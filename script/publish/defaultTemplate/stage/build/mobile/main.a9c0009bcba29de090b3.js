(()=>{var e={8970:function(e,t,n){var i;!function(a){"use strict";function s(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function o(e,t,n,i,a,o){return s((l=s(s(t,e),s(i,o)))<<(r=a)|l>>>32-r,n);var l,r}function l(e,t,n,i,a,s,l){return o(t&n|~t&i,e,t,a,s,l)}function r(e,t,n,i,a,s,l){return o(t&i|n&~i,e,t,a,s,l)}function d(e,t,n,i,a,s,l){return o(t^n^i,e,t,a,s,l)}function c(e,t,n,i,a,s,l){return o(n^(t|~i),e,t,a,s,l)}function u(e,t){var n,i,a,o,u;e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;var p=1732584193,m=-271733879,g=-1732584194,b=271733878;for(n=0;n<e.length;n+=16)i=p,a=m,o=g,u=b,p=l(p,m,g,b,e[n],7,-680876936),b=l(b,p,m,g,e[n+1],12,-389564586),g=l(g,b,p,m,e[n+2],17,606105819),m=l(m,g,b,p,e[n+3],22,-1044525330),p=l(p,m,g,b,e[n+4],7,-176418897),b=l(b,p,m,g,e[n+5],12,1200080426),g=l(g,b,p,m,e[n+6],17,-1473231341),m=l(m,g,b,p,e[n+7],22,-45705983),p=l(p,m,g,b,e[n+8],7,1770035416),b=l(b,p,m,g,e[n+9],12,-1958414417),g=l(g,b,p,m,e[n+10],17,-42063),m=l(m,g,b,p,e[n+11],22,-1990404162),p=l(p,m,g,b,e[n+12],7,1804603682),b=l(b,p,m,g,e[n+13],12,-40341101),g=l(g,b,p,m,e[n+14],17,-1502002290),p=r(p,m=l(m,g,b,p,e[n+15],22,1236535329),g,b,e[n+1],5,-165796510),b=r(b,p,m,g,e[n+6],9,-1069501632),g=r(g,b,p,m,e[n+11],14,643717713),m=r(m,g,b,p,e[n],20,-373897302),p=r(p,m,g,b,e[n+5],5,-701558691),b=r(b,p,m,g,e[n+10],9,38016083),g=r(g,b,p,m,e[n+15],14,-660478335),m=r(m,g,b,p,e[n+4],20,-405537848),p=r(p,m,g,b,e[n+9],5,568446438),b=r(b,p,m,g,e[n+14],9,-1019803690),g=r(g,b,p,m,e[n+3],14,-187363961),m=r(m,g,b,p,e[n+8],20,1163531501),p=r(p,m,g,b,e[n+13],5,-1444681467),b=r(b,p,m,g,e[n+2],9,-51403784),g=r(g,b,p,m,e[n+7],14,1735328473),p=d(p,m=r(m,g,b,p,e[n+12],20,-1926607734),g,b,e[n+5],4,-378558),b=d(b,p,m,g,e[n+8],11,-2022574463),g=d(g,b,p,m,e[n+11],16,1839030562),m=d(m,g,b,p,e[n+14],23,-35309556),p=d(p,m,g,b,e[n+1],4,-1530992060),b=d(b,p,m,g,e[n+4],11,1272893353),g=d(g,b,p,m,e[n+7],16,-155497632),m=d(m,g,b,p,e[n+10],23,-1094730640),p=d(p,m,g,b,e[n+13],4,681279174),b=d(b,p,m,g,e[n],11,-358537222),g=d(g,b,p,m,e[n+3],16,-722521979),m=d(m,g,b,p,e[n+6],23,76029189),p=d(p,m,g,b,e[n+9],4,-640364487),b=d(b,p,m,g,e[n+12],11,-421815835),g=d(g,b,p,m,e[n+15],16,530742520),p=c(p,m=d(m,g,b,p,e[n+2],23,-995338651),g,b,e[n],6,-198630844),b=c(b,p,m,g,e[n+7],10,1126891415),g=c(g,b,p,m,e[n+14],15,-1416354905),m=c(m,g,b,p,e[n+5],21,-57434055),p=c(p,m,g,b,e[n+12],6,1700485571),b=c(b,p,m,g,e[n+3],10,-1894986606),g=c(g,b,p,m,e[n+10],15,-1051523),m=c(m,g,b,p,e[n+1],21,-2054922799),p=c(p,m,g,b,e[n+8],6,1873313359),b=c(b,p,m,g,e[n+15],10,-30611744),g=c(g,b,p,m,e[n+6],15,-1560198380),m=c(m,g,b,p,e[n+13],21,1309151649),p=c(p,m,g,b,e[n+4],6,-145523070),b=c(b,p,m,g,e[n+11],10,-1120210379),g=c(g,b,p,m,e[n+2],15,718787259),m=c(m,g,b,p,e[n+9],21,-343485551),p=s(p,i),m=s(m,a),g=s(g,o),b=s(b,u);return[p,m,g,b]}function p(e){var t,n="",i=32*e.length;for(t=0;t<i;t+=8)n+=String.fromCharCode(e[t>>5]>>>t%32&255);return n}function m(e){var t,n=[];for(n[(e.length>>2)-1]=void 0,t=0;t<n.length;t+=1)n[t]=0;var i=8*e.length;for(t=0;t<i;t+=8)n[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return n}function g(e){var t,n,i="0123456789abcdef",a="";for(n=0;n<e.length;n+=1)t=e.charCodeAt(n),a+=i.charAt(t>>>4&15)+i.charAt(15&t);return a}function b(e){return unescape(encodeURIComponent(e))}function y(e){return function(e){return p(u(m(e),8*e.length))}(b(e))}function f(e,t){return function(e,t){var n,i,a=m(e),s=[],o=[];for(s[15]=o[15]=void 0,a.length>16&&(a=u(a,8*e.length)),n=0;n<16;n+=1)s[n]=909522486^a[n],o[n]=1549556828^a[n];return i=u(s.concat(m(t)),512+8*t.length),p(u(o.concat(i),640))}(b(e),b(t))}function h(e,t,n){return t?n?f(t,e):g(f(t,e)):n?y(e):g(y(e))}void 0===(i=function(){return h}.call(t,n,t,e))||(e.exports=i)}()},5680:function(e){e.exports=function(){"use strict";var e=1e3,t=6e4,n=36e5,i="millisecond",a="second",s="minute",o="hour",l="day",r="week",d="month",c="quarter",u="year",p="date",m="Invalid Date",g=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,b=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,y={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},f=function(e,t,n){var i=String(e);return!i||i.length>=t?e:""+Array(t+1-i.length).join(n)+e},h={s:f,z:function(e){var t=-e.utcOffset(),n=Math.abs(t),i=Math.floor(n/60),a=n%60;return(t<=0?"+":"-")+f(i,2,"0")+":"+f(a,2,"0")},m:function e(t,n){if(t.date()<n.date())return-e(n,t);var i=12*(n.year()-t.year())+(n.month()-t.month()),a=t.clone().add(i,d),s=n-a<0,o=t.clone().add(i+(s?-1:1),d);return+(-(i+(n-a)/(s?a-o:o-a))||0)},a:function(e){return e<0?Math.ceil(e)||0:Math.floor(e)},p:function(e){return{M:d,y:u,w:r,d:l,D:p,h:o,m:s,s:a,ms:i,Q:c}[e]||String(e||"").toLowerCase().replace(/s$/,"")},u:function(e){return void 0===e}},w="en",v={};v[w]=y;var _=function(e){return e instanceof x},E=function e(t,n,i){var a;if(!t)return w;if("string"==typeof t){var s=t.toLowerCase();v[s]&&(a=s),n&&(v[s]=n,a=s);var o=t.split("-");if(!a&&o.length>1)return e(o[0])}else{var l=t.name;v[l]=t,a=l}return!i&&a&&(w=a),a||!i&&w},k=function(e,t){if(_(e))return e.clone();var n="object"==typeof t?t:{};return n.date=e,n.args=arguments,new x(n)},C=h;C.l=E,C.i=_,C.w=function(e,t){return k(e,{locale:t.$L,utc:t.$u,x:t.$x,$offset:t.$offset})};var x=function(){function y(e){this.$L=E(e.locale,null,!0),this.parse(e)}var f=y.prototype;return f.parse=function(e){this.$d=function(e){var t=e.date,n=e.utc;if(null===t)return new Date(NaN);if(C.u(t))return new Date;if(t instanceof Date)return new Date(t);if("string"==typeof t&&!/Z$/i.test(t)){var i=t.match(g);if(i){var a=i[2]-1||0,s=(i[7]||"0").substring(0,3);return n?new Date(Date.UTC(i[1],a,i[3]||1,i[4]||0,i[5]||0,i[6]||0,s)):new Date(i[1],a,i[3]||1,i[4]||0,i[5]||0,i[6]||0,s)}}return new Date(t)}(e),this.$x=e.x||{},this.init()},f.init=function(){var e=this.$d;this.$y=e.getFullYear(),this.$M=e.getMonth(),this.$D=e.getDate(),this.$W=e.getDay(),this.$H=e.getHours(),this.$m=e.getMinutes(),this.$s=e.getSeconds(),this.$ms=e.getMilliseconds()},f.$utils=function(){return C},f.isValid=function(){return!(this.$d.toString()===m)},f.isSame=function(e,t){var n=k(e);return this.startOf(t)<=n&&n<=this.endOf(t)},f.isAfter=function(e,t){return k(e)<this.startOf(t)},f.isBefore=function(e,t){return this.endOf(t)<k(e)},f.$g=function(e,t,n){return C.u(e)?this[t]:this.set(n,e)},f.unix=function(){return Math.floor(this.valueOf()/1e3)},f.valueOf=function(){return this.$d.getTime()},f.startOf=function(e,t){var n=this,i=!!C.u(t)||t,c=C.p(e),m=function(e,t){var a=C.w(n.$u?Date.UTC(n.$y,t,e):new Date(n.$y,t,e),n);return i?a:a.endOf(l)},g=function(e,t){return C.w(n.toDate()[e].apply(n.toDate("s"),(i?[0,0,0,0]:[23,59,59,999]).slice(t)),n)},b=this.$W,y=this.$M,f=this.$D,h="set"+(this.$u?"UTC":"");switch(c){case u:return i?m(1,0):m(31,11);case d:return i?m(1,y):m(0,y+1);case r:var w=this.$locale().weekStart||0,v=(b<w?b+7:b)-w;return m(i?f-v:f+(6-v),y);case l:case p:return g(h+"Hours",0);case o:return g(h+"Minutes",1);case s:return g(h+"Seconds",2);case a:return g(h+"Milliseconds",3);default:return this.clone()}},f.endOf=function(e){return this.startOf(e,!1)},f.$set=function(e,t){var n,r=C.p(e),c="set"+(this.$u?"UTC":""),m=(n={},n[l]=c+"Date",n[p]=c+"Date",n[d]=c+"Month",n[u]=c+"FullYear",n[o]=c+"Hours",n[s]=c+"Minutes",n[a]=c+"Seconds",n[i]=c+"Milliseconds",n)[r],g=r===l?this.$D+(t-this.$W):t;if(r===d||r===u){var b=this.clone().set(p,1);b.$d[m](g),b.init(),this.$d=b.set(p,Math.min(this.$D,b.daysInMonth())).$d}else m&&this.$d[m](g);return this.init(),this},f.set=function(e,t){return this.clone().$set(e,t)},f.get=function(e){return this[C.p(e)]()},f.add=function(i,c){var p,m=this;i=Number(i);var g=C.p(c),b=function(e){var t=k(m);return C.w(t.date(t.date()+Math.round(e*i)),m)};if(g===d)return this.set(d,this.$M+i);if(g===u)return this.set(u,this.$y+i);if(g===l)return b(1);if(g===r)return b(7);var y=(p={},p[s]=t,p[o]=n,p[a]=e,p)[g]||1,f=this.$d.getTime()+i*y;return C.w(f,this)},f.subtract=function(e,t){return this.add(-1*e,t)},f.format=function(e){var t=this,n=this.$locale();if(!this.isValid())return n.invalidDate||m;var i=e||"YYYY-MM-DDTHH:mm:ssZ",a=C.z(this),s=this.$H,o=this.$m,l=this.$M,r=n.weekdays,d=n.months,c=function(e,n,a,s){return e&&(e[n]||e(t,i))||a[n].slice(0,s)},u=function(e){return C.s(s%12||12,e,"0")},p=n.meridiem||function(e,t,n){var i=e<12?"AM":"PM";return n?i.toLowerCase():i},g={YY:String(this.$y).slice(-2),YYYY:this.$y,M:l+1,MM:C.s(l+1,2,"0"),MMM:c(n.monthsShort,l,d,3),MMMM:c(d,l),D:this.$D,DD:C.s(this.$D,2,"0"),d:String(this.$W),dd:c(n.weekdaysMin,this.$W,r,2),ddd:c(n.weekdaysShort,this.$W,r,3),dddd:r[this.$W],H:String(s),HH:C.s(s,2,"0"),h:u(1),hh:u(2),a:p(s,o,!0),A:p(s,o,!1),m:String(o),mm:C.s(o,2,"0"),s:String(this.$s),ss:C.s(this.$s,2,"0"),SSS:C.s(this.$ms,3,"0"),Z:a};return i.replace(b,(function(e,t){return t||g[e]||a.replace(":","")}))},f.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},f.diff=function(i,p,m){var g,b=C.p(p),y=k(i),f=(y.utcOffset()-this.utcOffset())*t,h=this-y,w=C.m(this,y);return w=(g={},g[u]=w/12,g[d]=w,g[c]=w/3,g[r]=(h-f)/6048e5,g[l]=(h-f)/864e5,g[o]=h/n,g[s]=h/t,g[a]=h/e,g)[b]||h,m?w:C.a(w)},f.daysInMonth=function(){return this.endOf(d).$D},f.$locale=function(){return v[this.$L]},f.locale=function(e,t){if(!e)return this.$L;var n=this.clone(),i=E(e,t,!0);return i&&(n.$L=i),n},f.clone=function(){return C.w(this.$d,this)},f.toDate=function(){return new Date(this.valueOf())},f.toJSON=function(){return this.isValid()?this.toISOString():null},f.toISOString=function(){return this.$d.toISOString()},f.toString=function(){return this.$d.toUTCString()},y}(),L=x.prototype;return k.prototype=L,[["$ms",i],["$s",a],["$m",s],["$H",o],["$W",l],["$M",d],["$y",u],["$D",p]].forEach((function(e){L[e[1]]=function(t){return this.$g(t,e[0],e[1])}})),k.extend=function(e,t){return e.$i||(e(t,x,k),e.$i=!0),k},k.locale=E,k.isDayjs=_,k.unix=function(e){return k(1e3*e)},k.en=v[w],k.Ls=v,k.p={},k}()},1593:(e,t,n)=>{"use strict";n.r(t)},2005:e=>{"use strict";function t(e){if("string"!=typeof e)throw new TypeError("Path must be a string. Received "+JSON.stringify(e))}function n(e,t){for(var n,i="",a=0,s=-1,o=0,l=0;l<=e.length;++l){if(l<e.length)n=e.charCodeAt(l);else{if(47===n)break;n=47}if(47===n){if(s===l-1||1===o);else if(s!==l-1&&2===o){if(i.length<2||2!==a||46!==i.charCodeAt(i.length-1)||46!==i.charCodeAt(i.length-2))if(i.length>2){var r=i.lastIndexOf("/");if(r!==i.length-1){-1===r?(i="",a=0):a=(i=i.slice(0,r)).length-1-i.lastIndexOf("/"),s=l,o=0;continue}}else if(2===i.length||1===i.length){i="",a=0,s=l,o=0;continue}t&&(i.length>0?i+="/..":i="..",a=2)}else i.length>0?i+="/"+e.slice(s+1,l):i=e.slice(s+1,l),a=l-s-1;s=l,o=0}else 46===n&&-1!==o?++o:o=-1}return i}var i={resolve:function(){for(var e,i="",a=!1,s=arguments.length-1;s>=-1&&!a;s--){var o;s>=0?o=arguments[s]:(void 0===e&&(e=process.cwd()),o=e),t(o),0!==o.length&&(i=o+"/"+i,a=47===o.charCodeAt(0))}return i=n(i,!a),a?i.length>0?"/"+i:"/":i.length>0?i:"."},normalize:function(e){if(t(e),0===e.length)return".";var i=47===e.charCodeAt(0),a=47===e.charCodeAt(e.length-1);return 0!==(e=n(e,!i)).length||i||(e="."),e.length>0&&a&&(e+="/"),i?"/"+e:e},isAbsolute:function(e){return t(e),e.length>0&&47===e.charCodeAt(0)},join:function(){if(0===arguments.length)return".";for(var e,n=0;n<arguments.length;++n){var a=arguments[n];t(a),a.length>0&&(void 0===e?e=a:e+="/"+a)}return void 0===e?".":i.normalize(e)},relative:function(e,n){if(t(e),t(n),e===n)return"";if((e=i.resolve(e))===(n=i.resolve(n)))return"";for(var a=1;a<e.length&&47===e.charCodeAt(a);++a);for(var s=e.length,o=s-a,l=1;l<n.length&&47===n.charCodeAt(l);++l);for(var r=n.length-l,d=o<r?o:r,c=-1,u=0;u<=d;++u){if(u===d){if(r>d){if(47===n.charCodeAt(l+u))return n.slice(l+u+1);if(0===u)return n.slice(l+u)}else o>d&&(47===e.charCodeAt(a+u)?c=u:0===u&&(c=0));break}var p=e.charCodeAt(a+u);if(p!==n.charCodeAt(l+u))break;47===p&&(c=u)}var m="";for(u=a+c+1;u<=s;++u)u!==s&&47!==e.charCodeAt(u)||(0===m.length?m+="..":m+="/..");return m.length>0?m+n.slice(l+c):(l+=c,47===n.charCodeAt(l)&&++l,n.slice(l))},_makeLong:function(e){return e},dirname:function(e){if(t(e),0===e.length)return".";for(var n=e.charCodeAt(0),i=47===n,a=-1,s=!0,o=e.length-1;o>=1;--o)if(47===(n=e.charCodeAt(o))){if(!s){a=o;break}}else s=!1;return-1===a?i?"/":".":i&&1===a?"//":e.slice(0,a)},basename:function(e,n){if(void 0!==n&&"string"!=typeof n)throw new TypeError('"ext" argument must be a string');t(e);var i,a=0,s=-1,o=!0;if(void 0!==n&&n.length>0&&n.length<=e.length){if(n.length===e.length&&n===e)return"";var l=n.length-1,r=-1;for(i=e.length-1;i>=0;--i){var d=e.charCodeAt(i);if(47===d){if(!o){a=i+1;break}}else-1===r&&(o=!1,r=i+1),l>=0&&(d===n.charCodeAt(l)?-1==--l&&(s=i):(l=-1,s=r))}return a===s?s=r:-1===s&&(s=e.length),e.slice(a,s)}for(i=e.length-1;i>=0;--i)if(47===e.charCodeAt(i)){if(!o){a=i+1;break}}else-1===s&&(o=!1,s=i+1);return-1===s?"":e.slice(a,s)},extname:function(e){t(e);for(var n=-1,i=0,a=-1,s=!0,o=0,l=e.length-1;l>=0;--l){var r=e.charCodeAt(l);if(47!==r)-1===a&&(s=!1,a=l+1),46===r?-1===n?n=l:1!==o&&(o=1):-1!==n&&(o=-1);else if(!s){i=l+1;break}}return-1===n||-1===a||0===o||1===o&&n===a-1&&n===i+1?"":e.slice(n,a)},format:function(e){if(null===e||"object"!=typeof e)throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof e);return function(e,t){var n=t.dir||t.root,i=t.base||(t.name||"")+(t.ext||"");return n?n===t.root?n+i:n+e+i:i}("/",e)},parse:function(e){t(e);var n={root:"",dir:"",base:"",ext:"",name:""};if(0===e.length)return n;var i,a=e.charCodeAt(0),s=47===a;s?(n.root="/",i=1):i=0;for(var o=-1,l=0,r=-1,d=!0,c=e.length-1,u=0;c>=i;--c)if(47!==(a=e.charCodeAt(c)))-1===r&&(d=!1,r=c+1),46===a?-1===o?o=c:1!==u&&(u=1):-1!==o&&(u=-1);else if(!d){l=c+1;break}return-1===o||-1===r||0===u||1===u&&o===r-1&&o===l+1?-1!==r&&(n.base=n.name=0===l&&s?e.slice(1,r):e.slice(l,r)):(0===l&&s?(n.name=e.slice(1,o),n.base=e.slice(1,r)):(n.name=e.slice(l,o),n.base=e.slice(l,r)),n.ext=e.slice(o,r)),l>0?n.dir=e.slice(0,l-1):s&&(n.dir="/"),n},sep:"/",delimiter:":",win32:null,posix:null};i.posix=i,e.exports=i},9140:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pdfResize=t.renderAssetsPreview=void 0;const i=n(8438),a=n(9883);t.renderAssetsPreview=e=>{if(!e)return"";const t=(0,a.pathPosix)().extname(e).toLowerCase();return i.Constants.SIYUAN_ASSETS_IMAGE.includes(t)?`<img style="max-height: 100%" src="${e}">`:i.Constants.SIYUAN_ASSETS_AUDIO.includes(t)?`<audio style="max-width: 100%" controls="controls" src="${e}"></audio>`:i.Constants.SIYUAN_ASSETS_VIDEO.includes(t)?`<video style="max-width: 100%" controls="controls" src="${e}"></video>`:e};t.pdfResize=()=>{}},3053:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.genEmptyElement=t.genEmptyBlock=t.insertEmptyBlock=t.jumpToParentNext=t.genSBElement=t.cancelSB=void 0;const i=n(2386),a=n(7821),s=n(3903),o=n(9407),l=n(1985),r=n(5449),d=n(8438);t.cancelSB=(e,n)=>{const i=[],a=[];let s=n.previousElementSibling?n.previousElementSibling.getAttribute("data-node-id"):void 0;n.classList.remove("protyle-wysiwyg--select");const o=n.getAttribute("data-node-id"),l=(0,t.genSBElement)(n.getAttribute("data-sb-layout"),o,n.lastElementChild.outerHTML);return a.push({action:"insert",id:o,data:l.outerHTML,previousID:n.previousElementSibling?n.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:n.parentElement.getAttribute("data-node-id")||e.block.parentID}),Array.from(n.children).forEach(((t,l)=>{if(l===n.childElementCount-1)return i.push({action:"delete",id:o}),n.lastElementChild.remove(),void(n.outerHTML=n.innerHTML);i.push({action:"move",id:t.getAttribute("data-node-id"),previousID:s,parentID:n.parentElement.getAttribute("data-node-id")||e.block.parentID}),a.push({action:"move",id:t.getAttribute("data-node-id"),previousID:t.previousElementSibling?t.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:o}),s=t.getAttribute("data-node-id")})),{doOperations:i,undoOperations:a,previousId:s}};t.genSBElement=(e,t,n)=>{const i=document.createElement("div");return i.setAttribute("data-node-id",t||Lute.NewNodeID()),i.setAttribute("data-type","NodeSuperBlock"),i.setAttribute("class","sb"),i.setAttribute("data-sb-layout",e),i.innerHTML=n||`<div class="protyle-attr" contenteditable="false">${d.Constants.ZWSP}</div>`,i};t.jumpToParentNext=(e,t)=>{const n=(0,s.getTopAloneElement)(t);if(n){const t=(0,a.hasClosestByClassName)(n,"list")||(0,a.hasClosestByClassName)(n,"bq")||(0,a.hasClosestByClassName)(n,"sb")||n,o=(0,s.getNextBlock)(t);o&&((0,i.focusBlock)(o),(0,r.scrollCenter)(e,o))}};t.insertEmptyBlock=(e,n,d)=>{const c=(0,i.getEditorRange)(e.wysiwyg.element);let u,p;if(d)u=e.wysiwyg.element.querySelector(`[data-node-id="${d}"]`);else{const t=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");t.length>0?(u="beforebegin"===n?t[0]:t[t.length-1],t.forEach((e=>{e.classList.remove("protyle-wysiwyg--select")}))):(u=(0,a.hasClosestBlock)(c.startContainer),u=(0,s.getTopAloneElement)(u))}if(!u)return;"beforebegin"===n?u.previousElementSibling&&(p=u.previousElementSibling.getAttribute("data-node-id")):p=u.getAttribute("data-node-id");let m=(0,t.genEmptyElement)(!1,!0),g=1;"NodeListItem"===u.getAttribute("data-type")&&(m=(0,o.genListItemElement)(u,0,!0),g=parseInt(u.parentElement.firstElementChild.getAttribute("data-marker")));const b=u.parentElement.outerHTML,y=m.getAttribute("data-node-id");u.insertAdjacentElement(n,m),"NodeListItem"!==u.getAttribute("data-type")||"o"!==u.getAttribute("data-subtype")||m.parentElement.classList.contains("protyle-wysiwyg")?(0,l.transaction)(e,[{action:"insert",data:m.outerHTML,id:y,previousID:p,parentID:u.parentElement.getAttribute("data-node-id")||e.block.parentID}],[{action:"delete",id:y}]):((0,o.updateListOrder)(m.parentElement,g),(0,l.updateTransaction)(e,m.parentElement.getAttribute("data-node-id"),m.parentElement.outerHTML,b)),(0,i.focusByWbr)(e.wysiwyg.element,c),(0,r.scrollCenter)(e)};t.genEmptyBlock=(e=!0,t=!0,n)=>{let i="";return e&&(i=d.Constants.ZWSP),t&&(i+="<wbr>"),n&&(i+=n),`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="false">${i}</div><div contenteditable="false" class="protyle-attr">${d.Constants.ZWSP}</div></div>`};t.genEmptyElement=(e=!0,t=!0,n)=>{const i=document.createElement("div");return i.setAttribute("data-node-id",n||Lute.NewNodeID()),i.setAttribute("data-type","NodeParagraph"),i.classList.add("p"),i.innerHTML=`<div contenteditable="true" spellcheck="false">${e?d.Constants.ZWSP:""}${t?"<wbr>":""}</div><div class="protyle-attr" contenteditable="false">${d.Constants.ZWSP}</div>`,i}},5095:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.account=void 0;const i=n(8970),a=n(7491),s=n(8438),o=n(7683),l=n(3986),r=n(2041),d=n(7541),c=n(3680),u=n(7821);t.account={element:void 0,genHTML:()=>{const e=`<a href="https://ld246.com/sponsor" target="_blank" class="b3-chip b3-chip--secondary">\n    <svg version='1.1' xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path fill='#ffe43c' d='M6.4 0h19.2c4.268 0 6.4 2.132 6.4 6.4v19.2c0 4.268-2.132 6.4-6.4 6.4h-19.2c-4.268 0-6.4-2.132-6.4-6.4v-19.2c0-4.268 2.135-6.4 6.4-6.4z'></path> <path fill='#00f5d4' d='M25.6 0h-8.903c-7.762 1.894-14.043 7.579-16.697 15.113v10.487c0 3.533 2.867 6.4 6.4 6.4h19.2c3.533 0 6.4-2.867 6.4-6.4v-19.2c0-3.537-2.863-6.4-6.4-6.4z'></path> <path fill='#01beff' d='M25.6 0h-0.119c-12.739 2.754-20.833 15.316-18.079 28.054 0.293 1.35 0.702 2.667 1.224 3.946h16.974c3.533 0 6.4-2.867 6.4-6.4v-19.2c0-3.537-2.863-6.4-6.4-6.4z'></path> <path fill='#9a5ce5' d='M31.005 2.966c-0.457-0.722-1.060-1.353-1.784-1.849-8.342 3.865-13.683 12.223-13.679 21.416-0.003 3.256 0.67 6.481 1.978 9.463h8.081c0.602 0 1.185-0.084 1.736-0.238-2.1-3.189-3.401-7.624-3.401-12.526 0-7.337 2.921-13.628 7.070-16.266z'></path> <path fill='#f15bb5' d='M32 25.6v-19.2c0-1.234-0.354-2.419-0.998-3.43-4.149 2.638-7.067 8.928-7.067 16.266 0 4.902 1.301 9.334 3.401 12.526 2.693-0.757 4.664-3.231 4.664-6.162z'></path> <path fill='#fff' opacity='0.2' d='M26.972 22.415c-2.889 0.815-4.297 2.21-6.281 3.182 1.552 0.348 3.105 0.461 4.902 0.461 2.644 0 5.363-1.449 6.406-2.519v-1.085c-1.598-0.399-2.664-0.705-5.028-0.039zM4.773 21.612c-0.003 0-0.006-0.003-0.006-0.003-1.726-0.863-3.382-1.205-4.767-1.301v2.487c0.779-0.341 2.396-0.921 4.773-1.182zM17.158 26.599c1.472-0.158 2.57-0.531 3.533-1.002-1.063-0.238-2.126-0.583-3.269-1.079-2.767-1.205-5.63-3.092-10.491-3.034-0.779 0.010-1.495 0.058-2.158 0.132 4.503 2.248 7.882 5.463 12.384 4.983z'></path> <path fill='#fff' opacity='0.2' d='M20.691 25.594c-0.963 0.47-2.061 0.844-3.533 1.002-4.503 0.483-7.882-2.731-12.381-4.983-2.38 0.261-3.994 0.841-4.773 1.179v2.809c0 4.268 2.132 6.4 6.4 6.4h19.197c4.268 0 6.4-2.132 6.4-6.4v-2.065c-1.044 1.069-3.762 2.519-6.406 2.519-1.797 0-3.35-0.113-4.902-0.461z'></path> <path fill='#fff' opacity='0.5' d='M3.479 19.123c0 0.334 0.271 0.606 0.606 0.606s0.606-0.271 0.606-0.606v0c0-0.334-0.271-0.606-0.606-0.606s-0.606 0.271-0.606 0.606v0z'></path> <path fill='#fff' opacity='0.5' d='M29.027 14.266c0 0.334 0.271 0.606 0.606 0.606s0.606-0.271 0.606-0.606v0c0-0.334-0.271-0.606-0.606-0.606s-0.606 0.271-0.606 0.606v0z'></path> <path fill='#fff' d='M9.904 1.688c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' d='M2.673 10.468c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' opacity='0.6' d='M30.702 9.376c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' opacity='0.8' d='M29.236 20.881c0 0.276 0.224 0.499 0.499 0.499s0.499-0.224 0.499-0.499v0c0-0.276-0.224-0.499-0.499-0.499s-0.499 0.224-0.499 0.499v0z'></path> <path fill='#fff' opacity='0.8' d='M15.38 1.591c0.047 0.016 0.101 0.026 0.158 0.026 0.276 0 0.499-0.224 0.499-0.499 0-0.219-0.141-0.406-0.338-0.473l-0.004-0.001c-0.047-0.016-0.101-0.026-0.158-0.026-0.276 0-0.499 0.224-0.499 0.499 0 0.219 0.141 0.406 0.338 0.473l0.004 0.001z'></path> <path fill='#ffdeeb' d='M25.732 8.268c-2.393-2.371-6.249-2.371-8.642 0l-1.089 1.085-1.079-1.089c-2.38-2.39-6.249-2.393-8.639-0.013s-2.393 6.249-0.013 8.639l2.158 2.158 6.474 6.464c0.596 0.593 1.562 0.593 2.158 0l6.474-6.464 2.193-2.158c2.384-2.383 2.384-6.242 0.003-8.622z'></path> <path fill='#fff' d='M17.081 8.268l-1.079 1.085-1.079-1.089c-2.38-2.39-6.249-2.393-8.639-0.013s-2.393 6.249-0.013 8.639l2.158 2.158 2.548 2.487c4.097-1.044 7.627-3.646 9.837-7.254 1.424-2.271 2.284-4.848 2.503-7.518-2.193-0.715-4.606-0.132-6.236 1.504z'></path> </svg>\n    ${window.siyuan.languages.sponsor}\n</a>\n<div class="fn__hr--b"></div>\n<a class="b3-button b3-button--outline" style="min-width: 214px" href="https://ld246.com/subscribe/siyuan" target="_blank">\n    <span>\n        <div class="fn__hr"></div>\n        <span class="ft__smaller">${window.siyuan.languages.account4}</span>\n        <div class="fn__hr--small"></div>\n        <big class="ft__secondary">${window.siyuan.languages.priceAnnual}</big>\n        <span class="ft__on-background">/${window.siyuan.languages.year}</span>\n        <div class="fn__hr--small"></div>\n        <span class="ft__smaller ft__on-surface">${window.siyuan.languages.account1}</span>\n        <div class="fn__hr"></div>\n    </span>\n</a>\n<div class="fn__hr--b"></div>\n${window.siyuan.languages.account8}\n<div class="fn__hr"></div>\n${window.siyuan.languages.account2}\n<div><a href="https://b3log.org/siyuan/pricing.html" target="_blank">${window.siyuan.languages.account7}</a></div>\n<div class="fn__hr--b"></div>\n<span class="b3-chip b3-chip--primary fn__pointer${window.siyuan.user&&2===window.siyuan.user.userSiYuanSubscriptionStatus?" fn__none":""}" id="trialSub">\n    <svg class="ft__secondary"><use xlink:href="#iconVIP"></use></svg>\n    ${window.siyuan.languages.freeSub}\n</span>\n<div class="fn__hr--b"></div>`;if(window.siyuan.user){let t="";window.siyuan.user.userTitles.length>0&&(t='<div class="fn__hr--b"></div><div class="fn__flex" style="position: absolute"><span class="fn__space"></span>',window.siyuan.user.userTitles.forEach((e=>{t+=`<div class="b3-chip">${e.icon} ${e.name}</div><span class="fn__space"></span>`})),t+="</div>");let n=e,i=`<div class="fn__hr"></div>\n<div class="b3-form__icon fn__block">\n   <svg class="ft__secondary b3-form__icon-icon"><use xlink:href="#iconVIP"></use></svg>\n   <input class="b3-text-field fn__block b3-form__icon-input" style="padding-right: 44px;" placeholder="${window.siyuan.languages.activationCodePlaceholder}">\n   <button id="activationCode" class="b3-button b3-button--white" style="position: absolute;right: 1px;top: 1px;height: 25px;">${window.siyuan.languages.confirm}</button>\n</div>`;return-1===window.siyuan.user.userSiYuanProExpireTime?(i="",n=`<div class="b3-chip b3-chip--secondary">${s.Constants.SIYUAN_IMAGE_VIP}${window.siyuan.languages.account12}</div>`):window.siyuan.user.userSiYuanProExpireTime>0&&(n=2===window.siyuan.user.userSiYuanSubscriptionPlan?`<div class="b3-chip b3-chip--primary"><svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account3}</div>\n<div class="fn__hr"></div>\n<div class="ft__on-surface ft__smaller">${window.siyuan.languages.account6} ${Math.max(0,Math.floor((window.siyuan.user.userSiYuanProExpireTime-(new Date).getTime())/1e3/60/60/24))} ${window.siyuan.languages.day} ${window.siyuan.languages.clickMeToRenew}</div>\n<div class="fn__hr"></div>\n${window.siyuan.languages.account8}`:`<div class="b3-chip b3-chip--primary"><svg class="ft__secondary"><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account10}</div><div class="fn__hr"></div>\n<div class="ft__on-surface ft__smaller">${window.siyuan.languages.account6} ${Math.max(0,Math.floor((window.siyuan.user.userSiYuanProExpireTime-(new Date).getTime())/1e3/60/60/24))} ${window.siyuan.languages.day} ${window.siyuan.languages.clickMeToRenew}</div>`),`<div class="fn__flex config-account">\n<div class="config-account__center">\n    <div class="config-account__bg">\n        <div class="config-account__cover" style="background-image: url(${window.siyuan.user.userHomeBImgURL})"></div>\n        <a href="https://ld246.com/settings/avatar" class="config-account__avatar" style="background-image: url(${window.siyuan.user.userAvatarURL})" target="_blank"></a>\n        <h1 class="config-account__name">\n            <a target="_blank" class="fn__a" href="https://ld246.com/member/${window.siyuan.user.userName}">${window.siyuan.user.userName}</a>\n        </h1>\n        ${t}\n    </div>\n    <div class="config-account__info">\n        <div class="fn__flex">\n            <a class="b3-button b3-button--text" href="https://ld246.com/settings" target="_blank">${window.siyuan.languages.accountManage}</a>\n            <span class="fn__space"></span>\n            <button class="b3-button b3-button--cancel" id="logout">\n                ${window.siyuan.languages.logout}\n            </button>\n            <span class="fn__flex-1"></span>\n            <button class="b3-button b3-button--cancel b3-tooltips b3-tooltips__n" id="refresh" aria-label="${window.siyuan.languages.refresh}">\n                <svg><use xlink:href="#iconRefresh"></use></svg>\n            </button>\n        </div>\n        <div class="fn__hr--b"></div>\n        <div class="fn__flex">\n            <label>\n                ${window.siyuan.languages.accountDisplayTitle}\n                <input class="b3-switch fn__flex-center" id="displayTitle" type="checkbox"${window.siyuan.config.account.displayTitle?" checked":""}/>\n            </label>\n            <div class="fn__flex-1"></div>\n            <label>\n                ${window.siyuan.languages.accountDisplayVIP}\n                <input class="b3-switch fn__flex-center" id="displayVIP" type="checkbox"${window.siyuan.config.account.displayVIP?" checked":""}/>\n            </label>\n        </div>\n    </div>\n</div>\n<div class="config-account__center config-account__center--text${"ios"===window.siyuan.config.system.container?" fn__none":""}">\n    <div class="fn__flex-1 fn__hr"></div>\n    <div class="ft__center">${n}</div>\n    <div class="fn__flex-1 fn__hr"></div>\n    <div class="fn__flex fn__block" style="line-height: 1.625">\n        <div class="fn__flex-1"></div>\n        <span class="ft__on-surface">${window.siyuan.languages.paymentSum}</span>\n        <span class="fn__space"></span>\n        <span>${window.siyuan.user.userPaymentSum} RMB</span>\n    </div>\n    ${i}\n</div></div>`}return`<div class="fn__flex config-account">\n<div class="b3-form__space config-account__center">\n    <div class="config-account__form" id="form1">\n        <div class="b3-form__icon">\n            <svg class="b3-form__icon-icon"><use xlink:href="#iconAccount"></use></svg>\n            <input id="userName" class="b3-text-field fn__block b3-form__icon-input" placeholder="${window.siyuan.languages.accountName}">\n        </div>\n        <div class="fn__hr--b"></div>\n        <div class="b3-form__icon">\n            <svg class="b3-form__icon-icon"><use xlink:href="#iconLock"></use></svg>\n            <input type="password" id="userPassword" class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.password}">\n        </div>\n        <div class="b3-form__img fn__none">\n            <div class="fn__hr--b"></div>\n            <img id="captchaImg" class="fn__pointer" style="top: 17px">\n            <input id="captcha" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.captcha}">\n        </div>\n        <div class="fn__hr--b"></div>\n        <label class="ft__smaller ft__on-surface fn__flex">\n            <span class="fn__space"></span>\n            <input type="checkbox" class="b3-switch fn__flex-center" id="agreeLogin">\n            <span class="fn__space"></span>\n            <span>${window.siyuan.languages.accountTip}</span>\n        </label>\n        <div class="fn__hr--b"></div>\n        <button id="login" disabled class="b3-button fn__block">${window.siyuan.languages.login}</button>\n        <div class="fn__hr--b"></div>\n        <div class="ft__center">\n            <a href="https://ld246.com/forget-pwd" class="b3-button b3-button--cancel" target="_blank">${window.siyuan.languages.forgetPassword}</a>\n            <span class="fn__space${"ios"===window.siyuan.config.system.container?" fn__none":""}"></span>\n            <a href="https://ld246.com/register" class="b3-button b3-button--cancel${"ios"===window.siyuan.config.system.container?" fn__none":""}" target="_blank">${window.siyuan.languages.register}</a>\n        </div>\n    </div>\n    <div class="fn__none config-account__form" id="form2">\n        <div class="b3-form__icon">\n            <svg class="b3-form__icon-icon"><use xlink:href="#iconLock"></use></svg>\n            <input id="twofactorAuthCode" class="b3-text-field fn__block b3-form__icon-input" placeholder="${window.siyuan.languages.twoFactorCaptcha}">\n        </div>\n        <div class="fn__hr--b"></div>\n        <button id="login2" class="b3-button fn__block">${window.siyuan.languages.login}</button>\n    </div>\n</div>\n<div class="config-account__center config-account__center--text${"ios"===window.siyuan.config.system.container?" fn__none":""}">\n    <div class="ft__center">\n        ${e}\n        <div class="fn__hr--b"></div><div class="fn__hr--b"></div>\n    </div>\n</div>\n</div>`},bindEvent:e=>{const n=e.querySelector("#trialSub");n&&n.addEventListener("click",(()=>{(0,o.fetchPost)("/api/account/startFreeTrial",{},(()=>{e.querySelector("#refresh").dispatchEvent(new Event("click"))}))}));const s=e.querySelector("#agreeLogin"),l=e.querySelector("#userName");if(!l){const n=e.querySelector("#refresh");n.addEventListener("click",(()=>{const i=n.firstElementChild;i.classList.contains("fn__rotate")||(i.classList.add("fn__rotate"),(0,o.fetchPost)("/api/setting/getCloudUser",{token:window.siyuan.user.userToken},(n=>{window.siyuan.user=n.data,e.innerHTML=t.account.genHTML(),t.account.bindEvent(e),(0,a.showMessage)(window.siyuan.languages.refreshUser,3e3),t.account.onSetaccount()})))})),e.querySelector("#logout").addEventListener("click",(()=>{(0,o.fetchPost)("/api/setting/logoutCloudUser",{},(()=>{(0,o.fetchPost)("/api/setting/getCloudUser",{},(n=>{window.siyuan.user=n.data,e.innerHTML=t.account.genHTML(),t.account.bindEvent(e),t.account.onSetaccount()}))}))})),e.querySelectorAll("input[type='checkbox']").forEach((n=>{n.addEventListener("change",(()=>{(0,o.fetchPost)("/api/setting/setAccount",{displayTitle:e.querySelector("#displayTitle").checked,displayVIP:e.querySelector("#displayVIP").checked},(e=>{window.siyuan.config.account.displayTitle=e.data.displayTitle,window.siyuan.config.account.displayVIP=e.data.displayVIP,t.account.onSetaccount()}))}))}));const i=e.querySelector("#activationCode");return void i.addEventListener("click",(()=>{const e=i.previousElementSibling;(0,o.fetchPost)("/api/account/checkActivationcode",{data:e.value},(t=>{0!==t.code&&(e.value=""),(0,r.confirmDialog)(window.siyuan.languages.activationCode,t.msg,(()=>{0===t.code&&(0,o.fetchPost)("/api/account/useActivationcode",{data:i.previousElementSibling.value},(()=>{n.dispatchEvent(new CustomEvent("click"))}))}))}))}))}const d=e.querySelector("#userPassword"),c=e.querySelector("#captchaImg"),u=e.querySelector("#captcha"),p=e.querySelector("#twofactorAuthCode"),m=e.querySelector("#login"),g=e.querySelector("#login2");let b,y;s.addEventListener("click",(()=>{s.checked?m.removeAttribute("disabled"):m.setAttribute("disabled","disabled")})),l.focus(),l.addEventListener("keydown",(e=>{e.isComposing?e.preventDefault():"Enter"===e.key&&(m.click(),e.preventDefault())})),p.addEventListener("keydown",(e=>{e.isComposing?e.preventDefault():"Enter"===e.key&&(g.click(),e.preventDefault())})),u.addEventListener("keydown",(e=>{e.isComposing?e.preventDefault():"Enter"===e.key&&(m.click(),e.preventDefault())})),d.addEventListener("keydown",(e=>{e.isComposing?e.preventDefault():"Enter"===e.key&&(m.click(),e.preventDefault())})),c.addEventListener("click",(()=>{c.setAttribute("src",`https://ld246.com/captcha/login?needCaptcha=${y}&t=${(new Date).getTime()}`)})),m.addEventListener("click",(()=>{(0,o.fetchPost)("/api/account/login",{userName:l.value.replace(/(^\s*)|(\s*$)/g,""),userPassword:i(d.value),captcha:u.value.replace(/(^\s*)|(\s*$)/g,"")},(n=>{let i;return 1===n.code?(i=(0,a.showMessage)(n.msg),n.data.needCaptcha?(y=n.data.needCaptcha,u.parentElement.classList.remove("fn__none"),u.previousElementSibling.setAttribute("src",`https://ld246.com/captcha/login?needCaptcha=${n.data.needCaptcha}`),void(u.value="")):void 0):10===n.code?(e.querySelector("#form1").classList.add("fn__none"),e.querySelector("#form2").classList.remove("fn__none"),p.focus(),void(b=n.data.token)):((0,a.hideMessage)(i),void(0,o.fetchPost)("/api/setting/getCloudUser",{token:n.data.token},(n=>{t.account._afterLogin(n,e)})))}))})),g.addEventListener("click",(()=>{(0,o.fetchPost)("/api/setting/login2faCloudUser",{code:p.value,token:b},(n=>{(0,o.fetchPost)("/api/setting/getCloudUser",{token:n.data.token},(n=>{t.account._afterLogin(n,e)}))}))}))},_afterLogin(e,n){if(window.siyuan.user=e.data,n.classList.contains("account")&&!(0,d.needSubscribe)("")){const e=(0,u.hasClosestByClassName)(n,"b3-dialog--open");if(e)return window.siyuan.dialogs.find((t=>{if(t.element.isSameNode(e))return t.destroy(),!0})),void(0,c.syncGuide)()}n.innerHTML=t.account.genHTML(),t.account.bindEvent(n),t.account.onSetaccount()},onSetaccount(){if(l.repos.element&&(l.repos.element.innerHTML=""),"ios"===window.siyuan.config.system.container)return;let e="";window.siyuan.config.account.displayVIP&&window.siyuan.user&&(-1===window.siyuan.user.userSiYuanProExpireTime?e=`<div class="toolbar__item b3-tooltips b3-tooltips__se" aria-label="${window.siyuan.languages.account12}">${s.Constants.SIYUAN_IMAGE_VIP}</div>`:window.siyuan.user.userSiYuanProExpireTime>0&&(e=2===window.siyuan.user.userSiYuanSubscriptionPlan?`<div class="toolbar__item b3-tooltips b3-tooltips__se" aria-label="${window.siyuan.languages.account3}"><svg><use xlink:href="#iconVIP"></use></svg></div>`:`<div class="toolbar__item b3-tooltips b3-tooltips__se" aria-label="${window.siyuan.languages.account10}"><svg class="ft__secondary"><use xlink:href="#iconVIP"></use></svg></div>`)),(!window.siyuan.user||window.siyuan.user&&-1===window.siyuan.user.userSiYuanSubscriptionStatus)&&(e=`<div class="toolbar__item b3-tooltips b3-tooltips__se" aria-label="${window.siyuan.languages.freeSub}"><svg class="ft__error"><use xlink:href="#iconVIP"></use></svg></div>`),window.siyuan.config.account.displayTitle&&window.siyuan.user&&window.siyuan.user.userTitles.forEach((t=>{e+=`<div class="toolbar__item fn__a b3-tooltips b3-tooltips__se" aria-label="${t.name}：${t.desc}">${t.icon}</div>`})),document.getElementById("toolbarVIP").innerHTML=e}}},3986:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.repos=void 0;const i=n(7541),a=n(7683),s=n(6400),o=n(7491),l=n(3680);t.repos={element:void 0,genHTML:()=>{if((0,i.needSubscribe)(""))return`<div class="b3-label">${"ios"===window.siyuan.config.system.container?window.siyuan.languages._kernel[122]:window.siyuan.languages._kernel[29]}</div>\n<div class="b3-label">\n    ${window.siyuan.languages.cloudIntro1}\n    <div class="b3-label__text">\n        <ul style="padding-left: 2em">\n            <li>${window.siyuan.languages.cloudIntro2}</li>\n            <li>${window.siyuan.languages.cloudIntro3}</li>\n            <li>${window.siyuan.languages.cloudIntro4}</li>\n            <li>${window.siyuan.languages.cloudIntro5}</li>\n            <li>${window.siyuan.languages.cloudIntro6}</li>\n            <li>${window.siyuan.languages.cloudIntro7}</li>\n            <li>${window.siyuan.languages.cloudIntro8}</li>\n        </ul>\n    </div>\n</div>\n<div class="b3-label">\n    ${window.siyuan.languages.cloudIntro9}\n    <div class="b3-label__text">\n        <ul style="padding-left: 2em">\n            <li>${window.siyuan.languages.cloudIntro10}</li>\n            <li>${window.siyuan.languages.cloudIntro11}</li>\n        </ul>\n    </div>\n</div>`;let e=`<label class="fn__flex b3-label">\n    <div class="fn__flex-1">\n        ${window.siyuan.languages.syncMode}\n        <div class="b3-label__text">${window.siyuan.languages.syncModeTip}</div>\n    </div>\n    <span class="fn__space"></span>\n    <select id="syncMode" class="b3-select fn__flex-center fn__size200">\n        <option value="1" ${1===window.siyuan.config.sync.mode?"selected":""}>${window.siyuan.languages.syncMode1}</option>\n        <option value="2" ${2===window.siyuan.config.sync.mode?"selected":""}>${window.siyuan.languages.syncMode2}</option>\n    </select>\n</label>`;return(0,s.isMobile)()&&(e=`<div class="b3-label">\n    ${window.siyuan.languages.syncMode}\n    <div class="fn__hr"></div>\n    <select id="syncMode" class="b3-select fn__block">\n        <option value="1" ${1===window.siyuan.config.sync.mode?"selected":""}>${window.siyuan.languages.syncMode1}</option>\n        <option value="2" ${2===window.siyuan.config.sync.mode?"selected":""}>${window.siyuan.languages.syncMode2}</option>\n    </select>\n    <div class="b3-label__text">${window.siyuan.languages.syncModeTip}</div>\n</div>`),`<div><div style="position: fixed;width: 800px;height: 434px;box-sizing: border-box;text-align: center;display: flex;align-items: center;justify-content: center;z-index: 1;" id="reposLoading">\n    <img src="/stage/loading-pure.svg">\n</div>\n<div id="reposData" class="b3-label">\n    <div class="fn__flex">\n        <div class="fn__flex-1">\n            ${window.siyuan.languages.cloudStorage}\n        </div>\n        <div class="fn__flex-1">\n            ${window.siyuan.languages.trafficStat}\n        </div>\n    </div>\n</div>\n<label class="fn__flex b3-label">\n    <div class="fn__flex-1">\n        ${window.siyuan.languages.openSyncTip1}\n        <div class="b3-label__text">${window.siyuan.languages.openSyncTip2}</div>\n    </div>\n    <span class="fn__space"></span>\n    <input type="checkbox" id="reposCloudSyncSwitch"${window.siyuan.config.sync.enabled?" checked='checked'":""} class="b3-switch fn__flex-center">\n</label>\n${e}\n<div class="b3-label">\n    <div class="fn__flex">\n        <div class="fn__flex-center">${window.siyuan.languages.cloudSyncDir}</div>\n        <div class="fn__flex-1"></div>\n        <button class="b3-button b3-button--outline fn__flex-center${(0,s.isMobile)()?"":" fn__size200"}" data-type="config">\n            <svg><use xlink:href="#iconSettings"></use></svg>${window.siyuan.languages.config}\n        </button>\n    </div>\n    <div id="reposCloudSyncList" class="fn__none config-repos__sync"><img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg"></div>\n</div>\n<div class="b3-label fn__flex">\n    <div class="fn__flex-center">${window.siyuan.languages.cloudBackup}</div>\n    <div class="b3-list-item__meta fn__flex-center">${window.siyuan.languages.cloudBackupTip}</div>\n</div>\n</div>`},bindEvent:()=>{if((0,i.needSubscribe)(""))return;(0,a.fetchPost)("/api/cloud/getCloudSpace",{},(e=>{t.repos.element.querySelector("#reposLoading").classList.add("fn__none"),1!==e.code?t.repos.element.querySelector("#reposData").innerHTML=`<div class="fn__flex">\n    <div class="fn__flex-1">\n        ${window.siyuan.languages.cloudStorage}\n        <div class="fn__hr"></div>\n        <ul class="b3-list">\n            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.sync}<span class="b3-list-item__meta">${e.data.sync?e.data.sync.hSize:"0B"}</span></li>\n            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.backup}<span class="b3-list-item__meta">${e.data.backup?e.data.backup.hSize:"0B"}</span></li>\n            <li class="b3-list-item" style="cursor: auto;"><a href="https://ld246.com/settings/file?type=3" target="_blank">${window.siyuan.languages.cdn}</a><span class="b3-list-item__meta">${e.data.hAssetSize}</span></li>\n            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.total}<span class="b3-list-item__meta">${e.data.hSize}</span></li>\n            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.sizeLimit}<span class="b3-list-item__meta">${e.data.hTotalSize}</span></li>\n        </ul>\n    </div>\n    <div class="fn__flex-1">\n        ${window.siyuan.languages.trafficStat}\n        <div class="fn__hr"></div>\n        <ul class="b3-list">\n            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.upload}<span class="fn__space"></span><span class="ft__on-surface">${e.data.hTrafficUploadSize}</span></li>\n            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.download}<span class="fn__space"></span><span class="ft__on-surface">${e.data.hTrafficDownloadSize}</span></li>\n        </ul>\n    </div>\n</div>`:t.repos.element.querySelector("#reposData").innerHTML=e.msg}));const e=t.repos.element.querySelector("#reposCloudSyncSwitch");e.addEventListener("change",(()=>{if(e.checked&&""===window.siyuan.config.sync.cloudName)return e.checked=!1,void(0,o.showMessage)(window.siyuan.languages._kernel[123]);(0,a.fetchPost)("/api/sync/setSyncEnable",{enabled:e.checked},(t=>{1===t.code?((0,o.showMessage)(t.msg),e.checked=!1):window.siyuan.config.sync.enabled=e.checked}))}));const n=t.repos.element.querySelector("#syncMode");n.addEventListener("change",(()=>{(0,a.fetchPost)("/api/sync/setSyncMode",{mode:parseInt(n.value,10)},(e=>{1===e.code?((0,o.showMessage)(e.msg),n.value="1"):window.siyuan.config.sync.mode=parseInt(n.value,10)}))}));const s=t.repos.element.querySelector("#reposLoading");s.style.width=t.repos.element.clientWidth+"px",s.style.height=t.repos.element.clientHeight+"px";const r=t.repos.element.querySelector("#reposCloudSyncList");(0,l.bindSyncCloudListEvent)(r),t.repos.element.querySelector('[data-type="config"]').addEventListener("click",(()=>{r.classList.contains("fn__none")?((0,l.getSyncCloudList)(r),r.classList.remove("fn__none")):r.classList.add("fn__none")}))}}},4185:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setAccessAuthCode=void 0;const i=n(3163),a=n(6400),s=n(7683);t.setAccessAuthCode=()=>{const e=new i.Dialog({title:window.siyuan.languages.about5,content:`<div class="b3-dialog__content">\n    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.about5}" value="${window.siyuan.config.accessAuthCode}">\n    <div class="b3-label__text">${window.siyuan.languages.about6}</div>\n</div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>\n</div>`,width:(0,a.isMobile)()?"80vw":"520px"}),t=e.element.querySelector("input"),n=e.element.querySelectorAll(".b3-button");e.bindInput(t,(()=>{n[1].click()})),t.select(),n[0].addEventListener("click",(()=>{e.destroy()})),n[1].addEventListener("click",(()=>{(0,s.fetchPost)("/api/system/setAccessAuthCode",{accessAuthCode:t.value})}))}},8438:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Constants=void 0;class n{}t.Constants=n,n.SIYUAN_VERSION="2.2.0-alpha2",n.NODE_ENV="production",n.SIYUAN_APPID=Math.random().toString(36).substring(8),n.ASSETS_ADDRESS="https://assets.b3logfile.com/siyuan/",n.PROTYLE_CDN="/stage/protyle",n.UPLOAD_ADDRESS="/upload",n.SIYUAN_DROP_FILE="application/siyuan-file",n.SIYUAN_DROP_TAB="application/siyuan-tab",n.SIYUAN_DROP_EDITOR="application/siyuan-editor",n.SIYUAN_CONFIG_THEME="siyuan-config-theme",n.SIYUAN_CONFIG_CLOSE="siyuan-config-close",n.SIYUAN_CONFIG_TRAY="siyuan-config-tray",n.SIYUAN_CONFIG_CLOSETRAY="siyuan-config-closetray",n.SIYUAN_QUIT="siyuan-quit",n.SIYUAN_HOTKEY="siyuan-hotkey",n.SIYUAN_INIT="siyuan-init",n.SIYUAN_OPENURL="siyuan-openurl",n.SIYUAN_SAVE_CLOSE="siyuan-save-close",n.SIYUAN_EXPORT_PDF="siyuan-export-pdf",n.SIYUAN_EXPORT_CLOSE="siyuan-export-close",n.SIZE_TOOLBAR_HEIGHT=30,n.SIZE_GET=36,n.SIZE_GET_MAX=102400,n.SIZE_UNDO=64,n.SIZE_TITLE=512,n.SIZE_EDITOR_WIDTH=760,n.CB_MOUNT_HELP="cb-mount-help",n.CB_MOUNT_REMOVE="cb-mount-remove",n.CB_GET_APPEND="cb-get-append",n.CB_GET_BEFORE="cb-get-before",n.CB_GET_UNCHANGEID="cb-get-unchangeid",n.CB_GET_HL="cb-get-hl",n.CB_GET_FOCUS="cb-get-focus",n.CB_GET_FOCUSFIRST="cb-get-focusfirst",n.CB_GET_SETID="cb-get-setid",n.CB_GET_ALL="cb-get-all",n.CB_GET_UNUNDO="cb-get-unundo",n.CB_GET_SCROLL="cb-get-scroll",n.CB_GET_CONTEXT="cb-get-context",n.CB_GET_HTML="cb-get-html",n.CB_GET_HISTORY="cb-get-history",n.LOCAL_SEARCHEDATA="local-searchedata",n.LOCAL_SEARCHETABDATA="local-searchetabdata",n.LOCAL_DOCINFO="local-docinfo",n.LOCAL_DAILYNOTEID="local-dailynoteid",n.LOCAL_HISTORYNOTEID="local-historynoteid",n.LOCAL_CODELANG="local-codelang",n.LOCAL_FONTSTYLES="local-fontstyles",n.LOCAL_EXPORTPDF="local-exportpdf",n.LOCAL_EXPORTWORD="local-exportword",n.LOCAL_BAZAAR="local-bazaar",n.TIMEOUT_DBLCLICK=190,n.TIMEOUT_SEARCH=300,n.TIMEOUT_INPUT=256,n.TIMEOUT_BLOCKLOAD=300,n.HELP_PATH={zh_CN:"20210808180117-czj9bvb",zh_CHT:"20211226090932-5lcq56f",en_US:"20210808180117-6v0mkxr",fr_FR:"20210808180117-6v0mkxr"},n.HELP_START_PATH={zh_CN:"20200812220555-lj3enxa",zh_CHT:"20211226115423-d5z1joq",en_US:"20200923234011-ieuun1p",fr_FR:"20200923234011-ieuun1p"},n.SIYUAN_KEYMAP={general:{syncNow:{default:"F9",custom:"F9"},enterBack:{default:"⌥←",custom:"⌥←"},enter:{default:"⌥→",custom:"⌥→"},goForward:{default:"⌘]",custom:"⌘]"},goBack:{default:"⌘[",custom:"⌘["},newFile:{default:"⌘N",custom:"⌘N"},search:{default:"⌘F",custom:"⌘F"},globalSearch:{default:"⌘P",custom:"⌘P"},stickSearch:{default:"⇧⌘F",custom:"⇧⌘F"},replace:{default:"⌘R",custom:"⌘R"},closeTab:{default:"⌘W",custom:"⌘W"},fileTree:{default:"⌥1",custom:"⌥1"},outline:{default:"⌥2",custom:"⌥2"},bookmark:{default:"⌥3",custom:"⌥3"},tag:{default:"⌥4",custom:"⌥4"},dailyNote:{default:"⌥5",custom:"⌥5"},inbox:{default:"⌥6",custom:"⌥6"},backlinks:{default:"⌥7",custom:"⌥7"},graphView:{default:"⌥8",custom:"⌥8"},globalGraph:{default:"⌥9",custom:"⌥9"},config:{default:"⌥P",custom:"⌥P"},history:{default:"⌥H",custom:"⌥H"},toggleWin:{default:"⌥M",custom:"⌥M"},lockScreen:{default:"⌥N",custom:"⌥N"},move:{default:"",custom:""},selectOpen1:{default:"",custom:""}},editor:{general:{copyPlainText:{default:"",custom:""},copyID:{default:"",custom:""},netImg2LocalAsset:{default:"",custom:""},hLayout:{default:"",custom:""},vLayout:{default:"",custom:""},refPopover:{default:"",custom:""},expand:{default:"⌘↓",custom:"⌘↓"},collapse:{default:"⌘↑",custom:"⌘↑"},insertBottom:{default:"⌥⌘.",custom:"⌥⌘."},refTab:{default:"⇧⌘>",custom:"⇧⌘>"},openBy:{default:"⌘.",custom:"⌘."},insertRight:{default:"⌥.",custom:"⌥."},attr:{default:"⌥⌘A",custom:"⌥⌘A"},refresh:{default:"F5",custom:"F5"},copyBlockRef:{default:"⇧⌘C",custom:"⇧⌘C"},copyProtocol:{default:"⇧⌘H",custom:"⇧⌘H"},copyBlockEmbed:{default:"⇧⌘E",custom:"⇧⌘E"},copyHPath:{default:"⇧⌘P",custom:"⇧⌘P"},pasteAsPlainText:{default:"⇧⌘V",custom:"⇧⌘V"},undo:{default:"⌘Z",custom:"⌘Z"},redo:{default:"⌘Y",custom:"⌘Y"},rename:{default:"F2",custom:"F2"},newNameFile:{default:"F3",custom:"F3"},newContentFile:{default:"F4",custom:"F4"},showInFolder:{default:"⌥A",custom:"⌥A"},outline:{default:"⌥O",custom:"⌥O"},backlinks:{default:"⌥B",custom:"⌥B"},graphView:{default:"⌥G",custom:"⌥G"},fullscreen:{default:"⌥Y",custom:"⌥Y"},alignLeft:{default:"⌥L",custom:"⌥L"},alignCenter:{default:"⌥C",custom:"⌥C"},alignRight:{default:"⌥R",custom:"⌥R"},wysiwyg:{default:"⌥⌘7",custom:"⌥⌘7"},preview:{default:"⌥⌘9",custom:"⌥⌘9"},insertBefore:{default:"⇧⌘B",custom:"⇧⌘B"},insertAfter:{default:"⇧⌘A",custom:"⇧⌘A"},jumpToParentNext:{default:"⇧⌘N",custom:"⇧⌘N"},moveToUp:{default:"⇧⌘↑",custom:"⇧⌘↑"},moveToDown:{default:"⇧⌘↓",custom:"⇧⌘↓"}},insert:{font:{default:"⌥⌘X",custom:"⌥⌘X"},lastUsed:{default:"⌥X",custom:"⌥X"},blockRef:{default:"⌥[",custom:"⌥["},kbd:{default:"⌘'",custom:"⌘'"},sup:{default:"⌘H",custom:"⌘H"},sub:{default:"⌘J",custom:"⌘J"},bold:{default:"⌘B",custom:"⌘B"},"inline-math":{default:"⌘M",custom:"⌘M"},memo:{default:"⌥⌘M",custom:"⌥⌘M"},underline:{default:"⌘U",custom:"⌘U"},italic:{default:"⌘I",custom:"⌘I"},mark:{default:"⌘E",custom:"⌘E"},tag:{default:"⌘T",custom:"⌘T"},strike:{default:"⌘D",custom:"⌘D"},"inline-code":{default:"⌘G",custom:"⌘G"},link:{default:"⌘K",custom:"⌘K"},check:{default:"⌘L",custom:"⌘L"},table:{default:"⌘O",custom:"⌘O"},code:{default:"⇧⌘K",custom:"⇧⌘K"}},heading:{paragraph:{default:"⌥⌘0",custom:"⌥⌘0"},heading1:{default:"⌥⌘1",custom:"⌥⌘1"},heading2:{default:"⌥⌘2",custom:"⌥⌘2"},heading3:{default:"⌥⌘3",custom:"⌥⌘3"},heading4:{default:"⌥⌘4",custom:"⌥⌘4"},heading5:{default:"⌥⌘5",custom:"⌥⌘5"},heading6:{default:"⌥⌘6",custom:"⌥⌘6"}},list:{indent:{default:"⇥",custom:"⇥"},outdent:{default:"⇧⇥",custom:"⇧⇥"},checkToggle:{default:"⌘↩",custom:"⌘↩"}},table:{insertRowAbove:{default:"⇧⌘T",custom:"⇧⌘T"},insertRowBelow:{default:"⇧⌘D",custom:"⇧⌘D"},insertColumnLeft:{default:"⇧⌘L",custom:"⇧⌘L"},insertColumnRight:{default:"⇧⌘R",custom:"⇧⌘R"},moveToUp:{default:"⌥⌘T",custom:"⌥⌘T"},moveToDown:{default:"⌥⌘B",custom:"⌥⌘B"},moveToLeft:{default:"⌥⌘L",custom:"⌥⌘L"},moveToRight:{default:"⌥⌘R",custom:"⌥⌘R"},"delete-row":{default:"⌘-",custom:"⌘-"},"delete-column":{default:"⇧⌘_",custom:"⇧⌘_"}}}},n.SIYUAN_EMPTY_LAYOUT={hideDock:!1,layout:{direction:"tb",size:"0px",type:"normal",instance:"Layout",children:[{direction:"lr",size:"0px",type:"top",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"lr",children:[]}]},{direction:"lr",resize:"tb",size:"auto",type:"normal",instance:"Layout",children:[{direction:"tb",size:"0px",type:"left",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]},{direction:"lr",resize:"lr",size:"auto",type:"center",instance:"Layout",children:[{instance:"Wnd",children:[{instance:"Tab",children:[]}]}]},{direction:"tb",size:"0px",resize:"lr",type:"right",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]}]},{direction:"lr",size:"0px",resize:"tb",type:"bottom",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"lr",children:[]}]}]},top:[],bottom:[],left:[[{type:"file",size:{width:240,height:0},show:!0,icon:"iconFiles",hotkeyLangId:"fileTree"},{type:"outline",size:{width:240,height:0},show:!1,icon:"iconAlignCenter",hotkeyLangId:"outline"},{type:"inbox",size:{width:252,height:0},show:!1,icon:"iconInbox",hotkeyLangId:"inbox"}],[{type:"bookmark",size:{width:240,height:0},show:!1,icon:"iconBookmark",hotkeyLangId:"bookmark"},{type:"tag",size:{width:240,height:0},show:!1,icon:"iconTags",hotkeyLangId:"tag"}]],right:[[{type:"graph",size:{width:360,height:0},show:!1,icon:"iconGraph",hotkeyLangId:"graphView"},{type:"globalGraph",size:{width:360,height:0},show:!1,icon:"iconGlobalGraph",hotkeyLangId:"globalGraph"}],[{type:"backlink",size:{width:360,height:0},show:!1,icon:"iconLink",hotkeyLangId:"backlinks"}]]},n.SIYUAN_IMAGE_VIP='<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">\n<path fill="#ffd00f" d="M2.288 12.643l23.487 12.853c0.286 0.153 0.477 0.45 0.477 0.791 0 0.082-0.011 0.161-0.032 0.237l0.001-0.006c-0.119 0.395-0.479 0.678-0.905 0.678-0.004 0-0.009-0-0.013-0h-19.439c-0.958 0-1.766-0.684-1.885-1.595l-1.691-12.956z"></path>\n<path fill="#ffd00f" d="M29.676 12.643l-1.691 12.957c-0.119 0.911-0.927 1.594-1.884 1.594h-19.442c-0.004 0-0.009 0-0.013 0-0.425 0-0.785-0.281-0.903-0.668l-0.002-0.007c-0.019-0.070-0.031-0.15-0.031-0.232 0-0.341 0.191-0.638 0.472-0.788l0.005-0.002 23.487-12.853z"></path>\n<path fill="#ffe668" d="M15.413 8.369l10.394 15.921c0.378 0.579 0.407 1.317 0.076 1.924-0.328 0.591-0.948 0.985-1.66 0.985-0 0-0.001 0-0.001 0h-17.617c-0.694 0-1.331-0.378-1.661-0.985-0.144-0.26-0.229-0.569-0.229-0.899 0-0.382 0.114-0.736 0.31-1.033l-0.004 0.007 10.394-15.921z"></path>\n<path fill="#ffdd4e" d="M15.396 8.403l11.659 15.921c0.401 0.579 0.432 1.317 0.081 1.924-0.361 0.594-1.005 0.985-1.741 0.985-0.008 0-0.017-0-0.025-0h-9.344l-0.63-18.83z"></path>\n<path fill="#ffd00f" d="M13.868 6.478c0 0.946 0.767 1.712 1.712 1.712s1.712-0.767 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM28.577 10.818c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM0 10.822c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0z"></path>\n</svg>',n.SIYUAN_IMAGE_FILE="1f4c4",n.SIYUAN_IMAGE_NOTE="1f5c3",n.SIYUAN_IMAGE_FOLDER="1f4d1",n.SIYUAN_ASSETS_IMAGE=[".apng",".ico",".cur",".jpg",".jpe",".jpeg",".jfif",".pjp",".pjpeg",".png",".gif",".webp",".bmp",".svg"],n.SIYUAN_ASSETS_AUDIO=[".mp3",".wav",".ogg",".m4a"],n.SIYUAN_ASSETS_VIDEO=[".mov",".weba",".mkv",".mp4",".webm"],n.SIYUAN_ASSETS_EXTS=[".pdf"].concat(n.SIYUAN_ASSETS_IMAGE).concat(n.SIYUAN_ASSETS_AUDIO).concat(n.SIYUAN_ASSETS_VIDEO),n.SIYUAN_CONFIG_APPEARANCE_DARK_CODE=["a11y-dark","agate","an-old-hope","androidstudio","arta","atom-one-dark","atom-one-dark-reasonable","base16/3024","base16/apathy","base16/apprentice","base16/ashes","base16/atelier-cave","base16/atelier-dune","base16/atelier-estuary","base16/atelier-forest","base16/atelier-heath","base16/atelier-lakeside","base16/atelier-plateau","base16/atelier-savanna","base16/atelier-seaside","base16/atelier-sulphurpool","base16/atlas","base16/bespin","base16/black-metal","base16/black-metal-bathory","base16/black-metal-burzum","base16/black-metal-dark-funeral","base16/black-metal-gorgoroth","base16/black-metal-immortal","base16/black-metal-khold","base16/black-metal-marduk","base16/black-metal-mayhem","base16/black-metal-nile","base16/black-metal-venom","base16/brewer","base16/bright","base16/brogrammer","base16/brush-trees-dark","base16/chalk","base16/circus","base16/classic-dark","base16/codeschool","base16/colors","base16/danqing","base16/darcula","base16/dark-violet","base16/darkmoss","base16/darktooth","base16/decaf","base16/default-dark","base16/dracula","base16/edge-dark","base16/eighties","base16/embers","base16/equilibrium-dark","base16/equilibrium-gray-dark","base16/espresso","base16/eva","base16/eva-dim","base16/flat","base16/framer","base16/gigavolt","base16/google-dark","base16/grayscale-dark","base16/green-screen","base16/gruvbox-dark-hard","base16/gruvbox-dark-medium","base16/gruvbox-dark-pale","base16/gruvbox-dark-soft","base16/hardcore","base16/harmonic16-dark","base16/heetch-dark","base16/helios","base16/hopscotch","base16/horizon-dark","base16/humanoid-dark","base16/ia-dark","base16/icy-dark","base16/ir-black","base16/isotope","base16/kimber","base16/london-tube","base16/macintosh","base16/marrakesh","base16/materia","base16/material","base16/material-darker","base16/material-palenight","base16/material-vivid","base16/mellow-purple","base16/mocha","base16/monokai","base16/nebula","base16/nord","base16/nova","base16/ocean","base16/oceanicnext","base16/onedark","base16/outrun-dark","base16/papercolor-dark","base16/paraiso","base16/pasque","base16/phd","base16/pico","base16/pop","base16/porple","base16/qualia","base16/railscasts","base16/rebecca","base16/ros-pine","base16/ros-pine-moon","base16/sandcastle","base16/seti-ui","base16/silk-dark","base16/snazzy","base16/solar-flare","base16/solarized-dark","base16/spacemacs","base16/summercamp","base16/summerfruit-dark","base16/synth-midnight-terminal-dark","base16/tango","base16/tender","base16/tomorrow-night","base16/twilight","base16/unikitty-dark","base16/vulcan","base16/windows-10","base16/windows-95","base16/windows-high-contrast","base16/windows-nt","base16/woodland","base16/xcode-dusk","base16/zenburn","codepen-embed","dark","devibeans","far","felipec","github-dark","github-dark-dimmed","gml","gradient-dark","hybrid","ir-black","isbl-editor-dark","kimbie-dark","lioshi","monokai","monokai-sublime","night-owl","nnfx-dark","nord","obsidian","paraiso-dark","pojoaque","qtcreator-dark","rainbow","shades-of-purple","srcery","stackoverflow-dark","sunburst","tomorrow-night-blue","tomorrow-night-bright","tokyo-night-dark","vs2015","xt256"],n.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE=["ant-design","a11y-light","arduino-light","ascetic","atom-one-light","base16/atelier-cave-light","base16/atelier-dune-light","base16/atelier-estuary-light","base16/atelier-forest-light","base16/atelier-heath-light","base16/atelier-lakeside-light","base16/atelier-plateau-light","base16/atelier-savanna-light","base16/atelier-seaside-light","base16/atelier-sulphurpool-light","base16/brush-trees","base16/classic-light","base16/cupcake","base16/cupertino","base16/default-light","base16/dirtysea","base16/edge-light","base16/equilibrium-gray-light","base16/equilibrium-light","base16/fruit-soda","base16/github","base16/google-light","base16/grayscale-light","base16/gruvbox-light-hard","base16/gruvbox-light-medium","base16/gruvbox-light-soft","base16/harmonic16-light","base16/heetch-light","base16/humanoid-light","base16/horizon-light","base16/ia-light","base16/material-lighter","base16/mexico-light","base16/one-light","base16/papercolor-light","base16/ros-pine-dawn","base16/sagelight","base16/shapeshifter","base16/silk-light","base16/solar-flare-light","base16/solarized-light","base16/summerfruit-light","base16/synth-midnight-terminal-light","base16/tomorrow","base16/unikitty-light","base16/windows-10-light","base16/windows-95-light","base16/windows-high-contrast-light","brown-paper","base16/windows-nt-light","color-brewer","docco","foundation","github","googlecode","gradient-light","grayscale","idea","intellij-light","isbl-editor-light","kimbie-light","lightfair","magula","mono-blue","nnfx-light","paraiso-light","purebasic","qtcreator-light","routeros","school-book","stackoverflow-light","tokyo-night-light","vs","xcode","default"],n.ZWSP="​",n.INLINE_TYPE=["block-ref","kbd","text","file-annotation-ref","a","strong","em","u","s","mark","sup","sub","tag","code","inline-math","inline-memo"],n.BLOCK_HINT_KEYS=["((","[[","（（","【【"],n.BLOCK_HINT_CLOSE_KEYS={"((":"))","[[":"]]","（（":"））","【【":"】】"},n.CODE_LANGUAGES=["js","ts","html","toml","c#","bat","bash","c","csharp","cpp","css","diff","go","xml","json","java","javascript","kotlin","less","lua","makefile","markdown","objectivec","php","php-template","perl","plaintext","python","python-repl","r","ruby","rust","scss","sql","shell","swift","ini","typescript","vbnet","yaml","properties","1c","armasm","avrasm","actionscript","ada","angelscript","accesslog","apache","applescript","arcade","arduino","asciidoc","aspectj","abnf","autohotkey","autoit","awk","basic","bnf","dos","brainfuck","cal","cmake","csp","cos","capnproto","ceylon","clean","clojure","clojure-repl","coffeescript","coq","crystal","d","dns","dart","delphi","dts","django","dockerfile","dust","erb","elixir","elm","erlang","erlang-repl","excel","ebnf","fsharp","fix","flix","fortran","gcode","gams","gauss","glsl","gml","gherkin","golo","gradle","groovy","haml","hsp","http","handlebars","haskell","haxe","hy","irpf90","isbl","inform7","x86asm","jboss-cli","julia","julia-repl","ldif","llvm","lsl","latex","lasso","leaf","lisp","livecodeserver","livescript","mel","mipsasm","matlab","maxima","mercury","axapta","routeros","mizar","mojolicious","monkey","moonscript","n1ql","nsis","nestedtext","nginx","nim","nix","node-repl","ocaml","openscad","ruleslanguage","oxygene","pf","parser3","pony","pgsql","powershell","processing","prolog","protobuf","puppet","purebasic","profile","q","qml","reasonml","rib","rsl","roboconf","sas","sml","sqf","step21","scala","scheme","scilab","smali","smalltalk","stan","stata","stylus","subunit","tp","taggerscript","tcl","tap","thrift","twig","vbscript","vbscript-html","vhdl","vala","verilog","vim","wasm","mathematica","wren","xl","xquery","zephir","crmsh","dsconfig","graphql","yul","solidity","abap"]},2041:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.confirmDialog=void 0;const i=n(6400),a=n(3163);t.confirmDialog=(e,t,n,s)=>{const o=new a.Dialog({title:e,content:`<div class="b3-dialog__content">${t}</div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text" id="confirmDialogConfirmBtn">${window.siyuan.languages.confirm}</button>\n</div>`,width:(0,i.isMobile)()?"80vw":"520px"}),l=o.element.querySelectorAll(".b3-button");l[0].addEventListener("click",(()=>{s&&s(),o.destroy()})),l[1].addEventListener("click",(()=>{n&&n(),o.destroy()}))}},3163:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Dialog=void 0;const i=n(532),a=n(4577);t.Dialog=class{constructor(e){this.disableClose=e.disableClose,this.id=(0,a.genUUID)(),window.siyuan.dialogs.push(this),this.destroyCallback=e.destroyCallback,this.element=document.createElement("div"),this.element.innerHTML=`<div class="b3-dialog">\n<div class="b3-dialog__scrim"${e.transparent?'style="background-color:transparent"':""}></div>\n<div class="b3-dialog__container" style="width:${e.width||"auto"}">\n  <svg class="b3-dialog__close fn__a${this.disableClose?" fn__none":""}"><use xlink:href="#iconClose"></use></svg>\n  <div class="b3-dialog__header${e.title?"":" fn__none"}" onselectstart="return false;">${e.title||""}</div>\n  <div style="height:${e.height||"auto"}">${e.content}</div>\n</div></div>`,this.element.querySelector(".b3-dialog__scrim").addEventListener((0,i.getEventName)(),(e=>{this.disableClose||this.destroy(),e.stopPropagation(),window.siyuan.menus.menu.remove()})),this.disableClose||this.element.querySelector(".b3-dialog__close").addEventListener((0,i.getEventName)(),(e=>{this.destroy(),e.stopPropagation()})),document.body.append(this.element),e.disableAnimation?this.element.classList.add("b3-dialog--open"):setTimeout((()=>{this.element.classList.add("b3-dialog--open")}))}destroy(){this.element.remove(),this.destroyCallback&&this.destroyCallback(),window.siyuan.dialogs.find(((e,t)=>{if(e.id===this.id)return window.siyuan.dialogs.splice(t,1),!0}))}bindInput(e,t){e.focus(),e.addEventListener("keydown",(e=>{if(!e.isComposing)return"Escape"===e.key?(this.destroy(),e.preventDefault(),void e.stopPropagation()):void("Enter"===e.key&&t&&(t(),e.preventDefault()));e.preventDefault()}))}}},7491:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hideMessage=t.showMessage=t.initMessage=void 0;const i=n(4577),a=n(8438);t.initMessage=()=>{const e=document.getElementById("message");e.innerHTML=`<div class="fn__flex-1"></div>\n<button class="b3-button b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.clearMessage}"><svg style="margin-right: 0"><use xlink:href="#iconSelect"></use></svg></button>`,e.addEventListener("click",(n=>{let i=n.target;for(;i&&!i.isEqualNode(e);){if(i.classList.contains("b3-snackbar__close")){(0,t.hideMessage)(i.parentElement.getAttribute("data-id")),n.preventDefault();break}if(i.isSameNode(e.lastElementChild)){i.parentElement.classList.remove("b3-snackbars--show"),setTimeout((()=>{i.parentElement.firstElementChild.innerHTML=""}),a.Constants.TIMEOUT_INPUT),n.preventDefault();break}i=i.parentElement}}))};t.showMessage=(e,n=6e3,a="info",s)=>{const o=s||(0,i.genUUID)(),l=document.getElementById("message").firstElementChild,r=l.querySelector(`.b3-snackbar[data-id="${o}"]`);if(r){if(window.clearTimeout(parseInt(r.getAttribute("data-timeoutid"))),r.innerHTML=`<div class="b3-snackbar__content">${e}</div>${0===n?'<svg class="b3-snackbar__close"><use xlink:href="#iconClose"></use></svg>':""}`,"error"===a?r.classList.add("b3-snackbar--error"):r.classList.remove("b3-snackbar--error"),n>0){const e=window.setTimeout((()=>{(0,t.hideMessage)(o)}),n);r.setAttribute("data-timeoutid",e.toString())}return}let d=`<div data-id="${o}" class="b3-snackbar--hide b3-snackbar${"error"===a?" b3-snackbar--error":""}"><div class="b3-snackbar__content">${e}</div>`;if(0===n)d+='<svg class="b3-snackbar__close"><use xlink:href="#iconClose"></use></svg>';else if(-1!==n){const e=window.setTimeout((()=>{(0,t.hideMessage)(o)}),n);d=d.replace("<div data-id",`<div data-timeoutid="${e}" data-id`)}return 0===l.childElementCount&&l.parentElement.classList.add("b3-snackbars--show"),l.insertAdjacentHTML("afterbegin",d+"</div>"),setTimeout((()=>{l.querySelectorAll(".b3-snackbar--hide").forEach((e=>{e.classList.remove("b3-snackbar--hide")}))})),l.firstElementChild.nextElementSibling&&l.firstElementChild.nextElementSibling.innerHTML===l.firstElementChild.innerHTML&&l.firstElementChild.nextElementSibling.remove(),l.scrollTo({top:0,behavior:"smooth"}),o};t.hideMessage=e=>{const t=document.getElementById("message").firstElementChild;if(e){const n=t.querySelector(`[data-id="${e}"]`);n&&(n.classList.add("b3-snackbar--hide"),setTimeout((()=>{n.remove()}),a.Constants.TIMEOUT_INPUT)),t.childElementCount<2&&t.parentElement.classList.remove("b3-snackbars--show")}else t.parentElement.classList.remove("b3-snackbars--show"),setTimeout((()=>{t.innerHTML=""}),a.Constants.TIMEOUT_INPUT)}},4933:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.downloadProgress=t.setTitle=t.bootSync=t.progressLoading=t.progressStatus=t.transactionError=t.exitSiYuan=t.kernelError=t.lockFile=void 0;const i=n(8438),a=n(7683),s=n(7491),o=n(3163),l=n(6400),r=n(2041);t.lockFile=e=>{const t=`<div class="b3-dialog__scrim"></div>\n<div class="b3-dialog__container">\n    <div class="b3-dialog__header" onselectstart="return false;">🔒 ${window.siyuan.languages.lockFile0} <small>v${i.Constants.SIYUAN_VERSION}</small></div>\n    <div class="b3-dialog__content">\n        <p>${window.siyuan.languages.lockFile1}</p>\n        <p>${window.siyuan.languages.lockFile2}</p>\n    </div>\n    <div class="b3-dialog__action">\n        <button class="b3-button b3-button--cancel">${window.siyuan.languages.closeTab}</button>\n        <div class="fn__space"></div>\n        <button class="b3-button b3-button--text">${window.siyuan.languages.retry}</button>\n    </div>\n</div>`;let n=document.getElementById("errorLog");n?n.innerHTML=t:(document.body.insertAdjacentHTML("beforeend",`<div id="errorLog" class="b3-dialog b3-dialog--open">${t}</div>`),n=document.getElementById("errorLog")),n.querySelector(".b3-button--cancel").addEventListener("click",(()=>{})),n.querySelector(".b3-button--text").addEventListener("click",(()=>{(0,a.fetchPost)("/api/filetree/lockFile",{id:e},(e=>{0===e.code&&window.location.reload()}))}))};t.kernelError=()=>{var e,t;let n="";"ios"===window.siyuan.config.system.container&&(null===(e=window.webkit)||void 0===e?void 0:e.messageHandlers)&&(n=`<div class="fn__hr"></div><div class="fn__flex"><div class="fn__flex-1"></div><button class="b3-button">${window.siyuan.languages.retry}</button></div>`);const a=`<div class="b3-dialog__scrim"></div>\n<div class="b3-dialog__container" style="width: ${(0,l.isMobile)()?"80vw":"520px"}">\n    <div class="b3-dialog__header" onselectstart="return false;">💔 ${window.siyuan.languages.kernelFault0} <small>v${i.Constants.SIYUAN_VERSION}</small></div>\n    <div class="b3-dialog__content">\n        <p>${window.siyuan.languages.kernelFault1}</p>\n        <div class="fn__hr"></div>\n        <p>${window.siyuan.languages.kernelFault2}</p>\n        ${n}\n    </div>\n</div>`;let s=document.getElementById("errorLog");s?s.innerHTML=a:(document.body.insertAdjacentHTML("beforeend",`<div id="errorLog" class="b3-dialog b3-dialog--open">${a}</div>`),s=document.getElementById("errorLog"));const o=s.querySelector(".b3-button");o&&(null===(t=window.webkit)||void 0===t?void 0:t.messageHandlers)&&o.addEventListener("click",(()=>{s.remove(),window.webkit.messageHandlers.startKernelFast.postMessage("startKernelFast")}))};t.exitSiYuan=()=>{(0,a.fetchPost)("/api/system/exit",{force:!1},(e=>{var t;if(1===e.code){const t=(0,s.showMessage)(e.msg,e.data.closeTimeout,"error"),n=document.querySelector(`#message [data-id="${t}"] button`);n&&n.addEventListener("click",(()=>{(0,a.fetchPost)("/api/system/exit",{force:!0},(()=>{var e;["ios","android"].includes(window.siyuan.config.system.container)&&((null===(e=window.webkit)||void 0===e?void 0:e.messageHandlers)||window.JSAndroid)&&(window.location.href="siyuan://api/system/exit")}))}))}else 2===e.code?((0,s.hideMessage)(),(0,r.confirmDialog)(window.siyuan.languages.tip,e.msg,(()=>{(0,a.fetchPost)("/api/system/exit",{force:!0,execInstallPkg:2},(()=>{}))}),(()=>{(0,a.fetchPost)("/api/system/exit",{force:!0,execInstallPkg:1},(()=>{}))}))):["ios","android"].includes(window.siyuan.config.system.container)&&((null===(t=window.webkit)||void 0===t?void 0:t.messageHandlers)||window.JSAndroid)&&(window.location.href="siyuan://api/system/exit")}))};let d;t.transactionError=e=>{if(1===e.code)return void(0,t.lockFile)(e.data);if(document.getElementById("transactionError"))return;const n=new o.Dialog({disableClose:!0,title:`${window.siyuan.languages.stateExcepted} v${i.Constants.SIYUAN_VERSION}`,content:`<div class="b3-dialog__content" id="transactionError">${window.siyuan.languages.rebuildIndexTip}</div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--text">${window.siyuan.languages._kernel[97]}</button>\n    <div class="fn__space"></div>\n    <button class="b3-button">${window.siyuan.languages.rebuildIndex}</button>\n</div>`,width:(0,l.isMobile)()?"80vw":"520px"}).element.querySelectorAll(".b3-button");n[0].addEventListener("click",(()=>{(0,t.exitSiYuan)()})),n[1].addEventListener("click",(()=>{(0,a.fetchPost)("/api/filetree/refreshFiletree",{})}))};t.progressStatus=e=>{if((0,l.isMobile)()){clearTimeout(d);const t=document.querySelector("#status");return t.innerHTML=e.msg,t.classList.remove("status--hide"),void(d=window.setTimeout((()=>{t.classList.add("status--hide")}),6e3))}document.querySelector("#status .status__msg").innerHTML=e.msg};t.progressLoading=e=>{let t=document.getElementById("progress");t||(document.body.insertAdjacentHTML("beforeend",'<div id="progress"></div>'),t=document.getElementById("progress")),2!==e.code?0===e.code?t.innerHTML=`<div class="b3-dialog__scrim" style="z-index:400;opacity: 1"></div>\n<div style="position: fixed;top: 45vh;width: 70vw;left: 15vw;color:#fff;z-index:400;">\n    <div style="text-align: right">${e.data.current}/${e.data.total}</div>\n    <div style="margin: 8px 0;height: 8px;border-radius: 4px;overflow: hidden;background-color:#fff;"><div style="width: ${e.data.current/e.data.total*100}%;transition: var(--b3-transition);background-color: var(--b3-theme-primary);height: 8px;"></div></div>\n    <div>${e.msg}</div>\n</div>`:1===e.code&&(t.lastElementChild?t.lastElementChild.lastElementChild.innerHTML=e.msg:t.innerHTML=`<div class="b3-dialog__scrim" style="z-index:400;opacity: 1"></div>\n<div style="position: fixed;top: 45vh;width: 70vw;left: 15vw;color:#fff;z-index:400;">\n    <div style="margin: 8px 0;height: 8px;border-radius: 4px;overflow: hidden;background-color:#fff;"><div style="background-color: var(--b3-theme-primary);height: 8px;background-image: linear-gradient(-45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent);animation: stripMove 450ms linear infinite;background-size: 50px 50px;"></div></div>\n    <div>${e.msg}</div>\n</div>`):t.remove()};t.bootSync=()=>{(0,a.fetchPost)("/api/sync/getBootSync",{},(e=>{if(1===e.code){const t=new o.Dialog({width:(0,l.isMobile)()?"80vw":"50vw",title:"🌩️ "+window.siyuan.languages.bootSyncFailed,content:`<div class="b3-dialog__content">${e.msg}</div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.syncNow}</button>\n</div>`}),n=t.element.querySelectorAll(".b3-button");n[0].addEventListener("click",(()=>{t.destroy()})),n[1].addEventListener("click",(()=>{n[1].getAttribute("disabled")||(n[1].setAttribute("disabled","disabled"),(0,a.fetchPost)("/api/sync/performBootSync",{},(e=>{0===e.code&&t.destroy(),n[1].removeAttribute("disabled")})))}))}}))};t.setTitle=e=>{const t=document.getElementById("drag");if(e===window.siyuan.languages.siyuanNote){const n=e+" v"+i.Constants.SIYUAN_VERSION;document.title=n,t.textContent=n,t.setAttribute("title",n)}else document.title=e+" - "+window.siyuan.languages.siyuanNote+" v"+i.Constants.SIYUAN_VERSION,t.textContent=e,t.setAttribute("title",e)};t.downloadProgress=e=>{const t=document.getElementById("configBazaarReadme");if(!t)return;const n=t.querySelector(`[data-url="${e.id}"]`);n&&(e.percent>=1?n.parentElement.classList.add("fn__none"):(n.classList.add("b3-button--progress"),n.innerHTML=`<span style="width: ${100*e.percent}%"></span>`))}},1762:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deleteFile=void 0;const i=n(7683),a=n(9883),s=n(2041);t.deleteFile=(e,t,n)=>{window.siyuan.config.fileTree.removeDocWithoutConfirm?(0,i.fetchPost)("/api/filetree/removeDoc",{notebook:e,path:t}):(0,i.fetchPost)("/api/block/getDocInfo",{id:(0,a.getDisplayName)(t,!0,!0)},(a=>{let o=`${window.siyuan.languages.confirmDelete} <b>${n}</b>?`;a.data.subFileCount>0&&(o=`${window.siyuan.languages.confirmDelete} <b>${n}</b> ${window.siyuan.languages.andSubFile.replace("x",a.data.subFileCount)}?`),(0,s.confirmDialog)(window.siyuan.languages.delete,o,(()=>{(0,i.fetchPost)("/api/filetree/removeDoc",{notebook:e,path:t})}))}))}},8059:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getIconByType=void 0;t.getIconByType=(e,t)=>{let n="";switch(e){case"NodeDocument":n="iconFile";break;case"NodeThematicBreak":n="iconLine";break;case"NodeParagraph":n="iconParagraph";break;case"NodeHeading":n=t?"icon"+t.toUpperCase():"iconHeadings";break;case"NodeBlockquote":n="iconQuote";break;case"NodeList":n="t"===t?"iconCheck":"o"===t?"iconOrderedList":"iconList";break;case"NodeListItem":n="iconListItem";break;case"NodeCodeBlock":case"NodeYamlFrontMatter":n="iconCode";break;case"NodeTable":n="iconTable";break;case"NodeBlockQueryEmbed":n="iconSQL";break;case"NodeSuperBlock":n="iconSuper";break;case"NodeMathBlock":n="iconMath";break;case"NodeHTMLBlock":n="iconHTML5";break;case"NodeWidget":n="iconBoth";break;case"NodeIFrame":n="iconLanguage";break;case"NodeVideo":n="iconVideo";break;case"NodeAudio":n="iconRecord"}return n}},3029:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.newFileBySelect=t.newFileContentBySelect=t.renameAsset=t.rename=t.replaceLocalPath=t.replaceFileName=t.validateName=void 0;const i=n(7491),a=n(3163),s=n(2386),o=n(7821),l=n(133),r=n(8469),d=n(3053),c=n(6400),u=n(9883),p=n(7683),m=n(9755);t.validateName=e=>!/\r\n|\r|\n|\u2028|\u2029|\t|\//.test(e)||((0,i.showMessage)(window.siyuan.languages.fileNameRule),!1);t.replaceFileName=e=>e.replace(/\r\n|\r|\n|\u2028|\u2029|\t|\//g,"");t.replaceLocalPath=e=>e.replace(/\\\\|\/|:|\*|\?|\\|'|<|>|\|/g,"");t.rename=e=>{const n=new a.Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>\n</div>`,width:(0,c.isMobile)()?"80vw":"520px",destroyCallback(){e.range&&(0,s.focusByRange)(e.range)}}),i=n.element.querySelector("input"),o=n.element.querySelectorAll(".b3-button");n.bindInput(i,(()=>{o[1].click()})),i.value=Lute.UnEscapeHTMLStr(e.name),i.focus(),i.select(),o[0].addEventListener("click",(()=>{n.destroy()})),o[1].addEventListener("click",(()=>!!(0,t.validateName)(i.value)&&(i.value===e.name?(n.destroy(),!1):(""===i.value.trim()?i.value="Untitled":i.value=(0,t.replaceFileName)(i.value),"notebook"===e.type?(0,p.fetchPost)("/api/notebook/renameNotebook",{notebook:e.notebookId,name:i.value},(()=>{(0,u.setNotebookName)(e.notebookId,i.value)})):(0,p.fetchPost)("/api/filetree/renameDoc",{notebook:e.notebookId,path:e.path,title:i.value}),void n.destroy()))))};t.renameAsset=e=>{const t=new a.Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>\n</div>`,width:(0,c.isMobile)()?"80vw":"520px"}),n=t.element.querySelector("input"),i=t.element.querySelectorAll(".b3-button");t.bindInput(n,(()=>{i[1].click()}));const s=(0,u.getAssetName)(e);n.value=s,n.focus(),n.select(),i[0].addEventListener("click",(()=>{t.destroy()})),i[1].addEventListener("click",(()=>{if(n.value===s||!n.value)return t.destroy(),!1;(0,p.fetchPost)("/api/asset/renameAsset",{oldPath:e,newName:n.value})}))};t.newFileContentBySelect=e=>{if(0===getSelection().rangeCount)return;const n=getSelection().getRangeAt(0),i=(0,o.hasClosestBlock)(n.startContainer);if(!i)return;let a=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));0===a.length&&(a=[i]);let s="",r=n.toString();if(""===r){if(r=a[0].textContent,a.forEach((e=>{s+=(0,l.removeEmbed)(e)})),!r)return}else{const e=document.createElement("div");e.appendChild(n.cloneContents()),s=e.innerHTML}r.length>10&&(r=r.substr(0,10)+"..."),r=(0,t.replaceFileName)(r),(0,p.fetchPost)("/api/filetree/createDoc",{notebook:e.notebookId,path:(0,u.pathPosix)().join((0,u.getDisplayName)(e.path,!1,!0),Lute.NewNodeID()+".sy"),title:r,md:e.lute.BlockDOM2StdMd(s)})};t.newFileBySelect=(e,n)=>{e=(0,t.replaceFileName)(e);const i=Lute.NewNodeID();(0,p.fetchPost)("/api/filetree/createDoc",{notebook:n.notebookId,path:(0,u.pathPosix)().join((0,u.getDisplayName)(n.path,!1,!0),i+".sy"),title:e,md:""},(()=>{(0,r.insertHTML)((0,d.genEmptyBlock)(!1,!1,`<span data-type="block-ref" data-id="${i}" data-subtype="d">${(0,m.escapeHtml)(e)}</span>`),n)}))}},6810:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateFileTreeEmoji=t.updateOutlineEmoji=t.openEmojiPanel=t.addEmoji=t.filterEmoji=t.lazyLoadEmoji=t.unicode2Emoji=t.getRandomEmoji=void 0;const i=n(6400),a=n(7683),s=n(7821),o=n(8438),l=n(9883);t.getRandomEmoji=()=>{const e=window.siyuan.emojis[(0,i.getRandom)(0,window.siyuan.emojis.length-1)];return void 0===e.items[(0,i.getRandom)(0,e.items.length-1)]?"1f600":e.items[(0,i.getRandom)(0,e.items.length-1)].unicode};t.unicode2Emoji=(e,t=!1)=>{if(!e)return"";let n="";if(e.indexOf(".")>-1)n=`<img src="/emojis/${e}"/>`;else if((0,i.isMobile)()||window.siyuan.config.appearance.nativeEmoji||t)try{e.split("-").forEach((e=>{e.length<5?n+=String.fromCodePoint(parseInt("0"+e,16)):n+=String.fromCodePoint(parseInt(e,16))}))}catch(e){}else n=`<svg class="custom-icon"><use xlink:href="#icon-${e}"></use></svg>`;return n};t.lazyLoadEmoji=(e,n=!1)=>{const i=new IntersectionObserver((e=>{e.forEach((e=>{const i=e.target.getAttribute("data-index");if((void 0===e.isIntersecting?0!==e.intersectionRatio:e.isIntersecting)&&i){let a="";window.siyuan.emojis[parseInt(i)].items.forEach((e=>{a+=`<button data-unicode="${e.unicode}" class="emojis__item" aria-label="${"zh_CN"===window.siyuan.config.lang?e.description_zh_cn:e.description}">\n${(0,t.unicode2Emoji)(e.unicode,n)}</button>`})),e.target.innerHTML=a,e.target.removeAttribute("data-index")}}))}));e.querySelectorAll(".emojis__content").forEach((e=>{i.observe(e)}))};t.filterEmoji=(e="",n,i=!1)=>{let a="";const s=[];e&&(a=`<div class="emojis__title">${window.siyuan.languages.emoji}</div><div class="emojis__content">`);let o=0,l="";const r=[];window.siyuan.emojis.forEach(((d,c)=>{e||(a+=`<div class="emojis__title" data-type="${c+1}">${"zh_CN"===window.siyuan.config.lang?d.title_zh_cn:d.title}</div><div style="min-height:${0===c?"28px":"336px"}" class="emojis__content"${c>1?' data-index="'+c+'"':""}>`),0!==d.items.length||0!==c||e||(a+=`<div style="margin-left: 4px">${window.siyuan.languages.setEmojiTip}</div>`),d.items.forEach((u=>{if(e){if(window.siyuan.config.editor.emoji.includes(u.unicode)&&((0,t.unicode2Emoji)(u.unicode,!0)===e||u.keywords.toLowerCase().indexOf(e.toLowerCase())>-1||u.description.toLowerCase().indexOf(e.toLowerCase())>-1||u.description_zh_cn.toLowerCase().indexOf(e.toLowerCase())>-1)&&s.push(u),n&&o>n)return;((0,t.unicode2Emoji)(u.unicode,!0)===e||u.keywords.toLowerCase().indexOf(e.toLowerCase())>-1||u.description.toLowerCase().indexOf(e.toLowerCase())>-1||u.description_zh_cn.toLowerCase().indexOf(e.toLowerCase())>-1)&&("custom"===d.id?r.push(u):l+=`<button data-unicode="${u.unicode}" class="emojis__item" aria-label="${"zh_CN"===window.siyuan.config.lang?u.description_zh_cn:u.description}">\n${(0,t.unicode2Emoji)(u.unicode,i)}</button>`,o++)}else window.siyuan.config.editor.emoji.includes(u.unicode)&&s.push(u),c<2&&(a+=`<button data-unicode="${u.unicode}" class="emojis__item" aria-label="${"zh_CN"===window.siyuan.config.lang?u.description_zh_cn:u.description}">\n${(0,t.unicode2Emoji)(u.unicode,i)}</button>`)})),e||(a+="</div>")})),e&&(r.sort(((t,n)=>{const i=t.keywords.split("/"),a=n.keywords.split("/");return i[i.length-1].toLowerCase().indexOf(e.toLowerCase())<a[a.length-1].toLowerCase().indexOf(e.toLowerCase())?-1:0})).sort(((t,n)=>{const i=t.keywords.split("/"),a=n.keywords.split("/");return i[i.length-1].toLowerCase().indexOf(e.toLowerCase())===a[a.length-1].toLowerCase().indexOf(e.toLowerCase())&&i[i.length-1].length<a[a.length-1].length?-1:0})).forEach((e=>{a+=`<button data-unicode="${e.unicode}" class="emojis__item" aria-label="${"zh_CN"===window.siyuan.config.lang?e.description_zh_cn:e.description}">\n${(0,t.unicode2Emoji)(e.unicode,i)}</button>`})),a=a+l+"</div>");let d="";return s.length>0&&(d=`<div class="emojis__title" data-type="0">${window.siyuan.languages.recentEmoji}</div><div class="emojis__content">`,window.siyuan.config.editor.emoji.forEach((e=>{const n=s.filter((t=>t.unicode===e));n[0]&&(d+=`<button data-unicode="${n[0].unicode}" class="emojis__item" aria-label="${"zh_CN"===window.siyuan.config.lang?n[0].description_zh_cn:n[0].description}">\n${(0,t.unicode2Emoji)(n[0].unicode,i)}\n</button>`)})),d+="</div>"),d+a===""?`<div class="emojis__title">${window.siyuan.languages.emptyContent}</div>`:d+a};t.addEmoji=e=>{window.siyuan.config.editor.emoji.unshift(e),window.siyuan.config.editor.emoji.length>o.Constants.SIZE_UNDO&&window.siyuan.config.editor.emoji.pop(),window.siyuan.config.editor.emoji=Array.from(new Set(window.siyuan.config.editor.emoji)),(0,a.fetchPost)("/api/setting/setEmoji",{emoji:window.siyuan.config.editor.emoji})};t.openEmojiPanel=(e,n,o=!1)=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.innerHTML=`<div class="emojis" style="width: ${(0,i.isMobile)()?"80vw":"360px"}">\n<div class="fn__flex">\n    <span class="fn__space"></span>\n    <label class="b3-form__icon fn__flex-1">\n        <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>\n        <input class="b3-form__icon-input b3-text-field fn__block" placeholder="${window.siyuan.languages.search}">\n    </label>\n    <span class="fn__space"></span>\n    <span class="block__icon fn__flex-center b3-tooltips b3-tooltips__sw" style="opacity: 1" aria-label="${window.siyuan.languages.random}"><svg><use xlink:href="#iconRefresh"></use></svg></span>\n    <span class="fn__space"></span>\n    <span class="block__icon fn__flex-center b3-tooltips b3-tooltips__sw" style="opacity: 1" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>\n    <span class="fn__space"></span>\n</div>\n<div class="emojis__panel">${(0,t.filterEmoji)()}</div>\n<div class="fn__flex">\n    <div data-type="0" class="emojis__type" aria-label="${window.siyuan.languages.recentEmoji}">${(0,t.unicode2Emoji)("2b50")}</div>\n    <div data-type="1" class="emojis__type" aria-label="${window.siyuan.emojis[0]["zh_CN"===window.siyuan.config.lang?"title_zh_cn":"title"]}">${(0,t.unicode2Emoji)("1f527")}</div>\n    <div data-type="2" class="emojis__type" aria-label="${window.siyuan.emojis[1]["zh_CN"===window.siyuan.config.lang?"title_zh_cn":"title"]}">${(0,t.unicode2Emoji)("1f60d")}</div>\n    <div data-type="3" class="emojis__type" aria-label="${window.siyuan.emojis[2]["zh_CN"===window.siyuan.config.lang?"title_zh_cn":"title"]}">${(0,t.unicode2Emoji)("1f433")}</div>\n    <div data-type="4" class="emojis__type" aria-label="${window.siyuan.emojis[3]["zh_CN"===window.siyuan.config.lang?"title_zh_cn":"title"]}">${(0,t.unicode2Emoji)("1f96a")}</div>\n    <div data-type="5" class="emojis__type" aria-label="${window.siyuan.emojis[4]["zh_CN"===window.siyuan.config.lang?"title_zh_cn":"title"]}">${(0,t.unicode2Emoji)("1f3a8")}</div>\n    <div data-type="6" class="emojis__type" aria-label="${window.siyuan.emojis[5]["zh_CN"===window.siyuan.config.lang?"title_zh_cn":"title"]}">${(0,t.unicode2Emoji)("1f3dd")}</div>\n    <div data-type="7" class="emojis__type" aria-label="${window.siyuan.emojis[6]["zh_CN"===window.siyuan.config.lang?"title_zh_cn":"title"]}">${(0,t.unicode2Emoji)("1f52e")}</div>\n    <div data-type="8" class="emojis__type" aria-label="${window.siyuan.emojis[7]["zh_CN"===window.siyuan.config.lang?"title_zh_cn":"title"]}">${(0,t.unicode2Emoji)("267e")}</div>\n    <div data-type="9" class="emojis__type" aria-label="${window.siyuan.emojis[8]["zh_CN"===window.siyuan.config.lang?"title_zh_cn":"title"]}">${(0,t.unicode2Emoji)("1f6a9")}</div>\n</div>\n</div>`,window.siyuan.menus.menu.element.firstElementChild.querySelector(".emojis__item").classList.add("emojis__item--current");const l=n.getBoundingClientRect();window.siyuan.menus.menu.popup({x:l.left,y:l.top+l.height});const d=window.siyuan.menus.menu.element.querySelector(".b3-text-field"),c=window.siyuan.menus.menu.element.querySelector(".emojis__panel");d.addEventListener("compositionend",(()=>{var e;c.innerHTML=(0,t.filterEmoji)(d.value),d.value?c.nextElementSibling.classList.add("fn__none"):c.nextElementSibling.classList.remove("fn__none"),c.scrollTop=0,null===(e=window.siyuan.menus.menu.element.firstElementChild.querySelector(".emojis__item"))||void 0===e||e.classList.add("emojis__item--current"),""===d.value&&(0,t.lazyLoadEmoji)(window.siyuan.menus.menu.element)})),d.addEventListener("input",(e=>{var n;e.isComposing||(c.innerHTML=(0,t.filterEmoji)(d.value),d.value?c.nextElementSibling.classList.add("fn__none"):c.nextElementSibling.classList.remove("fn__none"),c.scrollTop=0,null===(n=window.siyuan.menus.menu.element.firstElementChild.querySelector(".emojis__item"))||void 0===n||n.classList.add("emojis__item--current"),""===d.value&&(0,t.lazyLoadEmoji)(window.siyuan.menus.menu.element))})),d.addEventListener("keydown",(n=>{var i,s;if(n.isComposing)return;if(-1===n.key.indexOf("Arrow")&&"Enter"!==n.key)return;const l=window.siyuan.menus.menu.element.firstElementChild.querySelector(".emojis__item--current");if(!l)return;if("Enter"===n.key){const i=l.getAttribute("data-unicode");return o?(0,a.fetchPost)("/api/notebook/setNotebookIcon",{notebook:e,icon:i},(()=>{window.siyuan.menus.menu.remove(),(0,t.addEmoji)(i),(0,t.updateFileTreeEmoji)(i,e,"iconFilesRoot")})):(0,a.fetchPost)("/api/attr/setBlockAttrs",{id:e,attrs:{icon:i}},(()=>{window.siyuan.menus.menu.remove(),(0,t.addEmoji)(i),(0,t.updateFileTreeEmoji)(i,e),r(i,e),(0,t.updateOutlineEmoji)(i)})),n.preventDefault(),void n.stopPropagation()}let u;if("ArrowLeft"===n.key||"ArrowUp"===n.key?l.previousElementSibling?(l.classList.remove("emojis__item--current"),u=l.previousElementSibling,n.preventDefault(),n.stopPropagation()):(null===(i=l.parentElement.previousElementSibling)||void 0===i?void 0:i.previousElementSibling)&&(l.classList.remove("emojis__item--current"),u=l.parentElement.previousElementSibling.previousElementSibling.lastElementChild,n.preventDefault(),n.stopPropagation()):"ArrowRight"!==n.key&&"ArrowDown"!==n.key||(l.nextElementSibling?(l.classList.remove("emojis__item--current"),u=l.nextElementSibling,n.preventDefault(),n.stopPropagation()):(null===(s=l.parentElement.nextElementSibling)||void 0===s?void 0:s.nextElementSibling)&&(l.classList.remove("emojis__item--current"),u=l.parentElement.nextElementSibling.nextElementSibling.firstElementChild,n.preventDefault(),n.stopPropagation())),u){u.classList.add("emojis__item--current");const e=d.clientHeight+6;u.offsetTop-e<c.scrollTop?c.scrollTop=u.offsetTop-e:u.offsetTop-e-c.clientHeight+u.clientHeight>c.scrollTop&&(c.scrollTop=u.offsetTop-e-c.clientHeight+u.clientHeight)}})),(0,i.isMobile)()||d.focus(),(0,t.lazyLoadEmoji)(window.siyuan.menus.menu.element),window.siyuan.menus.menu.element.firstElementChild.addEventListener("click",(n=>{const i=n.target,l=(0,s.hasClosestByClassName)(i,"emojis__type");if(l){const e=c.querySelector(`[data-type="${l.getAttribute("data-type")}"]`);if(e){const n=e.nextElementSibling.getAttribute("data-index");if(n){let i="";window.siyuan.emojis[parseInt(n)].items.forEach((e=>{i+=`<button data-unicode="${e.unicode}" class="emojis__item" aria-label="${"zh_CN"===window.siyuan.config.lang?e.description_zh_cn:e.description}">\n${(0,t.unicode2Emoji)(e.unicode)}</button>`})),e.nextElementSibling.innerHTML=i,e.nextElementSibling.removeAttribute("data-index")}c.scrollTo({top:e.offsetTop-34})}return}const d=(0,s.hasClosestByClassName)(i,"block__icon");if(d&&d.getAttribute("aria-label")===window.siyuan.languages.remove)return void(o?(0,a.fetchPost)("/api/notebook/setNotebookIcon",{notebook:e,icon:""},(()=>{window.siyuan.menus.menu.remove(),(0,t.updateFileTreeEmoji)("",e,"iconFilesRoot")})):(0,a.fetchPost)("/api/attr/setBlockAttrs",{id:e,attrs:{icon:""}},(()=>{window.siyuan.menus.menu.remove(),(0,t.updateFileTreeEmoji)("",e),r("",e),(0,t.updateOutlineEmoji)("")})));const u=(0,s.hasClosestByClassName)(i,"emojis__item");if(u||d){let n="";return u?(n=u.getAttribute("data-unicode"),window.siyuan.menus.menu.remove()):n=(0,t.getRandomEmoji)(),void(o?(0,a.fetchPost)("/api/notebook/setNotebookIcon",{notebook:e,icon:n},(()=>{(0,t.addEmoji)(n),(0,t.updateFileTreeEmoji)(n,e,"iconFilesRoot")})):(0,a.fetchPost)("/api/attr/setBlockAttrs",{id:e,attrs:{icon:n}},(()=>{(0,t.addEmoji)(n),(0,t.updateFileTreeEmoji)(n,e),r(n,e),(0,t.updateOutlineEmoji)(n)})))}}))};t.updateOutlineEmoji=e=>{};t.updateFileTreeEmoji=(e,n,i="iconFile")=>{let a;a=document.querySelector(`#sidebar [data-type="sidebar-file"] [data-node-id="${n}"] .b3-list-item__icon`),a&&(a.innerHTML=(0,t.unicode2Emoji)(e||("iconFile"===i?a.previousElementSibling.classList.contains("fn__hidden")?o.Constants.SIYUAN_IMAGE_FILE:o.Constants.SIYUAN_IMAGE_FOLDER:o.Constants.SIYUAN_IMAGE_NOTE))),"iconFile"!==i&&(0,l.setNoteBook)()};const r=(e,t)=>{window.siyuan.mobileEditor.protyle.block.rootID===t&&(window.siyuan.mobileEditor.protyle.background.ial.icon=e,window.siyuan.mobileEditor.protyle.background.render(window.siyuan.mobileEditor.protyle.background.ial,window.siyuan.mobileEditor.protyle.block.rootID))}},7849:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Model=void 0;const i=n(8438),a=n(6456),s=n(4933);t.Model=class{constructor(e){e.msgCallback&&this.connect(e)}connect(e){const t=`${"https:"===window.location.protocol?"wss":"ws"}://${window.location.host}/ws`,n=new WebSocket(`${t}?app=${i.Constants.SIYUAN_APPID}&id=${e.id}${e.type?"&type="+e.type:""}`);n.onopen=()=>{e.callback&&e.callback.call(this);document.getElementById("errorLog")&&window.location.reload()},n.onmessage=t=>{if(e.msgCallback){const n=(0,a.processMessage)(JSON.parse(t.data));e.msgCallback.call(this,n)}},n.onclose=t=>{0<=t.reason.indexOf("unauthenticated")||0>t.reason.indexOf("close websocket")&&(console.warn("WebSocket is closed. Reconnect will be attempted in 3 second.",t),setTimeout((()=>{this.connect({id:e.id,type:e.type,msgCallback:e.msgCallback})}),3e3))},n.onerror=e=>{const t=document.getElementById("errorLog");e.target.url.endsWith("&type=main")&&3===e.target.readyState&&!t&&(0,s.kernelError)()},this.ws=n}send(e,t,n=!1){this.ws&&(this.reqId=n?0:(new Date).getTime(),this.ws.send(JSON.stringify({cmd:e,reqId:this.reqId,param:t})))}}},9229:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.countBlockWord=t.countSelectWord=t.initStatus=void 0;t.initStatus=()=>{};t.countSelectWord=e=>{};t.countBlockWord=e=>{}},6937:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bindMenuKeydown=t.MenuItem=t.Menu=void 0;const i=n(532),a=n(5500),s=n(7821),o=n(6400);t.Menu=class{constructor(){this.wheelEvent="onwheel"in document.createElement("div")?"wheel":"mousewheel",this.element=document.getElementById("commonMenu"),this.element.addEventListener((0,o.isMobile)()?(0,i.getEventName)():"mouseover",(e=>{const t=e.target,n=(0,s.hasClosestByClassName)(t,"b3-menu__item");if(!n)return;if(n.classList.contains("b3-menu__item--readonly"))return;const i=n.querySelector(".b3-menu__submenu");this.element.querySelectorAll(".b3-menu__item--show").forEach((e=>{e.contains(n)||e.classList.remove("b3-menu__item--show")})),this.element.querySelectorAll(".b3-menu__item--current").forEach((e=>{e.classList.remove("b3-menu__item--current")})),n.classList.add("b3-menu__item--current"),i&&(n.classList.add("b3-menu__item--show"),this.showSubMenu(i))}))}showSubMenu(e){const t=e.getBoundingClientRect();let n="";const i=t.left-this.element.clientWidth-t.width;t.right>window.innerWidth&&(i>0||Math.abs(i)<t.right-window.innerWidth)?n=i>=0?"left:auto;right:100%;":`z-index:1;mix-blend-mode: normal;left:-${this.element.style.left};`:t.right>window.innerWidth&&(n=`z-index:1;mix-blend-mode: normal;left:${window.innerWidth-t.width-this.element.offsetLeft}px;`),t.bottom>window.innerHeight&&(n+=`top: auto;bottom:-5px;max-height:${Math.min(t.top,.4*window.innerHeight)}px`),n&&e.setAttribute("style",n)}preventDefault(e){(0,s.hasClosestByClassName)(e.target,"b3-menu")||e.preventDefault()}remove(){(0,o.isMobile)()?window.removeEventListener("touchmove",this.preventDefault,!1):window.removeEventListener(this.wheelEvent,this.preventDefault,!1),this.element.innerHTML="",this.element.classList.add("fn__none"),this.element.style.zIndex=""}append(e){e&&this.element.append(e)}popup(e,t=!1){(0,o.isMobile)()?window.addEventListener("touchmove",this.preventDefault,{passive:!1}):window.addEventListener(this.wheelEvent,this.preventDefault,{passive:!1}),this.element.classList.remove("fn__none"),(0,a.setPosition)(this.element,e.x-(t?window.siyuan.menus.menu.element.clientWidth:0),e.y,e.h)}};class l{constructor(e){if(this.element=document.createElement("button"),e.disabled&&this.element.setAttribute("disabled","disabled"),"separator"===e.type)return void this.element.classList.add("b3-menu__separator");this.element.classList.add("b3-menu__item"),e.current&&this.element.classList.add("b3-menu__item--selected"),e.click&&this.element.addEventListener((0,i.getEventName)(),(t=>{this.element.getAttribute("disabled")||(e.click(this.element),this.element.parentElement.classList.add("fn__none"),this.element.parentElement.innerHTML="",t.preventDefault(),t.stopImmediatePropagation(),t.stopPropagation(),window.siyuan.menus.menu.remove())}));let t=`<span class="b3-menu__label">${e.label}</span>`;if(t=e.iconHTML?e.iconHTML+t:`<svg class="b3-menu__icon${["HTML (SiYuan)",window.siyuan.languages.template].includes(e.label)?" ft__error":""}" style="${"iconClose"===e.icon?"height:10px;":""}"><use xlink:href="#${e.icon||""}"></use></svg>${t}`,e.accelerator&&(t+=`<span class="b3-menu__accelerator">${(0,i.updateHotkeyTip)(e.accelerator)}</span>`),e.id&&this.element.setAttribute("data-id",e.id),"readonly"===e.type&&this.element.classList.add("b3-menu__item--readonly"),this.element.innerHTML=t,e.bind&&(this.element.classList.add("b3-menu__item--custom"),e.bind(this.element)),e.submenu){const t=document.createElement("div");t.classList.add("b3-menu__submenu"),e.submenu.forEach((e=>{t.append(new l(e).element)})),this.element.insertAdjacentHTML("beforeend",'<svg class="b3-menu__icon b3-menu__icon--arrow"><use xlink:href="#iconRight"></use></svg>'),this.element.append(t)}}}t.MenuItem=l;const r=(e,t)=>{let n=e;for(;n&&(n.classList.contains("b3-menu__separator")||n.classList.contains("b3-menu__item--readonly"));)n=t?n.nextElementSibling:n.previousElementSibling;return n};t.bindMenuKeydown=e=>{if(window.siyuan.menus.menu.element.classList.contains("fn__none")||e.altKey||e.shiftKey||(0,i.isCtrl)(e))return!1;if("ArrowDown"===e.code){const e=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");let t;e?(e.classList.remove("b3-menu__item--current","b3-menu__item--show"),t=r(e.nextElementSibling,!0),t||(t=r(e.parentElement.firstElementChild,!0))):t=r(window.siyuan.menus.menu.element.firstElementChild,!0),t&&(t.classList.add("b3-menu__item--current"),t.classList.remove("b3-menu__item--show"))}else if("ArrowUp"===e.code){const e=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");let t;e?(e.classList.remove("b3-menu__item--current","b3-menu__item--show"),t=r(e.previousElementSibling,!1),t||(t=r(e.parentElement.lastElementChild,!1))):t=r(window.siyuan.menus.menu.element.lastElementChild,!1),t&&(t.classList.add("b3-menu__item--current"),t.classList.remove("b3-menu__item--show"))}else{if("ArrowRight"===e.code){const e=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(!e)return!0;const t=e.querySelector(".b3-menu__submenu");if(!t)return!0;e.classList.remove("b3-menu__item--current"),e.classList.add("b3-menu__item--show");const n=r(t.firstElementChild,!0);n&&n.classList.add("b3-menu__item--current");const i=t.getBoundingClientRect();let a="";return i.right>window.innerWidth&&(i.left-t.clientWidth-i.width>0||Math.abs(i.left-t.clientWidth-i.width)<i.right-window.innerWidth)&&(a="left:auto;right:100%;"),i.bottom>window.innerHeight&&(a+=`top: auto;bottom:-5px;max-height:${Math.min(i.top,.4*window.innerHeight)}px`),a&&t.setAttribute("style",a),!0}if("ArrowLeft"===e.code){const e=window.siyuan.menus.menu.element.querySelector(".b3-menu__submenu .b3-menu__item--current");return!e||(e.parentElement.parentElement.classList.remove("b3-menu__item--show"),e.parentElement.parentElement.classList.add("b3-menu__item--current"),e.classList.remove("b3-menu__item--current"),!0)}if("Enter"===e.code){const e=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(!e)return!1;{const t=e.querySelector(".b3-text-field"),n=e.querySelector(".b3-switch");if(t)return t.focus(),!0;n?n.click():e.dispatchEvent(new CustomEvent((0,i.getEventName)())),window.siyuan.menus.menu.remove()}return!0}}if("ArrowUp"===e.code||"ArrowDown"===e.code){const e=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current"),t=e.parentElement;return t.classList.contains("b3-menu__submenu")&&(e.offsetTop+e.clientHeight>t.scrollTop+t.clientHeight?t.scrollTop=e.offsetTop+e.clientHeight-t.clientHeight:e.offsetTop<t.scrollTop&&(t.scrollTop=e.offsetTop)),!0}}},2964:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.movePathToMenu=t.renameMenu=t.deleteMenu=t.openMenu=t.exportMd=t.copySubMenu=t.openAttr=t.openFileAttr=t.openFileWechatNotify=t.openWechatNotify=void 0;const i=n(2041),a=n(6400),s=n(9883),o=n(6937),l=n(7821),r=n(532),d=n(7683),c=n(7491),u=n(3163),p=n(2386),m=n(1985),g=n(3029),b=n(1676),y=n(5680),f=n(8438),h=n(1762),w=(e,t)=>{e.addEventListener("keydown",(e=>{e.isComposing||(0,b.matchHotKey)("⌘↩",e)&&(t.dispatchEvent(new CustomEvent("click")),e.stopPropagation(),e.preventDefault())}))};t.openWechatNotify=e=>{const t=e.getAttribute("data-node-id"),n=(0,p.getEditorRange)(e),i=e.getAttribute("custom-reminder-wechat");let s="";i&&(s=y(i).format("YYYY-MM-DDTHH:mm"));const o=new u.Dialog({width:(0,a.isMobile)()?"80vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">\n    <div class="fn__flex">\n        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>\n        <div class="fn__space"></div>\n        <input class="b3-text-field fn__flex-1" type="datetime-local" value="${s}">\n    </div>\n    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>\n</div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>\n</div>`,destroyCallback(){(0,p.focusByRange)(n)}}),l=o.element.querySelectorAll(".b3-button");l[0].addEventListener("click",(()=>{o.destroy()})),l[1].addEventListener("click",(()=>{l[1].getAttribute("disabled")||(l[1].setAttribute("disabled","disabled"),(0,d.fetchPost)("/api/block/setBlockReminder",{id:t,timed:"0"},(()=>{e.removeAttribute("custom-reminder-wechat"),o.destroy()})))})),l[2].addEventListener("click",(()=>{const n=o.element.querySelector("input").value;if(n){if(new Date(n)<=new Date)return void(0,c.showMessage)(window.siyuan.languages.reminderTip);if(l[2].getAttribute("disabled"))return;l[2].setAttribute("disabled","disabled");const i=y(n).format("YYYYMMDDHHmmss");(0,d.fetchPost)("/api/block/setBlockReminder",{id:t,timed:i},(()=>{e.setAttribute("custom-reminder-wechat",i),o.destroy()}))}else(0,c.showMessage)(window.siyuan.languages.notEmpty)}))};t.openFileWechatNotify=e=>{(0,d.fetchPost)("/api/block/getDocInfo",{id:e.block.rootID},(t=>{const n=t.data.ial["custom-reminder-wechat"];let i="";n&&(i=y(n).format("YYYY-MM-DDTHH:mm"));const s=new u.Dialog({width:(0,a.isMobile)()?"80vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">\n    <div class="fn__flex">\n        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>\n        <div class="fn__space"></div>\n        <input class="b3-text-field fn__flex-1" type="datetime-local" value="${i}">\n    </div>\n    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>\n</div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>\n</div>`}),o=s.element.querySelectorAll(".b3-button");o[0].addEventListener("click",(()=>{s.destroy()})),o[1].addEventListener("click",(()=>{(0,d.fetchPost)("/api/block/setBlockReminder",{id:e.block.rootID,timed:"0"},(()=>{s.destroy()}))})),o[2].addEventListener("click",(()=>{const t=s.element.querySelector("input").value;if(t){if(new Date(t)<=new Date)return void(0,c.showMessage)(window.siyuan.languages.reminderTip);(0,d.fetchPost)("/api/block/setBlockReminder",{id:e.block.rootID,timed:y(t).format("YYYYMMDDHHmmss")},(()=>{s.destroy()}))}else(0,c.showMessage)(window.siyuan.languages.notEmpty)}))}))};t.openFileAttr=(e,t,n="bookmark")=>{let i="",s="";Object.keys(e).forEach((t=>{"custom-reminder-wechat"===t?s=`<label class="fn__flex customItem">\n    <span class="ft__on-surface fn__flex-center fn__ellipsis" style="text-align: right;width: 100px">${window.siyuan.languages.wechatReminder}</span>\n    <div class="fn__space"></div>\n    <input class="b3-text-field fn__flex-1" type="datetime-local" readonly data-name="${t}" value="${y(e[t]).format("YYYY-MM-DDTHH:mm")}">\n    <div class="fn__space"></div>\n    <span class="block__icon fn__flex-center" style="opacity: 1;"><svg></svg></span>\n</label><div class="fn__hr--b"></div>`:t.indexOf("custom")>-1&&(i+=`<label class="fn__flex customItem">\n    <span class="ft__on-surface fn__flex-center fn__ellipsis" title="${t.replace("custom-","")}" style="text-align: right;width: 100px">${t.replace("custom-","")}</span>\n    <div class="fn__space"></div>\n    <textarea class="b3-text-field fn__flex-1" rows="1" data-name="${t}">${e[t]}</textarea>\n    <div class="fn__space"></div>\n    <span data-action="remove" class="block__icon fn__flex-center" style="opacity: 1;"><svg><use xlink:href="#iconMin"></use></svg></span>\n</label><div class="fn__hr--b"></div>`)}));const r=new u.Dialog({width:(0,a.isMobile)()?"80vw":"50vw",title:window.siyuan.languages.attr,content:`<div class="b3-dialog__content custom-attr">\n    <div class="fn__flex">\n        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.bookmark}</span>\n        <div class="fn__space"></div>\n        <input class="b3-text-field fn__flex-1" data-name="bookmark">\n        <div class="fn__space"></div>\n        <span data-action="bookmark" class="block__icon fn__flex-center" style="opacity: 1;"><svg><use xlink:href="#iconDown"></use></svg></span>\n    </div>\n    <div class="fn__hr--b"></div>\n    <label class="fn__flex">\n        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.name}</span>\n        <div class="fn__space"></div>\n        <input class="b3-text-field fn__flex-1" data-name="name">\n        <div class="fn__space"></div>\n        <span class="block__icon fn__flex-center"><svg></svg></span>\n    </label>\n    <div class="fn__hr--b"></div>\n    <label class="fn__flex">\n        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.alias}</span>\n        <div class="fn__space"></div>\n        <input class="b3-text-field fn__flex-1" data-name="alias">\n        <div class="fn__space"></div>\n        <span class="block__icon fn__flex-center"><svg></svg></span>\n    </label>\n    <div class="fn__hr--b"></div>\n    <label class="fn__flex">\n        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.memo}</span>\n        <div class="fn__space"></div>\n        <textarea rows="2" class="b3-text-field fn__flex-1" data-name="memo">${e.memo||""}</textarea>\n        <div class="fn__space"></div>\n        <span class="block__icon fn__flex-center"><svg></svg></span>\n    </label>\n    <div style="background-color: var(--b3-border-color);height: 1px;margin: 16px 0;"></div>\n    <div class="custom-attr__add">\n        ${s}\n        ${i}\n        <button class="b3-button b3-button--outline" style="width: 100px">\n            <svg><use xlink:href="#iconAdd"></use></svg>\n            ${window.siyuan.languages.addAttr}\n        </button>\n    </div>\n</div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>\n</div>`});r.element.querySelector('.b3-text-field[data-name="bookmark"]').value=e.bookmark||"",r.element.querySelector('.b3-text-field[data-name="name"]').value=e.name||"",r.element.querySelector('.b3-text-field[data-name="alias"]').value=e.alias||"";const p=[];r.element.addEventListener("click",(e=>{const t=e.target,n=(0,l.hasClosestByClassName)(t,"block__icon");if(n)switch(n.getAttribute("data-action")){case"remove":"SPAN"===n.parentElement.firstElementChild.tagName&&p.push(n.parentElement.querySelector("textarea").getAttribute("data-name")),n.parentElement.nextElementSibling.remove(),n.parentElement.remove();break;case"bookmark":(0,d.fetchPost)("/api/attr/getBookmarkLabels",{},(t=>{window.siyuan.menus.menu.remove(),0===t.data.length?window.siyuan.menus.menu.append(new o.MenuItem({label:window.siyuan.languages.emptyContent,type:"readonly"}).element):t.data.forEach((e=>{window.siyuan.menus.menu.append(new o.MenuItem({label:e,click(){n.parentElement.querySelector("input").value=e}}).element)})),window.siyuan.menus.menu.element.style.zIndex="310",window.siyuan.menus.menu.popup({x:e.clientX,y:e.clientY+16})}))}}));const m=r.element.querySelectorAll(".b3-button");m[0].addEventListener("click",(()=>{m[0].insertAdjacentHTML("beforebegin",`<div class="fn__flex customItem">\n    <input placeholder="${window.siyuan.languages.attrName}" class="b3-text-field" style="width: 100px;text-align: right">\n    <div class="fn__space"></div>\n    <textarea rows="1" class="b3-text-field fn__flex-1" placeholder="${window.siyuan.languages.attrValue1}"></textarea>\n    <div class="fn__space"></div>\n    <span data-action="remove" class="block__icon fn__flex-center" style="opacity: 1;"><svg><use xlink:href="#iconMin"></use></svg></span>\n</div><div class="fn__hr--b"></div>`);const e=r.element.querySelectorAll(".b3-text-field");e[e.length-2].focus(),w(e[e.length-1],m[2]),w(e[e.length-2],m[2])})),m[1].addEventListener("click",(()=>{r.destroy()})),m[2].addEventListener("click",(()=>{let e="",n="";const i={};r.element.querySelectorAll(".fn__flex-1").forEach((t=>{const a=t.getAttribute("data-name")||"custom-"+t.previousElementSibling.previousElementSibling.value;if(t.value.trim()){if(!/^[0-9a-zA-Z\-]*$/.test(a.replace("custom-",""))||"custom-"===a)return void(n+=a.replace("custom-","")+", ");i[a]=t.value;const s=Lute.EscapeHTMLStr(t.value);"bookmark"===a?e+=`<div class="protyle-attr--bookmark">${s}</div>`:"name"===a?e+=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${s}</div>`:"alias"===a?e+=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${s}</div>`:"memo"===a&&(e+=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${s}"><svg><use xlink:href="#iconM"></use></svg></div>`)}})),n&&(0,c.showMessage)(n.substr(0,n.length-2)+" "+window.siyuan.languages.invalid),(0,d.fetchPost)("/api/attr/resetBlockAttrs",{id:t,attrs:i},(()=>{})),r.destroy()})),r.element.querySelectorAll(".b3-text-field").forEach((e=>{n===e.getAttribute("data-name")&&e.focus(),w(e,m[2])}))};t.openAttr=(e,t,n="bookmark")=>{if("NodeThematicBreak"===e.getAttribute("data-type"))return;const i=e.getAttribute("data-node-id"),s=(0,p.getEditorRange)(e);(0,d.fetchPost)("/api/attr/getBlockAttrs",{id:i},(r=>{let g="",b="";Object.keys(r.data).forEach((e=>{"custom-reminder-wechat"===e?b=`<label class="fn__flex customItem">\n    <span class="ft__on-surface fn__flex-center fn__ellipsis" style="text-align: right;width: 100px">${window.siyuan.languages.wechatReminder}</span>\n    <div class="fn__space"></div>\n    <input class="b3-text-field fn__flex-1" type="datetime-local" readonly data-name="${e}" value="${y(r.data[e]).format("YYYY-MM-DDTHH:mm")}">\n    <div class="fn__space"></div>\n    <span class="block__icon fn__flex-center" style="opacity: 1;"><svg></svg></span>\n</label><div class="fn__hr--b"></div>`:e.indexOf("custom")>-1&&"custom-reminder-wechat"!==e&&(g+=`<label class="fn__flex customItem">\n    <span class="ft__on-surface fn__flex-center fn__ellipsis" style="text-align: right;width: 100px" title="${e.replace("custom-","")}">${e.replace("custom-","")}</span>\n    <div class="fn__space"></div>\n    <textarea class="b3-text-field fn__flex-1" rows="1" data-name="${e}">${r.data[e]}</textarea>\n    <div class="fn__space"></div>\n    <span data-action="remove" class="block__icon fn__flex-center" style="opacity: 1;"><svg><use xlink:href="#iconMin"></use></svg></span>\n</label><div class="fn__hr--b"></div>`)}));const h=new u.Dialog({width:(0,a.isMobile)()?"80vw":"50vw",title:window.siyuan.languages.attr,content:`<div class="b3-dialog__content custom-attr">\n    <div class="fn__flex">\n        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.bookmark}</span>\n        <div class="fn__space"></div>\n        <input class="b3-text-field fn__flex-1" data-name="bookmark">\n        <div class="fn__space"></div>\n        <span data-action="bookmark" class="block__icon fn__flex-center" style="opacity: 1;"><svg><use xlink:href="#iconDown"></use></svg></span>\n    </div>\n    <div class="fn__hr--b"></div>\n    <label class="fn__flex">\n        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.name}</span>\n        <div class="fn__space"></div>\n        <input class="b3-text-field fn__flex-1" data-name="name">\n        <div class="fn__space"></div>\n        <span class="block__icon fn__flex-center"><svg></svg></span>\n    </label>\n    <div class="fn__hr--b"></div>\n    <label class="fn__flex">\n        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.alias}</span>\n        <div class="fn__space"></div>\n        <input class="b3-text-field fn__flex-1" data-name="alias">\n        <div class="fn__space"></div>\n        <span class="block__icon fn__flex-center"><svg></svg></span>\n    </label>\n    <div class="fn__hr--b"></div>\n    <label class="fn__flex">\n        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.memo}</span>\n        <div class="fn__space"></div>\n        <textarea class="b3-text-field fn__flex-1" rows="2" data-name="memo">${r.data.memo||""}</textarea>\n        <div class="fn__space"></div>\n        <span class="block__icon fn__flex-center"><svg></svg></span>\n    </label>\n    <div style="background-color: var(--b3-border-color);height: 1px;margin: 16px 0;"></div>\n    <div class="custom-attr__add">\n        ${b}\n        ${g}\n        <button class="b3-button b3-button--outline" style="width: 100px">\n            <svg><use xlink:href="#iconAdd"></use></svg>\n            ${window.siyuan.languages.addAttr}\n        </button>\n    </div>\n</div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>\n</div>`,destroyCallback(){(0,p.focusByRange)(s)}});h.element.querySelector('.b3-text-field[data-name="bookmark"]').value=r.data.bookmark||"",h.element.querySelector('.b3-text-field[data-name="name"]').value=r.data.name||"",h.element.querySelector('.b3-text-field[data-name="alias"]').value=r.data.alias||"";const v=[];h.element.addEventListener("click",(e=>{const t=e.target,n=(0,l.hasClosestByClassName)(t,"block__icon");if(n)switch(n.getAttribute("data-action")){case"remove":"SPAN"===n.parentElement.firstElementChild.tagName&&v.push(n.parentElement.querySelector("textarea").getAttribute("data-name")),n.parentElement.nextElementSibling.remove(),n.parentElement.remove();break;case"bookmark":(0,d.fetchPost)("/api/attr/getBookmarkLabels",{},(t=>{window.siyuan.menus.menu.remove(),0===t.data.length?window.siyuan.menus.menu.append(new o.MenuItem({label:window.siyuan.languages.emptyContent,type:"readonly"}).element):t.data.forEach((e=>{window.siyuan.menus.menu.append(new o.MenuItem({label:e,click(){n.parentElement.querySelector("input").value=e}}).element)})),window.siyuan.menus.menu.element.style.zIndex="310",window.siyuan.menus.menu.popup({x:e.clientX,y:e.clientY+16})}))}}));const _=h.element.querySelectorAll(".b3-button");_[0].addEventListener("click",(()=>{_[0].insertAdjacentHTML("beforebegin",`<div class="fn__flex customItem">\n    <input placeholder="${window.siyuan.languages.attrName}" class="b3-text-field" style="width: 100px;text-align: right">\n    <div class="fn__space"></div>\n    <textarea class="b3-text-field fn__flex-1" rows="1" placeholder="${window.siyuan.languages.attrValue1}"></textarea>\n    <div class="fn__space"></div>\n    <span data-action="remove" class="block__icon fn__flex-center" style="opacity: 1;"><svg><use xlink:href="#iconMin"></use></svg></span>\n</div><div class="fn__hr--b"></div>`);const e=h.element.querySelectorAll(".b3-text-field");e[e.length-2].focus(),w(e[e.length-1],_[2]),w(e[e.length-2],_[2])})),_[1].addEventListener("click",(()=>{h.destroy()})),_[2].addEventListener("click",(()=>{let n="";const a=e.outerHTML;let s="";h.element.querySelectorAll(".fn__flex-1").forEach((t=>{const i=t.getAttribute("data-name")||"custom-"+t.previousElementSibling.previousElementSibling.value;if(t.value.trim()){if(!/^[0-9a-zA-Z\-]*$/.test(i.replace("custom-",""))||"custom-"===i)return void(s+=i.replace("custom-","")+", ");v.includes(i)&&v.find(((e,t)=>{if(e===i)return v.splice(t,1),!0}));const a=Lute.EscapeHTMLStr(t.value);e.setAttribute(i,a),"bookmark"===i?n+=`<div class="protyle-attr--bookmark">${a}</div>`:"name"===i?n+=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${a}</div>`:"alias"===i?n+=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${a}</div>`:"memo"===i&&(n+=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${a}"><svg><use xlink:href="#iconM"></use></svg></div>`)}else e.removeAttribute(i)})),v.forEach((t=>{e.removeAttribute(t)})),s&&(0,c.showMessage)(s.substr(0,s.length-2)+" "+window.siyuan.languages.invalid);const o=e.lastElementChild.querySelector(".protyle-attr--refcount");o&&(n+=o.outerHTML),e.lastElementChild.innerHTML=n+f.Constants.ZWSP,(0,m.updateTransaction)(t,i,e.outerHTML,a),h.destroy()})),h.element.querySelectorAll(".b3-text-field").forEach((e=>{n===e.getAttribute("data-name")&&e.focus(),w(e,_[2])}))}))};t.copySubMenu=(e,t,n=!0,i)=>[{icon:"iconGraph",accelerator:n?window.siyuan.config.keymap.editor.general.copyBlockRef.custom:void 0,label:window.siyuan.languages.copyBlockRef,click:()=>{t?(0,r.writeText)(`((${e} "${t}"))`):(0,d.fetchPost)("/api/block/getRefText",{id:e},(t=>{(0,r.writeText)(`((${e} '${t.data}'))`)})),i&&(0,p.focusBlock)(i)}},{icon:"iconSQL",label:window.siyuan.languages.copyBlockEmbed,accelerator:n?window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom:void 0,click:()=>{(0,r.writeText)(`{{select * from blocks where id='${e}'}}`),i&&(0,p.focusBlock)(i)}},{icon:"iconSiYuan",label:window.siyuan.languages.copyProtocol,accelerator:n?window.siyuan.config.keymap.editor.general.copyProtocol.custom:void 0,click:()=>{(0,r.writeText)(`siyuan://blocks/${e}`),i&&(0,p.focusBlock)(i)}},{label:window.siyuan.languages.copyHPath,accelerator:n?window.siyuan.config.keymap.editor.general.copyHPath.custom:void 0,click:()=>{(0,d.fetchPost)("/api/filetree/getHPathByID",{id:e},(e=>{(0,r.writeText)(e.data)}))}},{label:window.siyuan.languages.copyID,accelerator:n?window.siyuan.config.keymap.editor.general.copyID.custom:void 0,click:()=>{(0,r.writeText)(e),i&&(0,p.focusBlock)(i)}}];t.exportMd=e=>new o.MenuItem({label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{label:window.siyuan.languages.template,icon:"iconMarkdown",click:()=>{(0,d.fetchPost)("/api/template/docSaveAsTemplate",{id:e,overwrite:!1},(t=>{1!==t.code?(0,c.showMessage)(window.siyuan.languages.exportTplSucc):(0,i.confirmDialog)(window.siyuan.languages.export,window.siyuan.languages.exportTplTip,(()=>{(0,d.fetchPost)("/api/template/docSaveAsTemplate",{id:e,overwrite:!0})}))}))}},{label:"Markdown",icon:"iconMarkdown",click:()=>{const t=(0,c.showMessage)(window.siyuan.languages.exporting,-1);(0,d.fetchPost)("/api/export/exportMd",{id:e},(e=>{(0,c.hideMessage)(t),(0,r.openByMobile)(e.data.zip)}))}},{label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const t=(0,c.showMessage)(window.siyuan.languages.exporting,-1);(0,d.fetchPost)("/api/export/exportSY",{id:e},(e=>{(0,c.hideMessage)(t),(0,r.openByMobile)(e.data.zip)}))}}]}).element;t.openMenu=(e,t,n)=>{const i=[];if((0,s.isLocalPath)(e)&&f.Constants.SIYUAN_ASSETS_EXTS.includes((0,s.pathPosix)().extname(e))&&(!e.endsWith(".pdf")||e.endsWith(".pdf")&&e.startsWith("file://")),i.push({label:window.siyuan.languages.useBrowserView,accelerator:n?"Click":"",click:()=>{(0,r.openByMobile)(e)}}),t)return i;window.siyuan.menus.menu.append(new o.MenuItem({label:window.siyuan.languages.openBy,submenu:i}).element)};t.deleteMenu=(e,t,n)=>new o.MenuItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"⌦",click:()=>{(0,h.deleteFile)(e,n,t)}}).element;t.renameMenu=e=>new o.MenuItem({accelerator:window.siyuan.config.keymap.editor.general.rename.custom,label:window.siyuan.languages.rename,click:()=>{(0,g.rename)(e)}}).element;t.movePathToMenu=(e,t)=>new o.MenuItem({label:window.siyuan.languages.move,icon:"iconMove",accelerator:window.siyuan.config.keymap.general.move.custom,click(){(0,s.movePathTo)(e,t)}}).element},8445:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Menus=void 0;const i=n(6937),a=n(7821);t.Menus=class{constructor(){this.menu=new i.Menu}getDir(e){const t=(0,a.hasTopClosestByTag)(e,"UL");if(t)return t.getAttribute("data-url")}unselect(){getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!0)}}},1699:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.initFileMenu=t.initNavigationMenu=void 0;const i=n(2964),a=n(6937),s=n(9883),o=n(7491),l=n(7683),r=n(7031),d=n(2041),c=n(8438),u=n(9972);t.initNavigationMenu=e=>{const t=e.parentElement.getAttribute("data-url"),n=(0,s.getNotebookName)(t);return window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new a.MenuItem({icon:"iconFile",label:window.siyuan.languages.newFile,click:()=>{(0,u.newFile)(t,"/",!0)}}).element),window.siyuan.menus.menu.append(new a.MenuItem({type:"separator"}).element),window.siyuan.config.readonly||window.siyuan.menus.menu.append((0,i.renameMenu)({path:"/",notebookId:t,name:n,type:"notebook"})),window.siyuan.menus.menu.append(new a.MenuItem({label:window.siyuan.languages.config,icon:"iconSettings",click:()=>{(0,l.fetchPost)("/api/notebook/getNotebookConf",{notebook:t},(e=>{(0,r.onGetnotebookconf)(e.data)}))}}).element),window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new a.MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new a.MenuItem({label:window.siyuan.languages.close,icon:"iconClose",click:()=>{(0,l.fetchPost)("/api/notebook/closeNotebook",{notebook:t})}}).element),window.siyuan.menus.menu.append(new a.MenuItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"⌦",click:()=>{(0,d.confirmDialog)(window.siyuan.languages.delete,`${window.siyuan.languages.confirmDelete} <b>${Lute.EscapeHTMLStr(n)}</b>?`,(()=>{(0,l.fetchPost)("/api/notebook/removeNotebook",{notebook:t,callback:c.Constants.CB_MOUNT_REMOVE})}))}}).element)),window.siyuan.menus.menu.append(new a.MenuItem({type:"separator"}).element),p(t,"/"),window.siyuan.menus.menu.append(new a.MenuItem({label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{label:"Markdown",icon:"iconMarkdown",click:()=>{const e=(0,o.showMessage)(window.siyuan.languages.exporting,-1);(0,l.fetchPost)("/api/export/batchExportMd",{notebook:t,path:"/"},(t=>{(0,o.hideMessage)(e),window.open(t.data.zip)}))}},{label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const e=(0,o.showMessage)(window.siyuan.languages.exporting,-1);(0,l.fetchPost)("/api/export/exportNotebookSY",{id:t},(t=>{(0,o.hideMessage)(e),window.open(t.data.zip)}))}}]}).element),window.siyuan.menus.menu};t.initFileMenu=(e,t,n)=>{const o=n.getAttribute("data-node-id");let r=n.getAttribute("data-name");return window.siyuan.menus.menu.remove(),r=(0,s.getDisplayName)(r,!1,!0),window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new a.MenuItem({icon:"iconFile",label:window.siyuan.languages.newSubDoc,click:()=>{(0,u.newFile)(e,t,!0)}}).element),6===window.siyuan.config.fileTree.sort&&(window.siyuan.menus.menu.append(new a.MenuItem({icon:"iconBefore",label:window.siyuan.languages.newDocAbove,click:()=>{const i=[];Array.from(n.parentElement.children).forEach((e=>{"LI"===e.tagName&&(e.isSameNode(n)&&i.push(void 0),i.push(e.getAttribute("data-path")))})),(0,u.newFile)(e,(0,s.pathPosix)().dirname(t),!0,i)}}).element),window.siyuan.menus.menu.append(new a.MenuItem({icon:"iconAfter",label:window.siyuan.languages.newDocBelow,click:()=>{const i=[];Array.from(n.parentElement.children).forEach((e=>{"LI"===e.tagName&&(i.push(e.getAttribute("data-path")),e.isSameNode(n)&&i.push(void 0))})),(0,u.newFile)(e,(0,s.pathPosix)().dirname(t),!0,i)}}).element)),window.siyuan.menus.menu.append(new a.MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new a.MenuItem({label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:(0,i.copySubMenu)(o,"",!1).concat([{label:window.siyuan.languages.duplicate,click(){(0,l.fetchPost)("/api/filetree/duplicateDoc",{id:o})}}])}).element),window.siyuan.menus.menu.append((0,i.movePathToMenu)(e,t)),window.siyuan.menus.menu.append((0,i.deleteMenu)(e,r,t)),window.siyuan.menus.menu.append(new a.MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append((0,i.renameMenu)({path:t,notebookId:e,name:r,type:"file"})),window.siyuan.menus.menu.append(new a.MenuItem({label:window.siyuan.languages.attr,click(){(0,l.fetchPost)("/api/block/getDocInfo",{id:o},(e=>{(0,i.openFileAttr)(e.data.ial,o)}))}}).element),window.siyuan.menus.menu.append(new a.MenuItem({type:"separator"}).element)),p(e,t),window.siyuan.menus.menu.append((0,i.exportMd)(o)),window.siyuan.menus.menu};const p=(e,t)=>{window.siyuan.config.readonly||window.siyuan.menus.menu.append(new a.MenuItem({icon:"iconDownload",label:window.siyuan.languages.import,submenu:[{icon:"iconSiYuan",label:'SiYuan .sy.zip<input class="b3-form__upload" type="file" accept="application/zip">',bind:n=>{n.querySelector(".b3-form__upload").addEventListener("change",(n=>{const i=new FormData;i.append("file",n.target.files[0]),i.append("notebook",e),i.append("toPath",t),(0,l.fetchPost)("/api/import/importSY",i)}))}}]}).element)}},7031:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onGetnotebookconf=void 0;const i=n(3163),a=n(7683),s=n(6400),o=n(9755),l=n(532),r=n(7491);t.onGetnotebookconf=e=>{const t=`<div class="fn__flex">${(0,o.escapeHtml)(e.name)}\n<div class="fn__space"></div>\n<button class="b3-button b3-button--small">${window.siyuan.languages.copy} ID</button></div>`,n=`<div style="max-height: 80vh;overflow: auto;">\n<div class="b3-label">\n    ${window.siyuan.languages.fileTree12}\n    <div class="fn__hr"></div>\n    <div class="b3-label__text">${window.siyuan.languages.fileTree13}</div>\n    <div class="fn__hr"></div>\n    <input class="b3-text-field fn__flex-center fn__block" id="createDocNameTemplate" value="">\n</div>\n<div class="b3-label">\n    ${window.siyuan.languages.fileTree5}\n    <div class="fn__hr"></div>\n    <div class="b3-label__text">${window.siyuan.languages.fileTree6}</div>\n    <div class="fn__hr"></div>\n    <input class="b3-text-field fn__flex-center fn__block" id="refCreateSavePath" value="${window.siyuan.config.fileTree.refCreateSavePath}">\n</div>\n<div class="b3-label">\n    ${window.siyuan.languages.fileTree11}\n    <div class="fn__hr"></div>\n    <div class="b3-label__text">${window.siyuan.languages.fileTree14}</div>\n    <div class="fn__hr"></div>\n    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteSavePath" value="">\n    <div class="fn__hr"></div>\n    <div class="b3-label__text">${window.siyuan.languages.fileTree15}</div>\n    <div class="fn__hr"></div>\n    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteTemplatePath" value="${e.conf.dailyNoteTemplatePath}">\n</div></div>`;let d;if((0,s.isMobile)())d=document.getElementById("model"),d.style.top="0",d.querySelector(".toolbar__icon").innerHTML='<use xlink:href="#iconSettings"></use>',d.querySelector(".toolbar__text").innerHTML=t,d.querySelector("#modelMain").innerHTML=n;else{d=new i.Dialog({width:"80vw",title:t,content:n}).element}d.querySelector(".b3-button--small").addEventListener("click",(()=>{(0,l.writeText)(e.box),(0,r.showMessage)(window.siyuan.languages.copied)}));const c=d.querySelector("#dailyNoteSavePath");c.value=e.conf.dailyNoteSavePath;const u=d.querySelector("#createDocNameTemplate");u.value=e.conf.createDocNameTemplate;const p=d.querySelector("#refCreateSavePath");p.value=e.conf.refCreateSavePath;const m=d.querySelector("#dailyNoteTemplatePath");m.value=e.conf.dailyNoteTemplatePath,d.querySelectorAll("input").forEach((t=>{t.addEventListener("change",(()=>{(0,a.fetchPost)("/api/notebook/setNotebookConf",{notebook:e.box,conf:{refCreateSavePath:p.value,createDocNameTemplate:u.value,dailyNoteSavePath:c.value,dailyNoteTemplatePath:m.value}})}))}))}},6112:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,s){function o(e){try{r(i.next(e))}catch(e){s(e)}}function l(e){try{r(i.throw(e))}catch(e){s(e)}}function r(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,l)}r((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.setFold=t.tableMenu=t.videoMenu=t.iframeMenu=t.linkMenu=t.imgMenu=t.zoomOut=t.contentMenu=t.refMenu=void 0;const a=n(7821),s=n(6937),o=n(2386),l=n(1301),r=n(2224),d=n(1985),c=n(2964),u=n(7683),p=n(8438),m=n(532),g=n(5788),b=n(1040),y=n(3343),f=n(6400),h=n(7406),w=n(1456),v=n(5680),_=n(4383),E=n(3029),k=n(3903),C=n(4433),x=n(706),L=n(251);t.refMenu=(e,t)=>{const n=(0,a.hasClosestBlock)(t);if(!n)return;const i=t.getAttribute("data-id"),l=n.getAttribute("data-node-id"),r=n.outerHTML;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new s.MenuItem({label:`<input style="margin: 4px 0" class="b3-text-field" placeholder="${window.siyuan.languages.anchor}">`,bind(a){const s=a.querySelector("input");s.value="d"===t.getAttribute("data-subtype")?"":t.textContent,s.addEventListener("blur",(i=>{n.outerHTML!==r&&(n.setAttribute("updated",v().format("YYYYMMDDHHmmss")),t.setAttribute("data-subtype",s.value?"s":"d"),(0,d.updateTransaction)(e,l,n.outerHTML,r)),e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),(0,o.focusByRange)(e.toolbar.range),i.stopPropagation()})),s.addEventListener("input",(()=>{s.value?t.textContent=Lute.EscapeHTMLStr(s.value):(0,u.fetchPost)("/api/block/getRefText",{id:i},(e=>{t.innerHTML=e.data}))})),s.addEventListener("keydown",(e=>{if("Enter"!==e.key||e.isComposing){if((0,C.electronUndo)(e))return}else window.siyuan.menus.menu.remove()}))}}).element),window.siyuan.menus.menu.append(new s.MenuItem({type:"separator"}).element);let c=[];"s"===t.getAttribute("data-subtype")?c.push({label:window.siyuan.languages.turnToDynamic,click(){t.setAttribute("data-subtype","d"),(0,u.fetchPost)("/api/block/getRefText",{id:i},(i=>{t.innerHTML=i.data,n.setAttribute("updated",v().format("YYYYMMDDHHmmss")),(0,d.updateTransaction)(e,l,n.outerHTML,r)})),(0,o.focusByRange)(e.toolbar.range)}}):c.push({label:window.siyuan.languages.turnToStatic,click(){t.setAttribute("data-subtype","s"),n.setAttribute("updated",v().format("YYYYMMDDHHmmss")),(0,d.updateTransaction)(e,l,n.outerHTML,r),(0,o.focusByRange)(e.toolbar.range)}}),c=c.concat([{label:window.siyuan.languages.text,click(){t.outerHTML=`${t.innerHTML}<wbr>`,n.setAttribute("updated",v().format("YYYYMMDDHHmmss")),(0,d.updateTransaction)(e,l,n.outerHTML,r),(0,o.focusByWbr)(n,e.toolbar.range)}},{label:"*",click(){t.setAttribute("data-subtype","s"),t.textContent="*",n.setAttribute("updated",v().format("YYYYMMDDHHmmss")),(0,d.updateTransaction)(e,l,n.outerHTML,r),(0,o.focusByRange)(e.toolbar.range)}},{label:window.siyuan.languages.text+" *",click(){t.insertAdjacentHTML("beforebegin",t.innerHTML+" "),t.setAttribute("data-subtype","s"),t.textContent="*",n.setAttribute("updated",v().format("YYYYMMDDHHmmss")),(0,d.updateTransaction)(e,l,n.outerHTML,r),(0,o.focusByRange)(e.toolbar.range)}},{label:window.siyuan.languages.link,icon:"iconLink",click(){t.outerHTML=`<span data-type="a" data-href="siyuan://blocks/${t.getAttribute("data-id")}">${t.innerHTML}</span><wbr>`,n.setAttribute("updated",v().format("YYYYMMDDHHmmss")),(0,d.updateTransaction)(e,l,n.outerHTML,r),(0,o.focusByWbr)(n,e.toolbar.range)}}]),t.parentElement.textContent.trim()===t.textContent.trim()&&"DIV"===t.parentElement.tagName&&c.push({label:window.siyuan.languages.blockEmbed,icon:"iconSQL",click(){const t=`<div data-content="select * from blocks where id='${i}'" data-node-id="${l}" data-type="NodeBlockQueryEmbed" class="render-node" updated="${v().format("YYYYMMDDHHmmss")}">${n.querySelector(".protyle-attr").outerHTML}</div>`;n.outerHTML=t,(0,d.updateTransaction)(e,l,t,r),(0,_.blockRender)(e,e.wysiwyg.element)}}),window.siyuan.menus.menu.append(new s.MenuItem({label:window.siyuan.languages.turnInto,icon:"iconRefresh",submenu:c}).element),window.siyuan.menus.menu.append(new s.MenuItem({label:window.siyuan.languages.copy,icon:"iconCopy",click(){const e="s"===t.getAttribute("data-subtype")?'"':"'";(0,m.writeText)(`((${i} ${e}${t.textContent}${e}))`)}}).element),window.siyuan.menus.menu.append(new s.MenuItem({label:window.siyuan.languages.remove,icon:"iconTrashcan",click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),n.setAttribute("updated",v().format("YYYYMMDDHHmmss")),(0,d.updateTransaction)(e,l,n.outerHTML,r),(0,o.focusByWbr)(n,e.toolbar.range)}}).element);const p=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:p.left,y:p.top+26,h:26}),window.siyuan.menus.menu.element.querySelector("input").select()};t.contentMenu=(e,n)=>{const l=(0,o.getEditorRange)(n);if(window.siyuan.menus.menu.remove(),""!==l.toString()&&(window.siyuan.menus.menu.append(new s.MenuItem({icon:"iconCopy",accelerator:"⌘C",label:window.siyuan.languages.copy,click(){(0,o.focusByRange)((0,o.getEditorRange)(n)),document.execCommand("copy")}}).element),window.siyuan.menus.menu.append(new s.MenuItem({label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){(0,o.focusByRange)((0,o.getEditorRange)(n));const e=getSelection().getRangeAt(0).cloneContents();e.querySelectorAll('[data-type="backslash"]').forEach((e=>{e.firstElementChild.remove()})),(0,m.writeText)(e.textContent)}}).element),window.siyuan.menus.menu.append(new s.MenuItem({label:window.siyuan.languages.copy+" HTML",click(){(0,o.focusByRange)((0,o.getEditorRange)(n));let t="";getSelection().getRangeAt(0).cloneContents().childNodes.forEach((e=>{3===e.nodeType?t+=e.textContent:t+=e.outerHTML}));const i=document.createElement("template");i.innerHTML=e.lute.BlockDOM2HTML(t),(0,m.writeText)(i.content.firstElementChild.innerHTML)}}).element),window.siyuan.menus.menu.append(new s.MenuItem({icon:"iconCut",accelerator:"⌘X",label:window.siyuan.languages.cut,click(){(0,o.focusByRange)((0,o.getEditorRange)(n)),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new s.MenuItem({icon:"iconTrashcan",accelerator:"⌫",label:window.siyuan.languages.delete,click(){const t=(0,o.getEditorRange)(n);t.insertNode(document.createElement("wbr"));const i=n.outerHTML;t.extractContents(),(0,o.focusByWbr)(n,t),(0,o.focusByRange)(t),(0,d.updateTransaction)(e,n.getAttribute("data-node-id"),n.outerHTML,i)}}).element)),window.siyuan.menus.menu.append(new s.MenuItem({label:window.siyuan.languages.paste,accelerator:"⌘V",click(){return i(this,void 0,void 0,(function*(){if(document.queryCommandSupported("paste"))document.execCommand("paste");else try{const t=yield navigator.clipboard.readText();(0,y.pasteText)(e,t,n)}catch(e){console.log(e)}}))}}).element),window.siyuan.menus.menu.append(new s.MenuItem({label:window.siyuan.languages.pasteEscaped,click(){return i(this,void 0,void 0,(function*(){try{let t=yield navigator.clipboard.readText();t=t.replace(/\\/g,"\\\\").replace(/\*/g,"\\*").replace(/\_/g,"\\_").replace(/\[/g,"\\[").replace(/\]/g,"\\]").replace(/\!/g,"\\!").replace(/\`/g,"\\`").replace(/\</g,"\\<").replace(/\>/g,"\\>").replace(/\&/g,"\\&").replace(/\~/g,"\\~").replace(/\{/g,"\\{").replace(/\}/g,"\\}").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/\=/g,"\\=").replace(/\#/g,"\\#").replace(/\$/g,"\\$").replace(/\^/g,"\\^").replace(/\|/g,"\\|"),(0,y.pasteText)(e,t,n)}catch(e){console.log(e)}}))}}).element),window.siyuan.menus.menu.append(new s.MenuItem({label:window.siyuan.languages.selectAll,accelerator:"⌘A",click(){(0,o.selectAll)(e,n,l)}}).element),n.classList.contains("table")){const i=(0,a.hasClosestByMatchTag)(l.startContainer,"TD")||(0,a.hasClosestByMatchTag)(l.startContainer,"TH");i&&window.siyuan.menus.menu.append(new s.MenuItem({type:"submenu",icon:"iconTable",label:window.siyuan.languages.table,submenu:(0,t.tableMenu)(e,n,i,l)}).element)}};t.zoomOut=(e,t,n,i=!0,a)=>{var s;const l=null===(s=e.breadcrumb)||void 0===s?void 0:s.element.querySelector(".protyle-breadcrumb__item--active");if(l&&l.getAttribute("data-node-id")===t){if(t===e.block.rootID)return;const i=e.wysiwyg.element.querySelector(`[data-node-id="${n||t}"]`);if(i)return(0,o.focusBlock)(i),void i.scrollIntoView()}window.siyuan.mobileEditor&&(window.localStorage.setItem(p.Constants.LOCAL_DOCINFO,JSON.stringify({id:t,action:t===e.block.rootID?[p.Constants.CB_GET_HL,p.Constants.CB_GET_CONTEXT]:[p.Constants.CB_GET_ALL]})),i&&(0,x.pushBack)()),(0,u.fetchPost)("/api/filetree/getDoc",{id:t,size:t===e.block.rootID?p.Constants.SIZE_GET:p.Constants.SIZE_GET_MAX},(s=>{if(i?(0,b.onGet)(s,e,t===e.block.rootID?[p.Constants.CB_GET_FOCUS]:[p.Constants.CB_GET_ALL,p.Constants.CB_GET_FOCUS]):(0,b.onGet)(s,e,t===e.block.rootID?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_UNUNDO]:[p.Constants.CB_GET_ALL,p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_UNUNDO]),n){const a=e.wysiwyg.element.querySelector(`[data-node-id="${n}"]`);if(a)(0,o.focusBlock)(a),a.scrollIntoView();else if(t===e.block.rootID)return void(0,u.fetchPost)("/api/filetree/getDoc",{id:n,mode:3,size:p.Constants.SIZE_GET},(t=>{(0,b.onGet)(t,e,i?[p.Constants.CB_GET_FOCUS]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_UNUNDO])}))}a&&a()}))};t.imgMenu=(e,t,n,i)=>{window.siyuan.menus.menu.remove();const l=(0,a.hasClosestBlock)(n);if(!l)return;const u=l.getAttribute("data-node-id"),g=n.querySelector("img"),b=n.querySelector(".protyle-action__title");let y=l.outerHTML;window.siyuan.menus.menu.append(new s.MenuItem({label:`<div class="fn__hr--small"></div><input class="b3-text-field fn__size200" value="${g.getAttribute("src")}" placeholder="${window.siyuan.languages.imageURL}"><div class="fn__hr--small"></div>`,bind(t){t.querySelector("input").addEventListener("change",(t=>{const i=t.target.value;if(g.setAttribute("src",i),g.setAttribute("data-src",i),i.startsWith("assets/")){const e=n.querySelector(".img__net");e&&e.remove()}else window.siyuan.config.editor.displayNetImgMark&&n.querySelector(".protyle-action__drag").insertAdjacentHTML("afterend",'<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>');l.setAttribute("updated",v().format("YYYYMMDDHHmmss")),(0,d.updateTransaction)(e,u,l.outerHTML,y),y=l.outerHTML}))}}).element),window.siyuan.menus.menu.append(new s.MenuItem({label:`<div class="fn__hr--small"></div><input class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.title}"><div class="fn__hr--small"></div>`,bind(t){const i=t.querySelector("input");i.value=b.textContent,i.addEventListener("input",(e=>{const t=e.target.value;g.setAttribute("title",t),b.textContent=t,(0,r.mathRender)(b),n.style.maxWidth=g.clientWidth+10+"px"})),i.addEventListener("change",(()=>{l.setAttribute("updated",v().format("YYYYMMDDHHmmss")),(0,d.updateTransaction)(e,u,l.outerHTML,y),y=l.outerHTML}))}}).element),window.siyuan.menus.menu.append(new s.MenuItem({label:`<div class="fn__hr--small"></div><input class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.tooltipText}"><div class="fn__hr--small"></div>`,bind(t){const n=t.querySelector("input");n.value=g.getAttribute("alt")||"",n.addEventListener("change",(t=>{g.setAttribute("alt",t.target.value),l.setAttribute("updated",v().format("YYYYMMDDHHmmss")),(0,d.updateTransaction)(e,u,l.outerHTML,y),y=l.outerHTML}))}}).element),window.siyuan.menus.menu.append(new s.MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new s.MenuItem({label:window.siyuan.languages.copy,accelerator:"⌘C",icon:"iconCopy",click(){(0,m.writeText)(e.lute.BlockDOM2StdMd(n.outerHTML))}}).element),window.siyuan.menus.menu.append(new s.MenuItem({label:window.siyuan.languages.copy+" PNG",icon:"iconImage",click(){if("android"===window.siyuan.config.system.container&&window.JSAndroid)window.JSAndroid.writeImageClipboard(g.getAttribute("src"));else{const e=document.createElement("canvas"),t=document.createElement("img");t.onload=t=>{e.width=t.target.width,e.height=t.target.height,e.getContext("2d").drawImage(t.target,0,0,t.target.width,t.target.height),e.toBlob((e=>{navigator.clipboard.write([new ClipboardItem({"image/png":e})])}),"image/png",1)},t.src=g.getAttribute("src")}}}).element),window.siyuan.menus.menu.append(new s.MenuItem({icon:"iconCut",accelerator:"⌘X",label:window.siyuan.languages.cut,click(){(0,m.writeText)(e.lute.BlockDOM2StdMd(n.outerHTML)),n.outerHTML="<wbr>",l.setAttribute("updated",v().format("YYYYMMDDHHmmss")),(0,d.updateTransaction)(e,u,l.outerHTML,y),(0,o.focusByWbr)(e.wysiwyg.element,t)}}).element),window.siyuan.menus.menu.append(new s.MenuItem({icon:"iconTrashcan",accelerator:"⌫",label:window.siyuan.languages.delete,click:function(){n.outerHTML="<wbr>",l.setAttribute("updated",v().format("YYYYMMDDHHmmss")),(0,d.updateTransaction)(e,u,l.outerHTML,y),(0,o.focusByWbr)(e.wysiwyg.element,t)}}).element),window.siyuan.menus.menu.append(new s.MenuItem({type:"separator"}).element);const h=g.getAttribute("data-src");h.startsWith("assets/")&&window.siyuan.menus.menu.append(new s.MenuItem({label:window.siyuan.languages.rename,click(){(0,E.renameAsset)(h)}}).element),window.siyuan.menus.menu.append(new s.MenuItem({icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click(){l.setAttribute("updated",v().format("YYYYMMDDHHmmss")),n.style.display="block";let t=n.nextSibling;for(;t;){if(""!==t.textContent){if(t.textContent===p.Constants.ZWSP){t.textContent="";break}break}t=t.nextSibling}(0,d.updateTransaction)(e,u,l.outerHTML,y)}}).element),window.siyuan.menus.menu.append(new s.MenuItem({icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click(){l.setAttribute("updated",v().format("YYYYMMDDHHmmss")),n.style.display="",(0,k.hasNextSibling)(n)||n.insertAdjacentText("afterend",p.Constants.ZWSP),(0,d.updateTransaction)(e,u,l.outerHTML,y)}}).element);const w=parseInt(n.style.width||"0");window.siyuan.menus.menu.append(new s.MenuItem({label:window.siyuan.languages.width,submenu:[S("25%",n,g,e,u,l,y),S("33%",n,g,e,u,l,y),S("50%",n,g,e,u,l,y),S("67%",n,g,e,u,l,y),S("75%",n,g,e,u,l,y),S("100%",n,g,e,u,l,y),{type:"separator"},{label:`<div aria-label="${0===w?window.siyuan.languages.default:w+"%"}" class="b3-tooltips b3-tooltips__n${(0,f.isMobile)()?"":" fn__size200"}">\n    <input style="box-sizing: border-box" value="${w}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">\n</div>`,bind(t){const i=t.querySelector("input");i.addEventListener("input",(()=>{n.style.width=i.value+"%",g.style.width="10000px",n.style.maxWidth="",i.parentElement.setAttribute("aria-label",`${i.value}%`)})),i.addEventListener("change",(()=>{l.setAttribute("updated",v().format("YYYYMMDDHHmmss")),(0,d.updateTransaction)(e,u,l.outerHTML,y),window.siyuan.menus.menu.remove(),(0,o.focusBlock)(l)}))}},{type:"separator"},S(window.siyuan.languages.default,n,g,e,u,l,y)]}).element);const _=g.getAttribute("src");_&&(window.siyuan.menus.menu.append(new s.MenuItem({type:"separator"}).element),(0,c.openMenu)(_,!1,!1)),window.siyuan.menus.menu.popup({x:i.clientX,y:i.clientY}),window.siyuan.menus.menu.element.querySelector("input").focus()};t.linkMenu=(e,t,n=!1)=>{window.siyuan.menus.menu.remove();const i=(0,a.hasClosestBlock)(t);if(!i)return;const l=i.getAttribute("data-node-id");let r=i.outerHTML;const u=t.getAttribute("data-href");window.siyuan.menus.menu.append(new s.MenuItem({label:`<div class="fn__hr--small"></div><input class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.link}"><div class="fn__hr--small"></div>`,bind(n){const a=n.querySelector("input");a.value=u||"",a.addEventListener("change",(()=>{t.setAttribute("data-href",a.value),(0,d.updateTransaction)(e,l,i.outerHTML,r),r=i.outerHTML})),a.addEventListener("keydown",(i=>{if("Enter"!==i.key&&"Escape"!==i.key||i.isComposing)if("Tab"!==i.key||i.isComposing){if((0,C.electronUndo)(i))return}else i.preventDefault(),i.stopPropagation(),n.nextElementSibling.querySelector("input").focus();else i.preventDefault(),i.stopPropagation(),""===t.textContent||t.textContent===p.Constants.ZWSP?(0,L.removeLink)(t,e.toolbar.range):(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),(0,o.focusByRange)(e.toolbar.range)),window.siyuan.menus.menu.remove()}))}}).element),window.siyuan.menus.menu.append(new s.MenuItem({label:`<div class="fn__hr--small"></div><input class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.anchor}"><div class="fn__hr--small"></div>`,bind(n){const a=n.querySelector("input");a.value=t.textContent.replace(p.Constants.ZWSP,""),a.addEventListener("change",(()=>{a.value||t.remove(),(0,d.updateTransaction)(e,l,i.outerHTML,r),r=i.outerHTML})),a.addEventListener("compositionend",(()=>{t.innerHTML=Lute.EscapeHTMLStr(a.value)||""})),a.addEventListener("input",(e=>{e.isComposing||(t.innerHTML=Lute.EscapeHTMLStr(a.value).replace(/\\]/g,'<span data-type="backslash"><span>\\</span>]</span>').replace(/\\\[/g,'<span data-type="backslash"><span>\\</span>[</span>')||"")})),a.addEventListener("keydown",(i=>{if("Enter"!==i.key&&"Escape"!==i.key||i.isComposing)if("Tab"!==i.key||i.isComposing){if((0,C.electronUndo)(i))return}else i.preventDefault(),i.stopPropagation(),i.shiftKey?n.previousElementSibling.querySelector("input").focus():n.nextElementSibling.querySelector("input").focus();else i.preventDefault(),i.stopPropagation(),a.value?(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),(0,o.focusByRange)(e.toolbar.range)):(0,L.removeLink)(t,e.toolbar.range),window.siyuan.menus.menu.remove()}))}}).element),window.siyuan.menus.menu.append(new s.MenuItem({label:`<div class="fn__hr--small"></div><input class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.title}"><div class="fn__hr--small"></div>`,bind(n){const a=n.querySelector("input");a.value=Lute.UnEscapeHTMLStr(t.getAttribute("data-title")||""),a.addEventListener("change",(()=>{a.value?t.setAttribute("data-title",Lute.EscapeHTMLStr(a.value)):t.removeAttribute("data-title"),(0,d.updateTransaction)(e,l,i.outerHTML,r),r=i.outerHTML})),a.addEventListener("keydown",(i=>{if("Enter"!==i.key&&"Escape"!==i.key||i.isComposing){if("Tab"===i.key&&i.shiftKey&&!i.isComposing)i.preventDefault(),i.stopPropagation(),n.previousElementSibling.querySelector("input").focus();else if((0,C.electronUndo)(i))return}else i.preventDefault(),i.stopPropagation(),""===t.textContent||t.textContent===p.Constants.ZWSP?(0,L.removeLink)(t,e.toolbar.range):(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),(0,o.focusByRange)(e.toolbar.range)),window.siyuan.menus.menu.remove()}))}}).element),u&&(0,c.openMenu)(u,!1,!0),(null==u?void 0:u.startsWith("siyuan://blocks/"))&&window.siyuan.menus.menu.append(new s.MenuItem({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.blockRef}</b>`,icon:"iconGraph",click(){t.setAttribute("data-subtype","s");const n=t.getAttribute("data-type").split(" ");n.push("block-ref"),n.splice(n.indexOf("a"),1),t.setAttribute("data-type",n.join(" ")),t.setAttribute("data-id",null==u?void 0:u.replace("siyuan://blocks/","")),t.removeAttribute("data-href"),t.removeAttribute("data-title"),i.setAttribute("updated",v().format("YYYYMMDDHHmmss")),(0,d.updateTransaction)(e,l,i.outerHTML,r),e.toolbar.range.selectNode(t),e.toolbar.range.collapse(!1),(0,o.focusByRange)(e.toolbar.range)}}).element),window.siyuan.menus.menu.append(new s.MenuItem({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){(0,L.removeLink)(t,e.toolbar.range)}}).element),(null==u?void 0:u.startsWith("assets/"))&&window.siyuan.menus.menu.append(new s.MenuItem({label:window.siyuan.languages.rename,click(){(0,E.renameAsset)(u)}}).element),window.siyuan.menus.menu.append(new s.MenuItem({icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){const n=i.outerHTML;t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),i.setAttribute("updated",v().format("YYYYMMDDHHmmss")),(0,d.updateTransaction)(e,l,i.outerHTML,n),(0,o.focusByWbr)(i,e.toolbar.range)}}).element);const m=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:m.left,y:m.top+26,h:26}),n||e.lute.IsValidLinkDest(u)?window.siyuan.menus.menu.element.querySelectorAll("input")[1].select():window.siyuan.menus.menu.element.querySelector("input").select()};const S=(e,t,n,i,a,s,l)=>({label:e,click(){s.setAttribute("updated",v().format("YYYYMMDDHHmmss")),t.style.width=e===window.siyuan.languages.default?"":e,n.style.width=e===window.siyuan.languages.default?"":"10000px",t.style.maxWidth=e===window.siyuan.languages.default?n.clientWidth+10+"px":"",(0,d.updateTransaction)(i,a,s.outerHTML,l),(0,o.focusBlock)(s)}});t.iframeMenu=(e,t)=>{const n=t.getAttribute("data-node-id"),i=t.querySelector("iframe");let a=t.outerHTML;const s=[{label:`<div class="fn__hr--small"></div><input style="margin: 4px 0" class="b3-text-field fn__size200" value="${i.getAttribute("src")||""}" placeholder="${window.siyuan.languages.link}"><div class="fn__hr--small"></div>`,bind(s){s.querySelector("input").addEventListener("change",(s=>{const o=s.target.value,l=o.match(/(?:www\.|\/\/)bilibili\.com\/video\/(\w+)/);if(o.indexOf("bilibili.com")>-1&&(o.indexOf("bvid=")>-1||l&&l[1])){const e={bvid:o.indexOf("bvid=")>-1?o.split("bvid=")[1].split("&")[0]:l&&l[1],page:"1",high_quality:"1",as_wide:"1",allowfullscreen:"true"};o.indexOf("player.bilibili.com/player.html")>-1&&new URL(o.startsWith("http")?o:"https:"+o).search.split("&").forEach(((t,n)=>{0===n&&(t=t.substr(1));const i=t.split("=");e[i[0]]=i[1]}));let t="https://player.bilibili.com/player.html?";const n=Object.keys(e);n.forEach(((i,a)=>{t+=`${i}=${e[i]}`,a<n.length-1&&(t+="&")})),i.setAttribute("src",t),i.setAttribute("sandbox","allow-top-navigation-by-user-activation allow-same-origin allow-forms allow-scripts allow-popups"),i.style.height||(i.style.height="360px"),i.style.width||(i.style.width="640px")}else i.setAttribute("src",o);(0,d.updateTransaction)(e,n,t.outerHTML,a),a=t.outerHTML,s.stopPropagation()}))}}],o=i.getAttribute("src");return o?(s.push({type:"separator"}),s.concat((0,c.openMenu)(o,!0,!1))):s};t.videoMenu=(e,t,n)=>{const i=t.getAttribute("data-node-id"),a=t.querySelector("NodeVideo"===n?"video":"audio");let s=t.outerHTML;const o=[{label:`<input style="margin: 4px 0" class="b3-text-field" value="${a.getAttribute("src")}" placeholder="${window.siyuan.languages.link}">`,bind(n){n.querySelector("input").addEventListener("change",(n=>{const o=n.target.value;a.setAttribute("src",o),(0,d.updateTransaction)(e,i,t.outerHTML,s),s=t.outerHTML,n.stopPropagation()}))}}],l=a.getAttribute("src");l.startsWith("assets/")&&(o.push({type:"separator"}),o.push({label:window.siyuan.languages.rename,click(){(0,E.renameAsset)(l)}}));const r=a.getAttribute("src");return r?o.concat((0,c.openMenu)(r,!0,!1)):o};t.tableMenu=(e,t,n,i)=>{var a;const s=[],o=(0,l.getColIndex)(n);(n.rowSpan>1||n.colSpan>1)&&s.push({label:window.siyuan.languages.cancelMerged,click:()=>{const i=t.outerHTML;let a=n.rowSpan,s=n.parentElement;const l=n.colSpan;for(;a>0&&s;){let e=s.children[o],t=l;for(;t>0&&e;)e.classList.remove("fn__none"),e.colSpan=1,e.rowSpan=1,e=e.nextElementSibling,t--;s=s.nextElementSibling,a--}if(n.rowSpan=1,n.colSpan=1,"TH"===n.tagName){let e;if(Array.from(t.querySelectorAll("thead tr")).find((t=>{if(e=t,Array.from(t.children).forEach((t=>{(1!==t.rowSpan||t.classList.contains("fn__none"))&&(e=void 0)})),e)return!0})),e){const n=t.querySelector("tbody"),i=t.querySelector("thead");for(;!e.isSameNode(i.lastElementChild);)n.insertAdjacentElement("afterbegin",i.lastElementChild)}}(0,d.updateTransaction)(e,t.getAttribute("data-node-id"),t.outerHTML,i)}});const r=t.querySelectorAll("col")[o];r.style.width&&s.push({label:window.siyuan.languages.useDefaultWidth,click:()=>{const n=t.outerHTML;r.style.width="",(0,d.updateTransaction)(e,t.getAttribute("data-node-id"),t.outerHTML,n)}}),(n.rowSpan>1||n.colSpan>1||r.style.width)&&s.push({type:"separator"}),s.push({icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{(0,l.setTableAlign)(e,[n],t,"left",i)}}),s.push({icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{(0,l.setTableAlign)(e,[n],t,"center",i)}}),s.push({icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{(0,l.setTableAlign)(e,[n],t,"right",i)}}),s.push({type:"separator"});const c=t.querySelector("table"),u=n.parentElement.querySelector(".fn__none");let p=!1,m=!1;Array.from(n.parentElement.children).forEach((e=>{e.colSpan>1&&(p=!0),e.rowSpan>1&&(m=!0)}));let g=!1,b=!1,y=!1,f=n.parentElement.previousElementSibling;f||"TBODY"!==n.parentElement.parentElement.tagName||(f=c.querySelector("thead").lastElementChild),f&&(g=f.querySelector(".fn__none"),Array.from(f.children).forEach((e=>{e.colSpan>1&&(b=!0),e.rowSpan>1&&(y=!0)})));let h=!1,w=!1,v=!1,_=n.parentElement.nextElementSibling;_||"THEAD"!==n.parentElement.parentElement.tagName||(_=null===(a=c.querySelector("tbody"))||void 0===a?void 0:a.firstElementChild),_&&(h=_.querySelector(".fn__none"),Array.from(_.children).forEach((e=>{e.colSpan>1&&(w=!0),e.rowSpan>1&&(v=!0)})));let E=!0;Array.from(c.rows).find((e=>{const t=e.cells[o];if(t.classList.contains("fn__none")||t.colSpan>1||t.rowSpan>1)return E=!1,!0}));let k=!0;Array.from(c.rows).find((e=>{const t=e.cells[o+1];if(t&&(t.classList.contains("fn__none")||t.colSpan>1||t.rowSpan>1))return k=!1,!0}));let C=!0;return Array.from(c.rows).find((e=>{const t=e.cells[o-1];if(t&&(t.classList.contains("fn__none")||t.colSpan>1||t.rowSpan>1))return C=!1,!0})),s.push({icon:"iconBefore",label:window.siyuan.languages.insertRowAbove,accelerator:window.siyuan.config.keymap.editor.table.insertRowAbove.custom,click:()=>{(0,l.insertRowAbove)(e,i,n,t)}}),(!h||h&&!v&&w)&&s.push({icon:"iconAfter",label:window.siyuan.languages.insertRowBelow,accelerator:window.siyuan.config.keymap.editor.table.insertRowBelow.custom,click:()=>{(0,l.insertRow)(e,i,n,t)}}),(E||C)&&s.push({icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,accelerator:window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,click:()=>{(0,l.insertColumn)(e,t,n,"beforebegin",i)}}),(E||k)&&s.push({icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,accelerator:window.siyuan.config.keymap.editor.table.insertColumnRight.custom,click:()=>{(0,l.insertColumn)(e,t,n,"afterend",i)}}),((!u||u&&!m&&p)&&(!g||g&&!y&&b)||(!u||u&&!m&&p)&&(!h||h&&!v&&w)||E&&C||E&&k)&&s.push({type:"separator"}),(!u||u&&!m&&p)&&(!g||g&&!y&&b)&&s.push({icon:"iconUp",label:window.siyuan.languages.moveToUp,accelerator:window.siyuan.config.keymap.editor.table.moveToUp.custom,click:()=>{(0,l.moveRowToUp)(e,i,n,t)}}),(!u||u&&!m&&p)&&(!h||h&&!v&&w)&&s.push({icon:"iconDown",label:window.siyuan.languages.moveToDown,accelerator:window.siyuan.config.keymap.editor.table.moveToDown.custom,click:()=>{(0,l.moveRowToDown)(e,i,n,t)}}),E&&C&&s.push({icon:"iconLeft",label:window.siyuan.languages.moveToLeft,accelerator:window.siyuan.config.keymap.editor.table.moveToLeft.custom,click:()=>{(0,l.moveColumnToLeft)(e,i,n,t)}}),E&&k&&s.push({icon:"iconRight",label:window.siyuan.languages.moveToRight,accelerator:window.siyuan.config.keymap.editor.table.moveToRight.custom,click:()=>{(0,l.moveColumnToRight)(e,i,n,t)}}),("THEAD"!==n.parentElement.parentElement.tagName&&(!u&&!m||u&&!m&&p)||E)&&s.push({type:"separator"}),"THEAD"!==n.parentElement.parentElement.tagName&&(!u&&!m||u&&!m&&p)&&s.push({icon:"iconDeleteRow",label:window.siyuan.languages["delete-row"],accelerator:window.siyuan.config.keymap.editor.table["delete-row"].custom,click:()=>{(0,l.deleteRow)(e,i,n,t)}}),E&&s.push({icon:"iconDeleteColumn",label:window.siyuan.languages["delete-column"],accelerator:window.siyuan.config.keymap.editor.table["delete-column"].custom,click:()=>{(0,l.deleteColumn)(e,i,t,n)}}),s};t.setFold=(e,t,n,i)=>{if("NodeListItem"===t.getAttribute("data-type")&&t.childElementCount<4)return-1;let s="0";if("1"===t.getAttribute("fold")){if("boolean"==typeof n&&!n)return-1;t.removeAttribute("fold"),t.querySelectorAll(".protyle-linenumber").forEach((e=>{(0,w.lineNumberRender)(e)}))}else{if("boolean"==typeof n&&n)return-1;if(s="1",t.setAttribute("fold","1"),getSelection().rangeCount>0){const e=getSelection().getRangeAt(0),n=(0,a.hasClosestBlock)(e.startContainer);n&&0===n.getBoundingClientRect().width&&(0,o.focusBlock)(t,void 0,!1)}}const l=t.getAttribute("data-node-id");return"NodeHeading"===t.getAttribute("data-type")?"0"===s?(t.insertAdjacentHTML("beforeend",'<div spin="1" style="text-align: center"><img width="24px" src="/stage/loading-pure.svg"></div>'),(0,d.transaction)(e,[{action:"unfoldHeading",id:l,data:i?"remove":void 0}],[{action:"foldHeading",id:l}])):((0,d.transaction)(e,[{action:"foldHeading",id:l}],[{action:"unfoldHeading",id:l}]),(0,h.removeFoldHeading)(t)):(0,d.transaction)(e,[{action:"setAttrs",id:l,data:JSON.stringify({fold:s})}],[{action:"setAttrs",id:l,data:JSON.stringify({fold:"0"===s?"1":"0"})}]),(0,g.preventScroll)(e),s}},999:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.openMobileFileById=void 0;const i=n(4078),a=n(6700),s=n(2708),o=n(8438),l=n(7683),r=n(1040),d=n(7994),c=n(2386),u=n(5449),p=n(4933),m=n(7821),g=n(8461),b=n(5615),y=n(706);t.openMobileFileById=(e,t=[o.Constants.CB_GET_HL])=>{if(window.localStorage.setItem(o.Constants.LOCAL_DOCINFO,JSON.stringify({id:e,action:t})),window.siyuan.mobileEditor){let t;if((0,b.hideElements)(["toolbar","hint","util"],window.siyuan.mobileEditor.protyle),window.siyuan.mobileEditor.protyle.contentElement.classList.contains("fn__none")&&(0,g.setEditMode)(window.siyuan.mobileEditor.protyle,"wysiwyg"),Array.from(window.siyuan.mobileEditor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e}"]`)).find((e=>{if(!(0,m.hasClosestByAttribute)(e.parentElement,"data-type","NodeBlockQueryEmbed"))return t=e,!0})),t)return(0,y.pushBack)(),(0,c.focusBlock)(t),(0,u.scrollCenter)(window.siyuan.mobileEditor.protyle,t,!0),void(0,s.closePanel)()}(0,l.fetchPost)("/api/block/getBlockInfo",{id:e},(n=>{2!==n.code?(window.siyuan.mobileEditor?((0,y.pushBack)(),(0,d.addLoading)(window.siyuan.mobileEditor.protyle),(0,l.fetchPost)("/api/filetree/getDoc",{id:e,size:t.includes(o.Constants.CB_GET_ALL)?o.Constants.SIZE_GET_MAX:o.Constants.SIZE_GET,mode:t.includes(o.Constants.CB_GET_CONTEXT)?3:0},(e=>{var n;(0,r.onGet)(e,window.siyuan.mobileEditor.protyle,t),null===(n=window.siyuan.mobileEditor.protyle.breadcrumb)||void 0===n||n.render(window.siyuan.mobileEditor.protyle)})),window.siyuan.mobileEditor.protyle.undo.clear()):window.siyuan.mobileEditor=new i.default(document.getElementById("editor"),{blockId:e,action:t,render:{background:!0,gutter:!0},typewriterMode:!0,preview:{actions:["mp-wechat","zhihu"]},after:e=>{window.siyuan.config.readonly||"#iconEdit"===document.querySelector("#toolbarEdit use").getAttribute("xlink:href")?(0,r.disabledProtyle)(e.protyle):(0,r.enableProtyle)(e.protyle)}}),document.getElementById("toolbarName").value="Untitled"===n.data.rootTitle?"":n.data.rootTitle,(0,a.setEditor)(),(0,s.closePanel)()):(0,p.lockFile)(n.data)}))}},9683:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.initAppearance=void 0;const i=n(2708),a=n(7683),s=n(2738),o=n(5563),l=n(5715);t.initAppearance=(e,t)=>{(0,i.closePanel)(),e.style.top="0",e.querySelector(".toolbar__icon").innerHTML='<use xlink:href="#iconTheme"></use>',e.querySelector(".toolbar__text").textContent=window.siyuan.languages.appearance,t.innerHTML=`<div class="b3-label">\n    ${window.siyuan.languages.appearance4}\n    <div class="fn__hr"></div>\n    <select class="b3-select fn__block" id="mode">\n      <option value="0" ${0===window.siyuan.config.appearance.mode?"selected":""}>${window.siyuan.languages.themeLight}</option>\n      <option value="1" ${1===window.siyuan.config.appearance.mode?"selected":""}>${window.siyuan.languages.themeDark}</option>\n    </select>\n    <div class="b3-label__text">${window.siyuan.languages.appearance5}</div>\n</div>\n<div class="b3-label">\n    ${window.siyuan.languages.theme}\n    <div class="fn__hr"></div>\n    <select class="b3-select fn__block" id="themeLight">\n      ${(0,o.genOptions)(window.siyuan.config.appearance.lightThemes,window.siyuan.config.appearance.themeLight)}\n    </select>\n    <div class="b3-label__text">${window.siyuan.languages.theme11}</div>\n    <div class="fn__hr"></div>\n    <select class="b3-select fn__block" id="themeDark">\n       ${(0,o.genOptions)(window.siyuan.config.appearance.darkThemes,window.siyuan.config.appearance.themeDark)}\n    </select>\n    <div class="b3-label__text">${window.siyuan.languages.theme12}</div>\n</div>\n<div class="b3-label">\n    ${window.siyuan.languages.icon}\n    <div class="fn__hr"></div>\n    <select class="b3-select fn__block" id="icon">\n        ${(0,o.genOptions)(window.siyuan.config.appearance.icons,window.siyuan.config.appearance.icon)}\n    </select>\n    <div class="b3-label__text">${window.siyuan.languages.theme2}</div>\n</div>\n<div class="b3-label">\n    ${window.siyuan.languages.language}\n    <div class="fn__hr"></div>\n    <select id="lang" class="b3-select fn__block">${(0,o.genOptions)(window.siyuan.config.langs,window.siyuan.config.appearance.lang)}</select>\n    <div class="b3-label__text">${window.siyuan.languages.language1}</div>\n</div>\n<div class="b3-label">\n    ${window.siyuan.languages.fontSize} <span id="fontSize" class="ft__on-surface">${window.siyuan.config.editor.fontSize}px</span>\n    <div class="fn__hr"></div>\n    <input class="b3-slider fn__block" max="72" min="9" step="1" type="range" value="${window.siyuan.config.editor.fontSize}">\n    <div class="b3-label__text">${window.siyuan.languages.fontSizeTip}</div>\n</div>`,t.querySelector(".b3-slider").addEventListener("input",(e=>{t.querySelector("#fontSize").textContent=e.target.value+"px",(0,a.fetchPost)("/api/setting/setEditor",{displayBookmarkIcon:window.siyuan.config.editor.displayBookmarkIcon,displayNetImgMark:window.siyuan.config.editor.displayNetImgMark,codeLineWrap:window.siyuan.config.editor.codeLineWrap,codeSyntaxHighlightLineNum:window.siyuan.config.editor.codeSyntaxHighlightLineNum,virtualBlockRef:window.siyuan.config.editor.virtualBlockRef,virtualBlockRefExclude:window.siyuan.config.editor.virtualBlockRefExclude,blockRefDynamicAnchorTextMaxLen:window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen,fontSize:parseInt(t.querySelector(".b3-slider").value),codeLigatures:window.siyuan.config.editor.codeLigatures,codeTabSpaces:window.siyuan.config.editor.codeTabSpaces,generateHistoryInterval:window.siyuan.config.editor.generateHistoryInterval,historyRetentionDays:window.siyuan.config.editor.historyRetentionDays,fontFamily:window.siyuan.config.editor.fontFamily,emoji:window.siyuan.config.editor.emoji},(e=>{window.siyuan.config.editor=e.data,(0,l.reloadProtyle)(window.siyuan.mobileEditor.protyle),(0,s.setInlineStyle)()}))})),t.querySelectorAll("select").forEach((e=>{e.addEventListener("change",(()=>{(0,a.fetchPost)("/api/setting/setAppearance",{icon:t.querySelector("#icon").value,mode:parseInt(t.querySelector("#mode").value),codeBlockThemeDark:window.siyuan.config.appearance.codeBlockThemeDark,codeBlockThemeLight:window.siyuan.config.appearance.codeBlockThemeLight,themeDark:t.querySelector("#themeDark").value,themeLight:t.querySelector("#themeLight").value,darkThemes:window.siyuan.config.appearance.darkThemes,lightThemes:window.siyuan.config.appearance.lightThemes,icons:window.siyuan.config.appearance.icons,lang:t.querySelector("#lang").value,customCSS:window.siyuan.config.appearance.customCSS,closeButtonBehavior:window.siyuan.config.appearance.closeButtonBehavior,nativeEmoji:window.siyuan.config.appearance.nativeEmoji},(()=>{window.location.reload()}))}))}))}},706:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.goBack=t.goForward=t.pushBack=void 0;const i=n(8438),a=n(5615),s=n(8461),o=n(7683),l=n(6112),r=n(6259),d=n(1456),c=n(4383),u=n(1040),p=[],m=e=>{const t=window.siyuan.mobileEditor.protyle;window.localStorage.setItem(i.Constants.LOCAL_DOCINFO,JSON.stringify({id:e.id,action:e.callback})),(0,a.hideElements)(["toolbar","hint","util"],window.siyuan.mobileEditor.protyle),t.contentElement.classList.contains("fn__none")&&(0,s.setEditMode)(t,"wysiwyg");const n=e.endId.split(i.Constants.ZWSP);n[0]!==t.wysiwyg.element.firstElementChild.getAttribute("data-node-id")||n[1]!==t.wysiwyg.element.lastElementChild.getAttribute("data-node-id")?(e.id!==t.block.rootID&&(0,o.fetchPost)("/api/block/getDocInfo",{id:e.id},(e=>{document.getElementById("toolbarName").value="Untitled"===e.data.name?"":e.data.name,t.background.render(e.data.ial,t.block.rootID),t.wysiwyg.renderCustom(e.data.ial)})),e.isZoom?(0,o.fetchPost)("/api/block/checkBlockExist",{id:e.id},(n=>{n.data&&(0,l.zoomOut)(t,e.id,void 0,!1,(()=>{t.contentElement.scrollTop=e.scrollTop}))})):(0,o.fetchPost)("/api/filetree/getDoc",{id:e.id,startID:n[0],endID:n[1]},(n=>{var i;t.block.parentID=n.data.parentID,t.block.parent2ID=n.data.parent2ID,t.block.rootID=n.data.rootID,t.block.showAll=!1,t.block.mode=n.data.mode,t.block.blockCount=n.data.blockCount,t.block.id=n.data.id,t.block.action=e.callback,t.wysiwyg.element.setAttribute("data-doc-type",n.data.type),t.wysiwyg.element.innerHTML=n.data.content,(0,r.processRender)(t.wysiwyg.element),(0,d.highlightRender)(t.wysiwyg.element),(0,c.blockRender)(t,t.wysiwyg.element),t.disabled?(0,u.disabledProtyle)(t):(0,u.enableProtyle)(t),t.contentElement.scrollTop=e.scrollTop,null===(i=window.siyuan.mobileEditor.protyle.breadcrumb)||void 0===i||i.render(t)}))):window.siyuan.mobileEditor.protyle.contentElement.scrollTo({top:e.scrollTop,behavior:"smooth"})};t.pushBack=()=>{const e=window.siyuan.mobileEditor.protyle;window.siyuan.backStack.push({id:e.block.showAll?e.block.id:e.block.rootID,endId:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id")+i.Constants.ZWSP+e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),scrollTop:e.contentElement.scrollTop,callback:e.block.action,isZoom:e.block.showAll})};t.goForward=()=>{window.JSAndroid&&p.length<2?window.JSAndroid.returnDesktop():p.length<2||(window.siyuan.backStack.push(p.pop()),m(p[p.length-1]))};t.goBack=()=>{if(window.JSAndroid&&window.siyuan.backStack.length<1)return void window.JSAndroid.returnDesktop();if(window.siyuan.backStack.length<1)return;const e=window.siyuan.mobileEditor.protyle;0===p.length&&p.push({id:e.block.showAll?e.block.id:e.block.rootID,endId:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id")+i.Constants.ZWSP+e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),scrollTop:e.contentElement.scrollTop,callback:e.block.action,isZoom:e.block.showAll});const t=window.siyuan.backStack.pop();p.push(t),m(t)}},2649:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MobileBacklinks=void 0;const i=n(3456),a=n(7683),s=n(8438),o=n(7821),l=n(1040),r=n(999),d=n(6937);t.MobileBacklinks=class{constructor(){this.beforeLen=10,this.element=document.querySelector('#sidebar [data-type="sidebar-backlink"]'),this.element.innerHTML=`<div class="toolbar">\n    <div class="fn__space"></div>\n    <div class="toolbar__text">\n        ${window.siyuan.languages.backlinks}\n    </div>\n    <span class="counter listCount"></span>\n    <span class="fn__space"></span>\n    <svg data-type="expand" class="toolbar__icon"><use xlink:href="#iconFullscreen"></use></svg>\n    <span class="fn__space"></span>\n    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>\n</div>\n<div class="backlinkList fn__flex-1"></div>\n<div class="toolbar">\n    <div class="fn__space"></div>\n    <div class="toolbar__text">\n        ${window.siyuan.languages.mentions}\n    </div>\n    <span class="counter listMCount"></span>\n    <span class="fn__space"></span>\n    <svg data-type="mExpand" class="toolbar__icon"><use xlink:href="#iconFullscreen"></use></svg>\n    <span class="fn__space"></span>\n    <svg data-type="mCollapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>\n    <span class="fn__space"></span>\n    <svg data-type="layout" class="toolbar__icon"><use xlink:href="#iconDown"></use></svg>\n</div>\n<div class="backlinkMList fn__flex-1"></div>`,this.tree=new i.Tree({element:this.element.querySelector(".backlinkList"),data:null,click(e){(0,r.openMobileFileById)(e.getAttribute("data-node-id"),[s.Constants.CB_GET_FOCUS,s.Constants.CB_GET_CONTEXT])}}),this.mTree=new i.Tree({element:this.element.querySelector(".backlinkMList"),data:null,click:(e,t)=>{const n=(0,o.hasClosestByClassName)(t.target,"b3-list-item__action");if(n){if(n.firstElementChild.classList.contains("fn__rotate"))return;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new d.MenuItem({label:window.siyuan.languages.turnInto+" "+window.siyuan.languages.turnToStaticRef,click:()=>{this.turnToRef(e,!1)}}).element),window.siyuan.menus.menu.append(new d.MenuItem({label:window.siyuan.languages.turnInto+" "+window.siyuan.languages.turnToDynamicRef,click:()=>{this.turnToRef(e,!0)}}).element),window.siyuan.menus.menu.popup({x:t.clientX,y:t.clientY})}else(0,r.openMobileFileById)(e.getAttribute("data-node-id"),[s.Constants.CB_GET_FOCUS,s.Constants.CB_GET_CONTEXT])},blockExtHTML:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>'}),this.element.addEventListener("click",(e=>{let t=e.target;for(;t&&!t.isEqualNode(this.element);){if(t.classList.contains("toolbar__icon")){switch(t.getAttribute("data-type")){case"collapse":this.tree.collapseAll();break;case"expand":this.tree.expandAll();break;case"mExpand":this.mTree.expandAll();break;case"mCollapse":this.mTree.collapseAll();break;case"layout":this.mTree.element.style.flex?"0px"===this.mTree.element.style.height?(this.mTree.element.removeAttribute("style"),t.setAttribute("aria-label",window.siyuan.languages.up),t.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.mTree.element.removeAttribute("style"),t.setAttribute("aria-label",window.siyuan.languages.down),t.querySelector("use").setAttribute("xlink:href","#iconDown")):t.getAttribute("aria-label")===window.siyuan.languages.down?(this.mTree.element.setAttribute("style","flex:none;height:0px"),t.setAttribute("aria-label",window.siyuan.languages.up),t.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.mTree.element.setAttribute("style",`flex:none;height:${this.element.clientHeight-2*this.tree.element.previousElementSibling.clientHeight}px`),t.setAttribute("aria-label",window.siyuan.languages.down),t.querySelector("use").setAttribute("xlink:href","#iconDown")),t.setAttribute("data-clicked","true")}}t=t.parentElement}})),this.update()}turnToRef(e,t){e.querySelector(".b3-list-item__action").innerHTML='<svg class="fn__rotate"><use xlink:href="#iconRefresh"></use></svg>',(0,a.fetchPost)("/api/ref/createBacklink",{refID:e.getAttribute("data-node-id"),refText:decodeURIComponent(e.getAttribute("data-ref-text")),defID:window.siyuan.mobileEditor.protyle.block.id,pushMode:0,isDynamic:t},(e=>{e.data.defID===window.siyuan.mobileEditor.protyle.block.id&&this.update(),e.data.refRootID===window.siyuan.mobileEditor.protyle.block.rootID&&(0,a.fetchPost)("/api/filetree/getDoc",{id:window.siyuan.mobileEditor.protyle.block.id,size:s.Constants.SIZE_GET},(e=>{(0,l.onGet)(e,window.siyuan.mobileEditor.protyle)}))}))}update(){(0,a.fetchPost)("/api/ref/getBacklink",{id:window.siyuan.mobileEditor.protyle.block.id,beforeLen:this.beforeLen,k:"",mk:""},(e=>{this.notebookId=e.data.box,this.tree.updateData(e.data.backlinks),this.mTree.updateData(e.data.backmentions);const t=this.element.querySelector(".listCount");0===e.data.linkRefsCount?t.classList.add("fn__none"):(t.classList.remove("fn__none"),t.textContent=e.data.linkRefsCount.toString());const n=this.element.querySelector(".listMCount");0===e.data.mentionsCount?n.classList.add("fn__none"):(n.classList.remove("fn__none"),n.textContent=e.data.mentionsCount.toString());const i=this.element.querySelector("[data-type='layout']");if(!i.getAttribute("data-clicked"))return 0===e.data.mentionsCount?(this.mTree.element.setAttribute("style","flex:none;height:0px"),i.setAttribute("aria-label",window.siyuan.languages.up),void i.querySelector("use").setAttribute("xlink:href","#iconUp")):void(0===e.data.linkRefsCount?(this.mTree.element.setAttribute("style",`flex:none;height:${this.element.clientHeight-2*this.tree.element.previousElementSibling.clientHeight}px`),i.setAttribute("aria-label",window.siyuan.languages.down),i.querySelector("use").setAttribute("xlink:href","#iconDown")):(this.mTree.element.removeAttribute("style"),i.setAttribute("aria-label",window.siyuan.languages.down),i.querySelector("use").setAttribute("xlink:href","#iconDown")))}))}}},2504:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MobileBookmarks=void 0;const i=n(3456),a=n(7683),s=n(8438),o=n(7821),l=n(999),r=n(2041),d=n(9755),c=n(3163);t.MobileBookmarks=class{constructor(){this.element=document.querySelector('#sidebar [data-type="sidebar-bookmark"]'),this.element.innerHTML=`<div class="toolbar">\n    <div class="fn__space"></div>\n    <div class="toolbar__text">\n        ${window.siyuan.languages.bookmark}\n    </div>\n    <span class="fn__space"></span>\n    <svg data-type="expand" class="toolbar__icon"><use xlink:href="#iconFullscreen"></use></svg>\n    <span class="fn__space"></span>\n    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>\n</div>\n<div class="fn__flex-1 bookmarkList"></div>\n<img style="position: absolute;top: 0;left: 0;height: 100%;width: 100%;padding: 30vw;box-sizing: border-box;" src="/stage/loading-pure.svg">`,this.tree=new i.Tree({element:this.element.querySelector(".bookmarkList"),data:null,click:(e,t)=>{const n=e.getAttribute("data-node-id"),i=(0,o.hasClosestByClassName)(t.target,"b3-list-item__action");if(i){const t=(n?e.parentElement.previousElementSibling:e).querySelector(".b3-list-item__text").textContent;if("remove"===i.getAttribute("data-type"))(0,r.confirmDialog)(window.siyuan.languages.delete,`${window.siyuan.languages.confirmDelete} <b>${(0,d.escapeHtml)(t)}</b>?`,(()=>{n?((0,a.fetchPost)("/api/attr/setBlockAttrs",{id:n,attrs:{bookmark:""}},(()=>{this.update()})),document.querySelectorAll(`.protyle-wysiwyg [data-node-id="${n}"]`).forEach((e=>{e.setAttribute("bookmark","");const t=e.querySelector(".protyle-attr--bookmark");t&&t.remove()}))):(0,a.fetchPost)("/api/bookmark/removeBookmark",{bookmark:t})}));else{const e=new c.Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block"></div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>\n</div>`,width:"80vw"}),n=e.element.querySelectorAll(".b3-button");n[0].addEventListener("click",(()=>{e.destroy()}));const i=e.element.querySelector("input");e.bindInput(i,(()=>{n[1].click()})),i.value=t,i.focus(),i.select(),n[1].addEventListener("click",(()=>{(0,a.fetchPost)("/api/bookmark/renameBookmark",{oldBookmark:t,newBookmark:i.value},(()=>{e.destroy()}))}))}}else(0,l.openMobileFileById)(n,[s.Constants.CB_GET_FOCUS,s.Constants.CB_GET_CONTEXT])},blockExtHTML:'<span class="b3-list-item__action" data-type="remove"><svg><use xlink:href="#iconTrashcan"></use></svg></span>',topExtHTML:'<span class="b3-list-item__action" data-type="edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="b3-list-item__action" data-type="remove"><svg><use xlink:href="#iconTrashcan"></use></svg></span>'}),this.element.addEventListener("click",(e=>{let t=e.target;for(;t&&!t.isEqualNode(this.element);){if(t.classList.contains("toolbar__icon")){switch(t.getAttribute("data-type")){case"collapse":this.tree.collapseAll();break;case"expand":this.tree.expandAll()}}t=t.parentElement}})),this.update()}update(){this.element.lastElementChild.classList.remove("fn__none"),(0,a.fetchPost)("/api/bookmark/getBookmark",{},(e=>{this.openNodes&&(this.openNodes=this.tree.getExpandIds()),this.tree.updateData(e.data),this.openNodes?this.tree.setExpandIds(this.openNodes):this.openNodes=this.tree.getExpandIds(),this.element.lastElementChild.classList.add("fn__none")}))}}},6772:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MobileFiles=void 0;const i=n(7821),a=n(9755),s=n(7849),o=n(8438),l=n(9883),r=n(1699),d=n(7491),c=n(7683),u=n(4577),p=n(999),m=n(6810),g=n(8571),b=n(6700),y=n(2041),f=n(6937),h=n(9972);class w extends s.Model{constructor(){super({id:(0,u.genUUID)(),type:"filetree",msgCallback(e){if(e)switch(e.cmd){case"moveDoc":this.onMove(e.data);break;case"mount":this.onMount(e);break;case"createnotebook":(0,l.setNoteBook)(),this.element.insertAdjacentHTML("beforeend",this.genNotebook(e.data.box));break;case"unmount":case"remove":this.onRemove(e);break;case"createdailynote":case"create":case"heading2doc":case"li2doc":this.onMkdir(e.data);break;case"renamenotebook":this.element.querySelector(`[data-url="${e.data.box}"] .b3-list-item__text`).innerHTML=e.data.name;break;case"rename":this.onRename(e.data)}}}),this.genFileHTML=e=>{let t="";return e.count&&e.count>0&&(t=`<span class="counter">${e.count}</span>`),`<li data-node-id="${e.id}" data-name="${Lute.EscapeHTMLStr(e.name)}" draggable="true" \ndata-type="navigation-file" \nclass="b3-list-item" data-path="${e.path}">\n    <span style="padding-left: ${16*(e.path.split("/").length-1)}px" class="b3-list-item__toggle${0===e.subFileCount?" fn__hidden":""}">\n        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>\n    </span>\n    <span class="b3-list-item__icon">${(0,m.unicode2Emoji)(e.icon||(0===e.subFileCount?o.Constants.SIYUAN_IMAGE_FILE:o.Constants.SIYUAN_IMAGE_FOLDER))}</span>\n    <span class="b3-list-item__text">${(0,l.getDisplayName)(e.name,!0,!0)}</span>\n    <span data-type="more-file" class="b3-list-item__action b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.more}">\n        <svg><use xlink:href="#iconMore"></use></svg>\n    </span>\n    <span data-type="new" class="b3-list-item__action b3-tooltips b3-tooltips__nw${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.newFile}">\n        <svg><use xlink:href="#iconAdd"></use></svg>\n    </span>\n    ${t}\n</li>`};const e=document.querySelector('#sidebar [data-type="sidebar-file"]');e.innerHTML=`<div class="toolbar">\n    <div class="fn__space"></div>\n    <div class="toolbar__text">${window.siyuan.languages.fileTree}</div>\n    <div class="fn__flex-1 fn__space"></div>\n    <svg data-type="newNotebook" class="toolbar__icon"><use xlink:href="#iconFilesRoot"></use></svg>\n    <svg data-type="refresh" class="toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>\n    <svg data-type="focus" class="toolbar__icon"><use xlink:href="#iconFocus"></use></svg>\n    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>\n    <svg data-type="sort" class="toolbar__icon${window.siyuan.config.readonly?" fn__none":""}"><use xlink:href="#iconSort"></use></svg>\n</div>\n<div class="fn__flex-1" data-type="navigation"></div>\n<ul class="b3-list b3-list--background fn__flex-column" style="min-height: auto;transition: var(--b3-transition)">\n    <li class="b3-list-item" data-type="toggle">\n        <span class="b3-list-item__toggle">\n            <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>\n        </span>\n        <span class="b3-list-item__text">${window.siyuan.languages.closeNotebook}</span>\n    </li>\n    <ul class="fn__none fn__flex-1"></ul>\n</ul>`,this.actionsElement=e.firstElementChild,this.element=this.actionsElement.nextElementSibling,this.closeElement=this.element.nextElementSibling,e.addEventListener("click",(e=>{let t=e.target;for(;t&&!t.isEqualNode(this.actionsElement);){const n=t.getAttribute("data-type");if("refresh"===n){if(!t.getAttribute("disabled")){t.setAttribute("disabled","disabled");const e=[];Array.from(this.element.children).forEach((t=>{e.push(t.getAttribute("data-url"))})),(0,c.fetchPost)("/api/filetree/refreshFiletree",{},(()=>{t.removeAttribute("disabled"),this.init(!1)}))}e.preventDefault();break}if("focus"===n){window.siyuan.mobileEditor&&this.selectItem(window.siyuan.mobileEditor.protyle.notebookId,window.siyuan.mobileEditor.protyle.path),e.preventDefault();break}if("newNotebook"===n)(0,g.newNotebook)();else{if("collapse"===n){Array.from(this.element.children).forEach((e=>{const t=e.firstElementChild,n=t.querySelector(".b3-list-item__arrow");n.classList.contains("b3-list-item__arrow--open")&&(n.classList.remove("b3-list-item__arrow--open"),t.nextElementSibling.remove())})),e.preventDefault();break}if("sort"===n){this.genSort(e),e.preventDefault(),e.stopPropagation();break}if(t.classList.contains("b3-list-item__toggle")&&!t.classList.contains("fn__hidden")&&"toggle"!==t.parentElement.getAttribute("data-type")){const n=(0,i.hasTopClosestByTag)(t,"UL");if(n){const e=n.getAttribute("data-url");this.getLeaf(t.parentElement,e),this.setCurrent(t.parentElement),window.siyuan.menus.menu.remove()}e.preventDefault(),e.stopPropagation();break}if("toggle"===n){this.closeElement.classList.contains("fn__flex-1")?(this.closeElement.lastElementChild.classList.add("fn__none"),this.closeElement.classList.remove("fn__flex-1"),t.querySelector("svg").classList.remove("b3-list-item__arrow--open")):(this.closeElement.lastElementChild.classList.remove("fn__none"),this.closeElement.classList.add("fn__flex-1"),t.querySelector("svg").classList.add("b3-list-item__arrow--open")),e.stopPropagation(),e.preventDefault();break}if("remove"===n){(0,y.confirmDialog)(window.siyuan.languages.delete,`${window.siyuan.languages.confirmDelete} <b>${(0,a.escapeHtml)(t.parentElement.querySelector(".b3-list-item__text").textContent)}</b>?`,(()=>{(0,c.fetchPost)("/api/notebook/removeNotebook",{notebook:t.getAttribute("data-url"),callback:o.Constants.CB_MOUNT_REMOVE})})),e.stopPropagation(),e.preventDefault();break}if("open"===n){(0,c.fetchPost)("/api/notebook/openNotebook",{notebook:t.getAttribute("data-url")}),e.stopPropagation(),e.preventDefault();break}if(t.classList.contains("b3-list-item__action")){const n=t.getAttribute("data-type"),a=t.parentElement.getAttribute("data-path"),s=e instanceof TouchEvent?e.touches[0].clientX:e.clientX,o=e instanceof TouchEvent?e.touches[0].clientY:e.clientY,l=(0,i.hasTopClosestByTag)(t,"UL");if(l){const e=l.getAttribute("data-url");window.siyuan.config.readonly||("new"===n?(0,h.newFile)(e,a,!0):"more-root"===n&&((0,r.initNavigationMenu)(t.parentElement).popup({x:s,y:o}),window.siyuan.menus.menu.element.style.zIndex="310")),"more-file"===n&&((0,r.initFileMenu)(e,a,t.parentElement).popup({x:s,y:o}),window.siyuan.menus.menu.element.style.zIndex="310")}e.preventDefault(),e.stopPropagation();break}if("LI"===t.tagName){if(this.setCurrent(t),"navigation-file"===t.getAttribute("data-type"))(0,p.openMobileFileById)(t.getAttribute("data-node-id"));else if("navigation-root"===t.getAttribute("data-type")){const e=(0,i.hasTopClosestByTag)(t,"UL");if(e){const n=e.getAttribute("data-url");this.getLeaf(t,n)}}e.preventDefault();break}}t=t.parentElement}})),this.init()}genSort(e){window.siyuan.menus.menu.remove();const t=e=>{window.siyuan.config.fileTree.sort=e,(0,c.fetchPost)("/api/setting/setFiletree",{sort:window.siyuan.config.fileTree.sort,alwaysSelectOpenedFile:window.siyuan.config.fileTree.alwaysSelectOpenedFile,refCreateSavePath:window.siyuan.config.fileTree.refCreateSavePath,createDocNameTemplate:window.siyuan.config.fileTree.createDocNameTemplate,openFilesUseCurrentTab:window.siyuan.config.fileTree.openFilesUseCurrentTab,maxListCount:window.siyuan.config.fileTree.maxListCount},(()=>{(0,l.setNoteBook)((()=>{this.init(!1)}))}))};window.siyuan.menus.menu.append(new f.MenuItem({icon:0===window.siyuan.config.fileTree.sort?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{t(0)}}).element),window.siyuan.menus.menu.append(new f.MenuItem({icon:1===window.siyuan.config.fileTree.sort?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{t(1)}}).element),window.siyuan.menus.menu.append(new f.MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new f.MenuItem({icon:4===window.siyuan.config.fileTree.sort?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{t(4)}}).element),window.siyuan.menus.menu.append(new f.MenuItem({icon:5===window.siyuan.config.fileTree.sort?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{t(5)}}).element),window.siyuan.menus.menu.append(new f.MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new f.MenuItem({icon:9===window.siyuan.config.fileTree.sort?"iconSelect":void 0,label:window.siyuan.languages.createdASC,click:()=>{t(9)}}).element),window.siyuan.menus.menu.append(new f.MenuItem({icon:10===window.siyuan.config.fileTree.sort?"iconSelect":void 0,label:window.siyuan.languages.createdDESC,click:()=>{t(10)}}).element),window.siyuan.menus.menu.append(new f.MenuItem({icon:2===window.siyuan.config.fileTree.sort?"iconSelect":void 0,label:window.siyuan.languages.modifiedASC,click:()=>{t(2)}}).element),window.siyuan.menus.menu.append(new f.MenuItem({icon:3===window.siyuan.config.fileTree.sort?"iconSelect":void 0,label:window.siyuan.languages.modifiedDESC,click:()=>{t(3)}}).element),window.siyuan.menus.menu.append(new f.MenuItem({icon:7===window.siyuan.config.fileTree.sort?"iconSelect":void 0,label:window.siyuan.languages.refCountASC,click:()=>{t(7)}}).element),window.siyuan.menus.menu.append(new f.MenuItem({icon:8===window.siyuan.config.fileTree.sort?"iconSelect":void 0,label:window.siyuan.languages.refCountDESC,click:()=>{t(8)}}).element),window.siyuan.menus.menu.append(new f.MenuItem({icon:6===window.siyuan.config.fileTree.sort?"iconSelect":void 0,label:window.siyuan.languages.customSort,click:()=>{t(6)}}).element),window.siyuan.menus.menu.element.style.zIndex="310",window.siyuan.menus.menu.popup({x:e.clientX,y:e.clientY})}genNotebook(e){const t=`<span class="b3-list-item__icon b3-tooltips b3-tooltips__e" aria-label="${window.siyuan.languages.changeIcon}">${(0,m.unicode2Emoji)(e.icon||o.Constants.SIYUAN_IMAGE_NOTE)}</span>`;return e.closed?`<li data-type="open" data-url="${e.id}" class="b3-list-item">\n    <span class="b3-list-item__toggle fn__hidden">\n        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>\n    </span>\n    ${t}\n    <span class="b3-list-item__text">${(0,a.escapeHtml)(e.name)}</span>\n    <span data-type="remove" data-url="${e.id}" class="b3-list-item__action${window.siyuan.config.readonly?" fn__none":""}">\n        <svg><use xlink:href="#iconTrashcan"></use></svg>\n    </span>\n</li>`:`<ul class="b3-list b3-list--background" data-url="${e.id}">\n<li class="b3-list-item" data-type="navigation-root" data-path="/">\n    <span class="b3-list-item__toggle${e.closed?" fn__hidden":""}">\n        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>\n    </span>\n    ${t}\n    <span class="b3-list-item__text${e.closed?" ft__on-surface":""}">${(0,a.escapeHtml)(e.name)}</span>\n    <span data-type="more-root" class="b3-list-item__action${window.siyuan.config.readonly||e.closed?" fn__none":""}">\n        <svg><use xlink:href="#iconMore"></use></svg>\n    </span>\n    <span data-type="new" class="b3-list-item__action${window.siyuan.config.readonly||e.closed?" fn__none":""}">\n        <svg><use xlink:href="#iconAdd"></use></svg>\n    </span>\n</li></ul>`}init(e=!0){let t="",n="";window.siyuan.notebooks.forEach((e=>{e.closed?n+=this.genNotebook(e):t+=this.genNotebook(e)})),this.element.innerHTML=t,this.closeElement.lastElementChild.innerHTML=n,e&&(""===t?(this.closeElement.lastElementChild.classList.remove("fn__none"),this.closeElement.classList.add("fn__flex-1")):(this.closeElement.lastElementChild.classList.add("fn__none"),this.closeElement.classList.remove("fn__flex-1")))}onMove(e){const t=this.element.querySelector(`ul[data-url="${e.fromNotebook}"] li[data-path="${e.fromPath}"]`);if(t)if(t.nextElementSibling&&"UL"===t.nextElementSibling.tagName&&t.nextElementSibling.remove(),1===t.parentElement.childElementCount){if(t.parentElement.previousElementSibling){t.parentElement.previousElementSibling.querySelector(".b3-list-item__toggle").classList.add("fn__hidden"),t.parentElement.previousElementSibling.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open");const e=t.parentElement.previousElementSibling.querySelector(".b3-list-item__icon");e.innerHTML===(0,m.unicode2Emoji)(o.Constants.SIYUAN_IMAGE_FOLDER)&&(e.innerHTML=(0,m.unicode2Emoji)(o.Constants.SIYUAN_IMAGE_FILE))}t.parentElement.remove()}else t.remove();const n=this.element.querySelector(`[data-url="${e.toNotebook}"] li[data-path="${e.toPath}"]`);if(n){const t=n.querySelector(".b3-list-item__icon");t.innerHTML===(0,m.unicode2Emoji)(o.Constants.SIYUAN_IMAGE_FILE)&&(t.innerHTML=(0,m.unicode2Emoji)(o.Constants.SIYUAN_IMAGE_FOLDER)),n.querySelector(".b3-list-item__toggle").classList.remove("fn__hidden"),n.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),n.nextElementSibling&&"UL"===n.nextElementSibling.tagName&&n.nextElementSibling.remove(),this.getLeaf(n,e.toNotebook)}}onMkdir(e){let t=this.element.querySelector(`ul[data-url="${e.box.id}"]`),n=(0,l.pathPosix)().dirname(e.path)+".sy";for(;"/"!==n&&(t=t.querySelector(`li[data-path="${n}"]`),!t);)t=this.element.querySelector(`ul[data-url="${e.box.id}"]`),n=(0,l.pathPosix)().dirname(n);if("UL"===t.tagName&&(t="/"===(0,l.pathPosix)().dirname(e.path)?t.firstElementChild:void 0),t){t.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),t.querySelector(".b3-list-item__toggle").classList.remove("fn__hidden");const n=t.querySelector(".b3-list-item__icon");n.innerHTML===(0,m.unicode2Emoji)(o.Constants.SIYUAN_IMAGE_FILE)&&(n.innerHTML=(0,m.unicode2Emoji)(o.Constants.SIYUAN_IMAGE_FOLDER)),t.nextElementSibling&&"UL"===t.nextElementSibling.tagName&&t.nextElementSibling.remove(),this.getLeaf(t,e.box.id)}}onRemove(e){var t;const n=this.element.querySelector(`ul[data-url="${e.data.box}"] li[data-path="${e.data.path||"/"}"]`);if("unmount"===e.cmd){if((0,l.setNoteBook)((t=>{if(n&&(n.parentElement.remove(),o.Constants.CB_MOUNT_REMOVE!==e.callback)){let e="";t.find((t=>{t.closed&&(e+=this.genNotebook(t))})),this.closeElement.lastElementChild.innerHTML=e}})),window.siyuan.mobileEditor&&(0,c.fetchPost)("/api/block/checkBlockExist",{id:window.siyuan.mobileEditor.protyle.block.rootID},(e=>{e.data||(0,b.setEmpty)()})),o.Constants.CB_MOUNT_REMOVE===e.callback){const t=this.closeElement.querySelector(`li[data-url="${e.data.box}"]`);t&&t.remove()}}else if(n){"UL"===(null===(t=n.nextElementSibling)||void 0===t?void 0:t.tagName)&&n.nextElementSibling.remove();const i=n.parentElement.previousElementSibling;if(1===n.parentElement.childElementCount){if(i){const e=i.querySelector("svg");e.classList.remove("b3-list-item__arrow--open"),e.parentElement.classList.add("fn__hidden");const t=e.parentElement.nextElementSibling;t.innerHTML===(0,m.unicode2Emoji)(o.Constants.SIYUAN_IMAGE_FOLDER)&&(t.innerHTML=(0,m.unicode2Emoji)(o.Constants.SIYUAN_IMAGE_FILE))}n.parentElement.remove()}else n.remove();window.siyuan.mobileEditor&&window.siyuan.mobileEditor.protyle.path===e.data.path&&(0,b.setEmpty)()}}onRename(e){const t=this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${e.path}"]`);t&&(t.setAttribute("data-name",Lute.EscapeHTMLStr(e.title)),t.querySelector(".b3-list-item__text").innerHTML=(0,a.escapeHtml)(e.title))}onMount(e){if(e.data.existed)return;const t=this.closeElement.querySelector(`li[data-url="${e.data.box.id}"]`);t&&t.remove(),(0,l.setNoteBook)((t=>{const n=this.genNotebook(e.data.box);if(0===this.element.childElementCount)this.element.innerHTML=n;else{let i;t.find(((n,a)=>{if(n.id===e.data.box.id){for(;a>0;){if(!t[a-1].closed){i=t[a-1].id;break}a--}return!0}})),i?this.element.querySelector(`[data-url="${i}"]`).insertAdjacentHTML("afterend",n):this.element.insertAdjacentHTML("afterbegin",n)}e.callback===o.Constants.CB_MOUNT_HELP&&(0,p.openMobileFileById)(o.Constants.HELP_START_PATH[window.siyuan.config.appearance.lang])}))}onLsHTML(e){let t="";if(e.files.forEach((e=>{t+=this.genFileHTML(e)})),""===t)return;const n=this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${e.path}"]`);let i=n.nextElementSibling;i&&"UL"===i.tagName&&i.remove(),n.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),n.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${t}</ul>`),i=n.nextElementSibling,setTimeout((()=>{i.setAttribute("style",`height:${i.childElementCount*n.clientHeight}px;`),setTimeout((()=>{this.element.querySelectorAll(".file-tree__sliderDown").forEach((e=>{e.classList.remove("file-tree__sliderDown"),e.removeAttribute("style")}))}),120)}),2)}onLsSelect(e,t){let n="";if(e.files.forEach((i=>{n+=this.genFileHTML(i),t===i.path?this.selectItem(e.box,t):t.startsWith(i.path.replace(".sy",""))&&(0,c.fetchPost)("/api/filetree/listDocsByPath",{notebook:e.box,path:i.path,sort:window.siyuan.config.fileTree.sort},(e=>{this.selectItem(e.data.box,t,e.data)}))})),""===n)return;const i=this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${e.path}"]`);i.nextElementSibling&&"UL"===i.nextElementSibling.tagName&&i.nextElementSibling.remove(),i.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),i.insertAdjacentHTML("afterend",`<ul>${n}</ul>`),this.setCurrent(this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${t}"]`))}setCurrent(e){if(!e)return;this.element.querySelectorAll("li").forEach((e=>{e.classList.remove("b3-list-item--focus")})),e.classList.add("b3-list-item--focus");const t=this.actionsElement.clientHeight;e.offsetTop-t<this.element.scrollTop?this.element.scrollTop=e.offsetTop-t:e.offsetTop-this.element.clientHeight-t+e.clientHeight>this.element.scrollTop&&(this.element.scrollTop=e.offsetTop-this.element.clientHeight-t+e.clientHeight)}getLeaf(e,t){var n;const i=e.querySelector(".b3-list-item__arrow");if(i.classList.contains("b3-list-item__arrow--open"))return i.classList.remove("b3-list-item__arrow--open"),void(null===(n=e.nextElementSibling)||void 0===n||n.remove());(0,c.fetchPost)("/api/filetree/listDocsByPath",{notebook:t,path:e.getAttribute("data-path"),sort:window.siyuan.config.fileTree.sort},(e=>{"/"!==e.data.path||0!==e.data.files.length?this.onLsHTML(e.data):(0,d.showMessage)(window.siyuan.languages.emptyContent)}))}selectItem(e,t,n){const i=this.element.querySelector(`[data-url="${e}"]`);if(!i)return;let a,s=t;for(;!a;)if(a=i.querySelector(`[data-path="${s}"]`),!a){const e=(0,l.pathPosix)().dirname(s);s="/"===e?e:e+".sy"}a.getAttribute("data-path")!==t?n&&n.path===s?this.onLsSelect(n,t):(0,c.fetchPost)("/api/filetree/listDocsByPath",{notebook:e,path:s,sort:window.siyuan.config.fileTree.sort},(e=>{this.onLsSelect(e.data,t)})):this.setCurrent(a)}}t.MobileFiles=w},7950:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MobileOutline=void 0;const i=n(3456),a=n(7683),s=n(999),o=n(8438),l=n(532);t.MobileOutline=class{constructor(){this.openNodes={},this.element=document.querySelector('#sidebar [data-type="sidebar-outline"]'),this.element.innerHTML=`<div class="toolbar">\n    <div class="fn__space"></div>\n    <div class="toolbar__text">\n        ${window.siyuan.languages.outline}\n    </div>\n    <span class="fn__flex-1 fn__space"></span>\n    <svg data-type="expand" class="toolbar__icon"><use xlink:href="#iconFullscreen"></use></svg>\n    <span class="fn__space"></span>\n    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>\n</div>\n<div class="fn__flex-1"></div>`,this.tree=new i.Tree({element:this.element.lastElementChild,data:null,click:e=>{const t=e.getAttribute("data-node-id");(0,a.fetchPost)("/api/block/checkBlockFold",{id:t},(e=>{(0,s.openMobileFileById)(t,e.data?[o.Constants.CB_GET_FOCUS,o.Constants.CB_GET_ALL,o.Constants.CB_GET_HTML]:[o.Constants.CB_GET_FOCUS,o.Constants.CB_GET_SETID,o.Constants.CB_GET_CONTEXT,o.Constants.CB_GET_HTML])}))}}),this.element.firstElementChild.querySelector('[data-type="collapse"]').addEventListener((0,l.getEventName)(),(()=>{this.tree.collapseAll()}));const e=this.element.firstElementChild.querySelector('[data-type="expand"]');e.addEventListener((0,l.getEventName)(),(()=>{e.classList.contains("toolbar__icon--active")?e.classList.remove("toolbar__icon--active"):e.classList.add("toolbar__icon--active"),this.tree.expandAll()})),this.update()}update(){(0,a.fetchPost)("/api/outline/getDocOutline",{id:window.siyuan.mobileEditor.protyle.block.rootID},(e=>{let t,n=this.element.querySelector(".b3-list-item--focus");n&&(t=n.getAttribute("data-node-id"));const i=window.siyuan.mobileEditor.protyle.block.rootID;this.openNodes[i]&&(this.openNodes[i]=this.tree.getExpandIds()),this.tree.updateData(e.data),this.openNodes[i]&&!this.element.firstElementChild.querySelector('[data-type="expand"]').classList.contains("toolbar__icon--active")?this.tree.setExpandIds(this.openNodes[i]):(this.tree.expandAll(),this.openNodes[i]=this.tree.getExpandIds()),t&&(n=this.element.querySelector(`[data-node-id="${t}"]`),n&&n.classList.add("b3-list-item--focus"))}))}}},5543:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MobileTags=void 0;const i=n(3456),a=n(7683),s=n(7821),o=n(6937),l=n(3163),r=n(2041),d=n(9755),c=n(4356);t.MobileTags=class{constructor(){this.element=document.querySelector('#sidebar [data-type="sidebar-tag"]'),this.element.innerHTML=`<div class="toolbar">\n    <div class="fn__space"></div>\n    <div class="toolbar__text">\n        ${window.siyuan.languages.tag}\n    </div>\n    <span class="fn__space"></span>\n    <svg data-type="expand" class="toolbar__icon"><use xlink:href="#iconFullscreen"></use></svg>\n    <span class="fn__space"></span>\n    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>\n    <span class="fn__space"></span>\n    <svg data-type="sort" class="toolbar__icon"><use xlink:href="#iconSort"></use></svg>\n</div>\n<div class="fn__flex-1 tagList"></div>\n<img style="position: absolute;top: 0;left: 0;height: 100%;width: 100%;padding: 30vw;box-sizing: border-box;" src="/stage/loading-pure.svg">`,this.tree=new i.Tree({element:this.element.querySelector(".tagList"),data:null,click:e=>{const t=(0,s.hasClosestByClassName)(event.target,"b3-list-item__action");if(t){const n=e.getAttribute("data-label");if("edit"===t.getAttribute("data-type")){const e=new l.Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value="${n}"></div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>\n</div>`,width:"80vw"}),t=e.element.querySelectorAll(".b3-button");t[0].addEventListener("click",(()=>{e.destroy()}));const i=e.element.querySelector("input");e.bindInput(i,(()=>{t[1].click()})),i.focus(),i.select(),t[1].addEventListener("click",(()=>{(0,a.fetchPost)("/api/tag/renameTag",{oldLabel:n,newLabel:i.value})}))}else(0,r.confirmDialog)(window.siyuan.languages.delete,`${window.siyuan.languages.confirmDelete} <b>${(0,d.escapeHtml)(n)}</b>?`,(()=>{(0,a.fetchPost)("/api/tag/removeTag",{label:n})}))}else{const t=document.getElementById("model"),n=document.getElementById("modelMain");(0,c.popSearch)(t,n),document.getElementById("toolbarSearch").value=`#${e.getAttribute("data-label")}#`,(0,c.toolbarSearchEvent)()}},topExtHTML:'<span class="b3-list-item__action" data-type="edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="b3-list-item__action" data-type="remove"><svg><use xlink:href="#iconTrashcan"></use></svg></span>'}),this.element.addEventListener("click",(e=>{let t=e.target;for(;t&&!t.isEqualNode(this.element);){if(t.classList.contains("toolbar__icon")){switch(t.getAttribute("data-type")){case"collapse":this.tree.collapseAll(),e.preventDefault(),e.stopPropagation();break;case"expand":this.tree.expandAll(),e.preventDefault(),e.stopPropagation();break;case"sort":window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new o.MenuItem({icon:0===window.siyuan.config.tag.sort?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{window.siyuan.config.tag.sort=0,this.update()}}).element),window.siyuan.menus.menu.append(new o.MenuItem({icon:1===window.siyuan.config.tag.sort?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{window.siyuan.config.tag.sort=1,this.update()}}).element),window.siyuan.menus.menu.append(new o.MenuItem({icon:4===window.siyuan.config.tag.sort?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{window.siyuan.config.tag.sort=4,this.update()}}).element),window.siyuan.menus.menu.append(new o.MenuItem({icon:5===window.siyuan.config.tag.sort?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{window.siyuan.config.tag.sort=5,this.update()}}).element),window.siyuan.menus.menu.append(new o.MenuItem({icon:7===window.siyuan.config.tag.sort?"iconSelect":void 0,label:window.siyuan.languages.refCountASC,click:()=>{window.siyuan.config.tag.sort=7,this.update()}}).element),window.siyuan.menus.menu.append(new o.MenuItem({icon:8===window.siyuan.config.tag.sort?"iconSelect":void 0,label:window.siyuan.languages.refCountDESC,click:()=>{window.siyuan.config.tag.sort=8,this.update()}}).element),window.siyuan.menus.menu.popup({x:e.clientX,y:e.clientY}),window.siyuan.menus.menu.element.style.zIndex="310",e.preventDefault(),e.stopPropagation()}}t=t.parentElement}})),this.update()}update(){this.element.lastElementChild.classList.remove("fn__none"),(0,a.fetchPost)("/api/tag/getTag",{sort:window.siyuan.config.tag.sort},(e=>{this.openNodes&&(this.openNodes=this.tree.getExpandIds()),this.tree.updateData(e.data),this.openNodes?this.tree.setExpandIds(this.openNodes):this.openNodes=this.tree.getExpandIds(),this.element.lastElementChild.classList.add("fn__none")}))}}},2708:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.closePanel=void 0;t.closePanel=()=>{const e=document.getElementById("menu"),t=document.getElementById("sidebar"),n=document.querySelector(".scrim"),i=document.getElementById("model");e.style.right="-100vw",t.style.left="-100vw",i.style.top="-100vh",n.classList.add("fn__none")}},4448:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.initFramework=void 0;const i=n(8438),a=n(2708),s=n(999),o=n(3029),l=n(532),r=n(8571),d=n(7683),c=n(2738),u=n(6700),p=n(1040),m=n(9883),g=n(3575),b=n(6772),y=n(7950),f=n(7821),h=n(2649),w=n(2504),v=n(5543);t.initFramework=()=>{(0,c.setInlineStyle)();const e=document.querySelector(".scrim"),t=document.getElementById("sidebar");let n,o,E,k;t.querySelector(".toolbar--border").addEventListener((0,l.getEventName)(),(e=>{const i=(0,f.hasTopClosestByTag)(e.target,"svg");if(!i||i.classList.contains("toolbar__icon--active"))return;const a=i.getAttribute("data-type");t.querySelectorAll(".toolbar--border svg").forEach((e=>{const s=e.getAttribute("data-type");s===a?("sidebar-outline-tab"===a?n?n.update():n=new y.MobileOutline:"sidebar-backlink-tab"===a?o?o.update():o=new h.MobileBacklinks:"sidebar-bookmark-tab"===a?o?o.update():E=new w.MobileBookmarks:"sidebar-tag-tab"===a&&(o?k.update():k=new v.MobileTags),i.classList.add("toolbar__icon--active"),t.lastElementChild.querySelector(`[data-type="${s.replace("-tab","")}"]`).classList.remove("fn__none")):(e.classList.remove("toolbar__icon--active"),t.lastElementChild.querySelector(`[data-type="${s.replace("-tab","")}"]`).classList.add("fn__none"))}))})),new b.MobileFiles,document.getElementById("toolbarFile").addEventListener((0,l.getEventName)(),(()=>{t.style.left="0",document.querySelector(".scrim").classList.remove("fn__none");const e=t.querySelector(".toolbar--border .toolbar__icon--active").getAttribute("data-type");"sidebar-outline-tab"===e?n.update():"sidebar-backlink-tab"===e?o.update():"sidebar-bookmark-tab"===e?E.update():"sidebar-tag-tab"===e&&k.update()})),document.getElementById("toolbarMore").addEventListener((0,l.getEventName)(),(()=>{(0,g.popMenu)()}));const C=document.getElementById("toolbarEdit");if(window.siyuan.config.readonly)C.classList.add("fn__none");else{const e=C.querySelector("use");C.addEventListener((0,l.getEventName)(),(()=>{const t=document.getElementById("toolbarName");"#iconEdit"===e.getAttribute("xlink:href")?((0,p.enableProtyle)(window.siyuan.mobileEditor.protyle),t.readOnly=!1,e.setAttribute("xlink:href","#iconPreview")):((0,p.disabledProtyle)(window.siyuan.mobileEditor.protyle),t.readOnly=!0,e.setAttribute("xlink:href","#iconEdit"))}))}if(e.addEventListener((0,l.getEventName)(),(()=>{(0,a.closePanel)()})),document.getElementById("modelClose").addEventListener((0,l.getEventName)(),(()=>{(0,a.closePanel)()})),_(),(0,m.getOpenNotebookCount)()>0){const e=JSON.parse(window.localStorage.getItem(i.Constants.LOCAL_DOCINFO)||'{"id": ""}');(0,d.fetchPost)("/api/block/checkBlockExist",{id:e.id},(t=>{t.data?(0,s.openMobileFileById)(e.id,e.action):(0,d.fetchPost)("/api/block/getRecentUpdatedBlocks",{},(e=>{0!==e.data.length?(0,s.openMobileFileById)(e.data[0].id,[i.Constants.CB_GET_HL,i.Constants.CB_GET_CONTEXT]):(0,u.setEmpty)()}))}))}else(0,u.setEmpty)();window.siyuan.config.newbie&&(0,r.mountHelp)()};const _=()=>{const e=document.getElementById("toolbarName");e.setAttribute("placeholder",window.siyuan.languages._kernel[16]),e.addEventListener("blur",(()=>{if(!window.siyuan.config.readonly&&"#iconEdit"!==document.querySelector("#toolbarEdit use").getAttribute("xlink:href"))return!!(0,o.validateName)(e.value)&&void(0,d.fetchPost)("/api/filetree/renameDoc",{notebook:window.siyuan.mobileEditor.protyle.notebookId,path:window.siyuan.mobileEditor.protyle.path,title:e.value})}))}},3575:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.popMenu=void 0;const i=n(7683),a=n(532),s=n(4356),o=n(9683),l=n(2708),r=n(8438),d=n(4185),c=n(8571),u=n(7541),p=n(3986),m=n(8970),g=n(7491),b=n(4933),y=n(2041),f=n(8896),h=n(3163),w=n(3680),v=(e,t)=>{(0,l.closePanel)();let n="";window.siyuan.user.userTitles.length>0&&(n='<div class="fn__hr--b"></div><div class="fn__flex" style="position: absolute"><span class="fn__space"></span>',window.siyuan.user.userTitles.forEach((e=>{n+=`<div class="b3-chip">${e.icon} ${e.name}</div><span class="fn__space"></span>`})),n+="</div>"),e.style.top="0",e.querySelector(".toolbar__icon").innerHTML='<use xlink:href="#iconAccount"></use>',e.querySelector(".toolbar__text").textContent=window.siyuan.languages.accountManage,t.innerHTML=`<div class="fn__flex-column">\n<div class="config-account__bg">\n    <div class="config-account__cover" style="background-image: url(${window.siyuan.user.userHomeBImgURL})"></div>\n    <a href="https://ld246.com/settings/avatar" class="config-account__avatar" style="background-image: url(${window.siyuan.user.userAvatarURL})" target="_blank"></a>\n    <h1 class="config-account__name">\n        <a target="_blank" class="fn__a" href="https://ld246.com/member/${window.siyuan.user.userName}">${window.siyuan.user.userName}</a>\n    </h1>\n    ${n}\n</div>\n<div class="config-account__info">\n    <div class="fn__flex">\n        <a class="b3-button b3-button--text" href="https://ld246.com/settings" target="_blank">${window.siyuan.languages.accountManage}</a>\n        <span class="fn__space"></span>\n        <button class="b3-button b3-button--cancel" id="logout">\n            ${window.siyuan.languages.logout}\n        </button>\n        <span class="fn__space"></span>\n        <button class="b3-button b3-button--cancel" id="deactivateUser">\n            ${window.siyuan.languages.deactivateUser}\n        </button>\n        <span class="fn__flex-1"></span>\n        <button class="b3-button b3-button--cancel" id="refresh">\n            <svg><use xlink:href="#iconRefresh"></use></svg>\n        </button>\n    </div>\n</div></div>`,t.querySelector("#logout").addEventListener((0,a.getEventName)(),(()=>{(0,i.fetchPost)("/api/setting/logoutCloudUser",{},(()=>{window.siyuan.user=null,(0,l.closePanel)(),document.getElementById("menuAccount").innerHTML=`<svg class="b3-list-item__graphic"><use xlink:href="#iconAccount"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.login}</span>`}))})),t.querySelector("#deactivateUser").addEventListener((0,a.getEventName)(),(()=>{(0,y.confirmDialog)("⚠️ "+window.siyuan.languages.deactivateUser,window.siyuan.languages.deactivateUserTip,(()=>{(0,i.fetchPost)("/api/account/deactivate",{},(()=>{window.siyuan.user=null,(0,l.closePanel)(),document.getElementById("menuAccount").innerHTML=`<svg class="b3-list-item__graphic"><use xlink:href="#iconAccount"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.login}</span>`}))}))}));const s=t.querySelector("#refresh");s.addEventListener("click",(()=>{const n=s.firstElementChild;n.classList.contains("fn__rotate")||(n.classList.add("fn__rotate"),(0,i.fetchPost)("/api/setting/getCloudUser",{token:window.siyuan.user.userToken},(n=>{window.siyuan.user=n.data,(0,g.showMessage)(window.siyuan.languages.refreshUser,3e3),v(e,t);const i=document.getElementById("menuAccount");window.siyuan.user?i.innerHTML=`<img class="b3-list-item__graphic" src="${window.siyuan.user.userAvatarURL}"/><span class="b3-list-item__text">${window.siyuan.user.userName}</span>`:i.innerHTML=`<svg class="b3-list-item__graphic"><use xlink:href="#iconAccount"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.login}</span>`})))}))};t.popMenu=()=>{const e=document.getElementById("model"),t=document.getElementById("modelMain"),n=document.querySelector(".scrim"),_=document.getElementById("menu");if(""!==_.innerHTML)return _.style.right="0",void n.classList.remove("fn__none");(0,i.fetchPost)("/api/setting/getCloudUser",{},(E=>{window.siyuan.user=E.data;let k="";k=window.siyuan.user?`<div class="b3-list-item b3-list-item--big" id="menuAccount">\n    <img class="b3-list-item__graphic" src="${window.siyuan.user.userAvatarURL}"/>\n    <span class="b3-list-item__text">${window.siyuan.user.userName}</span>\n</div>`:`<div class="b3-list-item b3-list-item--big" id="menuAccount">\n    <svg class="b3-list-item__graphic"><use xlink:href="#iconAccount"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.login}</span>\n</div>`,_.innerHTML=`<div id="menuSearch" class="b3-list-item b3-list-item--big">\n    <svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.search}</span>\n</div>\n<div id="menuNewDaily" class="b3-list-item b3-list-item--big">\n    <svg class="b3-list-item__graphic"><use xlink:href="#iconCalendar"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.dailyNote}</span>\n</div>\n<div class="b3-list-item b3-list-item--big" id="menuNewNotebook">\n    <svg class="b3-list-item__graphic"><use xlink:href="#iconFilesRoot"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newNotebook}</span>\n</div>\n<div class="b3-list-item b3-list-item--big" id="menuSyncNow">\n    <svg class="b3-list-item__graphic"><use xlink:href="#iconRefresh"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.syncNow}</span>\n</div>\n<div class="b3-list-item b3-list-item--big${window.siyuan.config.readonly?" fn__none":""}" id="menuHistory">\n    <svg class="b3-list-item__graphic"><use xlink:href="#iconVideo"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.dataHistory}</span>\n</div>\n<div slot="border-bottom: 1px solid var(--b3-border-color);"></div>\n<div class="b3-list-item b3-list-item--big" id="menuAppearance">\n    <svg class="b3-list-item__graphic"><use xlink:href="#iconTheme"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.appearance}</span>\n</div>\n<div class="b3-list-item b3-list-item--big" id="menuLock">\n    <svg class="b3-list-item__graphic"><use xlink:href="#iconLock"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.lockScreen}</span>\n</div>\n${k}\n<div id="menuSync" class="b3-list-item b3-list-item--big">\n    <svg class="b3-list-item__graphic"><use xlink:href="#iconCloud"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.cloud}</span>\n</div>\n<div class="b3-list-item b3-list-item--big" id="menuHelp">\n    <svg class="b3-list-item__graphic"><use xlink:href="#iconHelp"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.help}</span>\n</div>\n<div class="b3-list-item b3-list-item--big" id="menuAbout">\n    <svg class="b3-list-item__graphic"><use xlink:href="#iconInfo"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.about}</span>\n</div>\n<div class="b3-list-item b3-list-item--big" id="menuSafeQuit">\n    <svg class="b3-list-item__graphic"><use xlink:href="#iconQuit"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.safeQuit}</span>\n</div>`,_.addEventListener((0,a.getEventName)(),(n=>{let E=n.target;for(;E&&!E.isEqualNode(_);){if("menuSearch"===E.id){(0,s.popSearch)(e,t),n.preventDefault(),n.stopPropagation();break}if("menuAppearance"===E.id){(0,o.initAppearance)(e,t),n.preventDefault(),n.stopPropagation();break}if("menuSafeQuit"===E.id){(0,b.exitSiYuan)(),n.preventDefault(),n.stopPropagation();break}if("menuAbout"===E.id){(0,l.closePanel)(),(!window.siyuan.config.localIPs||0===window.siyuan.config.localIPs.length||1===window.siyuan.config.localIPs.length&&""===window.siyuan.config.localIPs[0])&&(window.siyuan.config.localIPs=["127.0.0.1"]),e.style.top="0",e.querySelector(".toolbar__icon").innerHTML='<use xlink:href="#iconInfo"></use>',e.querySelector(".toolbar__text").textContent=window.siyuan.languages.about,t.innerHTML=`<div class="b3-label fn__flex">\n    <div class="fn__flex-1">\n        ${window.siyuan.languages.about11}\n        <div class="b3-label__text">${window.siyuan.languages.about12}</div>\n    </div>\n    <div class="fn__space"></div>\n    <input class="b3-switch fn__flex-center" id="networkServe" type="checkbox"${window.siyuan.config.system.networkServe?" checked":""}>\n</div>\n<div class="b3-label">\n       ${window.siyuan.languages.about2}\n       <div class="fn__hr"></div>\n       <input class="b3-text-field fn__block" readonly value="http://${window.siyuan.config.system.networkServe?window.siyuan.config.localIPs[0]:"127.0.0.1"}:6806">\n       <div class="b3-label__text">${window.siyuan.languages.about3}</div>\n       <div class="fn__hr"></div>\n       <span class="b3-label__text"><code class="fn__code">${window.siyuan.config.localIPs.join("</code> <code class='fn__code'>")}</code></span>\n</div>\n<div class="b3-label">\n    ${window.siyuan.languages.about5}\n    <div class="fn__hr"></div>\n    <button class="b3-button b3-button--outline fn__block" id="authCode">\n        <svg><use xlink:href="#iconLock"></use></svg>${window.siyuan.languages.config}\n    </button>\n    <div class="b3-label__text">${window.siyuan.languages.about6}</div>\n</div>\n<div class="b3-label">\n    ${window.siyuan.languages.dataRepoKey}\n    <div class="fn__hr"></div>\n    <div class="${window.siyuan.config.repo.key?"fn__none":""}">\n        <button class="b3-button b3-button--outline fn__block" id="importKey">\n            <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.importKey}\n        </button>\n        <div class="fn__hr"></div>\n        <button class="b3-button b3-button--outline fn__block" id="initKey">\n            <svg><use xlink:href="#iconLock"></use></svg>${window.siyuan.languages.genKey}\n        </button>\n        <div class="fn__hr"></div>\n        <button class="b3-button b3-button--outline fn__block" id="initKeyByPW">\n            ${window.siyuan.languages.genKeyByPW}\n        </button>\n    </div>\n    <div class="${window.siyuan.config.repo.key?"":"fn__none"}">\n        <button class="b3-button b3-button--outline fn__block" id="copyKey">\n            <svg><use xlink:href="#iconCopy"></use></svg>${window.siyuan.languages.copyKey}\n        </button>\n        <div class="fn__hr"></div>\n        <button class="b3-button b3-button--outline fn__block" id="removeKey">\n            <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.resetRepo}\n        </button>\n    </div>\n    <div class="b3-label__text">${window.siyuan.languages.dataRepoKeyTip1}</div>\n    <div class="b3-label__text ft__error">${window.siyuan.languages.dataRepoKeyTip2}</div>\n</div>\n<div class="b3-label">\n    ${window.siyuan.languages.about13}\n    <span class="b3-label__text">${window.siyuan.config.api.token}</span>\n    <div class="fn__hr"></div>\n    <button class="b3-button b3-button--outline fn__block" id="token">\n        <svg><use xlink:href="#iconCopy"></use></svg>${window.siyuan.languages.copy}\n    </button>\n    <div class="b3-label__text">${window.siyuan.languages.about14}</div>\n</div>\n<div class="b3-label">\n    <div class="fn__flex">\n        ${window.siyuan.languages.export}\n    </div>\n    <div class="fn__hr"></div>\n    <button class="b3-button b3-button--outline fn__block" id="exportData">\n       <svg><use xlink:href="#iconUpload"></use></svg>Data\n    </button>\n    <div class="fn__hr"></div>\n    <div class="b3-label__text">${window.siyuan.languages.exportDataTip}</div>\n    <div class="fn__hr--b"></div>\n    <button class="b3-button b3-button--outline fn__block" id="exportLog">\n       <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.systemLog}\n    </button>\n    <div class="fn__hr"></div>\n    <div class="b3-label__text">${window.siyuan.languages.systemLogTip}</div>\n</div>\n<div class="b3-label">\n    <div class="fn__flex">\n        ${window.siyuan.languages.import}\n    </div>\n    <div class="fn__hr"></div>\n    <button class="b3-button b3-button--outline fn__block" style="position: relative">\n        <input id="importData" class="b3-form__upload" type="file">\n        <svg><use xlink:href="#iconDownload"></use></svg> ${window.siyuan.languages.import} Data\n    </button>\n    <div class="fn__hr"></div>\n    <div class="b3-label__text">${window.siyuan.languages.importDataTip}</div>\n</div>\n<div class="b3-label">\n    <div class="config-about__logo">\n        <img src="/stage/icon.png">\n        <span class="fn__space"></span>\n        <div>\n            <span>${window.siyuan.languages.siyuanNote}</span>\n            <span class="fn__space"></span>\n            <span class="ft__on-surface">v${r.Constants.SIYUAN_VERSION}</span>\n            <br>\n            <span class="ft__on-surface">${window.siyuan.languages.slogan}</span>\n        </div>\n        <span class="fn__flex-1"></span>\n        <a class="fn__flex" href="${"zh_CN"===window.siyuan.config.lang?"https://ld246.com/article/1649901726096":"https://github.com/siyuan-note/siyuan/issues"}" target="_blank">\n            <svg class="fn__flex-center svg"><use xlink:href="#iconHeart"></use></svg>\n            <span class="fn__space"></span>\n            ${window.siyuan.languages.feedback}\n        </a>\n    </div>\n    <div style="color:var(--b3-theme-surface);font-family: cursive;">会泽百家&nbsp;至公天下</div>\n    ${window.siyuan.languages.about1}\n</div>`;t.querySelector("#authCode").addEventListener("click",(()=>{(0,d.setAccessAuthCode)()}));const s=t.querySelector("#importKey");s.addEventListener("click",(()=>{const e=new h.Dialog({title:"🔑 "+window.siyuan.languages.key,content:`<div class="b3-dialog__content">\n    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.keyPlaceholder}"></textarea>\n</div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>\n</div>`,width:"80vw"}),t=e.element.querySelector("textarea");t.focus();const n=e.element.querySelectorAll(".b3-button");n[0].addEventListener("click",(()=>{e.destroy()})),n[1].addEventListener("click",(()=>{(0,i.fetchPost)("/api/repo/importRepoKey",{key:t.value},(()=>{window.siyuan.config.repo.key=t.value,s.parentElement.classList.add("fn__none"),s.parentElement.nextElementSibling.classList.remove("fn__none"),e.destroy()}))}))})),t.querySelector("#initKey").addEventListener("click",(()=>{(0,y.confirmDialog)("🔑 "+window.siyuan.languages.genKey,window.siyuan.languages.initRepoKeyTip,(()=>{(0,i.fetchPost)("/api/repo/initRepoKey",{},(e=>{window.siyuan.config.repo.key=e.data.key,s.parentElement.classList.add("fn__none"),s.parentElement.nextElementSibling.classList.remove("fn__none")}))}))})),t.querySelector("#initKeyByPW").addEventListener("click",(()=>{const e=new h.Dialog({title:"🔑 "+window.siyuan.languages.genKeyByPW,content:`<div class="b3-dialog__content">\n    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.password}">\n</div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>\n</div>`,width:"520px"}),t=e.element.querySelector(".b3-text-field");t.focus();const n=e.element.querySelectorAll(".b3-button");e.bindInput(t,(()=>{n[1].click()})),n[0].addEventListener("click",(()=>{e.destroy()})),n[1].addEventListener("click",(()=>{t.value?(0,y.confirmDialog)("🔑 "+window.siyuan.languages.genKeyByPW,window.siyuan.languages.initRepoKeyTip,(()=>{e.destroy(),(0,i.fetchPost)("/api/repo/InitRepoKeyFromPassphrase",{pass:t.value},(e=>{window.siyuan.config.repo.key=e.data.key,s.parentElement.classList.add("fn__none"),s.parentElement.nextElementSibling.classList.remove("fn__none")}))})):(0,g.showMessage)(window.siyuan.languages._kernel[142])}))})),t.querySelector("#copyKey").addEventListener("click",(()=>{(0,g.showMessage)(window.siyuan.languages.copied),(0,a.writeText)(window.siyuan.config.repo.key)})),t.querySelector("#removeKey").addEventListener("click",(()=>{(0,y.confirmDialog)("⚠️ "+window.siyuan.languages.resetRepo,window.siyuan.languages.resetRepoTip,(()=>{(0,i.fetchPost)("/api/repo/resetRepo",{},(()=>{window.siyuan.config.repo.key="",window.siyuan.config.sync.enabled=!1,s.parentElement.classList.remove("fn__none"),s.parentElement.nextElementSibling.classList.add("fn__none")}))}))})),t.querySelector("#token").addEventListener("click",(()=>{(0,g.showMessage)(window.siyuan.languages.copied),(0,a.writeText)(window.siyuan.config.api.token)})),t.querySelector("#exportData").addEventListener("click",(()=>{(0,i.fetchPost)("/api/export/exportData",{},(e=>{(0,a.openByMobile)(e.data.zip)}))})),t.querySelector("#exportLog").addEventListener("click",(()=>{(0,i.fetchPost)("/api/system/exportLog",{},(e=>{(0,a.openByMobile)(e.data.zip)}))})),t.querySelector("#importData").addEventListener("change",(e=>{const t=new FormData;t.append("file",e.target.files[0]),(0,i.fetchPost)("/api/import/importData",t)}));const o=t.querySelector("#networkServe");o.addEventListener("change",(()=>{(0,i.fetchPost)("/api/system/setNetworkServe",{networkServe:o.checked},(()=>{(0,b.exitSiYuan)()}))})),n.preventDefault(),n.stopPropagation();break}if("menuNewDaily"===E.id){(0,c.newDailyNote)(),n.preventDefault(),n.stopPropagation();break}if("menuNewNotebook"===E.id){(0,c.newNotebook)(),n.preventDefault(),n.stopPropagation();break}if("menuHelp"===E.id){(0,c.mountHelp)(),n.preventDefault(),n.stopPropagation();break}if("menuLock"===E.id){(0,i.fetchPost)("/api/system/logoutAuth",{},(()=>{window.location.href="/"})),n.preventDefault(),n.stopPropagation();break}if("menuSync"===E.id){(0,u.needSubscribe)()||((0,l.closePanel)(),e.style.top="0",e.querySelector(".toolbar__icon").innerHTML='<use xlink:href="#iconCloud"></use>',e.querySelector(".toolbar__text").textContent=window.siyuan.languages.cloud,t.innerHTML=p.repos.genHTML(),p.repos.element=t,p.repos.bindEvent()),n.preventDefault(),n.stopPropagation();break}if("menuSyncNow"===E.id){(0,w.syncGuide)(),n.preventDefault(),n.stopPropagation();break}if("menuHistory"===E.id&&!window.siyuan.config.readonly){(0,f.openHistory)(),n.preventDefault(),n.stopPropagation();break}if("menuAccount"===E.id){if(n.preventDefault(),n.stopPropagation(),(0,l.closePanel)(),document.querySelector("#menuAccount img"))return void v(e,t);e.style.top="0",e.querySelector(".toolbar__icon").innerHTML='<use xlink:href="#iconAccount"></use>',e.querySelector(".toolbar__text").textContent=window.siyuan.languages.login,t.innerHTML=`<div class="b3-form__space" id="form1">\n    <div class="b3-form__icon">\n        <svg class="b3-form__icon-icon"><use xlink:href="#iconAccount"></use></svg>\n        <input id="userName" class="b3-text-field fn__block b3-form__icon-input" placeholder="${window.siyuan.languages.accountName}">\n    </div>\n    <div class="fn__hr--b"></div>\n    <div class="b3-form__icon">\n        <svg class="b3-form__icon-icon"><use xlink:href="#iconLock"></use></svg>\n        <input type="password" id="userPassword" class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.password}">\n    </div>\n    <div class="b3-form__img fn__none">\n        <div class="fn__hr--b"></div>\n        <img id="captchaImg" class="fn__pointer" style="top: 17px">\n        <input id="captcha" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.captcha}">\n    </div>\n    <div class="fn__hr--b"></div>\n    <label class="ft__smaller ft__on-surface fn__flex">\n        <span class="fn__space"></span>\n        <input type="checkbox" class="b3-switch fn__flex-center" id="agreeLogin">\n        <span class="fn__space"></span>\n        <span>${window.siyuan.languages.accountTip}</span>\n    </label>\n    <div class="fn__hr--b"></div>\n    <button id="login" disabled class="b3-button fn__block">${window.siyuan.languages.login}</button>\n    <div class="fn__hr--b"></div>\n    <div class="ft__center">\n        <a href="https://ld246.com/forget-pwd" class="b3-button b3-button--cancel" target="_blank">${window.siyuan.languages.forgetPassword}</a>\n        <span class="fn__space${"ios"===window.siyuan.config.system.container?" fn__none":""}"></span>\n        <a href="https://ld246.com/register" class="b3-button b3-button--cancel${"ios"===window.siyuan.config.system.container?" fn__none":""}" target="_blank">${window.siyuan.languages.register}</a>\n    </div>\n</div>\n<div class="b3-form__space fn__none" id="form2">\n    <div class="b3-form__icon">\n        <svg class="b3-form__icon-icon"><use xlink:href="#iconLock"></use></svg>\n        <input id="twofactorAuthCode" class="b3-text-field fn__block b3-form__icon-input" placeholder="${window.siyuan.languages.twoFactorCaptcha}">\n    </div>\n    <div class="fn__hr--b"></div>\n    <button id="login2" class="b3-button fn__block">${window.siyuan.languages.login}</button>\n</div>`;const a=t.querySelector("#agreeLogin"),s=t.querySelector("#userName"),o=t.querySelector("#userPassword"),r=t.querySelector("#captchaImg"),d=t.querySelector("#captcha"),c=t.querySelector("#twofactorAuthCode"),u=t.querySelector("#login"),p=t.querySelector("#login2");let b,y;s.focus(),a.addEventListener("click",(()=>{a.checked?u.removeAttribute("disabled"):u.setAttribute("disabled","disabled")})),r.addEventListener("click",(()=>{r.setAttribute("src",`https://ld246.com/captcha/login?needCaptcha=${y}&t=${(new Date).getTime()}`)})),u.addEventListener("click",(()=>{(0,i.fetchPost)("/api/account/login",{userName:s.value.replace(/(^\s*)|(\s*$)/g,""),userPassword:m(o.value),captcha:d.value.replace(/(^\s*)|(\s*$)/g,"")},(e=>1===e.code?((0,g.showMessage)(e.msg),e.data.needCaptcha?(y=e.data.needCaptcha,d.parentElement.classList.remove("fn__none"),d.previousElementSibling.setAttribute("src",`https://ld246.com/captcha/login?needCaptcha=${e.data.needCaptcha}`),void(d.value="")):void 0):10===e.code?(t.querySelector("#form1").classList.add("fn__none"),t.querySelector("#form2").classList.remove("fn__none"),c.focus(),void(b=e.data.token)):void(0,i.fetchPost)("/api/setting/getCloudUser",{token:e.data.token},(e=>{window.siyuan.user=e.data,(0,l.closePanel)(),document.getElementById("menuAccount").innerHTML=`<img class="b3-list-item__graphic" src="${window.siyuan.user.userAvatarURL}"/>\n<span class="b3-list-item__text">${window.siyuan.user.userName}</span>`}))))})),p.addEventListener("click",(()=>{(0,i.fetchPost)("/api/setting/login2faCloudUser",{code:c.value,token:b},(e=>{(0,i.fetchPost)("/api/setting/getCloudUser",{token:e.data.token},(e=>{window.siyuan.user=e.data,(0,l.closePanel)(),document.getElementById("menuAccount").innerHTML=`<img class="b3-list-item__graphic" src="${window.siyuan.user.userAvatarURL}"/>\n<span class="b3-list-item__text">${window.siyuan.user.userName}</span>`}))}))}));break}E=E.parentElement}})),_.style.right="0",n.classList.remove("fn__none")}))}},137:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onMessage=void 0;const i=n(999),a=n(4933);t.onMessage=e=>{if(e)switch(e.cmd){case"progress":(0,a.progressLoading)(e);break;case"syncing":document.querySelector("#menuSyncNow")&&(0===e.code?document.querySelector("#menuSyncNow svg").classList.add("fn__rotate"):document.querySelector("#menuSyncNow svg").classList.remove("fn__rotate"));break;case"create":case"createdailynote":(0,i.openMobileFileById)(e.data.id);break;case"txerr":(0,a.transactionError)(e);break;case"statusbar":(0,a.progressStatus)(e)}}},4356:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.popSearch=t.toolbarSearchEvent=void 0;const i=n(2708),a=n(999),s=n(8438),o=n(7683),l=n(8059),r=n(5788),d=(e,t,n)=>{let i="";n&&(i='<div class="b3-list-item ft__smaller ft__on-surface">'+window.siyuan.languages.findInDoc.replace("${x}",t).replace("${y}",n)+"</div>"),e.forEach((e=>{i+=`<div class="b3-list-item b3-list-item--two" data-url="${e.box}" data-path="${e.path}" data-id="${e.id}">\n<div class="b3-list-item__first">\n    <svg class="b3-list-item__graphic"><use xlink:href="#${(0,l.getIconByType)(e.type)}"></use></svg>\n    <span class="b3-list-item__text">${e.content}</span>\n</div>\n<div class="b3-list-item__meta">${Lute.EscapeHTMLStr(e.hPath)}</div>\n</div>`})),document.querySelector("#searchPanel").innerHTML=i};let c=0;t.toolbarSearchEvent=()=>{clearTimeout(c),c=window.setTimeout((()=>{const e=document.getElementById("toolbarSearch");""===e.value?(0,o.fetchPost)("/api/block/getRecentUpdatedBlocks",{},(e=>{d(e.data)})):(0,o.fetchPost)("/api/search/fullTextSearchBlock",{query:e.value},(e=>{d(e.data.blocks,e.data.matchedRootCount,e.data.matchedBlockCount)}));const t=JSON.parse(localStorage.getItem(s.Constants.LOCAL_SEARCHEDATA)||"{}");t.k=e.value,localStorage.setItem(s.Constants.LOCAL_SEARCHEDATA,JSON.stringify(t))}),s.Constants.TIMEOUT_SEARCH)};t.popSearch=(e,n)=>{(0,i.closePanel)(),e.style.top="0",e.querySelector(".toolbar__icon").innerHTML='<use xlink:href="#iconSearch"></use>',e.querySelector(".toolbar__text").innerHTML='<input id="toolbarSearch" style="background-color: var(--b3-theme-surface);border: 0;" class="b3-text-field fn__block">',n.innerHTML='<div id="searchPanel"></div>',(()=>{const e=document.getElementById("toolbarSearch");e.focus();const n=JSON.parse(localStorage.getItem(s.Constants.LOCAL_SEARCHEDATA)||"{}");e.value=n.k||"",e.addEventListener("compositionend",(e=>{e&&e.isComposing||(0,t.toolbarSearchEvent)()})),e.addEventListener("input",(e=>{e&&e.isComposing||(0,t.toolbarSearchEvent)()}))})();const l=document.getElementById("searchPanel");l.addEventListener("click",(e=>{let t=e.target;for(;t&&!t.isEqualNode(l);){if(t.classList.contains("b3-list-item")){const n=t.getAttribute("data-id");window.siyuan.mobileEditor.protyle&&(0,r.preventScroll)(window.siyuan.mobileEditor.protyle),(0,o.fetchPost)("/api/block/checkBlockFold",{id:n},(e=>{(0,a.openMobileFileById)(n,e.data?[s.Constants.CB_GET_ALL,s.Constants.CB_GET_HL]:[s.Constants.CB_GET_HL,s.Constants.CB_GET_CONTEXT])})),(0,i.closePanel)(),e.preventDefault(),e.stopPropagation();break}t=t.parentElement}}),!1),(0,t.toolbarSearchEvent)()}},6700:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setEditor=t.setEmpty=void 0;const i=n(532),a=n(8571),s=n(9972),o=n(9883);t.setEmpty=()=>{document.getElementById("toolbarName").classList.add("fn__hidden"),document.getElementById("toolbarEdit").classList.add("fn__hidden"),document.getElementById("editor").classList.add("fn__none");const e=document.getElementById("empty");e.innerHTML=`<h1 style="width: 200px">${window.siyuan.languages.noOpenFile}</h1>\n<div class="fn__hr--b"></div>\n<div id="emptyNewFile" class="b3-list-item b3-list-item--big${(0,o.getOpenNotebookCount)()>0?"":" fn__none"}">\n    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newFile}</span>\n</div>\n<div class="b3-list-item b3-list-item--big" id="emptyNewNotebook">\n    <svg class="b3-list-item__graphic"><use xlink:href="#iconFilesRoot"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newNotebook}</span>\n</div>\n<div class="b3-list-item b3-list-item--big" id="emptyHelp">\n    <svg class="b3-list-item__graphic"><use xlink:href="#iconHelp"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.help}</span>\n</div>`,document.getElementById("emptyNewFile").addEventListener((0,i.getEventName)(),(()=>{window.siyuan.mobileEditor?(0,s.newFile)(window.siyuan.mobileEditor.protyle.notebookId,window.siyuan.mobileEditor.protyle.path,!0):window.siyuan.notebooks.find((e=>{e.closed&&(0,s.newFile)(e.id,"/",!0)}))})),document.getElementById("emptyNewNotebook").addEventListener((0,i.getEventName)(),(()=>{(0,a.newNotebook)()})),document.getElementById("emptyHelp").addEventListener((0,i.getEventName)(),(()=>{(0,a.mountHelp)()})),e.classList.remove("fn__none")};t.setEditor=()=>{document.getElementById("toolbarName").classList.remove("fn__hidden"),document.getElementById("toolbarEdit").classList.remove("fn__hidden"),document.getElementById("editor").classList.remove("fn__none"),document.getElementById("empty").classList.add("fn__none")}},4473:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleTouchMove=t.handleTouchStart=t.handleTouchEnd=void 0;const i=n(706);let a,s,o,l;t.handleTouchEnd=()=>{var e;window.siyuan.mobileEditor&&(null===(e=window.siyuan.mobileEditor.protyle.breadcrumb)||void 0===e||e.show()),a&&s&&-1!==navigator.userAgent.indexOf("iPhone")&&(Math.abs(o)>Math.abs(l)&&Math.abs(o)>window.innerWidth/2&&(o>0?(0,i.goForward)():(0,i.goBack)()),a=null,s=null)};t.handleTouchStart=e=>{o=0,l=0,a=e.touches[0].clientX,(a<48||a>window.innerWidth-24)&&document.querySelector(".scrim").classList.contains("fn__none")?s=e.touches[0].clientY:(a=null,s=null,e.stopImmediatePropagation())};t.handleTouchMove=e=>{a&&s&&(o=Math.floor(a-e.touches[0].clientX),l=Math.floor(s-e.touches[0].clientY),Math.abs(o),Math.abs(l))}},601:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fullscreen=t.netImg2LocalAssets=void 0;const i=n(7994),a=n(7683),s=n(8438),o=n(1040),l=n(6245),r=n(5615);t.netImg2LocalAssets=e=>{e.element.querySelector(".wysiwygLoading")||((0,i.addLoading)(e),(0,r.hideElements)(["toolbar"],e),(0,a.fetchPost)("/api/format/netImg2LocalAssets",{id:e.block.rootID},(()=>{(0,a.fetchPost)("/api/filetree/getDoc",{id:e.block.id,mode:0,size:s.Constants.SIZE_GET},(t=>{(0,o.onGet)(t,e,[s.Constants.CB_GET_FOCUS],(0,l.saveScroll)(e,!0))}))})))};t.fullscreen=(e,t)=>{const n=e.className.includes("fullscreen");n?(e.classList.remove("fullscreen"),document.querySelector("body").classList.contains("body--win32")&&document.getElementById("drag").classList.remove("fn__hidden")):(e.classList.add("fullscreen"),document.querySelector("body").classList.contains("body--win32")&&document.getElementById("drag").classList.add("fn__hidden")),t&&(n?t.querySelector("use").setAttribute("xlink:href","#iconFullscreen"):t.querySelector("use").setAttribute("xlink:href","#iconContract"))}},1196:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Breadcrumb=void 0;const i=n(8059),a=n(7683),s=n(8438),o=n(6937),l=n(601),r=n(2964),d=n(8461),c=n(9580),u=n(7491),p=n(562),m=n(7821),g=n(7541),b=n(6400),y=n(6112),f=n(2386),h=n(7994),w=n(1040),v=n(6245),_=n(5615);t.Breadcrumb=class{constructor(e){const t=document.createElement("div");t.className="protyle-breadcrumb";let n=`<div class="protyle-breadcrumb__bar"></div>\n<span class="fn__flex-1 fn__flex-shrink"></span>\n<button class="b3-tooltips b3-tooltips__w block__icon fn__flex-center" style="opacity: 1;" data-menu="true" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></button>`;e.options.render.breadcrumbContext&&(n+=`<span class="fn__space"></span>\n<div class="b3-tooltips b3-tooltips__w block__icon fn__flex-center" style="opacity: 1;" data-type="context" aria-label="${window.siyuan.languages.context}"><svg><use xlink:href="#iconAlignCenter"></use></svg></div>`),t.innerHTML=n,this.element=t.firstElementChild,t.addEventListener("click",(n=>{let i=n.target;for(;i&&!i.isEqualNode(t);){const t=i.getAttribute("data-node-id");if(t){e.options.render.breadcrumbDocName&&window.siyuan.ctrlIsPressed||(0,y.zoomOut)(e,t),n.preventDefault();break}if("true"===i.getAttribute("data-menu")){this.showMenu(e,{x:n.clientX,y:n.clientY}),n.preventDefault();break}if("context"===i.getAttribute("data-type")){i.classList.contains("block__icon--active")?((0,a.fetchPost)("/api/filetree/getDoc",{id:e.options.blockId,mode:0,size:s.Constants.SIZE_GET},(t=>{(0,w.onGet)(t,e)})),i.classList.remove("block__icon--active")):((0,a.fetchPost)("/api/filetree/getDoc",{id:e.options.blockId,mode:3,size:s.Constants.SIZE_GET},(t=>{(0,w.onGet)(t,e,[s.Constants.CB_GET_HL])})),i.classList.add("block__icon--active")),n.preventDefault();break}i=i.parentElement}})),t.addEventListener("mouseleave",(()=>{e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach((e=>{e.classList.remove("protyle-wysiwyg--hl")}))})),this.element.addEventListener("mouseover",(t=>{if(!e.selectElement.classList.contains("fn__none"))return;const n=t.target,i=(0,m.hasClosestByAttribute)(n,"data-node-id",null);if(i){e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach((e=>{e.classList.remove("protyle-wysiwyg--hl")}));const t=e.wysiwyg.element.querySelector(`[data-node-id="${i.getAttribute("data-node-id")}"]`);t&&t.classList.add("protyle-wysiwyg--hl")}})),this.element.addEventListener("mousewheel",(e=>{this.element.scrollLeft=this.element.scrollLeft+e.deltaY}),{passive:!0})}showMenu(e,t){let n;const i=(0,m.hasClosestBlock)((0,f.getEditorRange)(e.element).startContainer);i&&(n=i.getAttribute("data-node-id")),(0,a.fetchPost)("/api/block/getBlockWordCount",{id:n||e.block.id},(n=>{var i,m;if(window.siyuan.menus.menu.remove(),!e.contentElement.classList.contains("fn__none")){let t="";e.disabled||(t='<input class="b3-form__upload" type="file" multiple="multiple"',e.options.upload.accept?t+=` accept="${e.options.upload.accept}">`:t+=">");const n=new o.MenuItem({disabled:e.disabled,icon:"iconDownload",label:`${window.siyuan.languages.insertAsset}${t}`}).element;e.disabled||n.querySelector("input").addEventListener("change",(t=>{0!==t.target.files.length&&((0,p.uploadFiles)(e,t.target.files,t.target),window.siyuan.menus.menu.remove())})),window.siyuan.menus.menu.append(n),"android"===window.siyuan.config.system.container&&window.JSAndroid||window.siyuan.menus.menu.append(new o.MenuItem({disabled:e.disabled&&(!this.mediaRecorder||this.mediaRecorder&&!this.mediaRecorder.isRecording),current:this.mediaRecorder&&this.mediaRecorder.isRecording,icon:"iconRecord",label:(null===(i=this.mediaRecorder)||void 0===i?void 0:i.isRecording)?window.siyuan.languages.endRecord:window.siyuan.languages.startRecord,click:()=>{let t="";if(this.mediaRecorder)if(this.mediaRecorder.isRecording){this.mediaRecorder.stopRecording(),(0,u.hideMessage)(t);const n=new File([this.mediaRecorder.buildWavFileBlob()],`record${(new Date).getTime()}.wav`,{type:"video/webm"});(0,p.uploadFiles)(e,[n])}else(0,u.hideMessage)(t),t=(0,u.showMessage)(window.siyuan.languages.recording,-1),this.mediaRecorder.startRecordingNewWavFile();else navigator.mediaDevices.getUserMedia({audio:!0}).then((e=>{this.mediaRecorder=new c.RecordMedia(e),this.mediaRecorder.recorder.onaudioprocess=e=>{if(!this.mediaRecorder.isRecording)return;const t=e.inputBuffer.getChannelData(0),n=e.inputBuffer.getChannelData(1);this.mediaRecorder.cloneChannelData(t,n)},this.mediaRecorder.startRecordingNewWavFile(),t=(0,u.showMessage)(window.siyuan.languages.recording,-1)})).catch((()=>{(0,u.showMessage)(window.siyuan.languages["record-tip"])}))}}).element)}window.siyuan.menus.menu.append(new o.MenuItem({label:window.siyuan.languages.uploadAssets2CDN,icon:"iconCloud",click(){(0,g.needSubscribe)()||(0,a.fetchPost)("/api/asset/uploadCloud",{id:e.block.parentID})}}).element),window.siyuan.menus.menu.append(new o.MenuItem({label:window.siyuan.languages.netImg2LocalAsset,icon:"iconTransform",accelerator:window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,click(){(0,l.netImg2LocalAssets)(e)}}).element),window.siyuan.menus.menu.append(new o.MenuItem({label:window.siyuan.languages.optimizeTypography,icon:"iconFormat",click:()=>{(0,_.hideElements)(["toolbar"],e),(0,a.fetchPost)("/api/format/autoSpace",{id:e.block.rootID},(()=>{(0,a.fetchPost)("/api/filetree/getDoc",{id:e.block.id,mode:0,size:s.Constants.SIZE_GET},(t=>{(0,w.onGet)(t,e,[s.Constants.CB_GET_FOCUS],(0,v.saveScroll)(e,!0))}))}))}}).element),(null===(m=e.scroll)||void 0===m?void 0:m.element.classList.contains("fn__none"))||window.siyuan.menus.menu.append(new o.MenuItem({current:e.scroll.keepLazyLoad,label:window.siyuan.languages.keepLazyLoad,click:()=>{e.scroll.keepLazyLoad=!e.scroll.keepLazyLoad}}).element),window.siyuan.menus.menu.append(new o.MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new o.MenuItem({icon:"iconRefresh",accelerator:window.siyuan.config.keymap.editor.general.refresh.custom,label:window.siyuan.languages.refresh,click:()=>{(0,a.fetchPost)("/api/filetree/getDoc",{id:e.block.showAll?e.block.id:e.block.rootID,mode:0,size:e.block.showAll?s.Constants.SIZE_GET_MAX:s.Constants.SIZE_GET},(t=>{(0,w.onGet)(t,e,e.block.showAll?[s.Constants.CB_GET_ALL,s.Constants.CB_GET_FOCUS]:[s.Constants.CB_GET_FOCUS],(0,v.saveScroll)(e,!0),!0)}))}}).element),(0,b.isMobile)()||window.siyuan.menus.menu.append(new o.MenuItem({icon:"iconFullscreen",accelerator:window.siyuan.config.keymap.editor.general.fullscreen.custom,label:window.siyuan.languages.fullscreen,click:()=>{(0,l.fullscreen)(e.element),(0,h.setPadding)(e)}}).element);const y=[{current:!e.contentElement.classList.contains("fn__none"),label:window.siyuan.languages.wysiwyg,accelerator:window.siyuan.config.keymap.editor.general.wysiwyg.custom,click:()=>{(0,d.setEditMode)(e,"wysiwyg"),e.scroll.lastScrollTop=0,(0,a.fetchPost)("/api/filetree/getDoc",{id:e.block.rootID,size:s.Constants.SIZE_GET},(t=>{(0,w.onGet)(t,e),window.siyuan.menus.menu.remove()}))}}];y.push({current:!e.preview.element.classList.contains("fn__none"),icon:"iconPreview",label:window.siyuan.languages.preview,accelerator:window.siyuan.config.keymap.editor.general.preview.custom,click:()=>{(0,d.setEditMode)(e,"preview"),window.siyuan.menus.menu.remove()}}),window.siyuan.menus.menu.append(new o.MenuItem({icon:"iconEdit",label:window.siyuan.languages["edit-mode"],type:"submenu",submenu:y}).element),window.siyuan.menus.menu.append((0,r.exportMd)(e.block.parentID)),window.siyuan.menus.menu.append(new o.MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new o.MenuItem({type:"readonly",label:`<div class="fn__flex">${window.siyuan.languages.docRuneCount}<span class="fn__space fn__flex-1"></span>${n.data.rootBlockRuneCount}</div>\n<div class="fn__flex">${window.siyuan.languages.docWordCount}<span class="fn__space fn__flex-1"></span>${n.data.rootBlockWordCount}</div>\n<div class="fn__flex">${window.siyuan.languages.blockRuneCount}<span class="fn__space fn__flex-1"></span>${n.data.blockRuneCount}</div>\n<div class="fn__flex">${window.siyuan.languages.blockWordCount}<span class="fn__space fn__flex-1"></span>${n.data.blockWordCount}</div>`}).element),window.siyuan.menus.menu.popup(t)}))}render(e,t=!1){let n,s;getSelection().rangeCount>0&&(n=getSelection().getRangeAt(0),s=e.wysiwyg.element.isEqualNode(n.startContainer)||e.wysiwyg.element.contains(n.startContainer)?(0,m.hasClosestBlock)(n.startContainer):e.wysiwyg.element.firstElementChild),s||(s=e.wysiwyg.element.firstElementChild);const o=s.getAttribute("data-node-id");if(o!==this.id||t)this.id=o,(0,a.fetchPost)("/api/block/getBlockBreadcrumb",{id:o},(t=>{let n="";t.data.forEach(((a,s)=>{let o=!1;e.block.showAll||a.id!==e.block.parentID?e.block.showAll&&a.id===e.block.id&&(o=!0):o=!0,0!==s||e.options.render.breadcrumbDocName?n+=`<span class="protyle-breadcrumb__item${o?" protyle-breadcrumb__item--active":""}" data-node-id="${a.id}">\n    <svg class="popover__block" data-id="${a.id}"><use xlink:href="#${(0,i.getIconByType)(a.type,a.subType)}"></use></svg>\n    <span class="protyle-breadcrumb__text" title="${a.name}">${a.name}</span>\n</span>`:n+=`<span class="protyle-breadcrumb__item${o?" protyle-breadcrumb__item--active":""}" data-node-id="${a.id}">\n    <svg class="popover__block" data-id="${a.id}"><use xlink:href="#${(0,i.getIconByType)(a.type,a.subType)}"></use></svg>\n</span>`,s!==t.data.length-1&&(n+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>')})),this.element.classList.remove("protyle-breadcrumb__bar--nowrap"),this.element.innerHTML=n;const a=Array.from(this.element.querySelectorAll(".protyle-breadcrumb__text"));if(0===a.length)return;let s=!1;for(;this.element.scrollHeight>30&&!s;)a.find(((e,t)=>1===a.length?(e.classList.add("protyle-breadcrumb__text--ellipsis"),s=!0,!0):e.classList.contains("protyle-breadcrumb__text--ellipsis")?void(t===a.length-1&&e.classList.contains("protyle-breadcrumb__text--ellipsis")&&(s=!0)):(e.classList.add("protyle-breadcrumb__text--ellipsis"),!0)));this.element.classList.add("protyle-breadcrumb__bar--nowrap"),this.element.lastElementChild&&(this.element.scrollLeft=this.element.lastElementChild.offsetLeft-this.element.clientWidth-8)}));else{e.breadcrumb.element.querySelectorAll(".protyle-breadcrumb__item--active").forEach((e=>{e.classList.remove("protyle-breadcrumb__item--active")}));const t=e.breadcrumb.element.querySelector(`[data-node-id="${e.block.showAll?e.block.id:e.block.parentID}"]`);t&&t.classList.add("protyle-breadcrumb__item--active")}}hide(){this.element.classList.add("protyle-breadcrumb__bar--hide"),window.siyuan.hideBreadcrumb=!0}show(){this.element.classList.remove("protyle-breadcrumb__bar--hide"),window.siyuan.hideBreadcrumb=!1}}},8383:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,s){function o(e){try{r(i.next(e))}catch(e){s(e)}}function l(e){try{r(i.throw(e))}catch(e){s(e)}}function r(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,l)}r((i=i.apply(e,t||[])).next())}))},a=this&&this.__asyncValues||function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(n){t[n]=e[n]&&function(t){return new Promise((function(i,a){(function(e,t,n,i){Promise.resolve(i).then((function(t){e({value:t,done:n})}),t)})(i,a,(t=e[n](t)).done,t.value)}))}}};Object.defineProperty(t,"__esModule",{value:!0}),t.Gutter=void 0;const s=n(7821),o=n(8059),l=n(6112),r=n(6937),d=n(2964),c=n(532),u=n(1985),p=n(5967),m=n(2386),g=n(5615),b=n(6259),y=n(1456),f=n(4383),h=n(133),w=n(3903),v=n(5680),_=n(7683),E=n(3053),k=n(5449),C=n(6400),x=n(2041),L=n(1040),S=n(9229),T=n(8438),A=n(999);t.Gutter=class{constructor(e){this.element=document.createElement("div"),this.element.className="protyle-gutters",this.element.setAttribute("aria-label",window.siyuan.languages.gutterTip.replace("⌘Click",(0,c.updateHotkeyTip)("⌘Click")).replace("⌥Click",(0,c.updateHotkeyTip)("⌥Click")).replace("⇧Click",(0,c.updateHotkeyTip)("⇧Click"))),this.element.setAttribute("data-type","a"),this.element.setAttribute("data-position","right"),this.element.addEventListener("dragstart",(t=>{let n=[t.target.getAttribute("data-node-id")];const i=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");i.length>0&&(n=[],i.forEach((e=>{n.push(e.getAttribute("data-node-id"))}))),0===i.length&&t.dataTransfer.setDragImage(e.wysiwyg.element.querySelector(`[data-node-id="${n[0]}"]`),0,0),t.target.style.opacity="0.1",t.dataTransfer.effectAllowed="move",window.siyuan.dragElement=t.target,window.siyuan.dragElement.setAttribute("data-selected-ids",n.toString())})),this.element.addEventListener("dragend",(()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.removeAttribute("data-selected-ids"),window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)})),this.element.addEventListener("click",(t=>{const n=(0,s.hasClosestByTag)(t.target,"BUTTON");if(!n)return;t.preventDefault(),t.stopPropagation();const i=n.getAttribute("data-node-id");if(!i){const t=()=>{n.setAttribute("disabled","disabled");const t=e.wysiwyg.element.querySelector(`[data-node-id="${(n.previousElementSibling||n.nextElementSibling).getAttribute("data-node-id")}"]`);if(window.siyuan.altIsPressed){let i=!0;const a=t.outerHTML;Array.from(t.children).find((e=>{if(e.classList.contains("list")){if(Array.from(e.children).find((e=>{if(e.classList.contains("li")&&"1"!==e.getAttribute("fold")&&e.childElementCount>3)return i=!1,!0})))return!0}})),Array.from(t.children).forEach((e=>{e.classList.contains("list")&&Array.from(e.children).forEach((e=>{e.classList.contains("li")&&(i?e.removeAttribute("fold"):e.childElementCount>3&&e.setAttribute("fold","1"))}))})),(0,u.updateTransaction)(e,t.getAttribute("data-node-id"),t.outerHTML,a),n.removeAttribute("disabled")}else{const i=(0,l.setFold)(e,t);"1"===i?n.firstElementChild.style.transform="":"0"===i&&(n.firstElementChild.style.transform="rotate(90deg)")}};if(n.getAttribute("disabled"))return;return e.disabled?(0,x.confirmDialog)(window.siyuan.languages._kernel[34],window.siyuan.languages.foldTip,(()=>{(0,C.isMobile)()&&(document.getElementById("toolbarName").readOnly=!1,document.querySelector("#toolbarEdit use").setAttribute("xlink:href","#iconPreview")),(0,L.enableProtyle)(e),t()})):t(),(0,g.hideElements)(["select"],e),void window.siyuan.menus.menu.remove()}if(!e.disabled)if(window.siyuan.ctrlIsPressed)(0,l.zoomOut)(e,i);else if(window.siyuan.altIsPressed){const t=e.wysiwyg.element.querySelector(`[data-node-id="${i}"]`);if("NodeListItem"===n.getAttribute("data-type")){let n=!0;const i=t.parentElement.outerHTML;Array.from(t.parentElement.children).find((e=>{if(e.classList.contains("li")&&"1"!==e.getAttribute("fold")&&e.childElementCount>3)return n=!1,!0})),Array.from(t.parentElement.children).find((e=>{e.classList.contains("li")&&(n?e.removeAttribute("fold"):e.childElementCount>3&&e.setAttribute("fold","1"))})),(0,u.updateTransaction)(e,t.parentElement.getAttribute("data-node-id"),t.parentElement.outerHTML,i)}else(0,l.setFold)(e,t);t.classList.remove("protyle-wysiwyg--hl")}else window.siyuan.shiftIsPressed?(0,d.openAttr)(e.wysiwyg.element.querySelector(`[data-node-id="${i}"]`),e):(this.renderMenu(e,n),window.siyuan.menus.menu.popup({x:t.clientX-16,y:t.clientY-16},!0),e.toolbar.range||(e.toolbar.range=(0,m.getEditorRange)(e.wysiwyg.element.firstElementChild)),(0,m.focusByRange)(e.toolbar.range))})),this.element.addEventListener("contextmenu",(t=>{const n=(0,s.hasClosestByTag)(t.target,"BUTTON");n&&!e.disabled&&"fold"!==n.getAttribute("data-type")&&(window.siyuan.ctrlIsPressed||window.siyuan.altIsPressed||window.siyuan.shiftIsPressed||(this.renderMenu(e,n),window.siyuan.menus.menu.popup({x:t.clientX-16,y:t.clientY-16},!0)),t.preventDefault(),t.stopPropagation())})),this.element.addEventListener("mouseover",(t=>{const n=(0,s.hasClosestByTag)(t.target,"BUTTON");if(!n||"fold"===(null==n?void 0:n.getAttribute("data-type")))return;let i;Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${n.getAttribute("data-node-id")}"]`)).find((e=>{if(!(0,s.hasClosestByAttribute)(e.parentElement,"data-type","NodeBlockQueryEmbed"))return i=e,!0})),i&&(i.classList.add("protyle-wysiwyg--hl"),t.preventDefault())})),this.element.addEventListener("mouseout",(t=>{const n=(0,s.hasClosestByTag)(t.target,"BUTTON");if(!n||"fold"===(null==n?void 0:n.getAttribute("data-type")))return;let i;Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${n.getAttribute("data-node-id")}"]`)).find((e=>{if(!(0,s.hasClosestByAttribute)(e.parentElement,"data-type","NodeBlockQueryEmbed"))return i=e,!0})),i&&(i.classList.remove("protyle-wysiwyg--hl"),t.preventDefault(),t.stopPropagation())}))}turnsOneInto(e){return{icon:e.icon,label:e.label,accelerator:e.accelerator,click(){var t,n,s,o;return i(this,void 0,void 0,(function*(){if(e.nodeElement.querySelector("wbr")||null===(s=(0,w.getContenteditableElement)(e.nodeElement))||void 0===s||s.insertAdjacentHTML("afterbegin","<wbr>"),"CancelList"===e.type||"CancelBlockquote"===e.type)try{for(var i,l=a(e.nodeElement.querySelectorAll('[data-type="NodeHeading"][fold="1"]'));!(i=yield l.next()).done;){const t=i.value,n=t.getAttribute("data-node-id");t.removeAttribute("fold");const a=yield(0,_.fetchSyncPost)("/api/transactions",{session:e.protyle.id,app:T.Constants.SIYUAN_APPID,transactions:[{doOperations:[{action:"unfoldHeading",id:n}],undoOperations:[{action:"foldHeading",id:n}]}]});e.protyle.undo.add([{action:"unfoldHeading",id:n}],[{action:"foldHeading",id:n}]),t.insertAdjacentHTML("afterend",a.data[0].doOperations[0].retData)}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=l.return)&&(yield n.call(l))}finally{if(t)throw t.error}}const r=e.nodeElement.outerHTML,d=null===(o=e.nodeElement.previousElementSibling)||void 0===o?void 0:o.getAttribute("data-node-id"),c=e.nodeElement.parentElement.getAttribute("data-node-id")||e.protyle.block.parentID,p=e.protyle.lute[e.type](e.nodeElement.outerHTML,e.level);if(e.nodeElement.outerHTML=p,"CancelList"===e.type||"CancelBlockquote"===e.type){const t=document.createElement("template");t.innerHTML=p;const n=[{action:"delete",id:e.id}],i=[];let a=d;Array.from(t.content.children).forEach((e=>{const t=e.getAttribute("data-node-id");n.push({action:"insert",data:e.outerHTML,id:t,previousID:a,parentID:c}),i.push({action:"delete",id:t}),a=t})),i.push({action:"insert",data:r,id:e.id,previousID:d,parentID:c}),(0,u.transaction)(e.protyle,n,i)}else(0,u.updateTransaction)(e.protyle,e.id,p,r);(0,m.focusByWbr)(e.protyle.wysiwyg.element,(0,m.getEditorRange)(e.protyle.wysiwyg.element)),e.protyle.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach((e=>{""===e.textContent&&(0,_.fetchPost)("/api/block/getRefText",{id:e.getAttribute("data-id")},(t=>{e.innerHTML=t.data}))})),(0,f.blockRender)(e.protyle,e.protyle.wysiwyg.element),(0,b.processRender)(e.protyle.wysiwyg.element),(0,y.highlightRender)(e.protyle.wysiwyg.element)}))}}}turnsIntoOne(e){return{icon:e.icon,label:e.label,accelerator:e.accelerator,click(){(0,u.turnsIntoOneTransaction)(e)}}}turnsInto(e){return{icon:e.icon,label:e.label,accelerator:e.accelerator,click(){(0,u.turnsIntoTransaction)(e)}}}renderMultipleMenu(e,t){let n=!1,i=!1,a=!1;if(t.find(((e,s)=>{if(e.classList.contains("li"))return n=!0,!0;if((e.classList.contains("bq")||e.classList.contains("sb")||e.classList.contains("p"))&&(a=!0),e.nextElementSibling&&t[s+1]&&e.nextElementSibling.isSameNode(t[s+1]))i=!0;else if(s!==t.length-1)return i=!1,!0})),!n&&!window.siyuan.config.readonly){const n=[];i&&(n.push(this.turnsIntoOne({icon:"iconList",label:window.siyuan.languages.list,protyle:e,selectsElement:t,type:"Blocks2ULs"})),n.push(this.turnsIntoOne({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,selectsElement:t,type:"Blocks2OLs"})),n.push(this.turnsIntoOne({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,selectsElement:t,type:"Blocks2TLs"})),n.push(this.turnsIntoOne({icon:"iconQuote",label:window.siyuan.languages.quote,protyle:e,selectsElement:t,type:"Blocks2Blockquote"}))),a||n.push(this.turnsInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:e,selectsElement:t,type:"Blocks2Ps",isContinue:i})),n.push(this.turnsInto({icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:t,level:1,type:"Blocks2Hs",isContinue:i})),n.push(this.turnsInto({icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:t,level:2,type:"Blocks2Hs",isContinue:i})),n.push(this.turnsInto({icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:t,level:3,type:"Blocks2Hs",isContinue:i})),n.push(this.turnsInto({icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:t,level:4,type:"Blocks2Hs",isContinue:i})),n.push(this.turnsInto({icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:t,level:5,type:"Blocks2Hs",isContinue:i})),n.push(this.turnsInto({icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:t,level:6,type:"Blocks2Hs",isContinue:i})),window.siyuan.menus.menu.append(new r.MenuItem({icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:n}).element),i&&window.siyuan.menus.menu.append(new r.MenuItem({icon:"iconSuper",label:window.siyuan.languages.merge+" "+window.siyuan.languages.superBlock,type:"submenu",submenu:[this.turnsIntoOne({label:window.siyuan.languages.hLayout,accelerator:window.siyuan.config.keymap.editor.general.hLayout.custom,icon:"iconSplitLR",protyle:e,selectsElement:t,type:"BlocksMergeSuperBlock",level:"col"}),this.turnsIntoOne({label:window.siyuan.languages.vLayout,accelerator:window.siyuan.config.keymap.editor.general.vLayout.custom,icon:"iconSplitTB",protyle:e,selectsElement:t,type:"BlocksMergeSuperBlock",level:"row"})]}).element)}if(window.siyuan.menus.menu.append(new r.MenuItem({label:window.siyuan.languages.copy,icon:"iconCopy",accelerator:"⌘C",click(){if((0,w.isNotEditBlock)(t[0])){let n="";t.forEach((e=>{n+=(0,h.removeEmbed)(e)})),(0,c.writeText)(e.lute.BlockDOM2StdMd(n).trimEnd())}else(0,m.focusByRange)((0,m.getEditorRange)(t[0])),document.execCommand("copy")}}).element),window.siyuan.menus.menu.append(new r.MenuItem({label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){let e="";t.forEach((t=>{t.querySelectorAll('[contenteditable="true"]').forEach((t=>{const n=t.cloneNode(!0);n.querySelectorAll('[data-type="backslash"]').forEach((e=>{e.firstElementChild.remove()})),e+=n.textContent+"\n"}))})),(0,c.writeText)(e.trimEnd())}}).element),window.siyuan.menus.menu.append(new r.MenuItem({label:window.siyuan.languages.copy+" HTML",click(){let n="";t.forEach((e=>{n+=e.outerHTML})),(0,c.writeText)(e.lute.BlockDOM2HTML(n))}}).element),window.siyuan.config.readonly)return;window.siyuan.menus.menu.append(new r.MenuItem({label:window.siyuan.languages.cut,accelerator:"⌘X",icon:"iconCut",click:()=>{var n;if((0,w.isNotEditBlock)(t[0])){let i="";t.forEach((e=>{i+=(0,h.removeEmbed)(e)})),(0,c.writeText)(e.lute.BlockDOM2StdMd(i).trimEnd()),null===(n=e.breadcrumb)||void 0===n||n.hide(),(0,p.removeBlock)(e,t[0],(0,m.getEditorRange)(t[0]))}else(0,m.focusByRange)((0,m.getEditorRange)(t[0])),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new r.MenuItem({label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,icon:"iconMove",click:()=>{e.toolbar.showFile(e,t,(0,m.getEditorRange)(t[0]))}}).element),window.siyuan.menus.menu.append(new r.MenuItem({label:window.siyuan.languages.delete,icon:"iconTrashcan",accelerator:"⌫",click:()=>{var n;null===(n=e.breadcrumb)||void 0===n||n.hide(),(0,p.removeBlock)(e,t[0],(0,m.getEditorRange)(t[0]))}}).element),window.siyuan.menus.menu.append(new r.MenuItem({type:"separator"}).element);const s=new r.MenuItem({label:window.siyuan.languages.appearance,submenu:this.genCardStyle(t,e).concat(this.genFontStyle(t,e)).concat(this.genBGStyle(t,e))}).element;return window.siyuan.menus.menu.append(s),s.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign(t,e),this.genWidths(t,e),window.siyuan.menus.menu}renderMenu(e,t){var n,i;(0,g.hideElements)(["hint"],e),window.siyuan.menus.menu.remove();const a=t.getAttribute("data-node-id"),o=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(o.length>1){if(Array.from(o).find((e=>{if(a===e.getAttribute("data-node-id"))return!0})))return this.renderMultipleMenu(e,Array.from(o))}let b;if("BUTTON"===t.tagName?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${a}"]`)).find((e=>{if(!(0,s.hasClosestByAttribute)(e.parentElement,"data-type","NodeBlockQueryEmbed"))return b=e,!0})):b=t,!b)return;const C=b.getAttribute("data-type"),x=b.getAttribute("data-subtype"),L=[];if((0,g.hideElements)(["select"],e),b.classList.add("protyle-wysiwyg--select"),(0,S.countBlockWord)([b.getAttribute("data-node-id")]),"NodeParagraph"!==C||window.siyuan.config.readonly?"NodeHeading"!==C||window.siyuan.config.readonly?"NodeList"!==C||window.siyuan.config.readonly?"NodeBlockquote"!==C||window.siyuan.config.readonly||L.push(this.turnsOneInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,protyle:e,nodeElement:b,id:a,type:"CancelBlockquote"})):(L.push(this.turnsOneInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,protyle:e,nodeElement:b,id:a,type:"CancelList"})),"o"===b.getAttribute("data-subtype")?(L.push(this.turnsOneInto({icon:"iconList",label:window.siyuan.languages.list,protyle:e,nodeElement:b,id:a,type:"OL2UL"})),L.push(this.turnsOneInto({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,nodeElement:b,id:a,type:"UL2TL"}))):"t"===b.getAttribute("data-subtype")?(L.push(this.turnsOneInto({icon:"iconList",label:window.siyuan.languages.list,protyle:e,nodeElement:b,id:a,type:"TL2UL"})),L.push(this.turnsOneInto({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,nodeElement:b,id:a,type:"TL2OL"}))):(L.push(this.turnsOneInto({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,nodeElement:b,id:a,type:"UL2OL"})),L.push(this.turnsOneInto({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,nodeElement:b,id:a,type:"OL2TL"})))):(L.push(this.turnsInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:e,selectsElement:[b],level:6,type:"Blocks2Ps"})),"h1"!==x&&L.push(this.turnsInto({icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:[b],level:1,type:"Blocks2Hs"})),"h2"!==x&&L.push(this.turnsInto({icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:[b],level:2,type:"Blocks2Hs"})),"h3"!==x&&L.push(this.turnsInto({icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:[b],level:3,type:"Blocks2Hs"})),"h4"!==x&&L.push(this.turnsInto({icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:[b],level:4,type:"Blocks2Hs"})),"h5"!==x&&L.push(this.turnsInto({icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:[b],level:5,type:"Blocks2Hs"})),"h6"!==x&&L.push(this.turnsInto({icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:[b],level:6,type:"Blocks2Hs"}))):(L.push(this.turnsIntoOne({icon:"iconList",label:window.siyuan.languages.list,protyle:e,selectsElement:[b],type:"Blocks2ULs"})),L.push(this.turnsIntoOne({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,selectsElement:[b],type:"Blocks2OLs"})),L.push(this.turnsIntoOne({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,selectsElement:[b],type:"Blocks2TLs"})),L.push(this.turnsIntoOne({icon:"iconQuote",label:window.siyuan.languages.quote,protyle:e,selectsElement:[b],type:"Blocks2Blockquote"})),L.push(this.turnsInto({icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:[b],level:1,type:"Blocks2Hs"})),L.push(this.turnsInto({icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:[b],level:2,type:"Blocks2Hs"})),L.push(this.turnsInto({icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:[b],level:3,type:"Blocks2Hs"})),L.push(this.turnsInto({icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:[b],level:4,type:"Blocks2Hs"})),L.push(this.turnsInto({icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:[b],level:5,type:"Blocks2Hs"})),L.push(this.turnsInto({icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:[b],level:6,type:"Blocks2Hs"}))),L.length>0&&!window.siyuan.config.readonly&&window.siyuan.menus.menu.append(new r.MenuItem({icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:L}).element),window.siyuan.menus.menu.append(new r.MenuItem({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:(0,d.copySubMenu)(a,null===(n=b.querySelector(".protyle-attr--name"))||void 0===n?void 0:n.textContent,!0,b).concat([{label:window.siyuan.languages.copy,accelerator:"⌘C",click(){(0,w.isNotEditBlock)(b)?(0,c.writeText)(e.lute.BlockDOM2StdMd((0,h.removeEmbed)(b)).trimEnd()):((0,m.focusByRange)((0,m.getEditorRange)(b)),document.execCommand("copy"))}},{label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){let e="";b.querySelectorAll('[contenteditable="true"]').forEach((t=>{const n=t.cloneNode(!0);n.querySelectorAll('[data-type="backslash"]').forEach((e=>{e.firstElementChild.remove()})),e+=n.textContent+"\n"})),(0,c.writeText)(e.trimEnd())}},{label:window.siyuan.languages.copy+" HTML",click(){(0,c.writeText)(e.lute.BlockDOM2HTML(b.outerHTML))}},{label:window.siyuan.languages.duplicate,disabled:window.siyuan.config.readonly,click(){const t=b.cloneNode(!0),n=Lute.NewNodeID();t.setAttribute("data-node-id",n),t.querySelectorAll("[data-node-id]").forEach((e=>{e.setAttribute("data-node-id",Lute.NewNodeID())})),b.after(t),(0,k.scrollCenter)(e),(0,u.transaction)(e,[{action:"insert",data:b.nextElementSibling.outerHTML,id:n,previousID:a}],[{action:"delete",id:n}]),(0,m.focusBlock)(t)}}])}).element),window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new r.MenuItem({label:window.siyuan.languages.cut,accelerator:"⌘X",icon:"iconCut",click:()=>{var t;(0,w.isNotEditBlock)(b)?((0,c.writeText)(e.lute.BlockDOM2StdMd((0,h.removeEmbed)(b)).trimEnd()),(0,p.removeBlock)(e,b,(0,m.getEditorRange)(b)),null===(t=e.breadcrumb)||void 0===t||t.hide()):((0,m.focusByRange)((0,m.getEditorRange)(b)),document.execCommand("cut"))}}).element),window.siyuan.menus.menu.append(new r.MenuItem({label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,icon:"iconMove",click:()=>{e.toolbar.showFile(e,[b],(0,m.getEditorRange)(b))}}).element),window.siyuan.menus.menu.append(new r.MenuItem({label:window.siyuan.languages.delete,icon:"iconTrashcan",accelerator:"⌫",click:()=>{var t;null===(t=e.breadcrumb)||void 0===t||t.hide(),(0,p.removeBlock)(e,b,(0,m.getEditorRange)(b))}}).element)),"NodeSuperBlock"!==C||window.siyuan.config.readonly)if("NodeCodeBlock"!==C||window.siyuan.config.readonly||b.getAttribute("data-subtype"))if("NodeCodeBlock"===C&&!window.siyuan.config.readonly&&["echarts","mindmap"].includes(b.getAttribute("data-subtype"))){window.siyuan.menus.menu.append(new r.MenuItem({type:"separator"}).element);const t=b.style.height;let n=b.outerHTML;window.siyuan.menus.menu.append(new r.MenuItem({label:window.siyuan.languages.chart,icon:"iconCode",submenu:[{label:`${window.siyuan.languages.height}<span class="fn__space"></span>\n<input style="margin: 4px 0;width: 84px" type="number" step="1" min="148" class="b3-text-field" value="${t?parseInt(t):"420"}">`,bind:t=>{t.querySelector("input").addEventListener("change",(t=>{const i=(t.target.value||"420")+"px";b.style.height=i,b.firstElementChild.nextElementSibling.style.height=i,(0,u.updateTransaction)(e,a,b.outerHTML,n),n=b.outerHTML,t.stopPropagation();const s=echarts.getInstanceById(b.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));s&&s.resize()}))}},{label:window.siyuan.languages.update,icon:"iconEdit",click(){e.toolbar.showRender(e,b)}}]}).element)}else if("NodeTable"!==C||window.siyuan.config.readonly)"NodeVideo"!==C&&"NodeAudio"!==C||window.siyuan.config.readonly?"NodeIFrame"!==C||window.siyuan.config.readonly?"NodeHTMLBlock"!==C||window.siyuan.config.readonly?"NodeBlockQueryEmbed"!==C||window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new r.MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new r.MenuItem({id:"assetSubMenu",type:"submenu",icon:"iconSQL",label:window.siyuan.languages.blockEmbed,submenu:[{icon:"iconRefresh",label:`${window.siyuan.languages.refresh} SQL`,click(){b.removeAttribute("data-render"),(0,f.blockRender)(e,b)}},{icon:"iconEdit",label:`${window.siyuan.languages.update} SQL`,click(){e.toolbar.showRender(e,b)}}]}).element)):(window.siyuan.menus.menu.append(new r.MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new r.MenuItem({icon:"iconHTML5",label:"HTML",click(){e.toolbar.showRender(e,b)}}).element)):(window.siyuan.menus.menu.append(new r.MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new r.MenuItem({id:"assetSubMenu",type:"submenu",icon:"iconLanguage",label:window.siyuan.languages.assets,submenu:(0,l.iframeMenu)(e,b)}).element)):(window.siyuan.menus.menu.append(new r.MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new r.MenuItem({id:"assetSubMenu",type:"submenu",icon:"NodeVideo"===C?"iconVideo":"iconRecord",label:window.siyuan.languages.assets,submenu:(0,l.videoMenu)(e,b,C)}).element));else{let t=(0,m.getEditorRange)(b);const n=b.querySelector("table");n.contains(t.startContainer)||(t=(0,m.getEditorRange)(n.querySelector("th")));const i=(0,s.hasClosestByMatchTag)(t.startContainer,"TD")||(0,s.hasClosestByMatchTag)(t.startContainer,"TH");i&&(window.siyuan.menus.menu.append(new r.MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new r.MenuItem({type:"submenu",icon:"iconTable",label:window.siyuan.languages.table,submenu:(0,l.tableMenu)(e,b,i,t)}).element))}else{window.siyuan.menus.menu.append(new r.MenuItem({type:"separator"}).element);const e=b.getAttribute("linewrap"),t=b.getAttribute("ligatures"),n=b.getAttribute("linenumber");window.siyuan.menus.menu.append(new r.MenuItem({type:"submenu",icon:"iconCode",label:window.siyuan.languages.code,submenu:[{label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md31}</span><span class="fn__space fn__flex-1"></span>\n<input type="checkbox" class="b3-switch fn__flex-center"${"true"===e||window.siyuan.config.editor.codeLineWrap&&"false"!==e?" checked":""}></div>`,bind(e){e.addEventListener("click",(t=>{const n=e.querySelector("input");"INPUT"!==t.target.tagName&&(n.checked=!n.checked),b.setAttribute("linewrap",n.checked.toString()),b.querySelector(".hljs").removeAttribute("data-render"),(0,y.highlightRender)(b),(0,_.fetchPost)("/api/attr/setBlockAttrs",{id:a,attrs:{linewrap:n.checked.toString()}}),window.siyuan.menus.menu.remove()}))}},{label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md2}</span><span class="fn__space fn__flex-1"></span>\n<input type="checkbox" class="b3-switch fn__flex-center"${"true"===t||window.siyuan.config.editor.codeLigatures&&"false"!==t?" checked":""}></div>`,bind(e){e.addEventListener("click",(t=>{const n=e.querySelector("input");"INPUT"!==t.target.tagName&&(n.checked=!n.checked),b.setAttribute("ligatures",n.checked.toString()),b.querySelector(".hljs").removeAttribute("data-render"),(0,y.highlightRender)(b),(0,_.fetchPost)("/api/attr/setBlockAttrs",{id:a,attrs:{ligatures:n.checked.toString()}}),window.siyuan.menus.menu.remove()}))}},{label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md27}</span><span class="fn__space fn__flex-1"></span>\n<input type="checkbox" class="b3-switch fn__flex-center"${"true"===n||window.siyuan.config.editor.codeSyntaxHighlightLineNum&&"false"!==n?" checked":""}></div>`,bind(e){e.addEventListener("click",(t=>{const n=e.querySelector("input");"INPUT"!==t.target.tagName&&(n.checked=!n.checked),b.setAttribute("linenumber",n.checked.toString()),b.querySelector(".hljs").removeAttribute("data-render"),(0,y.highlightRender)(b),(0,_.fetchPost)("/api/attr/setBlockAttrs",{id:a,attrs:{linenumber:n.checked.toString()}}),window.siyuan.menus.menu.remove()}))}}]}).element)}else window.siyuan.menus.menu.append(new r.MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new r.MenuItem({label:window.siyuan.languages.cancel+" "+window.siyuan.languages.superBlock,click(){const t=(0,E.cancelSB)(e,b);(0,u.transaction)(e,t.doOperations,t.undoOperations),(0,m.focusBlock)(e.wysiwyg.element.querySelector(`[data-node-id="${t.previousId}"]`)),(0,g.hideElements)(["gutter"],e)}}).element);if(window.siyuan.menus.menu.append(new r.MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new r.MenuItem({accelerator:`${(0,c.updateHotkeyTip)(window.siyuan.config.keymap.general.enter.custom)}/${(0,c.updateHotkeyTip)("⌘Click")}`,label:window.siyuan.languages.enter,click(){(0,l.zoomOut)(e,a)}}).element),window.siyuan.menus.menu.append(new r.MenuItem({accelerator:window.siyuan.config.keymap.general.enterBack.custom,label:window.siyuan.languages.enterBack,click(){if(e.block.showAll)(0,l.zoomOut)(e,e.block.parent2ID,a);else{const t=e.path.split("/");t.length>2&&(0,A.openMobileFileById)(t[t.length-2],[T.Constants.CB_GET_FOCUS,T.Constants.CB_GET_SCROLL])}}}).element),!window.siyuan.config.readonly){window.siyuan.menus.menu.append(new r.MenuItem({icon:"iconBefore",label:window.siyuan.languages["insert-before"],accelerator:window.siyuan.config.keymap.editor.general.insertBefore.custom,click(){b.classList.remove("protyle-wysiwyg--select"),(0,S.countBlockWord)([]),(0,E.insertEmptyBlock)(e,"beforebegin",a)}}).element),window.siyuan.menus.menu.append(new r.MenuItem({icon:"iconAfter",label:window.siyuan.languages["insert-after"],accelerator:window.siyuan.config.keymap.editor.general.insertAfter.custom,click(){b.classList.remove("protyle-wysiwyg--select"),(0,S.countBlockWord)([]),(0,E.insertEmptyBlock)(e,"afterend",a)}}).element),window.siyuan.menus.menu.append(new r.MenuItem({label:window.siyuan.languages.jumpToParentNext,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,click(){b.classList.remove("protyle-wysiwyg--select"),(0,E.jumpToParentNext)(e,b)}}).element),window.siyuan.menus.menu.append(new r.MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new r.MenuItem({label:window.siyuan.languages.fold,accelerator:`${(0,c.updateHotkeyTip)(window.siyuan.config.keymap.editor.general.collapse.custom)}/${(0,c.updateHotkeyTip)("⌥Click")}`,click(){(0,l.setFold)(e,b),(0,m.focusBlock)(b)}}).element),"NodeThematicBreak"!==C&&window.siyuan.menus.menu.append(new r.MenuItem({label:window.siyuan.languages.attr,accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+(0,c.updateHotkeyTip)("⇧Click"),click(){(0,d.openAttr)(b,e)}}).element);const t=new r.MenuItem({label:window.siyuan.languages.appearance,submenu:this.genCardStyle([b],e).concat(this.genFontStyle([b],e)).concat(this.genBGStyle([b],e))}).element;window.siyuan.menus.menu.append(t),t.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign([b],e),this.genWidths([b],e)}window.siyuan.menus.menu.append(new r.MenuItem({type:"separator"}).element),["NodeThematicBreak","NodeBlockQueryEmbed","NodeIFrame","NodeHTMLBlock","NodeWidget","NodeVideo","NodeAudio"].includes(C)||""===(null===(i=(0,w.getContenteditableElement)(b))||void 0===i?void 0:i.textContent.trim())||"NodeCodeBlock"===C&&("NodeCodeBlock"!==C||b.getAttribute("data-subtype"))||(window.siyuan.menus.menu.append(new r.MenuItem({label:window.siyuan.languages.wechatReminder,icon:"iconMp",click(){(0,d.openWechatNotify)(b)}}).element),window.siyuan.menus.menu.append(new r.MenuItem({type:"separator"}).element));let M=b.getAttribute("updated")||"";return M&&(M=`${window.siyuan.languages.modifiedAt} ${v(M).format("YYYY-MM-DD HH:mm:ss")}<br>`),window.siyuan.menus.menu.append(new r.MenuItem({type:"readonly",label:`<div style="margin-left: -18px;white-space: nowrap;">${M}${window.siyuan.languages.createdAt} ${v(a.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}</div>`}).element),window.siyuan.menus.menu}genClick(e,t,n){(0,u.updateBatchTransaction)(e,t,n),(0,m.focusBlock)(e[0])}genAlign(e,t){window.siyuan.menus.menu.append(new r.MenuItem({label:window.siyuan.languages.layout,type:"submenu",submenu:[{label:window.siyuan.languages.alignLeft,icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click:()=>{this.genClick(e,t,(e=>{e.style.textAlign="left"}))}},{label:window.siyuan.languages.alignCenter,icon:"iconAlignCenter",accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{this.genClick(e,t,(e=>{e.style.textAlign="center"}))}},{label:window.siyuan.languages.alignRight,icon:"iconAlignRight",accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{this.genClick(e,t,(e=>{e.style.textAlign="right"}))}},{label:window.siyuan.languages.justify,icon:"iconMenu",click:()=>{this.genClick(e,t,(e=>{e.style.textAlign="justify"}))}}]}).element)}genBGStyle(e,t){const n=[];return["var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach(((i,a)=>{n.push({label:`<div class="fn__flex" data-type="a" aria-label="${window.siyuan.languages.colorPrimary} ${a+1}">\n    <span style="background-color:${i};" class="b3-color__square fn__flex-center">A</span>\n</div>`,click:()=>{this.genClick(e,t,(e=>{e.style.backgroundColor=i}))}})})),n.push({type:"separator"}),n.push({label:`<div class="fn__flex" data-type="a" aria-label="${window.siyuan.languages.clearFontStyle}">\n    <span class="b3-color__square fn__flex-center">A</span>\n</div>`,click:()=>{this.genClick(e,t,(e=>{e.style.textShadow="",e.style.color="",e.style.webkitBackgroundClip="",e.style.backgroundImage="",e.style.webkitTextFillColor="",e.style.webkitTextStroke="",e.style.textShadow="",e.style.backgroundColor=""}))}}),n}genWidths(e,t){const n=[];["25%","33%","50%","67%","75%"].forEach((i=>{n.push({label:i,click:()=>{this.genClick(e,t,(e=>{e.style.width=i,e.style.flex="none"}))}})})),n.push({type:"separator"});let i=100;if(1===e.length){const t=e[0].style.width;t.endsWith("%")&&(i=parseInt(t))}window.siyuan.menus.menu.append(new r.MenuItem({label:window.siyuan.languages.width,submenu:n.concat([{label:`<div aria-label="${i}%" class="b3-tooltips b3-tooltips__n fn__size200">\n    <input style="box-sizing: border-box" value="${i}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">\n</div>`,bind(n){const i=n.querySelector("input");i.addEventListener("input",(()=>{e.forEach((e=>{e.style.width=i.value+"%",e.style.flex="none"})),i.parentElement.setAttribute("aria-label",`${i.value}%`)}));const a=[],s=[];e.forEach((e=>{a.push({action:"update",id:e.getAttribute("data-node-id"),data:e.outerHTML})})),i.addEventListener("change",(()=>{e.forEach((e=>{s.push({action:"update",id:e.getAttribute("data-node-id"),data:e.outerHTML})})),(0,u.transaction)(t,s,a),window.siyuan.menus.menu.remove(),(0,m.focusBlock)(e[0])}))}},{type:"separator"},{label:window.siyuan.languages.clearFontStyle,icon:"iconTrashcan",click:()=>{this.genClick(e,t,(e=>{e.style.width&&(e.style.width="",e.style.flex="")}))}}])}).element)}genFontStyle(e,t){const n=[];return["var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach(((i,a)=>{n.push({label:`<div class="fn__flex" data-type="a" aria-label="${window.siyuan.languages.colorFont} ${a+1}">\n    <span style="color:${i};" class="b3-color__square fn__flex-center">A</span>\n</div>`,click:()=>{this.genClick(e,t,(e=>{e.style.color=i}))}})})),n.push({type:"separator"}),n}genCardStyle(e,t){const n=[];return["error","warning","info","success"].forEach((i=>{n.push({label:`<div class="fn__flex" data-type="a" aria-label="${window.siyuan.languages[i+"Style"]}">\n    <span style="color: var(--b3-card-${i}-color);background-color: var(--b3-card-${i}-background);" class="b3-color__square fn__flex-center">A</span>    \n</div>`,click:()=>{this.genClick(e,t,(e=>{e.style.color=`var(--b3-card-${i}-color)`,e.style.backgroundColor=`var(--b3-card-${i}-background)`}))}})})),n.push({type:"separator"}),n.concat([{label:`<div class="fn__flex" data-type="a" aria-label="${window.siyuan.languages.hollow}">\n    <span style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;" class="b3-color__square fn__flex-center">A</span>\n</div>`,click:()=>{this.genClick(e,t,(e=>{e.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",e.style.webkitTextFillColor="transparent"}))}},{label:`<div class="fn__flex" data-type="a" aria-label="${window.siyuan.languages.shadow}">\n    <span style="text-shadow: 1px 1px var(--b3-border-color), 2px 2px var(--b3-border-color), 3px 3px var(--b3-border-color), 4px 4px var(--b3-border-color)" class="b3-color__square fn__flex-center">A</span>\n</div>`,click:()=>{this.genClick(e,t,(e=>{e.style.textShadow="1px 1px var(--b3-border-color), 2px 2px var(--b3-border-color), 3px 3px var(--b3-border-color), 4px 4px var(--b3-border-color)"}))}},{type:"separator"}])}render(e,t){const n=t.parentElement.querySelector(".protyle-title__input");if(n&&"true"!==n.getAttribute("data-render"))return;const i=t.parentElement.parentElement.querySelector(".protyle-select");if(i&&!i.classList.contains("fn__none"))return;let a,l="",r=e,d=0,c=0,u=!1;for(;r;){const e=!u||u&&"1"===r.getAttribute("fold");if(!(0,s.hasClosestByAttribute)(r.parentElement,"data-type","NodeBlockQueryEmbed")){let t;if(e&&(t=r.getAttribute("data-type")),0===c){if(["NodeBlockquote","NodeList","NodeSuperBlock"].includes(t))return;const e=(0,w.getTopAloneElement)(r);a=e.querySelector(".li")||e.querySelector(".list"),e.isSameNode(r)||"NodeHeading"===t||(r=e,t=r.getAttribute("data-type"))}"NodeListItem"!==t||1!==c||e||(l=""),c+=1,e&&(l=`<button ${window.siyuan.config.readonly?"":'draggable="true"'} data-type="${t}"  data-subtype="${r.getAttribute("data-subtype")}" data-node-id="${r.getAttribute("data-node-id")}"><svg><use xlink:href="#${(0,o.getIconByType)(t,r.getAttribute("data-subtype"))}"></use></svg></button>`+l);let n="";if("NodeListItem"===t&&r.childElementCount>3||"NodeHeading"===t){const e=r.getAttribute("fold");n=`<button data-type="fold"><svg style="width:10px${e&&"1"===e?"":";transform:rotate(90deg)"}"><use xlink:href="#iconPlay"></use></svg></button>`}"NodeListItem"!==t&&"NodeList"!==t||(a=r,"NodeListItem"===t&&r.childElementCount>3&&(l=`<button ${window.siyuan.config.readonly?"":'draggable="true"'} data-type="${t}"  data-subtype="${r.getAttribute("data-subtype")}" data-node-id="${r.getAttribute("data-node-id")}"><svg><use xlink:href="#${(0,o.getIconByType)(t,r.getAttribute("data-subtype"))}"></use></svg></button>${n}`)),"NodeHeading"===t&&(l+=n),"NodeBlockquote"===t&&(d+=8),r.previousElementSibling&&r.previousElementSibling.getAttribute("data-node-id")&&(u=!0)}const t=(0,s.hasClosestBlock)(r.parentElement);if(!t)break;r=t}let p=!0;const m=this.element.querySelectorAll("button");if(m.length!==l.split("</button>").length-1?p=!1:m.forEach((e=>{const t=e.getAttribute("data-node-id");t&&-1===l.indexOf(t)&&(p=!1)})),p&&this.element.childElementCount>0)return void this.element.classList.remove("fn__none");this.element.innerHTML=l,this.element.classList.remove("fn__none"),this.element.style.width="";let g=e.getBoundingClientRect(),b=0;a?(g=a.firstElementChild.getBoundingClientRect(),d=0):"NodeBlockQueryEmbed"===r.getAttribute("data-type")?(g=r.getBoundingClientRect(),d=0):(g.height<Math.floor(1.625*window.siyuan.config.editor.fontSize)+8||g.height>Math.floor(1.625*window.siyuan.config.editor.fontSize)+8&&g.height<2*Math.floor(1.625*window.siyuan.config.editor.fontSize)+8)&&(b=(g.height-this.element.clientHeight)/2),this.element.style.top=`${Math.max(g.top,t.parentElement.getBoundingClientRect().top)+b}px`;let y=g.left-this.element.clientWidth-d;"NodeBlockQueryEmbed"===r.getAttribute("data-type")&&1===this.element.childElementCount&&(y=r.getBoundingClientRect().left-this.element.clientWidth-d),this.element.style.left=`${y}px`,y<this.element.parentElement.getBoundingClientRect().left?(this.element.style.width="24px",this.element.style.left=g.left-this.element.clientWidth-d/2+"px",l="",Array.from(this.element.children).reverse().forEach(((e,t)=>{0!==t&&(e.firstElementChild.style.height="14px"),l+=e.outerHTML})),this.element.innerHTML=l):this.element.querySelectorAll("svg").forEach((e=>{e.style.height=""}))}}},7394:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Background=void 0;const i=n(7821),a=n(6400),s=n(5615),o=n(562),l=n(7683),r=n(6810),d=n(4739),c=n(532),u=n(3163);t.Background=class{constructor(e){this.transparentData="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",this.element=document.createElement("div"),this.element.className="protyle-background",this.element.innerHTML=`<div class="protyle-background__img">\n    <img class="fn__none">\n    <div class="protyle-icons">\n        <span class="protyle-icon protyle-icon--first b3-tooltips b3-tooltips__sw" style="position: relative" aria-label="${window.siyuan.languages.upload}"><input type="file" style="position: absolute;width: 22px;height: 100%;top: 0;left: 0;opacity: .001;overflow: hidden;cursor: pointer;"><svg><use xlink:href="#iconUpload"></use></svg></span>\n        <span class="protyle-icon b3-tooltips b3-tooltips__sw" data-type="link" aria-label="${window.siyuan.languages.link}"><svg><use xlink:href="#iconLink"></use></svg></span>\n        <span class="protyle-icon b3-tooltips b3-tooltips__sw" data-type="random" aria-label="${window.siyuan.languages.random}"><svg><use xlink:href="#iconRefresh"></use></svg></span>\n        <span class="protyle-icon b3-tooltips b3-tooltips__sw fn__none" data-type="position" aria-label="${window.siyuan.languages.dragPosition}"><svg><use xlink:href="#iconMove"></use></svg></span>\n        <span class="protyle-icon protyle-icon--last b3-tooltips b3-tooltips__sw" data-type="remove" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>\n    </div>\n    <div class="protyle-icons fn__none"><span class="protyle-icon protyle-icon--text">${window.siyuan.languages.dragPosition}</span></div>\n    <div class="protyle-icons fn__none" style="opacity: .86;">\n        <span class="protyle-icon protyle-icon--first" data-type="cancel">${window.siyuan.languages.cancel}</span>\n        <span class="protyle-icon protyle-icon--last" data-type="confirm">${window.siyuan.languages.confirm}</span>\n    </div>\n</div>\n<div class="protyle-background__tags"></div>\n<div class="protyle-background__iconw">\n    <div class="protyle-background__icon" data-menu="true" data-type="open-emoji"></div>\n    <div class="protyle-icons fn__flex-center">\n        <span class="protyle-icon protyle-icon--first b3-tooltips b3-tooltips__s" data-menu="true" data-type="tag" aria-label="${window.siyuan.languages.addTag}"><svg><use xlink:href="#iconTags"></use></svg></span>\n        <span class="protyle-icon b3-tooltips b3-tooltips__s" data-type="icon" aria-label="${window.siyuan.languages.changeIcon}"><svg><use xlink:href="#iconEmoji"></use></svg></span>\n        <span class="protyle-icon protyle-icon--last b3-tooltips b3-tooltips__s" data-type="random" aria-label="${window.siyuan.languages.titleBg}"><svg><use xlink:href="#iconImage"></use></svg></span>\n    </div>\n</div>`,this.tagsElement=this.element.querySelector(".protyle-background__tags"),this.iconElement=this.element.querySelector(".protyle-background__icon"),this.imgElement=this.element.firstElementChild.firstElementChild,(0,a.isMobile)()?this.imgElement.addEventListener("touchstart",(e=>{if(e.preventDefault(),!this.element.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none"))return;const t=e.touches[0].clientY,n=document,i=this.imgElement.naturalHeight*this.imgElement.clientWidth/this.imgElement.naturalWidth-this.imgElement.clientHeight;let a=parseFloat(this.imgElement.style.objectPosition.substring(7))||50;this.imgElement.style.objectPosition.endsWith("px")&&(a=-parseInt(this.imgElement.style.objectPosition.substring(7))/i*100),n.ontouchmove=n=>{this.imgElement.style.objectPosition=`center ${((t-n.touches[0].clientY)/i*100+a).toFixed(2)}%`,e.preventDefault()},n.ontouchend=()=>{n.ontouchmove=null,n.ontouchstart=null,n.ondragstart=null,n.onselectstart=null,n.onselect=null}})):this.imgElement.addEventListener("mousedown",(e=>{if(e.preventDefault(),!this.element.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none"))return;const t=e.clientY,n=document,i=this.imgElement.naturalHeight*this.imgElement.clientWidth/this.imgElement.naturalWidth-this.imgElement.clientHeight;let a=parseFloat(this.imgElement.style.objectPosition.substring(7))||50;this.imgElement.style.objectPosition.endsWith("px")&&(a=-parseInt(this.imgElement.style.objectPosition.substring(7))/i*100),n.onmousemove=n=>{this.imgElement.style.objectPosition=`center ${((t-n.clientY)/i*100+a).toFixed(2)}%`,e.preventDefault()},n.onmouseup=()=>{n.onmousemove=null,n.onmouseup=null,n.ondragstart=null,n.onselectstart=null,n.onselect=null}})),this.element.querySelector("input").addEventListener("change",(t=>{0!==t.target.files.length&&(0,o.uploadFiles)(e,t.target.files,t.target,(t=>{const n=JSON.parse(t),i=`background-image:url("${n.data.succMap[Object.keys(n.data.succMap)[0]]}")`;this.ial["title-img"]=i,this.render(this.ial,e.block.rootID),(0,l.fetchPost)("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":i}})}))})),this.element.addEventListener((0,c.getEventName)(),(t=>{let n=t.target;for((0,s.hideElements)(["gutter"],e);n&&!n.isEqualNode(this.element);){const i=n.getAttribute("data-type");if("position"===i){const e=this.element.firstElementChild.querySelectorAll(".protyle-icons");e[0].classList.add("fn__none"),e[1].classList.remove("fn__none"),e[2].classList.remove("fn__none"),this.imgElement.style.cursor="move",t.preventDefault(),t.stopPropagation();break}if("cancel"===i||"confirm"===i){this.imgElement.style.cursor="";const n=this.element.firstElementChild.querySelectorAll(".protyle-icons");if(n[0].classList.remove("fn__none"),n[1].classList.add("fn__none"),n[2].classList.add("fn__none"),"confirm"===i){const t=`background-image:url("${this.imgElement.getAttribute("src")}");object-position:${this.imgElement.style.objectPosition}`;this.ial["title-img"]=t,(0,l.fetchPost)("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":t}})}else this.render(this.ial,e.block.rootID);t.preventDefault(),t.stopPropagation();break}if("open-emoji"===i){(0,r.openEmojiPanel)(e.block.rootID,this.iconElement),t.preventDefault(),t.stopPropagation();break}if("random"===i){const n=["background:radial-gradient(black 3px, transparent 4px),radial-gradient(black 3px, transparent 4px),linear-gradient(#fff 4px, transparent 0),linear-gradient(45deg, transparent 74px, transparent 75px, #a4a4a4 75px, #a4a4a4 76px, transparent 77px, transparent 109px),linear-gradient(-45deg, transparent 75px, transparent 76px, #a4a4a4 76px, #a4a4a4 77px, transparent 78px, transparent 109px),#fff;background-size: 109px 109px, 109px 109px,100% 6px, 109px 109px, 109px 109px;background-position: 54px 55px, 0px 0px, 0px 0px, 0px 0px, 0px 0px;","background: linear-gradient(45deg, #dca 12%, transparent 0, transparent 88%, #dca 0),linear-gradient(135deg, transparent 37%, #a85 0, #a85 63%, transparent 0),linear-gradient(45deg, transparent 37%, #dca 0, #dca 63%, transparent 0) #753;background-size: 25px 25px;","background: linear-gradient(315deg, transparent 75%, #d45d55 0)-10px 0, linear-gradient(45deg, transparent 75%, #d45d55 0)-10px 0, linear-gradient(135deg, #a7332b 50%, transparent 0) 0 0, linear-gradient(45deg, #6a201b 50%, #561a16 0) 0 0 #561a16;background-size: 20px 20px;","background: linear-gradient(#ffffff 50%, rgba(255,255,255,0) 0) 0 0, radial-gradient(circle closest-side, #FFFFFF 53%, rgba(255,255,255,0) 0) 0 0, radial-gradient(circle closest-side, #FFFFFF 50%, rgba(255,255,255,0) 0) 55px 0 #48B;background-size: 110px 200px;background-repeat: repeat-x;","background:radial-gradient(circle farthest-side at 0% 50%,#fb1 23.5%,rgba(240,166,17,0) 0)21px 30px, radial-gradient(circle farthest-side at 0% 50%,#B71 24%,rgba(240,166,17,0) 0)19px 30px, linear-gradient(#fb1 14%,rgba(240,166,17,0) 0, rgba(240,166,17,0) 85%,#fb1 0)0 0, linear-gradient(150deg,#fb1 24%,#B71 0,#B71 26%,rgba(240,166,17,0) 0,rgba(240,166,17,0) 74%,#B71 0,#B71 76%,#fb1 0)0 0, linear-gradient(30deg,#fb1 24%,#B71 0,#B71 26%,rgba(240,166,17,0) 0,rgba(240,166,17,0) 74%,#B71 0,#B71 76%,#fb1 0)0 0, linear-gradient(90deg,#B71 2%,#fb1 0,#fb1 98%,#B71 0%)0 0 #fb1;background-size: 40px 60px;","background-color: gray;background-image: linear-gradient(transparent 50%, rgba(255,255,255,.5) 50%);background-size: 50px 50px;","background-color: gray;background-image: linear-gradient(90deg, transparent 50%, rgba(255,255,255,.5) 50%);background-size: 50px 50px;","background-color: #026873;background-image: linear-gradient(90deg, rgba(255,255,255,.07) 50%, transparent 50%),linear-gradient(90deg, rgba(255,255,255,.13) 50%, transparent 50%),linear-gradient(90deg, transparent 50%, rgba(255,255,255,.17) 50%),linear-gradient(90deg, transparent 50%, rgba(255,255,255,.19) 50%);background-size: 13px, 29px, 37px, 53px;","background-color: gray;background-image: repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.5) 35px, rgba(255,255,255,.5) 70px);","background-color:white;background-image: linear-gradient(90deg, rgba(200,0,0,.5) 50%, transparent 50%),linear-gradient(rgba(200,0,0,.5) 50%, transparent 50%);background-size:50px 50px;","background-color:#269;background-image: linear-gradient(white 2px, transparent 2px),linear-gradient(90deg, white 2px, transparent 2px),linear-gradient(rgba(255,255,255,.3) 1px, transparent 1px),linear-gradient(90deg, rgba(255,255,255,.3) 1px, transparent 1px);background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;background-position:-2px -2px, -2px -2px, -1px -1px, -1px -1px;","background-color: #fff;background-image:linear-gradient(90deg, transparent 79px, #abced4 79px, #abced4 81px, transparent 81px),linear-gradient(#eee .1em, transparent .1em);background-size: 100% 1.2em;","background-color: hsl(34, 53%, 82%);background-image: repeating-linear-gradient(45deg, transparent 5px, hsla(197, 62%, 11%, 0.5) 5px, hsla(197, 62%, 11%, 0.5) 10px, hsla(5, 53%, 63%, 0) 10px, hsla(5, 53%, 63%, 0) 35px, hsla(5, 53%, 63%, 0.5) 35px, hsla(5, 53%, 63%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 50px, hsla(197, 62%, 11%, 0) 50px, hsla(197, 62%, 11%, 0) 60px, hsla(5, 53%, 63%, 0.5) 60px, hsla(5, 53%, 63%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 80px, hsla(35, 91%, 65%, 0) 80px, hsla(35, 91%, 65%, 0) 90px, hsla(5, 53%, 63%, 0.5) 90px, hsla(5, 53%, 63%, 0.5) 110px, hsla(5, 53%, 63%, 0) 110px, hsla(5, 53%, 63%, 0) 120px, hsla(197, 62%, 11%, 0.5) 120px, hsla(197, 62%, 11%, 0.5) 140px),repeating-linear-gradient(135deg, transparent 5px, hsla(197, 62%, 11%, 0.5) 5px, hsla(197, 62%, 11%, 0.5) 10px, hsla(5, 53%, 63%, 0) 10px, hsla(5, 53%, 63%, 0) 35px, hsla(5, 53%, 63%, 0.5) 35px, hsla(5, 53%, 63%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 50px, hsla(197, 62%, 11%, 0) 50px, hsla(197, 62%, 11%, 0) 60px, hsla(5, 53%, 63%, 0.5) 60px, hsla(5, 53%, 63%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 80px, hsla(35, 91%, 65%, 0) 80px, hsla(35, 91%, 65%, 0) 90px, hsla(5, 53%, 63%, 0.5) 90px, hsla(5, 53%, 63%, 0.5) 110px, hsla(5, 53%, 63%, 0) 110px, hsla(5, 53%, 63%, 0) 140px, hsla(197, 62%, 11%, 0.5) 140px, hsla(197, 62%, 11%, 0.5) 160px);","background-color: hsl(2, 57%, 40%);background-image: repeating-linear-gradient(transparent, transparent 50px, rgba(0,0,0,.4) 50px, rgba(0,0,0,.4) 53px, transparent 53px, transparent 63px, rgba(0,0,0,.4) 63px, rgba(0,0,0,.4) 66px, transparent 66px, transparent 116px, rgba(0,0,0,.5) 116px, rgba(0,0,0,.5) 166px, rgba(255,255,255,.2) 166px, rgba(255,255,255,.2) 169px, rgba(0,0,0,.5) 169px, rgba(0,0,0,.5) 179px, rgba(255,255,255,.2) 179px, rgba(255,255,255,.2) 182px, rgba(0,0,0,.5) 182px, rgba(0,0,0,.5) 232px, transparent 232px),repeating-linear-gradient(270deg, transparent, transparent 50px, rgba(0,0,0,.4) 50px, rgba(0,0,0,.4) 53px, transparent 53px, transparent 63px, rgba(0,0,0,.4) 63px, rgba(0,0,0,.4) 66px, transparent 66px, transparent 116px, rgba(0,0,0,.5) 116px, rgba(0,0,0,.5) 166px, rgba(255,255,255,.2) 166px, rgba(255,255,255,.2) 169px, rgba(0,0,0,.5) 169px, rgba(0,0,0,.5) 179px, rgba(255,255,255,.2) 179px, rgba(255,255,255,.2) 182px, rgba(0,0,0,.5) 182px, rgba(0,0,0,.5) 232px, transparent 232px),repeating-linear-gradient(125deg, transparent, transparent 2px, rgba(0,0,0,.2) 2px, rgba(0,0,0,.2) 3px, transparent 3px, transparent 5px, rgba(0,0,0,.2) 5px);","background-color: #eee;background-image: linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black),linear-gradient(-45deg, black 25%, transparent 25%, transparent 75%, black 75%, black);background-size: 60px 60px;","background-color: #eee;background-image: linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black),linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black);background-size: 60px 60px;background-position: 0 0, 30px 30px;","background:linear-gradient(-45deg, white 25%, transparent 25%, transparent 75%, black 75%, black) 0 0, linear-gradient(-45deg, black 25%, transparent 25%, transparent 75%, white 75%, white) 1em 1em, linear-gradient(45deg, black 17%, transparent 17%, transparent 25%, black 25%, black 36%, transparent 36%, transparent 64%, black 64%, black 75%, transparent 75%, transparent 83%, black 83%) 1em 1em;background-color: white;background-size: 2em 2em;","background-color:#001;background-image: radial-gradient(white 15%, transparent 16%),radial-gradient(white 15%, transparent 16%);background-size: 60px 60px;background-position: 0 0, 30px 30px;","background-color:#556;background-image: linear-gradient(30deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(150deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(30deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(150deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(60deg, #99a 25%, transparent 25.5%, transparent 75%, #99a 75%, #99a),linear-gradient(60deg, #99a 25%, transparent 25.5%, transparent 75%, #99a 75%, #99a);background-size:80px 140px;background-position: 0 0, 0 0, 40px 70px, 40px 70px, 0 0, 40px 70px;","background-color:silver;background-image:radial-gradient(circle at 100% 150%, silver 24%, white 24%, white 28%, silver 28%, silver 36%, white 36%, white 40%, transparent 40%, transparent),radial-gradient(circle at 0    150%, silver 24%, white 24%, white 28%, silver 28%, silver 36%, white 36%, white 40%, transparent 40%, transparent),radial-gradient(circle at 50%  100%, white 10%, silver 10%, silver 23%, white 23%, white 30%, silver 30%, silver 43%, white 43%, white 50%, silver 50%, silver 63%, white 63%, white 71%, transparent 71%, transparent),radial-gradient(circle at 100% 50%, white 5%, silver 5%, silver 15%, white 15%, white 20%, silver 20%, silver 29%, white 29%, white 34%, silver 34%, silver 44%, white 44%, white 49%, transparent 49%, transparent),radial-gradient(circle at 0    50%, white 5%, silver 5%, silver 15%, white 15%, white 20%, silver 20%, silver 29%, white 29%, white 34%, silver 34%, silver 44%, white 44%, white 49%, transparent 49%, transparent);background-size: 100px 50px;","background-color: silver;background-image: linear-gradient(335deg, #b00 23px, transparent 23px),linear-gradient(155deg, #d00 23px, transparent 23px),linear-gradient(335deg, #b00 23px, transparent 23px),linear-gradient(155deg, #d00 23px, transparent 23px);background-size: 58px 58px;background-position: 0px 2px, 4px 35px, 29px 31px, 34px 6px;","background-color:#def;background-image: radial-gradient(closest-side, transparent 98%, rgba(0,0,0,.3) 99%),radial-gradient(closest-side, transparent 98%, rgba(0,0,0,.3) 99%);background-size:80px 80px;background-position:0 0, 40px 40px;","background-image:radial-gradient(closest-side, transparent 0%, transparent 75%, #B6CC66 76%, #B6CC66 85%, #EDFFDB 86%, #EDFFDB 94%, #FFFFFF 95%, #FFFFFF 103%, #D9E6A7 104%, #D9E6A7 112%, #798B3C 113%, #798B3C 121%, #FFFFFF 122%, #FFFFFF 130%, #E0EAD7 131%, #E0EAD7 140%),radial-gradient(closest-side, transparent 0%, transparent 75%, #B6CC66 76%, #B6CC66 85%, #EDFFDB 86%, #EDFFDB 94%, #FFFFFF 95%, #FFFFFF 103%, #D9E6A7 104%, #D9E6A7 112%, #798B3C 113%, #798B3C 121%, #FFFFFF 122%, #FFFFFF 130%, #E0EAD7 131%, #E0EAD7 140%);background-size: 110px 110px;background-color: #C8D3A7;background-position: 0 0, 55px 55px;","background:linear-gradient(324deg, #232927 4%,   transparent 4%) -70px 43px, linear-gradient( 36deg, #232927 4%,   transparent 4%) 30px 43px, linear-gradient( 72deg, #e3d7bf 8.5%, transparent 8.5%) 30px 43px, linear-gradient(288deg, #e3d7bf 8.5%, transparent 8.5%) -70px 43px, linear-gradient(216deg, #e3d7bf 7.5%, transparent 7.5%) -70px 23px, linear-gradient(144deg, #e3d7bf 7.5%, transparent 7.5%) 30px 23px, linear-gradient(324deg, #232927 4%,   transparent 4%) -20px 93px, linear-gradient( 36deg, #232927 4%,   transparent 4%) 80px 93px, linear-gradient( 72deg, #e3d7bf 8.5%, transparent 8.5%) 80px 93px, linear-gradient(288deg, #e3d7bf 8.5%, transparent 8.5%) -20px 93px, linear-gradient(216deg, #e3d7bf 7.5%, transparent 7.5%) -20px 73px, linear-gradient(144deg, #e3d7bf 7.5%, transparent 7.5%) 80px 73px;background-color: #232927;background-size: 100px 100px;","background:radial-gradient(circle at 50% 59%, #D2CAAB 3%, #364E27 4%, #364E27 11%, rgba(54,78,39,0) 12%, rgba(54,78,39,0)) 50px 0, radial-gradient(circle at 50% 41%, #364E27 3%, #D2CAAB 4%, #D2CAAB 11%, rgba(210,202,171,0) 12%, rgba(210,202,171,0)) 50px 0, radial-gradient(circle at 50% 59%, #D2CAAB 3%, #364E27 4%, #364E27 11%, rgba(54,78,39,0) 12%, rgba(54,78,39,0)) 0 50px, radial-gradient(circle at 50% 41%, #364E27 3%, #D2CAAB 4%, #D2CAAB 11%, rgba(210,202,171,0) 12%, rgba(210,202,171,0)) 0 50px, radial-gradient(circle at 100% 50%, #D2CAAB 16%, rgba(210,202,171,0) 17%),radial-gradient(circle at 0% 50%, #364E27 16%, rgba(54,78,39,0) 17%),radial-gradient(circle at 100% 50%, #D2CAAB 16%, rgba(210,202,171,0) 17%) 50px 50px, radial-gradient(circle at 0% 50%, #364E27 16%, rgba(54,78,39,0) 17%) 50px 50px;background-color:#63773F;background-size:100px 100px;","background:radial-gradient(circle, transparent 20%, slategray 20%, slategray 80%, transparent 80%, transparent),radial-gradient(circle, transparent 20%, slategray 20%, slategray 80%, transparent 80%, transparent) 50px 50px, linear-gradient(#A8B1BB 8px, transparent 8px) 0 -4px, linear-gradient(90deg, #A8B1BB 8px, transparent 8px) -4px 0;background-color: slategray;background-size:100px 100px, 100px 100px, 50px 50px, 50px 50px;","background:radial-gradient(circle at 100% 50%, transparent 20%, rgba(255,255,255,.3) 21%, rgba(255,255,255,.3) 34%, transparent 35%, transparent),radial-gradient(circle at 0% 50%, transparent 20%, rgba(255,255,255,.3) 21%, rgba(255,255,255,.3) 34%, transparent 35%, transparent) 0 -50px;background-color: slategray;background-size:75px 100px;","background-color: #FF7D9D;background-size: 58px 58px;background-position: 0px 2px, 4px 35px, 29px 31px, 33px 6px, 0px 36px, 4px 2px, 29px 6px, 33px 30px;background-image:linear-gradient(335deg, #C90032 23px, transparent 23px),linear-gradient(155deg, #C90032 23px, transparent 23px),linear-gradient(335deg, #C90032 23px, transparent 23px),linear-gradient(155deg, #C90032 23px, transparent 23px),linear-gradient(335deg, #C90032 10px, transparent 10px),linear-gradient(155deg, #C90032 10px, transparent 10px),linear-gradient(335deg, #C90032 10px, transparent 10px),linear-gradient(155deg, #C90032 10px, transparent 10px);","background-color: #6d695c;background-image:repeating-linear-gradient(120deg, rgba(255,255,255,.1), rgba(255,255,255,.1) 1px, transparent 1px, transparent 60px),repeating-linear-gradient(60deg, rgba(255,255,255,.1), rgba(255,255,255,.1) 1px, transparent 1px, transparent 60px),linear-gradient(60deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1)),linear-gradient(120deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1));background-size: 70px 120px;","background:radial-gradient(circle closest-side at 60% 43%, #b03 26%, rgba(187,0,51,0) 27%),radial-gradient(circle closest-side at 40% 43%, #b03 26%, rgba(187,0,51,0) 27%),radial-gradient(circle closest-side at 40% 22%, #d35 45%, rgba(221,51,85,0) 46%),radial-gradient(circle closest-side at 60% 22%, #d35 45%, rgba(221,51,85,0) 46%),radial-gradient(circle closest-side at 50% 35%, #d35 30%, rgba(221,51,85,0) 31%),radial-gradient(circle closest-side at 60% 43%, #b03 26%, rgba(187,0,51,0) 27%) 50px 50px, radial-gradient(circle closest-side at 40% 43%, #b03 26%, rgba(187,0,51,0) 27%) 50px 50px, radial-gradient(circle closest-side at 40% 22%, #d35 45%, rgba(221,51,85,0) 46%) 50px 50px, radial-gradient(circle closest-side at 60% 22%, #d35 45%, rgba(221,51,85,0) 46%) 50px 50px, radial-gradient(circle closest-side at 50% 35%, #d35 30%, rgba(221,51,85,0) 31%) 50px 50px;background-color:#b03;background-size:100px 100px;","background:radial-gradient(black 15%, transparent 16%) 0 0, radial-gradient(black 15%, transparent 16%) 8px 8px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 0 1px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 8px 9px;background-color:#282828;background-size:16px 16px;","background:linear-gradient(27deg, #151515 5px, transparent 5px) 0 5px, linear-gradient(207deg, #151515 5px, transparent 5px) 10px 0px, linear-gradient(27deg, #222 5px, transparent 5px) 0px 10px, linear-gradient(207deg, #222 5px, transparent 5px) 10px 5px, linear-gradient(90deg, #1b1b1b 10px, transparent 10px),linear-gradient(#1d1d1d 25%, #1a1a1a 25%, #1a1a1a 50%, transparent 50%, transparent 75%, #242424 75%, #242424);background-color: #131313;background-size: 20px 20px;","background:radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.15) 30%, rgba(255,255,255,.3) 32%, rgba(255,255,255,0) 33%) 0 0, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.1) 11%, rgba(255,255,255,.3) 13%, rgba(255,255,255,0) 14%) 0 0, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 17%, rgba(255,255,255,.43) 19%, rgba(255,255,255,0) 20%) 0 110px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 11%, rgba(255,255,255,.4) 13%, rgba(255,255,255,0) 14%) -130px -170px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 11%, rgba(255,255,255,.4) 13%, rgba(255,255,255,0) 14%) 130px 370px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.1) 11%, rgba(255,255,255,.2) 13%, rgba(255,255,255,0) 14%) 0 0, linear-gradient(45deg, #343702 0%, #184500 20%, #187546 30%, #006782 40%, #0b1284 50%, #760ea1 60%, #83096e 70%, #840b2a 80%, #b13e12 90%, #e27412 100%);background-size: 470px 470px, 970px 970px, 410px 410px, 610px 610px, 530px 530px, 730px 730px, 100% 100%;background-color: #840b2a;","background-color:white;background-image:radial-gradient(midnightblue 9px, transparent 10px),repeating-radial-gradient(midnightblue 0, midnightblue 4px, transparent 5px, transparent 20px, midnightblue 21px, midnightblue 25px, transparent 26px, transparent 50px);background-size: 30px 30px, 90px 90px;background-position: 0 0;","background-color:black;background-image:radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 40px),radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 30px),radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 40px),radial-gradient(rgba(255,255,255,.4), rgba(255,255,255,.1) 2px, transparent 30px);background-size: 550px 550px, 350px 350px, 250px 250px, 150px 150px;background-position: 0 0, 40px 60px, 130px 270px, 70px 100px;","background:radial-gradient(hsl(0, 100%, 27%) 4%, hsl(0, 100%, 18%) 9%, hsla(0, 100%, 20%, 0) 9%) 0 0, radial-gradient(hsl(0, 100%, 27%) 4%, hsl(0, 100%, 18%) 8%, hsla(0, 100%, 20%, 0) 10%) 50px 50px, radial-gradient(hsla(0, 100%, 30%, 0.8) 20%, hsla(0, 100%, 20%, 0)) 50px 0, radial-gradient(hsla(0, 100%, 30%, 0.8) 20%, hsla(0, 100%, 20%, 0)) 0 50px, radial-gradient(hsla(0, 100%, 20%, 1) 35%, hsla(0, 100%, 20%, 0) 60%) 50px 0, radial-gradient(hsla(0, 100%, 20%, 1) 35%, hsla(0, 100%, 20%, 0) 60%) 100px 50px, radial-gradient(hsla(0, 100%, 15%, 0.7), hsla(0, 100%, 20%, 0)) 0 0, radial-gradient(hsla(0, 100%, 15%, 0.7), hsla(0, 100%, 20%, 0)) 50px 50px, linear-gradient(45deg, hsla(0, 100%, 20%, 0) 49%, hsla(0, 100%, 0%, 1) 50%, hsla(0, 100%, 20%, 0) 70%) 0 0, linear-gradient(-45deg, hsla(0, 100%, 20%, 0) 49%, hsla(0, 100%, 0%, 1) 50%, hsla(0, 100%, 20%, 0) 70%) 0 0;background-color: #300;background-size: 100px 100px;","background:linear-gradient(135deg, #708090 21px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px),linear-gradient(225deg, #708090 21px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px)0 64px;background-color:#708090;background-size: 64px 128px;","background:linear-gradient(135deg, #ECEDDC 25%, transparent 25%) -50px 0, linear-gradient(225deg, #ECEDDC 25%, transparent 25%) -50px 0, linear-gradient(315deg, #ECEDDC 25%, transparent 25%),linear-gradient(45deg, #ECEDDC 25%, transparent 25%);background-size: 100px 100px;background-color: #EC173A;","background:linear-gradient(45deg, #92baac 45px, transparent 45px)64px 64px, linear-gradient(45deg, #92baac 45px, transparent 45px,transparent 91px, #e1ebbd 91px, #e1ebbd 135px, transparent 135px),linear-gradient(-45deg, #92baac 23px, transparent 23px, transparent 68px,#92baac 68px,#92baac 113px,transparent 113px,transparent 158px,#92baac 158px);background-color:#e1ebbd;background-size: 128px 128px;","background:linear-gradient(63deg, #999 23%, transparent 23%) 7px 0,linear-gradient(63deg, transparent 74%, #999 78%),linear-gradient(63deg, transparent 34%, #999 38%, #999 58%, transparent 62%),#444;background-size: 16px 48px;","background:#36c;background:linear-gradient(115deg, transparent 75%, rgba(255,255,255,.8) 75%) 0 0,linear-gradient(245deg, transparent 75%, rgba(255,255,255,.8) 75%) 0 0,linear-gradient(115deg, transparent 75%, rgba(255,255,255,.8) 75%) 7px -15px,linear-gradient(245deg, transparent 75%, rgba(255,255,255,.8) 75%) 7px -15px,#36c;background-size: 15px 30px;","background:radial-gradient(circle at 0% 50%, rgba(96, 16, 48, 0) 9px, #613 10px, rgba(96, 16, 48, 0) 11px) 0px 10px,radial-gradient(at 100% 100%,rgba(96, 16, 48, 0) 9px, #613 10px, rgba(96, 16, 48, 0) 11px),#8a3;background-size: 20px 20px;","background-image:linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%)","background-image:linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%)","background-image:linear-gradient(120deg, #a6c0fe 0%, #f68084 100%)","background-image:linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%)","background-image:linear-gradient(to right, #fa709a 0%, #fee140 100%)","background-image:linear-gradient(to top, #30cfd0 0%, #330867 100%)","background-image:linear-gradient(to top, #a8edea 0%, #fed6e3 100%)","background-image:linear-gradient(to top, #d299c2 0%, #fef9d7 100%)","background-image:linear-gradient(to top, #fddb92 0%, #d1fdff 100%)","background-image:linear-gradient(to top, #9890e3 0%, #b1f4cf 100%)","background-image:linear-gradient(to top, #96fbc4 0%, #f9f586 100%)","background-image:linear-gradient(to right, #eea2a2 0%, #bbc1bf 19%, #57c6e1 42%, #b49fda 79%, #7ac5d8 100%)","background-image:linear-gradient(to top, #9795f0 0%, #fbc8d4 100%)","background-image:linear-gradient(to top, #3f51b1 0%, #5a55ae 13%, #7b5fac 25%, #8f6aae 38%, #a86aa4 50%, #cc6b8e 62%, #f18271 75%, #f3a469 87%, #f7c978 100%)","background-image:linear-gradient(to top, #f43b47 0%, #453a94 100%)","background-image:linear-gradient(to top, #88d3ce 0%, #6e45e2 100%)","background-image:linear-gradient(to top, #d9afd9 0%, #97d9e1 100%)","background-image:linear-gradient(-20deg, #b721ff 0%, #21d4fd 100%)","background-image:linear-gradient(60deg, #abecd6 0%, #fbed96 100%)","background-image:linear-gradient(to top, #3b41c5 0%, #a981bb 49%, #ffc8a9 100%)","background-image:linear-gradient(to top, #0fd850 0%, #f9f047 100%)","background-image:linear-gradient(to top, #d5dee7 0%, #ffafbd 0%, #c9ffbf 100%)","background-image:linear-gradient(to top, #65bd60 0%, #5ac1a8 25%, #3ec6ed 50%, #b7ddb7 75%, #fef381 100%)","background-image:linear-gradient(to top, #50cc7f 0%, #f5d100 100%)","background-image:linear-gradient(to top, #df89b5 0%, #bfd9fe 100%)","background-image:linear-gradient(to top, #e14fad 0%, #f9d423 100%)","background-image:linear-gradient(to right, #ec77ab 0%, #7873f5 100%)","background-image:linear-gradient(-225deg, #2CD8D5 0%, #C5C1FF 56%, #FFBAC3 100%)","background-image:linear-gradient(-225deg, #5271C4 0%, #B19FFF 48%, #ECA1FE 100%)","background-image:linear-gradient(-225deg, #FF3CAC 0%, #562B7C 52%, #2B86C5 100%)","background-image:linear-gradient(-225deg, #69EACB 0%, #EACCF8 48%, #6654F1 100%)","background-image:linear-gradient(-225deg, #231557 0%, #44107A 29%, #FF1361 67%, #FFF800 100%)"],i=n[(0,a.getRandom)(0,n.length-1)];this.ial["title-img"]=i,this.render(this.ial,e.block.rootID),(0,l.fetchPost)("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),t.preventDefault(),t.stopPropagation();break}if("remove"===i){delete this.ial["title-img"],this.render(this.ial,e.block.rootID),(0,l.fetchPost)("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":""}}),t.preventDefault(),t.stopPropagation();break}if("icon"===i){const n=(0,r.getRandomEmoji)();n&&(this.ial.icon=n,this.render(this.ial,e.block.rootID),(0,r.updateFileTreeEmoji)(n,e.block.rootID),(0,r.updateOutlineEmoji)(n),(0,l.fetchPost)("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{icon:n}}),e.model&&e.model.parent.setDocIcon(n)),t.preventDefault(),t.stopPropagation();break}if("tag"===i){this.openTag(e),t.preventDefault(),t.stopPropagation();break}if("link"===i){const n=new u.Dialog({title:window.siyuan.languages.link,width:(0,a.isMobile)()?"80vw":"520px",content:`<div class="b3-dialog__content">\n        <input class="b3-text-field fn__block">\n</div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>\n</div>`}),i=n.element.querySelectorAll(".b3-button");i[0].addEventListener("click",(()=>{n.destroy()})),i[1].addEventListener("click",(()=>{const t=`background-image:url(${n.element.querySelector("input").value});`;this.ial["title-img"]=t,this.render(this.ial,e.block.rootID),(0,l.fetchPost)("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),n.destroy()})),n.element.querySelector("input").focus(),t.preventDefault(),t.stopPropagation();break}if("open-search"===i){t.preventDefault(),t.stopPropagation();break}if("remove-tag"===i){n.parentElement.remove();const i=this.getTags();(0,l.fetchPost)("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{tags:i.toString()}}),0===i.length?delete this.ial.tags:this.ial.tags=i.toString(),this.render(this.ial,e.block.rootID),t.preventDefault(),t.stopPropagation();break}n=n.parentElement}}))}render(e,t){var n;const i=e["title-img"],a=e.icon,s=e.tags;if(this.ial=e,this.element.setAttribute("data-node-id",t),s){let e="";s.split(",").forEach(((t,n)=>{e+=`<div class="item item--${n%4}" data-type="open-search">${t}<svg data-type="remove-tag"><use xlink:href="#iconClose"></use></svg></div>`})),this.tagsElement.innerHTML=e}else this.tagsElement.innerHTML="";if(a?(this.iconElement.classList.remove("fn__none"),this.iconElement.innerHTML=(0,r.unicode2Emoji)(a)):this.iconElement.classList.add("fn__none"),i)if(this.imgElement.classList.remove("fn__none"),this.imgElement.setAttribute("style",Lute.UnEscapeHTMLStr(i)),i.indexOf("url(")>-1){const e=this.imgElement.style.backgroundPosition||this.imgElement.style.objectPosition,t=null===(n=this.imgElement.style.backgroundImage)||void 0===n?void 0:n.replace(/^url\(["']?/,"").replace(/["']?\)$/,"");this.imgElement.removeAttribute("style"),this.imgElement.setAttribute("src",t),this.imgElement.style.objectPosition=e,this.element.querySelector('[data-type="position"]').classList.remove("fn__none")}else this.imgElement.setAttribute("src",this.transparentData),this.element.querySelector('[data-type="position"]').classList.add("fn__none");else this.imgElement.classList.add("fn__none");this.element.style.minHeight=i?"30vh":a?this.tagsElement.clientHeight+56+"px":s?this.tagsElement.clientHeight+"px":"0"}openTag(e){(0,l.fetchPost)("/api/search/searchTag",{k:""},(t=>{let n="";t.data.tags.forEach(((e,t)=>{n+=`<div class="b3-list-item${0===t?" b3-list-item--focus":""}">${e}</div>`})),window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.innerHTML=`<div class="fn__flex-column" style="max-height:50vh"><input style="margin: 4px 8px 8px 8px" class="b3-text-field"/>\n<div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${n}</div>\n</div>`;const a=window.siyuan.menus.menu.element.querySelector(".b3-list--background"),s=window.siyuan.menus.menu.element.querySelector("input");s.addEventListener("keydown",(t=>{if(t.stopPropagation(),!t.isComposing)if((0,d.upDownHint)(a,t),"Enter"===t.key){const t=a.querySelector(".b3-list-item--focus");t?this.addTags(t.textContent,e):this.addTags(s.value,e),window.siyuan.menus.menu.remove()}else"Escape"===t.key&&window.siyuan.menus.menu.remove()})),s.addEventListener("input",(e=>{e.stopPropagation(),(0,l.fetchPost)("/api/search/searchTag",{k:s.value},(e=>{let t="",n=!1;e.data.tags.forEach((i=>{t+=`<div class="b3-list-item">${i}</div>`,i===`<mark>${e.data.k}</mark>`&&(n=!0)})),!n&&e.data.k&&(t=`<div class="b3-list-item"><mark>${e.data.k}</mark></div>`+t),a.innerHTML=t,a.firstElementChild.classList.add("b3-list-item--focus")}))})),a.addEventListener("click",(t=>{const n=t.target,a=(0,i.hasClosestByClassName)(n,"b3-list-item");a&&this.addTags(a.textContent,e)}));const o=this.iconElement.nextElementSibling.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.left,y:o.top+o.height}),s.focus()}))}getTags(){const e=[];return this.tagsElement.querySelectorAll(".item").forEach((t=>{e.push(t.textContent.trim())})),e}addTags(e,t){window.siyuan.menus.menu.remove();const n=this.getTags();n.includes(e)||(n.push(e),(0,l.fetchPost)("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{tags:n.toString()}}),this.ial.tags=n.toString(),this.render(this.ial,t.block.rootID))}}},4659:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hintMoveBlock=t.hintRenderAssets=t.hintRenderWidget=t.hintRenderTemplate=t.hintEmbed=t.hintRef=t.hintTag=t.hintSlash=void 0;const i=n(7683),a=n(8469),s=n(8059),o=n(532),l=n(4383),r=n(8438),d=n(6259),c=n(1456),u=n(2386),p=n(7821),m=n(3903),g=n(3029),b=n(1985),y=n(9883),f=n(3053),h=n(9407),w=n(9755),v=n(6112);t.hintSlash=(e,t)=>{const n=[{filter:["模版","moban","mb","template"],value:r.Constants.ZWSP,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic ft__error"><use xlink:href="#iconMarkdown"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.template}</span></div>`},{filter:["资源","assets","zy","ziyuan"],value:r.Constants.ZWSP+2,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.assets}</span></div>`},{filter:["引用块","yinyong","yy","block reference"],value:"((",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconGraph"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.blockRef}</span><span class="b3-list-item__meta">((</span></div>`},{filter:["嵌入块","qianrukuai","qrk","embed block"],value:"{{",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSQL"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.blockEmbed}</span><span class="b3-list-item__meta">{{</span></div>`},{filter:["文档","子文档","wendang","wd","ziwendang","zwd","xjwd"],value:r.Constants.ZWSP+4,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newFile}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.general.newFile.custom)}</span></div>`},{value:"",html:"separator"},{filter:["yijibiaoti","一级标题","yjbt","h1","heading"],value:"# "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH1"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading1}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.editor.heading.heading1.custom)}</span></div>`},{filter:["erjibiaoti","二级标题","ejbt","h2","heading"],value:"## "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH2"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading2}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.editor.heading.heading2.custom)}</span></div>`},{filter:["sanjibiaoti","三级标题","sjbt","h3","heading"],value:"### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH3"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading3}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.editor.heading.heading3.custom)}</span></div>`},{filter:["sijibiaoti","四级标题","sjbt","h4","heading"],value:"#### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH4"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading4}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.editor.heading.heading4.custom)}</span></div>`},{filter:["wujibiaoti","五级标题","wjbt","h5","heading"],value:"##### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH5"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading5}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.editor.heading.heading5.custom)}</span></div>`},{filter:["liujibiaoti","六级标题","ljbt","h6","heading"],value:"###### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH6"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading6}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.editor.heading.heading6.custom)}</span></div>`},{filter:["无序列表","wuxuliebiao","wxlb","unordered list"],value:"* "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.list}</span><span class="b3-menu__accelerator">*&nbsp;</span></div>`},{filter:["有序列表","youxuliebiao","yxlb","ordered list"],value:"1. "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconOrderedList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["ordered-list"]}</span><span class="b3-menu__accelerator">1.&nbsp;</span></div>`},{filter:["任务列表","renwuliebiao","rwlb","task list","todo list"],value:"* [ ] "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCheck"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.check}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.editor.insert.check.custom)}</span></div>`},{filter:["引述","yinshu","ys","bq","blockquote"],value:"> "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconQuote"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.quote}</span><span class="b3-menu__accelerator">&gt;</span></div>`},{filter:["代码块","daimakuai","dmk","code block"],value:"```",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.code}</span><span class="b3-menu__accelerator">\`\`\`Enter</span></div>`},{filter:["表格","biaoge","bg","table"],value:`| col1${Lute.Caret} | col2 | col3 |\n| --- | --- | --- |\n|  |  |  |\n|  |  |  |`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.table}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.editor.insert.table.custom)}</span></div>`},{filter:["分割线","fengexian","fgx","divider"],value:"---",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLine"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.line}</span><span class="b3-menu__accelerator">---</span></div>`},{filter:["数学公式块","shuxuegongshikuai","sxgsk","math block"],value:"$$",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.math}</span><span class="b3-list-item__meta">$$</span></div>`},{filter:["html"],value:"<div>",html:'<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconHTML5"></use></svg><span class="b3-list-item__text">HTML</span></div>'},{value:"",html:"separator"},{filter:["表情","biaoqing","bq","emoji"],value:"emoji",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconEmoji"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.emoji}</span><span class="b3-menu__accelerator">:</span></div>`},{filter:["链接","lianjie","lj","link","a"],value:"a",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLink"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.link}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.editor.insert.link.custom)}</span></div>`},{filter:["粗体","cuti","ct","bold","strong"],value:"strong",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBold"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.bold}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.editor.insert.bold.custom)}</span></div>`},{filter:["斜体","xieti","xt","italic","em"],value:"em",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconItalic"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.italic}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.editor.insert.italic.custom)}</span></div>`},{filter:["下划线","xiahuaxian","xhx","underline"],value:"u",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconUnderline"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.underline}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.editor.insert.underline.custom)}</span></div>`},{filter:["删除线","shanchuxian","scx","strike"],value:"s",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconStrike"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.strike}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.editor.insert.strike.custom)}</span></div>`},{filter:["标记","biaoji","bj","mark"],value:"mark",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMark"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.mark}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.editor.insert.mark.custom)}</span></div>`},{filter:["上标","shangbiao","sb","superscript"],value:"sup",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSup"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sup}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.editor.insert.sup.custom)}</span></div>`},{filter:["下标","xiaobiao","xb","subscript"],value:"sub",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSub"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sub}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.editor.insert.sub.custom)}</span></div>`},{filter:["标签","biaoqian","bq","tag"],value:"tag",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.tag}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.editor.insert.tag.custom)}</span></div>`},{filter:["行内代码","hangneidaima","hndm","inline code"],value:"code",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconInlineCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-code"]}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.editor.insert["inline-code"].custom)}</span></div>`},{filter:["行内数学公式","hangneishuxuegongshi","hnsxgs","inline math"],value:"inline-math",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-math"]}</span><span class="b3-menu__accelerator">${(0,o.updateHotkeyTip)(window.siyuan.config.keymap.editor.insert["inline-math"].custom)}</span></div>`},{value:"",html:"separator"},{filter:["插入图片或文件","upload","上传","crtphwj","sc"],value:r.Constants.ZWSP+3,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDownload"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAsset}</span>\n<input class="b3-form__upload" type="file" ${t.options.upload.accept?'multiple="'+t.options.upload.accept+'"':""}></div>`},{filter:["iframe","嵌入网址","qianruwangzhan","qrwz"],value:'<iframe src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLanguage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertIframeURL}</span></div>`},{filter:["输入图片链接","input image url","shurutupianlianjie","srtptp"],value:"![]()",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertImgURL}</span></div>`},{filter:["输入视频链接","shurushipinlianjie","srsplj","input video url"],value:'<video controls="controls" src=""></video>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconVideo"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertVideoURL}</span></div>`},{filter:["输入音频链接","shuruyinpinlianjie","sryplj","input audio url"],value:'<audio controls="controls" src=""></audio>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRecord"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAudioURL}</span></div>`},{value:"",html:"separator"},{filter:["五线谱","wuxianpu","wxp","staff"],value:"```abc\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">ABC</span><span class="b3-list-item__meta">${window.siyuan.languages.staff}</span></div>`},{filter:["图表","tubiao","tb","chart"],value:"```echarts\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Chart</span><span class="b3-list-item__meta">${window.siyuan.languages.chart}</span></div>`},{filter:["流程图","liuchengtu","lct","flow chart"],value:"```flowchart\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">FlowChart</span><span class="b3-list-item__meta">Flow Chart</span></div>'},{filter:["状态图","zhuangtaitu","ztt","graph viz"],value:"```graphviz\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Graphviz</span><span class="b3-list-item__meta">Graph</span></div>'},{filter:["流程图","时序图","甘特图","liuchengtu","shixutu","gantetu","lct","sxt","gtt","mermaid"],value:"```mermaid\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Mermaid</span><span class="b3-list-item__meta">Mermaid</span></div>'},{filter:["脑图","naotu","nt","mind map"],value:"```mindmap\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Mind map</span><span class="b3-list-item__meta">${window.siyuan.languages.mindmap}</span></div>`},{filter:["统一建模语言","tongyijianmoyuyan","tyjmyy","plant uml"],value:"```plantuml\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">PlantUML</span><span class="b3-list-item__meta">UML</span></div>'},{value:"",html:"separator"},{filter:["信息样式","xinxiyangshi","xxys","info style"],value:`style${r.Constants.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="b3-color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.infoStyle}</span></div>`},{filter:["成功样式","chenggongyangshi","cgys","success style"],value:`style${r.Constants.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="b3-color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.successStyle}</span></div>`},{filter:["警告样式","jinggaoyangshi","jgys","warning style"],value:`style${r.Constants.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="b3-color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.warningStyle}</span></div>`},{filter:["错误样式","cuowuyangshi","cwys","error style"],value:`style${r.Constants.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="b3-color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.errorStyle}</span></div>`},{filter:["移除样式","yichuyangshi","ycys","remove style"],value:`style${r.Constants.ZWSP}`,html:`<div class="b3-list-item__first"><div class="b3-color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.clearFontStyle}</span></div>`}];return n.splice(1,0,{filter:["挂件","widget","gj","guajian"],value:r.Constants.ZWSP+1,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBoth"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.widget}</span></div>`}),""===e?n:n.filter((t=>{if(!t.filter)return!1;return!!t.filter.find((t=>{if(t.indexOf(e.toLowerCase())>-1)return!0}))}))};t.hintTag=(e,t)=>(t.hint.genLoading(t),(0,i.fetchPost)("/api/search/searchTag",{k:e},(e=>{const n=[];let i=!1;e.data.tags.forEach((t=>{const a=t.replace(/<mark>/g,"").replace(/<\/mark>/g,"");n.push({value:`#${a}#`,html:t}),a===e.data.k&&(i=!0)})),e.data.k&&!i&&n.splice(0,0,{value:`#${e.data.k}#`,html:`<mark>${(0,w.escapeHtml)(e.data.k)}</mark>`}),t.hint.genHTML(n,t,!0)})),[]);t.hintRef=(e,t,n=!1)=>{const a=(0,p.hasClosestBlock)((0,u.getEditorRange)(t.wysiwyg.element).startContainer);return t.hint.genLoading(t),(0,i.fetchPost)("/api/search/searchRefBlock",{k:e,id:a?a.getAttribute("data-node-id"):t.block.parentID,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),rootID:t.block.rootID},(i=>{const a=[];if(i.data.newDoc){const e=Lute.UnEscapeHTMLStr((0,g.replaceFileName)(i.data.k));a.push({value:n?`((newFile "${e}"${r.Constants.ZWSP}'${e}${Lute.Caret}'))`:`((newFile '${e}${Lute.Caret}'))`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>\n<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${i.data.k}</mark></span></div>`})}i.data.blocks.forEach((t=>{const i=(0,s.getIconByType)(t.type);let o="";t.name&&(o+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg>${t.name}</span><span class="fn__space"></span>`),t.alias&&(o+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg>${t.alias}</span><span class="fn__space"></span>`),t.memo&&(o+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg>${t.memo}</span>`),o&&(o=`<div class="fn__flex b3-list-item__meta b3-list-item__showall">${o}</div>`);let l=`<span data-type="block-ref" data-id="${t.id}" data-subtype="d">${t.name||t.refText}</span>`;n&&(l=`<span data-type="block-ref" data-id="${t.id}" data-subtype="s">${e}</span>`),a.push({value:l,html:`${o}<div class="b3-list-item__first">\n    <svg class="b3-list-item__graphic popover__block" data-id="${t.id}"><use xlink:href="#${i}"></use></svg>\n    <span class="b3-list-item__text">${t.content}</span>\n</div>\n<div class="b3-list-item__meta b3-list-item__showall" style="margin-bottom: 4px">${t.hPath}</div>`})})),n&&(t.hint.splitChar="((",t.hint.lastIndex=-1),0===a.length&&a.push({value:"",html:window.siyuan.languages.emptyContent}),t.hint.genHTML(a,t,!0,n)})),[]};t.hintEmbed=(e,t)=>{if(e.endsWith("}}")||e.endsWith("」」"))return[];t.hint.genLoading(t);const n=(0,p.hasClosestBlock)((0,u.getEditorRange)(t.wysiwyg.element).startContainer);return(0,i.fetchPost)("/api/search/searchRefBlock",{k:e,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),id:n?n.getAttribute("data-node-id"):t.block.parentID,rootID:t.block.rootID},(e=>{const n=[];e.data.blocks.forEach((e=>{const t=(0,s.getIconByType)(e.type);let i="";e.name&&(i+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg>${e.name}</span><span class="fn__space"></span>`),e.alias&&(i+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg>${e.alias}</span><span class="fn__space"></span>`),e.memo&&(i+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg>${e.memo}</span>`),i&&(i=`<div class="fn__flex b3-list-item__meta b3-list-item__showall">${i}</div>`),n.push({value:`{{select * from blocks where id='${e.id}'}}`,html:`${i}<div class="b3-list-item__first">\n    <svg class="b3-list-item__graphic popover__block" data-id="${e.id}"><use xlink:href="#${t}"></use></svg>\n    <span class="b3-list-item__text">${e.content}</span>\n</div>\n<div class="b3-list-item__meta b3-list-item__showall" style="margin-bottom: 4px">${e.hPath}</div>`})})),0===n.length&&n.push({value:"",html:window.siyuan.languages.emptyContent}),t.hint.genHTML(n,t,!0)})),[]};t.hintRenderTemplate=(e,t,n)=>{(0,i.fetchPost)("/api/template/render",{id:t.block.parentID,path:e},(e=>{(0,u.focusByRange)(t.toolbar.range);const i=(0,m.getContenteditableElement)(n);i&&""===i.textContent.trim()?(0,a.insertHTML)(e.data.content,t,!0):(0,a.insertHTML)(e.data.content,t),t.wysiwyg.element.querySelectorAll('[status="temp"]').forEach((e=>{e.remove()})),(0,l.blockRender)(t,t.wysiwyg.element),(0,d.processRender)(t.wysiwyg.element),(0,c.highlightRender)(t.wysiwyg.element),t.toolbar.subElement.classList.add("fn__none")}))};t.hintRenderWidget=(e,t)=>{(0,u.focusByRange)(t.toolbar.range),(0,a.insertHTML)(t.lute.SpinBlockDOM(`<iframe src="/widgets/${e}" data-subtype="widget" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>`),t,!0),t.toolbar.subElement.classList.add("fn__none")};t.hintRenderAssets=(e,t)=>{(0,u.focusByRange)(t.toolbar.range);const n=(0,y.pathPosix)().extname(e).toLowerCase(),i=e.startsWith("assets/")?(0,y.getAssetName)(e):e;let s="";r.Constants.SIYUAN_ASSETS_AUDIO.includes(n)?s+=`<audio controls="controls" src="${e}"></audio>`:r.Constants.SIYUAN_ASSETS_IMAGE.includes(n)?s+=`![${i}](${e})`:r.Constants.SIYUAN_ASSETS_VIDEO.includes(n)?s+=`<video controls="controls" src="${e}"></video>`:s+=`[${e.startsWith("assets/")?i+n:e}](${e})`,(0,a.insertHTML)(t.lute.SpinBlockDOM(s),t),t.toolbar.subElement.classList.add("fn__none")};t.hintMoveBlock=(e,t,n)=>{const i=[];let a;const s=t[0].parentElement;let o;if(t.forEach(((n,s)=>{s===t.length-1&&(a=(0,m.getTopAloneElement)(n),o=a.nextElementSibling||a.previousElementSibling,a.isSameNode(n)&&(a=void 0)),i.push({action:"append",id:n.getAttribute("data-node-id"),parentID:(0,y.getDisplayName)(e,!0,!0)}),n.remove()})),a)i.push({action:"delete",id:a.getAttribute("data-node-id")}),a.remove();else if(s.classList.contains("list")&&"o"===s.getAttribute("data-subtype")&&s.childElementCount>1)(0,h.updateListOrder)(s,1),Array.from(s.children).forEach((e=>{e.classList.contains("protyle-attr")||i.push({action:"update",id:e.getAttribute("data-node-id"),data:e.outerHTML})}));else if(n.block.showAll&&s.classList.contains("protyle-wysiwyg")&&0===s.childElementCount)setTimeout((()=>{(0,v.zoomOut)(n,n.block.parent2ID,n.block.parent2ID)}),2*r.Constants.TIMEOUT_INPUT+100);else if(s.classList.contains("protyle-wysiwyg")&&""===s.innerHTML&&!(0,p.hasClosestByClassName)(s,"block__edit",!0)&&n.block.id===n.block.rootID){const e=Lute.NewNodeID(),t=(0,f.genEmptyElement)(!1,!1,e);i.splice(0,0,{action:"insert",id:e,data:t.outerHTML,parentID:n.block.parentID}),s.innerHTML=t.outerHTML,(0,u.focusBlock)(t)}else o&&(0,u.focusBlock)(o);(0,b.transaction)(n,i),n.toolbar.subElement.classList.add("fn__none")}},5580:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Hint=void 0;const i=n(8438),a=n(7821),s=n(2386),o=n(4659),l=n(9972),r=n(4739),d=n(5500),c=n(3903),u=n(1985),p=n(3053),m=n(8469),g=n(1456),b=n(6112),y=n(5615),f=n(7683),h=n(9883),w=n(6810),v=n(9755),_=n(4383),E=n(562),k=n(999),C=n(8059),x=n(6259);t.Hint=class{constructor(e){this.enableSlash=!0,this.enableEmoji=!1,this.splitChar="",this.lastIndex=-1,this.element=document.createElement("div"),this.element.setAttribute("data-close","false"),this.element.setAttribute("style",`z-index: 201;overflow:auto;max-height:402px;width:${Math.max(e.element.clientWidth/2,320)}px;box-sizing: border-box;`),this.element.className="b3-menu b3-list b3-list--background fn__none",this.element.addEventListener("click",(t=>{var n;const i=t.target;if("INPUT"===i.tagName)return void t.stopPropagation();const o=(0,a.hasClosestByMatchTag)(i,"BUTTON");if(o&&!o.classList.contains("emojis__item"))return o.parentElement.classList.contains("b3-list")?this.fill(decodeURIComponent(o.getAttribute("data-value")),e):(setTimeout((()=>{this.fill(decodeURIComponent(o.getAttribute("data-value")),e)}),148),(0,s.focusByRange)(e.toolbar.range)),t.preventDefault(),void t.stopPropagation();const l=this.element.querySelector(".emojis__panel"),r=(0,a.hasClosestByClassName)(i,"emojis__type");if(r){const e=l.querySelector(`[data-type="${r.getAttribute("data-type")}"]`);if(e){const t=e.nextElementSibling.getAttribute("data-index");if(t){let n="";window.siyuan.emojis[parseInt(t)].items.forEach((e=>{n+=`<button data-unicode="${e.unicode}" class="emojis__item" aria-label="${"zh_CN"===window.siyuan.config.lang?e.description_zh_cn:e.description}">\n${(0,w.unicode2Emoji)(e.unicode,!0)}</button>`})),e.nextElementSibling.innerHTML=n,e.nextElementSibling.removeAttribute("data-index")}l.scrollTo({top:e.offsetTop})}return}const d=(0,a.hasClosestByClassName)(i,"emojis__item");if(d){const t=d.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const i=getSelection().getRangeAt(0);let a;3!==i.endContainer.nodeType&&(null===(n=i.endContainer.childNodes[i.endOffset-1])||void 0===n||n.remove()),(0,w.addEmoji)(t),a=t.indexOf(".")>-1?`:${t.split(".")[0]}: `:(0,w.unicode2Emoji)(t,!0)+" ",(0,m.insertHTML)(e.lute.SpinBlockDOM(a),e),this.element.classList.add("fn__none")}else this.fill(t,e)}}))}render(e){if(!window.getSelection().focusNode)return this.element.classList.add("fn__none"),void clearTimeout(this.timeId);const t=getSelection().getRangeAt(0),n=(0,s.getSelectionOffset)(t.startContainer,e.wysiwyg.element).start,i=t.startContainer.textContent.substring(0,n)||"",l=this.getKey(i,e.options.hint.extend);return void 0===l||":"!==this.splitChar&&(e.toolbar.getCurrentType(t).length>0||(0,a.hasClosestByAttribute)(t.startContainer,"data-type","NodeCodeBlock"))?(this.element.classList.add("fn__none"),void clearTimeout(this.timeId)):":"===this.splitChar?(clearTimeout(this.timeId),void(l?this.genEmojiHTML(e,l):this.element.classList.add("fn__none"))):"/"===this.splitChar||"、"===this.splitChar?(clearTimeout(this.timeId),void(this.enableSlash&&this.genHTML((0,o.hintSlash)(l,e),e))):void e.options.hint.extend.forEach((t=>{t.key===this.splitChar&&(clearTimeout(this.timeId),this.timeId=window.setTimeout((()=>{this.genHTML(t.hint(l,e),e)}),e.options.hint.delay))}))}genLoading(e){if(this.element.classList.contains("fn__none")){this.element.innerHTML='<div class="fn__loading" style="height: 128px;position: initial"><img width="64px" src="/stage/loading-pure.svg"></div>',this.element.classList.remove("fn__none");const t=(0,s.getSelectionPosition)(e.wysiwyg.element);(0,d.setPosition)(this.element,t.left,t.top+26,30)}else this.element.insertAdjacentHTML("beforeend",'<div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div>')}genHTML(e,t,n=!1,i=!1){if(0===e.length)return void(this.element.querySelector(".fn__loading")&&!n||this.element.classList.add("fn__none"));let o="";i?(o='<input style="margin: 0 4px 4px 4px" class="b3-text-field"><div style="flex: 1;overflow:auto;">',this.element.style.display="flex",this.element.style.flexDirection="column"):this.element.style.display="";let l=!1;e.forEach(((t,n)=>{let i="";0===n?t.value.startsWith("((newFile ")&&t.value.endsWith(`${Lute.Caret}'))`)&&e.length>1?i="":(i=" b3-list-item--focus",l=!0):1!==n||l||(i=" b3-list-item--focus"),"separator"===t.html?o+='<div class="b3-menu__separator"></div>':o+=`<button class="b3-list-item b3-list-item--two fn__block${i}" data-value="${encodeURIComponent(t.value)}">${t.html}</button>`})),i&&(o+="</div>"),this.element.innerHTML=o,this.element.classList.remove("fn__none"),e[0].filter?this.element.classList.add("hint--menu"):this.element.classList.remove("hint--menu"),this.element.style.width=Math.max(t.element.clientWidth/2,320)+"px";const c=(0,s.getSelectionPosition)(t.wysiwyg.element);(0,d.setPosition)(this.element,c.left,c.top+26,30),this.element.scrollTop=0;const u=this.element.querySelector('input[type="file"]');if(u&&u.addEventListener("change",(e=>{if(0===e.target.files.length)return;const n=(0,s.getEditorRange)(t.wysiwyg.element);this.lastIndex>-1&&n.setStart(n.startContainer,this.lastIndex),n.deleteContents(),(0,E.uploadFiles)(t,e.target.files,e.target),(0,y.hideElements)(["hint","toolbar"],t)})),i){const e=this.element.querySelector("input.b3-text-field"),n=this.element.querySelector("mark").textContent;e.value=n,e.select(),e.addEventListener("keydown",(e=>{e.stopPropagation(),e.isComposing||((0,r.upDownHint)(this.element.lastElementChild,e),"Enter"===e.key?(setTimeout((()=>{this.fill(decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value")),t)}),148),(0,s.focusByRange)(t.toolbar.range),e.preventDefault()):"Escape"===e.key&&(this.element.classList.add("fn__none"),(0,s.focusByRange)(t.toolbar.range)))}));const i=(0,a.hasClosestBlock)(t.toolbar.range.startContainer);e.addEventListener("input",(a=>{a.isComposing||(a.stopPropagation(),this.genSearchHTML(t,e,i,n))})),e.addEventListener("compositionend",(a=>{a.stopPropagation(),this.genSearchHTML(t,e,i,n)}))}}genSearchHTML(e,t,n,a){this.element.lastElementChild.innerHTML='<div class="ft__center"><img style="height:32px;width:32px;" src="/stage/loading-pure.svg"></div>',(0,f.fetchPost)("/api/search/searchRefBlock",{k:t.value,id:n?n.getAttribute("data-node-id"):e.block.parentID,beforeLen:Math.floor((Math.max(e.element.clientWidth/2,320)-58)/28.8),rootID:e.block.rootID},(e=>{let t="";if(e.data.newDoc){const n=`((newFile "${a}"${i.Constants.ZWSP}'${e.data.k}${Lute.Caret}'))`;t+=`<button class="b3-list-item b3-list-item--two fn__block${0===e.data.blocks.length?" b3-list-item--focus":""}" data-value="${encodeURIComponent(n)}"><div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>\n<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${e.data.k}</mark></span></div></button>`}e.data.blocks.forEach(((e,n)=>{const i=(0,C.getIconByType)(e.type);let s="";e.name&&(s+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg>${e.name}</span><span class="fn__space"></span>`),e.alias&&(s+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg>${e.alias}</span><span class="fn__space"></span>`),e.memo&&(s+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg>${e.memo}</span>`),s&&(s=`<div class="fn__flex b3-list-item__meta b3-list-item__showall">${s}</div>`);const o=`<span data-type="block-ref" data-id="${e.id}" data-subtype="s">${a}</span>`;t+=`<button class="b3-list-item b3-list-item--two fn__block${0===n?" b3-list-item--focus":""}" data-value="${encodeURIComponent(o)}">${s}<div class="b3-list-item__first">\n    <svg class="b3-list-item__graphic popover__block" data-id="${e.id}"><use xlink:href="#${i}"></use></svg>\n    <span class="b3-list-item__text">${e.content}</span>\n</div>\n<div class="b3-list-item__meta b3-list-item__showall" style="margin-bottom: 4px">${e.hPath}</div></button>`})),""===t&&(t=`<button class="b3-list-item b3-list-item--two fn__block" data-value="">${window.siyuan.languages.emptyContent}</button>`),this.element.lastElementChild.innerHTML=t}))}genEmojiHTML(e,t=""){if(t&&!this.enableEmoji)return;const n=this.element.querySelector(".emojis__panel");n?(n.innerHTML=(0,w.filterEmoji)(t,256,!0),t?n.nextElementSibling.classList.add("fn__none"):n.nextElementSibling.classList.remove("fn__none")):(this.element.innerHTML=`<div class="emojis" style="height: auto;">\n<div class="emojis__panel">${(0,w.filterEmoji)(t,256,!0)}</div>\n<div class="fn__flex${t?" fn__none":""}">\n    <div data-type="0" class="emojis__type" aria-label="${window.siyuan.languages.recentEmoji}">${(0,w.unicode2Emoji)("2b50",!0)}</div>\n    <div data-type="1" class="emojis__type" aria-label="${window.siyuan.emojis[0]["zh_CN"===window.siyuan.config.lang?"title_zh_cn":"title"]}">${(0,w.unicode2Emoji)("1f527",!0)}</div>\n    <div data-type="2" class="emojis__type" aria-label="${window.siyuan.emojis[1]["zh_CN"===window.siyuan.config.lang?"title_zh_cn":"title"]}">${(0,w.unicode2Emoji)("1f60d",!0)}</div>\n    <div data-type="3" class="emojis__type" aria-label="${window.siyuan.emojis[2]["zh_CN"===window.siyuan.config.lang?"title_zh_cn":"title"]}">${(0,w.unicode2Emoji)("1f433",!0)}</div>\n    <div data-type="4" class="emojis__type" aria-label="${window.siyuan.emojis[3]["zh_CN"===window.siyuan.config.lang?"title_zh_cn":"title"]}">${(0,w.unicode2Emoji)("1f96a",!0)}</div>\n    <div data-type="5" class="emojis__type" aria-label="${window.siyuan.emojis[4]["zh_CN"===window.siyuan.config.lang?"title_zh_cn":"title"]}">${(0,w.unicode2Emoji)("1f3a8",!0)}</div>\n    <div data-type="6" class="emojis__type" aria-label="${window.siyuan.emojis[5]["zh_CN"===window.siyuan.config.lang?"title_zh_cn":"title"]}">${(0,w.unicode2Emoji)("1f3dd",!0)}</div>\n    <div data-type="7" class="emojis__type" aria-label="${window.siyuan.emojis[6]["zh_CN"===window.siyuan.config.lang?"title_zh_cn":"title"]}">${(0,w.unicode2Emoji)("1f52e",!0)}</div>\n    <div data-type="8" class="emojis__type" aria-label="${window.siyuan.emojis[7]["zh_CN"===window.siyuan.config.lang?"title_zh_cn":"title"]}">${(0,w.unicode2Emoji)("267e",!0)}</div>\n    <div data-type="9" class="emojis__type" aria-label="${window.siyuan.emojis[8]["zh_CN"===window.siyuan.config.lang?"title_zh_cn":"title"]}">${(0,w.unicode2Emoji)("1f6a9",!0)}</div>\n</div>\n</div>`,(0,w.lazyLoadEmoji)(this.element,!0));const i=this.element.querySelector(".emojis__item");if(i){i.classList.add("emojis__item--current"),this.element.classList.remove("fn__none"),this.element.style.width=Math.max(e.element.clientWidth/2,320)+"px";const t=(0,s.getSelectionPosition)(e.wysiwyg.element);(0,d.setPosition)(this.element,t.left,t.top+26,30),this.element.querySelector(".emojis__panel").scrollTop=0}else this.element.classList.add("fn__none")}fill(e,t){(0,y.hideElements)(["hint","toolbar"],t);const n=(0,s.getEditorRange)(t.wysiwyg.element);let r=(0,a.hasClosestBlock)(n.startContainer);if(!r)return;let d="";r&&(d=r.getAttribute("data-node-id"));let E=r.outerHTML;const C=i.Constants.BLOCK_HINT_CLOSE_KEYS[this.splitChar];if(i.Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&C&&3===n.startContainer.nodeType&&n.startContainer.wholeText.indexOf(C)>-1){let e=0,t=n.startContainer;for(;t&&e<2;){const i=t.textContent.indexOf(C),a=t.textContent.indexOf(this.splitChar);if(i>-1&&(i<a||a<0)){e=2,n.setEnd(t,i+2);break}const s=t.textContent.indexOf(C.substr(1));if(s>-1&&(e+=1),2===e){n.setEnd(t,s+1);break}t=t.nextSibling}}if(this.lastIndex>-1&&n.setStart(n.startContainer,this.lastIndex),i.Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&e.startsWith("((newFile ")&&e.endsWith(`${Lute.Caret}'))`)){(0,s.focusByRange)(n);const a=e.substring(11,e.length-4).split(`"${i.Constants.ZWSP}'`),o=1===a.length?a[0]:a[1];(0,l.getSavePath)(t.path,t.notebookId,(e=>{(0,f.fetchPost)("/api/filetree/createDocWithMd",{notebook:t.notebookId,path:(0,h.pathPosix)().join(e,o),markdown:""},(e=>{let n=`<span data-type="block-ref" data-id="${e.data}" data-subtype="d">${(0,v.escapeHtml)(o)}</span>`;2===a.length&&(n=`<span data-type="block-ref" data-id="${e.data}" data-subtype="s">${(0,v.escapeHtml)(a[0])}</span>`),(0,m.insertHTML)((0,p.genEmptyBlock)(!1,!1,n),t)}))}))}else{if(i.Constants.BLOCK_HINT_KEYS.includes(this.splitChar)){if(""===e){const e=(0,c.getContenteditableElement)(r);return void(""===e.textContent&&(e.innerHTML="<wbr>",(0,s.focusByWbr)(e,n)))}n.insertNode(document.createElement("wbr")),E=r.outerHTML,n.deleteContents();let i=document.createElement("div");return i.innerHTML=e.replace(/<mark>/g,"").replace(/<\/mark>/g,""),i=i.firstChild,n.insertNode(i),n.setStartAfter(i),n.collapse(!0),(0,u.updateTransaction)(t,d,r.outerHTML,E),void(0,s.focusByWbr)(r,n)}if(":"===this.splitChar){let n;(0,w.addEmoji)(e),n=e.indexOf(".")>-1?`:${e.split(".")[0]}: `:(0,w.unicode2Emoji)(e,!0)+" ",(0,m.insertHTML)(t.lute.SpinBlockDOM(n),t)}else{if(["「「","{{"].includes(this.splitChar)||"#"===this.splitChar||":"===this.splitChar){if(""===e){const e=(0,c.getContenteditableElement)(r);return void(""===e.textContent&&(e.innerHTML="<wbr>",(0,s.focusByWbr)(e,n)))}return(0,m.insertHTML)(t.lute.SpinBlockDOM(e),t),void(0,_.blockRender)(t,t.wysiwyg.element)}if("/"===this.splitChar||"、"===this.splitChar){if("(("===e||"{{"===e){"(("===e?(0,o.hintRef)("",t):(0,o.hintEmbed)("",t),this.splitChar=e,this.lastIndex=0,n.deleteContents();const i=document.createTextNode(e);return n.insertNode(i),n.setEnd(i,e.length),void n.collapse(!1)}if(e===i.Constants.ZWSP)return n.deleteContents(),this.fixImageCursor(n),t.toolbar.showTpl(t,r,n),void(0,u.updateTransaction)(t,d,r.outerHTML,E);if(e===i.Constants.ZWSP+1)return n.deleteContents(),this.fixImageCursor(n),t.toolbar.showWidget(t,r,n),void(0,u.updateTransaction)(t,d,r.outerHTML,E);if(e===i.Constants.ZWSP+2)return n.deleteContents(),this.fixImageCursor(n),t.toolbar.showAssets(t,r,n),void(0,u.updateTransaction)(t,d,r.outerHTML,E);if(e===i.Constants.ZWSP+3)return void n.deleteContents();if(e===i.Constants.ZWSP+4){const e=Lute.NewNodeID();return void(0,f.fetchPost)("/api/filetree/createDoc",{notebook:t.notebookId,path:(0,h.pathPosix)().join((0,h.getDisplayName)(t.path,!1,!0),e+".sy"),title:"Untitled",md:""},(()=>{(0,m.insertHTML)((0,p.genEmptyBlock)(!1,!1,`<span data-type="block-ref" data-id="${e}" data-subtype="d">Untitled</span>`),t),(0,k.openMobileFileById)(e,[i.Constants.CB_GET_HL,i.Constants.CB_GET_CONTEXT])}))}if(i.Constants.INLINE_TYPE.includes(e))return n.deleteContents(),(0,s.focusByRange)(n),t.toolbar.range=n,void t.toolbar.setInlineMark(t,e,"range");if("emoji"===e)return n.deleteContents(),n.insertNode(document.createTextNode(":")),n.collapse(!1),this.enableEmoji=!0,void this.genEmojiHTML(t);if(e.indexOf("style")>-1)return n.deleteContents(),this.fixImageCursor(n),r.setAttribute("style",e.split(i.Constants.ZWSP)[1]||""),void(0,u.updateTransaction)(t,d,r.outerHTML,E);{n.deleteContents(),"![]()"!==e&&this.fixImageCursor(n);let a=e;"```"===e&&(a=e+(localStorage.getItem(i.Constants.LOCAL_CODELANG)||"")+Lute.Caret+"\n```");const o=(0,c.getContenteditableElement)(r);if("![]()"===e){let i="";n.insertNode(document.createElement("wbr")),n.insertNode(document.createTextNode(e)),i=t.lute.SpinBlockDOM(r.outerHTML),r.outerHTML=i,r=t.wysiwyg.element.querySelector(`[data-node-id="${d}"]`),(0,s.focusByWbr)(r,n),(0,u.updateTransaction)(t,d,r.outerHTML,E);let a=n.startContainer.childNodes[n.startOffset-1]||n.startContainer;a&&3!==a.nodeType&&a.classList.contains("img")||(a=r.querySelector(".img"));const o=a.getBoundingClientRect();return void(0,b.imgMenu)(t,n,a,{clientX:o.left,clientY:o.top})}if(""===o.textContent&&"NodeParagraph"===r.getAttribute("data-type")){let n="";"<div>"===e?n=`<div data-node-id="${d}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block"><div class="protyle-icons"><span class="protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span></div><div><protyle-html data-content=""></protyle-html><span style="position: absolute">${i.Constants.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`:(o.textContent=a,n=t.lute.SpinBlockDOM(r.outerHTML)),r.outerHTML=n,r=t.wysiwyg.element.querySelector(`[data-node-id="${d}"]`),(0,u.updateTransaction)(t,d,n,E)}else{let n=t.lute.SpinBlockDOM(a);"<div>"===e&&(n=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block"><div class="protyle-icons"><span class="protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span></div><div><protyle-html data-content=""></protyle-html><span style="position: absolute">${i.Constants.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`),r.insertAdjacentHTML("afterend",n);const s=n.substr(n.indexOf('data-node-id="')+14,22);(0,u.transaction)(t,[{data:r.outerHTML,id:d,action:"update"},{data:n,id:s,previousID:d,action:"insert"}],[{id:s,action:"delete"},{data:E,id:d,action:"update"}]),r=t.wysiwyg.element.querySelector(`[data-node-id="${s}"]`)}if("<div>"===e||"$$"===e||e.indexOf("```")>-1&&e.length>3)t.toolbar.showRender(t,r),(0,x.processRender)(r);else if(e.startsWith("```"))(0,g.highlightRender)(r);else if(e.startsWith("<iframe")||e.startsWith("<video")||e.startsWith("<audio")){t.gutter.renderMenu(t,r);const e=r.getBoundingClientRect();window.siyuan.menus.menu.popup({x:e.left,y:e.top},!0);const n=window.siyuan.menus.menu.element.querySelector('[data-id="assetSubMenu"]');n.classList.add("b3-menu__item--show"),window.siyuan.menus.menu.showSubMenu(n.querySelector(".b3-menu__submenu")),window.siyuan.menus.menu.element.querySelectorAll("input")[0].focus()}else"---"===e?(0,s.focusBlock)(r):(0,s.focusByWbr)(r,n)}}}}}select(e,t){var n,a,s;const o=this.element.firstElementChild.classList.contains("emojis");if(0===this.element.querySelectorAll("button").length&&!o)return!1;if("Enter"===e.key){if(o){const e=this.element.querySelector(".emojis__item--current");if(!e)return!1;const i=e.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const e=getSelection().getRangeAt(0);let a;3!==e.endContainer.nodeType&&(null===(n=e.endContainer.childNodes[e.endOffset-1])||void 0===n||n.remove()),(0,w.addEmoji)(i),a=i.indexOf(".")>-1?`:${i.split(".")[0]}: `:(0,w.unicode2Emoji)(i,!0)+" ",(0,m.insertHTML)(t.lute.SpinBlockDOM(a),t),this.element.classList.add("fn__none")}else this.fill(i,t)}else{const e=decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value"));e===i.Constants.ZWSP+3?this.element.querySelector(".b3-list-item--focus input").click():this.fill(e,t)}return e.preventDefault(),e.stopPropagation(),!0}if(o){const t=this.element.querySelector(".emojis__item--current");if(!t)return!1;let n;if("ArrowLeft"===e.key||"ArrowUp"===e.key?t.previousElementSibling?(t.classList.remove("emojis__item--current"),n=t.previousElementSibling):(null===(a=t.parentElement.previousElementSibling)||void 0===a?void 0:a.previousElementSibling)&&(t.classList.remove("emojis__item--current"),n=t.parentElement.previousElementSibling.previousElementSibling.lastElementChild):"ArrowRight"!==e.key&&"ArrowDown"!==e.key||(t.nextElementSibling?(t.classList.remove("emojis__item--current"),n=t.nextElementSibling):(null===(s=t.parentElement.nextElementSibling)||void 0===s?void 0:s.nextElementSibling)&&(t.classList.remove("emojis__item--current"),n=t.parentElement.nextElementSibling.nextElementSibling.firstElementChild)),n){n.classList.add("emojis__item--current");const e=4,t=this.element.querySelector(".emojis__panel");n.offsetTop-e<t.scrollTop?t.scrollTop=n.offsetTop-e:n.offsetTop-e-t.clientHeight+n.clientHeight>t.scrollTop&&(t.scrollTop=n.offsetTop-e-t.clientHeight+n.clientHeight)}return e.preventDefault(),e.stopPropagation(),!0}return("ArrowDown"===e.key||"ArrowUp"===e.key)&&((0,r.upDownHint)(this.element,e),e.preventDefault(),e.stopPropagation(),!0)}fixImageCursor(e){const t=(0,c.hasPreviousSibling)(e.startContainer);t&&3!==t.nodeType&&t.classList.contains("img")&&((0,c.hasNextSibling)(t)||(e.insertNode(document.createTextNode(i.Constants.ZWSP)),e.collapse(!1)))}getKey(e,t){if(this.lastIndex=-1,this.splitChar="",t.forEach((t=>{const n=e.lastIndexOf(t.key);this.lastIndex<n&&(!i.Constants.BLOCK_HINT_KEYS.includes(this.splitChar)||":"!==t.key&&"#"!==t.key&&"/"!==t.key&&"、"!==t.key)&&("#"!==this.splitChar||"/"!==t.key&&"、"!==t.key)&&(this.splitChar=t.key,this.lastIndex=n)})),-1===this.lastIndex)return;":"!==this.splitChar||!/\d/.test(e.substr(this.lastIndex-1,1))&&"::"!==e.substr(this.lastIndex-1,2)||(this.enableEmoji=!1);const n=e.split(this.splitChar),a=n[n.length-1];return n.length>1&&a.trim()===a&&a.length<i.Constants.SIZE_TITLE?"【【"===this.splitChar&&e.endsWith("【【】")?"":a:void 0}}},4078:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(8438),a=n(5580),s=n(6417),o=n(5894),l=n(7994),r=n(4433),d=n(562),c=n(3218),u=n(5062),p=n(6520),m=n(7849),g=n(4577),b=n(5948),y=n(1047),f=n(8383),h=n(1196),w=n(1985),v=n(7683),_=n(7394),E=n(9883),k=n(1040),C=n(5715);t.default=class{constructor(e,t){var n;this.version=i.Constants.SIYUAN_VERSION;const s=new c.Options(t).merge();this.protyle={transactionTime:(new Date).getTime(),id:(0,g.genUUID)(),disabled:!1,updated:!1,element:e,options:s,block:{}},this.protyle.hint=new a.Hint(this.protyle),s.render.breadcrumb&&(this.protyle.breadcrumb=new h.Breadcrumb(this.protyle)),s.render.background&&(this.protyle.background=new _.Background(this.protyle)),this.protyle.element.innerHTML="",this.protyle.element.classList.add("protyle"),s.render.breadcrumb&&this.protyle.element.appendChild(this.protyle.breadcrumb.element.parentElement),this.protyle.undo=new r.Undo,this.protyle.wysiwyg=new b.WYSIWYG(this.protyle),this.protyle.toolbar=new y.Toolbar(this.protyle),this.protyle.scroll=new p.Scroll(this.protyle),this.protyle.options.render.gutter&&(this.protyle.gutter=new f.Gutter(this.protyle)),(s.upload.url||s.upload.handler)&&(this.protyle.upload=new d.Upload),this.init(),t.action.includes(i.Constants.CB_GET_HISTORY)||(this.protyle.ws=new m.Model({id:this.protyle.id,type:"protyle",msgCallback:e=>{switch(e.cmd){case"transactions":e.data[0].doOperations.forEach((e=>{(0,w.onTransaction)(this.protyle,e,!1)}));break;case"heading2doc":case"li2doc":this.protyle.block.rootID===e.data.srcRootBlockID&&(this.protyle.block.showAll&&"heading2doc"===e.cmd?(0,v.fetchPost)("/api/filetree/getDoc",{id:this.protyle.block.rootID,size:i.Constants.SIZE_GET},(e=>{(0,k.onGet)(e,this.protyle)})):(0,C.reloadProtyle)(this.protyle));break;case"rename":this.protyle.path===e.data.path&&(this.protyle.model&&this.protyle.model.parent.updateTitle(e.data.title),this.protyle.background&&(this.protyle.background.ial.title=e.data.title)),this.protyle.options.render.title&&this.protyle.block.parentID===e.data.id&&(getSelection().rangeCount>0&&this.protyle.element.contains(getSelection().getRangeAt(0).startContainer)||this.protyle.title.setTitle(e.data.title)),this.protyle.wysiwyg.element.querySelectorAll(`[data-type="~block-ref"][data-id="${e.data.id}"]`).forEach((t=>{"d"===t.getAttribute("data-subtype")&&(t.textContent=e.data.title)}));break;case"moveDoc":e.data.fromNotebook===this.protyle.notebookId&&this.protyle.path===e.data.fromPath&&(this.protyle.path=e.data.newPath,this.protyle.notebookId=e.data.toNotebook);break;case"unmount":this.protyle.model&&this.protyle.notebookId===e.data.box&&this.protyle.model.parent.parent.removeTab(this.protyle.model.parent.id,!1,!1);break;case"remove":!this.protyle.model||this.protyle.notebookId!==e.data.box||e.data.path&&0!==this.protyle.path.indexOf((0,E.getDisplayName)(e.data.path,!1,!0))||this.protyle.model.parent.parent.removeTab(this.protyle.model.parent.id,!1,!1)}}}),(0,v.fetchPost)("/api/filetree/getDoc",{id:t.blockId,k:t.key||"",mode:t.action&&t.action.includes(i.Constants.CB_GET_CONTEXT)?3:0,size:(null===(n=t.action)||void 0===n?void 0:n.includes(i.Constants.CB_GET_ALL))?i.Constants.SIZE_GET_MAX:i.Constants.SIZE_GET},(e=>{(0,k.onGet)(e,this.protyle,t.action,t.scrollAttr),this.protyle.model,s.after&&s.after(this)})),(0,l.setPadding)(this.protyle))}init(){this.protyle.lute=(0,s.setLute)({emojiSite:this.protyle.options.hint.emojiPath,emojis:this.protyle.options.hint.emoji,headingAnchor:!1,listStyle:this.protyle.options.preview.markdown.listStyle,paragraphBeginningSpace:this.protyle.options.preview.markdown.paragraphBeginningSpace,sanitize:this.protyle.options.preview.markdown.sanitize}),this.protyle.preview=new o.Preview(this.protyle),(0,l.initUI)(this.protyle)}focus(){this.protyle.wysiwyg.element.focus()}isUploading(){return this.protyle.upload.isUploading}clearStack(){this.protyle.undo.clear()}destroy(){(0,u.destroy)(this.protyle)}}},2439:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.abcRender=void 0;const i=n(9173),a=n(8438);t.abcRender=(e,t=a.Constants.PROTYLE_CDN)=>{let n=[];n="abc"===e.getAttribute("data-subtype")?[e]:Array.from(e.querySelectorAll('[data-subtype="abc"]')),0!==n.length&&n.length>0&&(0,i.addScript)(`${t}/js/abcjs/abcjs-basic-min.js?v=0.0.0`,"protyleAbcjsScript").then((()=>{n.forEach((e=>{if("true"===e.getAttribute("data-render"))return;e.firstElementChild.classList.contains("protyle-icons")||e.insertAdjacentHTML("afterbegin",'<div class="protyle-icons"><span class="protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span></div>'),e.childElementCount<4&&e.lastElementChild.insertAdjacentHTML("beforebegin",`<span style="position: absolute">${a.Constants.ZWSP}</span>`);const t=e.firstElementChild.nextElementSibling;ABCJS.renderAbc(t,Lute.UnEscapeHTMLStr(e.getAttribute("data-content")),{responsive:"resize"}),t.setAttribute("contenteditable","false"),e.setAttribute("data-render","true")}))}))}},4383:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.blockRender=void 0;const i=n(7821),a=n(7683),s=n(6259),o=n(1456),l=n(8438);t.blockRender=(e,n)=>{let r=[];r="NodeBlockQueryEmbed"===n.getAttribute("data-type")?[n]:Array.from(n.querySelectorAll('[data-type="NodeBlockQueryEmbed"]')),0!==r.length&&r.forEach((n=>{if("true"===n.getAttribute("data-render"))return;n.innerHTML=`<div class="protyle-icons${(0,i.hasClosestByAttribute)(n.parentElement,"data-type","NodeBlockQueryEmbed")?" fn__none":""}">\n    <span class="protyle-icon protyle-action__reload protyle-icon--first"><svg class="fn__rotate"><use xlink:href="#iconRefresh"></use></svg></span>\n    <span class="protyle-icon protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>\n    <span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>\n</div>${n.lastElementChild.outerHTML}`;const r=Lute.UnEscapeHTMLStr(n.getAttribute("data-content"));(0,a.fetchPost)("/api/search/searchEmbedBlock",{stmt:r,headingMode:"1"===n.getAttribute("custom-heading-mode")?1:0,excludeIDs:[n.getAttribute("data-node-id"),e.block.rootID]},(a=>{const r=n.querySelector(".fn__rotate");r&&r.classList.remove("fn__rotate");let d="";a.data.blocks.forEach((e=>{d+=`<div class="protyle-wysiwyg__embed" data-id="${e.id}">${e.content}</div>`})),n.setAttribute("data-render","true"),a.data.blocks.length>0?n.lastElementChild.insertAdjacentHTML("beforebegin",d+`<div style="position: absolute;">${l.Constants.ZWSP}</div>`):n.lastElementChild.insertAdjacentHTML("beforebegin",`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>\n<div style="position: absolute;">${l.Constants.ZWSP}</div>`),(0,s.processRender)(n),(0,o.highlightRender)(n);let c=0,u=n;for(;c<4&&u;)u=(0,i.hasClosestByAttribute)(u.parentElement,"data-type","NodeBlockQueryEmbed"),c++;c<4&&n.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach((n=>{(0,t.blockRender)(e,n)}))}))}))}},406:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.chartRender=void 0;const i=n(9173),a=n(8438),s=n(7821);t.chartRender=(e,t=a.Constants.PROTYLE_CDN)=>{let n=[];n="echarts"===e.getAttribute("data-subtype")?[e]:Array.from(e.querySelectorAll('[data-subtype="echarts"]')),0!==n.length&&n.length>0&&(0,i.addScript)(`${t}/js/echarts/echarts.min.js?v=5.3.2`,"protyleEchartsScript").then((()=>{(0,i.addScript)(`${t}/js/echarts/echarts-gl.min.js?v=2.0.9`,"protyleEchartsGLScript").then((()=>{let e;if(0===n[0].firstElementChild.clientWidth){const t=(0,s.hasClosestByClassName)(n[0],"layout-tab-container",!0);t&&Array.from(t.children).find((t=>{if(t.classList.contains("protyle")&&!t.classList.contains("fn__none"))return e=t.querySelector(".protyle-wysiwyg").firstElementChild.clientWidth,!0}))}n.forEach((t=>{if("true"===t.getAttribute("data-render"))return;t.firstElementChild.classList.contains("protyle-icons")||t.insertAdjacentHTML("afterbegin",'<div class="protyle-icons"><span class="protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span></div>');const n=t.firstElementChild.nextElementSibling;try{n.style.height=t.style.height;const i=JSON.parse(Lute.UnEscapeHTMLStr(t.getAttribute("data-content")));echarts.init(n,1===window.siyuan.config.appearance.mode?"dark":void 0,{width:e}).setOption(i),t.setAttribute("data-render","true"),n.classList.remove("ft__error"),n.textContent.endsWith(a.Constants.ZWSP)||n.firstElementChild.insertAdjacentText("beforeend",a.Constants.ZWSP)}catch(e){echarts.dispose(n),n.classList.add("ft__error"),n.innerHTML=`echarts render error: <br>${e}`}}))}))}))}},6374:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.flowchartRender=void 0;const i=n(9173),a=n(8438),s=n(7821);t.flowchartRender=(e,t=a.Constants.PROTYLE_CDN)=>{let n=[];n="flowchart"===e.getAttribute("data-subtype")?[e]:Array.from(e.querySelectorAll('[data-subtype="flowchart"]')),0!==n.length&&(0,i.addScript)(`${t}/js/flowchart.js/flowchart.min.js?v=0.0.0`,"protyleFlowchartScript").then((()=>{if(0===n[0].firstElementChild.clientWidth){const e=(0,s.hasClosestByClassName)(n[0],"protyle",!0);if(!e)return;const t=new MutationObserver((()=>{o(n),t.disconnect()}));t.observe(e,{attributeFilter:["class"]})}else o(n)}))};const o=e=>{e.forEach((e=>{if("true"===e.getAttribute("data-render"))return;e.firstElementChild.classList.contains("protyle-icons")||e.insertAdjacentHTML("afterbegin",'<div class="protyle-icons"><span class="protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span></div>'),e.childElementCount<4&&e.lastElementChild.insertAdjacentHTML("beforebegin",`<span style="position: absolute">${a.Constants.ZWSP}</span>`);const t=e.firstElementChild.nextElementSibling,n=flowchart.parse(Lute.UnEscapeHTMLStr(e.getAttribute("data-content")));t.innerHTML="";try{n.drawSVG(t)}catch(e){t.classList.add("ft__error"),t.innerHTML=`Flow Chart render error: <br>${e}`}t.setAttribute("contenteditable","false"),e.setAttribute("data-render","true")}))}},881:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.graphvizRender=void 0;const i=n(9173),a=n(8438);t.graphvizRender=(e,t=a.Constants.PROTYLE_CDN)=>{let n=[];n="graphviz"===e.getAttribute("data-subtype")?[e]:Array.from(e.querySelectorAll('[data-subtype="graphviz"]')),0!==n.length&&(0,i.addScript)(`${t}/js/graphviz/viz.js?v=0.0.0`,"protyleGraphVizScript").then((()=>{n.forEach((e=>{if("true"===e.getAttribute("data-render"))return;e.firstElementChild.classList.contains("protyle-icons")||e.insertAdjacentHTML("afterbegin",'<div class="protyle-icons"><span class="protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span></div>');const t=e.firstElementChild.nextElementSibling;try{const n=new Blob([`importScripts('${document.getElementById("protyleGraphVizScript").src.replace("viz.js","full.render.js")}');`],{type:"application/javascript"}),i=(window.URL||window.webkitURL).createObjectURL(n),s=new Worker(i);new Viz({worker:s}).renderSVGElement(Lute.UnEscapeHTMLStr(e.getAttribute("data-content"))).then((n=>{t.innerHTML=n.outerHTML,t.classList.remove("ft__error"),t.setAttribute("contenteditable","false"),e.textContent.endsWith(a.Constants.ZWSP)||e.insertAdjacentHTML("beforeend",`<span style="position: absolute">${a.Constants.ZWSP}</span>`)})).catch((e=>{t.innerHTML=`graphviz render error: <br>${e}`,t.classList.add("ft__error")}))}catch(e){console.error("Graphviz error",e)}e.setAttribute("data-render","true")}))}))}},1456:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lineNumberRender=t.highlightRender=void 0;const i=n(9173),a=n(3242),s=n(8438),o=n(2386);t.highlightRender=(e,n=s.Constants.PROTYLE_CDN)=>{let l,r=!1;e.classList.contains("code-block")?l=e.querySelectorAll('[spellcheck="false"]'):e.classList.contains("item__readme")?(l=e.querySelectorAll("pre code"),l.forEach((e=>{e.parentElement.setAttribute("lineNumber","false")}))):e.classList.contains("b3-typography")?(l=e.querySelectorAll(".code-block code"),r=!0):l=e.querySelectorAll('.code-block [spellcheck="false"]'),0!==l.length&&((0,a.setCodeTheme)(n),(0,i.addScript)(`${n}/js/highlight.js/highlight.min.js?v=11.5.0`,"protyleHljsScript").then((()=>{(0,i.addScript)(`${n}/js/highlight.js/third-languages.js?v=1.0.0`,"protyleHljsThirdScript").then((()=>{l.forEach((e=>{var n;if("true"===e.getAttribute("data-render"))return;const i=e.querySelector("wbr");let a,s=0;if(i){let e=i.previousSibling;for(;e;){for(s+=e.textContent.length;!e.previousSibling&&"DIV"!==e.parentElement.tagName;)e=e.parentElement;e=e.previousSibling}i.remove()}a=r?e.parentElement.getAttribute("data-language"):e.previousElementSibling?e.previousElementSibling.firstElementChild.textContent:e.className.replace("language-",""),hljs.getLanguage(a)||(a="plaintext"),e.classList.add("hljs"),e.innerHTML=hljs.highlight(e.textContent+(e.textContent.endsWith("\n")?"":"\n"),{language:a,ignoreIllegals:!0}).value,e.setAttribute("data-render","true");const l=e.parentElement.getAttribute("linewrap"),d=e.parentElement.getAttribute("ligatures"),c=e.parentElement.getAttribute("linenumber");"true"===l||"false"!==l&&window.siyuan.config.editor.codeLineWrap?(e.style.setProperty("white-space","pre-wrap"),e.style.setProperty("word-break","break-all")):(e.style.setProperty("white-space","pre"),e.style.setProperty("word-break","initial")),"true"===d||"false"!==d&&window.siyuan.config.editor.codeLigatures?e.style.fontVariantLigatures="normal":e.style.fontVariantLigatures="none";const u=e.parentElement.querySelector(".protyle-action__language");!r&&("true"===c||"false"!==c&&window.siyuan.config.editor.codeSyntaxHighlightLineNum)?(e.classList.add("protyle-linenumber"),setTimeout((()=>{(0,t.lineNumberRender)(e)}),20),u&&(u.style.marginLeft="3.6em")):(null===(n=e.nextElementSibling)||void 0===n?void 0:n.classList.contains("protyle-linenumber__rows"))&&(e.classList.remove("protyle-linenumber"),e.nextElementSibling.remove(),u&&(u.style.marginLeft="")),i&&getSelection().rangeCount>0&&(0,o.focusByOffset)(e,s,s)}))}))})))};t.lineNumberRender=e=>{var t;if("false"===e.parentElement.getAttribute("lineNumber"))return;if(e.nextElementSibling&&e.nextElementSibling.clientHeight===e.clientHeight)return;e.classList.add("protyle-linenumber");const n=document.createElement("div");n.className="hljs protyle-linenumber",n.setAttribute("style",`padding-top:0 !important;padding-bottom:0 !important;min-height:auto !important;white-space:${e.style.whiteSpace};word-break:${e.style.wordBreak};font-variant-ligatures:${e.style.fontVariantLigatures};`),n.setAttribute("contenteditable","true"),e.insertAdjacentElement("afterend",n);let i="";const a=e.textContent.split(/\r\n|\r|\n|\u2028|\u2029/g);""===a[a.length-1]&&a.length>1&&a.pop();const s="break-all"===e.style.wordBreak;a.map((e=>{let t="";if(s){n.textContent=e||"\n";t=` style="height:${n.getBoundingClientRect().height}px;"`}i+=`<span${t}></span>`})),n.remove(),(null===(t=e.nextElementSibling)||void 0===t?void 0:t.classList.contains("protyle-linenumber__rows"))?e.nextElementSibling.innerHTML=i:e.insertAdjacentHTML("afterend",`<span contenteditable="false" class="protyle-linenumber__rows">${i}</span>`)}},2224:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mathRender=void 0;const i=n(9173),a=n(9632),s=n(8438),o=n(3903),l=n(7821);t.mathRender=(e,t=s.Constants.PROTYLE_CDN,n=!1)=>{let r=[];r="math"===e.getAttribute("data-subtype")?[e]:Array.from(e.querySelectorAll('[data-subtype="math"]')),0!==r.length&&((0,a.addStyle)(`${t}/js/katex/katex.min.css?v=0.16.0`,"protyleKatexStyle"),(0,i.addScript)(`${t}/js/katex/katex.min.js?v=0.16.0`,"protyleKatexScript").then((()=>{(0,i.addScript)(`${t}/js/katex/mhchem.min.js?v=0.16.0`,"protyleKatexMhchemScript").then((()=>{r.forEach((e=>{var t;if("true"===e.getAttribute("data-render"))return;e.setAttribute("data-render","true");let i=e;"DIV"===e.tagName&&(i=e.firstElementChild);let a={};try{a=JSON.parse(window.siyuan.config.editor.katexMacros||"{}")}catch(e){console.warn("KaTex macros is not JSON",e)}try{i.innerHTML=katex.renderToString(Lute.UnEscapeHTMLStr(e.getAttribute("data-content")),{displayMode:"DIV"===e.tagName,output:"html",macros:a}),i.classList.remove("ft__error");const r=(0,l.hasClosestBlock)(e);if("DIV"===e.tagName){i.firstElementChild.setAttribute("contenteditable","false"),i.childElementCount<2&&i.insertAdjacentHTML("beforeend",`<span style="position: absolute">${s.Constants.ZWSP}</span>`);const e=i.querySelectorAll(".base");e.length>0&&e[e.length-1].insertAdjacentHTML("afterend","<span class='fn__flex-1'></span>");const t=i.querySelector(".katex-html > .newline");t&&(t.parentElement.style.display="block")}else{r&&e.getBoundingClientRect().width>r.clientWidth?(e.style.maxWidth="100%",e.style.overflowX="auto",e.style.overflowY="hidden",e.style.display="inline-block"):(e.style.maxWidth="",e.style.overflowX="",e.style.overflowY="",e.style.display="");const n=(0,o.hasNextSibling)(e);n?n&&"\n"!==n.textContent&&e.insertAdjacentHTML("beforeend","&#xFEFF;"):"TH"!==e.parentElement.tagName&&"TD"!==e.parentElement.tagName?e.insertAdjacentText("afterend","\n"):e.insertAdjacentText("afterend",s.Constants.ZWSP),(null===(t=e.previousSibling)||void 0===t?void 0:t.textContent.endsWith("\n"))?e.insertAdjacentText("beforebegin",s.Constants.ZWSP):!(0,o.hasPreviousSibling)(e)&&["TH","TD"].includes(e.parentElement.tagName)&&e.insertAdjacentText("afterbegin",s.Constants.ZWSP)}n&&setTimeout((()=>{if("DIV"===e.tagName){const t=e.querySelector(".katex-display");t.clientWidth<t.scrollWidth&&t.firstElementChild.setAttribute("style",`font-size:${100*t.clientWidth/t.scrollWidth}%`)}else r&&e.offsetWidth>r.clientWidth&&e.firstElementChild.setAttribute("style",`font-size:${100*r.clientWidth/e.offsetWidth}%`)}))}catch(e){i.innerHTML=e.message,i.classList.add("ft__error")}}))}))})))}},3415:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mediaRender=void 0;t.mediaRender=e=>{e&&e.querySelectorAll("a").forEach((e=>{const t=e.getAttribute("href");t&&(t.match(/^.+.(mp4|m4v|ogg|ogv|webm)$/)?((e,t)=>{e.insertAdjacentHTML("afterend",`<video controls="controls" src="${t}"></video>`),e.remove()})(e,t):t.match(/^.+.(mp3|wav|flac)$/)?((e,t)=>{e.insertAdjacentHTML("afterend",`<audio controls="controls" src="${t}"></audio>`),e.remove()})(e,t):((e,t)=>{const n=t.match(/\/\/(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([\w|-]{11})(?:(?:[\?&]t=)(\S+))?/),i=t.match(/\/\/v\.youku\.com\/v_show\/id_(\w+)=*\.html/),a=t.match(/\/\/v\.qq\.com\/x\/cover\/.*\/([^\/]+)\.html\??.*/),s=t.match(/(?:www\.|\/\/)coub\.com\/view\/(\w+)/),o=t.match(/(?:www\.|\/\/)facebook\.com\/([^\/]+)\/videos\/([0-9]+)/),l=t.match(/.+dailymotion.com\/(video|hub)\/(\w+)\?/),r=t.match(/(?:www\.|\/\/)bilibili\.com\/video\/(\w+)/),d=t.match(/(?:www\.|\/\/)ted\.com\/talks\/(\w+)/),c=t.match(/(?:www\.|\/\/)asciinema\.org\/a\/(\w+)/);n&&11===n[1].length?(e.insertAdjacentHTML("afterend",`<iframe src="https://www.youtube.com/embed/${n[1]+(n[2]?"?start="+n[2]:"")}"></iframe>`),e.remove()):i&&i[1]?(e.insertAdjacentHTML("afterend",`<iframe src="https://player.youku.com/embed/${i[1]}"></iframe>`),e.remove()):a&&a[1]?(e.insertAdjacentHTML("afterend",`<iframe src="https://v.qq.com/txp/iframe/player.html?vid=${a[1]}"></iframe>`),e.remove()):s&&s[1]?(e.insertAdjacentHTML("afterend",`<iframe src="https://coub.com/embed/${s[1]}?muted=false&autostart=false&originalSize=true&startWithHD=true"></iframe>`),e.remove()):o&&o[0]?(e.insertAdjacentHTML("afterend",`<iframe src="https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(o[0])}"></iframe>`),e.remove()):l&&l[2]?(e.insertAdjacentHTML("afterend",`<iframe src="https://www.dailymotion.com/embed/video/${l[2]}"></iframe>`),e.remove()):r&&r[1]?(e.insertAdjacentHTML("afterend",`<iframe src="https://player.bilibili.com/player.html?bvid=${r[1]}"></iframe>`),e.remove()):d&&d[1]?(e.insertAdjacentHTML("afterend",`<iframe src="https://embed.ted.com/talks/${d[1]}"></iframe>`),e.remove()):c&&c[1]&&(e.insertAdjacentHTML("afterend",`<iframe style="height: 462px;width: 737px;min-width: auto;" src="https://asciinema.org/a/${c[1]}/embed?"></iframe>`),e.remove())})(e,t))}))}},3728:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mermaidRender=void 0;const i=n(9173),a=n(8438),s=n(7821);t.mermaidRender=(e,t=a.Constants.PROTYLE_CDN)=>{let n=[];n="mermaid"===e.getAttribute("data-subtype")?[e]:Array.from(e.querySelectorAll('[data-subtype="mermaid"]')),0!==n.length&&(0,i.addScript)(`${t}/js/mermaid/mermaid.min.js?v=9.1.1`,"protyleMermaidScript").then((()=>{const e={securityLevel:"loose",altFontFamily:"sans-serif",fontFamily:"sans-serif",startOnLoad:!1,flowchart:{htmlLabels:!0,useMaxWidth:!0},sequence:{useMaxWidth:!0,diagramMarginX:8,diagramMarginY:8,boxMargin:8},gantt:{leftPadding:75,rightPadding:20}};if(1===window.siyuan.config.appearance.mode&&(e.theme="dark",e.themeVariables={background:"#333",primaryColor:"#1f2020",secondaryColor:"hsl(180, 1.5873015873%, 28.3529411765%)",tertiaryColor:"hsl(20, 1.5873015873%, 12.3529411765%)",primaryBorderColor:"hsl(180, 0%, 2.3529411765%)",secondaryBorderColor:"hsl(180, 0%, 18.3529411765%)",tertiaryBorderColor:"hsl(20, 0%, 2.3529411765%)",primaryTextColor:"#e0dfdf",secondaryTextColor:"rgb(183.8476190475, 181.5523809523, 181.5523809523)",tertiaryTextColor:"rgb(222.9999999999, 223.6666666666, 223.9999999999)",lineColor:"lightgrey",textColor:"#ccc",mainBkg:"#1f2020",secondBkg:"hsl(180, 1.5873015873%, 28.3529411765%)",mainContrastColor:"lightgrey",darkTextColor:"hsl(28.5714285714, 17.3553719008%, 86.2745098039%)",border1:"#81B1DB",border2:"rgba(255, 255, 255, 0.25)",arrowheadColor:"lightgrey",fontFamily:'"trebuchet ms", verdana, arial',fontSize:"16px",labelBackground:"#181818",nodeBkg:"#1f2020",nodeBorder:"#81B1DB",clusterBkg:"hsl(180, 1.5873015873%, 28.3529411765%)",clusterBorder:"rgba(255, 255, 255, 0.25)",defaultLinkColor:"lightgrey",titleColor:"#F9FFFE",edgeLabelBackground:"hsl(0, 0%, 34.4117647059%)",actorBorder:"#81B1DB",actorBkg:"#1f2020",actorTextColor:"lightgrey",actorLineColor:"lightgrey",signalColor:"lightgrey",signalTextColor:"lightgrey",labelBoxBkgColor:"#1f2020",labelBoxBorderColor:"#81B1DB",labelTextColor:"lightgrey",loopTextColor:"lightgrey",noteBorderColor:"rgba(255, 255, 255, 0.25)",noteBkgColor:"#fff5ad",noteTextColor:"#1f2020",activationBorderColor:"#81B1DB",activationBkgColor:"hsl(180, 1.5873015873%, 28.3529411765%)",sequenceNumberColor:"black",sectionBkgColor:"hsl(52.9411764706, 28.813559322%, 58.431372549%)",altSectionBkgColor:"#333",sectionBkgColor2:"#EAE8D9",taskBorderColor:"#ffffff",taskBkgColor:"hsl(180, 1.5873015873%, 35.3529411765%)",taskTextColor:"hsl(28.5714285714, 17.3553719008%, 86.2745098039%)",taskTextLightColor:"lightgrey",taskTextOutsideColor:"lightgrey",taskTextClickableColor:"#003163",activeTaskBorderColor:"#ffffff",activeTaskBkgColor:"#81B1DB",gridColor:"lightgrey",doneTaskBkgColor:"lightgrey",doneTaskBorderColor:"grey",critBorderColor:"#E83737",critBkgColor:"#E83737",taskTextDarkColor:"hsl(28.5714285714, 17.3553719008%, 86.2745098039%)",todayLineColor:"#DB5757",labelColor:"#ccc",errorBkgColor:"#a44141",errorTextColor:"#ddd",altBackground:"hsl(0, 0%, 40%)",fillType0:"#1f2020",fillType1:"hsl(180, 1.5873015873%, 28.3529411765%)",fillType2:"hsl(244, 1.5873015873%, 12.3529411765%)",fillType3:"hsl(244, 1.5873015873%, 28.3529411765%)",fillType4:"hsl(116, 1.5873015873%, 12.3529411765%)",fillType5:"hsl(116, 1.5873015873%, 28.3529411765%)",fillType6:"hsl(308, 1.5873015873%, 12.3529411765%)",fillType7:"hsl(308, 1.5873015873%, 28.3529411765%)",classText:"#e0dfdf"}),mermaid.initialize(e),0===n[0].firstElementChild.clientWidth){const e=(0,s.hasClosestByClassName)(n[0],"protyle",!0);if(!e)return;const t=new MutationObserver((()=>{o(n),t.disconnect()}));t.observe(e,{attributeFilter:["class"]})}else o(n)}))};const o=e=>{e.forEach((e=>{if("true"===e.getAttribute("data-render"))return;e.firstElementChild.classList.contains("protyle-icons")||e.insertAdjacentHTML("afterbegin",'<div class="protyle-icons"><span class="protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span></div>');const t=e.firstElementChild.nextElementSibling;t.removeAttribute("data-processed"),t.textContent=Lute.UnEscapeHTMLStr(e.getAttribute("data-content")),mermaid.init(void 0,t),e.setAttribute("data-render","true"),t.setAttribute("contenteditable","false"),e.textContent.endsWith(a.Constants.ZWSP)||e.insertAdjacentHTML("beforeend",`<span style="position: absolute">${a.Constants.ZWSP}</span>`)}))}},6710:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mindmapRender=void 0;const i=n(9173),a=n(8438),s=n(7821);t.mindmapRender=(e,t=a.Constants.PROTYLE_CDN)=>{let n=[];n="mindmap"===e.getAttribute("data-subtype")?[e]:Array.from(e.querySelectorAll('[data-subtype="mindmap"]')),0!==n.length&&(0,i.addScript)(`${t}/js/echarts/echarts.min.js?v=0.0.0`,"protyleEchartsScript").then((()=>{let e;if(0===n[0].firstElementChild.clientWidth){const t=(0,s.hasClosestByClassName)(n[0],"layout-tab-container",!0);t&&Array.from(t.children).find((t=>{if(t.classList.contains("protyle")&&!t.classList.contains("fn__none")&&t.querySelector(".protyle-wysiwyg").firstElementChild)return e=t.querySelector(".protyle-wysiwyg").firstElementChild.clientWidth,!0}))}n.forEach((t=>{if("true"===t.getAttribute("data-render"))return;t.firstElementChild.classList.contains("protyle-icons")||t.insertAdjacentHTML("afterbegin",'<div class="protyle-icons"><span class="protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span></div>');const n=t.firstElementChild.nextElementSibling;try{n.style.height=t.style.height,echarts.init(n,1===window.siyuan.config.appearance.mode?"dark":void 0,{width:e}).setOption({series:[{data:[JSON.parse(Lute.EChartsMindmapStr(Lute.UnEscapeHTMLStr(t.getAttribute("data-content"))))],initialTreeDepth:-1,itemStyle:{borderWidth:0,color:"#4285f4"},label:{backgroundColor:"#f6f8fa",borderColor:"#d1d5da",borderRadius:5,borderWidth:.5,color:"#586069",lineHeight:20,offset:[-5,0],padding:[0,5],position:"insideRight"},lineStyle:{color:"#d1d5da",width:1},roam:!0,symbol:(e,t)=>{var n;return(null===(n=null==t?void 0:t.data)||void 0===n?void 0:n.children)?"circle":"path://"},type:"tree"}],tooltip:{trigger:"item",triggerOn:"mousemove"},backgroundColor:"transparent"}),t.setAttribute("data-render","true"),n.textContent.endsWith(a.Constants.ZWSP)||n.firstElementChild.insertAdjacentText("beforeend",a.Constants.ZWSP),n.classList.remove("ft__error")}catch(e){n.classList.add("ft__error"),n.innerHTML=`Mindmap render error: <br>${e}`}}))}))}},2886:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.plantumlRender=void 0;const i=n(9173),a=n(8438);t.plantumlRender=(e,t=a.Constants.PROTYLE_CDN)=>{let n=[];n="plantuml"===e.getAttribute("data-subtype")?[e]:Array.from(e.querySelectorAll('[data-subtype="plantuml"]')),0!==n.length&&(0,i.addScript)(`${t}/js/plantuml/plantuml-encoder.min.js?v=0.0.0`,"protylePlantumlScript").then((()=>{n.forEach((e=>{if("true"===e.getAttribute("data-render"))return;e.firstElementChild.classList.contains("protyle-icons")||e.insertAdjacentHTML("afterbegin",'<div class="protyle-icons"><span class="protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span></div>');const t=e.firstElementChild.nextElementSibling;try{t.innerHTML=`<img src=${window.siyuan.config.editor.plantUMLServePath}${plantumlEncoder.encode(Lute.UnEscapeHTMLStr(e.getAttribute("data-content")))}">`,t.classList.remove("ft__error"),e.setAttribute("data-render","true")}catch(e){t.classList.add("ft__error"),t.innerHTML=`plantuml render error: <br>${e}`}}))}))}},6417:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setLute=void 0;t.setLute=e=>{const t=Lute.New();if(t.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),t.SetFileAnnotationRef(!0),t.SetTextMark(!0),t.SetHeadingID(!1),t.SetYamlFrontMatter(!1),t.PutEmojis(e.emojis),t.SetEmojiSite(e.emojiSite),t.SetHeadingAnchor(e.headingAnchor),t.SetInlineMathAllowDigitAfterOpenMarker(!0),t.SetToC(!1),t.SetIndentCodeBlock(!1),t.SetParagraphBeginningSpace(!0),t.SetSetext(!1),t.SetFootnotes(!1),t.SetLinkRef(!1),t.SetSanitize(e.sanitize),t.SetChineseParagraphBeginningSpace(e.paragraphBeginningSpace),t.SetRenderListStyle(e.listStyle),t.SetImgPathAllowSpace(!0),t.SetKramdownIAL(!0),t.SetTag(!0),t.SetSuperBlock(!0),t.SetGitConflict(!0),t.SetMark(!0),t.SetSup(!0),t.SetSub(!0),t.SetProtyleWYSIWYG(!0),e.lazyLoadImage&&t.SetImageLazyLoading(e.lazyLoadImage),t.SetBlockRef(!0),window.siyuan.emojis[0].items.length>0){const n={};window.siyuan.emojis[0].items.forEach((t=>{n[t.keywords]=e.emojiSite+"/"+t.unicode})),t.PutEmojis(n)}return t}},17:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.speechRender=void 0;const i=n(2386);t.speechRender=(e,t)=>{if("undefined"==typeof speechSynthesis||"undefined"==typeof SpeechSynthesisUtterance)return;const n='<svg><use xlink:href="#iconPlay"></use></svg>',a='<svg><use xlink:href="#iconPause"></use></svg>';let s=document.querySelector(".protyle-speech");if(!s){s=document.createElement("div"),s.className="protyle-speech",document.body.insertAdjacentElement("beforeend",s);const e=()=>{let e,n;return speechSynthesis.getVoices().forEach((i=>{i.lang===t.replace("_","-")&&(e=i),i.default&&(n=i)})),e||(e=n),e};void 0!==speechSynthesis.onvoiceschanged&&(speechSynthesis.onvoiceschanged=e);const o=e();s.onclick=()=>{if("protyle-speech"===s.className){const e=new SpeechSynthesisUtterance(s.getAttribute("data-text"));e.voice=o,e.onend=()=>{s.className="protyle-speech",speechSynthesis.cancel(),s.innerHTML=n},speechSynthesis.speak(e),s.className="protyle-speech protyle-speech--current",s.innerHTML=a}else speechSynthesis.speaking&&(speechSynthesis.paused?(speechSynthesis.resume(),s.innerHTML=a):(speechSynthesis.pause(),s.innerHTML=n));(0,i.focusByRange)(window.protyleSpeechRange)},document.body.addEventListener("click",(()=>{""===getSelection().toString().trim()&&"block"===s.style.display&&(s.className="protyle-speech",speechSynthesis.cancel(),s.style.display="none")}))}e.addEventListener("mouseup",(e=>{const t=getSelection().toString().trim();if(speechSynthesis.cancel(),""===getSelection().toString().trim())return void("block"===s.style.display&&(s.className="protyle-speech",s.style.display="none"));window.protyleSpeechRange=getSelection().getRangeAt(0).cloneRange();const i=getSelection().getRangeAt(0).getBoundingClientRect();s.innerHTML=n,s.style.display="block",s.style.top=i.top+i.height+document.querySelector("html").scrollTop-20+"px",s.style.left=e.screenX+2+"px",s.setAttribute("data-text",t)}))}},5306:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.previewImage=void 0;const i=n(8438),a=n(9173),s=n(7683);t.previewImage=(e,t)=>{(0,a.addScript)(`${i.Constants.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.10.4`,"protyleViewerScript").then((()=>{(0,s.fetchPost)("/api/asset/getDocImageAssets",{id:t},(t=>{const n=document.createElement("ul");let i="",a=-1;t.data.forEach(((t,n)=>{t&&(i+=`<li><img src="${t}"></li>`,-1===a&&(e.endsWith(encodeURI(t))||e.endsWith(t))&&(a=n))})),n.innerHTML=i;const s=new Viewer(n,{button:!1,initialViewIndex:a,transition:!1,hidden:function(){s.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){s.destroy()}}});s.show()}))}))}},5894:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Preview=void 0;const i=n(532),a=n(7821),s=n(2386),o=n(7491),l=n(9883),r=n(5306),d=n(7541),c=n(8438),u=n(6400),p=n(7683),m=n(6259),g=n(1456),b=n(17),y=n(3415);t.Preview=class{constructor(e){this.element=document.createElement("div"),this.element.className="protyle-preview fn__none";const t=document.createElement("div");t.className="b3-typography",e.options.classes.preview&&t.classList.add(e.options.classes.preview),t.style.padding=e.wysiwyg.element.style.padding,t.addEventListener("click",(n=>{if("A"===n.target.tagName){const e=n.target.getAttribute("href");return e.startsWith("#")?(t.querySelector(e).scrollIntoView(),n.stopPropagation(),void n.preventDefault()):(0,u.isMobile)()?((0,i.openByMobile)(e),n.stopPropagation(),void n.preventDefault()):(n.stopPropagation(),n.preventDefault(),void((0,l.isLocalPath)(e)||window.open(e)))}"IMG"===n.target.tagName&&(0,r.previewImage)(n.target.src,e.block.rootID)}));const n=e.options.preview.actions,s=document.createElement("div");s.className="protyle-preview__action";const o=[];for(let e=0;e<n.length;e++){const t=n[e];if("object"!=typeof t)switch(t){case"desktop":o.push('<button type="button" class="protyle-preview__action--current" data-type="desktop">Desktop</button>');break;case"tablet":o.push('<button type="button" data-type="tablet">Tablet</button>');break;case"mobile":o.push('<button type="button" data-type="mobile">Mobile/Wechat</button>');break;case"mp-wechat":o.push('<button type="button" data-type="mp-wechat" class="b3-tooltips b3-tooltips__w" aria-label="复制到公众号"><svg><use xlink:href="#iconMp"></use></svg></button>');break;case"zhihu":o.push('<button type="button" data-type="zhihu" class="b3-tooltips b3-tooltips__w" aria-label="复制到知乎"><svg><use xlink:href="#iconZhihu"></use></svg></button>');break;case"yuque":o.push('<button type="button" data-type="yuque" class="b3-tooltips b3-tooltips__w" aria-label="复制到语雀"><svg><use xlink:href="#iconYuque"></use></svg></button>')}else o.push(`<button type="button" data-type="${t.key}" class="${t.className}">${t.text}</button>`)}s.innerHTML=o.join(""),this.element.appendChild(s),this.element.appendChild(t),s.addEventListener((0,i.getEventName)(),(i=>{const o=(0,a.hasClosestByTag)(i.target,"BUTTON");if(!o)return;const l=o.getAttribute("data-type"),r=n.find((e=>(null==e?void 0:e.key)===l));r?r.click(l):"mp-wechat"!==l&&"zhihu"!==l&&"yuque"!==l?("desktop"===l?(t.style.width="",t.style.padding=e.wysiwyg.element.style.padding):"tablet"===l?(t.style.width="1024px",t.style.padding="8px 16px"):(t.style.width="360px",t.style.padding="8px"),this.render(e),s.querySelectorAll("button").forEach((e=>{e.classList.remove("protyle-preview__action--current")})),o.classList.add("protyle-preview__action--current")):this.copyToX(this.element.lastElementChild.cloneNode(!0),e,l)})),this.previewElement=t}render(e){"none"!==this.element.style.display&&(this.mdTimeoutId=window.setTimeout((()=>{(0,p.fetchPost)("/api/export/preview",{id:e.block.parentID||e.options.blockId},(t=>{e.preview.previewElement.innerHTML=t.data.html,(0,m.processRender)(e.preview.previewElement),(0,g.highlightRender)(e.preview.previewElement),(0,b.speechRender)(e.preview.previewElement,e.options.lang),(0,y.mediaRender)(e.preview.previewElement)}))}),e.options.preview.delay))}link2online(e){(0,d.needSubscribe)("")||e.querySelectorAll("[href],[src]").forEach((e=>{const t=e.getAttribute("href")||e.getAttribute("src");if(t&&t.startsWith("assets/")){const n=c.Constants.ASSETS_ADDRESS+window.siyuan.user.userId+"/"+t;e.getAttribute("href")?e.setAttribute("href",n):e.setAttribute("src",n)}}))}copyToX(e,t,n){if("mp-wechat"===n)this.link2online(e),e.querySelectorAll(".katex-html .base").forEach((e=>{e.style.display="initial"})),e.querySelectorAll("mjx-container > svg").forEach((e=>{e.setAttribute("width",8*parseInt(e.getAttribute("width"))+"px")}));else if("zhihu"===n)this.link2online(e),e.querySelectorAll('[data-subtype="math"]').forEach((e=>{e.outerHTML=`<img class="Formula-image" data-eeimg="true" src="//www.zhihu.com/equation?tex=" alt="${e.getAttribute("data-content")}\\" style="display: block; margin: 0 auto; max-width: 100%;">`})),e.querySelectorAll("blockquote").forEach((e=>{const t=[];this.processZHBlockquote(e,t),t.reverse().forEach((t=>{e.insertAdjacentElement("afterend",t)})),e.remove()})),this.processZHTable(e);else if("yuque"===n)return void(0,p.fetchPost)("/api/lute/copyStdMarkdown",{id:t.block.rootID},(e=>{(0,i.writeText)(e.data),(0,o.showMessage)("已复制，可到语雀进行粘贴")}));e.style.backgroundColor="#fff",e.querySelectorAll("code").forEach((e=>{e.style.backgroundImage="none"})),this.element.append(e);const a=getSelection().getRangeAt(0).cloneRange(),l=e.ownerDocument.createRange();l.selectNodeContents(e),(0,s.focusByRange)(l),document.execCommand("copy"),this.element.lastElementChild.remove(),(0,s.focusByRange)(a),n&&(0,o.showMessage)(`已复制，可到${"zhihu"===n?"知乎":"微信公众号平台"}进行粘贴`)}processZHBlockquote(e,t){Array.from(e.children).forEach((e=>{if("BLOCKQUOTE"===e.tagName)this.processZHBlockquote(e,t);else if("P"!==e.tagName||e.querySelector("img"))t.push(e);else{const n=t[t.length-1];(!n||n&&"BLOCKQUOTE"!==n.tagName)&&t.push(document.createElement("blockquote")),t[t.length-1].append(e)}}))}processZHTable(e){e.querySelectorAll("table").forEach((e=>{const t=e.querySelector("thead");e.querySelector("tbody").insertAdjacentElement("afterbegin",t.firstElementChild),t.remove()}))}}},9286:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.scrollEvent=void 0;const i=n(8438),a=n(5615),s=n(7683),o=n(1040),l=n(7491),r=n(532),d=n(6400);t.scrollEvent=(e,t)=>{let n=t.getBoundingClientRect();t.addEventListener("scroll",(()=>{var c;if(!e.toolbar.element.classList.contains("fn__none")){const a=e.toolbar.element.getAttribute("data-inity").split(i.Constants.ZWSP),s=parseInt(a[0])+(parseInt(a[1])-t.scrollTop);0===n.width&&(n=t.getBoundingClientRect());const o=29;s<n.top-o||s>n.bottom-o?e.toolbar.element.style.display="none":(e.toolbar.element.style.top=s+"px",e.toolbar.element.style.display="")}e.element.classList.contains("block__edit")||(0,d.isMobile)()||e.contentElement.setAttribute("data-scrolltop",t.scrollTop.toString()),window.siyuan.dragElement||(0,a.hideElements)(["gutter"],e),e.selectElement.classList.contains("fn__none")||(0,l.showMessage)(window.siyuan.languages.crossPageUse.replace("${}",(0,r.updateHotkeyTip)("⇧Click")),9e3);const u=null===(c=e.breadcrumb)||void 0===c?void 0:c.element.parentElement.querySelector('[data-type="context"]');u&&!u.classList.contains("ft__primary")||e.wysiwyg.element.getAttribute("data-top")||e.block.showAll||e.scroll.lastScrollTop===t.scrollTop||-1===e.scroll.lastScrollTop||(e.scroll.lastScrollTop-t.scrollTop>0?t.scrollTop<t.clientHeight&&"true"!==e.wysiwyg.element.firstElementChild.getAttribute("data-eof")&&(e.contentElement.style.overflow="hidden",e.wysiwyg.element.setAttribute("data-top",t.scrollTop.toString()),(0,s.fetchPost)("/api/filetree/getDoc",{id:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,k:e.options.key||"",size:i.Constants.SIZE_GET},(t=>{e.contentElement.style.overflow="",(0,o.onGet)(t,e,[i.Constants.CB_GET_BEFORE,i.Constants.CB_GET_UNCHANGEID])}))):t.scrollTop>t.scrollHeight-1.8*t.clientHeight&&e.wysiwyg.element.lastElementChild&&"true"!==e.wysiwyg.element.lastElementChild.getAttribute("data-eof")&&(e.wysiwyg.element.setAttribute("data-top",t.scrollTop.toString()),(0,s.fetchPost)("/api/filetree/getDoc",{id:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,k:e.options.key||"",size:i.Constants.SIZE_GET},(t=>{(0,o.onGet)(t,e,[i.Constants.CB_GET_APPEND,i.Constants.CB_GET_UNCHANGEID])}))),e.scroll.lastScrollTop=Math.max(t.scrollTop,0))}),{capture:!1,passive:!0,once:!1})}},6520:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Scroll=void 0;const i=n(8438),a=n(1040),s=n(7683);t.Scroll=class{constructor(e){const t=document.createElement("div");t.innerHTML="<input class='b3-slider' type='range' max='1' min='1' step='1' value='1' />",t.className="fn__none protyle-scroll b3-tooltips b3-tooltips__s",t.setAttribute("aria-label","Blocks 1/1"),this.element=t,this.keepLazyLoad=!1,e.options.render.scroll||this.element.classList.add("fn__none"),this.lastScrollTop=0,this.inputElement=t.firstElementChild,this.inputElement.addEventListener("input",(()=>{this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${e.block.blockCount}`)})),this.inputElement.addEventListener("change",(()=>{this.setIndex(e)})),this.inputElement.addEventListener("touchend",(()=>{this.setIndex(e)})),this.inputElement.addEventListener("click",(()=>{this.setIndex(e)}))}setIndex(e){!e.wysiwyg.element.getAttribute("data-top")&&e.model&&(e.wysiwyg.element.setAttribute("data-top",e.wysiwyg.element.scrollTop.toString()),(0,s.fetchPost)("/api/filetree/getDoc",{index:parseInt(this.inputElement.value),id:e.block.parentID,mode:0,size:i.Constants.SIZE_GET},(t=>{(0,a.onGet)(t,e,[i.Constants.CB_GET_FOCUSFIRST,i.Constants.CB_GET_UNCHANGEID])})))}update(e){"number"==typeof e.block.blockCount&&(this.inputElement.setAttribute("max",e.block.blockCount.toString()),this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${e.block.blockCount}`)),e.block.showAll?this.element.classList.add("fn__none"):e.block.childBlockCount>i.Constants.SIZE_GET?this.element.classList.remove("fn__none"):this.element.classList.add("fn__none")}}},5788:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.preventScroll=void 0;t.preventScroll=(e,t=0,n=1e3)=>{e.scroll.lastScrollTop=-1,setTimeout((()=>{e.scroll.lastScrollTop=t}),n)}},6245:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.restoreScroll=t.saveScroll=void 0;const i=n(7821),a=n(2386),s=n(7683),o=n(6112),l=n(5788),r=n(6259),d=n(1456),c=n(4383),u=n(1040);t.saveScroll=(e,t=!1)=>{if(!e.wysiwyg.element.firstElementChild)return;const n={startId:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),scrollTop:e.contentElement.scrollTop||parseInt(e.contentElement.getAttribute("data-scrolltop"))||0};let o;if(getSelection().rangeCount>0&&(o=getSelection().getRangeAt(0)),o&&e.wysiwyg.element.contains(o.startContainer)||(o=e.toolbar.range),o&&e.wysiwyg.element.contains(o.startContainer)){const e=(0,i.hasClosestBlock)(o.startContainer);if(e){const t=(0,a.getSelectionOffset)(e,void 0,o);n.focusId=e.getAttribute("data-node-id"),n.focusStart=t.start,n.focusEnd=t.end}}if(e.block.showAll&&(n.zoomInId=e.block.id),t)return n;const l=JSON.stringify(n);(0,s.fetchPost)("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{scroll:l}},(()=>{e.wysiwyg.element.setAttribute("scroll",l)}))};t.restoreScroll=(e,t)=>{if((0,l.preventScroll)(e),e.wysiwyg.element.firstElementChild.getAttribute("data-node-id")===t.startId&&e.wysiwyg.element.lastElementChild.getAttribute("data-node-id")===t.endId){if(setTimeout((()=>{e.contentElement.scrollTop=t.scrollTop}),256),t.focusId){(0,a.focusByOffset)(e.wysiwyg.element.querySelector(`[data-node-id="${t.focusId}"]`),t.focusStart,t.focusEnd)}}else t.zoomInId&&e.block.id!==t.zoomInId?(0,s.fetchPost)("/api/block/checkBlockExist",{id:t.zoomInId},(n=>{n.data&&(0,o.zoomOut)(e,t.zoomInId,void 0,!0,(()=>{e.contentElement.scrollTop=t.scrollTop,t.focusId&&(0,a.focusByOffset)(e.wysiwyg.element.querySelector(`[data-node-id="${t.focusId}"]`),t.focusStart,t.focusEnd)}))})):e.scroll.element.classList.contains("fn__none")?t.scrollTop&&(e.contentElement.scrollTop=t.scrollTop):(0,s.fetchPost)("/api/filetree/getDoc",{id:e.block.id,startID:t.startId,endID:t.endId},(n=>{if(e.block.showAll=!1,e.wysiwyg.element.innerHTML=n.data.content,(0,r.processRender)(e.wysiwyg.element),(0,d.highlightRender)(e.wysiwyg.element),(0,c.blockRender)(e,e.wysiwyg.element),e.disabled?(0,u.disabledProtyle)(e):(0,u.enableProtyle)(e),e.contentElement.scrollTop=t.scrollTop,t.focusId){(0,a.focusByOffset)(e.wysiwyg.element.querySelector(`[data-node-id="${t.focusId}"]`),t.focusStart,t.focusEnd)}}))}},2036:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BlockRef=void 0;const i=n(680),a=n(4659),s=n(2386);class o extends i.ToolbarItem{constructor(e,t){super(e,t),this.element.addEventListener("click",(t=>{(0,s.fixTableRange)(e.toolbar.range),(0,a.hintRef)(e.toolbar.range.toString(),e,!0),e.toolbar.element.classList.add("fn__none"),t.stopPropagation()}))}}t.BlockRef=o},2053:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Divider=void 0;t.Divider=class{constructor(){this.element=document.createElement("div"),this.element.className="protyle-toolbar__divider"}}},8247:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasSameTextStyle=t.setFontStyle=t.fontEvent=t.fontMenu=t.Font=void 0;const i=n(532),a=n(680),s=n(5500),o=n(2386),l=n(8438);class r extends a.ToolbarItem{constructor(e,n){super(e,n),this.element.addEventListener((0,i.getEventName)(),(()=>{e.toolbar.element.classList.add("fn__none"),e.toolbar.subElement.innerHTML="",e.toolbar.subElement.style.width="",e.toolbar.subElement.style.padding="",e.toolbar.subElement.append((0,t.fontMenu)(e)),e.toolbar.subElement.classList.remove("fn__none");const n=(0,o.getSelectionPosition)(e.wysiwyg.element,e.toolbar.range);(0,s.setPosition)(e.toolbar.subElement,n.left,n.top+18,26)}))}}t.Font=r;t.fontMenu=e=>{let n="";["var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach((e=>{n+=`<button class="b3-color__square" data-type="color" style="background-color:${e}"></button>`}));let a="";["var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach((e=>{a+=`<button class="b3-color__square" data-type="backgroundColor" style="background-color:${e}"></button>`}));const s=document.createElement("div");s.classList.add("protyle-font");let o="";const r=JSON.parse(localStorage.getItem(l.Constants.LOCAL_FONTSTYLES)||"[]");return r.length>0&&(o=`<div style="margin-bottom: 2px" class="fn__flex">\n    ${window.siyuan.languages.lastUsed}<span class="fn__space"></span>\n    <small class="ft__on-surface fn__flex-center">${(0,i.updateHotkeyTip)(window.siyuan.config.keymap.editor.insert.lastUsed.custom)}</small>\n</div><div class="fn__flex" style="align-items: center">`,r.forEach((e=>{const t=e.split(l.Constants.ZWSP);switch(t[0]){case"remove":o+=`<button style="margin-right: 4px" data-type="remove" class="b3-button--outline b3-button b3-button--small">${window.siyuan.languages.clearFontStyle}</button>`;break;case"color":o+=`<button class="b3-color__square" data-type="color" style="background-color:${t[1]}"></button>`;break;case"backgroundColor":o+=`<button class="b3-color__square" data-type="backgroundColor" style="background-color:${t[1]}"></button>`;break;case"style2":o+=`<button data-type="style2" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>`;break;case"style4":o+=`<button data-type="style4" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-border-color), 2px 2px var(--b3-border-color), 3px 3px var(--b3-border-color), 4px 4px var(--b3-border-color)">${window.siyuan.languages.shadow}</button>`}})),o+="</div>"),s.innerHTML=`${o}<div style="margin: 4px 0 2px">${window.siyuan.languages.colorFont}</div>\n<div class="fn__flex">\n    ${n}\n</div>\n<div style="margin: 4px 0 2px">${window.siyuan.languages["--b3-theme-background"]}</div>\n<div class="fn__flex">\n    ${a}\n</div>\n<div style="margin: 4px 0 2px">${window.siyuan.languages.fontStyle}</div>\n<div class="fn__flex">\n    <button data-type="style2" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>\n    <button data-type="style4" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-border-color), 2px 2px var(--b3-border-color), 3px 3px var(--b3-border-color), 4px 4px var(--b3-border-color)">${window.siyuan.languages.shadow}</button>\n    <span class="fn__space fn__flex-1"></span>\n    <button data-type="remove" class="b3-button--outline b3-button b3-button--small">\n        ${window.siyuan.languages.clearFontStyle}\n    </button>\n</div>`,s.addEventListener((0,i.getEventName)(),(function(n){let i=n.target;for(;i&&!i.isEqualNode(s);){if("BUTTON"===i.tagName){(0,t.fontEvent)(e,i.getAttribute("data-type"),i.style.backgroundColor);break}i=i.parentElement}})),s};t.fontEvent=(e,t,n)=>{let i=JSON.parse(localStorage.getItem(l.Constants.LOCAL_FONTSTYLES)||"[]");if(t)i.splice(0,0,`${t}${l.Constants.ZWSP}${n}`),i=[...new Set(i)],i.length>8&&i.splice(7,1),localStorage.setItem(l.Constants.LOCAL_FONTSTYLES,JSON.stringify(i));else if(0===i.length)t="color",n="var(--b3-font-color1)";else{const e=i[0].split(l.Constants.ZWSP);t=e[0],n=e[1]}e.toolbar.setInlineMark(e,"text","range",{type:t,color:n})};t.setFontStyle=(e,t)=>{if(t)switch(t.type){case"color":e.style.color=t.color;break;case"backgroundColor":e.style.backgroundColor=t.color;break;case"style2":e.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",e.style.webkitTextFillColor="transparent";break;case"style4":e.style.textShadow="1px 1px var(--b3-border-color), 2px 2px var(--b3-border-color), 3px 3px var(--b3-border-color), 4px 4px var(--b3-border-color)"}};t.hasSameTextStyle=(e,t,n)=>{if(!n)return!0;let i="",a="",s="",o="",l="";return 3!==e.nodeType&&(i=e.style.color,a=e.style.webkitTextFillColor,s=e.style.webkitTextStroke,o=e.style.textShadow,l=e.style.backgroundColor),"color"===n.type?n.color===t.style.color&&a===t.style.webkitTextFillColor&&s===t.style.webkitTextStroke&&o===t.style.textShadow&&l===t.style.backgroundColor:"backgroundColor"===n.type?i===t.style.color&&a===t.style.webkitTextFillColor&&s===t.style.webkitTextStroke&&o===t.style.textShadow&&n.color===t.style.backgroundColor:"style2"===n.type?i===t.style.color&&"transparent"===t.style.webkitTextFillColor&&"0.2px var(--b3-theme-on-background)"===t.style.webkitTextStroke&&o===t.style.textShadow&&l===t.style.backgroundColor:"style4"===n.type?i===t.style.color&&a===t.style.webkitTextFillColor&&s===t.style.webkitTextStroke&&"1px 1px var(--b3-border-color), 2px 2px var(--b3-border-color), 3px 3px var(--b3-border-color), 4px 4px var(--b3-border-color)"===t.style.textShadow&&l===t.style.backgroundColor:void 0}},6253:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,s){function o(e){try{r(i.next(e))}catch(e){s(e)}}function l(e){try{r(i.throw(e))}catch(e){s(e)}}function r(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,l)}r((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.InlineMath=void 0;const a=n(680),s=n(5680),o=n(1985),l=n(7821),r=n(3903),d=n(2224),c=n(2386);class u extends a.ToolbarItem{constructor(e,t){super(e,t),this.element.addEventListener("click",(t=>i(this,void 0,void 0,(function*(){e.toolbar.element.classList.add("fn__none"),t.stopPropagation();const n=e.toolbar.range,i=(0,l.hasClosestBlock)(n.startContainer);if(!i)return;(0,c.fixTableRange)(n),["DIV","TD","TH","TR"].includes(n.startContainer.parentElement.tagName)||0!==n.startOffset||(0,r.hasPreviousSibling)(n.startContainer)||n.setStartBefore(n.startContainer.parentElement),["DIV","TD","TH","TR"].includes(n.endContainer.parentElement.tagName)||n.endOffset!==n.endContainer.textContent.length||(0,r.hasNextSibling)(n.endContainer)||n.setEndAfter(n.endContainer.parentElement);const a=document.createElement("wbr");n.insertNode(a);const u=i.outerHTML,p=document.createElement("span"),m=n.toString();p.className="render-node",p.setAttribute("contenteditable","false"),p.setAttribute("data-type","inline-math"),p.setAttribute("data-subtype","math"),p.setAttribute("data-content",m.trim()),n.extractContents(),n.insertNode(p),(0,d.mathRender)(p),""===m.trim()&&e.toolbar.showRender(e,p),i.setAttribute("updated",s().format("YYYYMMDDHHmmss")),(0,o.updateTransaction)(e,i.getAttribute("data-node-id"),i.outerHTML,u),a.remove()}))))}}t.InlineMath=u},1904:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,s){function o(e){try{r(i.next(e))}catch(e){s(e)}}function l(e){try{r(i.throw(e))}catch(e){s(e)}}function r(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,l)}r((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.InlineMemo=void 0;const a=n(680),s=n(5680),o=n(1985),l=n(7821),r=n(3903),d=n(2386),c=n(6400);class u extends a.ToolbarItem{constructor(e,t){super(e,t),this.element.addEventListener("click",(t=>i(this,void 0,void 0,(function*(){e.toolbar.element.classList.add("fn__none"),t.stopPropagation();const n=e.toolbar.range,i=(0,l.hasClosestBlock)(n.startContainer);if(!i)return;const a=(0,l.hasClosestByAttribute)(n.startContainer,"data-type","inline-memo");if(a)return void e.toolbar.showRender(e,a);if(""===n.toString())return;(0,d.fixTableRange)(n),["DIV","TD","TH","TR"].includes(n.startContainer.parentElement.tagName)||0!==n.startOffset||(0,r.hasPreviousSibling)(n.startContainer)||n.setStartBefore(n.startContainer.parentElement),["DIV","TD","TH","TR"].includes(n.endContainer.parentElement.tagName)||n.endOffset!==n.endContainer.textContent.length||(0,r.hasNextSibling)(n.endContainer)||n.setEndAfter(n.endContainer.parentElement);const u=document.createElement("wbr");n.insertNode(u);const p=i.outerHTML,m=[];n.extractContents().childNodes.forEach((e=>{if(3===e.nodeType){const t=document.createElement("span");t.setAttribute("data-type","inline-memo"),t.textContent=e.textContent,m.push(t)}else{let t=(e.getAttribute("data-type")||"").split(" ");t.push("inline-memo"),t=[...new Set(t)],"BR"!==e.tagName&&"WBR"!==e.tagName?(e.setAttribute("data-type",t.join(" ")),m.push(e)):"WBR"!==e.tagName&&m.push(e)}}));for(let e=0;e<m.length;e++){const t=m[e],i=m[e+1];3!==t.nodeType&&i&&3!==i.nodeType&&(0,c.isArrayEqual)(i.getAttribute("data-type").split(" "),t.getAttribute("data-type").split(" "))&&t.style.color===i.style.color&&t.style.webkitTextFillColor===i.style.webkitTextFillColor&&t.style.webkitTextStroke===i.style.webkitTextStroke&&t.style.textShadow===i.style.textShadow&&t.style.backgroundColor===i.style.backgroundColor?(i.innerHTML=t.innerHTML+i.innerHTML,m.splice(e,1),e--):(n.insertNode(m[e]),n.collapse(!1))}n.setStart(m[0].firstChild,0),e.toolbar.showRender(e,m[0],m),i.setAttribute("updated",s().format("YYYYMMDDHHmmss")),(0,o.updateTransaction)(e,i.getAttribute("data-node-id"),i.outerHTML,p),u.remove()}))))}}t.InlineMemo=u},251:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,s){function o(e){try{r(i.next(e))}catch(e){s(e)}}function l(e){try{r(i.throw(e))}catch(e){s(e)}}function r(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,l)}r((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.removeLink=t.Link=void 0;const a=n(680),s=n(6112),o=n(8438),l=n(5680),r=n(1985),d=n(7821),c=n(3903),u=n(2386);class p extends a.ToolbarItem{constructor(e,t){super(e,t),this.element.addEventListener("click",(t=>i(this,void 0,void 0,(function*(){e.toolbar.element.classList.add("fn__none"),t.stopPropagation();const n=e.toolbar.range,i=(0,d.hasClosestBlock)(n.startContainer);if(!i)return;const a=(0,d.hasClosestByAttribute)(n.startContainer,"data-type","a");if(a)return void(0,s.linkMenu)(e,a);(0,u.fixTableRange)(n),["DIV","TD","TH","TR"].includes(n.startContainer.parentElement.tagName)||0!==n.startOffset||(0,c.hasPreviousSibling)(n.startContainer)||n.setStartBefore(n.startContainer.parentElement),["DIV","TD","TH","TR"].includes(n.endContainer.parentElement.tagName)||n.endOffset!==n.endContainer.textContent.length||(0,c.hasNextSibling)(n.endContainer)||n.setEndAfter(n.endContainer.parentElement);const p=document.createElement("wbr");n.insertNode(p);const m=i.outerHTML,g=document.createElement("span");g.setAttribute("data-type","a"),g.setAttribute("data-href","");const b=n.toString();g.textContent=b,n.extractContents(),n.insertNode(g);let y=!0,f=!1;try{const t=yield navigator.clipboard.readText();e.lute.IsValidLinkDest(b.trim())?(g.setAttribute("data-href",b.trim()),y=!1):e.lute.IsValidLinkDest(t)&&(g.setAttribute("data-href",t),""!==g.textContent.replace(o.Constants.ZWSP,"")&&(y=!1),f=!0)}catch(e){console.log(e)}y&&(0,s.linkMenu)(e,g,f),i.setAttribute("updated",l().format("YYYYMMDDHHmmss")),(0,r.updateTransaction)(e,i.getAttribute("data-node-id"),i.outerHTML,m),n.setStartAfter(g),n.collapse(!0),p.remove()}))))}}t.Link=p;t.removeLink=(e,t)=>{const n=e.getAttribute("data-type").split(" ");if(1===n.length){const n=e.parentElement;e.outerHTML=e.innerHTML+"<wbr>",(0,u.focusByWbr)(n,t)}else n.find(((e,t)=>{if("a"===e)return n.splice(t,1),!0})),e.setAttribute("data-type",n.join(" ")),e.removeAttribute("data-href"),t.selectNodeContents(e),t.collapse(!1),(0,u.focusByRange)(t)}},680:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ToolbarItem=void 0;const i=n(532),a=n(532);t.ToolbarItem=class{constructor(e,t){this.element=document.createElement("button");const n=t.hotkey?` ${(0,a.updateHotkeyTip)(t.hotkey)}`:"",s=t.tip||window.siyuan.languages[t.lang];this.element.classList.add("protyle-toolbar__item","b3-tooltips",`b3-tooltips__${t.tipPosition}`),this.element.setAttribute("data-type",t.name),this.element.setAttribute("aria-label",s+n),this.element.innerHTML=`<svg><use xlink:href="#${t.icon}"></use></svg>`,["text","a","block-ref","inline-math","inline-memo"].includes(t.name)||this.element.addEventListener((0,i.getEventName)(),(n=>{n.preventDefault(),e.toolbar.setInlineMark(e,t.name,"toolbar")}))}}},1047:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Toolbar=void 0;const i=n(2053),a=n(8247),s=n(680),o=n(2386),l=n(7821),r=n(251),d=n(5500),c=n(1985),u=n(8438),p=n(532),m=n(4739),g=n(1456),b=n(3903),y=n(6259),f=n(2036),h=n(4659),w=n(4383),v=n(7683),_=n(6400),E=n(5680),k=n(3053),C=n(1676),x=n(6810),L=n(9755),S=n(5615),T=n(9140),A=n(4433),M=n(1629),H=n(7491),I=n(6253),B=n(1904);t.Toolbar=class{constructor(e){const t=e.options,n=document.createElement("div");n.className="protyle-toolbar fn__none",this.element=n,this.subElement=document.createElement("div"),this.subElement.className="protyle-util fn__none",this.toolbarHeight=29,t.toolbar.forEach((t=>{const n=this.genItem(e,t);this.element.appendChild(n)}))}render(e,t,n){this.range=t;const i=(0,l.hasClosestBlock)(t.startContainer);if(!i||e.disabled)return void this.element.classList.add("fn__none");let a=!0,s=!0;if(Array.from(t.cloneContents().childNodes).find((e=>{if(1!==e.nodeType){if(e.textContent.length>0)return s=!1,!0}else if(!e.classList.contains("img"))return a=!1,!0})),a&&s)return void this.element.classList.add("fn__none");const r=(0,l.hasClosestBlock)(t.startContainer),c=(0,l.hasClosestBlock)(t.endContainer);if(r&&c&&!r.isSameNode(c)&&(n?"ArrowLeft"===n.key?this.range=(0,o.setLastNodeRange)((0,b.getContenteditableElement)(r),t,!1):this.range=(0,o.setFirstNodeRange)((0,b.getContenteditableElement)(c),t):this.range=(0,o.setLastNodeRange)((0,b.getContenteditableElement)(i),t,!1),(0,o.focusByRange)(this.range),""===this.range.toString()))return void this.element.classList.add("fn__none");if("NodeCodeBlock"===i.getAttribute("data-type"))return void this.element.classList.add("fn__none");const p=(0,o.getSelectionPosition)(i,t);this.element.classList.remove("fn__none");const m=p.top-this.toolbarHeight-4;this.element.setAttribute("data-inity",m+u.Constants.ZWSP+e.contentElement.scrollTop.toString()),(0,d.setPosition)(this.element,p.left-52,m),this.element.querySelectorAll(".protyle-toolbar__item--current").forEach((e=>{e.classList.remove("protyle-toolbar__item--current")}));this.getCurrentType().forEach((e=>{["a","block-ref","text","file-annotation-ref","inline-math","inline-memo",""].includes(e)||this.element.querySelector(`[data-type="${e}"]`).classList.add("protyle-toolbar__item--current")}))}getCurrentType(e=this.range){var t,n;let i=[],a=e.startContainer;if(3===a.nodeType?a=a.parentElement:a.childElementCount>0&&3!==(null===(t=a.childNodes[e.startOffset])||void 0===t?void 0:t.nodeType)&&(a=a.childNodes[e.startOffset]),!a||3===a.nodeType)return[];["DIV","TD","TH","TR"].includes(a.tagName)||(i=(a.getAttribute("data-type")||"").split(" "));let s=e.endContainer;return 3===s.nodeType?s=s.parentElement:s.childElementCount>0&&3!==(null===(n=s.childNodes[e.endOffset])||void 0===n?void 0:n.nodeType)&&(s=s.childNodes[e.endOffset]),s&&3!==s.nodeType?(["DIV","TD","TH","TR"].includes(s.tagName)||a.isSameNode(s)||(i=i.concat((s.getAttribute("data-type")||"").split(" "))),e.cloneContents().childNodes.forEach((e=>{3!==e.nodeType&&(i=i.concat((e.getAttribute("data-type")||"").split(" ")))})),i=[...new Set(i)],i.find(((e,t)=>{if(""===e)return i.splice(t,1),!0})),i):[]}genItem(e,t){let n;switch(t.name){case"strong":case"em":case"s":case"code":case"mark":case"tag":case"u":case"sup":case"sub":case"kbd":n=new s.ToolbarItem(e,t);break;case"block-ref":n=new f.BlockRef(e,t);break;case"inline-math":n=new I.InlineMath(e,t);break;case"inline-memo":n=new B.InlineMemo(e,t);break;case"|":n=new i.Divider;break;case"text":n=new a.Font(e,t);break;case"a":n=new r.Link(e,t)}if(n)return n.element}mergeNode(e){for(let t=0;t<e.length;t++)3!==e[t].nodeType&&"WBR"===e[t].tagName&&(e[t].remove(),t--);for(let t=0;t<e.length;t++)3===e[t].nodeType&&(""===e[t].textContent?(e[t].remove(),t--):e[t+1]&&3===e[t+1].nodeType&&(e[t].textContent=e[t].textContent+e[t+1].textContent,e[t+1].remove(),t--))}setInlineMark(e,t,n,i){var s;if(["a","block-ref","inline-math","inline-memo"].includes(t))return void e.toolbar.element.querySelector(`[data-type="${t}"]`).dispatchEvent(new CustomEvent("block-ref"===t?(0,p.getEventName)():"click"));const r=(0,l.hasClosestBlock)(this.range.startContainer);if(!r)return;const d=this.getCurrentType(this.range),m=this.range.toString();let g,y,f,h;(0,o.fixTableRange)(this.range);const w=(0,b.hasPreviousSibling)(this.range.startContainer);["DIV","TD","TH","TR"].includes(this.range.startContainer.parentElement.tagName)?w&&3!==w.nodeType&&0===this.range.startOffset&&(g=w):0!==this.range.startOffset||w?g=this.range.startContainer.parentElement:(g=this.range.startContainer.parentElement.previousSibling,this.range.setStartBefore(this.range.startContainer.parentElement));const v=(0,b.hasNextSibling)(this.range.endContainer);["DIV","TD","TH","TR"].includes(this.range.endContainer.parentElement.tagName)?v&&3!==v.nodeType&&this.range.endOffset===this.range.endContainer.textContent.length&&(y=v):this.range.endOffset!==this.range.endContainer.textContent.length||v?y=this.range.endContainer.parentElement:(y=this.range.endContainer.parentElement.nextSibling,this.range.setEndAfter(this.range.endContainer.parentElement)),this.range.insertNode(document.createElement("wbr"));const k=r.outerHTML,C=this.range.extractContents();if(this.mergeNode(C.childNodes),g&&y&&g.isSameNode(y)&&3===(null===(s=C.firstChild)||void 0===s?void 0:s.nodeType)){const e=g.attributes;C.childNodes.forEach((t=>{const n=document.createElement("span");for(let t=0;t<e.length;t++)n.setAttribute(e[t].name,e[t].value);n.innerHTML=t.textContent,t.replaceWith(n)}))}const x="toolbar"===n?this.element.querySelector(`[data-type="${t}"]`):void 0,L=[];if((null==x?void 0:x.classList.contains("protyle-toolbar__item--current"))||"range"===n&&d.length>0&&d.includes(t)&&(!i||"remove"===i.type)){if(x&&x.classList.remove("protyle-toolbar__item--current"),0===C.childNodes.length)if(d.find(((e,n)=>{if(t===e)return d.splice(n,1),!0})),0===d.length)L.push(document.createTextNode(u.Constants.ZWSP));else{const e=document.createElement("span");e.setAttribute("data-type",d.join(" ")),e.textContent=u.Constants.ZWSP,L.push(e)}C.childNodes.forEach(((e,n)=>{if(3!==e.nodeType&&"BR"!==e.tagName){const s=e.getAttribute("data-type").split(" ");s.find(((e,n)=>{if(t===e)return s.splice(n,1),!0})),0===s.length?(""===e.textContent&&(e.textContent=u.Constants.ZWSP),L.push(document.createTextNode(e.textContent))):(i&&"remove"===i.type&&(e.style.color="",e.style.webkitTextFillColor="",e.style.webkitTextStroke="",e.style.textShadow="",e.style.backgroundColor=""),0===n&&g&&3!==g.nodeType&&(0,_.isArrayEqual)(s,g.getAttribute("data-type").split(" "))&&(0,a.hasSameTextStyle)(e,g,i)?(f=g.textContent.length,g.innerHTML=g.innerHTML+e.innerHTML):n===C.childNodes.length-1&&y&&3!==y.nodeType&&(0,_.isArrayEqual)(s,y.getAttribute("data-type").split(" "))&&(0,a.hasSameTextStyle)(e,y,i)?(h=e.textContent.length,y.innerHTML=e.innerHTML+y.innerHTML):(""===e.textContent&&(e.textContent=u.Constants.ZWSP),e.setAttribute("data-type",s.join(" ")),L.push(e)))}else""===e.textContent&&(e.textContent=u.Constants.ZWSP),L.push(e)}))}else if(this.element.classList.contains("fn__none")||"text"===t||this.element.querySelector(`[data-type="${t}"]`).classList.add("protyle-toolbar__item--current"),""===m){const e=document.createElement("span");d.push(t),e.setAttribute("data-type",[...new Set(d)].join(" ")),e.textContent=u.Constants.ZWSP,L.push(e)}else C.childNodes.forEach(((e,n)=>{if(3===e.nodeType)if(0===n&&g&&3!==g.nodeType&&t===g.getAttribute("data-type")&&(0,a.hasSameTextStyle)(e,g,i))f=g.textContent.length,g.innerHTML=g.innerHTML+e.textContent;else if(n===C.childNodes.length-1&&y&&3!==y.nodeType&&t===y.getAttribute("data-type")&&(0,a.hasSameTextStyle)(e,y,i))h=e.textContent.length,y.innerHTML=e.textContent+y.innerHTML;else{const n=document.createElement("span");n.setAttribute("data-type",t),n.textContent=e.textContent,(0,a.setFontStyle)(n,i),L.push(n)}else{let s=(e.getAttribute("data-type")||"").split(" ");s.push(t),"sub"===t&&s.includes("sup")?s.find(((e,t)=>{if("sup"===e)return s.splice(t,1),this.element.classList.contains("fn__none")||this.element.querySelector('[data-type="sup"]').classList.remove("protyle-toolbar__item--current"),!0})):"sup"===t&&s.includes("sub")&&s.find(((e,t)=>{if("sub"===e)return s.splice(t,1),this.element.classList.contains("fn__none")||this.element.querySelector('[data-type="sub"]').classList.remove("protyle-toolbar__item--current"),!0})),s=[...new Set(s)],0===n&&g&&3!==g.nodeType&&(0,_.isArrayEqual)(s,g.getAttribute("data-type").split(" "))&&(0,a.hasSameTextStyle)(e,g,i)?(f=g.textContent.length,g.innerHTML=g.innerHTML+e.innerHTML):n===C.childNodes.length-1&&y&&3!==y.nodeType&&(0,_.isArrayEqual)(s,y.getAttribute("data-type").split(" "))&&(0,a.hasSameTextStyle)(e,y,i)?(h=e.textContent.length,y.innerHTML=e.innerHTML+y.innerHTML):"BR"!==e.tagName?(e.setAttribute("data-type",s.join(" ")),(0,a.setFontStyle)(e,i),L.push(e)):L.push(e)}}));if(3!==this.range.startContainer.nodeType&&"SPAN"===this.range.startContainer.tagName&&this.range.startContainer.isSameNode(this.range.endContainer)){const e=this.range.startContainer,t=document.createElement("span"),n=e.attributes;for(let e=0;e<n.length;e++)t.setAttribute(n[e].name,n[e].value);this.range.setEnd(e.lastChild,e.lastChild.textContent.length),t.append(this.range.extractContents()),e.after(t),this.range.setStartBefore(t),this.range.collapse(!0)}for(let e=0;e<L.length;e++){const t=L[e],n=L[e+1];3!==t.nodeType&&n&&3!==n.nodeType&&(0,_.isArrayEqual)(n.getAttribute("data-type").split(" "),t.getAttribute("data-type").split(" "))&&t.style.color===n.style.color&&t.style.webkitTextFillColor===n.style.webkitTextFillColor&&t.style.webkitTextStroke===n.style.webkitTextStroke&&t.style.textShadow===n.style.textShadow&&t.style.backgroundColor===n.style.backgroundColor?(n.innerHTML=t.innerHTML+n.innerHTML,L.splice(e,1),e--):(this.range.insertNode(L[e]),this.range.collapse(!1))}if(g&&this.mergeNode(g.childNodes),y&&this.mergeNode(y.childNodes),f?this.range.setStart(g.firstChild,f):L.length>0?L[0].firstChild?this.range.setStart(L[0].firstChild,0):3===L[0].nodeType?this.range.setStart(L[0],0):this.range.setStartBefore(L[0]):y&&this.range.setStart(y.firstChild,0),h)this.range.setEnd(y.lastChild,h);else if(L.length>0){const e=L[L.length-1];e.lastChild?this.range.setEnd(e.lastChild,e.lastChild.textContent.length):3===e.nodeType?(this.range.setEnd(e,e.textContent.length),e.textContent===u.Constants.ZWSP&&this.range.collapse(!1)):this.range.setEndAfter(e)}else g&&this.range.setEnd(g.firstChild,g.firstChild.textContent.length);r.setAttribute("updated",E().format("YYYYMMDDHHmmss")),(0,c.updateTransaction)(e,r.getAttribute("data-node-id"),r.outerHTML,k);const S=r.querySelector("wbr");S&&S.remove()}showFileAnnotationRef(e,t){const n=(0,l.hasClosestBlock)(t);if(!n)return;const i=n.getAttribute("data-node-id");let a=n.outerHTML;this.subElement.style.width=(0,_.isMobile)()?"80vw":Math.min(480,window.innerWidth)+"px",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="b3-form__space--small">\n<label class="fn__flex">\n    <span class="ft__on-surface fn__flex-center" style="width: 64px">ID</span>\n    <div class="fn__space"></div>\n    <input data-type="id" value="${t.getAttribute("data-id")||""}" class="b3-text-field fn__block" readonly />\n</label>\n<div class="fn__hr"></div>\n<label class="fn__flex">\n    <span class="ft__on-surface fn__flex-center" style="width: 64px">${window.siyuan.languages.anchor}</span>\n    <div class="fn__space"></div>\n    <input data-type="anchor" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.anchor}" />\n</label>\n<div class="fn__hr"></div>\n<div class="fn__hr"></div>\n<div class="fn__flex"><span class="fn__flex-1"></span>\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.remove}</button>\n</div></div>`,this.subElement.querySelector(".b3-button--cancel").addEventListener((0,p.getEventName)(),(()=>{t.insertAdjacentHTML("afterend","<wbr>");const a=n.outerHTML;t.outerHTML=t.textContent,n.setAttribute("updated",E().format("YYYYMMDDHHmmss")),(0,c.updateTransaction)(e,i,n.outerHTML,a),this.subElement.classList.add("fn__none"),(0,o.focusByWbr)(n,this.range)}));const s=this.subElement.querySelector('[data-type="anchor"]');s.value=t.textContent,s.addEventListener("change",(s=>{t.after(document.createElement("wbr")),n.setAttribute("updated",E().format("YYYYMMDDHHmmss")),(0,c.updateTransaction)(e,i,n.outerHTML,a),a=n.outerHTML,n.querySelector("wbr").remove(),s.stopPropagation()})),s.addEventListener("input",(e=>{const n=e.target;n.value?t.innerHTML=Lute.EscapeHTMLStr(n.value):t.innerHTML="*",e.stopPropagation()})),s.addEventListener("keydown",(e=>{e.stopPropagation(),e.isComposing||"Enter"!==e.key&&"Escape"!==e.key||(this.subElement.classList.add("fn__none"),this.range.setStart(t.firstChild,0),this.range.setEnd(t.lastChild,t.lastChild.textContent.length),(0,o.focusByRange)(this.range),e.preventDefault(),e.stopPropagation())})),this.subElement.classList.remove("fn__none");const r=t.getBoundingClientRect();(0,d.setPosition)(this.subElement,r.left,r.bottom,r.height+4),this.element.classList.add("fn__none"),s.select()}showRender(e,t,n){var i;const a=(0,l.hasClosestBlock)(t);if(!a)return;const s=a.getAttribute("data-node-id"),r=t.getAttribute("data-type");let p=e.lute.SpinBlockDOM(a.outerHTML),m="HTML",g="";const b=r&&r.split(" ").includes("inline-memo");switch(t.getAttribute("data-subtype")){case"abc":m=window.siyuan.languages.staff;break;case"echarts":m=window.siyuan.languages.chart;break;case"flowchart":m="Flow Chart";break;case"graphviz":m="Graphviz";break;case"mermaid":m="Mermaid";break;case"mindmap":g="- foo\n  - bar\n- baz",m=window.siyuan.languages.mindmap;break;case"plantuml":m="UML";break;case"math":m="NodeMathBlock"===r?window.siyuan.languages.math:window.siyuan.languages["inline-math"]}"NodeBlockQueryEmbed"===r?m=window.siyuan.languages.blockEmbed:b&&(m=window.siyuan.languages.memo);const f=null===(i=this.subElement.querySelector('[data-type="pin"]'))||void 0===i?void 0:i.classList.contains("block__icon--active"),h={};if(f){const e=this.subElement.querySelector(".b3-text-field");h.styleH=e.style.height,h.styleW=e.style.width}else this.subElement.style.width=(0,_.isMobile)()?"100vw":"",this.subElement.style.padding="0";this.subElement.innerHTML=`<div ${f&&"true"===this.subElement.firstElementChild.getAttribute("data-drag")?'data-drag="true"':""} class="block__popover--move"><div class="block__icons block__icons--border fn__flex">\n    ${m}\n    <span class="fn__flex-1"></span>\n    <label aria-label="${window.siyuan.languages.hideHeadingBelowBlocks}" style="overflow:inherit;" class="b3-tooltips b3-tooltips__nw${"NodeBlockQueryEmbed"!==r?" fn__none":""}">\n        <input type="checkbox" class="b3-switch">\n        <span class="fn__space"></span>\n    </label>\n    <button data-type="refresh" class="block__icon b3-tooltips b3-tooltips__nw${f&&!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active")?"":" block__icon--active"}${"NodeBlockQueryEmbed"===r?" fn__none":""}" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href="#iconRefresh"></use></svg></button>\n    <span class="fn__space"></span>\n    <button data-type="before" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages["insert-before"]}"><svg><use xlink:href="#iconBefore"></use></svg></button>\n    <span class="fn__space"></span>\n    <button data-type="after" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages["insert-after"]}"><svg><use xlink:href="#iconAfter"></use></svg></button>\n    <span class="fn__space"></span>\n    <button data-type="copy" class="block__icon b3-tooltips b3-tooltips__nw${(0,_.isBrowser)()||b?" fn__none":""}" aria-label="${window.siyuan.languages.copy} PNG"><svg><use xlink:href="#iconCopy"></use></svg></button>\n    <span class="fn__space"></span>\n    <button data-type="pin" class="block__icon b3-tooltips b3-tooltips__nw${f?" block__icon--active":""}" aria-label="${window.siyuan.languages.pin}"><svg><use xlink:href="#iconPin"></use></svg></button>\n    <span class="fn__space"></span>\n    <button data-type="close" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.close}"><svg style="width: 10px"><use xlink:href="#iconClose"></use></svg></button>\n</div>\n<textarea spellcheck="false" class="b3-text-field b3-text-field--text fn__block" placeholder="${g}" style="width:${(0,_.isMobile)()?"100vw":Math.max(480,.7*t.clientWidth)+"px"};max-height:50vh"></textarea></div>`;const x=()=>{T.style.height=T.scrollHeight+"px",(0,_.isMobile)()?(0,d.setPosition)(this.subElement,0,0):"true"!==this.subElement.firstElementChild.getAttribute("data-drag")?this.subElement.clientHeight<=window.innerHeight-M.bottom||this.subElement.clientHeight<=M.top?"inline-math"===r||b?(0,d.setPosition)(this.subElement,M.left,M.bottom,M.height):(0,d.setPosition)(this.subElement,M.left+(M.width-this.subElement.clientWidth)/2,M.bottom,M.height):(0,d.setPosition)(this.subElement,M.right,M.bottom):T.getBoundingClientRect().bottom>window.innerHeight&&(this.subElement.style.top=window.innerHeight-this.subElement.clientHeight+"px")},L=this.subElement.querySelector(".block__icons");L.addEventListener("click",(t=>{const n=t.target,i=(0,l.hasClosestByClassName)(n,"b3-tooltips");if(i)switch(t.stopPropagation(),i.getAttribute("data-type")){case"close":this.subElement.classList.add("fn__none"),this.subElement.querySelector('[data-type="pin"]').classList.remove("block__icon--active");break;case"pin":i.classList.contains("block__icon--active")?(i.classList.remove("block__icon--active"),i.setAttribute("aria-label",window.siyuan.languages.pin)):(i.classList.add("block__icon--active"),i.setAttribute("aria-label",window.siyuan.languages.unpin));break;case"refresh":i.classList.toggle("block__icon--active");break;case"before":(0,k.insertEmptyBlock)(e,"beforebegin",s),(0,S.hideElements)(["util"],e);break;case"after":(0,k.insertEmptyBlock)(e,"afterend",s),(0,S.hideElements)(["util"],e)}else if(2===t.detail){const e=L.querySelector('[data-type="pin"]');e.classList.contains("block__icon--active")?(e.classList.remove("block__icon--active"),e.setAttribute("aria-label",window.siyuan.languages.pin)):(e.classList.add("block__icon--active"),e.setAttribute("aria-label",window.siyuan.languages.unpin)),t.preventDefault(),t.stopPropagation()}})),L.addEventListener("mousedown",(e=>{if((0,l.hasClosestByClassName)(e.target,"block__icon"))return;const t=document;this.subElement.style.userSelect="none";const n=e.clientX-parseInt(this.subElement.style.left),i=e.clientY-parseInt(this.subElement.style.top);t.onmousemove=e=>{let t=e.clientX-n,a=e.clientY-i;t>window.innerWidth-this.subElement.clientWidth&&(t=window.innerWidth-this.subElement.clientWidth),a>window.innerHeight-this.subElement.clientHeight&&(a=window.innerHeight-this.subElement.clientHeight),this.subElement.style.left=Math.max(t,0)+"px",this.subElement.style.top=Math.max(a,u.Constants.SIZE_TOOLBAR_HEIGHT)+"px",this.subElement.firstElementChild.setAttribute("data-drag","true")},t.onmouseup=()=>{this.subElement.style.userSelect="auto",t.onmousemove=null,t.onmouseup=null,t.ondragstart=null,t.onselectstart=null,t.onselect=null}}));const T=this.subElement.querySelector(".b3-text-field");if("NodeHTMLBlock"===r)T.value=Lute.UnEscapeHTMLStr(t.querySelector("protyle-html").getAttribute("data-content")||"");else if(b)T.value=Lute.UnEscapeHTMLStr(t.getAttribute("data-inline-memo-content")||"");else{const n=this.subElement.querySelector(".b3-switch");"1"===a.getAttribute("custom-heading-mode")&&(n.checked=!0),n.addEventListener("change",(()=>{(0,S.hideElements)(["util"],e),a.setAttribute("custom-heading-mode",n.checked?"1":"0"),(0,v.fetchPost)("/api/attr/setBlockAttrs",{id:s,attrs:{"custom-heading-mode":n.checked?"1":"0"}}),t.removeAttribute("data-render"),(0,w.blockRender)(e,t)})),T.value=Lute.UnEscapeHTMLStr(t.getAttribute("data-content")||"")}T.addEventListener("input",(e=>{if(!t.parentElement)return;if(T.clientHeight!==T.scrollHeight&&x(),!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active"))return;const n=e.target;"NodeHTMLBlock"===r?t.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(n.value)):b?t.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(n.value)):(t.setAttribute("data-content",Lute.EscapeHTMLStr(n.value)),t.removeAttribute("data-render")),["NodeBlockQueryEmbed","NodeHTMLBlock"].includes(r)||(0,y.processRender)(t),e.stopPropagation()})),T.addEventListener("change",(i=>{if(!t.parentElement)return;const l=i.target;if(this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active")||("NodeHTMLBlock"===r?t.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(l.value)):(t.setAttribute("data-content",Lute.EscapeHTMLStr(l.value)),t.removeAttribute("data-render")),["NodeBlockQueryEmbed","NodeHTMLBlock"].includes(r)||(0,y.processRender)(t)),b){let e;e=n||[t],e.forEach(((t,n)=>{if(l.value)t.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(l.value));else{const i=t.getAttribute("data-type").split(" ");1===i.length&&"inline-memo"===i[0]?(t.outerHTML=t.innerHTML+(n===e.length-1?"<wbr>":""),(0,o.focusByWbr)(a,this.range)):(i.find(((e,t)=>{if("inline-memo"===e)return i.splice(t,1),!0})),t.setAttribute("data-type",i.join(" ")),t.removeAttribute("data-inline-memo-content"))}}))}else"NodeBlockQueryEmbed"===r&&(0,w.blockRender)(e,t);this.range&&(0,o.focusByRange)(this.range),"inline-math"===r&&t.setAttribute("data-content",t.getAttribute("data-content").replace(/\n/g,"")),a.setAttribute("updated",E().format("YYYYMMDDHHmmss"));const d=e.lute.SpinBlockDOM(a.outerHTML);if("NodeHTMLBlock"===r){const e=document.createElement("template");e.innerHTML=d,e.content.childElementCount>1&&(0,H.showMessage)(window.siyuan.languages.htmlBlockTip)}(0,c.updateTransaction)(e,s,d,p),p=d,b&&!l.value&&this.subElement.classList.add("fn__none"),i.stopPropagation()})),T.addEventListener("keydown",(e=>{if(e.stopPropagation(),(0,C.matchHotKey)(window.siyuan.config.keymap.editor.insert["inline-math"].custom,e))e.preventDefault();else if(!e.isComposing)if("Escape"===e.key||(0,C.matchHotKey)("⌘↩",e))this.subElement.classList.add("fn__none"),this.subElement.querySelector('[data-type="pin"]').classList.remove("block__icon--active"),"SPAN"===t.tagName?"inline-memo"!==r||T.value?(0,o.focusByRange)(this.range):(t.outerHTML=t.innerHTML+"<wbr>",(0,o.focusByWbr)(a,this.range)):(0,o.focusSideBlock)(t);else if("Tab"===e.key)document.execCommand("insertText",!1,"\t"),e.preventDefault();else if((0,A.electronUndo)(e))return})),this.subElement.classList.remove("fn__none");const M=t.getBoundingClientRect();this.element.classList.add("fn__none"),f?(T.style.width=h.styleW,T.style.height=h.styleH):x(),T.select()}showCodeLanguage(e,t){const n=(0,l.hasClosestBlock)(t);if(!n)return;this.range=(0,o.getEditorRange)(n);const i=n.getAttribute("data-node-id");let a=n.outerHTML,s="";u.Constants.CODE_LANGUAGES.forEach(((e,t)=>{s+=`<div class="b3-list-item${0===t?" b3-list-item--focus":""}">${e}</div>`})),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh"><input placeholder="${window.siyuan.languages.search}" style="margin: 4px 8px 8px 8px" class="b3-text-field"/>\n<div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${s}</div>\n</div>`;const r=this.subElement.querySelector("input");r.addEventListener("keydown",(s=>{if(s.stopPropagation(),!s.isComposing){if((0,m.upDownHint)(this.subElement.lastElementChild.lastElementChild,s),"Enter"===s.key){t.textContent=this.subElement.querySelector(".b3-list-item--focus").textContent,localStorage.setItem(u.Constants.LOCAL_CODELANG,t.textContent);const o=(0,b.getContenteditableElement)(n),l=n.getAttribute("linenumber");"true"===l||"false"!==l&&window.siyuan.config.editor.codeSyntaxHighlightLineNum?o.classList.add("protyle-linenumber"):o.classList.remove("protyle-linenumber"),o.textContent=o.textContent,o.removeAttribute("data-render"),(0,g.highlightRender)(n),n.setAttribute("updated",E().format("YYYYMMDDHHmmss")),(0,c.updateTransaction)(e,i,n.outerHTML,a),a=n.outerHTML,s.preventDefault(),s.stopPropagation()}"Escape"!==s.key&&"Enter"!==s.key||(this.subElement.classList.add("fn__none"),(0,o.focusByRange)(this.range))}})),r.addEventListener("input",(e=>{const t=[];u.Constants.CODE_LANGUAGES.forEach((e=>{e.indexOf(r.value.toLowerCase())>-1&&t.push(e)}));let n="";t.sort(((e,t)=>e.startsWith(r.value.toLowerCase())&&t.startsWith(r.value.toLowerCase())?e.length<t.length?-1:e.length===t.length?0:1:e.startsWith(r.value.toLowerCase())?-1:t.startsWith(r.value.toLowerCase())?1:0)).forEach((e=>{n+=`<div class="b3-list-item">${e.replace(r.value.toLowerCase(),"<b>"+r.value.toLowerCase()+"</b>")}</div>`})),this.subElement.firstElementChild.lastElementChild.innerHTML=n,n&&this.subElement.firstElementChild.lastElementChild.firstElementChild.classList.add("b3-list-item--focus"),e.stopPropagation()})),this.subElement.lastElementChild.lastElementChild.addEventListener("click",(n=>{const s=n.target,r=(0,l.hasClosestByClassName)(s,"b3-list-item");if(!r)return;t.textContent=r.textContent,localStorage.setItem(u.Constants.LOCAL_CODELANG,t.textContent);const d=(0,l.hasClosestBlock)(t);if(d){const t=(0,b.getContenteditableElement)(d),n=d.getAttribute("linenumber");"true"===n||"false"!==n&&window.siyuan.config.editor.codeSyntaxHighlightLineNum?t.classList.add("protyle-linenumber"):t.classList.remove("protyle-linenumber"),t.textContent=t.textContent,t.removeAttribute("data-render"),(0,g.highlightRender)(d),d.setAttribute("updated",E().format("YYYYMMDDHHmmss")),(0,c.updateTransaction)(e,i,d.outerHTML,a),a=d.outerHTML,this.subElement.classList.add("fn__none"),(0,o.focusByRange)(this.range)}})),this.subElement.classList.remove("fn__none");const p=t.getBoundingClientRect();(0,d.setPosition)(this.subElement,p.left,p.bottom,p.height),this.element.classList.add("fn__none"),r.select()}showTpl(e,t,n){this.range=n,(0,v.fetchPost)("/api/search/searchTemplate",{k:""},(i=>{let a="";i.data.blocks.forEach(((e,t)=>{a+=`<div data-value="${e.path}" class="b3-list-item${0===t?" b3-list-item--focus":""}">${e.content}</div>`})),""===a&&(a=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div style="max-height:50vh" class="fn__flex">\n<div class="fn__flex-column" style="min-width: 260px;max-width: 100vw">\n    <input style="margin: 4px 8px 8px 8px" class="b3-text-field"/>\n    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${a}</div>\n</div>\n<div style="width: 520px;${(0,_.isMobile)()?"display:none":""};overflow: auto;"></div>\n</div>`;const s=this.subElement.querySelector(".b3-list"),r=this.subElement.firstElementChild.lastElementChild;(0,M.previewTemplate)(s.firstElementChild.getAttribute("data-value"),r,e.block.parentID),s.addEventListener("mouseover",(t=>{const n=t.target,i=(0,l.hasClosestByClassName)(n,"b3-list-item");i&&(0,M.previewTemplate)(i.getAttribute("data-value"),r,e.block.parentID)}));const c=this.subElement.querySelector("input");c.addEventListener("keydown",(n=>{if(n.stopPropagation(),n.isComposing)return;const i=!this.subElement.querySelector(".b3-list-item");if(!i){const t=(0,m.upDownHint)(s,n);t&&(0,M.previewTemplate)(t.getAttribute("data-value"),r,e.block.parentID)}"Enter"===n.key?(i?(0,o.focusByRange)(this.range):(0,h.hintRenderTemplate)(decodeURIComponent(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-value")),e,t),this.subElement.classList.add("fn__none"),n.preventDefault()):"Escape"===n.key&&(this.subElement.classList.add("fn__none"),(0,o.focusByRange)(this.range))})),c.addEventListener("input",(t=>{t.stopPropagation(),(0,v.fetchPost)("/api/search/searchTemplate",{k:c.value},(t=>{var n;let i="";t.data.blocks.forEach(((e,t)=>{i+=`<div data-value="${e.path}" class="b3-list-item${0===t?" b3-list-item--focus":""}">${e.content}</div>`})),s.innerHTML=i||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,(0,M.previewTemplate)(null===(n=t.data.blocks[0])||void 0===n?void 0:n.path,r,e.block.parentID)}))})),this.subElement.lastElementChild.addEventListener("click",(n=>{const i=n.target;if(i.classList.contains("b3-list--empty"))return this.subElement.classList.add("fn__none"),void(0,o.focusByRange)(this.range);const a=(0,l.hasClosestByClassName)(i,"b3-list-item");a&&(0,h.hintRenderTemplate)(decodeURIComponent(a.getAttribute("data-value")),e,t)}));const p=(0,o.getSelectionPosition)(t,n);this.subElement.classList.remove("fn__none"),(0,d.setPosition)(this.subElement,p.left,p.top+18,u.Constants.SIZE_TOOLBAR_HEIGHT),this.element.classList.add("fn__none"),c.select()}))}showWidget(e,t,n){this.range=n,(0,v.fetchPost)("/api/search/searchWidget",{k:""},(i=>{let a="";i.data.blocks.forEach(((e,t)=>{a+=`<div class="b3-list-item${0===t?" b3-list-item--focus":""}">${e.content}</div>`})),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh"><input style="margin: 4px 8px 8px 8px" class="b3-text-field"/>\n<div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${a}</div>\n</div>`;const s=this.subElement.querySelector("input");s.addEventListener("keydown",(t=>{t.stopPropagation(),t.isComposing||((0,m.upDownHint)(this.subElement.lastElementChild.lastElementChild,t),"Enter"===t.key?((0,h.hintRenderWidget)(this.subElement.querySelector(".b3-list-item--focus").textContent,e),this.subElement.classList.add("fn__none"),t.preventDefault()):"Escape"===t.key&&(this.subElement.classList.add("fn__none"),(0,o.focusByRange)(this.range)))})),s.addEventListener("input",(e=>{e.stopPropagation(),(0,v.fetchPost)("/api/search/searchWidget",{k:s.value},(e=>{let t="";e.data.blocks.forEach(((e,n)=>{t+=`<div data-value="${e.path}" class="b3-list-item${0===n?" b3-list-item--focus":""}">${e.content}</div>`})),this.subElement.firstElementChild.lastElementChild.innerHTML=t}))})),this.subElement.lastElementChild.addEventListener("click",(t=>{const n=t.target,i=(0,l.hasClosestByClassName)(n,"b3-list-item");i&&(0,h.hintRenderWidget)(i.textContent,e)}));const r=(0,o.getSelectionPosition)(t,n);this.subElement.classList.remove("fn__none"),(0,d.setPosition)(this.subElement,r.left,r.top+18,u.Constants.SIZE_TOOLBAR_HEIGHT),this.element.classList.add("fn__none"),s.select()}))}showAssets(e,t,n){this.range=n,(0,v.fetchPost)("/api/search/searchAsset",{k:""},(i=>{let a="";i.data.forEach(((e,t)=>{a+=`<div data-value="${e.path}" class="b3-list-item${0===t?" b3-list-item--focus":""}">${e.hName}</div>`})),""===a&&(a=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div style="max-height:50vh" class="fn__flex">\n<div class="fn__flex-column" style="min-width: 260px;max-width: 100vw">\n    <input style="margin: 4px 8px 8px 8px" class="b3-text-field"/>\n    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${a}</div>\n</div>\n<div style="width: 260px;display: ${(0,_.isMobile)()?"none":"flex"};padding: 8px;overflow: auto;justify-content: center;align-items: center;"></div>\n</div>`;const s=this.subElement.querySelector(".b3-list");s.addEventListener("mouseover",(e=>{const t=e.target,n=(0,l.hasClosestByClassName)(t,"b3-list-item");n&&(r.innerHTML=(0,T.renderAssetsPreview)(n.getAttribute("data-value")))}));const r=this.subElement.firstElementChild.lastElementChild;r.innerHTML=(0,T.renderAssetsPreview)(s.firstElementChild.getAttribute("data-value"));const c=this.subElement.querySelector("input");c.addEventListener("keydown",(t=>{if(t.stopPropagation(),t.isComposing)return;const n=!this.subElement.querySelector(".b3-list-item");if(!n){const e=(0,m.upDownHint)(s,t);e&&(r.innerHTML=(0,T.renderAssetsPreview)(e.getAttribute("data-value")))}"Enter"===t.key?(n?(0,o.focusByRange)(this.range):(0,h.hintRenderAssets)(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-value"),e),this.subElement.classList.add("fn__none"),t.preventDefault()):"Escape"===t.key&&(this.subElement.classList.add("fn__none"),(0,o.focusByRange)(this.range))})),c.addEventListener("input",(e=>{e.stopPropagation(),(0,v.fetchPost)("/api/search/searchAsset",{k:c.value},(e=>{let t="";e.data.forEach(((e,n)=>{t+=`<div data-value="${e.path}" class="b3-list-item${0===n?" b3-list-item--focus":""}">${e.hName}</div>`})),s.innerHTML=t||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,r.innerHTML=(0,T.renderAssetsPreview)(s.firstElementChild.getAttribute("data-value"))}))})),this.subElement.lastElementChild.addEventListener("click",(t=>{const n=t.target;if(n.classList.contains("b3-list--empty"))return this.subElement.classList.add("fn__none"),void(0,o.focusByRange)(this.range);const i=(0,l.hasClosestByClassName)(n,"b3-list-item");i&&(0,h.hintRenderAssets)(i.getAttribute("data-value"),e)}));const p=(0,o.getSelectionPosition)(t,n);this.subElement.classList.remove("fn__none"),(0,d.setPosition)(this.subElement,p.left,p.top+18,u.Constants.SIZE_TOOLBAR_HEIGHT),this.element.classList.add("fn__none"),c.select()}))}showFile(e,t,n){this.range=n,(0,v.fetchPost)("/api/filetree/searchDocs",{k:""},(i=>{let a="";i.data.forEach((e=>{"/"!==e.path&&(a+=`<div class="b3-list-item${""===a?" b3-list-item--focus":""}" data-path="${e.path}" data-box="${e.box}">\n    ${e.boxIcon?'<span class="b3-list-item__icon">'+(0,x.unicode2Emoji)(e.boxIcon)+"</span>":""}\n    <span class="b3-list-item__text">${(0,L.escapeHtml)(e.hPath)}</span>\n</div>`)})),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh"><input style="margin: 4px 8px 8px 8px" class="b3-text-field"/>\n<div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${a}</div>\n</div>`;const s=this.subElement.querySelector("input");s.addEventListener("keydown",(n=>{n.stopPropagation(),n.isComposing||((0,m.upDownHint)(this.subElement.lastElementChild.lastElementChild,n),"Enter"===n.key?((0,h.hintMoveBlock)(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-path"),t,e),n.preventDefault()):"Escape"===n.key&&(this.subElement.classList.add("fn__none"),(0,o.focusByRange)(this.range)))})),s.addEventListener("input",(e=>{e.stopPropagation(),(0,v.fetchPost)("/api/filetree/searchDocs",{k:s.value},(e=>{let t="";e.data.forEach((e=>{"/"!==e.path&&(t+=`<div class="b3-list-item${""===t?" b3-list-item--focus":""}" data-path="${e.path}" data-box="${e.box}">\n    ${e.boxIcon?'<span class="b3-list-item__icon">'+(0,x.unicode2Emoji)(e.boxIcon)+"</span>":""}\n    <span class="b3-list-item__text">${(0,L.escapeHtml)(e.hPath)}</span>\n</div>`)})),this.subElement.firstElementChild.lastElementChild.innerHTML=t}))})),this.subElement.lastElementChild.addEventListener("click",(n=>{const i=n.target,a=(0,l.hasClosestByClassName)(i,"b3-list-item");a&&(0,h.hintMoveBlock)(a.getAttribute("data-path"),t,e)}));const r=(0,o.getSelectionPosition)(t[0],n);this.subElement.classList.remove("fn__none"),(0,d.setPosition)(this.subElement,r.left,r.top+18,u.Constants.SIZE_TOOLBAR_HEIGHT),this.element.classList.add("fn__none"),s.select()}))}}},1629:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.previewTemplate=void 0;const i=n(7683);t.previewTemplate=(e,t,n)=>{e?(0,i.fetchPost)("/api/template/render",{id:n,path:e},(e=>{t.innerHTML=`<div class="protyle-wysiwyg" style="padding: 8px">${e.data.content.replace(/contenteditable="true"/g,"")}</div>`})):t.innerHTML=""}},5615:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hideElements=void 0;t.hideElements=(e,t)=>{if(t){if(e.includes("hint")&&(clearTimeout(t.hint.timeId),t.hint.element.classList.add("fn__none")),t.gutter&&e.includes("gutter")&&(t.gutter.element.classList.add("fn__none"),t.gutter.element.innerHTML="",t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach((e=>{e.classList.remove("protyle-wysiwyg--hl")}))),t.toolbar&&e.includes("toolbar")&&(t.toolbar.element.classList.add("fn__none"),t.toolbar.element.style.display=""),t.toolbar&&e.includes("util")){const e=t.toolbar.subElement.querySelector('[data-type="pin"]');(!e||e&&!e.classList.contains("block__icon--active"))&&t.toolbar.subElement.classList.add("fn__none")}e.includes("select")&&t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach((e=>{e.classList.remove("protyle-wysiwyg--select")}))}else if(e.includes("dialog"))for(let e=0;e<window.siyuan.dialogs.length;e++)window.siyuan.dialogs[e].destroy(),e--}},7994:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setPadding=t.removeLoading=t.addLoading=t.initUI=void 0;const i=n(8461),a=n(1456),s=n(9286),o=n(6400),l=n(8438);t.initUI=e=>{e.contentElement=document.createElement("div"),e.contentElement.className="protyle-content",window.siyuan.config.editor.fullWidth?e.contentElement.setAttribute("data-fullwidth","true"):e.contentElement.removeAttribute("data-fullwidth"),e.options.render.background&&e.contentElement.appendChild(e.background.element),e.options.render.title&&e.contentElement.appendChild(e.title.element),e.contentElement.appendChild(e.wysiwyg.element),e.options.action.includes(l.Constants.CB_GET_HISTORY)||(0,s.scrollEvent)(e,e.contentElement),e.element.append(e.contentElement),e.element.appendChild(e.preview.element),e.upload&&e.element.appendChild(e.upload.element),e.scroll&&e.element.appendChild(e.scroll.element),e.gutter&&e.element.appendChild(e.gutter.element),e.element.appendChild(e.hint.element),e.selectElement=document.createElement("div"),e.selectElement.className="protyle-select fn__none",e.element.appendChild(e.selectElement),e.element.appendChild(e.toolbar.element),e.element.appendChild(e.toolbar.subElement),(0,t.addLoading)(e),(0,i.setEditMode)(e,e.options.mode),document.execCommand("DefaultParagraphSeparator",!1,"p")};t.addLoading=e=>{e.element.insertAdjacentHTML("beforeend",'<div style="background-color: var(--b3-theme-background)" class="fn__loading wysiwygLoading"><img width="48px" src="/stage/loading-pure.svg"></div>')};t.removeLoading=e=>{const t=e.element.querySelector(".wysiwygLoading");t&&t.remove()};t.setPadding=e=>{if(e.options.action.includes(l.Constants.CB_GET_HISTORY))return;let t=16,n=24;if(!(0,o.isMobile)()){const i=(e.element.clientWidth-l.Constants.SIZE_EDITOR_WIDTH)/2;!window.siyuan.config.editor.fullWidth&&i>96?(t=i,n=i):e.element.clientWidth>l.Constants.SIZE_EDITOR_WIDTH&&(t=96,n=96)}e.options.render.background&&e.options.render.title?(e.background.element.lastElementChild.setAttribute("style",`left:${t}px`),e.title.element.style.margin=`16px ${t}px 0 ${n}px`):e.options.render.background&&!e.options.render.title?e.background.element.lastElementChild.setAttribute("style",`left:${t}px`):!e.options.render.background&&e.options.render.title&&(e.title.element.style.margin=`16px ${t}px 0 ${n}px`);let i="16px";if(e.options.typewriterMode&&(i=(0,o.isMobile)()?window.innerHeight/5+"px":e.element.clientHeight/2+"px"),e.wysiwyg.element.style.padding=`16px ${t}px ${i} ${n}px`,(0,o.isMobile)()||(window.siyuan.config.editor.fullWidth?(e.wysiwyg.element.style.width="",e.options.render.title&&(e.title.element.style.width="")):(e.wysiwyg.element.style.width=e.element.clientWidth-10+"px",e.options.render.title&&(e.title.element.style.width=e.element.clientWidth-t-n-10+"px"))),window.siyuan.config.editor.codeSyntaxHighlightLineNum&&setTimeout((()=>{e.wysiwyg.element.querySelectorAll('.code-block [contenteditable="true"]').forEach((e=>{(0,a.lineNumberRender)(e)}))}),300),window.siyuan.config.editor.displayBookmarkIcon){const i=document.getElementById("editorAttr");i&&(i.innerHTML=`.protyle-wysiwyg--attr .b3-tooltips:after { max-width: ${e.wysiwyg.element.clientWidth-t-n}px; }`)}}},3242:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setCodeTheme=void 0;const i=n(8438),a=n(9632);t.setCodeTheme=(e=i.Constants.PROTYLE_CDN)=>{const t=document.getElementById("protyleHljsStyle");let n;0===window.siyuan.config.appearance.mode?(n=window.siyuan.config.appearance.codeBlockThemeLight,i.Constants.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE.includes(n)||(n="default")):(n=window.siyuan.config.appearance.codeBlockThemeDark,i.Constants.SIYUAN_CONFIG_APPEARANCE_DARK_CODE.includes(n)||(n="github-dark"));const s=`${e}/js/highlight.js/styles/${n}.min.css?v=11.5.0`;t?t.href.includes(s)||(t.remove(),(0,a.addStyle)(s,"protyleHljsStyle")):(0,a.addStyle)(s,"protyleHljsStyle")}},4433:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.electronUndo=t.Undo=void 0;const i=n(1985),a=n(5788),s=n(8438),o=n(5615),l=n(5449);t.Undo=class{constructor(){this.hasUndo=!1,this.redoStack=[],this.undoStack=[]}undo(e){if(e.disabled)return;if(0===this.undoStack.length)return;const t=this.undoStack.pop();this.render(e,t,!1),this.hasUndo=!0,this.redoStack.push(t)}redo(e){if(e.disabled)return;if(0===this.redoStack.length)return;const t=this.redoStack.pop();this.render(e,t,!0),this.undoStack.push(t)}render(e,t,n){(0,o.hideElements)(["hint"],e),e.wysiwyg.lastHTMLs={},n?(t.doOperations.forEach((t=>{(0,i.onTransaction)(e,t,!0)})),(0,i.transaction)(e,t.doOperations)):(t.undoOperations.forEach((t=>{(0,i.onTransaction)(e,t,!0)})),(0,i.transaction)(e,t.undoOperations)),(0,a.preventScroll)(e),(0,l.scrollCenter)(e)}replace(e){this.undoStack.length>0&&(this.undoStack[this.undoStack.length-1].doOperations=e)}add(e,t){this.undoStack.push({undoOperations:t,doOperations:e}),this.undoStack.length>s.Constants.SIZE_UNDO&&this.undoStack.shift(),this.hasUndo&&(this.redoStack=[],this.hasUndo=!1)}clear(){this.undoStack=[],this.redoStack=[]}};t.electronUndo=e=>!1},562:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uploadFiles=t.uploadLocalFiles=t.Upload=void 0;const i=n(8469),a=n(7491),s=n(8438),o=n(5062),l=n(7683),r=n(2386),d=n(9883);t.Upload=class{constructor(){this.isUploading=!1,this.element=document.createElement("div"),this.element.className="protyle-upload"}};const c=(e,t)=>{const n=JSON.parse(e);let o="";1===n.code&&(o=`${n.msg}`),n.data.errFiles&&n.data.errFiles.length>0&&(o=`<ul><li>${o}</li>`,n.data.errFiles.forEach((e=>{const n=e.lastIndexOf("."),i=-1===n?e:t.options.upload.filename(e.substr(0,n))+e.substr(n);o+=`<li>${i} ${window.siyuan.languages.uploadError}</li>`})),o+="</ul>"),o&&(0,a.showMessage)(o);let l="";const c=Object.keys(n.data.succMap);c.forEach(((e,i)=>{const a=n.data.succMap[e],o=(0,d.pathPosix)().extname(e).toLowerCase(),r=t.options.upload.filename(e);s.Constants.SIYUAN_ASSETS_AUDIO.includes(o)?l+=`<audio controls="controls" src="${a}"></audio>`:s.Constants.SIYUAN_ASSETS_IMAGE.includes(o)?l+=`![${r.substring(0,r.length-o.length)}](${a})`:s.Constants.SIYUAN_ASSETS_VIDEO.includes(o)?l+=`<video controls="controls" src="${a}"></video>`:l+=`[${r}](${a})`,c.length-1!==i&&(l+="\n")}));const u=(0,r.getEditorRange)(t.wysiwyg.element);!l.startsWith("<")&&""===u.toString()&&3===u.startContainer.nodeType&&t.toolbar.getCurrentType(u).length>0&&(u.setEndAfter(u.startContainer.parentElement),u.collapse(!1)),(0,i.insertHTML)(t.lute.SpinBlockDOM(l),t)};t.uploadLocalFiles=(e,t)=>{const n=(0,a.showMessage)(window.siyuan.languages.uploading,0);(0,l.fetchPost)("/api/asset/insertLocalAssets",{assetPaths:e,id:t.block.rootID},(e=>{(0,a.hideMessage)(n),c(JSON.stringify(e),t)}))};t.uploadFiles=(e,t,n,i)=>{let s=[];for(let e=0;e<t.length;e++){let n=t[e];n instanceof DataTransferItem&&(n=n.getAsFile()),0===n.size&&""===n.type&&-1===n.name.indexOf(".")?document.execCommand("insertHTML",!1,`[${n.name}](file://${n.path})`):s.push(n)}if(e.options.upload.handler){const t=e.options.upload.handler(s);return"string"==typeof t?void(0,a.showMessage)(t):void 0}if(!e.options.upload.url||!e.upload)return n&&(n.value=""),void(0,a.showMessage)("please config: options.upload.url");if(e.options.upload.file&&(s=e.options.upload.file(s)),e.options.upload.validate){const t=e.options.upload.validate(s);if("string"==typeof t)return void(0,a.showMessage)(t)}const l=e.wysiwyg.element,r=((e,t)=>{const n=[];let i,s="",o="";for(let i=t.length,a=0;a<i;a++){const i=t[a];let l=!0;i.name||(s+=`<li>${window.siyuan.languages.nameEmpty}</li>`,l=!1),i.size>e.options.upload.max&&(s+=`<li>${i.name} ${window.siyuan.languages.over} ${e.options.upload.max/1024/1024}M</li>`,l=!1);const r=i.name.lastIndexOf("."),d=-1===r?"":i.name.substr(r),c=-1===r?i.name:e.options.upload.filename(i.name.substr(0,r))+d;e.options.upload.accept&&(e.options.upload.accept.split(",").some((e=>{const t=e.trim();if(0===t.indexOf(".")){if(d.toLowerCase()===t.toLowerCase())return!0}else if(i.type.split("/")[0]===t.split("/")[0])return!0;return!1}))||(s+=`<li>${i.name} ${window.siyuan.languages.fileTypeError}</li>`,l=!1)),l&&(n.push(i),o+=`<li>${c} ${window.siyuan.languages.uploading}</li>`)}return""===s&&""===o||(i=(0,a.showMessage)(`<ul>${s}${o}</ul>`)),{files:n,msgId:i}})(e,s);if(0===r.files.length)return void(n&&(n.value=""));const d=new FormData,u=e.options.upload.extraData;for(const e of Object.keys(u))d.append(e,u[e]);for(let t=0,n=r.files.length;t<n;t++)d.append(e.options.upload.fieldName,r.files[t]);d.append("id",e.block.rootID);const p=new XMLHttpRequest;p.open("POST",e.options.upload.url),e.options.upload.token&&p.setRequestHeader("X-Upload-Token",e.options.upload.token),e.options.upload.withCredentials&&(p.withCredentials=!0),e.upload.isUploading=!0,p.onreadystatechange=()=>{if(p.readyState===XMLHttpRequest.DONE){if(e.upload.isUploading=!1,!document.body.contains(e.element))return void(0,o.destroy)(e);if(200===p.status)if((0,a.hideMessage)(r.msgId),e.options.upload.success)e.options.upload.success(l,p.responseText);else if(i)i(p.responseText);else{let n=p.responseText;e.options.upload.format&&(n=e.options.upload.format(t,p.responseText)),c(n,e)}else 0===p.status?(0,a.showMessage)(window.siyuan.languages.fileTypeError):e.options.upload.error?e.options.upload.error(p.responseText):(0,a.showMessage)(p.responseText);n&&(n.value=""),e.upload.element.style.display="none"}},p.upload.onprogress=t=>{if(!t.lengthComputable)return;const n=t.loaded/t.total*100;e.upload.element.style.display="block";e.upload.element.style.width=n+"%"},p.send(d)}},3218:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Options=void 0;const i=n(8438),a=n(1025),s=n(4659),o=n(6400);t.Options=class{constructor(e){this.defaultOptions={mode:"wysiwyg",blockId:"",render:{background:!1,title:!1,gutter:!0,scroll:!1,breadcrumb:!0,breadcrumbDocName:!1,breadcrumbContext:!1},after:void 0,classes:{preview:""},debugger:"development"===i.Constants.NODE_ENV,hint:{delay:200,emoji:{"+1":"👍","-1":"👎",confused:"😕",eyes:"👀️",heart:"❤️",rocket:"🚀️",smile:"😄",tada:"🎉️"},emojiPath:"/emojis",extend:[{key:"((",hint:s.hintRef},{key:"【【",hint:s.hintRef},{key:"（（",hint:s.hintRef},{key:"[[",hint:s.hintRef},{key:"{{",hint:s.hintEmbed},{key:"「「",hint:s.hintEmbed},{key:"#",hint:s.hintTag},{key:"/",hint:s.hintSlash},{key:"、",hint:s.hintSlash},{key:":"}]},lang:window.siyuan.config.appearance.lang,preview:{actions:["desktop","tablet","mobile","mp-wechat","zhihu","yuque"],delay:1e3,markdown:{paragraphBeginningSpace:window.siyuan.config.export.paragraphBeginningSpace,listStyle:!1,sanitize:!0},mode:"both"},toolbar:(0,o.isMobile)()?["block-ref","a","|","strong","em","u","s","mark","|","tag","code","inline-math","|","inline-memo","text"]:["block-ref","a","|","strong","em","u","s","mark","|","sup","sub","kbd","|","tag","code","inline-math","|","inline-memo","text"],typewriterMode:!1,upload:{max:4294967296,url:i.Constants.UPLOAD_ADDRESS,extraData:{},fieldName:"file[]",filename:e=>e.replace(/[\\/:*?"'<>|]/g,""),linkToImgUrl:"",withCredentials:!1}},this.options=e}merge(){var e;return this.options&&(this.options.toolbar?this.options.toolbar=this.mergeToolbar(this.options.toolbar):this.options.toolbar=this.mergeToolbar(this.defaultOptions.toolbar),(null===(e=this.options.hint)||void 0===e?void 0:e.emoji)&&(this.defaultOptions.hint.emoji=this.options.hint.emoji)),(0,a.merge)(this.defaultOptions,this.options)}mergeToolbar(e){const t=[{name:"block-ref",hotkey:window.siyuan.config.keymap.editor.insert.blockRef.custom,lang:"blockRef",icon:"iconGraph",tipPosition:"ne"},{name:"a",hotkey:window.siyuan.config.keymap.editor.insert.link.custom,lang:"link",icon:"iconLink",tipPosition:"n"},{name:"strong",lang:"bold",hotkey:window.siyuan.config.keymap.editor.insert.bold.custom,icon:"iconBold",tipPosition:"n"},{name:"em",lang:"italic",hotkey:window.siyuan.config.keymap.editor.insert.italic.custom,icon:"iconItalic",tipPosition:"n"},{name:"u",lang:"underline",hotkey:window.siyuan.config.keymap.editor.insert.underline.custom,icon:"iconUnderline",tipPosition:"n"},{name:"s",lang:"strike",hotkey:window.siyuan.config.keymap.editor.insert.strike.custom,icon:"iconStrike",tipPosition:"n"},{name:"mark",lang:"mark",hotkey:window.siyuan.config.keymap.editor.insert.mark.custom,icon:"iconMark",tipPosition:"n"},{name:"sup",lang:"sup",hotkey:window.siyuan.config.keymap.editor.insert.sup.custom,icon:"iconSup",tipPosition:"n"},{name:"sub",lang:"sub",hotkey:window.siyuan.config.keymap.editor.insert.sub.custom,icon:"iconSub",tipPosition:"n"},{name:"kbd",lang:"kbd",hotkey:window.siyuan.config.keymap.editor.insert.kbd.custom,icon:"iconKeymap",tipPosition:"n"},{name:"tag",lang:"tag",hotkey:window.siyuan.config.keymap.editor.insert.tag.custom,icon:"iconTags",tipPosition:"n"},{name:"code",lang:"inline-code",hotkey:window.siyuan.config.keymap.editor.insert["inline-code"].custom,icon:"iconInlineCode",tipPosition:"n"},{name:"inline-math",lang:"inline-math",hotkey:window.siyuan.config.keymap.editor.insert["inline-math"].custom,icon:"iconMath",tipPosition:"n"},{name:"inline-memo",lang:"memo",hotkey:window.siyuan.config.keymap.editor.insert.memo.custom,icon:"iconM",tipPosition:"n"},{name:"text",lang:"font",hotkey:window.siyuan.config.keymap.editor.insert.font.custom,icon:"iconFont",tipPosition:"n"},{name:"|"}],n=[];return e.forEach((e=>{let i=e;t.find((t=>"string"==typeof e&&t.name===e?(i=t,!0):"object"==typeof e&&t.name===e.name?(i=Object.assign({},t,e),!0):void 0)),n.push(i)})),n}}},9580:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RecordMedia=void 0;t.RecordMedia=class{constructor(e){let t;if(this.SAMPLE_RATE=44100,this.isRecording=!1,this.readyFlag=!1,this.leftChannel=[],this.rightChannel=[],this.recordingLength=0,"undefined"!=typeof AudioContext)t=new AudioContext;else{if(!webkitAudioContext)return;t=new webkitAudioContext}this.DEFAULT_SAMPLE_RATE=t.sampleRate;const n=t.createGain();t.createMediaStreamSource(e).connect(n),this.recorder=t.createScriptProcessor(2048,2,1),this.recorder.onaudioprocess=null,n.connect(this.recorder),this.recorder.connect(t.destination),this.readyFlag=!0}cloneChannelData(e,t){this.leftChannel.push(new Float32Array(e)),this.rightChannel.push(new Float32Array(t)),this.recordingLength+=2048}startRecordingNewWavFile(){this.readyFlag&&(this.isRecording=!0,this.leftChannel.length=this.rightChannel.length=0,this.recordingLength=0)}stopRecording(){this.isRecording=!1}buildWavFileBlob(){const e=this.mergeBuffers(this.leftChannel),t=this.mergeBuffers(this.rightChannel);let n=new Float32Array(e.length);for(let i=0;i<e.length;++i)n[i]=.5*(e[i]+t[i]);this.DEFAULT_SAMPLE_RATE>this.SAMPLE_RATE&&(n=this.downSampleBuffer(n,this.SAMPLE_RATE));const i=44+2*n.length,a=new ArrayBuffer(i),s=new DataView(a);this.writeUTFBytes(s,0,"RIFF"),s.setUint32(4,i,!0),this.writeUTFBytes(s,8,"WAVE"),this.writeUTFBytes(s,12,"fmt "),s.setUint32(16,16,!0),s.setUint16(20,1,!0),s.setUint16(22,1,!0),s.setUint32(24,this.SAMPLE_RATE,!0),s.setUint32(28,2*this.SAMPLE_RATE,!0),s.setUint16(32,2,!0),s.setUint16(34,16,!0);const o=2*n.length;this.writeUTFBytes(s,36,"data"),s.setUint32(40,o,!0);const l=n.length;let r=44;for(let e=0;e<l;e++)s.setInt16(r,32767*n[e],!0),r+=2;return new Blob([s],{type:"audio/wav"})}downSampleBuffer(e,t){if(t===this.DEFAULT_SAMPLE_RATE)return e;if(t>this.DEFAULT_SAMPLE_RATE)return e;const n=this.DEFAULT_SAMPLE_RATE/t,i=Math.round(e.length/n),a=new Float32Array(i);let s=0,o=0;for(;s<a.length;){const t=Math.round((s+1)*n);let i=0,l=0;for(let n=o;n<t&&n<e.length;n++)i+=e[n],l++;a[s]=i/l,s++,o=t}return a}mergeBuffers(e){const t=new Float32Array(this.recordingLength);let n=0;const i=e.length;for(let a=0;a<i;++a){const i=e[a];t.set(i,n),n+=i.length}return t}writeUTFBytes(e,t,n){const i=n.length;for(let a=0;a<i;a++)e.setUint8(t+a,n.charCodeAt(a))}}},9173:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addScript=t.addScriptSync=void 0;t.addScriptSync=(e,t)=>{if(document.getElementById(t))return!1;const n=new XMLHttpRequest;n.open("GET",e,!1),n.setRequestHeader("Accept","text/javascript, application/javascript, application/ecmascript, application/x-ecmascript, */*; q=0.01"),n.send("");const i=document.createElement("script");i.type="text/javascript",i.text=n.responseText,i.id=t,document.head.appendChild(i)};t.addScript=(e,t)=>new Promise((n=>{if(document.getElementById(t))return n(!1),!1;const i=document.createElement("script");i.src=e,i.async=!0,document.head.appendChild(i),i.onload=()=>{if(document.getElementById(t))return i.remove(),n(!1),!1;i.id=t,n(!0)}}))},9632:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addStyle=void 0;t.addStyle=(e,t)=>{if(!document.getElementById(t)){const n=document.createElement("link");n.id=t,n.rel="stylesheet",n.type="text/css",n.href=e,document.getElementsByTagName("head")[0].appendChild(n)}}},532:function(e,t){"use strict";var n=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,s){function o(e){try{r(i.next(e))}catch(e){s(e)}}function l(e){try{r(i.throw(e))}catch(e){s(e)}}function r(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,l)}r((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.hotKey2Electron=t.updateHotkeyTip=t.isMac=t.isCtrl=t.getEventName=t.writeText=t.openByMobile=void 0;t.openByMobile=e=>{e&&("ios"===window.siyuan.config.system.container?window.location.href=e:"android"===window.siyuan.config.system.container&&window.JSAndroid?window.JSAndroid.openExternal(e):window.open(e))};t.writeText=e=>n(void 0,void 0,void 0,(function*(){var t,n;try{if("android"===window.siyuan.config.system.container&&window.JSAndroid)return void window.JSAndroid.writeClipboard(e);if("ios"===window.siyuan.config.system.container&&(null===(t=window.webkit)||void 0===t?void 0:t.messageHandlers))return void window.webkit.messageHandlers.setClipboard.postMessage(e);navigator.clipboard.writeText(e)}catch(t){if("ios"===window.siyuan.config.system.container&&(null===(n=window.webkit)||void 0===n?void 0:n.messageHandlers))window.webkit.messageHandlers.setClipboard.postMessage(e);else if("android"===window.siyuan.config.system.container&&window.JSAndroid)window.JSAndroid.writeClipboard(e);else{const t=document.createElement("textarea");t.value=e,t.style.position="fixed",document.body.appendChild(t),t.focus(),t.select(),document.execCommand("copy"),document.body.removeChild(t)}}}));t.getEventName=()=>navigator.userAgent.indexOf("iPhone")>-1?"touchstart":"click";t.isCtrl=e=>(0,t.isMac)()?!(!e.metaKey||e.ctrlKey):!(e.metaKey||!e.ctrlKey);t.isMac=()=>navigator.platform.toUpperCase().indexOf("MAC")>-1;t.updateHotkeyTip=e=>{if(/Mac/.test(navigator.platform)||"iPhone"===navigator.platform)return e;const t=new Map(Object.entries({"⌘":"Ctrl","⇧":"Shift","⌥":"Alt","⇥":"Tab","⌫":"Backspace","⌦":"Delete","↩":"Enter"})),n=new Map(Object.entries({";":":","=":"+","-":"_",".":">"})),i=[];e.indexOf("⌘")>-1&&i.push(t.get("⌘")),e.indexOf("⇧")>-1&&i.push(t.get("⇧")),e.indexOf("⌥")>-1&&i.push(t.get("⌥"));const a=e.replace(/⌘|⇧|⌥/g,"");return"⌘⇧⌥".indexOf(a)<0&&i.push(t.get(a)||e.indexOf("⇧")>-1&&n.get(a)||a),i.join("+")};t.hotKey2Electron=e=>{let t="";return e.indexOf("⌘")>-1&&(t+="CommandOrControl+"),e.indexOf("⇧")>-1&&(t+="Shift+"),e.indexOf("⌥")>-1&&(t+="Alt+"),t+e.substr(e.length-1)}},5062:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.destroy=void 0;t.destroy=e=>{if(e){e.element.classList.remove("protyle"),e.element.removeAttribute("style"),e.wysiwyg&&(e.wysiwyg.lastHTMLs={}),e.undo&&e.undo.clear();try{e.ws.send("closews",{})}catch(t){setTimeout((()=>{e.ws.send("closews",{})}),10240)}}}},4170:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,s){function o(e){try{r(i.next(e))}catch(e){s(e)}}function l(e){try{r(i.throw(e))}catch(e){s(e)}}function r(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,l)}r((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.dropEvent=void 0;const a=n(2386),s=n(7821),o=n(8438),l=n(3343),r=n(3053),d=n(1985),c=n(3903),u=n(9407),p=n(5615),m=n(2224),g=n(7683),b=n(1040),y=n(2005),f=n(4383),h=n(6259),w=n(1456),v=n(562),_=n(8469),E=(e,t,n,i,s)=>{var l,p,m,g,b,y,f;const h=e.element.contains(t[0]);let w;"NodeListItem"===t[0].getAttribute("data-type")&&"NodeListItem"!==n.getAttribute("data-type")&&(w=document.createElement("div"),w.setAttribute("data-node-id",Lute.NewNodeID()),w.setAttribute("data-type","NodeList"),w.setAttribute("data-subtype",t[0].getAttribute("data-subtype")),w.className="list",w.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${o.Constants.ZWSP}</div>`));const v=[{action:"move",id:n.getAttribute("data-node-id"),previousID:null===(l=n.previousElementSibling)||void 0===l?void 0:l.getAttribute("data-node-id"),parentID:(null===(p=n.parentElement)||void 0===p?void 0:p.getAttribute("data-node-id"))||e.block.parentID}];let _,E=t[0].parentElement;const k=(0,r.genSBElement)(s);n.parentElement.replaceChild(k,n);const C=[{action:"insert",data:k.outerHTML,id:k.getAttribute("data-node-id"),previousID:null===(m=k.previousElementSibling)||void 0===m?void 0:m.getAttribute("data-node-id"),parentID:k.parentElement.getAttribute("data-node-id")||e.block.parentID}];if(w?(k.insertAdjacentElement("afterbegin",n),C.push({action:"move",id:n.getAttribute("data-node-id"),parentID:k.getAttribute("data-node-id")}),i?(n.insertAdjacentElement("afterend",w),C.push({action:"insert",data:w.outerHTML,id:w.getAttribute("data-node-id"),previousID:n.getAttribute("data-node-id")})):(n.insertAdjacentElement("beforebegin",w),C.push({action:"insert",data:w.outerHTML,id:w.getAttribute("data-node-id"),previousID:null===(g=w.previousElementSibling)||void 0===g?void 0:g.getAttribute("data-node-id"),parentID:(null===(b=w.parentElement)||void 0===b?void 0:b.getAttribute("data-node-id"))||e.block.parentID})),t.reverse().forEach(((n,i)=>{var a;if(i===t.length-1&&(_=(0,c.getTopAloneElement)(n),_.isSameNode(n)&&(_=void 0)),v.push({action:"move",id:n.getAttribute("data-node-id"),previousID:null===(a=n.previousElementSibling)||void 0===a?void 0:a.getAttribute("data-node-id"),parentID:n.parentElement.getAttribute("data-node-id")||e.block.rootID}),!h){const t=e.wysiwyg.element.querySelector(`[data-node-id="${n.getAttribute("data-node-id")}"]`);t&&t.remove()}w.insertAdjacentElement("afterbegin",n),C.push({action:"move",id:n.getAttribute("data-node-id"),parentID:w.getAttribute("data-node-id")})})),v.reverse(),v.push({action:"delete",id:w.getAttribute("data-node-id")})):(i||(k.insertAdjacentElement("afterbegin",n),C.push({action:"move",id:n.getAttribute("data-node-id"),parentID:k.getAttribute("data-node-id")})),t.reverse().forEach(((n,i)=>{var a;if(i===t.length-1&&(_=(0,c.getTopAloneElement)(n),_.isSameNode(n)&&(_=void 0)),v.push({action:"move",id:n.getAttribute("data-node-id"),previousID:null===(a=n.previousElementSibling)||void 0===a?void 0:a.getAttribute("data-node-id"),parentID:n.parentElement.getAttribute("data-node-id")||e.block.rootID}),!h){const t=e.wysiwyg.element.querySelector(`[data-node-id="${n.getAttribute("data-node-id")}"]`);t&&t.remove()}k.insertAdjacentElement("afterbegin",n),C.push({action:"move",id:n.getAttribute("data-node-id"),parentID:k.getAttribute("data-node-id")})})),v.reverse(),i&&(k.insertAdjacentElement("afterbegin",n),C.push({action:"move",id:n.getAttribute("data-node-id"),parentID:k.getAttribute("data-node-id")}))),v.push({action:"delete",id:k.getAttribute("data-node-id")}),E&&E.classList.contains("list")&&"o"===E.getAttribute("data-subtype")&&!E.isSameNode(t[0].parentElement)&&E.childElementCount>1&&(Array.from(E.children).forEach((e=>{e.classList.contains("protyle-attr")||v.splice(0,0,{action:"update",id:e.getAttribute("data-node-id"),data:e.outerHTML})})),(0,u.updateListOrder)(E,1),Array.from(E.children).forEach((e=>{e.classList.contains("protyle-attr")||C.push({action:"update",id:e.getAttribute("data-node-id"),data:e.outerHTML})}))),_){if(C.push({action:"delete",id:_.getAttribute("data-node-id")}),v.splice(0,0,{action:"insert",data:_.outerHTML,id:_.getAttribute("data-node-id"),previousID:null===(y=_.previousElementSibling)||void 0===y?void 0:y.getAttribute("data-node-id"),parentID:(null===(f=_.parentElement)||void 0===f?void 0:f.getAttribute("data-node-id"))||e.block.parentID}),!h){const t=e.wysiwyg.element.querySelector(`[data-node-id="${_.getAttribute("data-node-id")}"]`);t&&t.remove()}E=_.parentElement,_.remove()}if(E&&E.classList.contains("sb")&&2===E.childElementCount){const t=(0,r.cancelSB)(e,E);C.push(t.doOperations[0],t.doOperations[1]),v.splice(0,0,t.undoOperations[0],t.undoOperations[1])}else E&&E.classList.contains("protyle-wysiwyg")&&E.innerHTML;h?(0,d.transaction)(e,C,v):(0,d.transaction)(e,C),(0,a.focusBlock)(t[0])},k=(e,t,n,i)=>{var s,l,p,m;const g=e.element.contains(t[0]),b=[],y=[];let f,h;"NodeListItem"===t[0].getAttribute("data-type")&&"NodeListItem"!==n.getAttribute("data-type")&&(f=document.createElement("div"),f.setAttribute("data-node-id",Lute.NewNodeID()),f.setAttribute("data-type","NodeList"),f.setAttribute("data-subtype",t[0].getAttribute("data-subtype")),f.className="list",f.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${o.Constants.ZWSP}</div>`));let w=t[0].parentElement;if(i?f?(n.insertAdjacentElement("afterend",f),b.push({action:"insert",data:f.outerHTML,id:f.getAttribute("data-node-id"),previousID:n.getAttribute("data-node-id")}),t.reverse().forEach(((n,i)=>{var a;if(i===t.length-1&&(h=(0,c.getTopAloneElement)(n),h.isSameNode(n)&&(h=void 0)),y.push({action:"move",id:n.getAttribute("data-node-id"),previousID:null===(a=n.previousElementSibling)||void 0===a?void 0:a.getAttribute("data-node-id"),parentID:n.parentElement.getAttribute("data-node-id")||e.block.rootID}),!g){const t=e.wysiwyg.element.querySelector(`[data-node-id="${n.getAttribute("data-node-id")}"]`);t&&t.remove()}f.insertAdjacentElement("afterbegin",n),b.push({action:"move",id:n.getAttribute("data-node-id"),parentID:f.getAttribute("data-node-id")})})),y.reverse(),y.push({action:"delete",id:f.getAttribute("data-node-id")})):(t.reverse().forEach(((i,a)=>{var s;if(a===t.length-1&&(h=(0,c.getTopAloneElement)(i),h.isSameNode(i)&&(h=void 0)),y.push({action:"move",id:i.getAttribute("data-node-id"),previousID:null===(s=i.previousElementSibling)||void 0===s?void 0:s.getAttribute("data-node-id"),parentID:i.parentElement.getAttribute("data-node-id")||e.block.rootID}),!g){const t=e.wysiwyg.element.querySelector(`[data-node-id="${i.getAttribute("data-node-id")}"]`);t&&t.remove()}n.insertAdjacentElement("afterend",i),b.push({action:"move",id:i.getAttribute("data-node-id"),previousID:n.getAttribute("data-node-id")})})),y.reverse()):f?(n.insertAdjacentElement("beforebegin",f),b.push({action:"insert",data:f.outerHTML,id:f.getAttribute("data-node-id"),previousID:null===(s=f.previousElementSibling)||void 0===s?void 0:s.getAttribute("data-node-id"),parentID:(null===(l=f.parentElement)||void 0===l?void 0:l.getAttribute("data-node-id"))||e.block.parentID}),t.reverse().forEach(((n,i)=>{var a;if(i===t.length-1&&(h=(0,c.getTopAloneElement)(n),h.isSameNode(n)&&(h=void 0)),y.push({action:"move",id:n.getAttribute("data-node-id"),previousID:null===(a=n.previousElementSibling)||void 0===a?void 0:a.getAttribute("data-node-id"),parentID:n.parentElement.getAttribute("data-node-id")||e.block.rootID}),!g){const t=e.wysiwyg.element.querySelector(`[data-node-id="${n.getAttribute("data-node-id")}"]`);t&&t.remove()}f.insertAdjacentElement("afterbegin",n),b.push({action:"move",id:n.getAttribute("data-node-id"),parentID:f.getAttribute("data-node-id")})})),y.reverse(),y.push({action:"delete",id:f.getAttribute("data-node-id")})):(t.forEach(((i,a)=>{var s,o,l;if(a===t.length-1&&(h=(0,c.getTopAloneElement)(i),h.isSameNode(i)&&(h=void 0)),y.push({action:"move",id:i.getAttribute("data-node-id"),previousID:null===(s=i.previousElementSibling)||void 0===s?void 0:s.getAttribute("data-node-id"),parentID:i.parentElement.getAttribute("data-node-id")||e.block.rootID}),!g){const t=e.wysiwyg.element.querySelector(`[data-node-id="${i.getAttribute("data-node-id")}"]`);t&&t.remove()}n.insertAdjacentElement("beforebegin",i),b.push({action:"move",id:i.getAttribute("data-node-id"),previousID:null===(o=i.previousElementSibling)||void 0===o?void 0:o.getAttribute("data-node-id"),parentID:(null===(l=i.parentElement)||void 0===l?void 0:l.getAttribute("data-node-id"))||e.block.parentID})})),y.reverse()),"NodeListItem"===n.getAttribute("data-type")&&"o"===n.getAttribute("data-subtype")&&(Array.from(n.parentElement.children).forEach((e=>{e.classList.contains("protyle-attr")||y.splice(0,0,{action:"update",id:e.getAttribute("data-node-id"),data:e.outerHTML})})),(0,u.updateListOrder)(n.parentElement,1),Array.from(n.parentElement.children).forEach((e=>{e.classList.contains("protyle-attr")||b.push({action:"update",id:e.getAttribute("data-node-id"),data:e.outerHTML})}))),w&&w.classList.contains("list")&&"o"===w.getAttribute("data-subtype")&&!w.isSameNode(t[0].parentElement)&&w.childElementCount>1&&(Array.from(w.children).forEach((e=>{e.classList.contains("protyle-attr")||(w.contains(n)?y.splice(0,0,{action:"update",id:e.getAttribute("data-node-id"),data:e.outerHTML}):y.splice(n.parentElement.childElementCount-1,0,{action:"update",id:e.getAttribute("data-node-id"),data:e.outerHTML}))})),(0,u.updateListOrder)(w,1),Array.from(w.children).forEach((e=>{e.classList.contains("protyle-attr")||b.push({action:"update",id:e.getAttribute("data-node-id"),data:e.outerHTML})}))),h&&(b.push({action:"delete",id:h.getAttribute("data-node-id")}),y.splice(0,0,{action:"insert",data:h.outerHTML,id:h.getAttribute("data-node-id"),previousID:null===(p=h.previousElementSibling)||void 0===p?void 0:p.getAttribute("data-node-id"),parentID:(null===(m=h.parentElement)||void 0===m?void 0:m.getAttribute("data-node-id"))||e.block.parentID}),w=h.parentElement,h.remove(),!g)){const t=e.wysiwyg.element.querySelector(`[data-node-id="${h.getAttribute("data-node-id")}"]`);t&&t.remove()}if(w&&w.classList.contains("sb")&&2===w.childElementCount){const t=(0,r.cancelSB)(e,w);b.push(t.doOperations[0],t.doOperations[1]),y.splice(0,0,t.undoOperations[0],t.undoOperations[1])}else w&&w.classList.contains("protyle-wysiwyg")&&w.childElementCount;g?(0,d.transaction)(e,b,y):(0,d.transaction)(e,b),(0,a.focusBlock)(t[0])};t.dropEvent=(e,t)=>{let n;t.addEventListener("dragstart",(t=>{const n=t.target;if("IMG"===n.tagName)return window.siyuan.dragElement=void 0,void t.preventDefault();n.classList&&n.classList.contains("protyle-action")?(0,s.hasClosestByClassName)(n,"protyle-wysiwyg__embed")?(window.siyuan.dragElement=void 0,t.preventDefault()):window.siyuan.dragElement=n.parentElement:(t.dataTransfer.setData(o.Constants.SIYUAN_DROP_EDITOR,o.Constants.SIYUAN_DROP_EDITOR),e.element.style.userSelect="auto",document.onmousemove=null,document.onmouseup=null)})),t.addEventListener("drop",(n=>i(void 0,void 0,void 0,(function*(){var i;if(n.dataTransfer.getData(o.Constants.SIYUAN_DROP_EDITOR)){if(0===getSelection().rangeCount)return;const t=(0,s.hasClosestBlock)(n.target),i=(0,s.hasClosestBlock)(getSelection().getRangeAt(0).startContainer);if(!t||!i)return;(0,p.hideElements)(["toolbar"],e);const o=t.isSameNode(i),l=[{action:"update",data:t.outerHTML,id:t.getAttribute("data-node-id")}];return o||l.push({action:"update",data:i.outerHTML,id:i.getAttribute("data-node-id")}),void setTimeout((()=>{const n=getSelection().getRangeAt(0);n.insertNode(document.createElement("wbr"));const s=e.lute.SpinBlockDOM(t.outerHTML);t.outerHTML=s;const r=[{action:"update",data:s,id:t.getAttribute("data-node-id")}];if(!o){const t=e.lute.SpinBlockDOM(i.outerHTML);i.outerHTML=t,r.push({action:"update",data:t,id:i.getAttribute("data-node-id")})}(0,d.transaction)(e,r,l),(0,m.mathRender)(e.wysiwyg.element),t.classList.contains("code-block")?(0,w.highlightRender)(e.wysiwyg.element):(0,a.focusByWbr)(e.wysiwyg.element,n),e.selectElement.classList.add("fn__none")}))}const r=t.querySelector(".dragover__bottom")||t.querySelector(".dragover__top")||t.querySelector(".dragover__left")||t.querySelector(".dragover__right"),c="backlink"===(null===(i=window.siyuan.dragElement)||void 0===i?void 0:i.getAttribute("data-treetype"));if(window.siyuan.dragElement&&(n.altKey||n.shiftKey)&&c){(0,a.focusByRange)(document.caretRangeFromPoint(n.clientX,n.clientY));const t=window.siyuan.dragElement.getAttribute("data-node-id");n.altKey?(0,g.fetchPost)("/api/block/getRefText",{id:t},(n=>{(0,_.insertHTML)(`((${t} '${n.data}'))`,e)})):((0,_.insertHTML)(e.lute.SpinBlockDOM(`{{select * from blocks where id='${t}'}}`),e),(0,f.blockRender)(e,e.wysiwyg.element))}else if(window.siyuan.dragElement&&r&&(window.siyuan.dragElement.parentElement.classList.contains("protyle-gutters")||c||"NodeListItem"===window.siyuan.dragElement.getAttribute("data-type"))){const t=window.siyuan.dragElement.getAttribute("data-node-id");let n=[];if(c){let i=document.createElement("div");const a=yield(0,g.fetchSyncPost)("/api/block/getBlockDOM",{id:t});i.innerHTML=a.data.dom,i=i.firstElementChild,(0,h.processRender)(i),(0,w.highlightRender)(i),(0,f.blockRender)(e,i),n=[i]}else{const e=window.siyuan.dragElement.getAttribute("data-selected-ids");(e?e.split(","):[window.siyuan.dragElement.getAttribute("data-node-id")]).forEach((e=>{const t=window.siyuan.dragElement.parentElement.parentElement.querySelector(`.protyle-wysiwyg [data-node-id="${e}"]`);t&&n.push(t)}))}n.forEach((e=>{e.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl")}));const i=r.className.split(" ");r.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right","protyle-wysiwyg--select"),"NodeSuperBlock"===r.parentElement.getAttribute("data-type")&&"col"===r.parentElement.getAttribute("data-sb-layout")?i.includes("dragover__left")||i.includes("dragover__right")?k(e,n,r,i.includes("dragover__right")):E(e,n,r,i.includes("dragover__bottom"),"row"):i.includes("dragover__left")||i.includes("dragover__right")?E(e,n,r,i.includes("dragover__right"),"col"):k(e,n,r,i.includes("dragover__bottom"))}else if(window.siyuan.dragElement&&"navigation-file"===window.siyuan.dragElement.getAttribute("data-type")&&r)(0,g.fetchPost)("/api/filetree/doc2Heading",{srcID:window.siyuan.dragElement.getAttribute("data-node-id"),after:r.classList.contains("dragover__bottom"),targetID:r.getAttribute("data-node-id")},(t=>{const n=e.contentElement.scrollTop;(0,g.fetchPost)("/api/filetree/removeDoc",{notebook:t.data.srcTreeBox,path:t.data.srcTreePath}),(0,g.fetchPost)("/api/filetree/getDoc",{id:e.block.id,size:o.Constants.SIZE_GET},(t=>{(0,b.onGet)(t,e),setTimeout((()=>{e.contentElement.scrollTop=n,e.scroll.lastScrollTop=n-1}),o.Constants.TIMEOUT_BLOCKLOAD)}))})),r.classList.remove("dragover__bottom","dragover__top");else if(!window.siyuan.dragElement&&("Files"===n.dataTransfer.types[0]||n.dataTransfer.types.includes("text/html")))if((0,a.focusByRange)(document.caretRangeFromPoint(n.clientX,n.clientY)),"Files"===n.dataTransfer.types[0]){const t=[];let i=!0;for(let e=0;e<n.dataTransfer.files.length;e++)t.push(n.dataTransfer.files[e].path),""===n.dataTransfer.files[e].type&&(i=!1);if(i)if(n.altKey){let n="";t.forEach((e=>{n+=`[${y.basename(e).replace(/\]/g,"\\]").replace(/\[/g,"\\[")}](file://${e.replace(/\\/g,"\\\\").replace(/\)/g,"\\)").replace(/\(/g,"\\(")})\n`})),(0,_.insertHTML)(e.lute.SpinBlockDOM(n),e)}else(0,v.uploadLocalFiles)(t,e);else(0,v.uploadLocalFiles)(t,e)}else(0,l.paste)(e,n);window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)})))),t.addEventListener("dragover",(t=>{if(t.dataTransfer.types.includes("Files")&&t.target.classList.contains("protyle-wysiwyg"))return void t.preventDefault();if(!window.siyuan.dragElement)return;if((t.shiftKey||t.altKey)&&"backlink"===window.siyuan.dragElement.getAttribute("data-treetype")){const e=(0,s.hasClosestBlock)(t.target);return e&&e.classList.remove("dragover__top","protyle-wysiwyg--select","dragover__bottom","dragover__left","dragover__right"),void t.preventDefault()}t.preventDefault();const i=(0,s.hasClosestBlock)(t.target);if(i){if(i&&n&&i.isSameNode(n)){const e=i.getBoundingClientRect();return i.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right"),"NodeListItem"===i.getAttribute("data-type")||"navigation-file"===window.siyuan.dragElement.getAttribute("data-type")?void(t.clientY>e.top+e.height/2?i.classList.add("dragover__bottom","protyle-wysiwyg--select"):i.classList.add("dragover__top","protyle-wysiwyg--select")):void(t.clientX<e.left+32&&t.clientX>e.left?i.classList.add("dragover__left","protyle-wysiwyg--select"):t.clientX>e.right-32&&t.clientX<e.right?i.classList.add("dragover__right","protyle-wysiwyg--select"):t.clientY>e.top+e.height/2?i.classList.add("dragover__bottom","protyle-wysiwyg--select"):i.classList.add("dragover__top","protyle-wysiwyg--select"))}if("navigation-file"!==window.siyuan.dragElement.getAttribute("data-type")||window.siyuan.dragElement.getAttribute("data-node-id")===e.block.rootID){if(window.siyuan.dragElement.parentElement.classList.contains("protyle-gutters")||"NodeListItem"===window.siyuan.dragElement.getAttribute("data-type")||"backlink"===window.siyuan.dragElement.getAttribute("data-treetype")){const e=window.siyuan.dragElement.getAttribute("data-selected-ids");if((e?e.split(","):[window.siyuan.dragElement.getAttribute("data-node-id")]).find((e=>{if(e&&(0,s.hasClosestByAttribute)(i,"data-node-id",e))return!0})))return;if((0,s.hasClosestByAttribute)(i.parentElement,"data-type","NodeBlockQueryEmbed"))return;if("NodeListItem"===window.siyuan.dragElement.getAttribute("data-type")&&window.siyuan.dragElement.getAttribute("data-subtype")!==i.getAttribute("data-subtype")&&window.siyuan.dragElement.getAttribute("data-type")===i.getAttribute("data-type"))return;if("NodeListItem"!==window.siyuan.dragElement.getAttribute("data-type")&&"NodeListItem"===i.getAttribute("data-type"))return;n=i}}else n=i}})),t.addEventListener("dragleave",(e=>{var t;const n=(0,s.hasClosestBlock)(e.target);n&&(-1===((null===(t=window.siyuan.dragElement)||void 0===t?void 0:t.getAttribute("data-selected-ids"))||"").indexOf(n.getAttribute("data-node-id"))&&n.classList.remove("protyle-wysiwyg--select"),n.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right"))}))}},7821:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasClosestByClassName=t.hasClosestByMatchTag=t.hasClosestBlock=t.hasClosestByAttribute=t.hasTopClosestByAttribute=t.hasTopClosestByTag=t.hasTopClosestByClassName=t.hasClosestByTag=void 0;t.hasClosestByTag=(e,t)=>{if(!e)return!1;3===e.nodeType&&(e=e.parentElement);let n=e,i=!1;for(;n&&!i&&!n.classList.contains("b3-typography");)0===n.nodeName.indexOf(t)?i=!0:n=n.parentElement;return i&&n};t.hasTopClosestByClassName=(e,n,i=!1)=>{let a=(0,t.hasClosestByClassName)(e,n,i),s=!1,o=!1;for(;a&&(i?"BODY"!==a.tagName:!a.classList.contains("protyle-wysiwyg"))&&!o;)s=(0,t.hasClosestByClassName)(a.parentElement,n,i),s?a=s:o=!0;return a||!1};t.hasTopClosestByTag=(e,n)=>{let i=(0,t.hasClosestByTag)(e,n),a=!1,s=!1;for(;i&&!i.classList.contains("protyle-wysiwyg")&&!s;)a=(0,t.hasClosestByTag)(i.parentElement,n),a?i=a:s=!0;return i||!1};t.hasTopClosestByAttribute=(e,n,i,a=!1)=>{let s=(0,t.hasClosestByAttribute)(e,n,i,a),o=!1,l=!1;for(;s&&!s.classList.contains("protyle-wysiwyg")&&!l;)o=(0,t.hasClosestByAttribute)(s.parentElement,n,i,a),o?s=o:l=!0;return s||!1};t.hasClosestByAttribute=(e,t,n,i=!1)=>{var a;if(!e)return!1;3===e.nodeType&&(e=e.parentElement);let s=e,o=!1;for(;s&&!o&&(i?"BODY"!==s.tagName:!s.classList.contains("protyle-wysiwyg"));)"string"==typeof n&&(null===(a=s.getAttribute(t))||void 0===a?void 0:a.split(" ").includes(n))||"string"!=typeof n&&s.hasAttribute(t)?o=!0:s=s.parentElement;return o&&s};t.hasClosestBlock=e=>{var n;const i=(0,t.hasClosestByAttribute)(e,"data-node-id",null);return!(!i||"BUTTON"===i.tagName||!(null===(n=i.getAttribute("data-type"))||void 0===n?void 0:n.startsWith("Node")))&&i};t.hasClosestByMatchTag=(e,t)=>{if(!e)return!1;3===e.nodeType&&(e=e.parentElement);let n=e,i=!1;for(;n&&!i&&!n.classList.contains("protyle-wysiwyg");)n.nodeName===t?i=!0:n=n.parentElement;return i&&n};t.hasClosestByClassName=(e,t,n=!1)=>{if(!e)return!1;3===e.nodeType&&(e=e.parentElement);let i=e,a=!1;for(;i&&!a&&(n?"BODY"!==i.tagName:!i.classList.contains("protyle-wysiwyg"));)i.classList.contains(t)?a=!0:i=i.parentElement;return a&&i}},7406:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.removeFoldHeading=void 0;t.removeFoldHeading=e=>{var t;const n=parseInt(e.getAttribute("data-subtype").substr(1));let i=e.nextElementSibling;for(;i;)if(i.classList.contains("sb")){let e=i.firstElementChild;for(;e&&e.classList.contains("sb");)e=e.firstElementChild;if(!("NodeHeading"===e.getAttribute("data-type")&&parseInt(e.getAttribute("data-subtype").substr(1))>n||"NodeHeading"!==e.getAttribute("data-type")))break;{const e=i;i=i.nextElementSibling,e.remove()}}else{const e=parseInt(null===(t=i.getAttribute("data-subtype"))||void 0===t?void 0:t.substr(1));if(i.classList.contains("protyle-attr")||!(isNaN(e)||e>n))break;{const e=i;i=i.nextElementSibling,e.remove()}}}},1676:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.matchHotKey=void 0;const i=n(532);t.matchHotKey=(e,t)=>{if(""===e)return!1;if(-1===e.indexOf("⇧")&&-1===e.indexOf("⌘")&&-1===e.indexOf("⌥")&&-1===e.indexOf("⌃"))return"⇥"===e&&(e="Tab"),!(t.ctrlKey||(0,i.isCtrl)(t)||t.altKey||t.shiftKey||t.code!==e);const n=e.split("");if((e.endsWith("↑")||e.endsWith("↓")||e.endsWith("→")||e.endsWith("←")||e.endsWith("↩")||e.endsWith("⇥")||e.indexOf("F")>-1)&&n.forEach(((e,t)=>{"↑"===e?n[t]="ArrowUp":"↓"===e?n[t]="ArrowDown":"←"===e?n[t]="ArrowLeft":"→"===e?n[t]="ArrowRight":"⇥"===e?n[t]="Tab":"↩"===e?n[t]="Enter":"F"===e&&(n[t]="F"+n.splice(t+1,1),n[t+1]&&(n[t+1]+=n.splice(t+1,1)))})),e.startsWith("⇧")&&2===n.length)return!(t.ctrlKey||(0,i.isCtrl)(t)||t.altKey||!t.shiftKey||t.key!==n[1]);if(e.startsWith("⌥")){let a=3===n.length?n[2]:n[1];4===n.length&&(a=n[3]);const s=(/^[0-9]$/.test(a)?t.code==="Digit"+a||t.code==="Numpad"+a:t.code==="Key"+a)||t.code===a||"Period"===t.code&&"."===a||"BracketLeft"===t.code&&"["===a||"BracketRight"===t.code&&"]"===a;return!((3===n.length?!(0,i.isCtrl)(t):(0,i.isCtrl)(t))||!t.altKey||t.shiftKey||!s)||(!!(e.startsWith("⌥⇧⌘")&&4===n.length&&t.altKey&&t.shiftKey&&(0,i.isCtrl)(t)&&s)||!!(e.startsWith("⌥⇧")&&3===n.length&&t.altKey&&t.shiftKey&&!(0,i.isCtrl)(t)&&s))}const a=n.length>2&&"⇧"===n[0];let s,o=a?n[2]:n[1];return a&&("-"===o?(o="_",s=189):"="===o?(o="+",s=187):"."===o&&(o=">",s=190)),!(!(0,i.isCtrl)(t)||t.key.toLowerCase()!==o.toLowerCase()&&t.keyCode!==s||t.altKey||!(!a&&!t.shiftKey||a&&t.shiftKey))}},8469:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.insertHTML=void 0;const i=n(7821),a=n(5680),s=n(133),o=n(1985),l=n(3903),r=n(2386),d=n(2224),c=n(8438);t.insertHTML=(e,t,n=!1,u=!0)=>{var p,m;if(""===e)return;const g=(0,r.getEditorRange)(t.wysiwyg.element);(0,r.fixTableRange)(g),(0,i.hasClosestByAttribute)(g.startContainer,"data-type","NodeTable")&&!n&&(e=t.lute.BlockDOM2InlineBlockDOM(e));let b=(0,i.hasClosestBlock)(g.startContainer);if(b||(b=t.toolbar.range?(0,i.hasClosestBlock)(t.toolbar.range.startContainer):t.wysiwyg.element.firstElementChild),!b)return;let y=b.getAttribute("data-node-id");g.insertNode(document.createElement("wbr"));let f=b.outerHTML;const h=[],w=[];if(""!==g.toString()){const e=(0,i.hasClosestByAttribute)(g.commonAncestorContainer,"data-type","inline-math");e?e.remove():3===g.startContainer.nodeType&&(null===(p=g.startContainer.parentElement.getAttribute("data-type"))||void 0===p?void 0:p.indexOf("block-ref"))>-1?(g.startContainer.parentElement.remove(),g.deleteContents()):g.deleteContents(),g.insertNode(document.createElement("wbr")),h.push({action:"update",id:y,data:f}),w.push({action:"update",id:y,data:b.outerHTML})}const v=document.createElement("template");v.innerHTML=e;const _=(0,l.getContenteditableElement)(b);let E=!1;if(!n&&(3===v.content.firstChild.nodeType||3!==v.content.firstChild.nodeType&&(v.content.firstElementChild.classList.contains("p")&&1===v.content.childElementCount||"DIV"!==v.content.firstElementChild.tagName))){3!==v.content.firstChild.nodeType&&v.content.firstElementChild.classList.contains("p")&&(v.innerHTML=v.content.firstElementChild.firstElementChild.innerHTML.trim());const e=3===g.startContainer.nodeType?g.startContainer.parentElement:g.startContainer;if(u&&"SPAN"===e.tagName&&e.isSameNode(3===g.endContainer.nodeType?g.endContainer.parentElement:g.endContainer)){const t=document.createElement("span"),n=e.attributes;for(let e=0;e<n.length;e++)t.setAttribute(n[e].name,n[e].value);g.setEnd(e.lastChild,e.lastChild.textContent.length),t.append(g.extractContents()),e.after(t),g.setStartBefore(t),g.collapse(!0)}g.insertNode(v.content.cloneNode(!0)),g.collapse(!1),b.setAttribute("updated",a().format("YYYYMMDDHHmmss"));const n=_?_.innerHTML.trimStart():"";if(_&&(n.startsWith("```")||n.startsWith("~~~")||n.startsWith("···")||n.indexOf("\n```")>-1||n.indexOf("\n~~~")>-1||n.indexOf("\n···")>-1))if(-1===n.indexOf("\n")&&n.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1);else{let e=_.innerHTML.replace(/^(~|·|`){3,}/g,"```").replace(/\n(~|·|`){3,}/g,"\n```").trim();e.endsWith("\n```")||(e+="\n```");const t=e.indexOf("```")+3;e=e.substring(0,t)+(window.localStorage["local-codelang"]||"")+e.substring(t),_.innerHTML=e}const l=t.lute.SpinBlockDOM((0,s.removeEmbed)(b)),c=b.firstElementChild.scrollLeft;if(b.outerHTML=l,E=!0,v.innerHTML=l,Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${y}"]`)).find((e=>{if(!(0,i.hasClosestByAttribute)(e,"data-type","NodeBlockQueryEmbed"))return b=e,!0})),1===v.content.childElementCount)return b.classList.contains("table")&&c>0&&(b.firstElementChild.scrollLeft=c),(0,d.mathRender)(b),(0,o.updateTransaction)(t,y,b.outerHTML,f),void(0,r.focusByWbr)(t.wysiwyg.element,g)}const k=(0,i.hasClosestByClassName)(b,"li");if("NodeListItem"===(null===(m=v.content.children[0])||void 0===m?void 0:m.getAttribute("data-type")))if(k)b=k,y=b.getAttribute("data-node-id"),f=b.outerHTML;else{const t=v.content.children[0].getAttribute("data-subtype");v.innerHTML=`<div${"o"===t?' data-marker="1."':""} data-subtype="${t}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${e}<div class="protyle-attr" contenteditable="false">${c.Constants.ZWSP}</div></div>`}let C;Array.from(v.content.children).reverse().forEach((e=>{const t=e.getAttribute("data-node-id");t===y?(w.push({action:"update",data:e.outerHTML,id:t}),h.push({action:"update",id:t,data:f})):(w.push({action:"insert",data:e.outerHTML,id:t,previousID:y}),h.push({action:"delete",id:t})),E||b.after(e),C||(C=e)})),_&&""===_.textContent&&(w.find(((e,t)=>{if(e.id===y)return w.splice(t,1),!0})),w.push({action:"delete",id:y}),h.find(((e,t)=>{if(e.id===y&&"update"===e.action)return h.splice(t,1),!0})),h.push({action:"insert",data:f,id:y,previousID:b.previousElementSibling?b.previousElementSibling.getAttribute("data-node-id"):"",parentID:b.parentElement.getAttribute("data-node-id")||t.block.parentID}),b.remove()),C&&(0,r.focusBlock)(C,void 0,!1);const x=t.wysiwyg.element.querySelector("wbr");x&&x.remove(),(0,o.transaction)(t,w,h)}},8740:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.log=void 0;t.log=(e,t,n,i)=>{i&&console.log(`${e} - ${n}: ${t}`)}},1025:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.merge=void 0;t.merge=(...e)=>{const n={},i=e=>{for(const i in e)e.hasOwnProperty(i)&&("[object Object]"===Object.prototype.toString.call(e[i])?n[i]=(0,t.merge)(n[i],e[i]):n[i]=e[i])};for(let t=0;t<e.length;t++)i(e[t]);return n}},1040:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.enableProtyle=t.disabledProtyle=t.onGet=void 0;const i=n(4933),a=n(8438),s=n(5615),o=n(3053),l=n(1985),r=n(7683),d=n(6259),c=n(1456),u=n(4383),p=n(5449),m=n(2386),g=n(7821),b=n(5788),y=n(6245),f=n(7994);t.onGet=(e,t,n=[],d,c=!1)=>{if(t.wysiwyg.element.removeAttribute("data-top"),1===e.code)return void(t.model?t.model.parent.parent.removeTab(t.model.parent.id,!1,!1):t.element.innerHTML=`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`);if(3===e.code)return;if(t.notebookId=e.data.box,t.path=e.data.path,2===e.code)return t.block.rootID=e.data,void(0,i.lockFile)(e.data);if(e.data.eof&&(n.includes(a.Constants.CB_GET_BEFORE)?t.wysiwyg.element.firstElementChild.setAttribute("data-eof","true"):t.wysiwyg.element.lastElementChild.setAttribute("data-eof","true"),4!==e.data.mode))return;(0,s.hideElements)(["gutter"],t);let u=e.data.content;if(""===u&&!n){const n=(0,o.genEmptyElement)(!1,!1);u=n.outerHTML,(0,l.transaction)(t,[{action:"insert",id:n.getAttribute("data-node-id"),data:u,parentID:e.data.parentID}])}if(t.block.parentID=e.data.parentID,t.block.parent2ID=e.data.parent2ID,t.block.rootID=e.data.rootID,t.block.showAll=!1,t.block.mode=e.data.mode,t.block.blockCount=e.data.blockCount,t.block.childBlockCount=e.data.childBlockCount,t.block.action=n,n.includes(a.Constants.CB_GET_UNCHANGEID)||(t.block.id=e.data.id,t.scroll.lastScrollTop=0,t.contentElement.scrollTop=0,t.wysiwyg.element.setAttribute("data-doc-type",e.data.type)),n.includes(a.Constants.CB_GET_APPEND)||n.includes(a.Constants.CB_GET_BEFORE)||n.includes(a.Constants.CB_GET_HTML))return h({content:u,action:n,unScroll:!1},t),void(0,f.removeLoading)(t);(0,r.fetchPost)("/api/block/getDocInfo",{id:t.block.rootID},(e=>{t.options.render.title?t.title.render(t,e,c):t.options.render.background&&(t.background.render(e.data.ial,t.block.rootID),t.wysiwyg.renderCustom(e.data.ial));let i=d;if(!i&&n.includes(a.Constants.CB_GET_SCROLL)&&e.data.ial.scroll)try{i=JSON.parse(e.data.ial.scroll.replace(/&quot;/g,'"'))}catch(e){i=void 0}h({content:u,action:n,unScroll:!(!i||!i.focusId)},t),i&&"preview"!==t.options.mode&&(0,y.restoreScroll)(t,i),(0,f.removeLoading)(t)}))};const h=(e,n)=>{if(n.contentElement.classList.contains("fn__none"))return;n.block.showAll=e.action.includes(a.Constants.CB_GET_ALL);const i=8*n.contentElement.clientHeight;if(e.action.includes(a.Constants.CB_GET_APPEND)){if(!n.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!n.scroll.keepLazyLoad&&n.contentElement.scrollHeight>i){let e=n.wysiwyg.element.firstElementChild;const t=[];for(;n.wysiwyg.element.childElementCount>2&&t&&!n.wysiwyg.element.lastElementChild.isSameNode(e)&&n.contentElement.scrollHeight-e.offsetTop>i;)t.push(e),e=e.nextElementSibling;const a=e.getBoundingClientRect().top;t.forEach((e=>{e.remove()})),n.contentElement.scrollTop=n.contentElement.scrollTop+(e.getBoundingClientRect().top-a),n.scroll.lastScrollTop=n.contentElement.scrollTop,(0,s.hideElements)(["toolbar"],n)}n.wysiwyg.element.insertAdjacentHTML("beforeend",e.content)}else if(e.action.includes(a.Constants.CB_GET_BEFORE)){const t=n.wysiwyg.element.firstElementChild,a=t.getBoundingClientRect().top;if(n.wysiwyg.element.insertAdjacentHTML("afterbegin",e.content),n.contentElement.scrollTop=n.contentElement.scrollTop+(t.getBoundingClientRect().top-a),n.scroll.lastScrollTop=n.contentElement.scrollTop,!n.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!n.scroll.keepLazyLoad){for(;n.wysiwyg.element.childElementCount>2&&n.contentElement.scrollHeight>i&&n.wysiwyg.element.lastElementChild.getBoundingClientRect().top>window.innerHeight;)n.wysiwyg.element.lastElementChild.remove();(0,s.hideElements)(["toolbar"],n)}}else n.wysiwyg.element.innerHTML=e.content;if((0,d.processRender)(n.wysiwyg.element),(0,c.highlightRender)(n.wysiwyg.element),(0,u.blockRender)(n,n.wysiwyg.element),e.action.includes(a.Constants.CB_GET_HISTORY))(0,t.disabledProtyle)(n);else{if(n.options.render.scroll&&n.scroll.update(n),e.action.includes(a.Constants.CB_GET_HL)&&!e.unScroll){(0,b.preventScroll)(n);(0,p.highlightById)(n,n.block.id,!0)}else if(e.action.includes(a.Constants.CB_GET_FOCUS)&&!e.unScroll){let e;Array.from(n.wysiwyg.element.querySelectorAll(`[data-node-id="${n.block.id}"]`)).find((t=>{if(!(0,g.hasClosestByAttribute)(t,"data-type","block-render",!0))return e=t,!0})),4===n.block.mode&&((0,b.preventScroll)(n),e=n.wysiwyg.element.lastElementChild),e&&!n.wysiwyg.element.firstElementChild.isSameNode(e)?((0,m.focusBlock)(e),e.scrollIntoView(),setTimeout((()=>{e.scrollIntoView()}),a.Constants.TIMEOUT_BLOCKLOAD)):(0,m.focusBlock)(n.wysiwyg.element.firstElementChild)}else if(e.action.includes(a.Constants.CB_GET_FOCUSFIRST)&&!e.unScroll){const e=n.wysiwyg.element.offsetTop-16;(0,b.preventScroll)(n,e,256),n.contentElement.scrollTop=e,(0,m.focusBlock)(n.wysiwyg.element.firstElementChild)}n.disabled?(0,t.disabledProtyle)(n):(0,t.enableProtyle)(n),e.action.includes(a.Constants.CB_GET_SETID)&&(n.block.id=n.block.rootID,n.wysiwyg.element.setAttribute("data-doc-type","NodeDocument")),n.options.defId&&(n.wysiwyg.element.querySelectorAll(`[data-id="${n.options.defId}"]`).forEach((e=>{e.classList.add("def--mark")})),n.options.defId=void 0),n.element.classList.contains("block__edit")&&(n.element.nextElementSibling||n.element.previousElementSibling)&&(n.element.style.minHeight=Math.min(30+n.wysiwyg.element.clientHeight,window.innerHeight/3)+"px"),!n.scroll.element.classList.contains("fn__none")&&"true"!==n.wysiwyg.element.lastElementChild.getAttribute("data-eof")&&n.contentElement.scrollHeight>0&&!e.action.includes(a.Constants.CB_GET_FOCUSFIRST)&&n.contentElement.scrollHeight<=n.contentElement.clientHeight&&(0,r.fetchPost)("/api/filetree/getDoc",{id:n.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,k:n.options.key||"",size:a.Constants.SIZE_GET},(e=>{(0,t.onGet)(e,n,[a.Constants.CB_GET_APPEND,a.Constants.CB_GET_UNCHANGEID])})),e.action.includes(a.Constants.CB_GET_APPEND)||e.action.includes(a.Constants.CB_GET_BEFORE)||n.options.render.breadcrumb&&n.breadcrumb.render(n)}};t.disabledProtyle=e=>{(0,s.hideElements)(["gutter","toolbar","select","hint","util"],e),e.disabled=!0,e.wysiwyg.element.setAttribute("contenteditable","false"),e.wysiwyg.element.querySelectorAll('[contenteditable="true"][spellcheck="false"]').forEach((e=>{e.setAttribute("contenteditable","false")}))};t.enableProtyle=e=>{e.disabled=!1,navigator&&navigator.maxTouchPoints>1&&["MacIntel","iPhone"].includes(navigator.platform)||e.wysiwyg.element.setAttribute("contenteditable","true"),e.wysiwyg.element.querySelectorAll('[contenteditable="false"][spellcheck="false"]').forEach((e=>{(0,g.hasClosestByClassName)(e,"protyle-wysiwyg__embed")||e.setAttribute("contenteditable","true")}))}},3343:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,s){function o(e){try{r(i.next(e))}catch(e){s(e)}}function l(e){try{r(i.throw(e))}catch(e){s(e)}}function r(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,l)}r((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.paste=t.pasteText=t.pasteAsPlainText=void 0;const a=n(8438),s=n(562),o=n(6259),l=n(532),r=n(7821),d=n(2386),c=n(4383),u=n(5680),p=n(1456),m=n(1985),g=n(7683),b=n(6400),y=n(8469),f=n(5449),h=n(3903),w=(e,t)=>{let n=!0;e.options.hint.extend.find((e=>{if(e.key===t)return n=!1,!0})),n&&e.hint.render(e)};t.pasteAsPlainText=e=>i(void 0,void 0,void 0,(function*(){}));t.pasteText=(e,t,n)=>{const i=(0,d.getEditorRange)(e.wysiwyg.element),a=n.getAttribute("data-node-id");if("NodeCodeBlock"===n.getAttribute("data-type")){i.insertNode(document.createElement("wbr"));const s=n.outerHTML;return i.deleteContents(),i.insertNode(document.createTextNode(t.replace(/\r\n|\r|\u2028|\u2029/g,"\n"))),i.collapse(!1),i.insertNode(document.createElement("wbr")),n.outerHTML=e.lute.SpinBlockDOM(n.outerHTML),n=e.wysiwyg.element.querySelector(`[data-node-id="${a}"]`),(0,p.highlightRender)(n),n.setAttribute("updated",u().format("YYYYMMDDHHmmss")),void(0,m.updateTransaction)(e,a,n.outerHTML,s)}""!==i.toString()&&((0,b.isDynamicRef)(t)?t=t.replace(/'.+'\)\)$/,` "${i.toString()}"))`):(0,b.isFileAnnotation)(t)?t=t.replace(/".+">>$/,`"${i.toString()}">>`):e.lute.IsValidLinkDest(t)&&(t=`[${i.toString()}](${t})`)),(0,y.insertHTML)(e.lute.Md2BlockDOM(t),e),(0,c.blockRender)(e,e.wysiwyg.element),(0,o.processRender)(e.wysiwyg.element),(0,p.highlightRender)(e.wysiwyg.element),w(e,t),(0,f.scrollCenter)(e)};t.paste=(e,t)=>i(void 0,void 0,void 0,(function*(){let n,i,v;if(t.stopPropagation(),t.preventDefault(),"clipboardData"in t?(n=t.clipboardData.getData("text/html"),i=t.clipboardData.getData("text/plain"),v=t.clipboardData.files):(n=t.dataTransfer.getData("text/html"),i=t.dataTransfer.getData("text/plain"),"Files"===t.dataTransfer.types[0]&&(v=t.dataTransfer.items)),n.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/gi,"").trim()!==`<a href="${i}">${i}</a>`&&n.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/gi,"").trim()!==`\x3c!--StartFragment--\x3e<a href="${i}">${i}</a>\x3c!--EndFragment--\x3e`||(n=""),!n.endsWith(a.Constants.ZWSP)&&!n.startsWith(a.Constants.ZWSP)){const e=(new DOMParser).parseFromString(n,"text/html");e.body&&e.body.innerHTML&&(n=e.body.innerHTML),n.startsWith("\n\x3c!--StartFragment--\x3e")&&n.endsWith("\x3c!--EndFragment--\x3e\n\n")&&(n=e.body.innerHTML.trim().replace("\x3c!--StartFragment--\x3e","").replace("\x3c!--EndFragment--\x3e",""))}n=Lute.Sanitize(n);const _=(0,r.hasClosestBlock)(t.target);if(!_)return void(v&&v.length>0&&(0,s.uploadFiles)(e,v));e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select, .protyle-wysiwyg--hl").forEach((e=>{e.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl")}));const E=(0,o.processPasteCode)(n,i),k=(0,d.getEditorRange)(e.wysiwyg.element),C=_.getAttribute("data-node-id");if("NodeCodeBlock"===_.getAttribute("data-type")){k.insertNode(document.createElement("wbr"));const t=_.outerHTML;return k.deleteContents(),k.insertNode(document.createTextNode(i.replace(/\r\n|\r|\u2028|\u2029/g,"\n"))),k.collapse(!1),k.insertNode(document.createElement("wbr")),(0,h.getContenteditableElement)(_).removeAttribute("data-render"),(0,p.highlightRender)(_),_.setAttribute("updated",u().format("YYYYMMDDHHmmss")),(0,m.updateTransaction)(e,C,_.outerHTML,t),void setTimeout((()=>{(0,f.scrollCenter)(e,_)}),a.Constants.TIMEOUT_BLOCKLOAD)}if(E)if(E.startsWith('<div data-type="NodeCodeBlock" class="code-block" data-node-id="'))(0,y.insertHTML)(E,e,!0),(0,p.highlightRender)(e.wysiwyg.element);else{const t=document.createElement("wbr");k.insertNode(t);const n=_.outerHTML;t.remove(),k.deleteContents();const i=document.createElement("code");i.textContent=E,k.insertNode(document.createElement("wbr")),k.insertNode(i),(0,m.updateTransaction)(e,_.getAttribute("data-node-id"),_.outerHTML,n),(0,d.focusByWbr)(e.wysiwyg.element,k)}else{let t=!1;if(n.startsWith(a.Constants.ZWSP)||n.endsWith(a.Constants.ZWSP)?t=!0:""!==n.replace("\x3c!--StartFragment--\x3e\x3c!--EndFragment--\x3e","").trim()&&(n=n.replace("\x3c!--StartFragment--\x3e","").replace("\x3c!--EndFragment--\x3e","").trim(),t=!(v&&1===v.length&&n.indexOf("<img")>-1)),t){const t=document.createElement("div");if(n.startsWith(a.Constants.ZWSP)){t.innerHTML=n.substr(1).replace('<meta charset="utf-8">',"");let i=!1;t.querySelectorAll("[data-node-id]").forEach((e=>{e.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),i=!0})),_.classList.contains("table")&&(i=!1),(0,y.insertHTML)(t.innerHTML,e,i);const a=e.lute.BlockDOM2StdMd(t.innerHTML);(0,l.writeText)(a),w(e,a)}else{if(!n.endsWith(a.Constants.ZWSP))return t.innerHTML=n,t.querySelectorAll("[style]").forEach((e=>{e.removeAttribute("style")})),t.querySelectorAll("a").forEach((e=>{""===e.innerHTML.trim()&&e.remove()})),void(0,g.fetchPost)("/api/lute/html2BlockDOM",{dom:t.innerHTML},(t=>{(0,y.insertHTML)(t.data,e),e.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach((e=>{""===e.textContent&&(0,g.fetchPost)("/api/block/getRefText",{id:e.getAttribute("data-id")},(t=>{e.innerHTML=t.data}))})),(0,c.blockRender)(e,e.wysiwyg.element),(0,o.processRender)(e.wysiwyg.element),(0,p.highlightRender)(e.wysiwyg.element),w(e,t.data),(0,f.scrollCenter)(e)}));{t.innerHTML=n.substr(0,n.length-1).replace('<meta charset="utf-8">',""),t.querySelectorAll("[data-node-id]").forEach((e=>{const t=Lute.NewNodeID();e.setAttribute("data-node-id",t),e.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),e.getAttribute("updated")&&e.setAttribute("updated",t.split("-")[0])})),t.querySelectorAll('[spellcheck="false"][contenteditable="false"]').forEach((e=>{e.setAttribute("contenteditable","true")}));const i=t.innerHTML;(0,y.insertHTML)(i,e),w(e,i)}}}else if(v&&v.length>0)(0,s.uploadFiles)(e,v);else if(""!==i.trim()&&v&&0===v.length){""!==k.toString()&&((0,b.isDynamicRef)(i)?i=i.replace(/'.*'\)\)$/,` "${Lute.EscapeHTMLStr(k.toString())}"))`):(0,b.isFileAnnotation)(i)?i=i.replace(/".+">>$/,`"${Lute.EscapeHTMLStr(k.toString())}">>`):e.lute.IsValidLinkDest(i)&&(i=`[${k.toString()}](${i})`));const t=e.lute.Md2BlockDOM(i);(0,y.insertHTML)(t,e),w(e,t)}(0,c.blockRender)(e,e.wysiwyg.element),(0,o.processRender)(e.wysiwyg.element),(0,p.highlightRender)(e.wysiwyg.element)}(0,f.scrollCenter)(e)}))},6259:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.processRender=t.processPasteCode=void 0;const i=n(2439),a=n(406),s=n(881),o=n(2224),l=n(3728),r=n(6710),d=n(6374),c=n(2886),u=n(8438);t.processPasteCode=(e,t)=>{const n=document.createElement("div");n.innerHTML=e;let i=!1;1===n.childElementCount&&n.lastElementChild.style.fontFamily.indexOf("monospace")>-1&&(i=!0);const a=n.querySelectorAll("pre");if(1===n.childElementCount&&1===a.length&&"protyle-sv"!==a[0].className&&(i=!0),0===e.indexOf('\n<p class="p1">')&&(i=!0),1===n.childElementCount&&"TABLE"===n.firstElementChild.tagName&&n.querySelector(".line-number")&&n.querySelector(".line-content")&&(i=!0),i){const n=t||e;return/\n/.test(n)||1===a.length?`<div data-type="NodeCodeBlock" class="code-block" data-node-id="${Lute.NewNodeID()}"><div class="protyle-action"><span class="protyle-action--first protyle-action__language" contenteditable="false">${localStorage.getItem(u.Constants.LOCAL_CODELANG)||""}</span><span class="fn__flex-1"></span><span class="protyle-icon protyle-icon--first protyle-action__copy"><svg><use xlink:href="#iconCopy"></use></svg></span><span class="protyle-icon protyle-icon--last protyle-action__menu"><svg><use xlink:href="#iconMore"></use></svg></span></div><div contenteditable="true" spellcheck="false">${n.replace(/&/g,"&amp;").replace(/</g,"&lt;")}<wbr></div><div class="protyle-attr" contenteditable="false">${u.Constants.ZWSP}</div></div>`:n}return!1};t.processRender=e=>{const t=e.getAttribute("data-subtype");if(!["abc","plantuml","mermaid","flowchart","echarts","mindmap","graphviz","math"].includes(t))return(0,i.abcRender)(e),(0,c.plantumlRender)(e),(0,l.mermaidRender)(e),(0,d.flowchartRender)(e),(0,a.chartRender)(e),(0,r.mindmapRender)(e),(0,s.graphvizRender)(e),void(0,o.mathRender)(e);"abc"===t?(0,i.abcRender)(e):"plantuml"===t?(0,c.plantumlRender)(e):"mermaid"===t?(0,l.mermaidRender)(e):"flowchart"===t?(0,d.flowchartRender)(e):"echarts"===t?(0,a.chartRender)(e):"mindmap"===t?(0,r.mindmapRender)(e):"graphviz"===t?(0,s.graphvizRender)(e):"math"===t&&(0,o.mathRender)(e)}},5715:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.reloadProtyle=void 0;const i=n(7994),a=n(7683),s=n(8438),o=n(1040),l=n(6245);t.reloadProtyle=e=>{window.siyuan.config.editor.displayBookmarkIcon?e.wysiwyg.element.classList.add("protyle-wysiwyg--attr"):e.wysiwyg.element.classList.remove("protyle-wysiwyg--attr"),e.lute.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),(0,i.addLoading)(e),(0,a.fetchPost)("/api/filetree/getDoc",{id:e.block.showAll?e.block.id:e.block.rootID,mode:0,size:e.block.showAll?s.Constants.SIZE_GET_MAX:s.Constants.SIZE_GET},(t=>{(0,o.onGet)(t,e,e.block.showAll?[s.Constants.CB_GET_ALL,s.Constants.CB_GET_FOCUS]:[s.Constants.CB_GET_FOCUS],(0,l.saveScroll)(e,!0),!0)}))}},2386:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.focusSideBlock=t.focusBlock=t.focusByRange=t.focusByWbr=t.focusByOffset=t.setFirstNodeRange=t.setLastNodeRange=t.getSelectionOffset=t.getSelectionPosition=t.getEditorRange=t.selectAll=t.fixTableRange=void 0;const i=n(3903),a=n(7821),s=n(9229);t.fixTableRange=e=>{const t=(0,a.hasClosestByAttribute)(e.startContainer,"data-type","NodeTable");if(""!==e.toString()&&t&&3!==e.commonAncestorContainer.nodeType){const n=e.commonAncestorContainer.tagName;if("TH"!==n&&"TD"!==n){const n=(0,a.hasClosestByMatchTag)(e.startContainer,"TD")||(0,a.hasClosestByMatchTag)(e.startContainer,"TH"),i=(0,a.hasClosestByMatchTag)(e.endContainer,"TD")||(0,a.hasClosestByMatchTag)(e.endContainer,"TH");if(n||i){if(n&&!n.contains(e.endContainer)){const t=e.cloneRange();e.setEnd(n.lastChild,n.lastChild.textContent.length),""===e.toString()&&i&&(e.setStart(i.firstChild,0),e.setEnd(t.endContainer,t.endOffset))}}else{const n=t.querySelector("th")||t.querySelector("td");e.setStart(n.firstChild,0),e.setEnd(n.lastChild,n.lastChild.textContent.length)}}}};t.selectAll=(e,n,o)=>{const l=(0,i.getContenteditableElement)(n);if(l){let i;if("TABLE"===l.tagName){const l=(0,a.hasClosestByMatchTag)(o.startContainer,"TD")||(0,a.hasClosestByMatchTag)(o.startContainer,"TH");if(l&&(i=(0,t.getSelectionOffset)(l,n,o),0!==i.start||i.end!==l.textContent.length))return o.setStart(l.firstChild,0),o.setEndAfter(l.lastChild),e.toolbar.render(e,o),(0,s.countSelectWord)(o),!0}else if(i=(0,t.getSelectionOffset)(l,n,o),0!==i.start||i.end!==l.textContent.length){let t=l.firstChild;for(;t;)if(3===t.nodeType){if(""!==t.textContent){o.setStart(t,0);break}t=t.nextSibling}else{if(t.classList.contains("render-node")||t.classList.contains("img")){o.setStartBefore(t);break}t=t.firstChild}let n=l.lastChild;for(;n;)if(3===n.nodeType){if(""!==n.textContent){o.setEnd(n,n.textContent.length);break}n=n.previousSibling}else{if(n.classList.contains("render-node")||n.classList.contains("img")||"BR"===n.tagName){o.setEndAfter(n);break}n=n.lastChild}return e.toolbar.render(e,o),(0,s.countSelectWord)(o),!0}}o.collapse(!0);const r=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(e.wysiwyg.element.childElementCount===r.length&&r[0].parentElement.isSameNode(e.wysiwyg.element))return!0;r.forEach((e=>{e.classList.remove("protyle-wysiwyg--select")}));const d=[];Array.from(e.wysiwyg.element.children).forEach((e=>{e.classList.add("protyle-wysiwyg--select"),d.push(e.getAttribute("data-node-id"))})),(0,s.countBlockWord)(d)};t.getEditorRange=e=>{let t,n;return getSelection().rangeCount>0&&(t=getSelection().getRangeAt(0),e.isSameNode(t.startContainer)||e.contains(t.startContainer))||(e.focus({preventScroll:!0}),e.classList.contains("table")?n=e.querySelector("th")||e.querySelector("td"):(n=(0,i.getContenteditableElement)(e),n?"TABLE"===n.tagName&&(n=n.querySelector("th")||e.querySelector("td")):n=e),t=n.ownerDocument.createRange(),t.setStart(n||e,0),t.collapse(!0)),t};t.getSelectionPosition=(e,n)=>{if(n||(n=(0,t.getEditorRange)(e)),!e.contains(n.startContainer))return{left:0,top:0};let i;if(0===n.getClientRects().length)if(3===n.startContainer.nodeType){const e=n.startContainer.parentElement;if(!(e&&e.getClientRects().length>0))return{left:0,top:0};i=e.getClientRects()[0]}else{const e=n.startContainer.children;if(e[n.startOffset]&&e[n.startOffset].getClientRects().length>0)i=e[n.startOffset].getClientRects()[0];else if(n.startContainer.childNodes.length>0){const e=n.cloneRange();n.selectNode(n.startContainer.childNodes[Math.max(0,n.startOffset-1)]),i=n.getClientRects()[0],n.setEnd(e.endContainer,e.endOffset),n.setStart(e.startContainer,e.startOffset)}else i=n.startContainer.getClientRects()[0];if(!i){let e=n.startContainer.childNodes[n.startOffset];for(e||(e=n.startContainer.childNodes[n.startOffset-1]);!e.getClientRects||e.getClientRects&&0===e.getClientRects().length;)e=e.parentElement;i=e.getClientRects()[0]}}else i=n.getBoundingClientRect();return{left:i.left,top:i.top}};function o(e,t,n,i){if(!t)return!1;if(n(t))return!0;for(let e=0,i=t.childNodes.length;e<i;e++)if(o(t,t.childNodes[e],n,!0))return!0;if(!i){let i=t;for(;i&&i!==e;){let t=i.nextSibling;for(;t;){if(o(e,t,n,!0))return!0;t=t.nextSibling}i=i.parentNode}}return!1}t.getSelectionOffset=(e,t,n)=>{const i={end:0,start:0};if(!n){if(0===getSelection().rangeCount)return i;n=window.getSelection().getRangeAt(0)}if(t&&!((e,t)=>{if(!t){if(0===getSelection().rangeCount)return!1;t=getSelection().getRangeAt(0)}const n=t.commonAncestorContainer;return e.isEqualNode(n)||e.contains(n)})(t,n))return i;const a=n.cloneRange();return e.childNodes[0]&&e.childNodes[0].childNodes[0]?a.setStart(e.childNodes[0].childNodes[0],0):a.selectNodeContents(e),a.setEnd(n.startContainer,n.startOffset),i.start=a.toString().length,i.end=i.start+n.toString().length,i};t.setLastNodeRange=(e,t,n=!0)=>{if(!e)return t;let i=e.lastChild;for(;i&&3!==i.nodeType;)i=i.lastChild;return i?(n?t.setStart(i,i.textContent.length):t.setEnd(i,i.textContent.length),t):(t.selectNodeContents(e),t)};t.setFirstNodeRange=(e,t)=>{if(!e)return t;let n=e.firstChild;for(;n&&3!==n.nodeType;)n=n.firstChild;return n?(t.setStart(n,0),t):(t.selectNodeContents(e),t)};t.focusByOffset=(e,n,a)=>{if(!e)return!1;const s=(0,i.getContenteditableElement)(e);if(s)e=s;else if((0,i.isNotEditBlock)(e))return(0,t.focusBlock)(e);let l,r;o(e,e.firstChild,(e=>{if(e.nodeType===Node.TEXT_NODE){const t=e.data.length;return n<=t?(l=e,!0):(n-=t,a-=t,!1)}})),l&&o(e,l,(e=>{if(e.nodeType===Node.TEXT_NODE){const t=e.data.length;return a<=t?(r=e,!0):(a-=t,!1)}}));const d=document.createRange();return l?n<l.data.length?d.setStart(l,n):d.setStartAfter(l):0===n?d.setStart(e,0):(0,t.setLastNodeRange)((0,i.getContenteditableElement)(e),d),r?a<r.data.length?d.setEnd(r,a):d.setEndAfter(r):0===a?d.setEnd(e,0):(0,t.setLastNodeRange)((0,i.getContenteditableElement)(e),d,!1),(0,t.focusByRange)(d),d};t.focusByWbr=(e,n)=>{var a;const s=e.querySelectorAll("wbr");if(0===s.length)return;s.forEach(((e,t)=>{0!==t&&e.remove()}));const o=s[0];if(o.previousElementSibling){const e=(0,i.hasPreviousSibling)(o);e&&o.previousElementSibling.isSameNode(e)?3===(null===(a=o.previousElementSibling.lastChild)||void 0===a?void 0:a.nodeType)?n.setStart(o.previousElementSibling.lastChild,o.previousElementSibling.lastChild.textContent.length):3!==e.nodeType&&e.classList.contains("img")?n.setStartAfter(e):n.setStartBefore(o):n.setStart(o.previousSibling,o.previousSibling.textContent.length)}else o.previousSibling?n.setStart(o.previousSibling,o.previousSibling.textContent.length):o.nextSibling?3===o.nextSibling.nodeType?n.setStart(o.nextSibling,0):n.setStartAfter(o):n.setStart(o.parentElement,0);n.collapse(!0),o.remove(),(0,t.focusByRange)(n)};t.focusByRange=e=>{if(!e)return;const t=window.getSelection();t.removeAllRanges(),t.addRange(e)};t.focusBlock=(e,n,a=!0)=>{var s,o,l;if(!e)return!1;if(e.classList.contains("render-node")||e.classList.contains("iframe")||e.classList.contains("hr")){const n=document.createRange(),i=e.getAttribute("data-type");let a=!1;return"NodeThematicBreak"===i?(n.selectNodeContents(e.firstElementChild),a=!0):"NodeBlockQueryEmbed"===i?((null===(s=e.lastElementChild.previousElementSibling)||void 0===s?void 0:s.firstChild)?(n.selectNodeContents(e.lastElementChild.previousElementSibling.firstChild),n.collapse(!0)):(n.selectNodeContents(e),n.collapse(!0)),a=!0):["NodeMathBlock","NodeHTMLBlock"].includes(i)?((null===(l=null===(o=e.lastElementChild.previousElementSibling)||void 0===o?void 0:o.lastElementChild)||void 0===l?void 0:l.firstChild)?(n.selectNodeContents(e.lastElementChild.previousElementSibling.lastElementChild.firstChild),n.collapse(!0)):e.lastElementChild.previousElementSibling&&(n.selectNodeContents(e.lastElementChild.previousElementSibling),n.collapse(!0)),a=!0):"NodeIFrame"===i||"NodeWidget"===i?(n.setStart(e,0),a=!0):"NodeVideo"===i?(n.setStart(e.firstElementChild,0),a=!0):"NodeAudio"===i?(n.setStart(e.firstElementChild.lastChild,0),a=!0):"NodeCodeBlock"===i&&(n.selectNodeContents(e),n.collapse(!0),a=!0),a?((0,t.focusByRange)(n),n):((0,t.focusSideBlock)(e),!1)}let r;if(a?r=(0,i.getContenteditableElement)(e):Array.from(e.querySelectorAll('[contenteditable="true"]')).reverse().find((e=>{if(e.getBoundingClientRect().width>0)return r=e,!0})),r){if("TABLE"===r.tagName)if(a)r=r.querySelector("th, td");else{const e=r.querySelectorAll("th, td");r=e[e.length-1]}const e=(0,t.getEditorRange)(r);return e.selectNodeContents(r),e.collapse(a),(0,t.focusByRange)(e),e}return n&&n.focus(),!1};t.focusSideBlock=e=>{if(e.getAttribute("data-node-id")){let n,a;return e.nextElementSibling&&!e.nextElementSibling.classList.contains("protyle-attr")?(a=!0,n=(0,i.getNextBlock)(e)):e.previousElementSibling&&(a=!1,n=(0,i.getPreviousBlock)(e)),n||(n=e),void(0,t.focusBlock)(n,void 0,a)}const n=(0,t.getEditorRange)(e);e.nextSibling?(n.selectNodeContents(e.nextSibling),n.collapse(!0)):e.previousSibling&&(n.selectNodeContents(e.previousSibling),n.collapse(!1)),(0,t.focusByRange)(n)}},8461:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setEditMode=void 0;const i=n(7994),a=n(5615);t.setEditMode=(e,t)=>{var n,s,o,l;if("preview"===t){if(!e.preview.element.classList.contains("fn__none"))return;e.preview.element.classList.remove("fn__none"),e.contentElement.classList.add("fn__none"),null===(n=e.scroll)||void 0===n||n.element.classList.add("fn__none"),e.options.render.breadcrumb&&(null===(s=e.breadcrumb)||void 0===s||s.element.classList.add("fn__none")),e.preview.render(e)}else if("wysiwyg"===t){if((0,i.setPadding)(e),!e.contentElement.classList.contains("fn__none"))return;e.preview.element.classList.add("fn__none"),e.contentElement.classList.remove("fn__none"),e.options.render.scroll&&(null===(o=e.scroll)||void 0===o||o.element.classList.remove("fn__none")),e.options.render.breadcrumb&&(null===(l=e.breadcrumb)||void 0===l||l.element.classList.remove("fn__none"))}(0,a.hideElements)(["gutter","toolbar","select","hint","util"],e)}},1301:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fixTable=t.moveColumnToRight=t.moveColumnToLeft=t.moveRowToDown=t.moveRowToUp=t.deleteColumn=t.deleteRow=t.insertColumn=t.insertRowAbove=t.insertRow=t.setTableAlign=t.getColIndex=void 0;const i=n(1985),a=n(2386),s=n(7821),o=n(1676),l=n(532),r=n(5449);t.getColIndex=e=>{let t=e.previousElementSibling,n=0;for(;t;)n++,t=t.previousElementSibling;return n};const d=(e,t,n=!0)=>{let i=e.previousElementSibling;return i||(i=e.parentElement.previousElementSibling?e.parentElement.previousElementSibling.lastElementChild:"TBODY"===e.parentElement.parentElement.tagName&&e.parentElement.parentElement.previousElementSibling?e.parentElement.parentElement.previousElementSibling.lastElementChild.lastElementChild:null),i&&(t.selectNodeContents(i),n||t.collapse(!1),(0,a.focusByRange)(t)),i};t.setTableAlign=(e,t,n,a,s)=>{s.insertNode(document.createElement("wbr"));const o=n.outerHTML,l=n.querySelector("table"),r=l.rows[0].cells.length,d=l.rows.length,c=[];for(let e=0;e<d;e++){for(let n=0;n<r;n++)l.rows[e].cells[n].isSameNode(t[c.length])&&c.push(n);if(c.length>0)break}for(let e=0;e<d;e++)c.forEach((t=>{l.rows[e].cells[t].setAttribute("align",a)}));(0,i.updateTransaction)(e,n.getAttribute("data-node-id"),n.outerHTML,o),n.querySelector("wbr").remove()};t.insertRow=(e,t,n,a)=>{t.insertNode(document.createElement("wbr"));const s=a.outerHTML;let o="";for(let e=0;e<n.parentElement.childElementCount;e++)o+=`<td align="${n.parentElement.children[e].getAttribute("align")||""}"> </td>`;if("TH"===n.tagName){const e=a.querySelector("tbody");e?e.insertAdjacentHTML("afterbegin",`<tr>${o}</tr>`):n.parentElement.parentElement.insertAdjacentHTML("afterend",`<tbody><tr>${o}</tr></tbody>`)}else n.parentElement.insertAdjacentHTML("afterend",`<tr>${o}</tr>`);(0,i.updateTransaction)(e,a.getAttribute("data-node-id"),a.outerHTML,s),a.querySelector("wbr").remove()};t.insertRowAbove=(e,t,n,s)=>{t.insertNode(document.createElement("wbr"));const o=s.outerHTML;let l="",r=!1;for(let e=0;e<n.parentElement.childElementCount;e++){const t=n.parentElement.children[e];"fn__none"===t.className&&(r=!0),"TH"===n.tagName?l+=`<th class="${t.className}" colspan="${t.colSpan}"  align="${t.getAttribute("align")}"> </th>`:l+=`<td class="${t.className}" colspan="${t.colSpan}" align="${t.getAttribute("align")}"> </td>`}if(r){let e=n.parentElement.previousElementSibling,t=1;for(;e;)t++,Array.from(e.children).forEach((e=>{e.rowSpan>=t&&e.rowSpan>1&&(e.rowSpan=e.rowSpan+1)})),e=e.previousElementSibling}"THEAD"!==n.parentElement.parentElement.tagName||n.parentElement.previousElementSibling?n.parentElement.insertAdjacentHTML("beforebegin",`<tr>${l}</tr>`):(n.parentElement.parentElement.insertAdjacentHTML("beforebegin",`<thead><tr>${l}</tr></thead>`),n.parentElement.parentElement.nextElementSibling.insertAdjacentHTML("afterbegin",n.parentElement.parentElement.innerHTML),n.parentElement.parentElement.remove()),(0,i.updateTransaction)(e,s.getAttribute("data-node-id"),s.outerHTML,o),(0,a.focusByWbr)(e.wysiwyg.element,t)};t.insertColumn=(e,n,a,s,o)=>{o.insertNode(document.createElement("wbr"));const l=n.outerHTML,r=(0,t.getColIndex)(a),d=n.querySelector("table");for(let e=0;e<d.rows.length;e++)0===e?d.rows[e].cells[r].insertAdjacentHTML(s,"<th></th>"):d.rows[e].cells[r].insertAdjacentHTML(s,"<td></td>");d.querySelectorAll("col")[r].insertAdjacentHTML(s,"<col>"),(0,i.updateTransaction)(e,n.getAttribute("data-node-id"),n.outerHTML,l),n.querySelector("wbr").remove()};t.deleteRow=(e,t,n,s)=>{if("THEAD"!==n.parentElement.parentElement.tagName){t.insertNode(document.createElement("wbr"));const o=s.outerHTML,l=n.parentElement.parentElement;n.parentElement.previousElementSibling?t.selectNodeContents(n.parentElement.previousElementSibling.lastElementChild):t.selectNodeContents(l.previousElementSibling.lastElementChild.lastElementChild),1===l.childElementCount?l.remove():n.parentElement.remove(),t.collapse(!1),t.insertNode(document.createElement("wbr")),(0,i.updateTransaction)(e,s.getAttribute("data-node-id"),s.outerHTML,o),(0,a.focusByWbr)(s,t)}};t.deleteColumn=(e,n,s,o)=>{var l;n.insertNode(document.createElement("wbr"));const r=s.outerHTML,d=(0,t.getColIndex)(o);(o.previousElementSibling||o.nextElementSibling)&&(n.selectNodeContents(o.previousElementSibling||o.nextElementSibling),n.collapse(!0),n.insertNode(document.createElement("wbr")));const c=s.querySelector("table");for(let e=0;e<c.rows.length;e++){const t=c.rows[e].cells;if(1===t.length){c.remove();break}t[d].remove()}null===(l=s.querySelectorAll("col")[d])||void 0===l||l.remove(),(0,i.updateTransaction)(e,s.getAttribute("data-node-id"),s.outerHTML,r),(0,a.focusByWbr)(s,n)};t.moveRowToUp=(e,t,n,s)=>{const o=n.parentElement;if("THEAD"===o.parentElement.tagName)return;t.insertNode(document.createElement("wbr"));const l=s.outerHTML;if(o.previousElementSibling)o.after(o.previousElementSibling);else{const e=o.parentElement.previousElementSibling.firstElementChild;e.querySelectorAll("th").forEach((e=>{const t=document.createElement("td");t.innerHTML=e.innerHTML,e.parentNode.replaceChild(t,e)})),o.querySelectorAll("td").forEach((e=>{const t=document.createElement("th");t.innerHTML=e.innerHTML,e.parentNode.replaceChild(t,e)})),o.after(e),o.parentElement.previousElementSibling.append(o)}(0,i.updateTransaction)(e,s.getAttribute("data-node-id"),s.outerHTML,l),(0,a.focusByWbr)(s,t)};t.moveRowToDown=(e,t,n,s)=>{const o=n.parentElement;if("TBODY"===o.parentElement.tagName&&!o.nextElementSibling||"THEAD"===o.parentElement.tagName&&!o.parentElement.nextElementSibling)return;t.insertNode(document.createElement("wbr"));const l=s.outerHTML;if(o.nextElementSibling)o.before(o.nextElementSibling);else{const e=o.parentElement.nextElementSibling.firstElementChild;e.querySelectorAll("td").forEach((e=>{const t=document.createElement("th");t.innerHTML=e.innerHTML,e.parentNode.replaceChild(t,e)})),o.querySelectorAll("th").forEach((e=>{const t=document.createElement("td");t.innerHTML=e.innerHTML,e.parentNode.replaceChild(t,e)})),o.after(e),o.parentElement.nextElementSibling.insertAdjacentElement("afterbegin",o)}(0,i.updateTransaction)(e,s.getAttribute("data-node-id"),s.outerHTML,l),(0,a.focusByWbr)(s,t)};t.moveColumnToLeft=(e,t,n,s)=>{if(!n.previousElementSibling)return;t.insertNode(document.createElement("wbr"));const o=s.outerHTML;let l=0;Array.from(n.parentElement.children).find(((e,t)=>{if(n.isSameNode(e))return l=t,!0})),s.querySelectorAll("tr").forEach((e=>{e.cells[l].after(e.cells[l-1])}));const r=s.querySelectorAll("col");r[l].after(r[l-1]),(0,i.updateTransaction)(e,s.getAttribute("data-node-id"),s.outerHTML,o),(0,a.focusByWbr)(s,t)};t.moveColumnToRight=(e,t,n,s)=>{if(!n.nextElementSibling)return;t.insertNode(document.createElement("wbr"));const o=s.outerHTML;let l=0;Array.from(n.parentElement.children).find(((e,t)=>{if(n.isSameNode(e))return l=t,!0})),s.querySelectorAll("tr").forEach((e=>{e.cells[l].before(e.cells[l+1])}));const r=s.querySelectorAll("col");r[l].before(r[l+1]),(0,i.updateTransaction)(e,s.getAttribute("data-node-id"),s.outerHTML,o),(0,a.focusByWbr)(s,t)};t.fixTable=(e,n,i)=>{var c,u,p;const m=(0,s.hasClosestByMatchTag)(i.startContainer,"TD")||(0,s.hasClosestByMatchTag)(i.startContainer,"TH"),g=(0,s.hasClosestBlock)(i.startContainer);if(!m||!g)return!1;if(g.classList.contains("protyle-wysiwyg--select"))return!1;if("Tab"===n.key&&!n.ctrlKey){if(n.shiftKey)return d(m,i),n.preventDefault(),!0;let a=m.nextElementSibling;return a||(a=m.parentElement.nextElementSibling?m.parentElement.nextElementSibling.firstElementChild:"THEAD"===m.parentElement.parentElement.tagName&&m.parentElement.parentElement.nextElementSibling?m.parentElement.parentElement.nextElementSibling.firstElementChild.firstElementChild:null),a?i.selectNodeContents(a):((0,t.insertRow)(e,i,m,g),i.selectNodeContents(g.querySelector("tbody").lastElementChild.firstElementChild)),n.preventDefault(),!0}if("ArrowUp"===n.key&&!(0,l.isCtrl)(n)&&!n.shiftKey&&!n.altKey){const a=i.startContainer;let s;for(s=3===a.nodeType||"TH"!==a.tagName&&"TD"!==a.tagName?a.previousElementSibling:null===(c=a.childNodes[Math.max(0,i.startOffset-1)])||void 0===c?void 0:c.previousElementSibling;s;){if("BR"===s.tagName)return!1;s=s.previousElementSibling}const o=m.parentElement;let l=o.previousElementSibling;return l||(l=o.parentElement.previousElementSibling.lastElementChild),l&&"COL"!==(null==l?void 0:l.tagName)?(i.selectNodeContents(l.cells[(0,t.getColIndex)(m)]),i.collapse(!1),(0,r.scrollCenter)(e),n.preventDefault(),!0):!1}if("ArrowDown"===n.key&&!(0,l.isCtrl)(n)&&!n.shiftKey&&!n.altKey){const a=i.endContainer;let s;for(s=3===a.nodeType||"TH"!==a.tagName&&"TD"!==a.tagName?a.nextElementSibling:null===(u=a.childNodes[Math.max(0,i.endOffset-1)])||void 0===u?void 0:u.nextElementSibling;s;){if("BR"===s.tagName)return!1;s=s.nextElementSibling}const o=m.parentElement;if(!o.nextElementSibling&&"TBODY"===o.parentElement.tagName||"THEAD"===o.parentElement.tagName&&!o.parentElement.nextElementSibling)return!1;let l=o.nextElementSibling;return l||(l=o.parentElement.nextElementSibling.firstChild),l?(i.selectNodeContents(l.cells[(0,t.getColIndex)(m)]),i.collapse(!0),(0,r.scrollCenter)(e),n.preventDefault(),!0):!1}if(!(0,l.isCtrl)(n)&&!n.shiftKey&&!n.altKey&&"Backspace"===n.key&&0===(0,a.getSelectionOffset)(m,e.wysiwyg.element,i).start&&""===i.toString()&&(0===i.startOffset||1===i.startOffset&&1===m.querySelectorAll("br").length)){return!d(m,i,!1)&&g.previousElementSibling&&(0,a.focusBlock)(g.previousElementSibling,void 0,!1),(0,r.scrollCenter)(e),n.preventDefault(),!0}if((0,o.matchHotKey)(window.siyuan.config.keymap.editor.general.alignLeft.custom,n))return(0,t.setTableAlign)(e,[m],g,"left",i),n.preventDefault(),!0;if((0,o.matchHotKey)(window.siyuan.config.keymap.editor.general.alignCenter.custom,n))return(0,t.setTableAlign)(e,[m],g,"center",i),n.preventDefault(),!0;if((0,o.matchHotKey)(window.siyuan.config.keymap.editor.general.alignRight.custom,n))return(0,t.setTableAlign)(e,[m],g,"right",i),n.preventDefault(),!0;const b=g.querySelector("table"),y=m.parentElement.querySelector(".fn__none");let f=!1,h=!1;Array.from(m.parentElement.children).forEach((e=>{e.colSpan>1&&(f=!0),e.rowSpan>1&&(h=!0)}));let w=!1,v=!1,_=!1,E=m.parentElement.previousElementSibling;E||"TBODY"!==m.parentElement.parentElement.tagName||(E=b.querySelector("thead").lastElementChild),E&&(w=E.querySelector(".fn__none"),Array.from(E.children).forEach((e=>{e.colSpan>1&&(v=!0),e.rowSpan>1&&(_=!0)})));let k=!1,C=!1,x=!1,L=m.parentElement.nextElementSibling;L||"THEAD"!==m.parentElement.parentElement.tagName||(L=null===(p=b.querySelector("tbody"))||void 0===p?void 0:p.firstElementChild),L&&(k=L.querySelector(".fn__none"),Array.from(L.children).forEach((e=>{e.colSpan>1&&(C=!0),e.rowSpan>1&&(x=!0)})));const S=(0,t.getColIndex)(m);let T=!0;Array.from(b.rows).find((e=>{const t=e.cells[S];if(t.classList.contains("fn__none")||t.colSpan>1||t.rowSpan>1)return T=!1,!0}));let A=!0;Array.from(b.rows).find((e=>{const t=e.cells[S+1];if(t&&(t.classList.contains("fn__none")||t.colSpan>1||t.rowSpan>1))return A=!1,!0}));let M=!0;return Array.from(b.rows).find((e=>{const t=e.cells[S-1];if(t&&(t.classList.contains("fn__none")||t.colSpan>1||t.rowSpan>1))return M=!1,!0})),(0,o.matchHotKey)(window.siyuan.config.keymap.editor.table.moveToUp.custom,n)?((!y||y&&!h&&f)&&(!w||w&&!_&&v)&&(0,t.moveRowToUp)(e,i,m,g),n.preventDefault(),!0):(0,o.matchHotKey)(window.siyuan.config.keymap.editor.table.moveToDown.custom,n)?((!y||y&&!h&&f)&&(!k||k&&!x&&C)&&(0,t.moveRowToDown)(e,i,m,g),n.preventDefault(),!0):(0,o.matchHotKey)(window.siyuan.config.keymap.editor.table.moveToLeft.custom,n)?(T&&M&&(0,t.moveColumnToLeft)(e,i,m,g),n.preventDefault(),!0):(0,o.matchHotKey)(window.siyuan.config.keymap.editor.table.moveToRight.custom,n)?(T&&A&&(0,t.moveColumnToRight)(e,i,m,g),n.preventDefault(),!0):(0,o.matchHotKey)(window.siyuan.config.keymap.editor.table.insertRowAbove.custom,n)?((0,t.insertRowAbove)(e,i,m,g),n.preventDefault(),n.stopPropagation(),!0):(0,o.matchHotKey)(window.siyuan.config.keymap.editor.table.insertRowBelow.custom,n)?((!k||k&&!x&&C)&&(0,t.insertRow)(e,i,m,g),n.preventDefault(),!0):(0,o.matchHotKey)(window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,n)?((T||M)&&(0,t.insertColumn)(e,g,m,"beforebegin",i),n.preventDefault(),!0):(0,o.matchHotKey)(window.siyuan.config.keymap.editor.table.insertColumnRight.custom,n)?((T||A)&&(0,t.insertColumn)(e,g,m,"afterend",i),n.preventDefault(),!0):(0,o.matchHotKey)(window.siyuan.config.keymap.editor.table["delete-row"].custom,n)?((!y&&!h||y&&!h&&f)&&(0,t.deleteRow)(e,i,m,g),n.preventDefault(),!0):(0,o.matchHotKey)(window.siyuan.config.keymap.editor.table["delete-column"].custom,n)?(T&&(0,t.deleteColumn)(e,i,g,m),n.preventDefault(),!0):void 0}},4652:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.enter=void 0;const i=n(3053),a=n(2386),s=n(3903),o=n(1985),l=n(9407),r=n(7821),d=n(1456),c=n(8438),u=n(5449);t.enter=(e,t,n)=>{var m,g;const b=(0,s.isNotEditBlock)(e);if(!b&&e.classList.contains("protyle-wysiwyg--select"))return(0,a.setLastNodeRange)((0,s.getContenteditableElement)(e),t,!1),t.collapse(!1),void e.classList.remove("protyle-wysiwyg--select");if(b){if(e.parentElement.classList.contains("li")){const i=e.parentElement.parentElement.outerHTML,s=(0,l.genListItemElement)(e.parentElement,0,!0);return e.parentElement.insertAdjacentElement("afterend",s),(0,o.updateTransaction)(n,e.parentElement.parentElement.getAttribute("data-node-id"),e.parentElement.parentElement.outerHTML,i),(0,a.focusByWbr)(s,t),p(s),void(0,u.scrollCenter)(n)}return e.classList.contains("hr")?void(0,i.insertEmptyBlock)(n,"afterend"):void(e.classList.contains("protyle-wysiwyg--select")&&e.classList.contains("render-node")?n.toolbar.showRender(n,e):(0,i.insertEmptyBlock)(n,"afterend"))}const y=(0,s.getContenteditableElement)(e);y.querySelectorAll(".img--select").forEach((e=>{e.classList.remove("img--select")}));const f=y.innerHTML.trimStart();if((f.startsWith("```")||f.startsWith("···")||f.startsWith("~~~")||f.indexOf("\n```")>-1||f.indexOf("\n~~~")>-1||f.indexOf("\n···")>-1)&&!(-1===f.indexOf("\n")&&f.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){const t=e.outerHTML;let i=y.innerHTML.replace(/^(~|·|`){3,}/g,"```").replace(/\n(~|·|`){3,}/g,"\n```").trim();i.endsWith("\n```")||(i+="<wbr>\n```"),y.innerHTML=i,e.outerHTML=n.lute.SpinBlockDOM(e.outerHTML);const a=(e=n.wysiwyg.element.querySelector(`[data-node-id="${e.getAttribute("data-node-id")}"]`)).querySelector(".protyle-action__language");return a?(localStorage.getItem(c.Constants.LOCAL_CODELANG)&&""===a.textContent?a.textContent=localStorage.getItem(c.Constants.LOCAL_CODELANG):localStorage.setItem(c.Constants.LOCAL_CODELANG,a.textContent),(0,d.highlightRender)(e)):n.toolbar.showRender(n,e),(0,o.updateTransaction)(n,e.getAttribute("data-node-id"),e.outerHTML,t),!0}if("NodeCodeBlock"===e.getAttribute("data-type")){const i=document.createElement("wbr");t.insertNode(i);const a=e.outerHTML;return i.remove(),t.extractContents(),y.textContent.endsWith("\n")||y.insertAdjacentText("beforeend","\n"),t.insertNode(document.createTextNode("\n")),t.collapse(!1),t.insertNode(i),y.removeAttribute("data-render"),(0,d.highlightRender)(e),(0,o.updateTransaction)(n,e.getAttribute("data-node-id"),e.outerHTML,a),!0}if("NodeTable"===e.getAttribute("data-type")&&((0,r.hasClosestByMatchTag)(t.startContainer,"TD")||(0,r.hasClosestByMatchTag)(t.startContainer,"TH"))){const i=document.createElement("wbr");t.insertNode(i);const a=e.outerHTML;i.remove();const s=(0,r.hasClosestByMatchTag)(t.startContainer,"TD")||(0,r.hasClosestByMatchTag)(t.startContainer,"TH");s&&!s.innerHTML.endsWith("<br>")&&s.insertAdjacentHTML("beforeend","<br>"),t.extractContents();if(n.toolbar.getCurrentType(t).includes("code")&&3!==t.startContainer.nodeType){const e=document.createElement("br");t.startContainer.after(e),t.setStartAfter(e)}else t.insertNode(document.createElement("br"));return t.collapse(!1),(0,u.scrollCenter)(n),(0,o.updateTransaction)(n,e.getAttribute("data-node-id"),e.outerHTML,a),!0}if(""===y.textContent&&e.nextElementSibling&&e.nextElementSibling.classList.contains("protyle-attr")&&"NodeBlockquote"===e.parentElement.getAttribute("data-type")){t.insertNode(document.createElement("wbr"));const i=(0,s.getTopEmptyElement)(e),l=e.getAttribute("data-node-id"),r=i.getAttribute("data-node-id"),d={action:"insert",id:l,data:e.outerHTML},c={action:"insert",id:r,data:i.outerHTML};return r===l?(d.previousID=e.parentElement.getAttribute("data-node-id"),c.previousID=e.previousElementSibling.getAttribute("data-node-id"),e.parentElement.after(e)):(d.previousID=i.previousElementSibling?i.previousElementSibling.getAttribute("data-node-id"):void 0,d.parentID=i.parentElement.getAttribute("data-node-id")||n.block.parentID,c.previousID=d.previousID,c.parentID=d.parentID,i.after(e),i.remove()),(0,o.transaction)(n,[{action:"delete",id:r},d],[{action:"delete",id:l},c]),(0,a.focusByWbr)(e,t),!0}const h=(0,a.getSelectionOffset)(y,n.wysiwyg.element,t);if("NodeListItem"===e.parentElement.getAttribute("data-type")&&(e.nextElementSibling.classList.contains("protyle-attr")||e.nextElementSibling.classList.contains("list")&&(null===(m=e.previousElementSibling)||void 0===m?void 0:m.classList.contains("protyle-action"))||0===h.start&&e.previousElementSibling.classList.contains("protyle-action")||"1"===e.parentElement.getAttribute("fold"))&&((e,t,n)=>{var i,r;const d=t.parentElement,m=(0,s.getContenteditableElement)(t);if(["","\n"].includes(m.textContent)&&t.previousElementSibling.classList.contains("protyle-action")&&!t.querySelector("img")){if(null===(i=d.nextElementSibling)||void 0===i?void 0:i.classList.contains("protyle-attr"))return(0,l.listOutdent)(e,[t.parentElement],n),!0;if(!d.parentElement.classList.contains("protyle-wysiwyg"))return(0,l.breakList)(e,t,n),!0}const g=(0,a.getSelectionOffset)(m,e.wysiwyg.element,n);if(""===n.toString()&&0===g.start&&!(0,s.hasPreviousSibling)(n.startContainer)){if(d.parentElement.classList.contains("protyle-wysiwyg"))return!0;const i=d.parentElement.outerHTML;let r=(0,l.genListItemElement)(d,-1,!0);if(t.previousElementSibling.classList.contains("protyle-action"))""===(0,s.getContenteditableElement)(t).textContent?d.insertAdjacentElement("afterend",r):d.insertAdjacentElement("beforebegin",r);else{if(""!==(0,s.getContenteditableElement)(t).textContent)return!1;t.remove(),r=(0,l.genListItemElement)(d,-1,!0),d.insertAdjacentElement("afterend",r)}return"o"===d.getAttribute("data-subtype")&&(0,l.updateListOrder)(d.parentElement),(0,o.updateTransaction)(e,d.parentElement.getAttribute("data-node-id"),d.parentElement.outerHTML,i),(0,a.focusByWbr)(r,n),(0,u.scrollCenter)(e),p(r),!0}const b=d.querySelector(".list");let y;if(b&&"1"!==d.getAttribute("fold")&&t.nextElementSibling.isSameNode(b)){if(g.end>=m.textContent.length){n.insertNode(document.createElement("wbr"));const i=b.outerHTML;t.querySelector("wbr").remove(),y=(0,l.genListItemElement)(b.firstElementChild,-1,!0),b.firstElementChild.before(y),"o"===b.getAttribute("data-subtype")&&(0,l.updateListOrder)(b),(0,o.updateTransaction)(e,b.getAttribute("data-node-id"),b.outerHTML,i),(0,a.focusByWbr)(d,n),(0,u.scrollCenter)(e)}else{n.insertNode(document.createElement("wbr"));const t=d.outerHTML,i=d.parentElement.outerHTML;""!==n.toString()&&(n.extractContents(),n.insertNode(document.createElement("wbr"))),n.setEndAfter(m.lastChild),y=(0,l.genListItemElement)(d,0,!1);const r=(0,s.getContenteditableElement)(y);r.appendChild(n.extractContents()),r.parentElement.after(b),d.insertAdjacentElement("afterend",y),"o"===d.getAttribute("data-subtype")&&(0,l.updateListOrder)(d.parentElement),d.parentElement.classList.contains("protyle-wysiwyg")?(0,o.transaction)(e,[{action:"update",data:d.outerHTML,id:d.getAttribute("data-node-id")},{action:"insert",id:y.getAttribute("data-node-id"),data:y.outerHTML,previousID:d.getAttribute("data-node-id")}],[{action:"delete",id:y.getAttribute("data-node-id")},{action:"update",data:t,id:d.getAttribute("data-node-id")}]):(0,o.updateTransaction)(e,d.parentElement.getAttribute("data-node-id"),d.parentElement.outerHTML,i),(0,a.focusByWbr)(y,n),(0,u.scrollCenter)(e)}return p(y),!0}""!==n.toString()&&n.toString()!==c.Constants.ZWSP||3!==n.startContainer.nodeType||n.startContainer.textContent!==c.Constants.ZWSP||0!==n.startOffset||(n.setStart(n.startContainer,1),n.collapse(!1)),n.insertNode(document.createElement("wbr"));const f=d.outerHTML,h=d.parentElement.outerHTML;""!==n.toString()&&(n.extractContents(),n.insertNode(document.createElement("wbr"))),n.setEndAfter(m.lastChild),y=(0,l.genListItemElement)(d,0,!1);const w=n.extractContents();return 3!==w.firstChild.nodeType&&""===w.firstChild.textContent&&(w.firstChild.after(document.createElement("wbr")),w.firstChild.remove()),(null===(r=null==m?void 0:m.lastElementChild)||void 0===r?void 0:r.getAttribute("data-type").indexOf("inline-math"))>-1&&!(0,s.hasNextSibling)(null==m?void 0:m.lastElementChild)&&m.insertAdjacentText("beforeend","\n"),(0,s.getContenteditableElement)(y).appendChild(w),d.insertAdjacentElement("afterend",y),"o"===d.getAttribute("data-subtype")&&(0,l.updateListOrder)(d.parentElement),d.parentElement.classList.contains("protyle-wysiwyg")?(0,o.transaction)(e,[{action:"update",id:d.getAttribute("data-node-id"),data:d.outerHTML},{action:"insert",id:y.getAttribute("data-node-id"),data:y.outerHTML,previousID:d.getAttribute("data-node-id")}],[{action:"delete",id:y.getAttribute("data-node-id")},{action:"update",id:d.getAttribute("data-node-id"),data:f}]):(0,o.updateTransaction)(e,d.parentElement.getAttribute("data-node-id"),d.parentElement.outerHTML,h),(0,a.focusByWbr)(y,n),(0,u.scrollCenter)(e),p(y),!0})(n,e,t))return!0;if(""!==y.textContent&&""===t.toString()&&0===h.start){const t=(0,i.genEmptyElement)(!1,!0),a=t.getAttribute("data-node-id");return(0,o.transaction)(n,[{action:"insert",data:t.outerHTML,id:a,previousID:e.previousElementSibling?e.previousElementSibling.getAttribute("data-node-id"):"",parentID:e.parentElement.getAttribute("data-node-id")||n.block.parentID}],[{action:"delete",id:a}]),t.querySelector("wbr").remove(),e.insertAdjacentElement("beforebegin",t),p(t),!0}""===t.toString()&&3===t.startContainer.nodeType&&t.startContainer.textContent===c.Constants.ZWSP&&0===t.startOffset&&t.setStart(t.startContainer,1),t.insertNode(document.createElement("wbr"));const w=e.outerHTML;""!==t.toString()&&(t.extractContents(),t.insertNode(document.createElement("wbr"))),y.lastChild&&t.setEndAfter(y.lastChild);const v=(0,i.genEmptyElement)(!1,!1),_=t.extractContents();3!==_.firstChild.nodeType&&""===_.firstChild.textContent&&(_.firstChild.after(document.createElement("wbr")),_.firstChild.remove()),(null===(g=null==y?void 0:y.lastElementChild)||void 0===g?void 0:g.getAttribute("data-type").indexOf("inline-math"))>-1&&!(0,s.hasNextSibling)(null==y?void 0:y.lastElementChild)&&y.insertAdjacentText("beforeend","\n"),(0,s.getContenteditableElement)(v).appendChild(_);const E=e.getAttribute("data-node-id"),k=v.getAttribute("data-node-id");return e.insertAdjacentElement("afterend",v),(0,o.transaction)(n,[{action:"update",data:e.outerHTML,id:E},{action:"insert",data:v.outerHTML,id:k,previousID:E}],[{action:"delete",id:k},{action:"update",data:w,id:E}]),e.insertAdjacentElement("afterend",v),(0,a.focusByWbr)(v,t),(0,u.scrollCenter)(n),p(v),!0};const p=e=>{const t=(0,s.getContenteditableElement)(e).childNodes;for(let e=0;e<t.length;e++)3===t[e].nodeType&&0===t[e].textContent.length&&(t[e].remove(),e--)}},3903:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasPreviousSibling=t.hasNextSibling=t.getTopAloneElement=t.getTopEmptyElement=t.isNotEditBlock=t.getContenteditableElement=t.getNoContainerElement=t.getNextBlock=t.getFirstBlock=t.getLastBlock=t.getPreviousBlock=t.getPreviousHeading=void 0;const i=n(7821);t.getPreviousHeading=e=>{let n=(0,t.getPreviousBlock)(e);for(;n&&"NodeHeading"!==n.getAttribute("data-type");)n=(0,t.getPreviousBlock)(n);return n};t.getPreviousBlock=e=>{let t=e;for(;t;){if(t.previousElementSibling&&t.previousElementSibling.getAttribute("data-node-id"))return t.previousElementSibling;const e=(0,i.hasClosestBlock)(t.parentElement);if(!e)return!1;t=e}};t.getLastBlock=e=>{let t;return Array.from(e.querySelectorAll("[data-node-id]")).reverse().find((e=>{if(!(0,i.hasClosestByAttribute)(e.parentElement,"data-type","NodeBlockQueryEmbed"))return t=e,!0})),t||e};t.getFirstBlock=e=>{let t;return Array.from(e.querySelectorAll("[data-node-id]")).find((e=>{if(!(0,i.hasClosestByAttribute)(e.parentElement,"data-type","NodeBlockQueryEmbed")&&!e.classList.contains("li"))return t=e,!0})),t||e};t.getNextBlock=e=>{let t=e;for(;t;){if(t.nextElementSibling&&!t.nextElementSibling.classList.contains("protyle-attr"))return t.nextElementSibling;const e=(0,i.hasClosestBlock)(t.parentElement);if(!e)return!1;t=e}return!1};t.getNoContainerElement=e=>{let t=e;for(;t;){if(!(t.classList.contains("list")||t.classList.contains("li")||t.classList.contains("bq")||t.classList.contains("sb")))return t;t=t.querySelector("[data-node-id]")}return!1};t.getContenteditableElement=e=>!e||"true"===e.getAttribute("contenteditable")&&!e.classList.contains("protyle-wysiwyg")?e:e.querySelector('[contenteditable="true"]');t.isNotEditBlock=e=>["NodeBlockQueryEmbed","NodeThematicBreak","NodeMathBlock","NodeHTMLBlock","NodeIFrame","NodeWidget","NodeVideo","NodeAudio"].includes(e.getAttribute("data-type"))||"NodeCodeBlock"===e.getAttribute("data-type")&&e.classList.contains("render-node");t.getTopEmptyElement=e=>{var n;let i=e;for(;i.parentElement&&!i.parentElement.classList.contains("protyle-wysiwyg");)if(i.parentElement.getAttribute("data-node-id")){if(""!==(0,t.getContenteditableElement)(i.parentElement).textContent||(null===(n=i.previousElementSibling)||void 0===n?void 0:n.getAttribute("data-node-id")))break;i=i.parentElement}else i=i.parentElement;return i};t.getTopAloneElement=e=>{if("NodeBlockquote"===e.parentElement.getAttribute("data-type")&&2===e.parentElement.childElementCount)for(;!e.parentElement.classList.contains("protyle-wysiwyg");){if("NodeBlockquote"!==e.parentElement.getAttribute("data-type")||2!==e.parentElement.childElementCount){e=(0,t.getTopAloneElement)(e);break}e=e.parentElement}else if("NodeSuperBlock"===e.parentElement.getAttribute("data-type")&&2===e.parentElement.childElementCount)for(;!e.parentElement.classList.contains("protyle-wysiwyg");){if("NodeSuperBlock"!==e.parentElement.getAttribute("data-type")||2!==e.parentElement.childElementCount){e=(0,t.getTopAloneElement)(e);break}e=e.parentElement}else if("NodeListItem"===e.parentElement.getAttribute("data-type")&&3===e.parentElement.childElementCount)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if("NodeListItem"===e.parentElement.getAttribute("data-type")&&3===e.parentElement.childElementCount)e=e.parentElement;else{if("NodeList"!==e.parentElement.getAttribute("data-type")||2!==e.parentElement.childElementCount){e=(0,t.getTopAloneElement)(e);break}e=e.parentElement}else if("NodeList"===e.parentElement.getAttribute("data-type")&&2===e.parentElement.childElementCount)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if("NodeList"===e.parentElement.getAttribute("data-type")&&2===e.parentElement.childElementCount)e=e.parentElement;else{if("NodeListItem"!==e.parentElement.getAttribute("data-type")||3!==e.parentElement.childElementCount){e=(0,t.getTopAloneElement)(e);break}e=e.parentElement}return e};t.hasNextSibling=e=>{let t=e.nextSibling;for(;t;){if(""!==t.textContent)return t;t=t.nextSibling}return!1};t.hasPreviousSibling=e=>{let t=e.previousSibling;for(;t;){if(""!==t.textContent||3!==t.nodeType)return t;t=t.previousSibling}return!1}},5948:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WYSIWYG=void 0;const i=n(3343),a=n(7821),s=n(2386),o=n(8438),l=n(6400),r=n(3053),d=n(5306),c=n(6112),u=n(5680),p=n(4170),m=n(3420),g=n(3903),b=n(1985),y=n(5615),f=n(133),h=n(6622),w=n(999),v=n(5967),_=n(1456),E=n(2964),k=n(4383),C=n(532),x=n(6937),L=n(7683),S=n(1040),T=n(1301),A=n(9229),M=n(7491);t.WYSIWYG=class{constructor(e){this.lastHTMLs={},this.element=document.createElement("div"),this.element.className="protyle-wysiwyg",this.element.setAttribute("spellcheck","false"),navigator&&navigator.maxTouchPoints>1&&"MacIntel"===navigator.platform?this.element.setAttribute("contenteditable","false"):this.element.setAttribute("contenteditable","true"),window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),this.bindCommonEvent(e),e.options.action.includes(o.Constants.CB_GET_HISTORY)||(this.bindEvent(e),(0,h.keydown)(e,this.element),(0,p.dropEvent)(e,this.element))}renderCustom(e){const t=Object.keys(e);for(let e=0;e<this.element.attributes.length;e++){const n=this.element.attributes[e].nodeName;["type","class","spellcheck","contenteditable","data-doc-type","style","scroll"].includes(n)||t.includes(n)||(this.element.removeAttribute(n),e--)}t.forEach((t=>{["title-img","title","updated","icon","id","type","class","spellcheck","contenteditable","data-doc-type","style"].includes(t)||this.element.setAttribute(t,e[t])}))}escapeInline(e,t,n){if(!n.data)return;const i=n.data;e.toolbar.range=t;const a=t.startContainer.parentElement,l=e.toolbar.getCurrentType();if("SPAN"===a.tagName&&a.textContent.replace(o.Constants.ZWSP,"")!==i&&""===t.toString()&&3===t.startContainer.nodeType&&(l.includes("inline-memo")||l.includes("text")||l.includes("block-ref")||l.includes("file-annotation-ref")||l.includes("a"))&&!(0,g.hasNextSibling)(t.startContainer)&&t.startContainer.textContent.length===t.startOffset&&a.textContent.replace(o.Constants.ZWSP,"").length>=i.length){const n=(0,s.getSelectionOffset)(a,e.wysiwyg.element,t);let l=i.length;"<"!==i&&">"!==i||(l=4);const r=a.innerHTML.replace(o.Constants.ZWSP,"");if(n.start===a.textContent.length){a.innerHTML=r.substr(0,r.length-l);const e=document.createTextNode(i);a.after(e),t.selectNodeContents(e),t.collapse(!1)}else if(n.start===i.length){a.innerHTML=r.substr(l);const e=document.createTextNode(i);a.before(e),t.selectNodeContents(e),t.collapse(!1)}}}setEmptyOutline(e,t){const n=e.wysiwyg.element.querySelector(".img--select");n&&n.classList.remove("img--select");let i=t;if(!t.getAttribute("data-node-id")){const e=(0,a.hasClosestBlock)(t);if(!e)return;i=e}}bindCommonEvent(e){this.element.addEventListener("copy",(t=>{if("PROTYLE-HTML"===t.target.tagName)return void t.stopPropagation();t.stopPropagation(),t.preventDefault();const n=(0,s.getEditorRange)(e.wysiwyg.element),i=(0,a.hasClosestBlock)(n.startContainer);if(!i)return;const l=i.querySelector(".img--select");let r=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));0!==r.length||""!==n.toString()||n.cloneContents().querySelector("img")||l||(i.classList.add("protyle-wysiwyg--select"),(0,A.countBlockWord)([i.getAttribute("data-node-id")]),r=[i]);let d="",c="";if(r.length>0)"NodeListItem"===r[0].getAttribute("data-type")&&r[0].parentElement.childElementCount-1===r.length?d=r[0].parentElement.outerHTML:r.forEach((e=>{const t=(0,g.getTopAloneElement)(e);d+=(0,f.removeEmbed)(t)}));else{const t=document.createElement("div"),i=e.toolbar.getCurrentType(n);if((i.length>0||"NodeHeading"===n.startContainer.parentElement.parentElement.getAttribute("data-type"))&&(3===n.startContainer.nodeType&&n.startContainer.parentElement.textContent===n.toString()||3!==n.startContainer.nodeType&&n.startContainer.textContent===n.toString()))"NodeHeading"===n.startContainer.parentElement.parentElement.getAttribute("data-type")?t.append(n.startContainer.parentElement.parentElement.cloneNode(!0)):["DIV","TD","TH","TR"].includes(n.startContainer.parentElement.tagName)?t.append(n.cloneContents()):t.append(n.startContainer.parentElement.cloneNode(!0)),d=t.innerHTML;else if(l)d=l.outerHTML;else if(i.length>0&&3===n.startContainer.nodeType&&"SPAN"===n.startContainer.parentElement.tagName&&n.startContainer.parentElement.isSameNode(n.endContainer.parentElement)){const e=n.startContainer.parentElement.attributes,t=document.createElement("span");for(let n=0;n<e.length;n++)t.setAttribute(e[n].name,e[n].value);t.textContent=n.toString(),d=t.outerHTML}else{t.append(n.cloneContents());const e=(0,a.hasClosestByAttribute)(n.commonAncestorContainer,"data-type","inline-math");d=e?e.outerHTML:t.innerHTML,((0,a.hasClosestByAttribute)(n.startContainer,"data-type","NodeCodeBlock")||(0,a.hasClosestByMatchTag)(n.startContainer,"CODE"))&&(c=t.textContent.replace(o.Constants.ZWSP,""))}}t.clipboardData.setData("text/plain",c||e.lute.BlockDOM2StdMd(d).trimEnd()),t.clipboardData.setData("text/html",d+o.Constants.ZWSP)})),this.element.addEventListener("mousedown",(t=>{var n;if(2===t.button||window.siyuan.ctrlIsPressed)return;window.siyuan.shiftIsPressed||(0,y.hideElements)(["select"],e);const i=t.target;if((0,a.hasClosestByClassName)(i,"protyle-action"))return;const o=document,l=e.element.getBoundingClientRect(),r=l.left+parseInt(e.wysiwyg.element.style.paddingLeft)+1,d=r+e.wysiwyg.element.firstElementChild.clientWidth-1,c=l.bottom,u=t.clientY;if(!e.disabled&&i.classList.contains("protyle-action__drag")){const n=(0,a.hasClosestBlock)(i);if(!n)return;let s=!0;["NodeIFrame","NodeWidget","NodeVideo"].includes(n.getAttribute("data-type"))?(n.classList.add("iframe--drag"),"left"!==n.style.textAlign&&"right"!==n.style.textAlign||(s=!1)):"img"===i.parentElement.parentElement.getAttribute("data-type")&&i.parentElement.parentElement.classList.add("img--drag");const l=n.getAttribute("data-node-id"),r=n.outerHTML,p=t.clientX,m=i.previousElementSibling,g=m.clientWidth,y=m.clientHeight;return o.onmousemove=e=>{"IMG"===m.tagName&&(m.parentElement.parentElement.style.width=""),e.clientX>p-g+8&&e.clientX<d&&("IMG"===m.tagName&&"block"!==m.parentElement.parentElement.style.display||!s?m.style.width=Math.max(17,g+(e.clientX-p))+"px":m.style.width=Math.max(17,g+2*(e.clientX-p))+"px"),"IMG"!==m.tagName?e.clientY>u-y+8&&e.clientY<c&&(m.style.height=y+(e.clientY-u)+"px"):m.parentElement.parentElement.style.maxWidth=parseInt(m.style.width)+10+"px"},void(o.onmouseup=()=>{o.onmousemove=null,o.onmouseup=null,o.ondragstart=null,o.onselectstart=null,o.onselect=null,i.classList.contains("protyle-action__drag")&&n&&(0,b.updateTransaction)(e,l,n.outerHTML,r),n.classList.remove("iframe--drag"),i.parentElement.parentElement.classList.remove("img--drag")})}let p;if(("TH"===i.tagName||"TD"===i.tagName||"TABLE"===(null===(n=i.firstElementChild)||void 0===n?void 0:n.tagName)||i.classList.contains("table__resize")||i.classList.contains("table__select"))&&(p=(0,a.hasClosestBlock)(i),p&&(p.querySelector("table").classList.remove("select"),p.querySelector(".table__select").removeAttribute("style"),window.siyuan.menus.menu.remove(),t.stopPropagation())),!e.disabled&&i.classList.contains("table__resize")){const n=(0,a.hasClosestBlock)(i);if(!n)return;const s=n.outerHTML;getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),n.firstElementChild.style.webkitUserModify="read-only",n.style.cursor="col-resize",i.removeAttribute("style");const l=n.getAttribute("data-node-id"),r=t.clientX,d=n.querySelectorAll("table col")[parseInt(i.getAttribute("data-col-index"))];n.querySelectorAll("table th")[parseInt(i.getAttribute("data-col-index"))].style.width="";const c=d.clientWidth,u=n.firstElementChild.clientWidth<n.firstElementChild.scrollWidth;return o.onmousemove=e=>{"center"!==n.style.textAlign||u?d.style.width=c+(e.clientX-r)+"px":d.style.width=c+2*(e.clientX-r)+"px"},void(o.onmouseup=()=>{n.firstElementChild.style.webkitUserModify="",n.style.cursor="",o.onmousemove=null,o.onmouseup=null,o.ondragstart=null,o.onselectstart=null,o.onselect=null,n&&(0,b.updateTransaction)(e,l,n.outerHTML,s)})}let m=t.clientX;t.clientX>d?m=d:t.clientX<r&&(m=r);const f=l.top+(e.options.render.breadcrumb?e.breadcrumb.element.parentElement.clientHeight:0);let h,w;o.onmousemove=t=>{const n=t.target;if(!e.disabled&&p&&p.contains(n)&&!(0,a.hasClosestByClassName)(p,"protyle-wysiwyg__embed")){if(!("TH"!==n.tagName&&"TD"!==n.tagName||n.isSameNode(i)||w&&w.isSameNode(n))){p.firstElementChild.style.webkitUserModify="read-only";let e=i.offsetLeft+i.clientWidth-n.offsetLeft,t=n.offsetLeft;i.offsetLeft===n.offsetLeft?e=Math.max(i.clientWidth,n.clientWidth):i.offsetLeft<n.offsetLeft&&(e=n.offsetLeft+n.clientWidth-i.offsetLeft,t=i.offsetLeft);let a=i.offsetTop+i.clientHeight-n.offsetTop,s=n.offsetTop;i.offsetTop===n.offsetTop?a=Math.max(i.clientHeight,n.clientHeight):i.offsetTop<n.offsetTop&&(a=n.offsetTop+n.clientHeight-i.offsetTop,s=i.offsetTop),Array.from(p.querySelectorAll("th, td")).find((n=>{const i=n.offsetLeft<t+e&&n.offsetLeft+n.clientWidth>t+e,o=n.offsetLeft<t&&n.offsetLeft+n.clientWidth>t;n.offsetTop<s&&n.offsetTop+n.clientHeight>s?((n.offsetLeft+6>t&&n.offsetLeft+n.clientWidth-6<t+e||i||o)&&(a=s+a-n.offsetTop,s=n.offsetTop),i&&(e=n.offsetLeft+n.clientWidth-t),o&&(e=t+e-n.offsetLeft,t=n.offsetLeft)):n.offsetTop<s+a&&n.offsetTop+n.clientHeight>s+a?((n.offsetLeft+6>t&&n.offsetLeft+n.clientWidth-6<t+e||i||o)&&(a=n.clientHeight+n.offsetTop-s),i&&(e=n.offsetLeft+n.clientWidth-t),o&&(e=t+e-n.offsetLeft,t=n.offsetLeft)):o&&n.offsetTop+6>s&&n.offsetTop+n.clientHeight-6<s+a?(e=t+e-n.offsetLeft,t=n.offsetLeft):i&&n.offsetTop+6>s&&n.offsetTop+n.clientHeight-6<s+a&&(e=n.offsetLeft+n.clientWidth-t)})),p.querySelector("table").classList.add("select"),p.querySelector(".table__select").setAttribute("style",`left:${t-p.firstElementChild.scrollLeft}px;top:${s}px;height:${a}px;width:${e+1}px;`),w=n}return}e.selectElement.classList.remove("fn__none"),(0,y.hideElements)(["gutter"],e);let s=0,o=0,l=0,g=0;t.clientX<m?(o=t.clientX<r?r:t.clientX,l=m-o):t.clientX>d?(o=m,l=d-o):(o=m,l=t.clientX-m),t.clientY>u?t.clientY>c?(s=u,g=c-u):(s=u,g=t.clientY-u):(s=t.clientY<f?f:t.clientY,g=u-s),e.selectElement.setAttribute("style",`background-color: ${e.selectElement.style.backgroundColor};top:${s}px;height:${g}px;left:${o+2}px;width:${l-2}px;`);const b=document.elementFromPoint(t.clientX,t.clientY);if(h&&h.isSameNode(b)&&!h.classList.contains("protyle-wysiwyg")&&!h.classList.contains("list")&&!h.classList.contains("bq")&&!h.classList.contains("sb"))return;h=b,(0,y.hideElements)(["select"],e);let v=document.elementFromPoint(o-1,s);if(!v)return;if((v.classList.contains("protyle-wysiwyg")||v.classList.contains("list")||v.classList.contains("sb")||v.classList.contains("bq"))&&(v=document.elementFromPoint(o-1,s+16)),!v||v.classList.contains("protyle-wysiwyg"))return;const _=(0,a.hasClosestBlock)(v);if(!_)return;let E=[],k=_,C=!1;for(;k;)if(k&&!k.classList.contains("protyle-attr")){const e=k.getBoundingClientRect();if(e.height>0&&e.top<s+g&&e.left<o+l)if(C)if(k.nextElementSibling&&!k.nextElementSibling.classList.contains("protyle-attr")){const e=k.nextElementSibling.getBoundingClientRect();if(e.top<s+g&&e.left<o+l)E=[k],k=k.nextElementSibling,C=!1;else{if(!k.parentElement.classList.contains("sb"))break;k=(0,a.hasClosestBlock)(k.parentElement),C=!0}}else k=(0,a.hasClosestBlock)(k.parentElement),C=!0;else E.push(k),k=k.nextElementSibling;else if(k.parentElement.classList.contains("sb"))k=(0,a.hasClosestBlock)(k.parentElement),C=!0;else{if(0!==e.height||0!==e.width||"1"!==k.parentElement.getAttribute("fold"))break;k=k.parentElement,E=[]}}else k=(0,a.hasClosestBlock)(k.parentElement),C=!0;1!==E.length||E[0].classList.contains("list")||E[0].classList.contains("bq")||E[0].classList.contains("sb")?(E.forEach((e=>{(0,a.hasClosestByClassName)(e,"protyle-wysiwyg__embed")||e.classList.add("protyle-wysiwyg--select")})),e.selectElement.style.backgroundColor=""):e.selectElement.style.backgroundColor="transparent"},o.onmouseup=n=>{var i;if(o.onmousemove=null,o.onmouseup=null,o.ondragstart=null,o.onselectstart=null,o.onselect=null,e.selectElement.classList.add("fn__none"),e.selectElement.removeAttribute("style"),!e.disabled&&p){p.firstElementChild.style.webkitUserModify="";const t=p.querySelector(".table__select");t.getAttribute("style")&&(getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new x.MenuItem({label:window.siyuan.languages.mergeCell,click:()=>{if(p){const n=[],i=[],a=p.querySelectorAll("th").length;let s=0;const o=p.firstElementChild.scrollLeft;let l=!1,r=!1;p.querySelectorAll("th, td").forEach(((e,d)=>{e.classList.contains("fn__none")?(e.previousElementSibling&&e.previousElementSibling.isSameNode(n[n.length-1])||d<s&&i.includes((d+1)%a))&&(n.push(e),l||"THEAD"!==e.parentElement.parentElement.tagName?r||"TBODY"!==e.parentElement.parentElement.tagName||(r=!0):l=!0):e.offsetLeft+6>t.offsetLeft+o&&e.offsetLeft+e.clientWidth-6<t.offsetLeft+o+t.clientWidth&&e.offsetTop+6>t.offsetTop&&e.offsetTop+e.clientHeight-6<t.offsetTop+t.clientHeight&&(n.push(e),l||"THEAD"!==e.parentElement.parentElement.tagName?r||"TBODY"!==e.parentElement.parentElement.tagName||(r=!0):l=!0,i.push((d+1)%a),s=Math.max((e.rowSpan-1)*a+d+1,s))})),p.querySelector("table").classList.remove("select"),t.removeAttribute("style");const d=p.outerHTML;let c=n[0],u=c.colSpan,m=1;for(;c.nextElementSibling&&c.nextElementSibling.isSameNode(n[m]);)c=c.nextElementSibling,c.classList.contains("fn__none")||(u+=c.colSpan),m++;let g="",y=n[0].parentElement,f=n[0].rowSpan;if(n.forEach(((e,t)=>{let i=e.innerHTML.trim();i.endsWith("<br>")&&(i=i.substr(0,i.length-4)),g+=i+(i&&t!==n.length-1?"<br>":""),0!==t&&(y.isSameNode(e.parentElement)||(e.classList.contains("fn__none")||(f+=e.rowSpan),y=e.parentElement,"THEAD"===n[0].parentElement.parentElement.tagName&&"THEAD"!==e.parentElement.parentElement.tagName&&n[0].parentElement.parentElement.insertAdjacentElement("beforeend",e.parentElement)),e.classList.add("fn__none"),e.innerHTML="")})),l&&r)for(y=y.parentElement.nextElementSibling.firstElementChild;y&&"THEAD"!==y.parentElement.tagName;){let e=0,t=0;if(Array.from(y.children).forEach((n=>{e+=n.colSpan-1,n.classList.contains("fn__none")&&t++})),e===t)break;n[0].parentElement.parentElement.insertAdjacentElement("beforeend",y),y=y.parentElement.nextElementSibling.firstElementChild}setTimeout((()=>{p&&(n[0].innerHTML=g,n[0].colSpan=u,n[0].rowSpan=f,(0,b.updateTransaction)(e,p.getAttribute("data-node-id"),p.outerHTML,d))}))}}}).element),window.siyuan.menus.menu.append(new x.MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new x.MenuItem({icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{if(p){const n=[],i=p.firstElementChild.scrollLeft;p.querySelectorAll("th, td").forEach((e=>{!e.classList.contains("fn__none")&&e.offsetLeft+6>t.offsetLeft+i&&e.offsetLeft+e.clientWidth-6<t.offsetLeft+i+t.clientWidth&&e.offsetTop+6>t.offsetTop&&e.offsetTop+e.clientHeight-6<t.offsetTop+t.clientHeight&&(0===n.length||n.length>0&&e.offsetTop===n[0].offsetTop)&&n.push(e)})),p.querySelector("table").classList.remove("select"),t.removeAttribute("style"),(0,T.setTableAlign)(e,n,p,"left",(0,s.getEditorRange)(p))}}}).element),window.siyuan.menus.menu.append(new x.MenuItem({icon:"iconAlignCenter",accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,label:window.siyuan.languages.alignCenter,click:()=>{if(p){const n=[],i=p.firstElementChild.scrollLeft;p.querySelectorAll("th, td").forEach((e=>{!e.classList.contains("fn__none")&&e.offsetLeft+6>t.offsetLeft+i&&e.offsetLeft+e.clientWidth-6<t.offsetLeft+i+t.clientWidth&&e.offsetTop+6>t.offsetTop&&e.offsetTop+e.clientHeight-6<t.offsetTop+t.clientHeight&&(0===n.length||n.length>0&&e.offsetTop===n[0].offsetTop)&&n.push(e)})),p.querySelector("table").classList.remove("select"),t.removeAttribute("style"),(0,T.setTableAlign)(e,n,p,"center",(0,s.getEditorRange)(p))}}}).element),window.siyuan.menus.menu.append(new x.MenuItem({icon:"iconAlignRight",accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,label:window.siyuan.languages.alignRight,click:()=>{if(p){const n=[],i=p.firstElementChild.scrollLeft;p.querySelectorAll("th, td").forEach((e=>{!e.classList.contains("fn__none")&&e.offsetLeft+6>t.offsetLeft+i&&e.offsetLeft+e.clientWidth-6<t.offsetLeft+i+t.clientWidth&&e.offsetTop+6>t.offsetTop&&e.offsetTop+e.clientHeight-6<t.offsetTop+t.clientHeight&&(0===n.length||n.length>0&&e.offsetTop===n[0].offsetTop)&&n.push(e)})),p.querySelector("table").classList.remove("select"),t.removeAttribute("style"),(0,T.setTableAlign)(e,n,p,"right",(0,s.getEditorRange)(p))}}}).element),window.siyuan.menus.menu.append(new x.MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new x.MenuItem({label:window.siyuan.languages.remove,icon:"iconTrashcan",click(){if(p){const n=[],i=p.firstElementChild.scrollLeft;p.querySelectorAll("th, td").forEach((e=>{!e.classList.contains("fn__none")&&e.offsetLeft+6>t.offsetLeft+i&&e.offsetLeft+e.clientWidth-6<t.offsetLeft+i+t.clientWidth&&e.offsetTop+6>t.offsetTop&&e.offsetTop+e.clientHeight-6<t.offsetTop+t.clientHeight&&n.push(e)})),p.querySelector("table").classList.remove("select"),t.removeAttribute("style");const a=p.outerHTML;n.forEach((e=>{e.innerHTML=""})),(0,b.updateTransaction)(e,p.getAttribute("data-node-id"),p.outerHTML,a)}}}).element),window.siyuan.menus.menu.popup({x:n.clientX-8,y:n.clientY-16}))}const l=[],r=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(r.forEach((e=>{l.push(e.getAttribute("data-node-id"))})),(0,A.countBlockWord)(l),getSelection().rangeCount>0){const e=getSelection().getRangeAt(0);if(""===e.toString()||window.siyuan.shiftIsPressed){if(3===t.detail){let t=(0,a.hasClosestBlock)(e.startContainer);if(t)if(null===(i=t.nextElementSibling)||void 0===i?void 0:i.classList.contains("table"))(0,s.setLastNodeRange)((0,g.getContenteditableElement)(t),e,!1);else if(t.classList.contains("table")){const n=t.querySelectorAll("th, td");t=n[n.length-1],t.contains(e.startContainer)&&(0,s.setLastNodeRange)(t,e,!1)}}return}if(r.length>0)return void e.collapse(!0);const o=(0,a.hasClosestBlock)(e.startContainer);let l;3===n.detail&&3!==e.endContainer.nodeType&&"DIV"===e.endContainer.tagName&&0===e.endOffset?e.endContainer.classList.contains("protyle-attr")&&e.setEndAfter(e.endContainer.previousSibling.lastChild):l=(0,a.hasClosestBlock)(e.endContainer),o&&l&&!l.isSameNode(o)&&e.collapse(!0)}}}))}bindEvent(e){let t;this.element.addEventListener("focusout",(()=>{getSelection().rangeCount>0&&!this.element.contains(getSelection().getRangeAt(0).startContainer)?e.toolbar.range||(e.toolbar.range=this.element.ownerDocument.createRange(),e.toolbar.range.setStart((0,g.getContenteditableElement)(this.element)||this.element,0),e.toolbar.range.collapse(!0)):e.toolbar.range=(0,s.getEditorRange)(this.element)})),this.element.addEventListener("cut",(t=>{var n,i;if("PROTYLE-HTML"===t.target.tagName)return void t.stopPropagation();t.stopPropagation(),t.preventDefault(),e.options.render.breadcrumb&&e.breadcrumb.hide();const l=(0,s.getEditorRange)(e.wysiwyg.element);let d=(0,a.hasClosestBlock)(l.startContainer);if(!d)return;const p=d.querySelector(".img--select");let m=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));0!==m.length||""!==l.toString()||l.cloneContents().querySelector("img")||p||(d.classList.add("protyle-wysiwyg--select"),m=[d]);let y="";if(m.length>0){"NodeListItem"===m[0].getAttribute("data-type")&&m[0].parentElement.childElementCount-1===m.length?y=m[0].parentElement.outerHTML:(m.forEach((e=>{const t=(0,g.getTopAloneElement)(e);"NodeHeading"===e.getAttribute("data-type")&&"1"===e.getAttribute("fold")?y+=(0,f.removeEmbed)(t).replace('fold="1"',""):y+=(0,f.removeEmbed)(t)})),"NodeListItem"===m[0].getAttribute("data-type")&&(y=`<div data-subtype="${m[0].getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${y}<div class="protyle-attr" contenteditable="false">${o.Constants.ZWSP}</div></div>`));const t=(0,g.getNextBlock)(m[m.length-1]);(0,v.removeBlock)(e,d,l),t&&(0,s.focusBlock)(t)}else{const t=d.getAttribute("data-node-id"),o=d.outerHTML,m=document.createElement("div");let f=l.startContainer;if(3===f.nodeType&&""===f.textContent){const e=(0,g.hasNextSibling)(l.startContainer);e&&(f=e)}const h=(0,a.hasClosestByAttribute)(f,"data-type","NodeHeading");let w=!1;if(h&&l.toString()===h.firstElementChild.textContent){const t=[{action:"delete",id:h.getAttribute("data-node-id")}],a=[{action:"insert",id:h.getAttribute("data-node-id"),data:h.outerHTML,previousID:null===(n=h.previousElementSibling)||void 0===n?void 0:n.getAttribute("data-node-id"),parentID:(null===(i=h.parentElement)||void 0===i?void 0:i.getAttribute("data-node-id"))||e.block.parentID}];if("1"===h.getAttribute("fold")){w=!0;const t=h.cloneNode(!0);t.removeAttribute("fold"),m.append(t),a[0].data=t.outerHTML,(0,c.setFold)(e,h,void 0,!0)}else{if(3===h.parentElement.childElementCount&&h.parentElement.classList.contains("li")||2===h.parentElement.childElementCount&&(h.parentElement.classList.contains("bq")||h.parentElement.classList.contains("sb"))||1===h.parentElement.childElementCount&&h.parentElement.classList.contains("protyle-wysiwyg")){const n=Lute.NewNodeID(),i=(0,r.genEmptyElement)(!1,!1,n);t.push({id:n,data:i.outerHTML,action:"insert",parentID:h.parentElement.getAttribute("data-node-id")||e.block.parentID}),a.push({id:n,action:"delete"}),h.before(i)}(0,s.focusSideBlock)(h),m.append(h)}(0,b.transaction)(e,t,a)}else if(""!==l.toString()&&f.isSameNode(l.endContainer)&&3===l.startContainer.nodeType&&l.endOffset===l.endContainer.textContent.length&&0===l.startOffset&&!["DIV","TD","TH","TR"].includes(l.startContainer.parentElement.tagName))m.append(l.startContainer.parentElement);else if(p)m.append(p);else if(l.cloneContents().querySelectorAll("td, th").length>0){const n=document.createElement("wbr");l.insertNode(n),l.setStartAfter(n),m.append(l.extractContents()),d.outerHTML=e.lute.SpinBlockDOM(d.outerHTML),d=e.wysiwyg.element.querySelector(`[data-node-id="${t}"]`),(0,s.focusByWbr)(d,l)}else{const e=(0,a.hasClosestByAttribute)(l.commonAncestorContainer,"data-type","inline-math");if(e)m.append(e);else{let e;m.append(l.extractContents()),e=d.classList.contains("table")?(0,a.hasClosestByMatchTag)(l.startContainer,"TD")||(0,a.hasClosestByMatchTag)(l.startContainer,"TH"):(0,g.getContenteditableElement)(d),e&&Array.from(e.children).forEach((e=>{""===e.textContent&&1===e.nodeType&&"BR"!==e.tagName&&e.remove()}))}}if(y=m.innerHTML,!d.classList.contains("table")){const e=(0,g.getContenteditableElement)(d);e&&""===e.textContent&&(e.innerHTML="")}d.setAttribute("updated",u().format("YYYYMMDDHHmmss")),"NodeCodeBlock"===d.getAttribute("data-type")&&(l.insertNode(document.createElement("wbr")),(0,g.getContenteditableElement)(d).removeAttribute("data-render"),(0,_.highlightRender)(d)),d.parentElement.parentElement&&!w&&(0,b.updateTransaction)(e,t,d.outerHTML,o)}e.hint.render(e),t.clipboardData.setData("text/plain",e.lute.BlockDOM2StdMd(y)),t.clipboardData.setData("text/html",o.Constants.ZWSP+y)})),this.element.addEventListener("contextmenu",(n=>{var i,o,r,d;n.stopPropagation(),n.preventDefault();const u=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(u.length>1)return(0,y.hideElements)(["util"],e),e.gutter.renderMenu(e,u[0]),void window.siyuan.menus.menu.popup({x:n.clientX,y:n.clientY});const p=n.target,m=(0,a.hasClosestByAttribute)(p,"data-type","NodeBlockQueryEmbed");if(m)return 0===getSelection().rangeCount&&(0,s.focusSideBlock)(m),e.gutter.renderMenu(e,m),window.siyuan.menus.menu.popup({x:n.clientX,y:n.clientY}),!1;if(e.disabled)return!1;e.toolbar.range=(0,s.getEditorRange)(e.element);const b=(p.getAttribute("data-type")||"").split(" ");if(b.includes("block-ref"))return(0,c.refMenu)(e,p),p.setAttribute("prevent-popover","true"),setTimeout((()=>{p.removeAttribute("prevent-popover")}),620),!1;if(b.includes("file-annotation-ref"))return e.toolbar.showFileAnnotationRef(e,p),!1;if(b.includes("inline-memo"))return e.toolbar.showRender(e,p),!1;if(b.includes("a"))return(0,c.linkMenu)(e,p),(null===(i=p.getAttribute("data-href"))||void 0===i?void 0:i.startsWith("siyuan://blocks"))&&(p.setAttribute("prevent-popover","true"),setTimeout((()=>{p.removeAttribute("prevent-popover")}),620)),!1;if("IMG"===p.tagName&&(0,a.hasClosestByClassName)(p,"img"))return(0,c.imgMenu)(e,e.toolbar.range,p.parentElement.parentElement,{clientX:n.clientX+4,clientY:n.clientY}),!1;const f=(0,a.hasClosestBlock)(p);if(!f)return!1;!(0,g.isNotEditBlock)(f)&&((0,l.isMobile)()||t&&f.contains(t.startContainer))?(0,l.isMobile)()&&!(null===(o=e.toolbar)||void 0===o?void 0:o.element.classList.contains("fn__none"))||((0,c.contentMenu)(e,f),window.siyuan.menus.menu.popup({x:n.clientX,y:n.clientY+13,h:26}),null===(r=e.toolbar)||void 0===r||r.element.classList.add("fn__none"),f.classList.contains("table")&&(f.querySelector("table").classList.remove("select"),f.querySelector(".table__select").removeAttribute("style"))):""===e.toolbar.range.toString()&&((0,y.hideElements)(["util"],e),e.gutter.renderMenu(e,f),window.siyuan.menus.menu.popup({x:n.clientX,y:n.clientY}),null===(d=e.toolbar)||void 0===d||d.element.classList.add("fn__none"))})),this.element.addEventListener("pointerdown",(()=>{t=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0}));let n=!1;this.element.addEventListener("mousewheel",(t=>{if(!n&&t.deltaY<0&&!e.scroll.element.classList.contains("fn__none")&&e.contentElement.clientHeight===e.contentElement.scrollHeight&&"true"!==e.wysiwyg.element.firstElementChild.getAttribute("data-eof")&&((0,L.fetchPost)("/api/filetree/getDoc",{id:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,k:e.options.key||"",size:o.Constants.SIZE_GET},(t=>{n=!1,(0,S.onGet)(t,e,[o.Constants.CB_GET_BEFORE,o.Constants.CB_GET_UNCHANGEID])})),n=!0),0===t.deltaX)return;const i=(0,a.hasClosestByClassName)(t.target,"table");if(i){const e=i.querySelector(".table__select");(null==e?void 0:e.style.width)&&(e.removeAttribute("style"),window.siyuan.menus.menu.remove())}}),{passive:!0});let p=!1;this.element.addEventListener("mouseover",(t=>{const n=(0,a.hasClosestByClassName)(t.target,"protyle-attr");if(n)return p=!0,void n.parentElement.classList.add("protyle-wysiwyg--hl");if(p){const t=e.wysiwyg.element.querySelector(".protyle-wysiwyg--hl");t&&t.classList.remove("protyle-wysiwyg--hl"),p=!1}if((0,a.hasClosestByClassName)(t.target,"protyle-action")||!e.options.render.gutter)return;const i=(0,a.hasClosestBlock)(t.target);if((!i||!i.classList.contains("list")&&!i.classList.contains("li"))&&i){const t=(0,a.hasClosestByAttribute)(i,"data-type","NodeBlockQueryEmbed");t?e.gutter.render(t,this.element):e.gutter.render(i,this.element)}})),this.element.addEventListener("paste",(t=>{"PROTYLE-HTML"!==t.target.tagName?(0,i.paste)(e,t):t.stopPropagation()}));let h,x=!1;this.element.addEventListener("compositionstart",(t=>{const n=(0,s.getEditorRange)(e.wysiwyg.element),i=(0,a.hasClosestBlock)(n.startContainer);i&&void 0===e.wysiwyg.lastHTMLs[i.getAttribute("data-node-id")]&&(n.insertNode(document.createElement("wbr")),e.wysiwyg.lastHTMLs[i.getAttribute("data-node-id")]=i.outerHTML,i.querySelector("wbr").remove()),x=!0,t.stopPropagation()})),this.element.addEventListener("compositionend",(t=>{t.stopPropagation(),x=!1;const n=(0,s.getEditorRange)(this.element),i=(0,a.hasClosestBlock)(n.startContainer);if((!i||"NodeHTMLBlock"!==i.getAttribute("data-type"))&&i)if(""!==t.data)this.escapeInline(e,n,t),(0,m.input)(e,i,n,!0);else{const t=i.getAttribute("data-node-id");e.wysiwyg.lastHTMLs[t]&&(0,b.updateTransaction)(e,t,i.outerHTML,e.wysiwyg.lastHTMLs[t])}})),this.element.addEventListener("input",(t=>{const n=t.target;if("VIDEO"===n.tagName||"AUDIO"===n.tagName||"historyRedo"===t.inputType)return;const i=(0,s.getEditorRange)(this.element),o=(0,a.hasClosestBlock)(i.startContainer);o&&(o&&"NodeHTMLBlock"===o.getAttribute("data-type")?t.stopPropagation():t.isComposing||x||"deleteByDrag"===t.inputType||"insertFromDrop"===t.inputType||(this.escapeInline(e,i,t),/^\d{1}$/.test(t.data)||"‘"===t.data||"“"===t.data?setTimeout((()=>{(0,m.input)(e,o,i,!0)})):(":"===t.data&&(e.hint.enableEmoji=!0),(0,m.input)(e,o,i,!0)),t.stopPropagation()))})),this.element.addEventListener("keyup",(t=>{const n=(0,s.getEditorRange)(this.element).cloneRange();if("PageUp"===t.key||"PageDown"===t.key||"Home"===t.key||"End"===t.key||-1!==t.key.indexOf("Arrow")||"Alt"===t.key||"Shift"===t.key||"CapsLock"===t.key||"Escape"===t.key||"Meta"===t.key||/^F\d{1,2}$/.test(t.key)||t.isComposing&&(!t.isComposing||""===n.toString())){if(!this.preventKeyup&&(!t.shiftKey&&!(0,C.isCtrl)(t)||t.isComposing||""===n.toString()||(e.toolbar.render(e,n,t),(0,A.countSelectWord)(n)),3!==t.eventPhase&&!t.shiftKey&&(t.key.indexOf("Arrow")>-1||"Home"===t.key||"End"===t.key||"PageUp"===t.key||"PageDown"===t.key)&&!t.isComposing)){const i=(0,a.hasClosestBlock)(n.startContainer);i&&(i.classList.contains("protyle-wysiwyg--select")||(0,A.countSelectWord)(n),this.setEmptyOutline(e,i)),t.stopPropagation()}}else{const t=(0,a.hasClosestBlock)(n.startContainer);t&&void 0===e.wysiwyg.lastHTMLs[t.getAttribute("data-node-id")]&&(n.insertNode(document.createElement("wbr")),e.wysiwyg.lastHTMLs[t.getAttribute("data-node-id")]=t.outerHTML,t.querySelector("wbr").remove())}})),this.element.addEventListener("dblclick",(t=>{"IMG"!==t.target.tagName||(0,d.previewImage)(t.target.src,e.block.rootID)})),this.element.addEventListener("click",(t=>{(0,y.hideElements)(["hint","util"],e),window.siyuan.shiftIsPressed||(h=void 0),this.setEmptyOutline(e,t.target);const n=(0,a.hasClosestByClassName)(t.target,"table");this.element.querySelectorAll(".table").forEach((e=>{n&&e.isSameNode(n)||(e.querySelector("table").classList.remove("select"),e.querySelector(".table__select").removeAttribute("style")),n&&n.isSameNode(e)&&e.querySelector(".table__select").getAttribute("style")&&t.stopPropagation()}));const i=(0,s.getEditorRange)(this.element),d=(0,a.hasClosestByAttribute)(t.target,"data-type","block-ref"),p=(0,a.hasClosestByAttribute)(t.target,"data-type","a");if(d||p&&p.getAttribute("data-href").startsWith("siyuan://blocks/")){if(t.stopPropagation(),t.preventDefault(),(0,y.hideElements)(["dialog","toolbar"],e),""!==i.toString()&&!window.siyuan.shiftIsPressed)return;let n;return d?n=d.getAttribute("data-id"):p&&(n=p.getAttribute("data-href").substring(16,38)),void(0,L.fetchPost)("/api/block/checkBlockFold",{id:n},(e=>{(0,w.openMobileFileById)(n,e.data?[o.Constants.CB_GET_ALL,o.Constants.CB_GET_HL]:[o.Constants.CB_GET_HL,o.Constants.CB_GET_CONTEXT])}))}const m=(0,a.hasClosestByAttribute)(t.target,"data-type","file-annotation-ref");if(m&&""===i.toString()){t.stopPropagation(),t.preventDefault();const e=`assets/${m.getAttribute("data-id").split("/")[1]}`;return void(0,C.openByMobile)(e)}if(p&&!window.siyuan.altIsPressed){t.stopPropagation(),t.preventDefault();const e=p.getAttribute("data-href");return void(0,C.openByMobile)(e)}const f=(0,a.hasClosestByClassName)(t.target,"protyle-wysiwyg__embed");if(f){const e=f.getAttribute("data-id");return(0,w.openMobileFileById)(e,[o.Constants.CB_GET_ALL]),void t.stopPropagation()}const v=(0,a.hasClosestByClassName)(t.target,"protyle-attr--bookmark");if(v)return(0,E.openAttr)(v.parentElement.parentElement,e,"bookmark"),void t.stopPropagation();const _=(0,a.hasClosestByClassName)(t.target,"protyle-attr--name");if(_)return(0,E.openAttr)(_.parentElement.parentElement,e,"name"),void t.stopPropagation();const x=(0,a.hasClosestByClassName)(t.target,"protyle-attr--alias");if(x)return(0,E.openAttr)(x.parentElement.parentElement,e,"alias"),void t.stopPropagation();const S=(0,a.hasClosestByClassName)(t.target,"protyle-attr--memo");if(S)return(0,E.openAttr)(S.parentElement.parentElement,e,"memo"),void t.stopPropagation();if((0,a.hasTopClosestByClassName)(t.target,"protyle-action__copy"))return;const T=(0,a.hasClosestByClassName)(t.target,"protyle-action__edit");if(T&&!e.disabled)return e.toolbar.showRender(e,T.parentElement.parentElement),t.stopPropagation(),void t.preventDefault();const H=(0,a.hasClosestByClassName)(t.target,"protyle-action__menu");if(H&&!e.disabled){e.gutter.renderMenu(e,H.parentElement.parentElement);const n=H.getBoundingClientRect();return window.siyuan.menus.menu.popup({x:n.left,y:n.top},!0),t.stopPropagation(),void t.preventDefault()}const I=(0,a.hasClosestByClassName)(t.target,"protyle-action__reload");if(I){const n=(0,a.hasClosestByAttribute)(I,"data-type","NodeBlockQueryEmbed");return n&&(n.removeAttribute("data-render"),(0,k.blockRender)(e,n)),t.stopPropagation(),void t.preventDefault()}const B=(0,a.hasClosestByClassName)(t.target,"protyle-action__language");if(B&&!e.disabled)return e.toolbar.showCodeLanguage(e,B),t.stopPropagation(),void t.preventDefault();const $=(0,a.hasClosestByAttribute)(t.target,"data-subtype","math");if(!window.siyuan.shiftIsPressed&&!window.siyuan.ctrlIsPressed&&$&&!e.disabled)return e.toolbar.showRender(e,$),void t.stopPropagation();const N=(0,a.hasClosestByClassName)(t.target,"protyle-action");if(N){if("img"!==N.parentElement.parentElement.getAttribute("data-type")||e.disabled){if(!e.disabled&&N.parentElement.classList.contains("li"))if(window.siyuan.altIsPressed){if(N.parentElement.parentElement.classList.contains("protyle-wysiwyg"))(0,c.setFold)(e,N.parentElement);else{let t=!0;const n=N.parentElement.parentElement.outerHTML;Array.from(N.parentElement.parentElement.children).find((e=>{if(e.classList.contains("li")&&"1"!==e.getAttribute("fold")&&e.childElementCount>3)return t=!1,!0})),Array.from(N.parentElement.parentElement.children).find((e=>{e.classList.contains("li")&&(t?e.removeAttribute("fold"):e.childElementCount>3&&e.setAttribute("fold","1"))})),(0,b.updateTransaction)(e,N.parentElement.parentElement.getAttribute("data-node-id"),N.parentElement.parentElement.outerHTML,n)}(0,y.hideElements)(["gutter"],e)}else if(window.siyuan.shiftIsPressed)(0,E.openAttr)(N.parentElement,e);else if(window.siyuan.ctrlIsPressed)(0,c.zoomOut)(e,N.parentElement.getAttribute("data-node-id"));else if(N.classList.contains("protyle-action--task")){const t=N.parentElement.outerHTML;N.parentElement.classList.contains("protyle-task--done")?(N.querySelector("use").setAttribute("xlink:href","#iconUncheck"),N.parentElement.classList.remove("protyle-task--done")):(N.querySelector("use").setAttribute("xlink:href","#iconCheck"),N.parentElement.classList.add("protyle-task--done")),N.parentElement.setAttribute("updated",u().format("YYYYMMDDHHmmss")),(0,b.updateTransaction)(e,N.parentElement.getAttribute("data-node-id"),N.parentElement.outerHTML,t)}else e.gutter.renderMenu(e,N.parentElement),window.siyuan.menus.menu.popup({x:t.clientX-16,y:t.clientY-16},!0)}else(0,c.imgMenu)(e,i,N.parentElement.parentElement,{clientX:t.clientX+4,clientY:t.clientY});return void t.stopPropagation()}const D=(0,a.hasClosestByClassName)(t.target,"hr")||(0,a.hasClosestByClassName)(t.target,"iframe");if(!window.siyuan.shiftIsPressed&&!window.siyuan.ctrlIsPressed&&D)return D.classList.add("protyle-wysiwyg--select"),void t.stopPropagation();const P=(0,a.hasTopClosestByClassName)(t.target,"img");if(!window.siyuan.shiftIsPressed&&!window.siyuan.ctrlIsPressed&&P)return P.classList.add("img--select"),i.setStartAfter(P),i.collapse(!0),void(0,s.focusByRange)(i);if(t.target.contains(this.element)&&this.element.lastElementChild&&!e.disabled){const n=this.element.lastElementChild.getBoundingClientRect();if(t.y>n.bottom){const t=(0,g.getContenteditableElement)((0,g.getLastBlock)(this.element.lastElementChild));if(!t||"NodeParagraph"!==this.element.lastElementChild.getAttribute("data-type")&&"NodeListItem"!==e.wysiwyg.element.getAttribute("data-doc-type")||"NodeParagraph"===this.element.lastElementChild.getAttribute("data-type")&&""!==(0,g.getContenteditableElement)(t).textContent){const t=(0,r.genEmptyElement)(!1,!1);this.element.insertAdjacentElement("beforeend",t),(0,b.transaction)(e,[{action:"insert",data:t.outerHTML,id:t.getAttribute("data-node-id"),previousID:t.previousElementSibling.getAttribute("data-node-id"),parentID:e.block.parentID}],[{action:"delete",id:t.getAttribute("data-node-id")}]);const n=(0,g.getContenteditableElement)(t);i.selectNodeContents(n),i.collapse(!0),(0,s.focusByRange)(i)}else t&&(i.selectNodeContents(t),i.collapse(!1))}}if(setTimeout((()=>{const t=(0,s.getEditorRange)(this.element);""!==t.toString().replace(o.Constants.ZWSP,"")?e.toolbar.render(e,t):(0,y.hideElements)(["toolbar"],e),e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")||(0,A.countSelectWord)(t),0===getSelection().rangeCount&&(0,s.focusByRange)(t)}),(0,l.isMobile)()?520:0),e.hint.enableEmoji=!1,window.siyuan.shiftIsPressed){t.preventDefault(),t.stopPropagation();let n=(0,a.hasClosestBlock)(i.startContainer),o=(0,a.hasClosestBlock)(t.target);if(n&&o&&n.isSameNode(o)&&(n=(0,a.hasClosestBlock)(i.endContainer)),n&&o&&(!n.isSameNode(o)||h&&h.isSameNode(n))){let t=!0;i.collapse(!0),h?n=h:h=n;const l=n.getBoundingClientRect(),r=o.getBoundingClientRect();let d=l.top,c=r.top;if(d===c&&(d=l.right,c=r.right),d>c){const e=o;o=n,n=e;const i=c;c=d,d=i,t=!1}let u=[],p=n,m=!1;for(;p;)if(p&&!p.classList.contains("protyle-attr")){const e=p.getBoundingClientRect();if(l.top===r.top?e.right<=c:e.top<=c)if(m)if(p.nextElementSibling&&!p.nextElementSibling.classList.contains("protyle-attr")){const e=p.nextElementSibling.getBoundingClientRect();if(l.top===r.top?e.right<=c:e.top<=c)u=[p],p=p.nextElementSibling,m=!1;else{if(!p.parentElement.classList.contains("sb"))break;p=(0,a.hasClosestBlock)(p.parentElement),m=!0}}else p=(0,a.hasClosestBlock)(p.parentElement),m=!0;else u.push(p),p=p.nextElementSibling;else{if(!p.parentElement.classList.contains("sb"))break;p=(0,a.hasClosestBlock)(p.parentElement),m=!0}}else p=(0,a.hasClosestBlock)(p.parentElement),m=!0;if(1!==u.length||u[0].classList.contains("list")||u[0].classList.contains("bq")||u[0].classList.contains("sb")){const i=[];e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")||!e.scroll||e.scroll.element.classList.contains("fn__none")||e.scroll.keepLazyLoad||!(n.getBoundingClientRect().top<2*-e.contentElement.clientHeight||o.getBoundingClientRect().bottom>2*e.contentElement.clientHeight)||(0,M.showMessage)(window.siyuan.languages.crossKeepLazyLoad),u.forEach((e=>{e.classList.add("protyle-wysiwyg--select"),i.push(e.getAttribute("data-node-id"))})),(0,A.countBlockWord)(i),t?(0,s.focusBlock)(u[u.length-1],e.wysiwyg.element,!1):(0,s.focusBlock)(u[0],e.wysiwyg.element,!1)}else h=void 0}}if(this.element.querySelector(".protyle-wysiwyg--select")&&""!==i.toString()&&(i.collapse(!1),(0,s.focusByRange)(i)),window.siyuan.ctrlIsPressed){let n=(0,a.hasClosestBlock)(t.target);if(n){n=(0,g.getTopAloneElement)(n),n.classList.contains("protyle-wysiwyg--select")?n.classList.remove("protyle-wysiwyg--select"):n.classList.add("protyle-wysiwyg--select"),n.querySelectorAll(".protyle-wysiwyg--select").forEach((e=>{e.classList.remove("protyle-wysiwyg--select")}));const t=(0,a.hasClosestByClassName)(n,"protyle-wysiwyg--select");t&&!n.isSameNode(t)&&t.classList.remove("protyle-wysiwyg--select");const i=[];e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach((e=>{i.push(e.getAttribute("data-node-id"))})),(0,A.countBlockWord)(i)}}e.options.render.breadcrumb&&e.breadcrumb.render(e)}))}}},3420:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,s){function o(e){try{r(i.next(e))}catch(e){s(e)}}function l(e){try{r(i.throw(e))}catch(e){s(e)}}function r(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,l)}r((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.input=void 0;const a=n(8740),s=n(2386),o=n(8438),l=n(5680),r=n(1985),d=n(2224),c=n(1456),u=n(3903),p=n(3053),m=n(4383),g=n(5615),b=n(7821),y=n(7683);t.input=(e,t,n,h=!0)=>i(void 0,void 0,void 0,(function*(){var i,w,v,_;if(!t.parentElement)return;const E=(0,u.getContenteditableElement)(t),k=t.getAttribute("data-type");if(!E)return"NodeThematicBreak"===k?t.innerHTML="<div><wbr></div>":"NodeBlockQueryEmbed"===k?t.lastElementChild.previousElementSibling.innerHTML="<wbr>"+o.Constants.ZWSP:"NodeMathBlock"===k||"NodeHTMLBlock"===k?t.lastElementChild.previousElementSibling.lastElementChild.innerHTML="<wbr>"+o.Constants.ZWSP:"NodeIFrame"===k||"NodeWidget"===k?t.innerHTML="<wbr>"+t.firstElementChild.outerHTML+t.lastElementChild.outerHTML:"NodeVideo"===k?t.firstElementChild.innerHTML="<wbr>"+o.Constants.ZWSP+t.firstElementChild.firstElementChild.outerHTML+t.firstElementChild.lastElementChild.outerHTML:"NodeAudio"===k?t.firstElementChild.innerHTML=t.firstElementChild.firstElementChild.outerHTML+"<wbr>"+o.Constants.ZWSP:"NodeCodeBlock"===k&&(n.startContainer.textContent=o.Constants.ZWSP),void(0,s.focusByWbr)(t,n);const C=document.createElement("wbr");n.insertNode(C);let x=t.getAttribute("data-node-id");if("NodeCodeBlock"!==k&&(E.innerHTML.endsWith("\n<wbr>")||E.innerHTML.endsWith("\n<wbr>\n")))return(0,r.updateTransaction)(e,x,t.outerHTML,t.outerHTML.replace("\n<wbr>","<wbr>")),void C.remove();const L=t.querySelector("br");!L||"TD"===L.parentElement.tagName||"TH"===L.parentElement.tagName||""!==L.parentElement.textContent.trim()&&"\n"!==(null===(w=null===(i=L.previousSibling)||void 0===i?void 0:i.previousSibling)||void 0===w?void 0:w.textContent)||L.remove(),t.setAttribute("updated",l().format("YYYYMMDDHHmmss")),"》<wbr>"===E.innerHTML&&(E.innerHTML="><wbr>");const S=E.innerHTML.trimStart();if((S.startsWith("````")||S.startsWith("····")||S.startsWith("~~~~"))&&-1===S.indexOf("\n"));else if((S.startsWith("```")||S.startsWith("···")||S.startsWith("~~~"))&&-1===S.indexOf("\n")&&-1===S.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`"))return(0,r.updateTransaction)(e,x,t.outerHTML,e.wysiwyg.lastHTMLs[x]),void C.remove();const T=(0,b.hasClosestByAttribute)(n.startContainer,"data-type","block-ref");if(T&&"d"===T.getAttribute("data-subtype")){(yield(0,y.fetchSyncPost)("/api/block/getRefText",{id:T.getAttribute("data-id")})).data!==T.innerHTML&&T.setAttribute("data-subtype","s")}let A=t.outerHTML,M="",H=!1;if("---"!==E.textContent||t.classList.contains("code-block"))if(!t.classList.contains("code-block")&&["[]","[ ]","[x]","[X]","【】","【 】","【x】","【X】"].includes(E.textContent)){const e=E.textContent.indexOf("x")>-1||E.textContent.indexOf("X")>-1;t.parentElement.classList.contains("li")&&3===t.parentElement.childElementCount?2===t.parentElement.parentElement.childElementCount&&(A=`<div data-subtype="t" data-node-id="${t.parentElement.parentElement.getAttribute("data-node-id")}" data-type="NodeList" class="list"><div data-marker="*" data-subtype="t" data-node-id="${t.parentElement.getAttribute("data-node-id")}" data-type="NodeListItem" class="li${e?" protyle-task--done":""}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${e?"C":"Unc"}heck"></use></svg></div><div data-node-id="${x}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="false"><wbr></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,x=t.parentElement.parentElement.getAttribute("data-node-id"),M=(t=t.parentElement.parentElement).outerHTML):(A=`<div data-subtype="t" data-node-id="${x}" data-type="NodeList" class="list"><div data-marker="*" data-subtype="t" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li${e?" protyle-task--done":""}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${e?"C":"Unc"}heck"></use></svg></div><div data-node-id="${Lute.NewNodeID()}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="false"><wbr></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,M=t.outerHTML)}else{if(S.startsWith("```")||S.startsWith("~~~")||S.startsWith("···")||S.indexOf("\n```")>-1||S.indexOf("\n~~~")>-1||S.indexOf("\n···")>-1)if(-1===S.indexOf("\n")&&S.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1);else{let e=E.innerHTML.replace(/^(~|·|`){3,}/g,"```").replace(/\n(~|·|`){3,}/g,"\n```").trim();e.endsWith("\n```")||(e=e.replace("<wbr>","")+"<wbr>\n```"),E.innerHTML=e,A=t.outerHTML}A=e.lute.SpinBlockDOM(A)}else{A=`<div data-node-id="${x}" data-type="NodeThematicBreak" class="hr"><div></div></div>`;const e=(0,u.getNextBlock)(E);e?(0,u.isNotEditBlock)(e)?H=!0:(0,s.focusBlock)(e):A+=(0,p.genEmptyBlock)(!1,!0)}e.toolbar.subElement.classList.add("fn__none");const I=document.createElement("template");if(I.innerHTML=A,!h||(null===(v=(0,u.getContenteditableElement)(I.content.firstElementChild))||void 0===v?void 0:v.innerHTML)===(0,u.getContenteditableElement)(t).innerHTML&&(1!==I.content.childElementCount||"<wbr>"!==(null===(_=(0,u.getContenteditableElement)(I.content.firstElementChild))||void 0===_?void 0:_.innerHTML))||1===I.content.childElementCount&&I.content.firstElementChild.classList.contains("code-block")&&t.classList.contains("code-block"))"NodeCodeBlock"===t.getAttribute("data-type")?(E.removeAttribute("data-render"),(0,c.highlightRender)(t)):((0,s.focusByWbr)(e.wysiwyg.element,n),e.hint.render(e));else{let i;(0,a.log)("SpinBlockDOM",t.outerHTML,"argument",e.options.debugger),(0,a.log)("SpinBlockDOM",A,"result",e.options.debugger),t.classList.contains("table")&&(i=(0,u.getContenteditableElement)(t).scrollLeft),/<span data-type="backslash"><span>\\<\/span>.<\/span><wbr>/.test(A)?t.outerHTML=A:t.outerHTML=A.replace("</span><wbr>","</span>"+o.Constants.ZWSP+"<wbr>"),t=e.wysiwyg.element.querySelector(`[data-node-id="${x}"]`),Array.from(I.content.children).forEach(((a,l)=>{const r=a.getAttribute("data-node-id");let p;p=r===x?t:e.wysiwyg.element.querySelector(`[data-node-id="${r}"]`);const b=p.getAttribute("data-type");if("NodeCodeBlock"===b){const t=p.querySelector(".protyle-action__language");t?(localStorage.getItem(o.Constants.LOCAL_CODELANG)&&""===t.textContent&&(t.textContent=localStorage.getItem(o.Constants.LOCAL_CODELANG)),(0,c.highlightRender)(p)):1===I.content.childElementCount&&e.toolbar.showRender(e,p)}else["NodeMathBlock","NodeHTMLBlock"].includes(b)?("NodeMathBlock"===b&&(0,d.mathRender)(p),e.toolbar.showRender(e,p)):"NodeBlockQueryEmbed"===b?((0,m.blockRender)(e,p),e.toolbar.showRender(e,p),(0,g.hideElements)(["hint"],e)):"NodeThematicBreak"===b&&H?(0,s.focusBlock)(t):((0,d.mathRender)(p),l===I.content.childElementCount-1&&((0,s.focusByWbr)(e.wysiwyg.element,n),e.hint.render(e),i>0&&((0,u.getContenteditableElement)(p).scrollLeft=i)))}))}(0,g.hideElements)(["gutter"],e),f(A,e,x,k,M)}));const f=(e,t,n,i,a)=>{const s=document.createElement("template");s.innerHTML=e;const o=[],l=[];Array.from(s.content.children).forEach(((e,i)=>{var s;"false"===e.getAttribute("spellcheck")&&"false"===e.getAttribute("contenteditable")&&e.setAttribute("contenteditable","true");const r=e.getAttribute("data-node-id");if(r===n)o.push({id:n,data:e.outerHTML,action:"update"}),l.push({id:n,data:t.wysiwyg.lastHTMLs[n]||a,action:"update"});else{let n;0===i&&(n=t.wysiwyg.element.querySelector(`[data-node-id="${r}"]`)),o.push({action:"insert",data:e.outerHTML,id:r,previousID:0===i?null===(s=null==n?void 0:n.previousElementSibling)||void 0===s?void 0:s.getAttribute("data-node-id"):e.previousElementSibling.getAttribute("data-node-id"),parentID:(null==n?void 0:n.parentElement.getAttribute("data-node-id"))||t.block.parentID}),l.push({id:r,action:"delete"})}})),(0,r.transaction)(t,o,l)}},6622:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.keydown=void 0;const i=n(5615),a=n(532),s=n(2386),o=n(7821),l=n(5967),r=n(3903),d=n(1676),c=n(4652),u=n(1301),p=n(1985),m=n(8247),g=n(9407),b=n(3029),y=n(3053),f=n(6112),h=n(133),w=n(2964),v=n(8438),_=n(5788),E=n(6937),k=n(7683),C=n(1040),x=n(5449),L=n(5680),S=n(1456),T=n(9229),A=n(999);t.keydown=(e,t)=>{t.addEventListener("keydown",(n=>{var M,H,I,B,$,N,D,P,O,R,q,j,F,W,U,Y,z,G,K;if("protyle-html"===n.target.localName)return void n.stopPropagation();if(e.disabled||!e.selectElement.classList.contains("fn__none"))return n.stopPropagation(),void n.preventDefault();e.wysiwyg.preventKeyup=!1,(0,i.hideElements)(["util"],e),n.shiftKey&&n.key.indexOf("Arrow")>-1||n.repeat||(0,i.hideElements)(["toolbar"],e);const Z=(0,s.getEditorRange)(e.wysiwyg.element),V=(0,o.hasClosestBlock)(Z.startContainer);if(!V)return;if(V.classList.contains("protyle-wysiwyg--select")&&!(0,a.isCtrl)(n)&&!n.shiftKey&&!n.altKey){if("a"===n.key.toLowerCase())return n.stopPropagation(),n.preventDefault(),e.wysiwyg.element.blur(),setTimeout((()=>{(0,y.insertEmptyBlock)(e,"afterend")}),100),!1;if("b"===n.key.toLowerCase())return n.stopPropagation(),n.preventDefault(),e.wysiwyg.element.blur(),setTimeout((()=>{(0,y.insertEmptyBlock)(e,"beforebegin")}),100),!1}if(n.isComposing)return void n.stopPropagation();if((0,a.isCtrl)(n)||n.shiftKey||n.altKey||("Slash"===n.code?e.hint.enableSlash=!0:"Backslash"===n.code&&(e.hint.enableSlash=!1,(0,i.hideElements)(["hint"],e))),"PageUp"===n.key||"PageDown"===n.key||"Home"===n.key||"End"===n.key||-1!==n.key.indexOf("Arrow")||"Escape"===n.key||"Shift"===n.key||"Meta"===n.key||"Alt"===n.key||"Control"===n.key||"CapsLock"===n.key||/^F\d{1,2}$/.test(n.key)||void 0!==e.wysiwyg.lastHTMLs[V.getAttribute("data-node-id")]||(Z.insertNode(document.createElement("wbr")),e.wysiwyg.lastHTMLs[V.getAttribute("data-node-id")]=V.outerHTML,V.querySelector("wbr").remove()),(0,E.bindMenuKeydown)(n))return n.stopPropagation(),void n.preventDefault();if("Escape"!==n.key&&window.siyuan.menus.menu.remove(),["Alt","Meta","Shift","Control","CapsLock","Escape"].includes(n.key)||e.breadcrumb.hide(),!(n.altKey||n.shiftKey||(0,a.isCtrl)(n)||"ArrowDown"!==n.key&&"ArrowUp"!==n.key)){const t=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.length>0){if(n.preventDefault(),n.stopPropagation(),t.forEach((e=>{e.classList.remove("protyle-wysiwyg--select")})),"ArrowDown"===n.key){const n=t[t.length-1];let i=(0,r.getNextBlock)(n);if(i)if(0===i.getBoundingClientRect().width){const e=(0,o.hasTopClosestByAttribute)(i,"fold","1");e?(i=(0,r.getNextBlock)(e),i=i?(0,r.getFirstBlock)(i):n):i=n}else"1"===i.getAttribute("fold")&&(i.classList.contains("sb")||i.classList.contains("bq"))||(i=(0,r.getFirstBlock)(i));else i=n;i.classList.add("protyle-wysiwyg--select"),(0,T.countBlockWord)([i.getAttribute("data-node-id")]);const a=i.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;a>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+a,e.scroll.lastScrollTop=e.contentElement.scrollTop-1),(0,s.focusBlock)(i)}else if("ArrowUp"===n.key){let n=(0,r.getPreviousBlock)(t[0]);if(n){if(n=(0,r.getLastBlock)(n),0===n.getBoundingClientRect().width){const e=(0,o.hasTopClosestByAttribute)(n,"fold","1");n=e?(0,r.getFirstBlock)(e):t[0]}else if(n){const e=(0,o.hasTopClosestByAttribute)(n,"fold","1");e&&(e.classList.contains("sb")||e.classList.contains("bq"))&&(n=e)}}else!e.title||"true"!==e.wysiwyg.element.firstElementChild.getAttribute("data-eof")&&0!==e.contentElement.scrollTop?0!==e.contentElement.scrollTop?(e.contentElement.scrollTop=0,e.scroll.lastScrollTop=8):n=t[0]:e.title.editElement.focus();if(n){n.classList.add("protyle-wysiwyg--select"),(0,T.countBlockWord)([n.getAttribute("data-node-id")]);const t=n.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;t<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+t,e.scroll.lastScrollTop=e.contentElement.scrollTop+1),(0,s.focusBlock)(n)}}return}}if(!("PageUp"===n.key||"PageDown"===n.key||"Home"===n.key||"End"===n.key||-1!==n.key.indexOf("Arrow")||(0,a.isCtrl)(n)||"Escape"===n.key||n.shiftKey||n.altKey||/^F\d{1,2}$/.test(n.key)||"Enter"===n.key||"Tab"===n.key||"Backspace"===n.key||"Delete"===n.key))return n.stopPropagation(),(0,i.hideElements)(["select"],e),!1;if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.collapse.custom,n)){const t=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");return t.length>0?(0,f.setFold)(e,t[0]):"NodeListItem"===V.parentElement.getAttribute("data-type")?V.parentElement.childElementCount>3?(0,f.setFold)(e,V.parentElement):(0,f.setFold)(e,V):"NodeHeading"===V.getAttribute("data-type")?(0,f.setFold)(e,V):(0,f.setFold)(e,(0,r.getTopAloneElement)(V)),n.stopPropagation(),n.preventDefault(),!1}if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.expand.custom,n)){const t=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");return t.length>0?(0,f.setFold)(e,t[0],!0):"NodeListItem"===V.parentElement.getAttribute("data-type")?V.parentElement.childElementCount>3?(0,f.setFold)(e,V.parentElement,!0):(0,f.setFold)(e,V,!0):"NodeHeading"===V.getAttribute("data-type")?(0,f.setFold)(e,V,!0):(0,f.setFold)(e,(0,r.getTopAloneElement)(V),!0),n.stopPropagation(),void n.preventDefault()}if((0,d.matchHotKey)("⇧←",n)||(0,d.matchHotKey)("⇧→",n)){if(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").length>0)return n.stopPropagation(),void n.preventDefault()}if((0,d.matchHotKey)("⇧↑",n)){const a=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(a.length>0)n.stopPropagation(),n.preventDefault();else{const e=(0,s.getSelectionOffset)(V,t,Z).start;if(0!==e){const t=(0,r.getContenteditableElement)(V);if("TABLE"!==t.tagName){const i=t.textContent.indexOf("\n");return-1===i||e<=i||e===t.textContent.replace("\n"," ").indexOf("\n")?((0,s.setFirstNodeRange)(t,Z),n.stopPropagation(),void n.preventDefault()):void 0}{const e=(0,o.hasClosestByMatchTag)(Z.startContainer,"TH")||(0,o.hasClosestByMatchTag)(Z.startContainer,"TD")||t.querySelector("th, td");if(0!==(0,s.getSelectionOffset)(e,e,Z).start)return(0,s.setFirstNodeRange)(e,Z),n.stopPropagation(),void n.preventDefault()}}}if(Z.collapse(!0),(0,i.hideElements)(["toolbar"],e),0===a.length)V.classList.add("protyle-wysiwyg--select");else{const t=a[0].previousElementSibling;if(t&&t.getAttribute("data-node-id")){t.classList.add("protyle-wysiwyg--select");const n=t.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;n<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+n,e.scroll.lastScrollTop=e.contentElement.scrollTop+1)}else a[0].parentElement.classList.contains("protyle-wysiwyg")||((0,i.hideElements)(["select"],e),a[0].parentElement.classList.add("protyle-wysiwyg--select"))}const l=[];return e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach((e=>{l.push(e.getAttribute("data-node-id"))})),(0,T.countBlockWord)(l),n.stopPropagation(),void n.preventDefault()}if((0,d.matchHotKey)("⇧↓",n)){const a=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(a.length>0)n.stopPropagation(),n.preventDefault();else{const e=(0,r.getContenteditableElement)(V),i=(0,s.getSelectionOffset)(V,t,Z).end;if(i<e.textContent.length)return i>e.textContent.lastIndexOf("\n")?((0,s.setLastNodeRange)(e,Z,!1),n.stopPropagation(),void n.preventDefault()):void 0}Z.collapse(!1),(0,i.hideElements)(["toolbar"],e);const o=a[a.length-1];if(0===a.length)V.classList.add("protyle-wysiwyg--select");else{const t=o.nextElementSibling;if(t&&t.getAttribute("data-node-id")){t.classList.add("protyle-wysiwyg--select");const n=t.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;n>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+n,e.scroll.lastScrollTop=e.contentElement.scrollTop-1)}else o.parentElement.classList.contains("protyle-wysiwyg")||((0,i.hideElements)(["select"],e),o.parentElement.classList.add("protyle-wysiwyg--select"))}const l=[];return e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach((e=>{l.push(e.getAttribute("data-node-id"))})),(0,T.countBlockWord)(l),n.stopPropagation(),void n.preventDefault()}if((0,d.matchHotKey)(window.siyuan.config.keymap.general.enter.custom,n)){let t=(0,r.getTopAloneElement)(V);return t.parentElement.classList.contains("li")&&t.parentElement.parentElement.classList.contains("list")&&(null===(M=t.nextElementSibling)||void 0===M?void 0:M.classList.contains("list"))&&t.previousElementSibling.classList.contains("protyle-action")&&(t=t.parentElement),(0,f.zoomOut)(e,t.getAttribute("data-node-id")),n.preventDefault(),void n.stopPropagation()}if((0,d.matchHotKey)(window.siyuan.config.keymap.general.enterBack.custom,n)){if(e.block.showAll)(0,f.zoomOut)(e,e.block.parent2ID,V.getAttribute("data-node-id"));else{const t=e.path.split("/");t.length>2&&(0,A.openMobileFileById)(t[t.length-2],[v.Constants.CB_GET_FOCUS,v.Constants.CB_GET_SCROLL])}return n.preventDefault(),void n.stopPropagation()}if(!n.altKey&&!(0,a.isCtrl)(n)&&("Home"===n.key||"End"===n.key)&&(0,a.isMac)()){const e=(0,r.getContenteditableElement)(V);return e&&"TABLE"!==e.tagName&&(n.shiftKey?"Home"===n.key&&e.firstChild?Z.setStartBefore(e.firstChild):Z.setEndAfter(e.lastChild):(Z.selectNodeContents(e),Z.collapse("Home"===n.key))),n.stopPropagation(),void n.preventDefault()}if(!n.altKey&&!n.shiftKey&&(0,a.isCtrl)(n)&&"Home"===n.key)return"0"===e.wysiwyg.element.firstElementChild.getAttribute("data-node-index")||"true"===e.wysiwyg.element.firstElementChild.getAttribute("data-eof")?((0,s.focusBlock)(e.wysiwyg.element.firstElementChild),e.contentElement.scrollTop=0,e.scroll.lastScrollTop=1):(0,k.fetchPost)("/api/filetree/getDoc",{id:e.block.rootID,mode:0,size:v.Constants.SIZE_GET},(t=>{(0,C.onGet)(t,e,[v.Constants.CB_GET_FOCUS])})),n.stopPropagation(),void n.preventDefault();if(!n.altKey&&!n.shiftKey&&(0,a.isCtrl)(n)&&"End"===n.key)return e.scroll.element.classList.contains("fn__none")||"true"===e.wysiwyg.element.lastElementChild.getAttribute("data-eof")?(e.contentElement.scrollTop=e.contentElement.scrollHeight,e.scroll.lastScrollTop=e.contentElement.scrollTop,(0,s.focusBlock)(e.wysiwyg.element.lastElementChild,void 0,!1)):(0,k.fetchPost)("/api/filetree/getDoc",{id:e.block.rootID,mode:4,size:v.Constants.SIZE_GET},(t=>{(0,C.onGet)(t,e,[v.Constants.CB_GET_FOCUS])})),n.stopPropagation(),void n.preventDefault();if(!(n.altKey||n.shiftKey||(0,a.isCtrl)(n)||"PageUp"!==n.key&&"PageDown"!==n.key)){"PageUp"===n.key?(e.contentElement.scrollTop=e.contentElement.scrollTop-e.contentElement.clientHeight,e.scroll.lastScrollTop=e.contentElement.scrollTop+1):(e.contentElement.scrollTop=e.contentElement.scrollTop+e.contentElement.clientHeight,e.scroll.lastScrollTop=e.contentElement.scrollTop-1);const t=e.contentElement.getBoundingClientRect();let i=document.elementFromPoint(t.x+t.width/2,t.y+t.height/2);i.classList.contains("protyle-wysiwyg")&&(i=document.elementFromPoint(t.x+t.width/2,t.y+t.height/2+v.Constants.SIZE_TOOLBAR_HEIGHT));const a=(0,o.hasClosestBlock)(i);return a&&!a.isSameNode(V)&&(0,s.focusBlock)(a,void 0,!1),n.stopPropagation(),void n.preventDefault()}if(!n.altKey&&!n.shiftKey&&!(0,a.isCtrl)(n)&&(n.key.indexOf("Arrow")>-1||"Enter"===n.key)&&!e.hint.element.classList.contains("fn__none")&&e.hint.select(n,e))return n.stopPropagation(),void n.preventDefault();if((0,d.matchHotKey)("⌘/",n)){n.stopPropagation(),n.preventDefault();const t=(0,o.hasClosestByAttribute)(Z.startContainer,"data-type",null);if(t){const n=t.getAttribute("data-type").split(" ");if(n.includes("block-ref"))return void(0,f.refMenu)(e,t);if(n.includes("inline-memo"))return void e.toolbar.showRender(e,t);if(n.includes("file-annotation-ref"))return void e.toolbar.showFileAnnotationRef(e,t);if(n.includes("a"))return void(0,f.linkMenu)(e,t)}if(0===Z.startOffset&&3===Z.startContainer.nodeType){const t=(0,r.hasPreviousSibling)(Z.startContainer);if(t&&3!==t.nodeType&&t.getAttribute("data-type").indexOf("inline-math")>-1)return void e.toolbar.showRender(e,t);if(!t&&Z.startContainer.parentElement.previousSibling.isSameNode(Z.startContainer.parentElement.previousElementSibling)&&Z.startContainer.parentElement.previousElementSibling.getAttribute("data-type").indexOf("inline-math")>-1)return void e.toolbar.showRender(e,Z.startContainer.parentElement.previousElementSibling)}const i=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let a=V;i.length>0&&(a=i[0]),e.gutter.renderMenu(e,a);const s=V.getBoundingClientRect();return void window.siyuan.menus.menu.popup({x:s.left,y:s.top},!0)}if((0,u.fixTable)(e,n,Z))return void n.preventDefault();if(!n.altKey&&!n.shiftKey&&!(0,a.isCtrl)(n)&&!n.isComposing&&n.key.indexOf("Arrow")>-1){e.hint.enableEmoji=!1;const t=(0,r.getContenteditableElement)(V)||V,i=(0,s.getSelectionOffset)(t,e.wysiwyg.element,Z),a=(0,o.hasClosestByMatchTag)(Z.startContainer,"TD");if("ArrowDown"===n.key&&-1===(null==t?void 0:t.textContent.trimRight().substr(i.start).indexOf("\n"))&&(a&&!a.parentElement.nextElementSibling&&"NodeTable"===V.getAttribute("data-type")&&!(0,r.getNextBlock)(V)||"NodeCodeBlock"===V.getAttribute("data-type")&&!(0,r.getNextBlock)(V)||"NodeBlockquote"===V.parentElement.getAttribute("data-type")&&V.nextElementSibling.classList.contains("protyle-attr")&&!(0,r.getNextBlock)(V.parentElement)))"NodeBlockquote"===V.parentElement.getAttribute("data-type")?(0,y.insertEmptyBlock)(e,"afterend",V.parentElement.getAttribute("data-node-id")):(0,y.insertEmptyBlock)(e,"afterend",V.getAttribute("data-node-id"));else if("ArrowUp"===n.key){const a=(0,r.getContenteditableElement)(e.wysiwyg.element.firstElementChild);if(!(0,r.getPreviousBlock)(V)&&V.contains(a)||!a&&V.isSameNode(e.wysiwyg.element.firstElementChild))-1===(null==t?void 0:t.textContent.substr(0,i.end).indexOf("\n"))&&(!e.title||"true"!==e.wysiwyg.element.firstElementChild.getAttribute("data-eof")&&0!==e.contentElement.scrollTop?(e.contentElement.scrollTop=0,e.scroll.lastScrollTop=8):e.title.editElement.focus());else if(-1===(null==t?void 0:t.textContent.substr(0,i.end).indexOf("\n"))){let t=(0,r.getPreviousBlock)(V);if(t&&(t=(0,r.getLastBlock)(t),t)){const i=(0,o.hasClosestByAttribute)(t,"fold","1");(null===(H=(0,r.getContenteditableElement)(t))||void 0===H?void 0:H.textContent.endsWith("\n"))&&!i?((0,s.focusBlock)(t,void 0,!1),(0,x.scrollCenter)(e,t),n.stopPropagation(),n.preventDefault()):i&&"NodeListItem"!==i.getAttribute("data-type")&&(i.scrollTop=0,(0,s.focusBlock)(i,void 0,!0),(0,x.scrollCenter)(e,i),n.stopPropagation(),n.preventDefault())}}}else if(""!==Z.toString()||"ArrowDown"!==n.key&&"ArrowRight"!==n.key||!V.isSameNode((0,r.getLastBlock)(e.wysiwyg.element.lastElementChild))||(0,o.hasClosestByMatchTag)(Z.startContainer,"TD")||(0,o.hasClosestByMatchTag)(Z.startContainer,"TH")){if(""===Z.toString()&&"ArrowLeft"===n.key&&V.isSameNode((0,r.getFirstBlock)(e.wysiwyg.element.firstElementChild))){const e=(0,r.getContenteditableElement)(V);e&&0===(0,s.getSelectionOffset)(e,void 0,Z).start&&(n.stopPropagation(),n.preventDefault(),(0,s.focusByRange)(Z))}}else{const e=(0,r.getContenteditableElement)(V);e&&e.textContent.replace(/\n$/,"").length<=(0,s.getSelectionOffset)(e,void 0,Z).end&&(n.stopPropagation(),n.preventDefault(),(0,s.focusByRange)(Z))}if("ArrowDown"===n.key){const a=(0,o.hasClosestByAttribute)(Z.startContainer,"fold","1");if(a){let t=(0,r.getNextBlock)(a);t&&("1"===t.getAttribute("fold")&&(t.classList.contains("sb")||t.classList.contains("bq"))||(t=(0,r.getFirstBlock)(t)),(0,s.focusBlock)(t),(0,x.scrollCenter)(e,t)),n.stopPropagation(),n.preventDefault()}else if(-1===(null==t?void 0:t.textContent.substr(i.end+1).indexOf("\n"))){const t=(0,r.getNextBlock)(V);t&&"1"===t.getAttribute("fold")&&((0,s.focusBlock)(t),(0,x.scrollCenter)(e,t),n.stopPropagation(),n.preventDefault())}}return}const X=Z.toString();if(!(n.altKey||n.shiftKey||"Backspace"!==n.key&&"Delete"!==n.key)){(0,T.countBlockWord)([]);const t=(0,r.hasPreviousSibling)(Z.startContainer);1===Z.startOffset&&Z.startContainer.textContent===v.Constants.ZWSP&&t&&3!==t.nodeType&&t.classList.contains("img")&&t.classList.add("img--select");const i=e.wysiwyg.element.querySelector(".img--select");if(e.wysiwyg.element.querySelector(".protyle-wysiwyg--select"))return(0,l.removeBlock)(e,V,Z),n.stopPropagation(),void n.preventDefault();if(i){i.insertAdjacentHTML("afterend","<wbr>"),i.classList.remove("img--select");const t=V.outerHTML;return i.remove(),(0,p.updateTransaction)(e,V.getAttribute("data-node-id"),V.outerHTML,t),(0,s.focusByWbr)(V,Z),n.stopPropagation(),void n.preventDefault()}if(""===X){const t=(0,r.getContenteditableElement)(V);if(!t)return V.classList.add("protyle-wysiwyg--select"),(0,l.removeBlock)(e,V,Z),n.stopPropagation(),void n.preventDefault();const i=(0,s.getSelectionOffset)(t,e.wysiwyg.element,Z);if("Delete"===n.key){if(i.end===t.textContent.length){const t=(0,r.getNextBlock)((0,r.getTopAloneElement)(V));if(t){const i=(0,s.focusBlock)(t);if(i){const t=(0,o.hasClosestBlock)(i.startContainer);t&&(0,l.removeBlock)(e,t,i)}return n.stopPropagation(),void n.preventDefault()}}else if(i.end===t.textContent.length-1&&"NodeCodeBlock"===V.getAttribute("data-type"))return n.stopPropagation(),void n.preventDefault()}else{const t=Z.startContainer.childNodes[Z.startOffset-1];if(0===i.start&&(0===Z.startOffset||t&&3===t.nodeType&&!(0,r.hasPreviousSibling)(t)&&""===t.textContent))return(0,l.removeBlock)(e,V,Z),n.stopPropagation(),void n.preventDefault();if(3!==Z.startContainer.nodeType&&"NodeTable"===V.getAttribute("data-type")&&"TABLE"===(null===(I=Z.startContainer.children[Z.startOffset-1])||void 0===I?void 0:I.tagName))return V.classList.add("protyle-wysiwyg--select"),(0,l.removeBlock)(e,V,Z),n.stopPropagation(),void n.preventDefault();if(t&&3!==t.nodeType&&t.classList.contains("img")){Z.insertNode(document.createElement("wbr"));const i=V.outerHTML;return t.remove(),(0,p.updateTransaction)(e,V.getAttribute("data-node-id"),V.outerHTML,i),(0,s.focusByWbr)(V,Z),n.stopPropagation(),void n.preventDefault()}if(V.classList.contains("code-block")&&3===Z.startContainer.nodeType&&"\n"===Z.startContainer.textContent.substring(Z.startOffset-1,Z.startOffset))return n.stopPropagation(),void n.preventDefault()}}}if((0,d.matchHotKey)("⇧↩",n)&&""===Z.toString()){let t=Z.startContainer;const i=(0,r.hasNextSibling)(t);if(i&&3!==i.nodeType&&i.classList.contains("img")){i.insertAdjacentHTML("beforebegin","<wbr>");const a=V.outerHTML;i.previousElementSibling.remove();const s=document.createTextNode("\n");return t.after(document.createTextNode(v.Constants.ZWSP)),t.after(s),Z.selectNode(s),Z.collapse(!1),(0,p.updateTransaction)(e,V.getAttribute("data-node-id"),V.outerHTML,a),n.stopPropagation(),void n.preventDefault()}if(3===t.nodeType&&(t=t.parentElement),t&&e.toolbar.getCurrentType(Z).length>0&&(0,s.getSelectionOffset)(t,t,Z).end===t.textContent.length){t.insertAdjacentHTML("afterend","<wbr>");const i=V.outerHTML;t.nextElementSibling.remove(),(0,r.hasNextSibling)(t)||t.after(document.createTextNode("\n"));const a=document.createTextNode("\n");return t.after(a),Z.selectNode(a),Z.collapse(!1),(0,p.updateTransaction)(e,V.getAttribute("data-node-id"),V.outerHTML,i),n.stopPropagation(),void n.preventDefault()}if("ios"===window.siyuan.config.system.container){t=Z.startContainer;const e=(0,r.hasNextSibling)(t);if(e&&""!==e.textContent.trim())return document.execCommand("insertHTML",!1,"\n"),n.stopPropagation(),void n.preventDefault();e||t.after(document.createTextNode("\n"));const i=document.createTextNode("\n");t.after(i);const a=(0,r.hasNextSibling)(i);return a&&"\n"===a.textContent?Z.setStart(a,0):Z.setStart(i,0),Z.collapse(!1),(0,s.focusByRange)(Z),n.stopPropagation(),void n.preventDefault()}}if(!n.altKey&&!n.shiftKey&&!(0,a.isCtrl)(n)&&"Enter"===n.key)return n.stopPropagation(),n.preventDefault(),void(0,c.enter)(V,Z,e);if((0,d.matchHotKey)("⌘A",n))return n.preventDefault(),(0,s.selectAll)(e,V,Z),!0;if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.undo.custom,n))return e.undo.undo(e),n.preventDefault(),void n.stopPropagation();if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.redo.custom,n))return e.undo.redo(e),n.preventDefault(),void n.stopPropagation();if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.copyProtocol.custom,n)){const t=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let i;return i=1===t.length?t[0]:V,(0,a.writeText)(`siyuan://blocks/${i.getAttribute("data-node-id")}`),n.preventDefault(),n.stopPropagation(),!0}if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.copyID.custom,n))return(0,a.writeText)(V.getAttribute("data-node-id")),n.preventDefault(),n.stopPropagation(),!0;if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.copyBlockRef.custom,n)){const t=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let i;i=1===t.length?t[0]:V;const s=i.getAttribute("data-node-id");return""!==X?(0,a.writeText)(`((${s} "${X}"))`):(0,k.fetchPost)("/api/block/getRefText",{id:s},(e=>{(0,a.writeText)(`((${s} '${e.data}'))`)})),n.preventDefault(),n.stopPropagation(),!0}if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,n)){const t=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let i;return i=1===t.length?t[0]:V,(0,a.writeText)(`{{select * from blocks where id='${i.getAttribute("data-node-id")}'}}`),n.preventDefault(),n.stopPropagation(),!0}if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.attr.custom,n)){const t=(0,r.getTopAloneElement)(V);if(""===X){const n=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let i;i=1===n.length?n[0]:t,(0,w.openAttr)(i,e)}else{const n=t.outerHTML,i=Lute.EscapeHTMLStr(X),a=t.lastElementChild.querySelector(".protyle-attr--name");a?a.innerHTML=`<svg><use xlink:href="#iconN"></use></svg>${i}`:t.lastElementChild.insertAdjacentHTML("afterbegin",`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${i}</div>`),t.setAttribute("name",i),(0,p.updateTransaction)(e,t.getAttribute("data-node-id"),t.outerHTML,n)}return n.preventDefault(),n.stopPropagation(),!0}if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.rename.custom,n))return""===X?(0,k.fetchPost)("/api/block/getDocInfo",{id:e.block.rootID},(t=>{(0,b.rename)({notebookId:e.notebookId,path:e.path,name:t.data.ial.title,range:Z,type:"file"})})):(0,k.fetchPost)("/api/filetree/renameDoc",{notebook:e.notebookId,path:e.path,title:(0,b.replaceFileName)(X)}),n.preventDefault(),void n.stopPropagation();if(X.trim()&&(0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.newNameFile.custom,n))return(0,b.newFileBySelect)(X,e),n.preventDefault(),void n.stopPropagation();if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.newContentFile.custom,n))return(0,b.newFileContentBySelect)(e),n.preventDefault(),void n.stopPropagation();if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.alignLeft.custom,n)){const t=V.querySelectorAll(".img--select");if(t.length>0){const n=V.outerHTML;t.forEach((e=>{e.style.display="",(0,r.hasNextSibling)(e)||e.insertAdjacentText("afterend",v.Constants.ZWSP)})),(0,p.updateTransaction)(e,V.getAttribute("data-node-id"),V.outerHTML,n)}else{let t=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));0===t.length&&(t=[V]),(0,p.updateBatchTransaction)(t,e,(e=>{e.style.textAlign="left"}))}return n.stopPropagation(),void n.preventDefault()}if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.alignCenter.custom,n)){const t=V.querySelectorAll(".img--select");if(t.length>0){const n=V.outerHTML;t.forEach((e=>{e.style.display="block";let t=e.nextSibling;for(;t;){if(""!==t.textContent){if(t.textContent===v.Constants.ZWSP){t.textContent="";break}break}t=t.nextSibling}})),(0,p.updateTransaction)(e,V.getAttribute("data-node-id"),V.outerHTML,n)}else{let t=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));0===t.length&&(t=[V]),(0,p.updateBatchTransaction)(t,e,(e=>{e.style.textAlign="center"}))}return n.stopPropagation(),void n.preventDefault()}if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.alignRight.custom,n)){let t=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));return 0===t.length&&(t=[V]),(0,p.updateBatchTransaction)(t,e,(e=>{e.style.textAlign="right"})),n.stopPropagation(),void n.preventDefault()}if("Escape"===n.key)return e.toolbar.element.classList.contains("fn__none")&&e.hint.element.classList.contains("fn__none")&&e.toolbar.subElement.classList.contains("fn__none")?V.classList.contains("protyle-wysiwyg--select")?((0,i.hideElements)(["select"],e),(0,T.countBlockWord)([])):window.siyuan.menus.menu.element.classList.contains("fn__none")?(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach((e=>{e.classList.remove("protyle-wysiwyg--select")})),Z.collapse(!1),V.classList.add("protyle-wysiwyg--select"),(0,T.countBlockWord)([V.getAttribute("data-node-id")])):window.siyuan.menus.menu.remove():((0,i.hideElements)(["toolbar","hint","util"],e),e.hint.enableEmoji=!1),void n.preventDefault();if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.heading.paragraph.custom,n))return(0,p.turnsIntoTransaction)({protyle:e,nodeElement:V,type:"Blocks2Ps"}),n.preventDefault(),n.stopPropagation(),!0;if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.heading.heading1.custom,n))return(0,p.turnsIntoTransaction)({protyle:e,nodeElement:V,type:"Blocks2Hs",level:1}),n.preventDefault(),n.stopPropagation(),!0;if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.heading.heading2.custom,n))return(0,p.turnsIntoTransaction)({protyle:e,nodeElement:V,type:"Blocks2Hs",level:2}),n.preventDefault(),n.stopPropagation(),!0;if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.heading.heading3.custom,n))return(0,p.turnsIntoTransaction)({protyle:e,nodeElement:V,type:"Blocks2Hs",level:3}),n.preventDefault(),n.stopPropagation(),!0;if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.heading.heading4.custom,n))return(0,p.turnsIntoTransaction)({protyle:e,nodeElement:V,type:"Blocks2Hs",level:4}),n.preventDefault(),n.stopPropagation(),!0;if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.heading.heading5.custom,n))return(0,p.turnsIntoTransaction)({protyle:e,nodeElement:V,type:"Blocks2Hs",level:5}),n.preventDefault(),n.stopPropagation(),!0;if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.heading.heading6.custom,n))return(0,p.turnsIntoTransaction)({protyle:e,nodeElement:V,type:"Blocks2Hs",level:6}),n.preventDefault(),n.stopPropagation(),!0;if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.insert.code.custom,n)&&"NodeCodeBlock"!==V.getAttribute("data-type")){const t=V.getAttribute("data-node-id"),i=V.outerHTML,a=(0,r.getContenteditableElement)(V);a.innerHTML="```"+(localStorage.getItem(v.Constants.LOCAL_CODELANG)||"")+"\n"+a.textContent+"<wbr>\n```";const s=e.lute.SpinBlockDOM(V.outerHTML);V.outerHTML=s;const o=e.wysiwyg.element.querySelector(`[data-node-id="${t}"]`);return(0,p.updateTransaction)(e,t,s,i),(0,S.highlightRender)(o),n.preventDefault(),n.stopPropagation(),!0}if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.insert.lastUsed.custom,n))return e.toolbar.range=Z,(0,m.fontEvent)(e),n.stopPropagation(),void n.preventDefault();if(!V.classList.contains("code-block")){if(e.options.toolbar.find((t=>!!t.hotkey&&((0,d.matchHotKey)(t.hotkey,n)?(e.toolbar.range=(0,s.getEditorRange)(e.wysiwyg.element),e.toolbar.setInlineMark(e,t.name,"range"),!0):void 0))))return n.preventDefault(),n.stopPropagation(),e.wysiwyg.preventKeyup=!0,!0}if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.list.outdent.custom,n)){const t=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.length>0&&"NodeListItem"===t[0].getAttribute("data-type"))return(0,g.listOutdent)(e,Array.from(t),Z),n.preventDefault(),n.stopPropagation(),!0;if(V.parentElement.classList.contains("li")&&"NodeCodeBlock"!==V.getAttribute("data-type"))return(0,g.listOutdent)(e,[V.parentElement],Z),n.preventDefault(),n.stopPropagation(),!0}if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.list.indent.custom,n)){const t=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.length>0&&"NodeListItem"===t[0].getAttribute("data-type"))return(0,g.listIndent)(e,Array.from(t),Z),n.preventDefault(),n.stopPropagation(),!0;if(V.parentElement.classList.contains("li")&&"NodeCodeBlock"!==V.getAttribute("data-type"))return(0,g.listIndent)(e,[V.parentElement],Z),n.preventDefault(),n.stopPropagation(),!0}if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.insert.check.custom,n))return e.hint.splitChar="/",e.hint.lastIndex=-1,e.hint.fill("* [ ] "+Lute.Caret,e),n.preventDefault(),void n.stopPropagation();if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.insert.table.custom,n))return e.hint.splitChar="/",e.hint.lastIndex=-1,e.hint.fill(`| col1${Lute.Caret} | col2 | col3 |\n| --- | --- | --- |\n|  |  |  |\n|  |  |  |`,e),n.preventDefault(),void n.stopPropagation();if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.list.checkToggle.custom,n)){const t=(0,o.hasClosestByAttribute)(Z.startContainer,"data-subtype","t");if(!t)return;const i=t.outerHTML;return t.classList.contains("protyle-task--done")?(t.querySelector("use").setAttribute("xlink:href","#iconUncheck"),t.classList.remove("protyle-task--done")):(t.querySelector("use").setAttribute("xlink:href","#iconCheck"),t.classList.add("protyle-task--done")),t.setAttribute("updated",L().format("YYYYMMDDHHmmss")),(0,p.updateTransaction)(e,t.getAttribute("data-node-id"),t.outerHTML,i),n.preventDefault(),void n.stopPropagation()}if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.insertBefore.custom,n))return(0,y.insertEmptyBlock)(e,"beforebegin"),n.preventDefault(),!0;if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.insertAfter.custom,n))return(0,y.insertEmptyBlock)(e,"afterend"),n.preventDefault(),n.stopPropagation(),!0;if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,n))return(0,y.jumpToParentNext)(e,V),n.preventDefault(),n.stopPropagation(),!0;if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.moveToUp.custom,n)){let t;n.preventDefault(),n.stopPropagation();let i=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(0===i.length){let e=(0,r.getTopAloneElement)(V);const t=(0,o.hasClosestByAttribute)(e,"fold","1");t&&(e=t),(null===(B=e.previousElementSibling)||void 0===B?void 0:B.classList.contains("protyle-action"))&&(e=(0,r.getTopAloneElement)(e.parentElement)),i=[e]}const a=i[0].getAttribute("data-type");if("NodeListItem"===a&&!i[0].previousElementSibling&&(null===(N=null===($=i[0].parentElement.previousElementSibling)||void 0===$?void 0:$.previousElementSibling)||void 0===N?void 0:N.classList.contains("protyle-action"))&&((null===(D=i[0].parentElement.parentElement.previousElementSibling)||void 0===D?void 0:D.classList.contains("li"))&&(t=i[0].parentElement.parentElement.previousElementSibling.querySelector(".list")),!t))return;if("NodeList"===a&&(null===(O=null===(P=i[0].previousElementSibling)||void 0===P?void 0:P.previousElementSibling)||void 0===O?void 0:O.classList.contains("protyle-action"))&&((null===(R=i[0].parentElement.previousElementSibling)||void 0===R?void 0:R.classList.contains("li"))&&(t=i[0].parentElement.previousElementSibling.querySelector(".list")),!t))return;if(t){t=t.lastElementChild.previousElementSibling;const n=i[0].classList.contains("list")?i[0]:i[0].parentElement;Z.insertNode(document.createElement("wbr"));const a=t.parentElement.parentElement.parentElement.outerHTML;return i.reverse().forEach((e=>{e.classList.contains("list")?t.after(e.firstElementChild):t.after(e)})),1===n.childElementCount?n.remove():"o"===n.getAttribute("data-subtype")&&n.classList.contains("list")&&(0,g.updateListOrder)(n,1),"o"===t.getAttribute("data-subtype")&&(0,g.updateListOrder)(t.parentElement),(0,p.updateTransaction)(e,t.parentElement.parentElement.parentElement.getAttribute("data-node-id"),t.parentElement.parentElement.parentElement.outerHTML,a),(0,_.preventScroll)(e),(0,x.scrollCenter)(e),void(0,s.focusByWbr)(t.parentElement,Z)}if(!i[0].previousElementSibling||(null===(q=i[0].previousElementSibling)||void 0===q?void 0:q.classList.contains("protyle-action")))return;if(t=i[0].previousElementSibling,"o"===i[0].getAttribute("data-subtype")&&"NodeListItem"===a){const n=i[0].parentElement.outerHTML;i[i.length-1].after(t),(0,g.updateListOrder)(i[0].parentElement,1),(0,p.updateTransaction)(e,i[0].parentElement.getAttribute("data-node-id"),i[0].parentElement.outerHTML,n)}else{const n=t.getAttribute("data-node-id");(0,p.transaction)(e,[{action:"move",id:n,previousID:i[i.length-1].getAttribute("data-node-id")}],[{action:"move",id:n,previousID:null===(j=t.previousElementSibling)||void 0===j?void 0:j.getAttribute("data-node-id"),parentID:t.parentElement.getAttribute("data-node-id")||e.block.parentID}]),i[i.length-1].after(t)}return(0,_.preventScroll)(e),void(0,x.scrollCenter)(e)}if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.moveToDown.custom,n)){let t;n.preventDefault(),n.stopPropagation();let i=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(0===i.length){let e=(0,r.getTopAloneElement)(V);const t=(0,o.hasClosestByAttribute)(e,"fold","1");t&&(e=t),(null===(F=e.previousElementSibling)||void 0===F?void 0:F.classList.contains("protyle-action"))&&(e=(0,r.getTopAloneElement)(e.parentElement)),i=[e]}const a=i[0].getAttribute("data-type");if("NodeListItem"===a&&i[i.length-1].nextElementSibling.classList.contains("protyle-attr")&&(null===(W=i[0].parentElement.parentElement)||void 0===W?void 0:W.classList.contains("li"))&&((null===(U=i[0].parentElement.parentElement.nextElementSibling)||void 0===U?void 0:U.classList.contains("li"))&&(t=i[0].parentElement.parentElement.nextElementSibling.querySelector(".list > .li")),!t))return;if("NodeList"===a&&i[i.length-1].nextElementSibling.classList.contains("protyle-attr")&&(null===(Y=i[0].parentElement)||void 0===Y?void 0:Y.classList.contains("li"))&&((null===(z=i[0].parentElement.nextElementSibling)||void 0===z?void 0:z.classList.contains("li"))&&(t=i[0].parentElement.nextElementSibling.querySelector(".list > .li")),!t))return;if(t){const n=i[0].classList.contains("list")?i[0]:i[0].parentElement;Z.insertNode(document.createElement("wbr"));const a=t.parentElement.parentElement.parentElement.outerHTML;return i.forEach((e=>{e.classList.contains("list")?t.before(e.firstElementChild):t.before(e)})),1===n.childElementCount?n.remove():"o"===n.getAttribute("data-subtype")&&n.classList.contains("list")&&(0,g.updateListOrder)(n,1),"o"===t.getAttribute("data-subtype")&&(0,g.updateListOrder)(t.parentElement,1),(0,p.updateTransaction)(e,t.parentElement.parentElement.parentElement.getAttribute("data-node-id"),t.parentElement.parentElement.parentElement.outerHTML,a),(0,_.preventScroll)(e),(0,x.scrollCenter)(e),void(0,s.focusByWbr)(t.parentElement,Z)}if(!i[i.length-1].nextElementSibling||(null===(G=i[i.length-1].nextElementSibling)||void 0===G?void 0:G.classList.contains("protyle-attr")))return;if(t=i[i.length-1].nextElementSibling,"o"===t.getAttribute("data-subtype")&&"NodeListItem"===t.getAttribute("data-type")){const n=t.parentElement.outerHTML;i[0].before(t),(0,g.updateListOrder)(t.parentElement,1),(0,p.updateTransaction)(e,t.parentElement.getAttribute("data-node-id"),t.parentElement.outerHTML,n)}else{const n=t.getAttribute("data-node-id");(0,p.transaction)(e,[{action:"move",id:n,previousID:null===(K=i[0].previousElementSibling)||void 0===K?void 0:K.getAttribute("data-node-id"),parentID:t.parentElement.getAttribute("data-node-id")||e.block.parentID}],[{action:"move",id:n,previousID:i[i.length-1].getAttribute("data-node-id")}]),i[0].before(t)}return(0,_.preventScroll)(e),void(0,x.scrollCenter)(e)}if((0,r.isNotEditBlock)(V)&&"NodeHTMLBlock"!==V.getAttribute("data-type")&&(0,d.matchHotKey)("⌘C",n)){let t="";e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach((e=>{t+=(0,h.removeEmbed)(e)})),(0,a.writeText)(e.lute.BlockDOM2StdMd(t).trimEnd())}if((0,r.isNotEditBlock)(V)&&(0,d.matchHotKey)("⌘X",n)){let t="";V.classList.add("protyle-wysiwyg--select");const i=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");i.forEach((e=>{t+=(0,h.removeEmbed)(e)})),(0,a.writeText)(e.lute.BlockDOM2StdMd(t).trimEnd());const o=(0,r.getNextBlock)(i[i.length-1]);(0,l.removeBlock)(e,V,Z),o&&(0,s.focusBlock)(o),n.preventDefault(),n.stopPropagation()}if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.copyPlainText.custom,n)){if(""===Z.toString()){const t=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let n="";0===t.length&&t.push(V),t.forEach((e=>{e.querySelectorAll('[contenteditable="true"]').forEach((e=>{const t=e.cloneNode(!0);t.querySelectorAll('[data-type="backslash"]').forEach((e=>{e.firstElementChild.remove()})),n+=t.textContent+"\n"}))})),(0,a.writeText)(n.trimEnd())}else{const e=Z.cloneContents();e.querySelectorAll('[data-type="backslash"]').forEach((e=>{e.firstElementChild.remove()})),(0,a.writeText)(e.textContent)}return n.preventDefault(),void n.stopPropagation()}if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.vLayout.custom,n)){n.preventDefault(),n.stopPropagation();const t=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(t.length<2)return;(0,p.turnsIntoOneTransaction)({protyle:e,selectsElement:t,type:"BlocksMergeSuperBlock",level:"row"})}else if((0,d.matchHotKey)(window.siyuan.config.keymap.editor.general.hLayout.custom,n)){n.preventDefault(),n.stopPropagation();const t=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(t.length<2)return;(0,p.turnsIntoOneTransaction)({protyle:e,selectsElement:t,type:"BlocksMergeSuperBlock",level:"col"})}else{if("Tab"===n.key&&!n.ctrlKey&&!(0,a.isCtrl)(n)&&!n.altKey){n.preventDefault();const t=0===window.siyuan.config.editor.codeTabSpaces?"\t":"".padStart(window.siyuan.config.editor.codeTabSpaces," ");if("NodeCodeBlock"===V.getAttribute("data-type")&&""!==X){const i=document.createElement("wbr");Z.insertNode(i),Z.setStartAfter(i);const a=V.outerHTML;let s="";n.shiftKey?Z.extractContents().textContent.split("\n").forEach((e=>{e.startsWith(t)?s+=e.replace(t,"")+"\n":s+=e+"\n"})):Z.extractContents().textContent.split("\n").forEach((e=>{s+=t+e+"\n"}));const o=document.createElement("span");let l=V.querySelector(".protyle-action__language").textContent;return hljs.getLanguage(l)||(l="plaintext"),o.innerHTML=hljs.highlight(s.substr(0,s.length-1),{language:l,ignoreIllegals:!0}).value,Z.insertNode(o),(0,p.updateTransaction)(e,V.getAttribute("data-node-id"),V.outerHTML,a),void i.remove()}if(!n.shiftKey){const n=document.createElement("wbr");Z.insertNode(n);const i=V.outerHTML;return Z.extractContents(),Z.insertNode(document.createTextNode(t)),Z.collapse(!1),(0,s.focusByRange)(Z),n.remove(),(0,p.updateTransaction)(e,V.getAttribute("data-node-id"),V.outerHTML,i),!0}}(0,a.isCtrl)(n)||"Backspace"===n.key||"Escape"===n.key||"Delete"===n.key||n.shiftKey||n.altKey||"Enter"===n.key||(0,i.hideElements)(["select"],e)}}))}},9407:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.listOutdent=t.breakList=t.listIndent=t.genListItemElement=t.updateListOrder=void 0;const i=n(2386),a=n(1985),s=n(3053),o=n(5680),l=n(8438);t.updateListOrder=(e,t)=>{if("o"!==e.getAttribute("data-subtype"))return;let n;Array.from(e.children).forEach(((e,i)=>{0===i?t?(n=t,e.setAttribute("data-marker",n+"."),e.querySelector(".protyle-action--order").textContent=n+"."):n=parseInt(e.getAttribute("data-marker")):e.classList.contains("li")&&(n++,e.setAttribute("data-marker",n+"."),e.querySelector(".protyle-action--order").textContent=n+".")}))};t.genListItemElement=(e,t=0,n=!1)=>{const i=document.createElement("template"),a=e.getAttribute("data-subtype");if("o"===a){const o=parseInt(e.getAttribute("data-marker"))+t;i.innerHTML=`<div data-marker="${o+1}." data-subtype="${a}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div contenteditable="false" class="protyle-action protyle-action--order" draggable="true">${o+1}.</div>${(0,s.genEmptyBlock)(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`}else i.innerHTML="t"===a?`<div data-marker="*" data-subtype="${a}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>${(0,s.genEmptyBlock)(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`:`<div data-marker="*" data-subtype="${a}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${(0,s.genEmptyBlock)(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`;return i.content.firstElementChild};t.listIndent=(e,n,s)=>{const o=n[0].previousElementSibling;if(!o)return;s.collapse(!1),s.insertNode(document.createElement("wbr")),n.forEach((e=>{e.classList.remove("protyle-wysiwyg--select")}));const l=o.parentElement.outerHTML;if("NodeList"===o.lastElementChild.previousElementSibling.getAttribute("data-type")){const i=o.lastElementChild.previousElementSibling.outerHTML,s=[],l=[],r=o.lastElementChild.previousElementSibling.getAttribute("data-subtype");let d=o.lastElementChild.previousElementSibling.lastElementChild.previousElementSibling.getAttribute("data-node-id");n.forEach(((e,t)=>{s.push({action:"move",id:e.getAttribute("data-node-id"),previousID:d}),l.push({action:"move",id:e.getAttribute("data-node-id"),previousID:0===t?o.getAttribute("data-node-id"):d}),d=e.getAttribute("data-node-id"),e.setAttribute("data-subtype",r);const n=e.querySelector(".protyle-action");"o"===r?(n.classList.add("protyle-action--order"),n.classList.remove("protyle-action--task"),o.lastElementChild.previousElementSibling.lastElementChild.before(e)):"t"===r?(e.setAttribute("data-marker","*"),n.innerHTML='<svg><use xlink:href="#iconUncheck"></use></svg>',n.classList.remove("protyle-action--order"),n.classList.add("protyle-action--task"),o.lastElementChild.previousElementSibling.lastElementChild.before(e)):(e.setAttribute("data-marker","*"),n.innerHTML='<svg><use xlink:href="#iconDot"></use></svg>',n.classList.remove("protyle-action--order","protyle-action--task"),o.lastElementChild.previousElementSibling.lastElementChild.before(e))})),"o"===r?((0,t.updateListOrder)(o.lastElementChild.previousElementSibling),(0,t.updateListOrder)(o.parentElement)):"o"===o.getAttribute("data-subtype")&&(0,t.updateListOrder)(o.parentElement),o.parentElement.classList.contains("protyle-wysiwyg")&&(s.push({action:"update",data:o.lastElementChild.previousElementSibling.outerHTML,id:o.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),l.push({action:"update",data:i,id:o.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),(0,a.transaction)(e,s,l))}else{const i=o.outerHTML,s=n[0].getAttribute("data-subtype"),l=document.createElement("div"),r=Lute.NewNodeID();l.setAttribute("data-node-id",r),l.setAttribute("data-type","NodeList"),l.setAttribute("class","list"),l.setAttribute("data-subtype",s),l.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';const d=[{action:"insert",data:l.outerHTML,id:r,previousID:o.lastElementChild.previousElementSibling.getAttribute("data-node-id")}];o.lastElementChild.before(l);const c=[];let u;n.forEach(((e,t)=>{d.push({action:"move",id:e.getAttribute("data-node-id"),parentID:r,previousID:u}),c.push({action:"move",id:e.getAttribute("data-node-id"),previousID:0===t?o.getAttribute("data-node-id"):u}),u=e.getAttribute("data-node-id"),l.lastElementChild.before(e)})),c.push({action:"delete",id:r}),"o"===s&&((0,t.updateListOrder)(l,1),(0,t.updateListOrder)(o.parentElement)),o.parentElement.classList.contains("protyle-wysiwyg")&&(d.push({action:"update",data:o.outerHTML,id:o.getAttribute("data-node-id")}),c.push({action:"update",data:i,id:o.getAttribute("data-node-id")}),(0,a.transaction)(e,d,c))}o.parentElement.classList.contains("protyle-wysiwyg")||(0,a.updateTransaction)(e,o.parentElement.getAttribute("data-node-id"),o.parentElement.outerHTML,l),(0,i.focusByWbr)(o,s)};t.breakList=(e,t,n)=>{var s,r;const d=t.parentElement,c=d.getAttribute("data-node-id"),u=[],p=[];n.insertNode(document.createElement("wbr"));const m=Lute.NewNodeID();let g="",b=0;Array.from(d.parentElement.children).forEach((e=>{!b&&e.isSameNode(d)?b=1:b&&!e.classList.contains("protyle-attr")&&(p.push({id:e.getAttribute("data-node-id"),action:"move",previousID:c}),u.push({id:e.getAttribute("data-node-id"),action:"delete"}),"o"===e.getAttribute("data-subtype")&&(p.push({id:e.getAttribute("data-node-id"),action:"update",data:e.outerHTML}),e.setAttribute("data-marker",b+"."),e.firstElementChild.innerHTML=b+"."),g+=e.outerHTML,e.remove(),b++)})),p.reverse(),g=`<div data-subtype="${d.getAttribute("data-subtype")}" data-node-id="${m}" data-type="NodeList" class="list" updated="${o().format("YYYYMMDDHHmmss")}">${g}<div class="protyle-attr" contenteditable="false">${l.Constants.ZWSP}</div></div>`,d.parentElement.insertAdjacentHTML("afterend",g),u.push({id:m,action:"insert",previousID:d.parentElement.getAttribute("data-node-id"),data:g}),p.push({id:m,action:"delete"}),Array.from(d.children).reverse().forEach((e=>{e.classList.contains("protyle-action")||e.classList.contains("protyle-attr")||(u.push({id:e.getAttribute("data-node-id"),action:"move",previousID:d.parentElement.getAttribute("data-node-id")}),p.push({id:e.getAttribute("data-node-id"),action:"move",parentID:c}),d.parentElement.after(e))}));const y=d.parentElement.getAttribute("data-node-id");2===d.parentElement.childElementCount?(p.splice(0,0,{id:y,action:"insert",data:d.parentElement.outerHTML,previousID:null===(s=d.parentElement.previousElementSibling)||void 0===s?void 0:s.getAttribute("data-node-id"),parentID:d.parentElement.parentElement.getAttribute("data-node-id")||e.block.rootID}),d.parentElement.remove(),u.push({id:y,action:"delete"})):(p.splice(0,0,{id:c,action:"insert",data:d.outerHTML,previousID:null===(r=d.previousElementSibling)||void 0===r?void 0:r.getAttribute("data-node-id"),parentID:y}),d.remove(),u.push({id:c,action:"delete"})),(0,a.transaction)(e,u,p),(0,i.focusByWbr)(e.wysiwyg.element,n)};t.listOutdent=(e,n,s)=>{var o,l;const r=n[0].parentElement,d=r.getAttribute("data-node-id");if(!d)return;const c=r.parentElement;if(c.classList.contains("protyle-wysiwyg")||c.classList.contains("sb")||c.classList.contains("bq")){const l=[],u=[];let p;s.collapse(!1),s.insertNode(document.createElement("wbr")),n[0].previousElementSibling||"o"!==r.getAttribute("data-subtype")||(p=parseInt(n[0].getAttribute("data-marker")));let m=d,g=r;n.forEach((t=>{t.classList.remove("protyle-wysiwyg--select"),Array.from(t.children).forEach(((n,i)=>{const a=n.getAttribute("data-node-id");a&&(l.push({action:"move",id:a,previousID:m,parentID:c.getAttribute("data-node-id")||e.block.parentID}),u.push({action:"move",id:a,previousID:1===i?void 0:m,parentID:t.getAttribute("data-node-id"),data:n.contains(s.startContainer)?"focus":""}),m=a,g.after(n),g=n)}))}));const b=r.outerHTML;return n.forEach((e=>{e.remove()})),1===r.childElementCount?(l.push({action:"delete",id:d}),u.splice(0,0,{action:"insert",data:b,id:d,previousID:null===(o=r.previousElementSibling)||void 0===o?void 0:o.getAttribute("data-node-id"),parentID:c.getAttribute("data-node-id")||e.block.parentID}),r.remove()):("o"===r.getAttribute("data-subtype")&&(0,t.updateListOrder)(r,p),l.push({action:"update",id:d,data:r.outerHTML}),u.splice(0,0,{action:"update",id:d,data:b})),(0,a.transaction)(e,l,u),void(0,i.focusByWbr)(c,s)}if(2===r.childElementCount&&3===c.childElementCount){s.collapse(!1),s.insertNode(document.createElement("wbr"));const t=c.outerHTML;return n[0].firstElementChild.remove(),n[0].lastElementChild.remove(),r.outerHTML=n[0].innerHTML,(0,a.updateTransaction)(e,c.getAttribute("data-node-id"),c.outerHTML,t),void(0,i.focusByWbr)(c,s)}s.collapse(!1),s.insertNode(document.createElement("wbr"));const u=[],p=[],m=null===(l=n[0].previousElementSibling)||void 0===l?void 0:l.getAttribute("data-node-id");let g;n.forEach((e=>{e.classList.remove("protyle-wysiwyg--select")})),n[0].previousElementSibling||"o"!==r.getAttribute("data-subtype")||(g=parseInt(n[0].getAttribute("data-marker")));const b=c.parentElement.outerHTML;n.reverse().forEach((e=>{const t=e.getAttribute("data-node-id");u.push({action:"move",id:t,previousID:c.getAttribute("data-node-id")}),p.push({action:"move",id:t,previousID:m,parentID:r.getAttribute("data-node-id")}),c.after(e),"o"!==e.getAttribute("data-subtype")&&"t"!==e.getAttribute("data-subtype")||"u"!==c.getAttribute("data-subtype")?"u"!==e.getAttribute("data-subtype")&&"t"!==e.getAttribute("data-subtype")||"o"!==c.getAttribute("data-subtype")?"u"!==e.getAttribute("data-subtype")&&"0"!==e.getAttribute("data-subtype")||"t"!==c.getAttribute("data-subtype")||(p.push({action:"update",id:t,data:e.outerHTML}),e.querySelector(".protyle-action").outerHTML='<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>',e.setAttribute("data-subtype","t"),e.setAttribute("data-marker","*"),u.push({action:"update",id:t,data:e.outerHTML})):(p.push({action:"update",id:t,data:e.outerHTML}),e.querySelector(".protyle-action").outerHTML='<div contenteditable="false" draggable="true" class="protyle-action protyle-action--order">1.</div>',e.setAttribute("data-subtype","o"),e.setAttribute("data-marker","1."),u.push({action:"update",id:t,data:e.outerHTML})):(p.push({action:"update",id:t,data:e.outerHTML}),e.querySelector(".protyle-action").outerHTML='<div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>',e.setAttribute("data-subtype","u"),e.setAttribute("data-marker","*"),u.push({action:"update",id:t,data:e.outerHTML}))})),1===r.childElementCount?(u.push({action:"delete",id:r.getAttribute("data-node-id")}),p.splice(0,0,{action:"insert",id:r.getAttribute("data-node-id"),data:r.outerHTML,previousID:r.previousElementSibling.getAttribute("data-node-id")}),r.remove()):"o"===r.getAttribute("data-subtype")&&(p.splice(0,0,{action:"update",data:r.outerHTML,id:r.getAttribute("data-node-id")}),(0,t.updateListOrder)(r,g),u.push({action:"update",data:r.outerHTML,id:r.getAttribute("data-node-id")})),c.parentElement.classList.contains("protyle-wysiwyg")?(0,a.transaction)(e,u,p):("o"===c.getAttribute("data-subtype")&&(0,t.updateListOrder)(c.parentElement),(0,a.updateTransaction)(e,c.parentElement.getAttribute("data-node-id"),c.parentElement.outerHTML,b)),(0,i.focusByWbr)(c.parentElement,s)}},5967:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.removeBlock=void 0;const i=n(2386),a=n(3903),s=n(1985),o=n(3053),l=n(9407),r=n(6112),d=n(5788),c=n(5615),u=n(8438);t.removeBlock=(e,n,p)=>{var m,g,b,y,f,h;(0,d.preventScroll)(e);const w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if((null==w?void 0:w.length)>0){const t=[],n=[];let d,m,g=w[0].previousElementSibling||w[w.length-1].nextElementSibling;if(w.find((i=>{i.classList.remove("protyle-wysiwyg--select");const s=(0,a.getTopAloneElement)(i);m=s.parentElement;const o=s.getAttribute("data-node-id");if(t.push({action:"delete",id:o}),g=(0,a.getPreviousBlock)(s)||(0,a.getNextBlock)(s)||s.parentElement||e.wysiwyg.element.firstElementChild,"NodeHeading"===s.getAttribute("data-type")&&"1"===s.getAttribute("fold")){(0,r.setFold)(e,s,void 0,!0),n.push({action:"insert",data:s.outerHTML,id:o,previousID:w[0].previousElementSibling?w[0].previousElementSibling.getAttribute("data-node-id"):"",parentID:s.parentElement.getAttribute("data-node-id")||e.block.parentID}),s.firstElementChild.removeAttribute("contenteditable");const t=s.nextElementSibling;if(t){const e=t.getAttribute("data-type");if("NodeHeading"!==e||"NodeHeading"===e&&t.getAttribute("data-subtype")>s.getAttribute("data-subtype"))return!0}}else n.push({action:"insert",data:e.lute.SpinBlockDOM(s.outerHTML),id:o,previousID:s.previousElementSibling?s.previousElementSibling.getAttribute("data-node-id"):"",parentID:s.parentElement.getAttribute("data-node-id")||e.block.parentID}),d="o"===s.getAttribute("data-subtype")&&s.classList.contains("li")?s.parentElement:void 0,s.remove()})),g)if(e.block.showAll&&g.classList.contains("protyle-wysiwyg")&&0===e.wysiwyg.element.childElementCount)setTimeout((()=>{(0,r.zoomOut)(e,e.block.parent2ID,e.block.parent2ID)}),2*u.Constants.TIMEOUT_INPUT+100);else{if(g.classList.contains("protyle-wysiwyg")&&0===e.wysiwyg.element.childElementCount){const a=Lute.NewNodeID(),s=(0,o.genEmptyElement)(!1,!0,a);g.insertAdjacentElement("afterbegin",s),t.push({action:"insert",data:s.outerHTML,id:a,parentID:g.getAttribute("data-node-id")||e.block.parentID}),n.push({action:"delete",id:a}),g=void 0,(0,i.focusByWbr)(s,p)}(0,i.focusBlock)(g,void 0,!1),d&&(n.push({action:"update",id:d.getAttribute("data-node-id"),data:d.outerHTML}),(0,l.updateListOrder)(d,1),t.push({action:"update",id:d.getAttribute("data-node-id"),data:d.outerHTML}))}if(t.length>0)if(m&&"NodeSuperBlock"===m.getAttribute("data-type")&&2===m.childElementCount){const i=(0,o.cancelSB)(e,m);(0,s.transaction)(e,t.concat(i.doOperations),i.undoOperations.concat(n.reverse()))}else(0,s.transaction)(e,t,n.reverse());return void(0,c.hideElements)(["util"],e)}if("NodeCodeBlock"===n.getAttribute("data-type")&&""===(0,a.getContenteditableElement)(n).textContent.trim())return n.classList.add("protyle-wysiwyg--select"),void(0,t.removeBlock)(e,n,p);if("NodeCodeBlock"===n.getAttribute("data-type")||"NodeTable"===n.getAttribute("data-type"))return void(n.previousElementSibling&&(0,i.focusBlock)(n.previousElementSibling,void 0,!1));if("NodeHeading"===n.getAttribute("data-type")){const t=n.getAttribute("data-node-id"),l=(0,o.genEmptyElement)(!1,!1,t);"1"===n.getAttribute("fold")&&(0,r.setFold)(e,n),(0,a.getContenteditableElement)(l).innerHTML="<wbr>"+(0,a.getContenteditableElement)(n).textContent;const d=n.outerHTML;return n.parentElement.replaceChild(l,n),(0,s.updateTransaction)(e,t,l.outerHTML,d),void(0,i.focusByWbr)(l,p)}if(!n.previousElementSibling&&"NodeBlockquote"===n.parentElement.getAttribute("data-type")){p.insertNode(document.createElement("wbr"));const t=n.parentElement;return t.insertAdjacentElement("beforebegin",n),1===t.childElementCount?((0,s.transaction)(e,[{action:"move",id:n.getAttribute("data-node-id"),previousID:null===(m=n.previousElementSibling)||void 0===m?void 0:m.getAttribute("data-node-id"),parentID:t.parentElement.getAttribute("data-node-id")||e.block.parentID},{action:"delete",id:t.getAttribute("data-node-id")}],[{action:"insert",id:t.getAttribute("data-node-id"),data:t.outerHTML,previousID:null===(g=n.previousElementSibling)||void 0===g?void 0:g.getAttribute("data-node-id"),parentID:t.parentElement.getAttribute("data-node-id")||e.block.parentID},{action:"move",id:n.getAttribute("data-node-id"),parentID:t.getAttribute("data-node-id")}]),t.remove()):(0,s.transaction)(e,[{action:"move",id:n.getAttribute("data-node-id"),previousID:null===(b=n.previousElementSibling)||void 0===b?void 0:b.getAttribute("data-node-id"),parentID:t.parentElement.getAttribute("data-node-id")||e.block.parentID}],[{action:"move",id:n.getAttribute("data-node-id"),parentID:t.getAttribute("data-node-id")}]),void(0,i.focusByWbr)(n,p)}if(n.parentElement.classList.contains("li")&&n.previousElementSibling.classList.contains("protyle-action"))return void((e,t,n)=>{if(!t.parentElement.previousElementSibling&&t.parentElement.nextElementSibling&&t.parentElement.nextElementSibling.classList.contains("protyle-attr"))return void(0,l.listOutdent)(e,[t.parentElement],n);if(!t.parentElement.previousElementSibling&&t.parentElement.parentElement.parentElement.classList.contains("list")){n.insertNode(document.createElement("wbr"));const a=t.parentElement.parentElement,o=a.outerHTML,r=t.parentElement.parentElement.previousElementSibling.lastElementChild,d=r.parentElement.outerHTML;return t.parentElement.firstElementChild.remove(),t.parentElement.lastElementChild.remove(),r.insertAdjacentHTML("beforebegin",t.parentElement.innerHTML),t.parentElement.remove(),"o"===a.getAttribute("data-subtype")&&(0,l.updateListOrder)(a),(0,s.transaction)(e,[{action:"update",id:a.getAttribute("data-node-id"),data:a.outerHTML},{action:"update",data:r.parentElement.outerHTML,id:r.parentElement.getAttribute("data-node-id")}],[{action:"update",data:d,id:r.parentElement.getAttribute("data-node-id")},{action:"update",data:o,id:a.getAttribute("data-node-id")}]),void(0,i.focusByWbr)(r.parentElement,n)}if(!t.parentElement.previousElementSibling){if(t.parentElement.parentElement.classList.contains("protyle-wysiwyg"))return;n.insertNode(document.createElement("wbr"));const a=t.parentElement.parentElement,o=a.outerHTML;t.parentElement.firstElementChild.remove(),t.parentElement.lastElementChild.remove();const r=document.createElement("div");r.innerHTML=t.parentElement.innerHTML;const d=[],c=[];return Array.from(r.children).forEach(((t,n)=>{var i;d.push({action:"insert",id:t.getAttribute("data-node-id"),data:t.outerHTML,previousID:0===n?null===(i=a.previousElementSibling)||void 0===i?void 0:i.getAttribute("data-node-id"):d[n-1].id,parentID:a.parentElement.getAttribute("data-node-id")||e.block.parentID}),c.push({action:"delete",id:t.getAttribute("data-node-id")})})),a.insertAdjacentHTML("beforebegin",t.parentElement.innerHTML),t.parentElement.remove(),"o"===a.getAttribute("data-subtype")&&(0,l.updateListOrder)(a,parseInt(a.firstElementChild.getAttribute("data-marker"))-1),d.splice(0,0,{action:"update",id:a.getAttribute("data-node-id"),data:a.outerHTML}),c.push({action:"update",data:o,id:a.getAttribute("data-node-id")}),(0,s.transaction)(e,d,c),void(0,i.focusByWbr)(e.wysiwyg.element,n)}const o=t.parentElement,r=o.getAttribute("data-node-id"),d=o.parentElement;n.insertNode(document.createElement("wbr"));const c=d.outerHTML,u=[],p=[{action:"insert",id:r,data:"",previousID:o.previousElementSibling.getAttribute("data-node-id")}],m=o.previousElementSibling.lastElementChild;if("1"===o.previousElementSibling.getAttribute("fold")){if(""!==(0,a.getContenteditableElement)(t).textContent.trim())return n.selectNodeContents((0,a.getContenteditableElement)(o.previousElementSibling)),void n.collapse(!1);u.push({action:"delete",id:r}),p[0].data=o.outerHTML,n.selectNodeContents((0,a.getContenteditableElement)(o.previousElementSibling)),n.collapse(!1),o.remove()}else{let e=m.previousElementSibling.getAttribute("data-node-id");Array.from(t.parentElement.children).forEach(((t,n)=>{if(t.classList.contains("protyle-action")||t.classList.contains("protyle-attr"))return;const i=t.getAttribute("data-node-id");u.push({action:"move",id:i,previousID:e}),p.push({action:"move",id:i,previousID:1===n?void 0:e,parentID:r}),e=i,m.before(t)})),u.push({action:"delete",id:r}),p[0].data=o.outerHTML,o.remove()}d.classList.contains("protyle-wysiwyg")?(0,s.transaction)(e,u,p):("o"===d.getAttribute("data-subtype")&&(0,l.updateListOrder)(d),(0,s.updateTransaction)(e,d.getAttribute("data-node-id"),d.outerHTML,c)),(0,i.focusByWbr)(m.parentElement,n)})(e,n,p);const v=(0,a.getPreviousBlock)(n);if(!v){if(e.wysiwyg.element.childElementCount>1&&""===(0,a.getContenteditableElement)(n).textContent){(0,i.focusBlock)(e.wysiwyg.element.firstElementChild.nextElementSibling);const t=(0,a.getTopAloneElement)(n);(0,s.transaction)(e,[{action:"delete",id:t.getAttribute("data-node-id")}],[{action:"insert",data:t.outerHTML,id:t.getAttribute("data-node-id"),parentID:e.block.parentID}]),t.remove()}return}const _=n.parentElement,E=(0,a.getContenteditableElement)(n),k=(0,a.getLastBlock)(v),C=k&&(k.classList.contains("table")||k.classList.contains("render-node")||k.classList.contains("iframe")||k.classList.contains("hr")||k.classList.contains("code-block")),x=k.getAttribute("data-node-id");if(C){if(k.classList.contains("code-block")){if(""===E.textContent.trim()){const t=n.getAttribute("data-node-id"),a=[{action:"delete",id:t}],l=[{action:"insert",data:n.outerHTML,id:t,previousID:null===(y=n.previousElementSibling)||void 0===y?void 0:y.getAttribute("data-node-id"),parentID:n.parentElement.getAttribute("data-node-id")}];if(n.remove(),"NodeSuperBlock"===_.getAttribute("data-type")&&2===_.childElementCount){const t=(0,o.cancelSB)(e,_);(0,s.transaction)(e,a.concat(t.doOperations),t.undoOperations.concat(l))}else(0,s.transaction)(e,a,l);(0,i.focusBlock)(e.wysiwyg.element.querySelector(`[data-node-id="${x}"]`),void 0,!1)}else(0,i.focusBlock)(k,void 0,!1);return}if(""!==E.textContent)return void(0,i.focusBlock)(k,void 0,!1)}const L=(0,a.getTopEmptyElement)(n),S=L.getAttribute("data-node-id");p.insertNode(document.createElement("wbr"));const T=[{action:"update",data:k.outerHTML,id:x},{action:"insert",data:L.outerHTML,id:S,previousID:null===(f=n.previousElementSibling)||void 0===f?void 0:f.getAttribute("data-node-id"),parentID:_.getAttribute("data-node-id")}],A=[{action:"delete",id:S}];if(C)L.remove(),(0,i.focusBlock)(k,void 0,!1);else{const t=(0,a.getContenteditableElement)(k);if(E&&""!==E.textContent&&(p.setEndAfter(E.lastChild),(null===(h=null==t?void 0:t.lastElementChild)||void 0===h?void 0:h.getAttribute("data-type").indexOf("inline-math"))>-1)){const e=(0,a.hasNextSibling)(null==t?void 0:t.lastElementChild);e&&"\n"===e.textContent&&e.remove()}const n=e.contentElement.scrollTop,i=p.extractContents();p.selectNodeContents(t),p.collapse(!1),p.insertNode(i),L.remove(),e.contentElement.scrollTop=n,e.scroll.lastScrollTop=n-1,A.push({action:"update",data:k.outerHTML,id:x})}if("NodeSuperBlock"===_.getAttribute("data-type")&&2===_.childElementCount){const t=(0,o.cancelSB)(e,_);(0,s.transaction)(e,A.concat(t.doOperations),t.undoOperations.concat(T))}else(0,s.transaction)(e,A,T);(0,i.focusByWbr)(e.wysiwyg.element,p)}},133:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.removeEmbed=void 0;t.removeEmbed=(e,t="outerHTML")=>{if(!e.querySelector("[data-type='block-render']"))return e[t];const n=e.cloneNode(!0);return n.querySelectorAll("span[data-render='1'][data-type='block-render']").forEach((e=>{e.innerHTML="",e.setAttribute("data-render","2")})),n[t]}},1985:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateBatchTransaction=t.updateTransaction=t.transaction=t.turnsIntoTransaction=t.turnsIntoOneTransaction=t.onTransaction=t.promiseTransactions=void 0;const i=n(7683),a=n(2386),s=n(3903),o=n(8438),l=n(4383),r=n(6259),d=n(1456),c=n(7821),u=n(4933),p=n(6112),m=n(7994),g=n(1040),b=n(7406),y=n(3053),f=n(5615),h=(e,n)=>{const i=(0,s.getTopAloneElement)(e),a=[];if(i.isSameNode(e)||(e.remove(),a.push({action:"delete",id:i.getAttribute("data-node-id")})),i.remove(),n.block.rootID===n.block.id&&0===n.wysiwyg.element.childElementCount){const e=Lute.NewNodeID(),t=(0,y.genEmptyElement)(!1,!1,e);a.push({action:"insert",data:t.outerHTML,id:e,parentID:n.block.parentID}),n.wysiwyg.element.innerHTML=t.outerHTML}a.length>0&&(0,t.transaction)(n,a,[])},w=()=>{const e=window.siyuan.transactions[0].protyle,n=window.siyuan.transactions[0].doOperations,s=window.siyuan.transactions[0].undoOperations;window.siyuan.transactions.splice(0,1),(0,i.fetchPost)("/api/transactions",{session:e.id,app:o.Constants.SIYUAN_APPID,transactions:[{doOperations:n,undoOperations:s}]},(s=>{if(0===window.siyuan.transactions.length?(0,t.promiseTransactions)():w(),1!==s.code)if(1!==n.length||"unfoldHeading"!==n[0].action&&"foldHeading"!==n[0].action&&"setAttrs"!==n[0].action)n.forEach((t=>"update"===t.action?(v(e,t),void E(e,t.id)):"delete"===t.action||"append"===t.action?(e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach((n=>{n.querySelector(`[data-node-id="${t.id}"]`)&&(n.removeAttribute("data-render"),(0,l.blockRender)(e,n))})),void e.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${t.id}"]`).forEach((e=>{"d"===e.getAttribute("data-subtype")&&(e.textContent="block not found")}))):void("move"!==t.action?E(e,t.id):e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach((n=>{n.querySelector(`[data-node-id="${t.id}"]`)&&(n.removeAttribute("data-render"),(0,l.blockRender)(e,n))})))));else{const t=e.gutter.element.querySelector('[data-type="fold"]');if(t&&t.removeAttribute("disabled"),"unfoldHeading"===n[0].action){const t=e.contentElement.scrollTop;e.wysiwyg.element.querySelectorAll(`[data-node-id="${n[0].id}"]`).forEach((t=>{if(t.lastElementChild.classList.contains("protyle-attr")||t.lastElementChild.remove(),_(s.data[0].doOperations[0].retData,e),t.insertAdjacentHTML("afterend",s.data[0].doOperations[0].retData),"remove"===n[0].data){const e=getSelection();e.rangeCount>0&&t.contains(e.getRangeAt(0).startContainer)&&(0,a.focusBlock)(t.nextElementSibling,void 0,!0),t.remove()}})),(0,r.processRender)(e.wysiwyg.element),(0,d.highlightRender)(e.wysiwyg.element),(0,l.blockRender)(e,e.wysiwyg.element),e.contentElement.scrollTop=t,e.scroll.lastScrollTop=t}else"foldHeading"===n[0].action&&("true"===e.wysiwyg.element.lastElementChild.getAttribute("data-eof")||e.scroll.element.classList.contains("fn__none")||(0,i.fetchPost)("/api/filetree/getDoc",{id:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,k:e.options.key||"",size:o.Constants.SIZE_GET},(t=>{(0,g.onGet)(t,e,[o.Constants.CB_GET_APPEND,o.Constants.CB_GET_UNCHANGEID])})))}else(0,u.lockFile)(e.block.rootID)}))},v=(e,t)=>{let n=!1;e.wysiwyg.element.querySelectorAll(`[data-type="NodeBlockQueryEmbed"] [data-node-id="${t.id}"]`).forEach((e=>{const i=document.createElement("div");i.innerHTML=t.data,i.querySelectorAll('[contenteditable="true"]').forEach((e=>{e.setAttribute("contenteditable","false")}));const a=i.querySelector("wbr");a&&a.remove(),e.outerHTML=i.innerHTML,n=!0})),n&&((0,r.processRender)(e.wysiwyg.element),(0,d.highlightRender)(e.wysiwyg.element))};t.promiseTransactions=()=>{window.siyuan.transactionsTimeout=window.setInterval((()=>{0!==window.siyuan.transactions.length&&(window.clearInterval(window.siyuan.transactionsTimeout),w())}),2*o.Constants.TIMEOUT_INPUT)};t.onTransaction=(e,t,n)=>{var s,u;let p;if(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).find((e=>{if(!(0,c.hasClosestByAttribute)(e.parentElement,"data-type","NodeBlockQueryEmbed"))return p=e,!0})),"setAttrs"!==t.action){if("unfoldHeading"===t.action){const n=e.contentElement.scrollTop;return e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach((n=>{t.retData&&(_(t.retData,e),n.insertAdjacentHTML("afterend",t.retData)),n.removeAttribute("fold"),"remove"===t.data&&n.remove()})),void(t.retData&&((0,r.processRender)(e.wysiwyg.element),(0,d.highlightRender)(e.wysiwyg.element),(0,l.blockRender)(e,e.wysiwyg.element),e.contentElement.scrollTop=n,e.scroll.lastScrollTop=n))}if("foldHeading"===t.action)return e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach((e=>{e.setAttribute("fold","1"),t.retData||(0,b.removeFoldHeading)(e)})),void(t.retData&&t.retData.forEach((t=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${t}"]`).forEach((e=>{e.remove()}))})));if("delete"===t.action)return p&&(n&&(0,a.focusSideBlock)(p),p.remove()),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach((n=>{n.querySelector(`[data-node-id="${t.id}"]`)&&(n.removeAttribute("data-render"),(0,l.blockRender)(e,n))})),void e.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${t.id}"]`).forEach((e=>{"d"===e.getAttribute("data-subtype")&&(e.textContent="block not found")}));if("update"===t.action){if(p){p.outerHTML=t.data,Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).find((e=>{if("NodeBlockQueryEmbed"===e.getAttribute("data-type")||!(0,c.hasClosestByAttribute)(e,"data-type","NodeBlockQueryEmbed"))return p=e,!0}));const i=p.querySelector("wbr");if(n){const e=(0,a.getEditorRange)(p);i?(0,a.focusByWbr)(p,e):(0,a.focusBlock)(p)}else i&&i.remove();(0,r.processRender)(p),(0,d.highlightRender)(p),(0,l.blockRender)(e,p)}return v(e,t),void E(e,t.id)}if("updateAttrs"!==t.action){if("move"===t.action){let i,o;if(n&&getSelection().rangeCount>0&&(o=getSelection().getRangeAt(0),i={startContainer:o.startContainer,startOffset:o.startOffset,endContainer:o.endContainer,endOffset:o.endOffset}),t.previousID){let n;Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.previousID}"]`)).find((e=>{if(!(0,c.hasClosestByAttribute)(e.parentElement,"data-type","NodeBlockQueryEmbed"))return n=e,!0})),n&&p?n.after(p):p&&p.parentElement&&h(p,e)}else{let n;Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.parentID}"]`)).find((e=>{if(!(0,c.hasClosestByAttribute)(e.parentElement,"data-type","NodeBlockQueryEmbed"))return n=e,!0})),n&&p?(null===(s=n.firstElementChild)||void 0===s?void 0:s.classList.contains("protyle-action"))?n.firstElementChild.after(p):n.prepend(p):t.parentID===e.block.parentID&&p?e.wysiwyg.element.prepend(p):p&&p.parentElement&&h(p,e)}return n&&i&&o&&("focus"===t.data?(0,a.focusBlock)(p):(o.setStart(i.startContainer,i.startOffset),o.setEnd(i.endContainer,i.endOffset),(0,a.focusByRange)(o))),void e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach((n=>{n.querySelector(`[data-node-id="${t.id}"]`)&&(n.removeAttribute("data-render"),(0,l.blockRender)(e,n))}))}if("insert"===t.action){let i;if(t.previousID){let n;Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.previousID}"]`)).find((t=>{const i=(0,c.hasClosestByAttribute)(t.parentElement,"data-type","NodeBlockQueryEmbed");if(!i)return n=t,!0;i.removeAttribute("data-render"),(0,l.blockRender)(e,i)})),n&&(n.insertAdjacentHTML("afterend",t.data),i=n.nextElementSibling)}else{let n;Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.parentID}"]`)).find((e=>{if(!(0,c.hasClosestByAttribute)(e.parentElement,"data-type","NodeBlockQueryEmbed"))return n=e,!0})),n?(null===(u=n.firstElementChild)||void 0===u?void 0:u.classList.contains("protyle-action"))?(n.firstElementChild.insertAdjacentHTML("afterend",t.data),i=n.firstElementChild.nextElementSibling):(n.insertAdjacentHTML("afterbegin",t.data),i=n.firstElementChild):t.parentID===e.block.parentID&&(e.wysiwyg.element.insertAdjacentHTML("afterbegin",t.data),i=e.wysiwyg.element.firstElementChild)}if(!i)return;(0,r.processRender)(i),(0,d.highlightRender)(i),(0,l.blockRender)(e,i),e.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach((e=>{"1"===e.lastElementChild.getAttribute("spin")&&e.lastElementChild.remove()}));const s=i.querySelector("wbr");if(n){const e=(0,a.getEditorRange)(i);s?(0,a.focusByWbr)(i,e):(0,a.focusBlock)(i)}else s&&s.remove();return e.wysiwyg.element.querySelectorAll(`[data-type="NodeBlockQueryEmbed"][data-node-id="${t.id}"]`).forEach((t=>{t.removeAttribute("data-render"),(0,l.blockRender)(e,t)})),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach((n=>{n.querySelector(`[data-node-id="${t.id}"]`)&&(n.removeAttribute("data-render"),(0,l.blockRender)(e,n))})),void E(e,t.id)}"append"===t.action&&((0,m.addLoading)(e),(0,i.fetchPost)("/api/filetree/getDoc",{id:e.block.id,mode:0,size:o.Constants.SIZE_GET},(t=>{(0,g.onGet)(t,e)})))}else{let n="";const i=t.data,a={};if(Object.keys(i.new).forEach((e=>{a[e]=i.new[e];const t=i.new[e];"bookmark"===e?n+=`<div class="protyle-attr--bookmark">${t}</div>`:"name"===e?n+=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${t}</div>`:"alias"===e?n+=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${t}</div>`:"memo"===e&&(n+=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${t}"><svg><use xlink:href="#iconM"></use></svg></div>`)})),e.block.rootID===t.id){const t=e.title.element.querySelector(".protyle-attr--refcount");return t&&(n+=t.outerHTML),e.title.element.querySelector(".protyle-attr").innerHTML=n,void e.wysiwyg.renderCustom(a)}e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach((e=>{Object.keys(i.old).forEach((t=>{e.removeAttribute(t)})),Object.keys(i.new).forEach((t=>{e.setAttribute(t,i.new[t])}));const t=e.lastElementChild.querySelector(".protyle-attr--refcount");t&&(n+=t.outerHTML),e.lastElementChild.innerHTML=n+o.Constants.ZWSP}))}}else e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach((e=>{"1"===JSON.parse(t.data).fold?e.setAttribute("fold","1"):e.removeAttribute("fold")}))};t.turnsIntoOneTransaction=e=>{let n;const i=Lute.NewNodeID();if("BlocksMergeSuperBlock"===e.type)n=(0,y.genSBElement)(e.level,i);else if("Blocks2Blockquote"===e.type)n=document.createElement("div"),n.classList.add("bq"),n.setAttribute("data-node-id",i),n.setAttribute("data-type","NodeBlockquote"),n.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';else if(e.type.endsWith("Ls")){n=document.createElement("div"),n.classList.add("list"),n.setAttribute("data-node-id",i),n.setAttribute("data-type","NodeList"),"Blocks2ULs"===e.type?n.setAttribute("data-subtype","u"):"Blocks2OLs"===e.type?n.setAttribute("data-subtype","o"):n.setAttribute("data-subtype","t");let t="";e.selectsElement.forEach(((n,i)=>{"Blocks2ULs"===e.type?t+=`<div data-marker="*" data-subtype="u" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`:"Blocks2OLs"===e.type?t+=`<div data-marker="${i+1}." data-subtype="o" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--order" contenteditable="false" draggable="true">${i+1}.</div><div class="protyle-attr" contenteditable="false"></div></div>`:t+=`<div data-marker="*" data-subtype="t" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`})),n.innerHTML=t+'<div class="protyle-attr" contenteditable="false"></div>'}const s=e.selectsElement[0].previousElementSibling?e.selectsElement[0].previousElementSibling.getAttribute("data-node-id"):void 0,o=e.selectsElement[0].parentElement.getAttribute("data-node-id")||e.protyle.block.parentID,l=[{action:"insert",id:i,data:n.outerHTML,previousID:s,parentID:o}],r=[];let d;e.selectsElement[0].previousElementSibling?e.selectsElement[0].before(n):e.selectsElement[0].parentElement.prepend(n),e.selectsElement.forEach(((t,a)=>{t.classList.remove("protyle-wysiwyg--select");const c=t.getAttribute("data-node-id");r.push({action:"move",id:c,previousID:d||s,parentID:o}),e.type.endsWith("Ls")?(l.push({action:"move",id:c,parentID:n.children[a].getAttribute("data-node-id")}),n.children[a].firstElementChild.after(t)):(l.push({action:"move",id:c,previousID:d,parentID:i}),n.lastElementChild.before(t)),d=t.getAttribute("data-node-id"),a===e.selectsElement.length-1&&r.push({action:"delete",id:i})})),(0,t.transaction)(e.protyle,l,r),(0,a.focusBlock)(e.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.selectsElement[0].getAttribute("data-node-id")}"]`)),(0,f.hideElements)(["gutter"],e.protyle)};const _=(e,t)=>{const n=document.createElement("template");n.innerHTML=e,Array.from(n.content.children).forEach((e=>{var n;null===(n=t.wysiwyg.element.querySelector(`:scope > [data-node-id="${e.getAttribute("data-node-id")}"]`))||void 0===n||n.remove()}))};t.turnsIntoTransaction=e=>{let n,i=e.selectsElement;if(e.nodeElement){n=getSelection().getRangeAt(0),n.insertNode(document.createElement("wbr")),i=Array.from(e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),0===i.length&&(i=[e.nodeElement]);let t=!1,a=!1,s=!1;if(i.find(((e,n)=>{if(e.classList.contains("li"))return s=!0,!0;if((e.classList.contains("bq")||e.classList.contains("sb")||e.classList.contains("p"))&&(a=!0),e.nextElementSibling&&i[n+1]&&e.nextElementSibling.isSameNode(i[n+1]))t=!0;else if(n!==i.length-1)return t=!1,!0})),s||a&&"Blocks2Ps"===e.type)return;1===i.length&&"Blocks2Hs"===e.type&&"NodeHeading"===i[0].getAttribute("data-type")&&e.level===parseInt(i[0].getAttribute("data-subtype").substr(1))&&(e.type="Blocks2Ps"),e.isContinue=t}let s="";const o=[],c=[];i.forEach(((t,n)=>{"Blocks2Ps"!==e.type&&"Blocks2Hs"!==e.type||"NodeHeading"!==t.getAttribute("data-type")||"1"!==t.getAttribute("fold")||(0,p.setFold)(e.protyle,t),t.classList.remove("protyle-wysiwyg--select"),s+=t.outerHTML;const a=t.getAttribute("data-node-id");if(c.push({action:"update",id:a,data:t.outerHTML}),"Blocks2Ps"!==e.type&&"Blocks2Hs"!==e.type||e.isContinue)if(n===i.length-1){const n=document.createElement("div");n.innerHTML=e.protyle.lute[e.type](s,e.level),t.outerHTML=n.innerHTML}else t.remove();else t.outerHTML=e.protyle.lute[e.type](t.outerHTML,e.level)})),c.forEach((t=>{const n=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${t.id}"]`);o.push({action:"update",id:t.id,data:n.outerHTML})})),(0,t.transaction)(e.protyle,o,c),(0,r.processRender)(e.protyle.wysiwyg.element),(0,d.highlightRender)(e.protyle.wysiwyg.element),(0,l.blockRender)(e.protyle,e.protyle.wysiwyg.element),n?(0,a.focusByWbr)(e.protyle.wysiwyg.element,n):(0,a.focusBlock)(e.protyle.wysiwyg.element.querySelector(`[data-node-id="${i[0].getAttribute("data-node-id")}"]`)),(0,f.hideElements)(["gutter"],e.protyle)};const E=(e,t,n=0)=>{n>6||e.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${t}"]`).forEach((a=>{"d"===a.getAttribute("data-subtype")&&(0,i.fetchPost)("/api/block/getRefText",{id:t},(t=>{a.innerHTML=t.data;const i=(0,c.hasClosestBlock)(a);i&&E(e,i.getAttribute("data-node-id"),n+1)}))}))};t.transaction=(e,t,n)=>{const i=window.siyuan.transactions[window.siyuan.transactions.length-1];let a=!1;const s=(new Date).getTime();i&&1===i.doOperations.length&&"update"===i.doOperations[0].action&&1===t.length&&"update"===t[0].action&&i.doOperations[0].id===t[0].id&&e.transactionTime-s<o.Constants.TIMEOUT_INPUT&&(a=!0),e.wysiwyg.lastHTMLs={},n&&(window.siyuan.config.fileTree.openFilesUseCurrentTab&&e.model&&e.model.headElement.classList.remove("item--unupdate"),e.updated=!0,a?e.undo.replace(t):e.undo.add(t,n)),a?(window.siyuan.transactions[window.siyuan.transactions.length-1].protyle=e,window.siyuan.transactions[window.siyuan.transactions.length-1].doOperations=t):window.siyuan.transactions.push({protyle:e,doOperations:t,undoOperations:n}),e.transactionTime=s};t.updateTransaction=(e,n,i,a)=>{i!==a&&(0,t.transaction)(e,[{id:n,data:i,action:"update"}],[{id:n,data:a,action:"update"}])};t.updateBatchTransaction=(e,n,i)=>{const a=[],s=[];e.forEach((e=>{const t=e.getAttribute("data-node-id");e.classList.remove("protyle-wysiwyg--select"),s.push({action:"update",id:t,data:e.outerHTML}),i(e),a.push({action:"update",id:t,data:e.outerHTML})})),(0,t.transaction)(n,a,s)}},3680:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.syncGuide=t.getSyncCloudList=t.bindSyncCloudListEvent=t.addCloudName=void 0;const i=n(7541),a=n(7491),s=n(7683),o=n(3163),l=n(2041),r=n(6400),d=n(5095);t.addCloudName=e=>{const n=new o.Dialog({title:window.siyuan.languages.cloudSyncDir,content:`<div class="b3-dialog__content">\n    <input class="b3-text-field fn__block" value="main">\n    <div class="b3-label__text">${window.siyuan.languages.reposTip}</div>\n</div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>\n</div>`,width:(0,r.isMobile)()?"80vw":"520px"}),i=n.element.querySelector("input"),a=n.element.querySelectorAll(".b3-button");n.bindInput(i,(()=>{a[1].click()})),i.focus(),i.select(),a[0].addEventListener("click",(()=>{n.destroy()})),a[1].addEventListener("click",(()=>{e.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',(0,s.fetchPost)("/api/sync/createCloudSyncDir",{name:i.value},(()=>{n.destroy(),(0,t.getSyncCloudList)(e,!0)}))}))};t.bindSyncCloudListEvent=e=>{e.addEventListener("click",(n=>{let i=n.target;for(;i&&!i.isEqualNode(e);){const a=i.getAttribute("data-type");if(a){switch(a){case"addCloud":(0,t.addCloudName)(e);break;case"removeCloud":(0,l.confirmDialog)(window.siyuan.languages.confirm,`${window.siyuan.languages.confirmDeleteCloudDir} <i>${i.parentElement.getAttribute("data-name")}</i>`,(()=>{e.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',(0,s.fetchPost)("/api/sync/removeCloudSyncDir",{name:i.parentElement.getAttribute("data-name")},(n=>{window.siyuan.config.sync.cloudName=n.data,(0,t.getSyncCloudList)(e,!0)}))}));break;case"selectCloud":e.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',(0,s.fetchPost)("/api/sync/setCloudSyncDir",{name:i.getAttribute("data-name")},(()=>{window.siyuan.config.sync.cloudName=i.getAttribute("data-name"),(0,t.getSyncCloudList)(e,!0)}))}n.preventDefault(),n.stopPropagation();break}i=i.parentElement}}))};t.getSyncCloudList=(e,t=!1,n)=>{(t||"IMG"===e.firstElementChild.tagName)&&(0,s.fetchPost)("/api/sync/listCloudSyncDir",{},(t=>{let i=`<div class="fn__hr"></div><ul><li style="padding: 0 16px" class="b3-list--empty">${window.siyuan.languages.emptyCloudSyncList}</li></ul>`;1===t.code?i=`<div class="fn__hr"></div><ul><li style="padding: 0 16px" class="b3-list--empty ft__error">${t.msg}</li></ul>`:1!==t.code&&(i='<div class="fn__hr"></div><ul class="b3-list b3-list--background fn__flex-1" style="overflow: auto;">',t.data.syncDirs.forEach((e=>{i+=`<li data-type="selectCloud" data-name="${e.cloudName}" class="b3-list-item${(0,r.isMobile)()?"":" b3-list-item--hide-action"}">\n<input type="radio" name="cloudName"${e.cloudName===t.data.checkedSyncDir?" checked":""}/>\n<span class="fn__space"></span>\n<span>${e.cloudName}</span>\n<span class="fn__space"></span>\n<span class="ft__on-surface">${e.hSize}</span>\n<span class="b3-list-item__meta${(0,r.isMobile)()?" fn__none":""}">${e.updated}</span>\n<span class="fn__flex-1 fn__space"></span>\n<span data-type="removeCloud" class="b3-tooltips b3-tooltips__w b3-list-item__action" aria-label="${window.siyuan.languages.delete}">\n    <svg><use xlink:href="#iconTrashcan"></use></svg>\n</span></li>`})),i+=`</ul>\n<div class="fn__hr"></div>\n<div class="fn__flex">\n    <div class="fn__flex-1"></div>\n    <button class="b3-button b3-button--outline" data-type="addCloud"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}</button>\n</div>`),e.innerHTML=i,n&&n()}))};t.syncGuide=e=>{if(!e||!e.classList.contains("toolbar__item--active")){if((0,r.isMobile)()){if((0,i.needSubscribe)())return}else if((0,i.needSubscribe)("")){const e=new o.Dialog({title:window.siyuan.languages.account,content:`<div class="account" style="background-color: var(--b3-theme-background)">${d.account.genHTML()}</div>`,width:"80vw"});return void d.account.bindEvent(e.element.querySelector(".account"))}window.siyuan.config.repo.key?window.siyuan.config.sync.enabled?(0,s.fetchPost)("/api/sync/performSync",{}):c():u()}};const c=(e,n)=>{if(e&&(window.siyuan.config.repo.key=e),window.siyuan.config.sync.enabled)n&&n.destroy(),(0,l.confirmDialog)(window.siyuan.languages.syncConfGuide4,window.siyuan.languages.syncConfGuide5,(()=>{(0,s.fetchPost)("/api/sync/performSync",{})}));else{const e=`<div class="b3-dialog__content">\n    <div class="ft__on-surface">${window.siyuan.languages.syncConfGuide3}</div>\n    <div style="display: flex;flex-direction: column;height: 40vh;">\n        <img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">\n    </div>\n</div>\n<div class="b3-dialog__action">\n    <button class="b3-button" disabled="disabled">${window.siyuan.languages.openSyncTip1}</button>\n</div>`;n?(n.element.querySelector(".b3-dialog__header").innerHTML=window.siyuan.languages.cloudSyncDir,n.element.querySelector(".b3-dialog__container").lastElementChild.innerHTML=e):n=new o.Dialog({title:window.siyuan.languages.cloudSyncDir,content:e,width:(0,r.isMobile)()?"80vw":"520px"});const i=n.element.querySelector(".b3-dialog__content").lastElementChild;(0,t.bindSyncCloudListEvent)(i);const d=n.element.querySelector(".b3-button");(0,t.getSyncCloudList)(i,!1,(()=>{i.querySelector("input[checked]")?d.removeAttribute("disabled"):d.setAttribute("disabled","disabled")})),d.addEventListener("click",(()=>{n.destroy(),(0,s.fetchPost)("/api/sync/setSyncEnable",{enabled:!0},(e=>{1===e.code?(0,a.showMessage)(e.msg):(window.siyuan.config.sync.enabled=!0,(0,l.confirmDialog)(window.siyuan.languages.syncConfGuide4,window.siyuan.languages.syncConfGuide5,(()=>{(0,s.fetchPost)("/api/sync/performSync",{})})))}))}))}},u=()=>{const e=new o.Dialog({title:window.siyuan.languages.syncConfGuide1,content:`<div class="b3-dialog__content ft__center">\n    <img style="width: 260px" src="/stage/images/sync-guide.svg"/>\n    <div class="fn__hr--b"></div>\n    <div class="ft__on-surface">${window.siyuan.languages.syncConfGuide2}</div>\n     <div class="fn__hr--b"></div>\n    <input class="b3-text-field fn__block ft__center" placeholder="${window.siyuan.languages.passphrase}">\n    <div class="fn__hr"></div>\n    <button class="b3-button fn__block" id="initKeyByPW">\n        <svg><use xlink:href="#iconHand"></use></svg>${window.siyuan.languages.genKeyByPW}\n    </button>\n</div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>\n</div>`,width:(0,r.isMobile)()?"80vw":"520px"});e.element.querySelector(".b3-button--cancel").addEventListener("click",(()=>{e.destroy()}));const t=e.element.querySelector(".b3-text-field");e.element.querySelector("#initKeyByPW").addEventListener("click",(()=>{t.value?(0,l.confirmDialog)("🔑 "+window.siyuan.languages.genKeyByPW,window.siyuan.languages.initRepoKeyTip,(()=>{(0,s.fetchPost)("/api/repo/InitRepoKeyFromPassphrase",{pass:t.value},(t=>{c(t.data.key,e)}))})):(0,a.showMessage)(window.siyuan.languages._kernel[142])})),t.focus()}},3456:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Tree=void 0;const i=n(8059),a=n(7821),s=n(6400),o=n(2224),l=n(6810),r=n(8438);t.Tree=class{constructor(e){this.click=e.click,this.ctrlClick=e.ctrlClick,this.altClick=e.altClick,this.shiftClick=e.shiftClick,this.rightClick=e.rightClick,this.element=e.element,this.blockExtHTML=e.blockExtHTML,this.topExtHTML=e.topExtHTML,this.updateData(e.data),this.bindEvent()}updateData(e){this.data=e,this.data&&0!==this.data.length?(this.element.innerHTML=this.genHTML(this.data),(0,o.mathRender)(this.element)):this.element.innerHTML=`<ul class="b3-list b3-list--background"><li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li></ul>`}genHTML(e){let t=`<ul${0===e[0].depth?" class='b3-list b3-list--background'":""}>`;return e.forEach((e=>{let n='<svg class="b3-list-item__graphic"><use xlink:href="#iconFolder"></use></svg>';"bookmark"===e.type?n='<svg class="b3-list-item__graphic"><use xlink:href="#iconBookmark"></use></svg>':"tag"===e.type?n='<svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg>':("backlink"===e.type||"outline"===e.type)&&(n=`<svg class="b3-list-item__graphic popover__block" data-id="${e.id}"><use xlink:href="#${(0,i.getIconByType)(e.nodeType,e.subType)}"></use></svg>`);let a="";e.count&&(a=`<span class="counter">${e.count}</span>`),t+=`<li class="b3-list-item" \n${"NodeDocument"!==e.nodeType&&"backlink"===e.type?'draggable="true"':""}\n${e.id?'data-node-id="'+e.id+'"':""} \ndata-treetype="${e.type}" \ndata-type="${e.nodeType}" \ndata-subtype="${e.subType}" \n${e.label?"data-label='"+e.label+"'":""}>\n    <span style="padding-left: ${16*e.depth}px" class="b3-list-item__toggle">\n        <svg data-id="${encodeURIComponent(e.name+e.depth)}" class="b3-list-item__arrow ${e.children&&e.children.length>0||e.blocks&&e.blocks.length>0?"b3-list-item__arrow--open":"fn__hidden"}"><use xlink:href="#iconRight"></use></svg>\n    </span>\n    ${n}\n    <span class="b3-list-item__text"${"outline"===e.type?' title="'+Lute.EscapeHTMLStr(Lute.BlockDOM2Content(e.name))+'"':""}>${e.name}</span>\n    ${a}\n    ${this.topExtHTML||""}\n</li>`,e.children&&e.children.length>0&&(t+=this.genHTML(e.children)+"</ul>"),e.blocks&&e.blocks.length>0&&(t+=this.genBlockHTML(e.blocks,!0,e.type)+"</ul>")})),t}genBlockHTML(e,t=!1,n){let a=`<ul class="${t?"":"fn__none"}">`;return e.forEach((e=>{let t,o="";e.count&&(o=`<span class="counter">${e.count}</span>`),t="NodeDocument"===e.type?`<span data-defids='["${e.defID}"]' class="b3-list-item__graphic popover__block" data-id="${e.id}">${(0,l.unicode2Emoji)(e.ial.icon||r.Constants.SIYUAN_IMAGE_FILE)}</span>`:`<svg data-defids='["${e.defID}"]' class="b3-list-item__graphic popover__block" data-id="${e.id}"><use xlink:href="#${(0,i.getIconByType)(e.type,e.subType)}"></use></svg>`,a+=`<li ${"backlink"===n?'draggable="true"':""} \nclass="b3-list-item ${(0,s.isMobile)()?"":"b3-list-item--hide-action"}"  \ndata-node-id="${e.id}" \ndata-ref-text="${encodeURIComponent(e.refText)}" \ndata-def-id="${e.defID}" \ndata-type="${e.type}" \ndata-subtype="${e.subType}" \ndata-treetype="${n}"\ndata-def-path="${e.defPath}">\n    <span style="padding-left: ${16*e.depth}px" class="b3-list-item__toggle">\n        <svg data-id="${e.id}" class="b3-list-item__arrow${e.children?"":" fn__hidden"}"><use xlink:href="#iconRight"></use></svg>\n    </span>\n    ${t}\n    <span class="b3-list-item__text" ${"outline"===n?' title="'+Lute.EscapeHTMLStr(Lute.BlockDOM2Content(e.content))+'"':""}>${e.content}</span>\n    ${o}\n    ${this.blockExtHTML||""}\n</li>`,e.children&&e.children.length>0&&(a+=this.genBlockHTML(e.children,!1,n)+"</ul>")})),a}toggleBlocks(e){if(!e.nextElementSibling)return;const t=e.firstElementChild.firstElementChild;t.classList.contains("b3-list-item__arrow--open")?(t.classList.remove("b3-list-item__arrow--open"),e.nextElementSibling.classList.add("fn__none"),e.nextElementSibling.nextElementSibling&&"UL"===e.nextElementSibling.nextElementSibling.tagName&&e.nextElementSibling.nextElementSibling.classList.add("fn__none")):(t.classList.add("b3-list-item__arrow--open"),e.nextElementSibling.classList.remove("fn__none"),e.nextElementSibling.nextElementSibling&&"UL"===e.nextElementSibling.nextElementSibling.tagName&&e.nextElementSibling.nextElementSibling.classList.remove("fn__none"))}setCurrent(e){e.classList.contains("b3-list--empty")||(this.element.querySelectorAll("li").forEach((e=>{e.classList.remove("b3-list-item--focus")})),e.classList.add("b3-list-item--focus"))}bindEvent(){this.element.addEventListener("contextmenu",(e=>{let t=e.target;for(;t&&!t.isEqualNode(this.element);){if("LI"===t.tagName&&this.rightClick){this.rightClick(t,e),e.preventDefault(),e.stopPropagation();break}t=t.parentElement}})),this.element.addEventListener("click",(e=>{let t=e.target;for(;t&&!t.isEqualNode(this.element);){if(t.classList.contains("b3-list-item__toggle")&&!t.firstElementChild.classList.contains("fn__hidden")){this.toggleBlocks(t.parentElement),this.setCurrent(t.parentElement),e.preventDefault();break}if(t.classList.contains("b3-list-item__action")&&this.click){const n=(0,a.hasClosestByMatchTag)(t,"LI");n&&this.click(n,e),e.preventDefault(),e.stopPropagation();break}if("LI"===t.tagName){this.setCurrent(t),t.getAttribute("data-node-id")||"tag"===t.getAttribute("data-treetype")?(this.ctrlClick&&window.siyuan.ctrlIsPressed?this.ctrlClick(t):this.altClick&&window.siyuan.altIsPressed?this.altClick(t):this.shiftClick&&window.siyuan.shiftIsPressed?this.shiftClick(t):this.click&&this.click(t,e),e.stopPropagation()):this.toggleBlocks(t),e.preventDefault();break}t=t.parentElement}})),this.element.addEventListener("dragstart",(e=>{const t=(0,a.hasClosestByTag)(e.target,"LI");t&&(e.dataTransfer.setData("text/html",t.outerHTML),t.style.opacity="0.1",window.siyuan.dragElement=t)})),this.element.addEventListener("dragend",(e=>{const t=(0,a.hasClosestByTag)(e.target,"LI");t&&(t.style.opacity="1"),window.siyuan.dragElement=void 0}))}expandAll(){this.element.querySelectorAll("ul").forEach((e=>{e.classList.contains("b3-list")||e.classList.remove("fn__none")})),this.element.querySelectorAll(".b3-list-item__arrow").forEach((e=>{e.classList.add("b3-list-item__arrow--open")}))}collapseAll(){this.element.querySelectorAll("ul").forEach((e=>{e.classList.contains("b3-list")||e.classList.add("fn__none")})),this.element.querySelectorAll(".b3-list-item__arrow").forEach((e=>{e.classList.remove("b3-list-item__arrow--open")}))}getExpandIds(){const e=[];return this.element.querySelectorAll(".b3-list-item__arrow--open").forEach((t=>{e.push(t.getAttribute("data-id"))})),e}setExpandIds(e){this.element.querySelectorAll(".b3-list-item__arrow").forEach((t=>{e.includes(t.getAttribute("data-id"))?(t.classList.add("b3-list-item__arrow--open"),t.parentElement.parentElement.nextElementSibling&&t.parentElement.parentElement.nextElementSibling.classList.remove("fn__none")):(t.classList.remove("b3-list-item__arrow--open"),t.parentElement.parentElement.nextElementSibling&&"UL"===t.parentElement.parentElement.nextElementSibling.tagName&&t.parentElement.parentElement.nextElementSibling.classList.add("fn__none"))}))}}},2738:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setInlineStyle=t.initAssets=t.loadAssets=void 0;const i=n(8438),a=n(9173),s=n(9632),o=n(3242),l=n(6400);t.loadAssets=e=>{const t=document.getElementById("themeDefaultStyle");let n=`/appearance/themes/${1===e.mode?"midnight":"daylight"}/${e.customCSS?"custom":"theme"}.css?v=${e.customCSS?(new Date).getTime():i.Constants.SIYUAN_VERSION}`;(1===e.mode&&"midnight"!==e.themeDark||0===e.mode&&"daylight"!==e.themeLight)&&(n=`/appearance/themes/${1===e.mode?"midnight":"daylight"}/theme.css?v=${i.Constants.SIYUAN_VERSION}`),t?t.getAttribute("href").startsWith(n)||(t.remove(),(0,s.addStyle)(n,"themeDefaultStyle")):(0,s.addStyle)(n,"themeDefaultStyle");const l=document.getElementById("themeStyle");if(1===e.mode&&"midnight"!==e.themeDark||0===e.mode&&"daylight"!==e.themeLight){const t=`/appearance/themes/${1===e.mode?e.themeDark:e.themeLight}/${e.customCSS?"custom":"theme"}.css?v=${e.customCSS?(new Date).getTime():e.themeVer}`;l?l.getAttribute("href").startsWith(t)||(l.remove(),(0,s.addStyle)(t,"themeStyle")):(0,s.addStyle)(t,"themeStyle")}else l&&l.remove();(0,o.setCodeTheme)();const r=document.getElementById("themeScript"),d=`/appearance/themes/${1===e.mode?e.themeDark:e.themeLight}/theme.js?v=${e.themeVer}`;r?r.getAttribute("src").startsWith(d)||(r.remove(),(0,a.addScript)(d,"themeScript")):(0,a.addScript)(d,"themeScript");const c=document.getElementById("iconScript"),u=`/appearance/icons/${e.icon}/icon.js?v=${e.iconVer}`;c?c.getAttribute("src").startsWith(u)||(c.remove(),(0,a.addScript)(u,"iconScript")):(0,a.addScript)(u,"iconScript")};t.initAssets=()=>{const e=document.getElementById("emojiScript"),t=document.getElementById("loading");e||window.siyuan.config.appearance.nativeEmoji||(0,l.isMobile)()?t&&setTimeout((()=>{t.remove()}),160):(0,a.addScript)("/appearance/emojis/twitter-emoji.js?v=1.0.0","emojiScript").then((()=>{t&&t.remove()}))};t.setInlineStyle=(e=!0)=>{const t=Math.floor(1.625*window.siyuan.config.editor.fontSize);let n=`.b3-typography, .protyle-wysiwyg, .protyle-title {font-size:${window.siyuan.config.editor.fontSize}px !important}\n.b3-typography code:not(.hljs), .protyle-wysiwyg code:not(.hljs) { font-variant-ligatures: ${window.siyuan.config.editor.codeLigatures?"normal":"none"} }\n.li > .protyle-action {height:${t+8}px;line-height: ${t+8}px}\n.protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h1, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h2, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h3, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h4, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h5, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h6 {line-height:${t+8}px;}\n.protyle-wysiwyg [data-node-id].li > .protyle-action:after {height: ${window.siyuan.config.editor.fontSize}px;width: ${window.siyuan.config.editor.fontSize}px;margin:-${window.siyuan.config.editor.fontSize/2}px 0 0 -${window.siyuan.config.editor.fontSize/2}px}\n.protyle-wysiwyg [data-node-id].li > .protyle-action svg {height: ${Math.max(14,window.siyuan.config.editor.fontSize-8)}px}\n.protyle-wysiwyg [data-node-id] [spellcheck="false"] {min-height:${t}px}\n.protyle-wysiwyg .li {min-height:${t+8}px}\n.protyle-gutters button svg {height:${t}px}\n.protyle-wysiwyg img.emoji, .b3-typography img.emoji {width:${t-8}px}\n.protyle-wysiwyg .h1 img.emoji, .b3-typography h1 img.emoji {width:${Math.floor(1.75*window.siyuan.config.editor.fontSize*1.25)}px}\n.protyle-wysiwyg .h2 img.emoji, .b3-typography h2 img.emoji {width:${Math.floor(1.55*window.siyuan.config.editor.fontSize*1.25)}px}\n.protyle-wysiwyg .h3 img.emoji, .b3-typography h3 img.emoji {width:${Math.floor(1.38*window.siyuan.config.editor.fontSize*1.25)}px}\n.protyle-wysiwyg .h4 img.emoji, .b3-typography h4 img.emoji {width:${Math.floor(1.25*window.siyuan.config.editor.fontSize*1.25)}px}\n.protyle-wysiwyg .h5 img.emoji, .b3-typography h5 img.emoji {width:${Math.floor(1.13*window.siyuan.config.editor.fontSize*1.25)}px}\n.protyle-wysiwyg .h6 img.emoji, .b3-typography h6 img.emoji {width:${Math.floor(1.25*window.siyuan.config.editor.fontSize)}px}`;return window.siyuan.config.editor.fontFamily&&(n+=`.b3-typography:not(.b3-typography--default), .protyle-wysiwyg, .protyle-title, .protyle-title__input{font-family: "${window.siyuan.config.editor.fontFamily}", "quote", "Helvetica Neue", "Luxi Sans", "DejaVu Sans", "Hiragino Sans GB", "Microsoft Yahei", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", "Segoe UI Symbol", "Android Emoji", "EmojiSymbols" !important;}`),e&&(document.getElementById("editorFontSize").innerHTML=n),n}},9755:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.escapeHtml=void 0;t.escapeHtml=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;")},7683:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,s){function o(e){try{r(i.next(e))}catch(e){s(e)}}function l(e){try{r(i.throw(e))}catch(e){s(e)}}function r(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,l)}r((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.fetchGet=t.fetchSyncPost=t.fetchPost=void 0;const a=n(6456),s=n(4933);t.fetchPost=(e,t,n,i)=>{const o={method:"POST"};t&&(["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph"].includes(e)&&(window.siyuan.reqIds[e]=(new Date).getTime(),t.reqId=window.siyuan.reqIds[e]),t instanceof FormData?o.body=t:o.body=JSON.stringify(t)),i&&(o.headers=i),fetch(e,o).then((e=>e.json())).then((t=>{["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph"].includes(e)&&t.data.reqId&&window.siyuan.reqIds[e]&&window.siyuan.reqIds[e]>t.data.reqId||(0,a.processMessage)(t)&&n&&n(t)})).catch((t=>{console.warn("fetch post error",t),"/api/transactions"!==e||"Failed to fetch"!==t.message&&"Unexpected end of JSON input"!==t.message||(0,s.kernelError)()}))};t.fetchSyncPost=(e,t)=>i(void 0,void 0,void 0,(function*(){const n={method:"POST"};t&&(n.body=JSON.stringify(t));const i=yield fetch(e,n),s=yield i.json();return(0,a.processMessage)(s),s}));t.fetchGet=(e,t)=>{fetch(e).then((e=>e.json())).then((e=>{t(e)}))}},6400:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isFileAnnotation=t.isDynamicRef=t.isBrowser=t.getSearch=t.getRandom=t.isArrayEqual=t.isMobile=void 0;t.isMobile=()=>!document.getElementById("dockBottom");t.isArrayEqual=(e,t)=>e.length===t.length&&e.every((e=>t.includes(e)));t.getRandom=(e,t)=>Math.floor(Math.random()*(t-e+1))+e;t.getSearch=(e,t=window.location.search)=>{if(-1===t.indexOf("?"))return"";let n="";return t.split("?")[1].split("&").find((t=>{const i=t.split("=");if(i[0]===e)return n=i[1],!0})),n};t.isBrowser=()=>!0;t.isDynamicRef=e=>/^\(\(\d{14}-\w{7} '.*'\)\)$/.test(e);t.isFileAnnotation=e=>/^<<assets\/.+\/\d{14}-\w{7} ".+">>$/.test(e)},4577:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.genUUID=void 0;t.genUUID=()=>([1e7].toString()+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(e=>(parseInt(e,10)^window.crypto.getRandomValues(new Uint32Array(1))[0]&15>>parseInt(e,10)/4).toString(16)))},5563:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.genOptions=void 0;t.genOptions=(e,t)=>{let n="";return e.forEach((e=>{n+="string"==typeof e?`<option value="${e}" ${t===e?"selected":""}>${e}</option>`:`<option value="${e.name}" ${t===e.name?"selected":""}>${e.label}</option>`})),n}},5449:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.scrollCenter=t.highlightById=void 0;const i=n(7821),a=n(2386),s=e=>{e.classList.add("protyle-wysiwyg--hl"),setTimeout((function(){e.classList.remove("protyle-wysiwyg--hl")}),1024)};t.highlightById=(e,n,a=!1)=>{let o;const l=e.wysiwyg.element;return e.preview.element.classList.contains("fn__none")?(Array.from(l.querySelectorAll(`[data-node-id="${n}"]`)).find((e=>{if(!(0,i.hasClosestByAttribute)(e,"data-type","block-render",!0))return o=e,!0})),o?((0,t.scrollCenter)(e,o,a),s(o),o):n===e.block.rootID&&e.options.render.title?(s(e.title.editElement),e.title.editElement):void 0):(o=document.getElementById(n),void(o&&(e.preview.element.scrollTop=o.offsetTop,s(o))))};t.scrollCenter=(e,t,n=!1)=>{if(!n&&getSelection().rangeCount>0&&(0,i.hasClosestBlock)(getSelection().getRangeAt(0).startContainer)){const t=e.contentElement,n=(0,a.getSelectionPosition)(t).top-t.getBoundingClientRect().top;return void(n<0?t.scrollTop=t.scrollTop+n:n>t.clientHeight-34&&(t.scrollTop=t.scrollTop+(n+34-t.clientHeight)))}if(t||(t=(0,i.hasClosestBlock)((0,a.getEditorRange)(e.wysiwyg.element).startContainer)),!t)return;let s=0,o=t;for(;!o.classList.contains("protyle-wysiwyg");)s+=o.offsetTop,o=o.parentElement;n||e.contentElement.scrollTop>s-32?e.contentElement.scrollTop=s-32:e.contentElement.scrollTop+e.contentElement.clientHeight<s+t.clientHeight-32&&(e.contentElement.scrollTop=s+t.clientHeight-32-e.contentElement.clientHeight)}},8896:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.openHistory=void 0;const i=n(3163),a=n(2041),s=n(7683),o=n(8438),l=n(9755),r=n(6400),d=n(7821),c=n(9140),u=n(4078),p=n(1040);let m;const g=(e,t)=>{const n=e.querySelector('[data-type="docprevious"]'),i=e.querySelector('[data-type="docnext"]');e.setAttribute("data-page",t.toString()),t>1?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled");const a=e.querySelector(".b3-text-field"),r=e.querySelector('.b3-select[data-type="opselect"]'),d=e.querySelector('.b3-select[data-type="typeselect"]'),c=e.querySelector('.b3-select[data-type="notebookselect"]');window.localStorage.setItem(o.Constants.LOCAL_HISTORYNOTEID,c.value);const u=e.querySelector('.history__text[data-type="docPanel"]'),p=e.querySelector('.history__text[data-type="assetPanel"]'),m=e.querySelector('.history__text[data-type="mdPanel"]');u.classList.add("fn__none"),m.classList.add("fn__none"),"0"===d.value?(r.removeAttribute("disabled"),c.removeAttribute("disabled"),p.classList.add("fn__none")):(r.setAttribute("disabled","disabled"),c.setAttribute("disabled","disabled"),p.classList.remove("fn__none")),(0,s.fetchPost)("/api/history/searchHistory",{notebook:c.value,query:a.value,page:t,op:r.value,type:parseInt(d.value)},(n=>{if(t<n.data.pageCount?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"),0===n.data.histories.length)return e.lastElementChild.lastElementChild.previousElementSibling.classList.add("fn__none"),e.lastElementChild.lastElementChild.classList.add("fn__none"),void(e.lastElementChild.firstElementChild.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`);let a="";n.data.histories.forEach(((e,t)=>{a+=`<li class="b3-list-item" data-type="toggle" style="padding-left: 0">\n    <span style="padding-left: 8px" class="b3-list-item__toggle"><svg class="b3-list-item__arrow${0===t?" b3-list-item__arrow--open":""}${e.items.length>0?"":" fn__hidden"}"><use xlink:href="#iconRight"></use></svg></span>\n    <span class="b3-list-item__text">${e.hCreated}</span>\n</li>`,e.items.length>0&&(a+=`<ul class="${0===t?"":"fn__none"}">`,e.items.forEach((e=>{a+=`<li title="${(0,l.escapeHtml)(e.title)}" data-type="${"1"===d.value?"assets":"doc"}" data-path="${e.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 32px">\n    <span class="b3-list-item__text">${(0,l.escapeHtml)(e.title)}</span>\n    <span class="fn__space"></span>\n    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">\n        <svg><use xlink:href="#iconUndo"></use></svg>\n    </span>\n</li>`})),a+="</ul>")})),e.lastElementChild.firstElementChild.innerHTML=a}))},b=(e,t,n)=>{if(0===e.data.snapshots.length)return void(t.lastElementChild.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`);let i="";"cloudTag"===n?i=`<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="downloadSnapshot" aria-label="${window.siyuan.languages.download}"><svg><use xlink:href="#iconDownload"></use></svg></span>\n<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="removeCloudRepoTagSnapshot" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>`:"localTag"===n?i=`<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="uploadSnapshot" aria-label="${window.siyuan.languages.upload}"><svg><use xlink:href="#iconUpload"></use></svg></span>\n<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}"><svg><use xlink:href="#iconUndo"></use></svg></span>\n<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="removeRepoTagSnapshot" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>`:"local"===n&&(i=`<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="genTag" aria-label="${window.siyuan.languages.tagSnapshot}"><svg><use xlink:href="#iconTags"></use></svg></span>\n<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}"><svg><use xlink:href="#iconUndo"></use></svg></span>`);let a="";e.data.snapshots.forEach((e=>{(0,r.isMobile)()?a+=`<li class="b3-list-item b3-list-item--two">\n    <div class="b3-list-item__first">\n        <span class="b3-list-item__text">${(0,l.escapeHtml)(e.memo)}</span>\n        <span class="b3-chip b3-chip--secondary${e.tag?"":" fn__none"}">${e.tag}</span>\n    </div>\n    <div>\n        <span class="ft__smaller ft__on-surface">${e.hCreated}</span>\n        <span class="b3-list-item__meta">${e.hSize}</span>\n        <span class="b3-list-item__meta">${window.siyuan.languages.fileCount}${e.count}</span>\n    </div>\n    <div class="fn__flex" style="justify-content: flex-end;" data-id="${e.id}" data-tag="${e.tag}">${i}</div>\n</li>`:a+=`<li class="b3-list-item b3-list-item--hide-action" data-id="${e.id}" data-tag="${e.tag}">\n    <div class="fn__flex-1">\n        <div class="b3-list-item__text">\n            ${(0,l.escapeHtml)(e.memo)}\n            <span class="b3-chip b3-chip--secondary${e.tag?"":" fn__none"}">${e.tag}</span>\n        </div>\n        <div>\n            <span class="ft__smaller ft__on-surface">${e.hCreated}</span>\n            <span class="b3-list-item__meta">${e.hSize}</span>\n            <span class="b3-list-item__meta">${window.siyuan.languages.fileCount}${e.count}</span>\n        </div>\n    </div>\n    ${i}\n</li>`})),t.lastElementChild.innerHTML=`${a}`},y=(e,t)=>{e.lastElementChild.innerHTML='<li style="position: relative;height: 100%;"><div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div></li>';const n=e.querySelector('[data-type="previous"]'),i=e.querySelector('[data-type="next"]');t<0?(-1===t&&(0,s.fetchPost)("/api/repo/getRepoTagSnapshots",{},(t=>{b(t,e,"localTag")})),-2===t&&(0,s.fetchPost)("/api/repo/getCloudRepoTagSnapshots",{},(t=>{b(t,e,"cloudTag")})),n.classList.add("fn__none"),i.classList.add("fn__none")):(n.classList.remove("fn__none"),i.classList.remove("fn__none"),e.setAttribute("data-init","true"),e.setAttribute("data-page",t.toString()),t>1?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled"),(0,s.fetchPost)("/api/repo/getRepoSnapshots",{page:t},(n=>{t<n.data.pageCount?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"),b(n,e,"local")})))};t.openHistory=()=>{if(window.siyuan.dialogs.find((e=>{if(e.element.querySelector("#historyContainer"))return e.destroy(),!0})))return;const e=localStorage.getItem(o.Constants.LOCAL_HISTORYNOTEID);let t="";window.siyuan.notebooks.forEach((n=>{n.closed||(t+=` <option value="${n.id}"${n.id===e?" selected":""}>${n.name}</option>`)}));const n=new i.Dialog({content:`<div class="fn__flex-column" style="height: 100%;">\n    <div class="layout-tab-bar fn__flex" style="border-radius: 4px 4px 0 0">\n        <div data-type="doc" class="item item--focus"><span class="item__text">${window.siyuan.languages.fileHistory}</span></div>\n        <div data-type="notebook" class="item"><span class="item__text">${window.siyuan.languages.removedNotebook}</span></div>\n        <div data-type="repo" class="item"><span class="item__text">${window.siyuan.languages.dataSnapshot}</span></div>\n    </div>\n    <div class="fn__flex-1 fn__flex" id="historyContainer">\n        <div data-type="doc" class="history__repo fn__block" data-init="true">\n            <div class="fn__flex history__repoheader">\n                <span data-type="docprevious" class="block__icon b3-tooltips b3-tooltips__se" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>\n                <span class="fn__space"></span>\n                <span data-type="docnext" class="block__icon b3-tooltips b3-tooltips__se" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>\n                <div class="fn__flex-1"></div>\n                <div style="position: relative">\n                    <svg class="b3-form__icon-icon ft__on-surface"><use xlink:href="#iconSearch"></use></svg>\n                    <input class="b3-text-field b3-form__icon-input">\n                </div>\n                <span class="fn__space"></span>\n                <select data-type="typeselect" class="b3-select" style="min-width: auto">\n                    <option value="0" selected>${window.siyuan.languages.doc}</option>\n                    <option value="1">${window.siyuan.languages.assets}</option>\n                </select>\n                <span class="fn__space"></span>\n                <select data-type="opselect" class="b3-select" style="min-width: auto">\n                    <option value="all" selected>${window.siyuan.languages.allOp}</option>\n                    <option value="clean">clean</option>\n                    <option value="update">update</option>\n                    <option value="delete">delete</option>\n                    <option value="format">format</option>\n                    <option value="sync">sync</option>\n                </select>\n                <span class="fn__space"></span>\n                <select data-type="notebookselect" class="b3-select" style="min-width: auto">\n                    ${t}\n                </select>\n                <span class="fn__space"></span>\n                <button data-type="rebuildIndex" class="b3-button b3-button--outline">${window.siyuan.languages.rebuildIndex}</button>\n            </div>\n            <div class="fn__flex fn__flex-1"${(0,r.isMobile)()?' style="flex-direction: column;"':""}>\n                <ul style="${(0,r.isMobile)()?"height: 30%":"width:200px"};overflow: auto;" class="b3-list b3-list--background">\n                    <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>\n                </ul>\n                <div class="fn__flex-1 history__text fn__none" data-type="assetPanel"></div>\n                <textarea class="fn__flex-1 history__text fn__none" data-type="mdPanel"></textarea>\n                <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>\n            </div>\n        </div>\n        <ul data-type="notebook" style="background-color: var(--b3-theme-background);border-radius: 0 0 4px 4px" class="fn__none b3-list b3-list--background">\n            <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>\n        </ul>\n        <div data-type="repo" class="fn__none history__repo">\n            <div class="fn__flex history__repoheader">\n                <span data-type="previous" class="block__icon b3-tooltips b3-tooltips__se" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>\n                <span class="fn__space"></span>\n                <span data-type="next" class="block__icon b3-tooltips b3-tooltips__se" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>\n                <div class="fn__flex-1"></div>\n                <select class="b3-select" style="min-width: auto">\n                    <option value="0">${window.siyuan.languages.localSnapshot}</option>\n                    <option value="1">${window.siyuan.languages.localTagSnapshot}</option>\n                    <option value="2">${window.siyuan.languages.cloudTagSnapshot}</option>\n                </select>\n                <span class="fn__space"></span>\n                <button class="b3-button b3-button--outline" data-type="genRepo">\n                    <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.createSnapshot}\n                </button>\n            </div>    \n            <ul style="background: var(--b3-theme-background);" class="b3-list b3-list--background fn__flex-1">\n                <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>\n            </ul>\n        </div>\n    </div>\n</div>`,width:"80vw",height:"80vh"}),b=n.element.querySelector("#historyContainer [data-type=doc]");b.querySelectorAll(".b3-select").forEach((e=>{e.addEventListener("change",(()=>{g(b,1)}))})),b.querySelector(".b3-text-field").addEventListener("input",(e=>{e.isComposing||g(b,1)})),b.querySelector(".b3-text-field").addEventListener("compositionend",(()=>{g(b,1)}));const f=b.querySelector('.history__text[data-type="docPanel"]'),h=b.querySelector('.history__text[data-type="assetPanel"]'),w=b.querySelector('.history__text[data-type="mdPanel"]');g(b,1),m=new u.default(f,{blockId:"",action:[o.Constants.CB_GET_HISTORY],render:{background:!1,title:!1,gutter:!1,scroll:!1,breadcrumb:!1,breadcrumbDocName:!1,breadcrumbContext:!1},typewriterMode:!1});const v=n.element.querySelector('#historyContainer [data-type="repo"]'),_=v.querySelector(".b3-select");_.addEventListener("change",(()=>{const e=_.value;"0"===e?y(v,1):"1"===e?y(v,-1):"2"===e&&y(v,-2)})),n.element.addEventListener("click",(e=>{let t=e.target;for(;t&&!t.isEqualNode(n.element);){const e=t.getAttribute("data-type");if(t.classList.contains("item")){t.parentElement.querySelector(".item--focus").classList.remove("item--focus"),Array.from(n.element.querySelector("#historyContainer").children).forEach((n=>{var i;n.getAttribute("data-type")===e?(n.classList.remove("fn__none"),n.classList.add("fn__block"),t.classList.add("item--focus"),"true"!==n.getAttribute("data-init")&&("notebook"===e?((i=n).setAttribute("data-init","true"),(0,s.fetchPost)("/api/history/getNotebookHistory",{},(e=>{if(0===e.data.histories.length)return void(i.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`);let t="";e.data.histories.forEach(((e,n)=>{t+=`<li class="b3-list-item" style="padding-left: 0" data-type="toggle">\n    <span style="padding-left: 8px" class="b3-list-item__toggle"><svg class="b3-list-item__arrow${0===n?" b3-list-item__arrow--open":""}${e.items.length>0?"":" fn__hidden"}"><use xlink:href="#iconRight"></use></svg></span>\n    <span class="b3-list-item__text">${e.hCreated}</span>\n</li>`,e.items.length>0&&(t+=`<ul class="${0===n?"":"fn__none"}">`,e.items.forEach((e=>{t+=`<li data-type="notebook" data-path="${e.path}" class="b3-list-item" style="padding-left: 32px">\n    <span class="b3-list-item__text">${(0,l.escapeHtml)(e.title)}</span>\n    <span class="fn__space"></span>\n    <span class="b3-list-item__action" data-type="rollback">\n        <svg><use xlink:href="#iconUndo"></use></svg><span class="fn__space"></span>${window.siyuan.languages.rollback}\n    </span>\n</li>`})),t+="</ul>")})),i.innerHTML=t}))):"repo"===e&&y(n,1))):(n.classList.add("fn__none"),n.classList.remove("fn__block"))}));break}if(t.classList.contains("b3-list-item__action")&&"rollback"===e&&!window.siyuan.config.readonly){(0,a.confirmDialog)("⚠️ "+window.siyuan.languages.rollback,`${window.siyuan.languages.rollbackConfirm.replace("${date}",t.parentElement.textContent.trim())}`,(()=>{const e=t.parentElement.getAttribute("data-type");"assets"===e?(0,s.fetchPost)("/api/history/rollbackAssetsHistory",{historyPath:t.parentElement.getAttribute("data-path")}):"doc"===e?(0,s.fetchPost)("/api/history/rollbackDocHistory",{notebook:b.querySelector('.b3-select[data-type="notebookselect"]').value,historyPath:t.parentElement.getAttribute("data-path")}):"notebook"===e?(0,s.fetchPost)("/api/history/rollbackNotebookHistory",{historyPath:t.parentElement.getAttribute("data-path")}):(0,s.fetchPost)("/api/repo/checkoutRepo",{id:t.parentElement.getAttribute("data-id")})}));break}if("toggle"===e){t.nextElementSibling.classList.toggle("fn__none"),t.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open");break}if(t.classList.contains("b3-list-item")&&("assets"===e||"doc"===e)){const n=t.getAttribute("data-path");"assets"===e?h.innerHTML=(0,c.renderAssetsPreview)(n):"doc"===e&&(0,s.fetchPost)("/api/history/getDocHistoryContent",{historyPath:n,k:b.querySelector(".b3-text-field").value},(e=>{e.data.isLargeDoc?(w.value=e.data.content,w.classList.remove("fn__none"),f.classList.add("fn__none")):(w.classList.add("fn__none"),f.classList.remove("fn__none"),(0,p.onGet)(e,m.protyle,[o.Constants.CB_GET_HISTORY,o.Constants.CB_GET_HTML]))}));let i=(0,d.hasClosestByClassName)(t,"b3-list");i&&(i=i.querySelector(".b3-list-item--focus"),i&&i.classList.remove("b3-list-item--focus")),t.classList.add("b3-list-item--focus");break}if("genRepo"===e){const e=new i.Dialog({title:window.siyuan.languages.snapshotMemo,content:`<div class="b3-dialog__content">\n    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.snapshotMemoTip}"></textarea>\n</div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>\n</div>`,width:(0,r.isMobile)()?"80vw":"520px"}),t=e.element.querySelector("textarea");t.focus();const n=e.element.querySelectorAll(".b3-button");e.bindInput(t,(()=>{n[1].click()})),n[0].addEventListener("click",(()=>{e.destroy()})),n[1].addEventListener("click",(()=>{(0,s.fetchPost)("/api/repo/createSnapshot",{memo:t.value},(()=>{y(v,1)})),e.destroy()}));break}if("removeRepoTagSnapshot"===e||"removeCloudRepoTagSnapshot"===e){const n=t.parentElement.getAttribute("data-tag");(0,a.confirmDialog)(window.siyuan.languages.delete,`${window.siyuan.languages.confirmDelete} <i>${n}</i>?`,(()=>{(0,s.fetchPost)("/api/repo/"+e,{tag:n},(()=>{y(v,"removeRepoTagSnapshot"===e?-1:-2)}))}));break}if("uploadSnapshot"===e){(0,s.fetchPost)("/api/repo/uploadCloudSnapshot",{tag:t.parentElement.getAttribute("data-tag"),id:t.parentElement.getAttribute("data-id")});break}if("downloadSnapshot"===e){(0,s.fetchPost)("/api/repo/downloadCloudSnapshot",{tag:t.parentElement.getAttribute("data-tag"),id:t.parentElement.getAttribute("data-id")});break}if("genTag"===e){const e=new i.Dialog({title:window.siyuan.languages.tagSnapshot,content:`<div class="b3-dialog__content">\n    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.tagSnapshotTip}">\n</div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>\n</div>`,width:(0,r.isMobile)()?"80vw":"520px"}),n=e.element.querySelector(".b3-text-field");n.focus();const a=e.element.querySelectorAll(".b3-button");a[0].addEventListener("click",(()=>{e.destroy()})),e.bindInput(n,(()=>{a[1].click()})),a[1].addEventListener("click",(()=>{(0,s.fetchPost)("/api/repo/tagSnapshot",{id:t.parentElement.getAttribute("data-id"),name:n.value},(()=>{y(v,1)})),e.destroy()}));break}if(("previous"===e||"next"===e)&&"disabled"!==t.getAttribute("disabled")){const t=parseInt(v.getAttribute("data-page"));y(v,"previous"===e?t-1:t+1);break}if(("docprevious"===e||"docnext"===e)&&"disabled"!==t.getAttribute("disabled")){const t=parseInt(b.getAttribute("data-page"));g(b,"docprevious"===e?t-1:t+1);break}if("rebuildIndex"===e){(0,s.fetchPost)("/api/history/reindexHistory",{},(()=>{g(b,1)}));break}t=t.parentElement}}))}},8571:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.newNotebook=t.mountHelp=t.newDailyNote=void 0;const i=n(8438),a=n(7491),s=n(6400),o=n(7683),l=n(3163),r=n(9883),d=n(3029);t.newDailyNote=()=>{const e=(0,r.getOpenNotebookCount)();if(0===e)return void(0,a.showMessage)(window.siyuan.languages.newFileTip);if(1===e){let e="";return window.siyuan.notebooks.find((t=>{t.closed||(e=t.id)})),void(0,o.fetchPost)("/api/filetree/createDailyNote",{notebook:e})}const t=window.localStorage.getItem(i.Constants.LOCAL_DAILYNOTEID);if(t&&(0,r.getNotebookName)(t)&&!(0,s.isMobile)())(0,o.fetchPost)("/api/filetree/createDailyNote",{notebook:t});else{let e="";window.siyuan.notebooks.forEach((t=>{t.closed||(e+=`<option value="${t.id}">${t.name}</option>`)}));const n=new l.Dialog({content:`<div class="b3-dialog__content">\n    <select class="b3-select fn__block">${e}</select>\n</div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>\n</div>`,width:(0,s.isMobile)()?"80vw":"520px"}),a=n.element.querySelectorAll(".b3-button"),r=n.element.querySelector(".b3-select");r.value=t,a[0].addEventListener("click",(()=>{n.destroy()})),a[1].addEventListener("click",(()=>{const e=r.value;window.localStorage.setItem(i.Constants.LOCAL_DAILYNOTEID,e),(0,o.fetchPost)("/api/filetree/createDailyNote",{notebook:e}),n.destroy()}))}};t.mountHelp=()=>{const e=i.Constants.HELP_PATH[window.siyuan.config.appearance.lang];(0,o.fetchPost)("/api/notebook/removeNotebook",{notebook:e,callback:i.Constants.CB_MOUNT_REMOVE},(()=>{(0,o.fetchPost)("/api/notebook/openNotebook",{callback:i.Constants.CB_MOUNT_HELP,notebook:e})}))};t.newNotebook=()=>{const e=new l.Dialog({title:window.siyuan.languages.newNotebook,content:`<div class="b3-dialog__content">\n    <input placeholder="${window.siyuan.languages.notebookName}" class="b3-text-field fn__block">\n</div>\n<div class="b3-dialog__action">\n    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>\n    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>\n</div>`,width:(0,s.isMobile)()?"80vw":"520px"}),t=e.element.querySelectorAll(".b3-button");e.bindInput(e.element.querySelector("input"),(()=>{t[1].dispatchEvent(new CustomEvent("click"))})),t[0].addEventListener("click",(()=>{e.destroy()})),t[1].addEventListener("click",(()=>{const t=e.element.querySelector("input").value;if(!(0,d.validateName)(t))return!1;(0,o.fetchPost)("/api/notebook/createNotebook",{name:t}),e.destroy()}))}},7541:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.needSubscribe=void 0;const i=n(7491);t.needSubscribe=(e=window.siyuan.languages._kernel[29])=>(!window.siyuan.user||!(-1===window.siyuan.user.userSiYuanProExpireTime||window.siyuan.user.userSiYuanProExpireTime>0))&&(e&&(e===window.siyuan.languages._kernel[29]&&"ios"===window.siyuan.config.system.container?(0,i.showMessage)(window.siyuan.languages._kernel[122]):(0,i.showMessage)(e)),!0)},9972:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getSavePath=t.newFile=void 0;const i=n(7491),a=n(7683),s=n(9883);t.newFile=(e,t,n,o)=>{0!==(0,s.getOpenNotebookCount)()?(e||window.siyuan.notebooks.find((n=>{if(!n.closed)return e=n.id,t="/",!0})),(0,a.fetchPost)("/api/filetree/getDocNameTemplate",{notebook:e},(n=>{const i=Lute.NewNodeID(),l=(0,s.pathPosix)().join((0,s.getDisplayName)(t,!1,!0),i+".sy");o&&(o[o.indexOf(void 0)]=l),(0,a.fetchPost)("/api/filetree/createDoc",{notebook:e,path:l,title:n.data.name||"Untitled",md:"",sorts:o},(()=>{}))}))):(0,i.showMessage)(window.siyuan.languages.newFileTip)};t.getSavePath=(e,t,n)=>{(0,a.fetchPost)("/api/notebook/getNotebookConf",{notebook:t},(i=>{let o=i.data.conf.refCreateSavePath;o||(o=window.siyuan.config.fileTree.refCreateSavePath),o?o.startsWith("/")?n((0,s.getDisplayName)(o,!1,!0)):(0,a.fetchPost)("/api/filetree/getHPathByPath",{notebook:t,path:e},(e=>{n((0,s.getDisplayName)((0,s.pathPosix)().join(e.data,o),!1,!0))})):(0,a.fetchPost)("/api/filetree/getHPathByPath",{notebook:t,path:e},(e=>{n((0,s.getDisplayName)(e.data,!1,!0))}))}))}},9883:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,s){function o(e){try{r(i.next(e))}catch(e){s(e)}}function l(e){try{r(i.throw(e))}catch(e){s(e)}}function r(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,l)}r((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.setNoteBook=t.getOpenNotebookCount=t.setNotebookName=t.getNotebookName=t.movePathTo=t.pathPosix=t.isLocalPath=t.getAssetName=t.getDisplayName=t.addBaseURL=void 0;const a=n(2005),s=n(7683),o=n(3163),l=n(9755),r=n(6400),d=n(2386),c=n(7821),u=n(6810),p=n(8438);t.addBaseURL=()=>{let e=document.getElementById("baseURL");e||(e=document.createElement("base"),e.id="baseURL"),e.setAttribute("href",location.origin),document.getElementsByTagName("head")[0].appendChild(e)};t.getDisplayName=(e,n=!0,i=!1)=>{let a=e;return n&&(a=(0,t.pathPosix)().basename(e)),i&&a.endsWith(".sy")&&(a=a.substr(0,a.length-3)),a};t.getAssetName=e=>e.substring(7,e.length-(0,t.pathPosix)().extname(e).length-23);t.isLocalPath=e=>!!e&&(e.startsWith("assets/")||e.startsWith("file://"));t.pathPosix=()=>a.posix?a.posix:a;const m=(e,t,n,i,a)=>{(0,s.fetchPost)("/api/filetree/moveDoc",{fromNotebook:e,toNotebook:n,fromPath:t,toPath:i}),a.destroy()};t.movePathTo=(e,n,a=!0)=>i(void 0,void 0,void 0,(function*(){if(window.siyuan.dialogs.find((e=>{if(e.element.querySelector("#foldList"))return e.destroy(),!0})))return;const i=yield(0,s.fetchSyncPost)("/api/filetree/getHPathByPath",{notebook:e,path:n});let g;getSelection().rangeCount>0&&(g=getSelection().getRangeAt(0));const b=new o.Dialog({title:`${window.siyuan.languages.move} <span class="ft__smaller ft__on-surface">${(0,l.escapeHtml)((0,t.pathPosix)().join((0,t.getNotebookName)(e),i.data))}</span>`,content:`<div class="b3-form__icon b3-form__space">\n    <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>\n    <input class="b3-text-field fn__block b3-form__icon-input" value="" placeholder="${window.siyuan.languages.search}">\n</div>\n<ul id="foldList" class="b3-list b3-list--background" style="height: 50vh;overflow: auto;position: relative"></ul>`,width:(0,r.isMobile)()?"80vw":"50vw",destroyCallback(){g&&a&&(0,d.focusByRange)(g)}}),y=b.element.querySelector("#foldList"),f=b.element.querySelector(".b3-text-field");f.focus();const h=e=>{e&&e.isComposing||(0,s.fetchPost)("/api/filetree/searchDocs",{k:f.value},(e=>{let i="";e.data.forEach((e=>{e.path!==(0,t.pathPosix)().dirname(n)+"/"&&e.path!==n&&(i+=`<li class="b3-list-item${""===i?" b3-list-item--focus":""}" data-path="${e.path}" data-box="${e.box}">\n    <span class="b3-list-item__icon">${(0,u.unicode2Emoji)(e.boxIcon||p.Constants.SIYUAN_IMAGE_NOTE)}</span>\n    <span class="b3-list-item__showall">${(0,l.escapeHtml)(e.hPath)}</span>\n</li>`)})),y.innerHTML=i}))};h(),f.addEventListener("compositionend",(e=>{h(e)})),f.addEventListener("input",(e=>{h(e)}));f.addEventListener("keydown",(t=>{let i=b.element.querySelector(".b3-list-item--focus");if(i)if("ArrowDown"===t.key)i.classList.remove("b3-list-item--focus"),i.nextElementSibling?i.nextElementSibling.classList.add("b3-list-item--focus"):y.children[0].classList.add("b3-list-item--focus"),i=y.querySelector(".b3-list-item--focus"),(y.scrollTop<i.offsetTop-y.clientHeight+28||y.scrollTop>i.offsetTop)&&(y.scrollTop=i.offsetTop-y.clientHeight+28),t.preventDefault();else if("ArrowUp"===t.key){if(i.classList.remove("b3-list-item--focus"),i.previousElementSibling)i.previousElementSibling.classList.add("b3-list-item--focus");else{const e=y.children.length;y.children[e-1].classList.add("b3-list-item--focus")}i=y.querySelector(".b3-list-item--focus"),(y.scrollTop<i.offsetTop-y.clientHeight+28||y.scrollTop>i.offsetTop-56)&&(y.scrollTop=i.offsetTop-56),t.preventDefault()}else"Enter"===t.key&&(m(e,n,i.getAttribute("data-box"),i.getAttribute("data-path"),b),t.preventDefault())})),b.element.addEventListener("click",(t=>{const i=t.target,a=(0,c.hasClosestByClassName)(i,"b3-list-item");a&&m(e,n,a.getAttribute("data-box"),a.getAttribute("data-path"),b)}))}));t.getNotebookName=e=>{let t="";return window.siyuan.notebooks.find((n=>{if(n.id===e)return t=n.name,!0})),t};t.setNotebookName=(e,t)=>{window.siyuan.notebooks.find((n=>{if(n.id===e)return n.name=t,!0}))};t.getOpenNotebookCount=()=>{let e=0;return window.siyuan.notebooks.forEach((t=>{t.closed||e++})),e};t.setNoteBook=e=>{(0,s.fetchPost)("/api/notebook/lsNotebooks",{},(t=>{window.siyuan.notebooks=t.data.notebooks,e&&e(t.data.notebooks)}))}},6456:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.processMessage=void 0;const i=n(7491);t.processMessage=e=>{if("msg"===e.cmd)return(0,i.showMessage)(e.msg,e.data.closeTimeout,0===e.code?"info":"error",e.data.id),!1;if("cmsg"===e.cmd)return(0,i.hideMessage)(e.data.id),!1;if("cprogress"===e.cmd){const e=document.getElementById("progress");return e&&e.remove(),!1}return"reloadui"===e.cmd?(window.location.reload(),!1):e.code<0?((0,i.showMessage)(e.msg,e.data&&e.data.closeTimeout||0,-1===e.code?"error":"info"),!1):e}},5500:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setPosition=void 0;const i=n(8438);t.setPosition=(e,t,n,a=0,s=0)=>{e.style.top=n+"px",e.style.left=t+"px";const o=e.getBoundingClientRect();if(o.bottom>window.innerHeight||o.top<0){const t=n-o.height-a;t>0&&t+o.height<window.innerHeight-0?e.style.top=t+"px":e.style.top=t<=0?"0px":Math.max(i.Constants.SIZE_TOOLBAR_HEIGHT,window.innerHeight-o.height)+"px"}o.right>window.innerWidth?e.style.left=window.innerWidth-o.width-s+"px":o.left<0&&(e.style.left="0")}},4739:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.upDownHint=void 0;t.upDownHint=(e,t)=>{let n=e.querySelector(".b3-list-item--focus");if("ArrowDown"===t.key)return t.preventDefault(),t.stopPropagation(),n.classList.remove("b3-list-item--focus"),n.nextElementSibling?n.nextElementSibling.classList.contains("b3-list-item")?n.nextElementSibling.classList.add("b3-list-item--focus"):n.nextElementSibling.nextElementSibling.classList.add("b3-list-item--focus"):e.children[0].classList.add("b3-list-item--focus"),n=e.querySelector(".b3-list-item--focus"),(e.scrollTop<n.offsetTop-e.clientHeight+n.clientHeight||e.scrollTop>n.offsetTop)&&(e.scrollTop=n.offsetTop-e.clientHeight+n.clientHeight),n;if("ArrowUp"===t.key){if(t.preventDefault(),t.stopPropagation(),n.classList.remove("b3-list-item--focus"),n.previousElementSibling)n.previousElementSibling.classList.contains("b3-list-item")?n.previousElementSibling.classList.add("b3-list-item--focus"):n.previousElementSibling.previousElementSibling.classList.add("b3-list-item--focus");else{const t=e.children.length;e.children[t-1].classList.add("b3-list-item--focus")}return n=e.querySelector(".b3-list-item--focus"),(e.scrollTop<n.offsetTop-e.clientHeight+n.clientHeight||e.scrollTop>n.offsetTop-2*n.clientHeight)&&(e.scrollTop=n.offsetTop-2*n.clientHeight),n}}}},t={};function n(i){var a=t[i];if(void 0!==a)return a.exports;var s=t[i]={exports:{}};return e[i].call(s.exports,s,s.exports,n),s.exports}n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};(()=>{"use strict";const e=n(9173),t=n(8438),i=n(137),a=n(4577),s=n(7821),o=n(7849);n(1593);const l=n(8445),r=n(9883),d=n(4473),c=n(7683),u=n(4448),p=n(2738),m=n(1985),g=n(4933),b=n(7491),y=n(706);new class{constructor(){(0,e.addScriptSync)(`${t.Constants.PROTYLE_CDN}/js/lute/lute.min.js?v=${t.Constants.SIYUAN_VERSION}`,"protyleLuteScript"),(0,e.addScript)(`${t.Constants.PROTYLE_CDN}/js/protyle-html.js?v=${t.Constants.SIYUAN_VERSION}`,"protyleWcHtmlScript"),(0,r.addBaseURL)(),window.siyuan={transactions:[],reqIds:{},backStack:[],dialogs:[],blockPanels:[],menus:new l.Menus,ws:new o.Model({id:(0,a.genUUID)(),type:"main",msgCallback(e){(0,i.onMessage)(e)}})},window.addEventListener("click",(e=>{window.siyuan.menus.menu.element.contains(e.target)||(0,s.hasClosestByAttribute)(e.target,"data-menu","true")||window.siyuan.menus.menu.remove()})),(0,c.fetchPost)("/api/system/getConf",{},(e=>{e.data.conf.keymap=t.Constants.SIYUAN_KEYMAP,window.siyuan.config=e.data.conf,(0,c.fetchGet)(`/appearance/langs/${window.siyuan.config.appearance.lang}.json?v=${t.Constants.SIYUAN_VERSION}`,(t=>{window.siyuan.languages=t,document.title=window.siyuan.languages.siyuanNote,(0,g.bootSync)(),(0,p.loadAssets)(e.data.conf.appearance),(0,p.initAssets)(),(0,c.fetchPost)("/api/system/getEmojiConf",{},(e=>{var t;window.siyuan.emojis=e.data,(0,u.initFramework)(),"ios"===window.siyuan.config.system.container&&(null===(t=window.webkit)||void 0===t?void 0:t.messageHandlers)?window.webkit.messageHandlers.changeStatusBar.postMessage(getComputedStyle(document.body).getPropertyValue("--b3-theme-background")+" "+window.siyuan.config.appearance.mode):"android"===window.siyuan.config.system.container&&window.JSAndroid&&window.JSAndroid.changeStatusBarColor(getComputedStyle(document.body).getPropertyValue("--b3-theme-background"),window.siyuan.config.appearance.mode),(0,b.initMessage)()}))})),navigator.userAgent.indexOf("iPhone")>-1&&(document.addEventListener("touchstart",d.handleTouchStart,!1),document.addEventListener("touchmove",d.handleTouchMove,!1)),document.addEventListener("touchend",d.handleTouchEnd,!1)})),(0,r.setNoteBook)(),(0,m.promiseTransactions)()}},window.goBack=y.goBack})()})();